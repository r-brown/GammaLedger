const VALID_TRADE_TYPES=new Set(["BTO","STO","STC","BTC"]),SHORT_STRATEGY_PATTERNS=["cash-secured put","covered call","the wheel","bear call spread","bull put spread","iron condor","iron butterfly","short straddle","short strangle","credit spread"],LONG_STRATEGY_PATTERNS=["long ","protective put","bull call spread","bear put spread","calendar spread","diagonal spread","pmcc","straddle","strangle","debit spread"],LOCAL_STORAGE_KEY="GammaLedgerCache",LEGACY_STORAGE_KEY="GammaLedgerTrades",GEMINI_STORAGE_KEY="GammaLedgerGeminiConfig",GEMINI_SECRET_STORAGE_KEY="GammaLedgerGeminiSecret",DEFAULT_GEMINI_ENDPOINT="https://generativelanguage.googleapis.com/v1beta/models",DEFAULT_GEMINI_MODEL="gemini-2.5-flash-lite",DEFAULT_GEMINI_TEMPERATURE=.7,GEMINI_ALLOWED_MODELS=["gemini-2.5-flash-lite","gemini-2.5-flash","gemini-2.5-pro"],BUILTIN_SAMPLE_DATA={trades:[{ticker:"AAPL",strategy:"Long Call",tradeType:"BTO",quantity:1,entryDate:"2025-02-20",expirationDate:"2025-04-19",exitDate:"2025-03-12",status:"Closed",stockPriceAtEntry:175.6,strikePrice:175,entryPrice:1.45,exitPrice:2.89,fees:1,ivRank:32,delta:28.5,gamma:null,theta:-.04,vega:.15,marketCondition:"Bullish",convictionLevel:7,notes:"Breakout continuation",exitReason:"Profit target reached",id:1001,tradeDirection:"long",daysHeld:21,dte:38,pl:144,roi:98.63,annualizedROI:512.4,maxRisk:146,cycleId:"",cycleType:"",cycleRole:"",definedRiskWidth:null,maxRiskOverride:null},{ticker:"MSFT",strategy:"Covered Call",tradeType:"STO",quantity:-1,entryDate:"2025-03-24",expirationDate:"2025-05-16",exitDate:"2025-04-18",status:"Closed",stockPriceAtEntry:318.2,strikePrice:325,entryPrice:1.95,exitPrice:.45,fees:1.5,ivRank:27,delta:-14,gamma:null,theta:.02,vega:null,marketCondition:"Neutral",convictionLevel:5,notes:"Rolled after earnings",exitReason:"Profit target reached",id:1002,tradeDirection:"short",daysHeld:25,dte:28,pl:148.5,roi:39.23,annualizedROI:286.7,maxRisk:81.6,cycleId:"",cycleType:"",cycleRole:"",definedRiskWidth:null,maxRiskOverride:null},{ticker:"SPY",strategy:"Bull Put Spread",tradeType:"BTO",quantity:1,entryDate:"2025-04-22",expirationDate:"2025-05-31",exitDate:"2025-05-18",status:"Closed",stockPriceAtEntry:507.4,strikePrice:500,entryPrice:1.95,exitPrice:.5,fees:1.1,ivRank:25,delta:16.2,gamma:null,theta:.06,vega:.12,marketCondition:"Bullish",convictionLevel:6,notes:"Bounce off 50-day moving average",exitReason:"Hit 70% max profit",id:1011,tradeDirection:"long",daysHeld:26,dte:13,pl:144,roi:73.85,annualizedROI:411.2,maxRisk:195,cycleId:"SPY-2025-05",cycleType:"defined-risk",cycleRole:"primary",definedRiskWidth:5,maxRiskOverride:null},{ticker:"META",strategy:"Iron Condor",tradeType:"BTO",quantity:1,entryDate:"2025-05-28",expirationDate:"2025-06-28",exitDate:"2025-06-21",status:"Closed",stockPriceAtEntry:301.7,strikePrice:300,entryPrice:2.35,exitPrice:.85,fees:1.3,ivRank:41,delta:2.8,gamma:null,theta:.11,vega:-.05,marketCondition:"Neutral",convictionLevel:5,notes:"Captured IV crush into FOMC week",exitReason:"50% max profit",id:1006,tradeDirection:"long",daysHeld:24,dte:7,pl:148.7,roi:42.48,annualizedROI:532.1,maxRisk:350,cycleId:"META-2025-06",cycleType:"iron-condor",cycleRole:"primary",definedRiskWidth:10,maxRiskOverride:null},{ticker:"DIS",strategy:"Cash-Secured Put",tradeType:"STO",quantity:-1,entryDate:"2025-06-24",expirationDate:"2025-07-19",exitDate:"2025-07-18",status:"Closed",stockPriceAtEntry:101.6,strikePrice:100,entryPrice:2.3,exitPrice:.35,fees:.85,ivRank:38,delta:-24.1,gamma:null,theta:.08,vega:null,marketCondition:"Neutral",convictionLevel:6,notes:"Earnings gap fill support held",exitReason:"Premium decay captured",id:1012,tradeDirection:"short",daysHeld:24,dte:1,pl:194.15,roi:1.99,annualizedROI:30.3,maxRisk:9770,cycleId:"DIS-2025-07",cycleType:"wheel",cycleRole:"wheel-put",definedRiskWidth:null,maxRiskOverride:null},{ticker:"SMH",strategy:"Bear Call Spread",tradeType:"STO",quantity:-1,entryDate:"2025-07-22",expirationDate:"2025-08-23",exitDate:"2025-08-16",status:"Closed",stockPriceAtEntry:250.1,strikePrice:255,entryPrice:2.1,exitPrice:.6,fees:1.1,ivRank:47,delta:-18.7,gamma:null,theta:.05,vega:-.14,marketCondition:"Bearish",convictionLevel:5,notes:"Rejected weekly resistance",exitReason:"90% max profit captured",id:1013,tradeDirection:"short",daysHeld:25,dte:7,pl:148.9,roi:70.9,annualizedROI:413.4,maxRisk:210,cycleId:"SMH-2025-08",cycleType:"defined-risk",cycleRole:"hedge",definedRiskWidth:5,maxRiskOverride:null},{ticker:"AVGO",strategy:"Covered Call",tradeType:"STO",quantity:-1,entryDate:"2025-08-26",expirationDate:"2025-09-20",exitDate:"2025-09-19",status:"Closed",stockPriceAtEntry:950.7,strikePrice:980,entryPrice:6.8,exitPrice:1.1,fees:1.75,ivRank:29,delta:-22.4,gamma:null,theta:.04,vega:-.12,marketCondition:"Neutral",convictionLevel:6,notes:"Monthly income against core holding",exitReason:"Roll candidate after profit",id:1014,tradeDirection:"short",daysHeld:24,dte:1,pl:489.25,roi:35.75,annualizedROI:544.1,maxRisk:0,cycleId:"AVGO-2025-09",cycleType:"covered",cycleRole:"income",definedRiskWidth:null,maxRiskOverride:95e3},{ticker:"TSLA",strategy:"Cash-Secured Put",tradeType:"STO",quantity:-1,entryDate:"2025-09-15",expirationDate:"2025-10-17",exitDate:null,status:"Open",stockPriceAtEntry:260.5,strikePrice:250,entryPrice:3.4,exitPrice:null,fees:.75,ivRank:60,delta:-28.1,gamma:null,theta:.05,vega:null,marketCondition:"Neutral",convictionLevel:6,notes:"Prefer assignment for long-term hold",exitReason:null,id:1003,tradeDirection:"short",daysHeld:10,dte:32,pl:0,roi:0,annualizedROI:0,maxRisk:2466,cycleId:"TSLA-2025-10",cycleType:"wheel",cycleRole:"wheel-put",definedRiskWidth:null,maxRiskOverride:null},{ticker:"AMZN",strategy:"Short Put Spread",tradeType:"BTO",quantity:1,entryDate:"2025-09-05",expirationDate:"2025-10-11",exitDate:null,status:"Open",stockPriceAtEntry:138.2,strikePrice:134,entryPrice:1.1,exitPrice:null,fees:1.05,ivRank:48,delta:18.7,gamma:null,theta:.04,vega:.15,marketCondition:"Bullish",convictionLevel:6,notes:"High IV setup",exitReason:null,id:1004,tradeDirection:"long",daysHeld:5,dte:15,pl:0,roi:0,annualizedROI:0,maxRisk:390,cycleId:"AMZN-2025-10",cycleType:"defined-risk",cycleRole:"base",definedRiskWidth:5,maxRiskOverride:null},{ticker:"NVDA",strategy:"Poor Man's Covered Call",tradeType:"BTO",quantity:1,entryDate:"2025-06-20",expirationDate:"2026-01-17",exitDate:null,status:"Open",stockPriceAtEntry:440,strikePrice:400,entryPrice:38.6,exitPrice:null,fees:1.25,ivRank:52,delta:62,gamma:null,theta:-.08,vega:.4,marketCondition:"Bullish",convictionLevel:8,notes:"Synthetic stock core position",exitReason:null,id:1005,tradeDirection:"long",daysHeld:110,dte:99,pl:0,roi:0,annualizedROI:0,maxRisk:3860,cycleId:"NVDA-2026-01",cycleType:"pmcc",cycleRole:"base",definedRiskWidth:null,maxRiskOverride:null},{ticker:"GOOG",strategy:"Diagonal Call Spread",tradeType:"BTO",quantity:1,entryDate:"2025-07-30",expirationDate:"2025-11-15",exitDate:null,status:"Open",stockPriceAtEntry:132.5,strikePrice:133,entryPrice:4.6,exitPrice:null,fees:1.1,ivRank:30,delta:35.4,gamma:null,theta:.07,vega:.21,marketCondition:"Neutral",convictionLevel:6,notes:"Diagonal with short weekly calls",exitReason:null,id:1007,tradeDirection:"long",daysHeld:70,dte:45,pl:0,roi:0,annualizedROI:0,maxRisk:460,cycleId:"GOOG-2025-11",cycleType:"diagonal",cycleRole:"long-leg",definedRiskWidth:null,maxRiskOverride:null},{ticker:"AMD",strategy:"Short Call",tradeType:"STO",quantity:-1,entryDate:"2025-09-12",expirationDate:"2025-09-27",exitDate:null,status:"Open",stockPriceAtEntry:108.3,strikePrice:115,entryPrice:1.45,exitPrice:null,fees:.9,ivRank:55,delta:-20.6,gamma:null,theta:.06,vega:-.18,marketCondition:"Bearish",convictionLevel:5,notes:"Overbought daily chart",exitReason:null,id:1008,tradeDirection:"short",daysHeld:4,dte:14,pl:0,roi:0,annualizedROI:0,maxRisk:0,cycleId:"AMD-2025-09",cycleType:"short-call",cycleRole:"overlay",definedRiskWidth:null,maxRiskOverride:1e3},{ticker:"NFLX",strategy:"Strangle",tradeType:"BTO",quantity:1,entryDate:"2025-09-18",expirationDate:"2025-10-18",exitDate:null,status:"Open",stockPriceAtEntry:405.4,strikePrice:400,entryPrice:6.8,exitPrice:null,fees:1.35,ivRank:58,delta:0,gamma:null,theta:-.12,vega:.45,marketCondition:"Volatile",convictionLevel:6,notes:"Pre-earnings volatility play",exitReason:null,id:1009,tradeDirection:"long",daysHeld:1,dte:30,pl:0,roi:0,annualizedROI:0,maxRisk:680,cycleId:"NFLX-2025-10",cycleType:"strangle",cycleRole:"earnings",definedRiskWidth:null,maxRiskOverride:null},{ticker:"JPM",strategy:"Covered Call",tradeType:"STO",quantity:-1,entryDate:"2025-09-02",expirationDate:"2025-10-04",exitDate:null,status:"Open",stockPriceAtEntry:147.2,strikePrice:150,entryPrice:1.05,exitPrice:null,fees:.8,ivRank:22,delta:-18,gamma:null,theta:.03,vega:-.09,marketCondition:"Neutral",convictionLevel:4,notes:"Monthly income trade",exitReason:null,id:1010,tradeDirection:"short",daysHeld:8,dte:24,pl:0,roi:0,annualizedROI:0,maxRisk:0,cycleId:"JPM-2025-10",cycleType:"covered",cycleRole:"income",definedRiskWidth:null,maxRiskOverride:null}],exportDate:"2025-09-25T12:00:00.000Z",version:"2.2"};class GammaLedger{constructor(){this.trades=[],this.currentView="dashboard",this.sortDirection={},this.charts={},this.tradeDetailCharts=new Map,this.cycleAnalytics=[],this.currentFileHandle=null,this.currentFileName="Unsaved Database",this.hasUnsavedChanges=!1,this.supportsFileSystemAccess="showOpenFilePicker"in window,this.currentEditingId=null,this.finnhub={apiKey:"",encryptionKey:null,cache:new Map,cacheTTL:6e4,outstandingRequests:new Map,rateLimitQueue:Promise.resolve(),maxRequestsPerMinute:60,timestamps:[],statusTimeoutId:null,lastStatus:null,elements:{}},this.gemini={apiKey:"",encryptionKey:null,model:DEFAULT_GEMINI_MODEL,statusTimeoutId:null,lastStatus:null,elements:{}},this.aiAgent=new GeminiInsightsAgent(this),this.aiChatMessages=[],this.aiChatSessionId=Date.now(),this.aiChatPendingRequest=!1,this.aiChatOpen=!1,this.activeQuoteEntries=new Map,this.quoteRefreshIntervalId=null,this.autoRefreshIntervalMs=this.computeAutoRefreshInterval(),this.quoteRefreshKeys=[],this.quoteRefreshCursor=0,this.features={greeksEnabled:!1},this.positionHighlightConfig={expirationWarningDays:20,expirationCriticalDays:10},this.currentDate=new Date,this.init()}async init(){await this.loadFromStorage(),await this.loadFinnhubConfigFromStorage(),await this.loadGeminiConfigFromStorage(),this.trades&&0!==this.trades.length?(this.updateFileNameDisplay(),this.updateDashboard()):await this.loadDefaultDatabase(),this.bindEvents(),this.initializeGeminiControls(),this.initializeAIChat(),this.initializeFinnhubControls(),this.updateFileNameDisplay(),this.checkBrowserCompatibility(),setTimeout(()=>{this.updateDashboard(),this.showView("dashboard")},100)}computeAutoRefreshInterval(){const e=Number(this.finnhub?.maxRequestsPerMinute)||60,t=Math.min(Math.max(e-2,1),60);return Math.max(800,Math.ceil(12e4/t))}areGreeksEnabled(){return Boolean(this.features?.greeksEnabled)}checkBrowserCompatibility(){if(!this.supportsFileSystemAccess){const e=document.getElementById("compatibility-notice");e&&e.classList.remove("hidden"),console.log("File System Access API not supported, using fallback methods")}}async loadDefaultDatabase(){try{if(!BUILTIN_SAMPLE_DATA||!Array.isArray(BUILTIN_SAMPLE_DATA.trades))throw new Error("Built-in sample data unavailable.");const e=JSON.parse(JSON.stringify(BUILTIN_SAMPLE_DATA));this.processLoadedData(e,{fileName:"Sample Database (Built-in)",source:"default-sample"}),this.currentFileHandle=null}catch(e){console.warn("Default database not loaded:",e),this.trades=[],this.currentFileName="Unsaved Database",this.currentFileHandle=null,this.hasUnsavedChanges=!1,this.updateUnsavedIndicator(),this.saveToStorage({fileName:this.currentFileName}),this.updateFileNameDisplay(),this.updateDashboard()}}getTradeType(e){return e.tradeType&&VALID_TRADE_TYPES.has(e.tradeType.toUpperCase())?e.tradeType.toUpperCase():this.normalizeTradeType(e)}normalizeTradeType(e){const t=(e.tradeType||"").toUpperCase();if(VALID_TRADE_TYPES.has(t))return t;const i=this.inferTradeDirection(e);return this.isClosedStatus(e.status)?"short"===i?"BTC":"STC":"short"===i?"STO":"BTO"}inferTradeDirection(e){const t=(e.tradeType||"").toUpperCase();if("BTO"===t||"STC"===t)return"long";if("STO"===t||"BTC"===t)return"short";const i=Number(e.quantity);if(!Number.isNaN(i)&&0!==i&&i<0)return"short";const a=(e.strategy||"").toLowerCase();return a.includes("short ")||SHORT_STRATEGY_PATTERNS.some(e=>a.includes(e))?"short":(LONG_STRATEGY_PATTERNS.some(e=>a.includes(e)),"long")}normalizeStatus(e){return(e||"").toString().trim().toLowerCase()}isClosedStatus(e){const t=this.normalizeStatus(e);return"closed"===t||"assigned"===t||"expired"===t}isAssignmentReason(e){return(e||"").toString().trim().toLowerCase().includes("assign")}getDisplayStatus(e){if(!e)return"Unknown";const t=(e.status||"Unknown").toString().trim();if(!t)return"Unknown";const i=t.toLowerCase();return"closed"===i&&this.isAssignmentReason(e.exitReason)||"assigned"===i?"Assigned":"expired"===i?"Expired":t}calculateDTE(e,t){const i=new Date(e);let a=this.currentDate;if(this.isClosedStatus(t.status))return 0;const n=i.getTime()-a.getTime(),r=Math.ceil(n/864e5);return Math.max(0,r)}calculatePL(e){if(!this.isClosedStatus(e.status)||null===e.exitPrice||void 0===e.exitPrice)return 0;const t=Math.abs(Number(e.quantity)||0);if(0===t)return 0;const i=Number(e.entryPrice)||0,a=Number(e.exitPrice)||0,n=Number(e.fees)||0,r=this.getTradeType(e);return("STO"===r||"BTC"===r?i-a:a-i)*t*100-n}calculateROI(e){const t=this.calculatePL(e),i=this.getCapitalAtRisk(e);if(!(i>0))return 0;const a=t/i*100;return Number.isFinite(a)?parseFloat(a.toFixed(2)):0}calculateDaysHeld(e){const t=new Date(e.entryDate);let i;i=this.isClosedStatus(e.status)&&e.exitDate?new Date(e.exitDate):this.currentDate;const a=i-t,n=Math.ceil(a/864e5);return Math.max(1,n)}calculateMaxRisk(e){const t=Math.abs(Number(e.quantity)||0);if(0===t)return 0;const i=Number(e.maxRiskOverride);if(Number.isFinite(i)&&i>0)return i;const a=Math.abs(Number(e.entryPrice)||0),n=Number(e.fees)||0,r=(e.strategy||"").toLowerCase(),s=this.getTradeType(e),o="STO"===s||"BTC"===s,l=Number(e.definedRiskWidth),c=Number.isFinite(l)&&l>0;if(!o)return a*t*100+n;if(c){return Math.max(100*(l-a),0)*t+n}r.includes("spread")||r.includes("condor")||r.includes("collar")||r.includes("butterfly");if(r.includes("put")){const i=Number(e.strikePrice)||0;if(i>0){return Math.max(100*(i-a),0)*t+n}}return a*t*100+n}getCapitalAtRisk(e){const t=Number(e.maxRisk);return Number.isFinite(t)&&t>0?t:this.calculateMaxRisk(e)}calculateAnnualizedROI(e){if(!this.isClosedStatus(e.status))return 0;const t=this.calculateROI(e);if(!Number.isFinite(t))return 0;const i=this.calculateDaysHeld(e),a=365*t/Math.max(1,Number(i)||0);return Number.isFinite(a)?parseFloat(a.toFixed(2)):0}enrichTradeData(e){const t={...e};delete t.optionType;const i=this.normalizeTradeType(t);t.tradeType=i;const a=this.inferTradeDirection({...t,tradeType:i});t.tradeDirection=a;const n=Number(t.definedRiskWidth);t.definedRiskWidth=Number.isFinite(n)&&n>0?n:null;const r=Number(t.maxRiskOverride);t.maxRiskOverride=Number.isFinite(r)&&r>0?r:null;const s=Number(t.quantity),o=Math.abs(Number.isNaN(s)?0:s);return t.quantity=o>0&&"short"===a?-o:o,t.daysHeld=this.calculateDaysHeld(t),t.dte=this.calculateDTE(t.expirationDate,t),t.pl=this.calculatePL(t),t.roi=this.calculateROI(t),t.annualizedROI=this.calculateAnnualizedROI(t),t.maxRisk=this.calculateMaxRisk(t),t.cycleId=this.normalizeCycleId(t.cycleId),t.cycleType=this.normalizeCycleType(t.cycleType,t.strategy),t.cycleRole=this.normalizeCycleRole(t.cycleRole,t),t}formatDateForInput(e){if(!e)return"";const t=new Date(e);if(isNaN(t.getTime()))return"";return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}calculateDaysBetween(e,t){const i=new Date(e),a=new Date(t),n=Math.abs(a.getTime()-i.getTime());return Math.ceil(n/864e5)}generateTickerLink(e){const t=(e??"").toString().trim().toUpperCase();return t?`https://www.investing.com/search/?q=${encodeURIComponent(t)}`:"https://www.investing.com/search/"}createTickerElement(e,t="ticker-link",i={}){const a=(e??"").toString().trim().toUpperCase();if(!a){const e=document.createElement("span");return e.className=`${t} ticker-link--placeholder`.trim(),e.textContent="—",e}const{behavior:n="external",onClick:r=null,title:s=""}=i||{},o=document.createElement("a");return o.className=t,o.textContent=a,s&&(o.title=s),"filter"===n&&"function"==typeof r?(o.href="#",o.setAttribute("role","button"),o.dataset.ticker=a,o.addEventListener("click",e=>{e.preventDefault(),r(a)})):(o.href=this.generateTickerLink(a),o.target="_blank",o.rel="noopener noreferrer",o.addEventListener("click",e=>{e.preventDefault(),window.open(this.generateTickerLink(a),"_blank","noopener,noreferrer")})),o}applyResponsiveLabels(e,t=[]){if(!e||!Array.isArray(t)||0===t.length)return;Array.from(e.cells||[]).forEach((e,i)=>{const a=t[i];a?e.setAttribute("data-label",a):e.removeAttribute("data-label")})}normalizeCycleId(e){return(e||"").toString().trim()}normalizeCycleType(e,t=""){const i=(e||"").toString().trim().toLowerCase();if("wheel"===i)return"wheel";if("pmcc"===i||"pmc"===i)return"pmcc";return this.inferCycleTypeFromStrategy(t)||i||""}inferCycleTypeFromStrategy(e=""){const t=e.toString().trim().toLowerCase();return t?t.includes("poor man")||t.includes("pmcc")?"pmcc":t.includes("cash-secured put")||t.includes("covered call")||t.includes("wheel")?"wheel":"":""}normalizeCycleRole(e,t={}){const i=(e||"").toString().trim().toLowerCase();return i||this.inferCycleRole(t)}inferCycleRole(e={}){const t=(e.strategy||"").toString().toLowerCase(),i=e.tradeDirection||this.inferTradeDirection(e),a=this.getTradeType(e);if(t.includes("cash-secured put"))return"wheel-put";if(t.includes("covered call"))return"wheel-call";if(t.includes("poor man")){if("long"===i||"BTO"===a)return"pmcc-base";if("short"===i||"STO"===a)return"pmcc-short"}return this.isAssignmentTrade(e)?"assignment":""}isWheelPut(e={}){if("wheel-put"===(e.cycleRole||"").toLowerCase())return!0;return(e.strategy||"").toLowerCase().includes("cash-secured put")}isCoveredCall(e={}){const t=(e.cycleRole||"").toLowerCase();if("wheel-call"===t||"covered-call"===t)return!0;return(e.strategy||"").toLowerCase().includes("covered call")}isPmccBaseLeg(e={}){if("pmcc-base"===(e.cycleRole||"").toLowerCase())return!0;return(e.strategy||"").toLowerCase().includes("poor man")&&("long"===e.tradeDirection||"BTO"===this.getTradeType(e))}isPmccShortCall(e={}){if("pmcc-short"===(e.cycleRole||"").toLowerCase())return!0;return(e.strategy||"").toLowerCase().includes("poor man")&&("short"===e.tradeDirection||"STO"===this.getTradeType(e))}isAssignmentTrade(e={}){return"assigned"===this.normalizeStatus(e.status)||this.isAssignmentReason(e.exitReason)}calculateOptionPremium(e={}){const t=Math.abs(Number(e.quantity)||0);if(!t)return 0;const i=Number(e.entryPrice)||0,a=Number(e.exitPrice)||0,n=Number(e.fees)||0,r=(i-a)*t*100;return"short"===(e.tradeDirection||this.inferTradeDirection(e))?r-n:(a-i)*t*100-n}bindEvents(){document.querySelectorAll(".nav-item").forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-view");t&&this.showView(t)})});const e=document.getElementById("save-database-btn");e&&e.addEventListener("click",async e=>{e.preventDefault(),await this.saveDatabase()});const t=document.getElementById("load-database-btn");t&&t.addEventListener("click",async e=>{e.preventDefault(),await this.loadDatabase()});const i=document.getElementById("new-database-btn");i&&i.addEventListener("click",e=>{e.preventDefault(),this.newDatabase()});const a=document.getElementById("add-trade-form");a&&a.addEventListener("submit",e=>{e.preventDefault(),this.handleTradeSubmit()});const n=document.getElementById("ticker");n&&n.addEventListener("input",e=>{this.updateTickerPreview(e.target.value)});const r=document.getElementById("convictionLevel");r&&r.addEventListener("input",e=>{const t=document.getElementById("conviction-display");t&&(t.textContent=e.target.value)}),["filter-strategy","filter-status","filter-market-condition","filter-trade-type"].forEach(e=>{const t=document.getElementById(e);t&&t.addEventListener("change",()=>this.filterTrades())});const s=document.getElementById("search-ticker");s&&s.addEventListener("input",()=>this.filterTrades());const o=document.getElementById("export-csv");o&&o.addEventListener("click",()=>this.exportToCSV()),document.querySelectorAll(".sortable").forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-sort");t&&this.sortTrades(t)})});const l=document.getElementById("ai-chat-toggle");l&&l.addEventListener("click",()=>this.toggleAIChat());const c=document.getElementById("ai-chat-close");c&&c.addEventListener("click",()=>this.toggleAIChat(!1));const d=document.getElementById("ai-chat-form");d&&d.addEventListener("submit",e=>{e.preventDefault(),this.handleAIChatSubmit()}),document.querySelectorAll(".ai-chat__quick-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-ai-prompt");t&&this.handleAIQuickPrompt(t)})});const u=document.getElementById("ai-chat");u&&u.addEventListener("click",e=>{const t=e.target instanceof Element?e.target:null,i=t?.closest('a[href="#settings"]');if(!i)return;e.preventDefault(),this.showView("settings"),this.toggleAIChat(!1);const a=document.getElementById("gemini-api-key");a&&setTimeout(()=>a.focus(),120)}),this.setupAIChatResizeHandle(),this.setTodayDate(),this.setupResponsiveFilters()}setupResponsiveFilters(){const e=document.getElementById("trades-filters-panel"),t=document.getElementById("toggle-filters");if(!e||!t)return;const i=e=>{t.textContent=e?"Hide Filters":"Show Filters",t.setAttribute("aria-expanded",String(e))};let a=window.innerWidth<=768;const n=(t=!1)=>{const n=window.innerWidth<=768;n?(!t&&a||e.classList.remove("is-open"),i(e.classList.contains("is-open"))):(e.classList.add("is-open"),i(!0)),a=n};t.addEventListener("click",()=>{const t=e.classList.toggle("is-open");i(t)});let r=null;window.addEventListener("resize",()=>{clearTimeout(r),r=setTimeout(()=>n(!1),160)}),n(!0)}setupAIChatResizeHandle(){const e=document.getElementById("ai-chat-panel"),t=document.getElementById("ai-chat-resize-handle")||e?.querySelector(".ai-chat__resize-handle");if(!e||!t||"true"===t.dataset.initialized)return void(t&&(t.dataset.initialized="true"));const i=(e,t,i)=>Math.min(Math.max(e,t),i),a={resizing:!1,startX:0,startY:0,startWidth:0,startHeight:0,maxWidth:0,maxHeight:0,minWidth:280,minHeight:280,rightMargin:24,bottomMargin:24,viewportPadding:24},n=i=>{if(a.resizing){if(a.resizing=!1,e.classList.remove("ai-chat__panel--resizing"),i)try{t.releasePointerCapture(i.pointerId)}catch(e){}document.removeEventListener("pointermove",r),document.removeEventListener("pointerup",n),document.removeEventListener("pointercancel",n)}},r=t=>{if(!a.resizing)return;t.preventDefault();const n=t.clientX-a.startX,r=t.clientY-a.startY,s=i(a.startWidth-n,a.minWidth,a.maxWidth),o=i(a.startHeight-r,a.minHeight,a.maxHeight);e.style.width=`${s}px`,e.style.height=`${o}px`};t.addEventListener("pointerdown",i=>{if(0!==i.button&&"touch"!==i.pointerType)return;i.preventDefault();const s=e.getBoundingClientRect();a.resizing=!0,a.startX=i.clientX,a.startY=i.clientY,a.startWidth=s.width,a.startHeight=s.height,a.rightMargin=Math.max(a.viewportPadding,Math.round(window.innerWidth-s.right)),a.bottomMargin=Math.max(a.viewportPadding,Math.round(window.innerHeight-s.bottom)),a.maxWidth=Math.max(a.minWidth,window.innerWidth-a.rightMargin-a.viewportPadding),a.maxHeight=Math.max(a.minHeight,window.innerHeight-a.bottomMargin-a.viewportPadding),e.classList.add("ai-chat__panel--resizing"),e.style.removeProperty("transform");try{t.setPointerCapture(i.pointerId)}catch(e){}document.addEventListener("pointermove",r,{passive:!1}),document.addEventListener("pointerup",n),document.addEventListener("pointercancel",n)}),t.dataset.initialized="true"}initializeAIChat(){if(this.updateAIChatHeader(),!this.aiAgent)return void(this.aiChatMessages=[]);const e=this.calculateAdvancedStats();this.aiAgent.updateContext({stats:e,openTrades:e.openTradesList,closedTrades:e.closedTradesList}),this.aiChatSessionId=Date.now(),this.aiChatMessages=[],this.aiChatPendingRequest=!1;const t=this.aiAgent.getGreeting();t?this.appendAIChatMessage("ai",t):this.renderAIChatMessages()}toggleAIChat(e=null){const t=document.getElementById("ai-chat-panel"),i=document.getElementById("ai-chat-toggle"),a=document.getElementById("ai-chat-input");if(!t||!i)return;(null===e?t.classList.contains("hidden"):Boolean(e))?(t.classList.remove("hidden"),t.setAttribute("aria-hidden","false"),i.setAttribute("aria-expanded","true"),this.aiChatOpen=!0,a&&setTimeout(()=>a.focus(),80)):(t.classList.add("hidden"),t.setAttribute("aria-hidden","true"),i.setAttribute("aria-expanded","false"),this.aiChatOpen=!1)}async handleAIChatSubmit(){if(this.aiChatPendingRequest)return;const e=document.getElementById("ai-chat-input");if(!e)return;const t=e.value.trim();if(!t)return;this.appendAIChatMessage("user",t),e.value="";const i=this.appendAIChatMessage("ai","Analyzing your portfolio...",{pending:!0}),a=this.aiChatMessages.filter(e=>e.id!==i).slice(-10).map(e=>({...e}));this.aiChatPendingRequest=!0;try{const e=this.aiAgent?await this.aiAgent.generateResponse(t,{history:a}):"AI assistant is unavailable at the moment.";this.appendAIChatMessage("ai",e,{replaceId:i,pending:!1})}catch(e){const t=e?.message||"Unknown error",a="Sorry, I could not reach Gemini right now. Please try again soon.";this.appendAIChatMessage("ai",`${a} (${t})`,{replaceId:i,pending:!1})}finally{this.aiChatPendingRequest=!1,e&&e.focus()}}async handleAIQuickPrompt(e){if(this.aiChatPendingRequest||!e)return;this.toggleAIChat(!0);const t=document.getElementById("ai-chat-input");t&&(t.value=""),this.appendAIChatMessage("user",e);const i=this.appendAIChatMessage("ai","Analyzing your portfolio...",{pending:!0}),a=this.aiChatMessages.filter(e=>e.id!==i).slice(-10).map(e=>({...e}));this.aiChatPendingRequest=!0;try{const t=this.aiAgent?await this.aiAgent.generateResponse(e,{history:a}):"AI assistant is unavailable at the moment.";this.appendAIChatMessage("ai",t,{replaceId:i,pending:!1})}catch(e){const t=e?.message||"Unknown error",a="Sorry, I could not reach Gemini right now. Please try again soon.";this.appendAIChatMessage("ai",`${a} (${t})`,{replaceId:i,pending:!1})}finally{this.aiChatPendingRequest=!1,t&&t.focus()}}appendAIChatMessage(e,t,i={}){const a="ai"===e?"ai":"user",{suppressRender:n=!1,replaceId:r=null,id:s=null,pending:o=!1}=i||{};if(!r&&("string"!=typeof t||0===t.length))return null;const l=new Date;if(r){const e=this.aiChatMessages.findIndex(e=>e.id===r);if(-1!==e){const i=this.aiChatMessages[e];return this.aiChatMessages[e]={...i,sender:a,text:t||"",timestamp:l,pending:Boolean(o)},n||this.renderAIChatMessages(),this.aiChatMessages[e].id}}const c={id:s||`${this.aiChatSessionId}-${Date.now()}-${Math.random().toString(16).slice(2)}`,sender:a,text:t||"",timestamp:l,pending:Boolean(o)};return this.aiChatMessages=[...this.aiChatMessages,c].slice(-200),n||this.renderAIChatMessages(),c.id}renderAIChatMessages(){const e=document.getElementById("ai-chat-history");e&&(e.innerHTML="",this.aiChatMessages.forEach(t=>{const i=document.createElement("div");i.className=`ai-chat__message ai-chat__message--${t.sender}`,t.pending&&i.classList.add("ai-chat__message--pending");const a=document.createElement("span");a.textContent="ai"===t.sender?this.getGeminiChatDisplayName():"You",i.appendChild(a);const n=document.createElement("div");n.className="ai-chat__bubble",t.pending&&n.setAttribute("data-pending","true"),"ai"===t.sender?n.innerHTML=this.renderMarkdownToHTML(t.text):n.textContent=t.text,i.appendChild(n),e.appendChild(i)}),e.scrollTop=e.scrollHeight)}renderMarkdownToHTML(e=""){if(!e)return"";const t=[],i=/```([\s\S]*?)```/g;let a,n=0;for(;null!==(a=i.exec(e));)a.index>n&&t.push({type:"text",value:e.slice(n,a.index)}),t.push({type:"code",value:a[1]}),n=a.index+a[0].length;return n<e.length&&t.push({type:"text",value:e.slice(n)}),t.map(e=>{if("code"===e.type){const t=e.value.replace(/^\n+|\n+$/g,"");return`<pre class="ai-chat__code"><code>${this.escapeHTML(t)}</code></pre>`}return this.renderMarkdownTextSegment(e.value)}).join("")}renderMarkdownTextSegment(e=""){if(!e)return"";const t=e.replace(/\r/g,"").split("\n"),i=[];let a=[],n=!1,r=!1;const s=()=>{n&&(i.push("</ul>"),n=!1),r&&(i.push("</ol>"),r=!1)},o=()=>{if(!a.length)return;const e=a.join(" ").trim();e&&i.push(`<p>${this.formatMarkdownInline(e)}</p>`),a=[]};return t.forEach(e=>{const t=e.trim();if(!t)return o(),void s();const l=t.match(/^(#{1,3})\s+(.*)$/);if(l){o(),s();const e=Math.min(l[1].length+2,6);return void i.push(`<h${e}>${this.formatMarkdownInline(l[2])}</h${e}>`)}if(/^([-*_])\1{2,}$/.test(t))return o(),s(),void i.push('<hr class="ai-chat__rule">');if(t.startsWith(">")){o(),s();const e=t.replace(/^>\s?/,"");return void i.push(`<blockquote class="ai-chat__quote">${this.formatMarkdownInline(e)}</blockquote>`)}const c=t.match(/^[-*]\s+(.*)$/);if(c)return o(),n||(s(),i.push("<ul>"),n=!0),void i.push(`<li>${this.formatMarkdownInline(c[1])}</li>`);const d=t.match(/^\d+\.\s+(.*)$/);if(d)return o(),r||(s(),i.push("<ol>"),r=!0),void i.push(`<li>${this.formatMarkdownInline(d[1])}</li>`);a.push(e)}),o(),s(),i.join("")}formatMarkdownInline(e=""){if(!e)return"";const t=/\[([^\]]+)\]\(([^)]+)\)/g;let i,a=0,n="";for(;null!==(i=t.exec(e));){if(i.index>a){const t=e.slice(a,i.index);n+=this.applyBasicInlineFormatting(t)}const t=this.applyBasicInlineFormatting(i[1]);n+=`<a href="${this.escapeHTML(this.sanitizeMarkdownUrl(i[2]))}" target="_blank" rel="noopener noreferrer">${t}</a>`,a=i.index+i[0].length}return a<e.length&&(n+=this.applyBasicInlineFormatting(e.slice(a))),n}applyBasicInlineFormatting(e=""){if(!e)return"";let t=this.escapeHTML(e);return t=t.replace(/`([^`]+)`/g,"<code>$1</code>"),t=t.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>"),t=t.replace(/__([^_]+)__/g,"<strong>$1</strong>"),t=t.replace(/\*(?!\s)([^*]+?)\*(?!\*)/g,"<em>$1</em>"),t=t.replace(/_([^_]+)_/g,"<em>$1</em>"),t}sanitizeMarkdownUrl(e=""){try{const t=e.trim();if(!t)return"#";if(t.startsWith("#")){const e=t.slice(1);return e&&/^[a-z0-9_-]{1,64}$/i.test(e)?`#${e}`:"#"}const i=t.toLowerCase();return i.startsWith("http://")||i.startsWith("https://")?t:"#"}catch(e){return"#"}}updateTickerPreview(e){const t=document.getElementById("ticker-preview");if(e&&e.trim()){const i=e.toUpperCase().trim(),a=this.generateTickerLink(i);t.innerHTML="";const n=document.createTextNode("Search ");t.appendChild(n);const r=document.createElement("a");r.href=a,r.target="_blank",r.rel="noopener noreferrer",r.className="ticker-link",r.textContent=i,r.addEventListener("click",e=>{e.preventDefault(),window.open(a,"_blank","noopener,noreferrer")}),t.appendChild(r);const s=document.createTextNode(" on Investing.com");t.appendChild(s)}else t.innerHTML=""}setTodayDate(){const e=this.currentDate,t=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`,i=document.getElementById("entryDate");i&&!this.currentEditingId&&(i.value=t)}showView(e){document.querySelectorAll(".nav-item").forEach(e=>{e.classList.remove("active")});const t=document.querySelector(`[data-view="${e}"]`);t&&t.classList.add("active"),document.querySelectorAll(".view").forEach(e=>{e.classList.remove("active")});const i=document.querySelector(`.${e}-view`);i&&i.classList.add("active");const a={dashboard:"Options Trading Dashboard","add-trade":this.currentEditingId?"Edit Trade":"Add New Trade","trades-list":"All Trades",settings:"Settings"}[e]||"GammaLedger";switch(document.getElementById("page-title").textContent=a,this.currentView=e,e){case"dashboard":this.updateDashboard();break;case"add-trade":this.currentEditingId||this.resetAddTradeForm();break;case"trades-list":this.updateTradesList();break;case"settings":{const e=this.finnhub?.lastStatus;e&&this.finnhub?.elements?.status&&this.updateFinnhubStatus(e.message,e.variant,0);break}}}resetAddTradeForm(){document.getElementById("add-trade-form").reset(),this.setTodayDate(),this.updateTickerPreview(""),document.getElementById("conviction-display").textContent="5";const e=document.getElementById("cycleId"),t=document.getElementById("cycleType"),i=document.getElementById("cycleRole");e&&(e.value=""),t&&(t.value=""),i&&(i.value=""),this.currentEditingId=null}parseDecimal(e,t=null,{allowNegative:i=!0}={}){if(null==e)return t;const a="string"==typeof e?e.trim():e;if(""===a)return t;const n=Number(a);return Number.isFinite(n)?!i&&n<0?t:n:t}parseInteger(e,t=null,{allowNegative:i=!0}={}){if(null==e)return t;const a="string"==typeof e?e.trim():e;if(""===a)return t;const n=parseInt(a,10);return Number.isFinite(n)?!i&&n<0?t:n:t}parseExitPrice(e){const t=this.parseDecimal(e,null,{allowNegative:!1});return null===t?null:t}handleTradeSubmit(){const e=document.getElementById("add-trade-form"),t=new FormData(e),i=t.get("tradeType"),a=Math.abs(this.parseInteger(t.get("quantity"),0,{allowNegative:!1})||0);let n=a;["STO","BTC"].includes(i)&&(n=-a);const r=this.parseDecimal(t.get("definedRiskWidth"),null,{allowNegative:!1}),s=this.parseDecimal(t.get("maxRiskOverride"),null,{allowNegative:!1}),o={ticker:t.get("ticker").toUpperCase(),strategy:t.get("strategy"),tradeType:i,quantity:n,entryDate:t.get("entryDate"),expirationDate:t.get("expirationDate"),exitDate:t.get("exitDate")||null,status:t.get("status"),stockPriceAtEntry:this.parseDecimal(t.get("stockPriceAtEntry")),strikePrice:this.parseDecimal(t.get("strikePrice")),entryPrice:this.parseDecimal(t.get("entryPrice")),exitPrice:this.parseExitPrice(t.get("exitPrice")),fees:this.parseDecimal(t.get("fees"),0),ivRank:this.parseInteger(t.get("ivRank")),delta:this.parseDecimal(t.get("delta")),gamma:this.parseDecimal(t.get("gamma")),theta:this.parseDecimal(t.get("theta")),vega:this.parseDecimal(t.get("vega")),marketCondition:t.get("marketCondition"),convictionLevel:this.parseInteger(t.get("convictionLevel"),5,{allowNegative:!1}),notes:t.get("notes"),exitReason:t.get("exitReason")||null,cycleId:t.get("cycleId"),cycleType:t.get("cycleType"),cycleRole:t.get("cycleRole"),definedRiskWidth:null!==r&&r>0?r:null,maxRiskOverride:null!==s&&s>0?s:null};if(this.currentEditingId)this.updateTrade(o)&&(this.showNotification("Trade updated successfully","success"),this.currentEditingId=null,document.getElementById("page-title").textContent="All Trades",this.resetAddTradeForm(),this.showView("trades-list"));else{o.id=Date.now();const e=this.enrichTradeData(o);this.trades.push(e),this.saveToStorage(),this.markUnsavedChanges(),this.resetAddTradeForm(),this.showView("dashboard")}}updateTrade(e){try{e.id=this.currentEditingId;const t=this.enrichTradeData(e),i=this.trades.findIndex(e=>e.id===this.currentEditingId);return-1!==i&&(this.trades[i]=t,this.saveToStorage(),this.markUnsavedChanges(),!0)}catch(e){return console.error("Error updating trade:",e),!1}}updateDashboard(){const e=this.calculateAdvancedStats(),{openTradesList:t,closedTradesList:i}=e;this.aiAgent&&this.aiAgent.updateContext({stats:e,openTrades:t,closedTrades:i}),this.cycleAnalytics=this.calculateCycleAnalytics(),document.getElementById("total-pl").textContent=this.formatCurrency(e.totalPL),document.getElementById("pl-percentage").textContent=`${e.totalROI.toFixed(2)}% Return`,document.getElementById("win-rate").textContent=`${e.winRate.toFixed(1)}%`,document.getElementById("win-loss-count").textContent=`${e.wins}W / ${e.losses}L`,document.getElementById("profit-factor").textContent=e.profitFactor.toFixed(2),document.getElementById("active-positions").textContent=e.activePositions;const a=document.getElementById("portfolio-delta");a&&(this.areGreeksEnabled()?(a.textContent=`Δ: ${e.portfolioDelta.toFixed(2)}`,a.classList.remove("feature-disabled-label")):(a.textContent="Δ tracking paused",a.classList.add("feature-disabled-label"))),document.getElementById("total-roi").textContent=`${e.annualizedROI.toFixed(2)}%`,document.getElementById("max-drawdown").textContent=`${e.maxDrawdown.toFixed(1)}%`,this.updatePortfolioGreeks(t),this.updateRiskMetrics(i,e),this.updateActivePositionsTable(t),this.updateRecentTradesTable(i,e.activePositions),this.updateCycleSummaryTable(this.cycleAnalytics),setTimeout(()=>{this.updateAllCharts()},200)}calculateAdvancedStats(){const e=this.trades.filter(e=>this.isClosedStatus(e.status)),t=this.trades.filter(e=>"open"===this.normalizeStatus(e.status)),i=e.filter(e=>e.pl>0),a=e.filter(e=>e.pl<0),n=e.reduce((e,t)=>e+t.pl,0),r=e.reduce((e,t)=>{const i=this.getCapitalAtRisk(t);return i>0?e+i:e},0),s=e.length>0?i.length/e.length*100:0,o=i.reduce((e,t)=>e+t.pl,0),l=Math.abs(a.reduce((e,t)=>e+t.pl,0)),c=l>0?o/l:o>0?999:0,d=t.reduce((e,t)=>e+(t.delta||0)*t.quantity,0);let u=0,h=0,m=0;[...e].sort((e,t)=>new Date(e.exitDate)-new Date(t.exitDate)).forEach(e=>{m+=e.pl,m>h&&(h=m);const t=h>0?(h-m)/h*100:0;t>u&&(u=t)});const p=r>0?n/r*100:0,y=e.length>0?e.reduce((e,t)=>e+t.daysHeld,0)/e.length:0,g=y>0?100*(Math.pow(1+p/100,365/y)-1):0;return{totalTrades:this.trades.length,totalPL:n,winRate:s,wins:i.length,losses:a.length,profitFactor:c,activePositions:t.length,portfolioDelta:d,totalROI:p,annualizedROI:g,maxDrawdown:u,closedTrades:e.length,totalInvestment:r,closedTradesList:e,openTradesList:t}}calculateCycleAnalytics(){const e=new Map;this.trades.forEach(t=>{const i=this.normalizeCycleId(t.cycleId);if(!i)return;const a=e.get(i)||{cycleId:i,cycleType:this.normalizeCycleType(t.cycleType,t.strategy),trades:[],ticker:t.ticker||""};!a.ticker&&t.ticker&&(a.ticker=t.ticker),a.cycleType||(a.cycleType=this.normalizeCycleType(t.cycleType,t.strategy)),a.trades.push(t),e.set(i,a)});const t=Array.from(e.values()).map(e=>this.computeCycleMetrics(e));return t.sort((e,t)=>{const i=e.startDate?new Date(e.startDate).getTime():0;return(t.startDate?new Date(t.startDate).getTime():0)-i}),t}computeCycleMetrics(e){const t=[...e.trades].sort((e,t)=>new Date(e.entryDate)-new Date(t.entryDate)),i=this.normalizeCycleType(e.cycleType,t[0]?.strategy||"");let a=null,n=null,r=!1,s=0,o=0,l=0,c=0,d=0,u=0,h=0,m=null,p=null,y=null,g=0,f=0;t.forEach(e=>{const t=e.entryDate?new Date(e.entryDate):null;t&&!isNaN(t.getTime())&&(!a||t<a)&&(a=t);const i=e.exitDate?new Date(e.exitDate):null;i&&!isNaN(i.getTime())?(!n||i>n)&&(n=i):r=!0;const b=Number(e.pl)||0;o+=b;const C=Math.abs(Number(e.quantity)||0);C>f&&(f=C);if("short"===(e.tradeDirection||this.inferTradeDirection(e))){const t=this.calculateOptionPremium(e);if(s+=t,this.isWheelPut(e)){l+=t;const i=Number(e.strikePrice)||0;!m&&i>0&&(m=i);const a=i*C*100;a>h&&(h=a)}(this.isCoveredCall(e)||this.isPmccShortCall(e))&&(c+=t)}else if(this.isPmccBaseLeg(e)){const t=Number(e.entryPrice),i=Number(e.exitPrice),a=Number(e.fees),n=Number.isFinite(t)?t*C*100:0,r=Number.isFinite(i)?i*C*100:0,s=Number.isFinite(a)?Math.max(a,0):0;d+=n-r+s,n>0&&(u+=n+s);const o=Number(e.strikePrice);Number.isFinite(o)&&o>0&&(this.isClosedStatus(e.status)||(y=o),p=o)}if(this.isAssignmentTrade(e)){g+=C;const t=Number(e.strikePrice)||Number(e.stockPriceAtEntry)||null;if(!m&&Number.isFinite(t)&&t>0&&(m=t),Number.isFinite(t)&&t>0){const e=t*C*100;e>h&&(h=e)}}}),Number.isFinite(y)&&y>0&&(p=y);const b=r?"In Progress":"Closed",C=a?a.toISOString():null,v=!r&&n?n.toISOString():null;let k=null,x=null,T=null,w=null;if("wheel"===i&&m&&f>0)k=m-s/(100*f),x=k,T=h||m*f*100;else if("pmcc"===i){w=d-c;const e=Number.isFinite(w)&&w>0?w:null,t=d>0?d:null,i=u>0?u:null;e?T=e:t?T=t:i&&(T=i);const a=e||t||i;a&&a>h&&(h=a),Number.isFinite(p)&&p>0&&f>0&&Number.isFinite(w)&&(x=p+w/(100*f))}Number.isFinite(d)&&Math.abs(d)<1e-6&&(d=0),Number.isFinite(w)&&Math.abs(w)<1e-6&&(w=0);let I=T;if((!I||I<=0)&&("wheel"===i?I=h||(m&&f>0?m*f*100:null):"pmcc"===i&&(Number.isFinite(w)&&w>0?I=w:d>0?I=d:u>0&&(I=u))),!I||I<=0){const e=t.reduce((e,t)=>{const i=Math.abs(Number(t.quantity)||0);if(!i)return e;const a=Number(t.entryPrice),n=Number(t.fees)||0,r=this.getTradeType(t);if("BTO"===r||"BTC"===r){const t=(Number.isFinite(a)?a:0)*i*100+(Number.isFinite(n)?Math.max(n,0):0);return e+Math.max(t,0)}return e},0);I=e>0?e:null}(!T||T<=0)&&(T=I&&I>0?I:null);const N=T?o/T*100:null;let S="",P=null;return"wheel"===i&&null!==k?(S="Eff. Basis",P=k):"pmcc"===i&&null!==w&&(S="Net Basis",P=w),{cycleId:e.cycleId,cycleType:i,typeLabel:"pmcc"===i?"PMCC":"wheel"===i?"Wheel":i?i.toUpperCase():"Custom",ticker:e.ticker||t[0]?.ticker||"—",trades:t,startDate:C,endDate:v,status:b,totalPremiums:s,totalPL:o,putPremiums:l,callPremiums:c,baseCost:d,baseInitialCost:u,capitalAtRisk:h,effectiveCostBasis:k,netBasis:w,costBasis:I,assignments:g,maxContracts:f,roiPercent:N,keyMetricLabel:S,keyMetricValue:P,breakevenPrice:x,hasOpenTrade:r,durationDays:a?this.calculateDaysBetween(a,n||this.currentDate):0}}updateCycleSummaryTable(e=this.cycleAnalytics||[]){const t=document.querySelector("#cycle-summary-table tbody"),i=document.getElementById("cycle-summary-empty");if(!t)return;if(t.innerHTML="",!Array.isArray(e)||0===e.length)return void(i&&i.classList.remove("hidden"));i&&i.classList.add("hidden");const a=["Cycle","Type","Ticker","Status","Trades","Premiums","Total P&L","ROI","Cost Basis","Key Metrics","Timeline"];e.forEach(e=>{const i=t.insertRow(),n=i.insertCell(0),r=this.normalizeCycleId(e.cycleId);if(r){const t=document.createElement("button");t.type="button",t.className="cycle-chip cycle-chip--link",t.textContent=r,t.title="Open All Trades filtered by this cycle",t.addEventListener("click",()=>{this.openTradesFilteredByCycle(r,e.ticker)}),n.appendChild(t)}else n.textContent="—";i.insertCell(1).textContent=e.typeLabel,i.insertCell(2).textContent=e.ticker||"—";const s=i.insertCell(3),o=document.createElement("span"),l="Closed"===e.status?"closed":"open";o.className=`status-badge ${l}`,o.textContent=e.status,s.appendChild(o),i.insertCell(4).textContent=e.trades.length;i.insertCell(5).textContent=this.formatCurrency(e.totalPremiums);const c=i.insertCell(6);c.textContent=this.formatCurrency(e.totalPL),e.totalPL>0?c.className="pl-positive":e.totalPL<0?c.className="pl-negative":c.className="pl-neutral";const d=i.insertCell(7);d.textContent=this.formatPercent(e.roiPercent),e.roiPercent>0?d.className="pl-positive":e.roiPercent<0?d.className="pl-negative":d.className="pl-neutral";const u=i.insertCell(8);Number.isFinite(e.costBasis)?u.textContent=this.formatCurrency(e.costBasis):(u.textContent="—",u.className="pl-neutral");const h=i.insertCell(9);if(e.keyMetricLabel&&Number.isFinite(e.keyMetricValue)){const t=document.createElement("div");if(t.className="cell-metric__label",t.textContent=`${e.keyMetricLabel}: ${this.formatCurrency(e.keyMetricValue)}`,h.appendChild(t),e.breakevenPrice&&Number.isFinite(e.breakevenPrice)){const t=document.createElement("div");t.className="cell-metric__subtext",t.textContent=`Breakeven: ${this.formatCurrency(e.breakevenPrice)}`,h.appendChild(t)}if("wheel"===e.cycleType&&e.assignments){const t=document.createElement("div");t.className="cell-metric__subtext",t.textContent=`Assignments: ${e.assignments}`,h.appendChild(t)}}else if(Number.isFinite(e.costBasis)){const t=document.createElement("div");if(t.className="cell-metric__label",t.textContent=`Cost Basis: ${this.formatCurrency(e.costBasis)}`,h.appendChild(t),e.breakevenPrice&&Number.isFinite(e.breakevenPrice)){const t=document.createElement("div");t.className="cell-metric__subtext",t.textContent=`Breakeven: ${this.formatCurrency(e.breakevenPrice)}`,h.appendChild(t)}if("wheel"===e.cycleType&&e.assignments){const t=document.createElement("div");t.className="cell-metric__subtext",t.textContent=`Assignments: ${e.assignments}`,h.appendChild(t)}}else"wheel"===e.cycleType&&e.assignments?h.textContent=`Assignments: ${e.assignments}`:h.textContent="—";i.insertCell(10).textContent=this.formatCycleDateRange(e.startDate,e.endDate,e.hasOpenTrade),this.applyResponsiveLabels(i,a)})}updatePortfolioGreeks(e=this.trades.filter(e=>"open"===this.normalizeStatus(e.status))){const t=document.getElementById("portfolio-delta-value"),i=document.getElementById("portfolio-gamma"),a=document.getElementById("portfolio-theta"),n=document.getElementById("portfolio-vega");if(!this.areGreeksEnabled())return t&&(t.textContent="—"),i&&(i.textContent="—"),a&&(a.textContent="—"),void(n&&(n.textContent="—"));const r=Array.isArray(e)?e:[],s=r.reduce((e,t)=>e+(t.delta||0)*t.quantity,0),o=r.reduce((e,t)=>e+(t.gamma||0)*t.quantity,0),l=r.reduce((e,t)=>e+(t.theta||0)*t.quantity,0),c=r.reduce((e,t)=>e+(t.vega||0)*t.quantity,0);t&&(t.textContent=s.toFixed(2)),i&&(i.textContent=o.toFixed(2)),a&&(a.textContent=l.toFixed(2)),n&&(n.textContent=c.toFixed(2))}updateRiskMetrics(e=this.trades.filter(e=>this.isClosedStatus(e.status)),t=null){const i=Array.isArray(e)?e:[];if(0===i.length)return document.getElementById("sharpe-ratio").textContent="0.00",document.getElementById("calmar-ratio").textContent="0.00",document.getElementById("volatility").textContent="0.00%",void(document.getElementById("expectancy").textContent="$0.00");const a=i.map(e=>Number(e.roi)/100).filter(e=>Number.isFinite(e));if(0===a.length)return document.getElementById("sharpe-ratio").textContent="0.00",document.getElementById("calmar-ratio").textContent="0.00",document.getElementById("volatility").textContent="0.00%",void(document.getElementById("expectancy").textContent="$0.00");const n=a.reduce((e,t)=>e+t,0)/a.length,r=a.reduce((e,t)=>e+Math.pow(t-n,2),0)/a.length,s=Math.sqrt(r),o=100*s,l=s>0?n*Math.sqrt(252)/s:0,c=i.filter(e=>e.pl>0),d=i.filter(e=>e.pl<0),u=c.length>0?c.reduce((e,t)=>e+t.pl,0)/c.length:0,h=d.length>0?Math.abs(d.reduce((e,t)=>e+t.pl,0)/d.length):0,m=u*(c.length/i.length)-h*(d.length/i.length),p=t??this.calculateAdvancedStats(),y=p.totalPL,g=p.totalInvestment,f=g>0?y/g*100:0,b=p.maxDrawdown>0?f/p.maxDrawdown:0;document.getElementById("sharpe-ratio").textContent=l.toFixed(2),document.getElementById("calmar-ratio").textContent=b.toFixed(2),document.getElementById("volatility").textContent=`${o.toFixed(2)}%`,document.getElementById("expectancy").textContent=this.formatCurrency(m)}updateActivePositionsTable(e=this.trades.filter(e=>"Open"===e.status)){const t=document.querySelector("#active-positions-table tbody");if(t){t.innerHTML="";const i=[...Array.isArray(e)?e:[]].sort((e,t)=>this.parseInteger(e.dte,Number.POSITIVE_INFINITY,{allowNegative:!1})-this.parseInteger(t.dte,Number.POSITIVE_INFINITY,{allowNegative:!1})),a=["Ticker","Strategy","Trade Type","Strike","Current Price","DTE","Max Risk","Notes"],n=new Map;i.forEach(e=>{const i=t.insertRow();i.dataset.tradeId=String(e.id??"");const r=i.insertCell(0),s=(e.ticker??"").toString().trim().toUpperCase(),o=this.createTickerElement(e.ticker,"ticker-pill",{behavior:"filter",onClick:e=>this.openTradesFilteredByTicker(e),title:s?`View all trades for ${s}`:""});r.appendChild(o),i.dataset.ticker=s,i.insertCell(1).textContent=e.strategy||"—";const l=i.insertCell(2),c=this.getTradeType(e);l.textContent=c;l.className={BTO:"trade-type-bto",STO:"trade-type-sto",STC:"trade-type-stc",BTC:"trade-type-btc"}[c]||"";const d=this.parseDecimal(e.strikePrice);i.insertCell(3).textContent=null!==d?`$${d.toFixed(2)}`:"—",Number.isFinite(d)?i.dataset.strikePrice=String(d):delete i.dataset.strikePrice;const u=i.insertCell(4);u.className="quote-cell";const h=`${this.getQuoteEntryKey(e)}|row:${n.size}`;i.dataset.quoteKey=h,this.populateQuoteCell(u,e,i,{deferNetworkFetch:!0}),n.set(h,{trade:e,row:i,cell:u,key:h});const m=this.parseInteger(e.dte,null,{allowNegative:!1});i.insertCell(5).textContent=null!==m?m:"—",Number.isFinite(m)?i.dataset.dte=String(m):delete i.dataset.dte;const p=i.insertCell(6),y=this.parseDecimal(e.maxRisk,null,{allowNegative:!1});null!==y?(p.textContent=this.formatCurrency(y),p.className="pl-negative"):(p.textContent="—",p.className="pl-neutral");const g=i.insertCell(7),f=(e.notes||"").trim();g.textContent=f||"—",this.updateExpirationHighlight(i,e),this.applyResponsiveLabels(i,a)}),this.activeQuoteEntries=n,this.rebuildQuoteRefreshSchedule(),this.startQuoteAutoRefreshIfNeeded(),this.refreshActivePositionsQuotes({force:!0,immediate:!0})}}updateRecentTradesTable(e=this.trades.filter(e=>this.isClosedStatus(e.status)),t=this.trades.filter(e=>"open"===this.normalizeStatus(e.status)).length){const i=Number(t),a=Math.max(Number.isFinite(i)?i:0,10),n=[...Array.isArray(e)?e:[]].sort((e,t)=>new Date(t.exitDate)-new Date(e.exitDate)).slice(0,a),r=document.querySelector("#recent-trades-table tbody");if(r){r.innerHTML="";const e=["Ticker","Strategy","Exit Date","Days Held","P&L","ROI"];n.forEach(t=>{const i=r.insertRow(),a=i.insertCell(0),n=(t.ticker??"").toString().trim().toUpperCase(),s=this.createTickerElement(t.ticker,"ticker-pill",{behavior:"filter",onClick:e=>this.openTradesFilteredByTicker(e),title:n?`View all trades for ${n}`:""});a.appendChild(s),i.insertCell(1).textContent=t.strategy,i.insertCell(2).textContent=this.formatDate(t.exitDate);const o=i.insertCell(3),l=Number(t.daysHeld);o.textContent=Number.isFinite(l)?l:"—";const c=i.insertCell(4);c.textContent=this.formatCurrency(t.pl),c.className=t.pl>=0?"pl-positive":"pl-negative";const d=i.insertCell(5),u=Number(t.roi);Number.isFinite(u)?(d.textContent=`${u.toFixed(2)}%`,d.className=u>=0?"pl-positive":"pl-negative"):(d.textContent="—",d.className="pl-neutral"),this.applyResponsiveLabels(i,e)})}}updateAllCharts(){this.updateMonthlyPLChart(),this.updateCumulativePLChart(),this.updateStrategyPerformanceChart(),this.updateWinRateByStrategyChart(),this.updateMarketConditionChart()}initializeGeminiControls(){const e=document.getElementById("gemini-controls");if(!e)return;const t=document.getElementById("gemini-api-key"),i=document.getElementById("gemini-model"),a=document.getElementById("gemini-save"),n=document.getElementById("gemini-clear"),r=document.getElementById("gemini-status");if(this.gemini.elements={container:e,keyInput:t,modelSelect:i,saveButton:a,clearButton:n,status:r},t&&(t.value=this.gemini.apiKey),GEMINI_ALLOWED_MODELS.includes(this.gemini.model)||(this.gemini.model=DEFAULT_GEMINI_MODEL),i){0===Array.from(i.options).map(e=>e.value).length&&GEMINI_ALLOWED_MODELS.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e.replace(/gemini-2\.5-/,"Gemini 2.5 ").replace(/-/g," ").replace(/\b([a-z])/g,(e,t)=>t.toUpperCase()),i.appendChild(t)}),i.value=GEMINI_ALLOWED_MODELS.includes(this.gemini.model)?this.gemini.model:DEFAULT_GEMINI_MODEL,this.setGeminiModel(i.value),i.addEventListener("change",()=>{this.setGeminiModel(i.value),this.saveGeminiConfigToStorage()})}if(r){const e=this.gemini.apiKey?"success":"neutral",t=this.gemini.apiKey?"API key loaded":"Not set";this.updateGeminiStatus(t,e)}const s=async()=>{const e=(t?.value||"").trim();this.setGeminiApiKey(e,{persist:!1,updateUI:!1});const i=this.gemini.apiKey,a=this.getCrypto();if(!e)return this.removeGeminiEncryptionKey(),this.saveGeminiConfigToStorage(),t&&(t.value=""),this.updateGeminiStatus("API key cleared. Connect your Gemini key via Settings to get tailored analysis.","neutral",6e3),this.initializeAIChat(),void this.updateAIChatHeader();if(!a?.subtle)return this.saveGeminiConfigToStorage({includeApiKey:!0}),this.updateGeminiStatus("Gemini API key saved (unencrypted — Web Crypto unavailable).","success",6e3),t&&(t.value=i),this.initializeAIChat(),void this.updateAIChatHeader();await this.encryptAndStoreGeminiApiKey(a)?this.updateGeminiStatus("Gemini API key saved securely.","success",5e3):(this.saveGeminiConfigToStorage({includeApiKey:!0}),this.updateGeminiStatus("Gemini API key saved (unencrypted fallback).","neutral",6e3)),t&&(t.value=i),this.initializeAIChat(),this.updateAIChatHeader()};a?.addEventListener("click",async e=>{e.preventDefault(),await s()}),t?.addEventListener("keydown",async e=>{"Enter"===e.key&&(e.preventDefault(),await s())}),n?.addEventListener("click",e=>{e.preventDefault(),t&&(t.value=""),this.setGeminiApiKey("",{persist:!1,updateUI:!1}),this.removeGeminiEncryptionKey(),this.saveGeminiConfigToStorage(),this.updateGeminiStatus("API key cleared. Connect your Gemini key via Settings to get tailored analysis.","neutral",6e3),this.initializeAIChat(),this.updateAIChatHeader()}),this.updateAIChatHeader()}getGeminiModelLabel(e=""){const t=(e||"").toLowerCase(),i={"gemini-2.5-flash-lite":"Gemini 2.5 Flash Lite","gemini-2.5-flash":"Gemini 2.5 Flash","gemini-2.5-pro":"Gemini 2.5 Pro"};if(i[t])return i[t];if(!t)return"";return t.replace(/^gemini[-\s]?/i,"Gemini ").replace(/-/g," ").replace(/\b([a-z])/g,(e,t)=>t.toUpperCase()).trim()||"Gemini"}getGeminiChatDisplayName(){const e=this.getGeminiModelLabel(this.gemini?.model);return e||"Gemini"}updateAIChatHeader(){const e=document.getElementById("ai-chat-title"),t=document.getElementById("ai-chat-subtitle");if(!e&&!t)return;if(e&&(e.textContent="Portfolio AI Coach"),!t)return;Boolean(this.gemini?.apiKey)?t.textContent="Ask about your portfolio for AI-guided insights.":t.innerHTML='Connect your Gemini API key in <a href="#settings" class="ai-chat__settings-link">Settings</a> to get tailored analysis.'}updateGeminiStatus(e,t="neutral",i=0){const a=this.gemini?.elements?.status;if(!a||!e)return;const n=["success","error","neutral"].includes(t)?t:"neutral";a.textContent=e,a.classList.remove("is-success","is-error"),"success"===n?a.classList.add("is-success"):"error"===n&&a.classList.add("is-error"),this.gemini.statusTimeoutId&&clearTimeout(this.gemini.statusTimeoutId),this.gemini.lastStatus={message:e,variant:n},i>0&&(this.gemini.statusTimeoutId=setTimeout(()=>{a.isConnected&&(a.textContent="neutral"===n?"Not set":"",a.classList.remove("is-success","is-error"))},i))}setGeminiApiKey(e,{persist:t=!1,updateUI:i=!0}={}){const a=(e||"").trim();a!==this.gemini.apiKey&&(this.gemini.apiKey=a,i&&this.gemini.elements?.keyInput&&(this.gemini.elements.keyInput.value=a),t&&this.saveGeminiConfigToStorage({includeApiKey:!0}))}setGeminiModel(e){const t=(e||"").trim(),i=GEMINI_ALLOWED_MODELS.includes(t)?t:DEFAULT_GEMINI_MODEL,a=this.gemini.model;this.gemini.model=i;const n=this.gemini.elements?.modelSelect;n&&n.value!==this.gemini.model&&(n.value=this.gemini.model),this.gemini.model!==a&&(this.updateAIChatHeader(),this.renderAIChatMessages())}async loadGeminiConfigFromStorage(){try{const e=localStorage.getItem(GEMINI_STORAGE_KEY);if(!e)return;const t=JSON.parse(e);if(!t||"object"!=typeof t)return;if("string"==typeof t.model&&t.model.trim()&&this.setGeminiModel(t.model.trim()),t.enc&&t.payload){const e=this.getCrypto();if(!e?.subtle)return void console.warn("Encrypted Gemini API key stored but Web Crypto unavailable.");try{const i=await this.ensureGeminiEncryptionKey(e);if(!i)throw new Error("Encryption key unavailable");const a=await this.decryptString(t.payload,e,i);a&&(this.gemini.apiKey=a)}catch(e){console.warn("Failed to decrypt stored Gemini API key:",e)}}else"string"==typeof t.apiKey&&(this.gemini.apiKey=t.apiKey)}catch(e){console.warn("Failed to load Gemini configuration:",e)}}saveGeminiConfigToStorage({includeApiKey:e=!1,encryptedPayload:t=null}={}){try{const i={model:this.gemini.model};t?(i.enc=!0,i.payload=t):e&&this.gemini.apiKey&&(i.apiKey=this.gemini.apiKey),localStorage.setItem(GEMINI_STORAGE_KEY,JSON.stringify(i))}catch(e){console.warn("Failed to save Gemini configuration:",e)}}removeGeminiEncryptionKey(){try{localStorage.removeItem("GammaLedgerGeminiSecret"),this.gemini.encryptionKey=null}catch(e){console.warn("Failed to remove Gemini encryption key:",e)}}async ensureGeminiEncryptionKey(e=this.getCrypto()){if(!e?.subtle)return null;if(this.gemini.encryptionKey)return this.gemini.encryptionKey;let t=localStorage.getItem("GammaLedgerGeminiSecret");if(!t){const i=e.getRandomValues(new Uint8Array(32));t=this.arrayBufferToBase64(i.buffer),localStorage.setItem("GammaLedgerGeminiSecret",t)}const i=new Uint8Array(this.base64ToArrayBuffer(t)),a=await e.subtle.importKey("raw",i,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"]);return this.gemini.encryptionKey=a,a}async encryptAndStoreGeminiApiKey(e=this.getCrypto()){try{if(!e?.subtle)throw new Error("Web Crypto API unavailable");const t=this.gemini.apiKey||"";if(!t)return this.saveGeminiConfigToStorage(),!0;const i=await this.ensureGeminiEncryptionKey(e);if(!i)throw new Error("Failed to prepare encryption key");const a=await this.encryptString(t,e,i);return this.saveGeminiConfigToStorage({encryptedPayload:a}),!0}catch(e){return console.warn("Failed to encrypt Gemini API key:",e),!1}}initializeFinnhubControls(){const e=document.getElementById("finnhub-controls");if(!e)return;const t=document.getElementById("finnhub-api-key"),i=document.getElementById("finnhub-save"),a=document.getElementById("finnhub-status");if(this.finnhub.elements={container:e,input:t,saveButton:i,status:a},t&&(t.value=this.finnhub.apiKey),a){const e=this.finnhub.apiKey?"success":"neutral",t=this.finnhub.apiKey?"API key loaded":"Not set";this.updateFinnhubStatus(t,e,4e3)}const n=async()=>{const e=(t?.value||"").trim();this.setFinnhubApiKey(e,{persist:!1,updateUI:!0,markUnsaved:!1});const i=this.getCrypto();if(!e)return this.removeFinnhubConfigFromStorage(),this.updateFinnhubStatus("API key cleared. Live prices disabled.","neutral",5e3),void this.updateActivePositionsTable();if(!i?.subtle)return this.saveFinnhubConfigToStorage(),this.updateFinnhubStatus("Finnhub API key saved (unencrypted — Web Crypto unavailable).","success",6e3),void this.updateActivePositionsTable();await this.encryptAndStoreFinnhubApiKey(i)?this.updateFinnhubStatus("Finnhub API key saved securely.","success",5e3):(this.saveFinnhubConfigToStorage(),this.updateFinnhubStatus("Finnhub API key saved (unencrypted fallback).","neutral",6e3)),this.updateActivePositionsTable()};i?.addEventListener("click",async e=>{e.preventDefault(),await n()}),t?.addEventListener("keydown",async e=>{"Enter"===e.key&&(e.preventDefault(),await n())})}updateFinnhubStatus(e,t="neutral",i=0){const a=this.finnhub?.elements?.status;if(!a||!e)return;const n=["success","error","neutral"].includes(t)?t:"neutral";a.textContent=e,a.classList.remove("is-success","is-error"),"success"===n?a.classList.add("is-success"):"error"===n&&a.classList.add("is-error"),this.finnhub.statusTimeoutId&&clearTimeout(this.finnhub.statusTimeoutId),this.finnhub.lastStatus={message:e,variant:n},i>0&&(this.finnhub.statusTimeoutId=setTimeout(()=>{a.isConnected&&(a.textContent="neutral"===n?"Not set":"",a.classList.remove("is-success","is-error"))},i))}setFinnhubApiKey(e,{persist:t=!1,updateUI:i=!0,markUnsaved:a=!1}={}){const n=(e||"").trim();n!==this.finnhub.apiKey&&(this.finnhub.apiKey=n,this.finnhub.cache.clear(),this.finnhub.outstandingRequests.clear(),i&&this.finnhub.elements?.input&&(this.finnhub.elements.input.value=n),t&&this.saveFinnhubConfigToStorage(),a&&this.markUnsavedChanges())}getFinnhubStorageKey(){return"GammaLedgerFinnhubConfig"}async loadFinnhubConfigFromStorage(){try{const e=localStorage.getItem(this.getFinnhubStorageKey());if(!e)return;const t=JSON.parse(e);if(!t)return;if(t.enc&&t.payload){const e=this.getCrypto();if(!e?.subtle)return console.warn("Encrypted Finnhub API key stored but Web Crypto unavailable."),void this.updateFinnhubStatus("Stored Finnhub key is encrypted, but this browser cannot decrypt it.","error",7e3);try{const i=await this.ensureFinnhubEncryptionKey(e);if(!i)throw new Error("Encryption key unavailable");const a=await this.decryptString(t.payload,e,i);a&&(this.finnhub.apiKey=a)}catch(e){console.warn("Failed to decrypt stored Finnhub API key:",e),this.updateFinnhubStatus("Failed to decrypt stored Finnhub API key.","error",6e3)}return}"string"==typeof t.apiKey&&(this.finnhub.apiKey=t.apiKey)}catch(e){console.warn("Failed to load Finnhub configuration:",e)}}saveFinnhubConfigToStorage(){try{const e={apiKey:this.finnhub.apiKey};localStorage.setItem(this.getFinnhubStorageKey(),JSON.stringify(e))}catch(e){console.warn("Failed to save Finnhub configuration:",e)}}removeFinnhubConfigFromStorage(){try{localStorage.removeItem(this.getFinnhubStorageKey())}catch(e){console.warn("Failed to remove Finnhub configuration:",e)}}arrayBufferToBase64(e){const t=new Uint8Array(e);let i="";for(let e=0;e<t.byteLength;e++)i+=String.fromCharCode(t[e]);return btoa(i)}base64ToArrayBuffer(e){const t=atob(e),i=t.length,a=new Uint8Array(i);for(let e=0;e<i;e++)a[e]=t.charCodeAt(e);return a.buffer}getFinnhubSecretStorageKey(){return"GammaLedgerFinnhubSecret"}async ensureFinnhubEncryptionKey(e=this.getCrypto()){if(!e?.subtle)return null;if(this.finnhub.encryptionKey)return this.finnhub.encryptionKey;let t=localStorage.getItem(this.getFinnhubSecretStorageKey());if(!t){const i=e.getRandomValues(new Uint8Array(32));t=this.arrayBufferToBase64(i.buffer),localStorage.setItem(this.getFinnhubSecretStorageKey(),t)}const i=new Uint8Array(this.base64ToArrayBuffer(t)),a=await e.subtle.importKey("raw",i,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"]);return this.finnhub.encryptionKey=a,a}async encryptString(e,t,i){const a=t.getRandomValues(new Uint8Array(12)),n=new TextEncoder,r=await t.subtle.encrypt({name:"AES-GCM",iv:a},i,n.encode(e));return{iv:this.arrayBufferToBase64(a.buffer),ct:this.arrayBufferToBase64(r)}}getCrypto(){return"undefined"!=typeof globalThis&&globalThis.crypto?globalThis.crypto:"undefined"!=typeof window&&window.crypto?window.crypto:null}async decryptString(e,t,i){const a=new Uint8Array(this.base64ToArrayBuffer(e.iv)),n=this.base64ToArrayBuffer(e.ct),r=await t.subtle.decrypt({name:"AES-GCM",iv:a},i,n);return(new TextDecoder).decode(r)}async encryptAndStoreFinnhubApiKey(e=this.getCrypto()){try{if(!e?.subtle)throw new Error("Web Crypto API unavailable");const t=this.finnhub.apiKey||"";if(!t)return this.removeFinnhubConfigFromStorage(),!0;const i=await this.ensureFinnhubEncryptionKey(e);if(!i)throw new Error("Failed to prepare encryption key");const a=await this.encryptString(t,e,i);return localStorage.setItem(this.getFinnhubStorageKey(),JSON.stringify({enc:!0,payload:a})),!0}catch(e){return console.warn("Failed to encrypt Finnhub API key:",e),!1}}getQuoteEntryKey(e){if(!e||"object"!=typeof e)return"unknown";const t=e.id??e.tradeId??e.uid??e.uniqueId;if(null!=t&&""!==t)return`id:${t}`;return`fallback:${(e.ticker||"").toString().trim().toUpperCase()}|${e.entryDate||""}|${e.strikePrice||""}`}rebuildQuoteRefreshSchedule(){this.activeQuoteEntries instanceof Map||(this.activeQuoteEntries=new Map),this.quoteRefreshKeys=Array.from(this.activeQuoteEntries.keys()),this.quoteRefreshCursor=0}startQuoteAutoRefreshIfNeeded(){if(this.activeQuoteEntries instanceof Map||(this.activeQuoteEntries=new Map),0===this.activeQuoteEntries.size)return void this.stopQuoteAutoRefresh();const e=this.computeAutoRefreshInterval();e!==this.autoRefreshIntervalMs&&(this.autoRefreshIntervalMs=e,this.stopQuoteAutoRefresh()),this.quoteRefreshIntervalId||(this.quoteRefreshIntervalId=setInterval(()=>{this.refreshActivePositionsQuotes({force:!0})},this.autoRefreshIntervalMs))}stopQuoteAutoRefresh(){this.quoteRefreshIntervalId&&(clearInterval(this.quoteRefreshIntervalId),this.quoteRefreshIntervalId=null),0===this.activeQuoteEntries?.size&&(this.quoteRefreshKeys=[],this.quoteRefreshCursor=0)}refreshActivePositionsQuotes({force:e=!1,immediate:t=!1}={}){if(!(this.activeQuoteEntries instanceof Map)||0===this.activeQuoteEntries.size)return void this.stopQuoteAutoRefresh();if(Array.isArray(this.quoteRefreshKeys)&&0!==this.quoteRefreshKeys.length||this.rebuildQuoteRefreshSchedule(),0===this.quoteRefreshKeys.length)return void this.stopQuoteAutoRefresh();let i=0;const a=this.quoteRefreshKeys.length;for(;i<a&&this.quoteRefreshKeys.length>0;){const a=this.quoteRefreshCursor%this.quoteRefreshKeys.length,n=this.quoteRefreshKeys[a],r=this.activeQuoteEntries.get(n);if(this.quoteRefreshCursor=(a+1)%this.quoteRefreshKeys.length,i+=1,r&&r.cell?.isConnected&&r.row?.isConnected)return void this.populateQuoteCell(r.cell,r.trade,r.row,{forceRefresh:e,silentIfCached:!e,suppressLoadingText:!t});if(this.activeQuoteEntries.delete(n),this.quoteRefreshKeys.splice(a,1),0===this.quoteRefreshKeys.length)return void this.stopQuoteAutoRefresh()}0===this.activeQuoteEntries.size&&this.stopQuoteAutoRefresh()}populateQuoteCell(e,t,i,a={}){const{forceRefresh:n=!1,deferNetworkFetch:r=!1,silentIfCached:s=!1,suppressLoadingText:o=!1}=a;if(!e)return;const l=(t?.ticker||"").toString().trim().toUpperCase();if(!l)return e.dataset.priceState="idle",e.textContent="—",void e.classList.remove("quote-error");const c=n?null:this.getCachedQuote(l);if(c)this.renderQuoteValue(e,i,t,c.value);else{if(!this.finnhub.apiKey){e.dataset.priceState="error",this.setQuoteCellError(e,i,t,"Set API key");const a=this.finnhub.lastStatus?.message;return"Add your Finnhub API key to load live prices."!==a&&this.updateFinnhubStatus("Add your Finnhub API key to load live prices.","neutral",6e3),void this.updateItmHighlight(i,t,null)}e.dataset.priceState=n?"refreshing":"loading",n||o||s||(e.textContent="Loading…"),e.classList.remove("quote-error"),this.finnhub.apiKey&&!r&&this.getCurrentPrice(l,{forceRefresh:n}).then(a=>{e.isConnected&&this.renderQuoteValue(e,i,t,a)}).catch(a=>{if(!e.isConnected)return;const n=this.getQuoteErrorMessage(a);this.setQuoteCellError(e,i,t,n)})}}renderQuoteValue(e,t,i,a){if(!e)return;e.dataset.priceState="ready",e.classList.remove("quote-error");const n=Number(a?.price);if(!Number.isFinite(n))return e.textContent="—",void this.applyPositionHighlight(t,i,null);const r=this.getQuoteChangePercent(a),s=this.getQuoteChangeValue(a);e.innerHTML="";const o=document.createElement("span");if(o.className="quote-price",o.textContent=this.formatCurrency(n),e.appendChild(o),Number.isFinite(r)){const t=document.createElement("span");t.className="quote-change";const i=`${r>0?"+":""}${r.toFixed(2)}%`;if(t.textContent=i,r>0?t.classList.add("is-up"):r<0?t.classList.add("is-down"):t.classList.add("is-flat"),Number.isFinite(s)){const e=`${s>0?"+":""}${s.toFixed(2)}`;t.title=`${e} (${i})`}e.appendChild(t)}this.applyPositionHighlight(t,i,n)}getQuoteChangePercent(e){const t=Number(e?.changePercent);if(Number.isFinite(t))return t;const i=Number(e?.change),a=Number(e?.previousClose);if(Number.isFinite(i)&&Number.isFinite(a)&&0!==a)return i/a*100;const n=Number(e?.price);return Number.isFinite(n)&&Number.isFinite(a)&&0!==a?(n-a)/a*100:null}getQuoteChangeValue(e){const t=Number(e?.change);if(Number.isFinite(t))return t;const i=Number(e?.price),a=Number(e?.previousClose);return Number.isFinite(i)&&Number.isFinite(a)?i-a:null}setQuoteCellError(e,t,i,a){if(!e)return;e.dataset.priceState="error",e.classList.add("quote-error");const n=(a||"").trim();if("Set API key"===n){e.textContent="";const t=document.createElement("button");t.type="button",t.className="link-button link-button--inline",t.textContent="Set API key",t.addEventListener("click",e=>{e.preventDefault(),this.showView("settings")}),e.appendChild(t)}else e.textContent=n||"Unavailable";this.applyPositionHighlight(t,i,null)}getQuoteErrorMessage(e){const t=(e?.message||"").toLowerCase();return t?t.includes("api key")?"Set API key":t.includes("rate limit")?"Rate limited":t.includes("symbol")?"Bad ticker":t.includes("network")?"Network error":"Unavailable":"Unavailable"}getCachedQuote(e){if(!e)return null;const t=this.finnhub.cache.get(e);return t?Date.now()-t.timestamp>this.finnhub.cacheTTL?(this.finnhub.cache.delete(e),null):t:null}setCachedQuote(e,t){e&&this.finnhub.cache.set(e,{value:t,timestamp:Date.now()})}async getCurrentPrice(e,{forceRefresh:t=!1}={}){const i=(e||"").toString().trim().toUpperCase();if(!i)throw new Error("Invalid symbol");if(t)this.finnhub.cache.delete(i);else{const e=this.getCachedQuote(i);if(e)return e.value}if(!this.finnhub.apiKey)throw new Error("Finnhub API key missing");const a=this.finnhub.outstandingRequests.get(i);if(a)return a;const n=this.enqueueFinnhubRequest(i).then(e=>(this.setCachedQuote(i,e),e)).catch(e=>{throw this.updateFinnhubStatus(e.message||"Failed to load quote.","error",7e3),e}).finally(()=>{this.finnhub.outstandingRequests.delete(i)});return this.finnhub.outstandingRequests.set(i,n),n}enqueueFinnhubRequest(e){const t=this.finnhub.rateLimitQueue.catch(()=>{}).then(()=>this.performFinnhubFetch(e));return this.finnhub.rateLimitQueue=t.then(()=>{}).catch(()=>{}),t}async performFinnhubFetch(e){await this.enforceFinnhubRateLimit();const t=new URL("https://finnhub.io/api/v1/quote");let i,a;t.searchParams.set("symbol",e),t.searchParams.set("token",this.finnhub.apiKey);try{i=await fetch(t.toString(),{cache:"no-store"})}catch(e){throw new Error("Network error fetching price")}if(!i.ok)throw new Error(429===i.status?"Finnhub rate limit exceeded. Please wait.":"Finnhub API error");try{a=await i.json()}catch(e){throw new Error("Invalid response from Finnhub")}if(a&&"string"==typeof a.error)throw new Error(a.error);const n=Number(a?.c);if(!Number.isFinite(n))throw new Error("Price unavailable for symbol");const r=Number(a?.d),s=Number(a?.dp),o=Number(a?.pc),l=Number(a?.o),c=Number(a?.h),d=Number(a?.l);return{price:n,change:Number.isFinite(r)?r:null,changePercent:Number.isFinite(s)?s:null,previousClose:Number.isFinite(o)?o:null,open:Number.isFinite(l)?l:null,high:Number.isFinite(c)?c:null,low:Number.isFinite(d)?d:null,fetchedAt:(new Date).toISOString(),currency:"USD"}}async enforceFinnhubRateLimit(){const e=this.finnhub.timestamps,t=Date.now();for(;e.length>0&&t-e[0]>=6e4;)e.shift();if(e.length>=this.finnhub.maxRequestsPerMinute){const i=6e4-(t-e[0])+50;await new Promise(e=>setTimeout(e,i))}e.push(Date.now())}applyPositionHighlight(e,t,i=null){e&&(this.updateExpirationHighlight(e,t),this.updateItmHighlight(e,t,i))}updateExpirationHighlight(e,t){if(!e)return;e.classList.remove("position-expiring-critical","position-expiring-warning");const i=this.positionHighlightConfig?.expirationWarningDays??20,a=this.positionHighlightConfig?.expirationCriticalDays??7,n=t?.dte,r=this.parseInteger(n,null,{allowNegative:!0});!Number.isFinite(r)||r<0||(r<a?e.classList.add("position-expiring-critical"):r<i&&e.classList.add("position-expiring-warning"))}updateItmHighlight(e,t,i){if(!e)return;const a=this.isInTheMoney(t,i);e.classList.toggle("position-itm",Boolean(a))}isInTheMoney(e,t){if(!Number.isFinite(t))return!1;const i=Number(e?.strikePrice);if(!Number.isFinite(i))return!1;const a=this.inferOptionFlavor(e);return"call"===a?t>=i:"put"===a&&t<=i}inferOptionFlavor(e={}){const t=(e.optionType||e.optionFlavor||"").toString().trim().toLowerCase();if("call"===t||"put"===t)return t;const i=(e.strategy||"").toLowerCase(),a=i.includes("call"),n=i.includes("put");if(a&&!n)return"call";if(n&&!a)return"put";const r=(e.notes||"").toLowerCase(),s=r.includes("call"),o=r.includes("put");return s&&!o?"call":o&&!s?"put":null}updateMonthlyPLChart(){const e=document.getElementById("monthlyPLChart");if(!e)return;const t=e.getContext("2d");this.charts.monthlyPL&&this.charts.monthlyPL.destroy();const i={};this.trades.filter(e=>this.isClosedStatus(e.status)&&e.exitDate).forEach(e=>{const t=e.exitDate.substring(0,7);i[t]||(i[t]=0),i[t]+=e.pl});const a=Object.keys(i).sort(),n=a.map(e=>new Date(e+"-01").toLocaleDateString("en-US",{month:"short",year:"numeric"}));this.charts.monthlyPL=new Chart(t,{type:"bar",data:{labels:n,datasets:[{label:"Monthly P&L",data:a.map(e=>i[e]),backgroundColor:a.map(e=>i[e]>=0?"#1FB8CD":"#B4413C"),borderColor:a.map(e=>i[e]>=0?"#1FB8CD":"#B4413C"),borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{callback:function(e){return"$"+e.toLocaleString()}}},x:{ticks:{maxRotation:45,minRotation:45}}},plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(e){return"P&L: $"+e.raw.toLocaleString()}}}}}})}updateCumulativePLChart(){const e=document.getElementById("cumulativePLChart");if(!e)return void console.error("Cumulative P&L chart canvas not found");const t=e.getContext("2d");this.charts.cumulativePL&&this.charts.cumulativePL.destroy();const i=this.trades.filter(e=>this.isClosedStatus(e.status)&&e.exitDate),a=()=>{this.charts.cumulativePL=new Chart(t,{type:"line",data:{labels:["No Data"],datasets:[{label:"Cumulative P&L",data:[0],borderColor:"#1FB8CD",backgroundColor:"rgba(31, 184, 205, 0.1)",fill:!1,tension:.4}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{ticks:{callback:function(e){return"$"+e.toLocaleString()}}}},plugins:{legend:{display:!1}}}})};if(0===i.length)return void a();const n=new Map;let r=null,s=null;if(i.forEach(e=>{const t=this.getWeekEndingFriday(e.exitDate);if(!t)return;const i=this.getWeekKey(t);n.set(i,(n.get(i)||0)+e.pl),(!r||t<r)&&(r=new Date(t)),(!s||t>s)&&(s=new Date(t))}),!r||!s)return void a();r.setHours(0,0,0,0),s.setHours(0,0,0,0);const o=[],l=[];let c=0;const d=new Date(r);for(;d.getTime()<=s.getTime();){const e=this.getWeekKey(d);c+=n.get(e)||0,o.push(this.formatWeekLabel(d)),l.push(c),d.setDate(d.getDate()+7)}this.charts.cumulativePL=new Chart(t,{type:"line",data:{labels:o,datasets:[{label:"Cumulative P&L",data:l,borderColor:"#1FB8CD",backgroundColor:"rgba(31, 184, 205, 0.1)",fill:!0,tension:.4,pointRadius:3,pointHoverRadius:6}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{x:{ticks:{callback:function(e){if("string"==typeof e)return e;if("number"==typeof e&&this&&"function"==typeof this.getLabelForValue){const t=this.getLabelForValue(e);if(t)return t}return""},maxRotation:45,minRotation:45}},y:{ticks:{callback:function(e){return"$"+e.toLocaleString()}}}},plugins:{legend:{display:!1},tooltip:{callbacks:{title:function(e){return e[0]?.label||""},label:function(e){return"Cumulative P&L: $"+e.raw.toLocaleString()}}}}}})}getWeekEndingFriday(e){const t=new Date(e);if(isNaN(t.getTime()))return null;const i=new Date(t);i.setHours(0,0,0,0);const a=i.getDay();return 5===a?i:6===a?(i.setDate(i.getDate()-1),i):0===a?(i.setDate(i.getDate()-2),i):(i.setDate(i.getDate()+(5-a)),i)}getWeekKey(e){const t=new Date(e);if(isNaN(t.getTime()))return"";return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}formatWeekLabel(e){const t=new Date(e);return isNaN(t.getTime())?"":t.toLocaleDateString("en-US",{month:"short",day:"2-digit",year:"numeric"})}updateStrategyPerformanceChart(){const e=document.getElementById("strategyChart");if(!e)return;const t=e.getContext("2d");this.charts.strategy&&this.charts.strategy.destroy();const i={};this.trades.filter(e=>this.isClosedStatus(e.status)).forEach(e=>{i[e.strategy]||(i[e.strategy]=0),i[e.strategy]+=e.pl});const a=Object.entries(i).sort(([,e],[,t])=>t-e).slice(0,8);this.charts.strategy=new Chart(t,{type:"bar",data:{labels:a.map(([e])=>e),datasets:[{label:"Total P&L",data:a.map(([,e])=>e),backgroundColor:a.map(([,e])=>e>=0?"#1FB8CD":"#B4413C"),borderColor:a.map(([,e])=>e>=0?"#1FB8CD":"#B4413C"),borderWidth:1}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,scales:{x:{beginAtZero:!0,ticks:{callback:function(e){return"$"+e.toLocaleString()}}}},plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(e){return"P&L: $"+e.raw.toLocaleString()}}}}}})}updateWinRateByStrategyChart(){const e=document.getElementById("winRateChart");if(!e)return;const t=e.getContext("2d");this.charts.winRate&&this.charts.winRate.destroy();const i={};this.trades.forEach(e=>{i[e.strategy]||(i[e.strategy]={total:0,wins:0}),this.isClosedStatus(e.status)&&(i[e.strategy].total++,e.pl>0&&i[e.strategy].wins++)});const a=Object.entries(i).filter(([,e])=>e.total>=1).map(([e,t])=>({strategy:e,winRate:t.wins/t.total*100,total:t.total})).sort((e,t)=>t.winRate-e.winRate);this.charts.winRate=new Chart(t,{type:"doughnut",data:{labels:a.map(e=>`${e.strategy} (${e.total})`),datasets:[{data:a.map(e=>e.winRate),backgroundColor:["#1FB8CD","#FFC185","#B4413C","#ECEBD5","#5D878F","#DB4545","#D2BA4C","#964325","#944454","#13343B"].slice(0,a.length),borderWidth:2,borderColor:"#fff"}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"right",labels:{boxWidth:15,padding:15}},tooltip:{callbacks:{label:function(e){return e.label+": "+e.raw.toFixed(2)+"%"}}}}}})}updateMarketConditionChart(){const e=document.getElementById("marketConditionChart");if(!e)return;const t=e.getContext("2d");this.charts.marketCondition&&this.charts.marketCondition.destroy();const i={};this.trades.filter(e=>this.isClosedStatus(e.status)).forEach(e=>{i[e.marketCondition]||(i[e.marketCondition]=0),i[e.marketCondition]+=e.pl}),this.charts.marketCondition=new Chart(t,{type:"bar",data:{labels:Object.keys(i),datasets:[{label:"P&L by Market Condition",data:Object.values(i),backgroundColor:Object.values(i).map(e=>e>=0?"#1FB8CD":"#B4413C"),borderColor:Object.values(i).map(e=>e>=0?"#1FB8CD":"#B4413C"),borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{callback:function(e){return"$"+e.toLocaleString()}}}},plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(e){return"P&L: $"+e.raw.toLocaleString()}}}}}})}updateTradesList(){this.populateFilters(),this.filterTrades()}populateFilters(){const e=document.getElementById("filter-strategy"),t=document.getElementById("filter-trade-type"),i={strategy:e?.value||"",tradeType:t?.value||""},a=[...new Set(this.trades.map(e=>e.strategy))].filter(Boolean).sort((e,t)=>e.localeCompare(t)),n=[...new Set(this.trades.map(e=>this.getTradeType(e)))].filter(e=>e&&"—"!==e).sort((e,t)=>e.localeCompare(t));e&&(e.innerHTML='<option value="">All Strategies</option>',a.forEach(t=>{const i=document.createElement("option");i.value=t,i.textContent=t,e.appendChild(i)}),i.strategy&&a.includes(i.strategy)&&(e.value=i.strategy)),t&&(t.innerHTML='<option value="">All Trade Types</option>',n.forEach(e=>{const i=document.createElement("option");i.value=e,i.textContent=e,t.appendChild(i)}),i.tradeType&&n.includes(i.tradeType)&&(t.value=i.tradeType))}filterTrades(){const e=document.getElementById("filter-strategy")?.value||"",t=document.getElementById("filter-status")?.value||"",i=document.getElementById("filter-market-condition")?.value||"",a=document.getElementById("filter-trade-type")?.value||"",n=(document.getElementById("search-ticker")?.value||"").toString().trim().toLowerCase(),r=this.trades.filter(r=>{const s=!e||r.strategy===e,o=this.normalizeStatus(r.status);let l=!0;if(t){const e=t.toLowerCase();l="assigned"===e?"assigned"===o||"closed"===o&&this.isAssignmentReason(r.exitReason):o===e}const c=!i||r.marketCondition===i,d=this.getTradeType(r),u=!a||d===a,h=(r.ticker??"").toString().toLowerCase(),m=this.normalizeCycleId(r.cycleId).toLowerCase(),p=(this.normalizeCycleType(r.cycleType,r.strategy)||"").toLowerCase(),y=!n||h.includes(n)||m.includes(n)||p&&p.includes(n);return s&&l&&c&&u&&y});this.renderTradesTable(r)}openTradesFilteredByTicker(e){const t=(e??"").toString().trim().toUpperCase();if(!t)return;this.showView("trades-list");const i=document.getElementById("search-ticker");i&&(i.value=t,i.focus()),["filter-strategy","filter-status","filter-market-condition","filter-trade-type"].forEach(e=>{const t=document.getElementById(e);t&&""!==t.value&&(t.value="")}),this.filterTrades()}openTradesFilteredByCycle(e,t=""){const i=this.normalizeCycleId(e);if(!i)return;this.showView("trades-list");const a=document.getElementById("search-ticker");a&&(a.value=i,a.focus()),this.filterTrades()}renderTradesTable(e=this.trades){const t=document.querySelector("#trades-table tbody");if(!t)return;t.innerHTML="",this.tradeDetailCharts?.size&&(this.tradeDetailCharts.forEach(e=>{try{e.destroy()}catch(e){console.warn("Failed to destroy payoff chart:",e)}}),this.tradeDetailCharts.clear());const i=e=>{const t=Number(e);return Number.isFinite(t)?t:null},a=["Ticker","Strategy","Cycle","Trade Type","Strike","Qty","Entry Price","Exit Price","Entry Date","Expiration","DTE","Exit Date","Days Held","Max Risk","P&L","ROI","Annual ROI","Status","Actions"];e.forEach((e,n)=>{const r=t.insertRow();r.classList.add("trade-summary-row");r.insertCell(0).appendChild(this.createTickerElement(e.ticker)),r.insertCell(1).textContent=e.strategy||"—";const s=r.insertCell(2),o=this.normalizeCycleId(e.cycleId);if(o){const t=this.normalizeCycleType(e.cycleType,e.strategy),i=document.createElement("button");i.type="button",i.className="cycle-chip cycle-chip--link",i.textContent=t?`${o} (${t.toUpperCase()})`:o,i.addEventListener("click",t=>{t.stopPropagation(),this.openTradesFilteredByCycle(o,e.ticker)}),i.title="View trades in this cycle",s.appendChild(i)}else s.textContent="—";const l=r.insertCell(3),c=this.getTradeType(e);l.textContent=c;l.className={BTO:"trade-type-bto",STO:"trade-type-sto",STC:"trade-type-stc",BTC:"trade-type-btc"}[c]||"";const d=r.insertCell(4),u=i(e.strikePrice);d.textContent=null!==u?`$${u.toFixed(2)}`:"—";const h=r.insertCell(5),m=i(e.quantity);h.textContent=null!==m?Math.abs(m):"—";const p=r.insertCell(6),y=i(e.entryPrice);p.textContent=null!==y?`$${y.toFixed(2)}`:"—";const g=r.insertCell(7),f=i(e.exitPrice);g.textContent=null!==f?`$${f.toFixed(2)}`:"-",r.insertCell(8).textContent=this.formatDate(e.entryDate),r.insertCell(9).textContent=this.formatDate(e.expirationDate);const b=r.insertCell(10),C=i(e.dte);b.textContent=null!==C?C:"—";r.insertCell(11).textContent=e.exitDate?this.formatDate(e.exitDate):"-";const v=r.insertCell(12),k=i(e.daysHeld);v.textContent=null!==k?k:"—";const x=r.insertCell(13),T=i(e.maxRisk);null!==T?(x.textContent=this.formatCurrency(T),x.className="pl-negative"):(x.textContent="—",x.className="pl-neutral");const w=r.insertCell(14),I=i(e.pl);null!==I?(w.textContent=this.formatCurrency(I),w.className=I>0?"pl-positive":I<0?"pl-negative":"pl-neutral"):(w.textContent="—",w.className="pl-neutral");const N=r.insertCell(15),S=i(e.roi);null!==S?(N.textContent=`${S.toFixed(2)}%`,N.className=S>0?"pl-positive":S<0?"pl-negative":"pl-neutral"):(N.textContent="—",N.className="pl-neutral");const P=r.insertCell(16),E=i(e.annualizedROI);this.isClosedStatus(e.status)&&null!==E?(P.textContent=`${E.toFixed(2)}%`,P.className=E>0?"pl-positive":E<0?"pl-negative":"pl-neutral"):(P.textContent="-",P.className="pl-neutral");const D=r.insertCell(17),L=document.createElement("span"),R=this.getDisplayStatus(e),A=R.toLowerCase().replace(/\s+/g,"-");L.className=`status-badge ${A}`.trim(),L.textContent=R,D.appendChild(L);const F=r.insertCell(18);F.className="actions-cell";const M=`trade-pl-${e.id??e.tradeId??e.uniqueId??`${e.ticker||"trade"}-${n}`}`.toString().replace(/[^a-zA-Z0-9_-]/g,"-"),B=`${M}-footnote`,O=document.createElement("button");O.type="button",O.className="action-btn action-btn--edit",O.textContent="Edit",O.addEventListener("click",t=>{t.stopPropagation(),this.editTrade(e.id)});const $=document.createElement("button");$.type="button",$.className="action-btn action-btn--delete",$.textContent="Delete",$.addEventListener("click",t=>{t.stopPropagation(),this.deleteTrade(e.id)}),F.append(O,$),r.setAttribute("tabindex","0"),r.setAttribute("aria-expanded","false"),r.setAttribute("aria-controls",M),r.dataset.chartId=M;const G=t.insertRow();G.className="trade-detail-row",G.setAttribute("aria-hidden","true"),G.style.display="none",G.dataset.chartId=M;const _=G.insertCell(0);_.colSpan=a.length,_.innerHTML=`\n                <div class="trade-diagram" data-chart-container="${M}">\n                    <div class="trade-diagram__canvas">\n                        <canvas id="${M}" aria-hidden="true"></canvas>\n                    </div>\n                    <p class="trade-diagram__footnote" id="${B}">Tap or click the trade row to generate the payoff diagram.</p>\n                </div>\n            `;const U=()=>{this.toggleTradePayoffDetail(r,G,e,M,B)};r.addEventListener("click",e=>{e.target.closest("button")||e.target.closest("a")||e.target.closest("input")||e.target.closest(".trade-diagram")||U()}),r.addEventListener("keydown",e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),U())}),this.applyResponsiveLabels(r,a)})}toggleTradePayoffDetail(e,t,i,a,n){if(!t)return;const r=!t.classList.contains("is-open");t.classList.toggle("is-open",r),t.style.display=r?"table-row":"none",t.setAttribute("aria-hidden",String(!r)),e?.setAttribute("aria-expanded",String(r));const s=t.querySelector("canvas");if(s&&s.setAttribute("aria-hidden",String(!r)),r){const e=this.renderTradePayoffChart(i,a,n);e?.catch&&e.catch(e=>{console.error("Failed to render payoff chart:",e)})}else this.destroyTradePayoffChart(a,n)}async renderTradePayoffChart(e,t,i){const a=document.getElementById(t),n=document.getElementById(i),r=a?.parentElement;if(!a)return void(n&&(n.textContent="Canvas element missing; cannot generate payoff diagram."));if(this.tradeDetailCharts?.has(t))return;n&&(n.textContent="Loading live price and payoff data…");const s=this.calculatePayoffSeries(e);if(!s||!Array.isArray(s.points)||0===s.points.length)return r&&r.classList.add("trade-diagram__canvas--empty"),a.classList.add("hidden"),void(n&&(n.textContent=s?.message||"Payoff diagram not available for this strategy yet."));a.classList.remove("hidden"),r?.classList.remove("trade-diagram__canvas--empty");const o=a.getContext("2d");if(!o)return void(n&&(n.textContent="Unable to access canvas rendering context."));const l=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:2}),c="rgba(34, 197, 94, 1)",d=s.points.map(e=>e.y);let u=Math.min(...d,0),h=Math.max(...d,0);Number.isFinite(u)&&Number.isFinite(h)||(u=0,h=0),u===h&&(u-=1,h+=1);const m=s.points.map(e=>({x:e.x,y:e.y>=0?e.y:null})),p=s.points.map(e=>({x:e.x,y:e.y<=0?e.y:null})),y=o.createLinearGradient(0,0,0,a.height);y.addColorStop(0,"rgba(34, 197, 94, 0.18)"),y.addColorStop(1,"rgba(34, 197, 94, 0.02)");const g=o.createLinearGradient(0,0,0,a.height);g.addColorStop(0,"rgba(248, 113, 113, 0.18)"),g.addColorStop(1,"rgba(248, 113, 113, 0.02)");const f=await this.getUnderlyingPriceForPayoff(e),b=document.querySelector(`.trade-detail-row[data-chart-id="${t}"]`);if(b&&!b.classList.contains("is-open"))return void(n&&(n.textContent="Tap or click the trade row to generate the payoff diagram."));const C={id:`payoffPriceLineLabel-${t}`,afterDatasetsDraw:e=>{if(!Number.isFinite(f))return;const t=e.scales?.x,i=e.chartArea;if(!t||!i)return;const a=t.getPixelForValue(f);if(!Number.isFinite(a)||a<i.left||a>i.right)return;e.scales;const n=e.ctx;n.save(),n.font='12px "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',n.fillStyle="rgba(30, 41, 59, 0.9)",n.textBaseline="middle",n.textAlign="center";let r=i.bottom-10-50;(!Number.isFinite(r)||r<i.top+12)&&(r=i.top+12);const s=a<(i.left+i.right)/2?Math.min(i.right-18,a+18):Math.max(i.left+18,a-18),o=`Current ${l.format(f)}`;n.translate(s,r),n.rotate(-Math.PI/2),n.fillText(o,0,0),n.restore()}},v=[{id:"currentPriceLine",label:"Current Price",data:[],borderColor:"rgba(100, 116, 139, 0.95)",borderDash:[6,4],borderWidth:2,hoverBorderColor:"rgba(100, 116, 139, 0.95)",hoverBorderWidth:2,pointRadius:0,pointHitRadius:0,fill:!1,order:0,hidden:!0},{id:"breakevenLine",label:"Breakeven",data:[],borderColor:"rgba(59, 130, 246, 0.8)",borderDash:[2,4],borderWidth:1,pointRadius:0,pointHitRadius:0,fill:!1,order:0,hidden:!0},{id:"positiveFill",label:"Profit Region",data:m,borderColor:"rgba(0,0,0,0)",backgroundColor:y,hoverBackgroundColor:y,hoverBorderColor:"rgba(0, 0, 0, 0)",hoverBorderWidth:0,fill:"origin",pointRadius:0,pointHitRadius:0,tension:0,order:1,spanGaps:!0,showLine:!0},{id:"negativeFill",label:"Loss Region",data:p,borderColor:"rgba(0,0,0,0)",backgroundColor:g,hoverBackgroundColor:g,hoverBorderColor:"rgba(0, 0, 0, 0)",hoverBorderWidth:0,fill:"origin",pointRadius:0,pointHitRadius:0,tension:0,order:1,spanGaps:!0,showLine:!0},{id:"payoffLine",label:"P&L at Expiration",data:s.points,borderColor:c,hoverBorderColor:c,hoverBorderWidth:2,tension:0,pointRadius:0,pointHoverRadius:0,borderWidth:2,fill:!1,order:2,segment:{borderColor:e=>{const t=e.p0.parsed?.y,i=e.p1.parsed?.y;return t>=0&&i>=0?c:t<=0&&i<=0?"rgba(248, 113, 113, 1)":"rgba(148, 163, 184, 1)"}}},{id:"zeroLine",label:"Break-even Baseline",data:s.zeroLinePoints??s.points.map(e=>({x:e.x,y:0})),borderColor:"rgba(71, 85, 105, 0.9)",borderDash:[4,4],borderWidth:2,hoverBorderColor:"rgba(71, 85, 105, 0.95)",hoverBorderWidth:2,pointRadius:0,pointHitRadius:0,fill:!1,order:3}];if(Number.isFinite(f)){const e=v.findIndex(e=>"currentPriceLine"===e.id);-1!==e&&(v[e].data=[{x:f,y:u},{x:f,y:h}],v[e].hidden=!1)}if(Number.isFinite(s.breakeven)){const e=v.findIndex(e=>"breakevenLine"===e.id);-1!==e&&(v[e].data=[{x:s.breakeven,y:u},{x:s.breakeven,y:h}])}const k=new Chart(o,{type:"line",data:{datasets:v},plugins:[C],options:{parsing:!1,responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},hover:{mode:"index",intersect:!1},plugins:{legend:{display:!1},tooltip:{callbacks:{label:e=>{if(!e.dataset||"payoffLine"!==e.dataset.id)return null;const t=Number(e.parsed?.x),i=Number(e.parsed?.y);if(!Number.isFinite(t)||!Number.isFinite(i))return null;const a=l.format(i),n=l.format(t);return`${e.dataset.label||"P&L"}: ${a} @ ${n}`}}}},scales:{x:{type:"linear",title:{display:!0,text:"Underlying Price ($)"},ticks:{callback:e=>l.format(Number(e))}},y:{title:{display:!0,text:"P&L ($)"},ticks:{callback:e=>l.format(Number(e))},suggestedMin:u,suggestedMax:h}}}});this.tradeDetailCharts.set(t,k),n&&(n.textContent=this.formatPayoffFooter(s,l))}destroyTradePayoffChart(e,t){const i=this.tradeDetailCharts?.get(e);if(i){try{i.destroy()}catch(e){console.warn("Failed to destroy payoff chart:",e)}this.tradeDetailCharts.delete(e)}const a=document.getElementById(e),n=a?.parentElement;if(a){const e=a.getContext("2d");e&&e.clearRect(0,0,a.width,a.height),a.classList.remove("hidden")}if(n?.classList.remove("trade-diagram__canvas--empty"),t){const e=document.getElementById(t);e&&(e.textContent="Tap or click the trade row to generate the payoff diagram.")}}async getUnderlyingPriceForPayoff(e={}){const t=(e?.ticker||"").toString().trim().toUpperCase();if(t){const e=this.getCachedQuote(t);if(e?.value&&Number.isFinite(Number(e.value.price)))return Number(e.value.price);if(this.finnhub.apiKey)try{const e=await this.getCurrentPrice(t),i=Number(e?.price);if(Number.isFinite(i)&&i>0)return i}catch(e){console.warn("Live price lookup failed for payoff chart:",e)}}return this.getFallbackUnderlyingPrice(e)}getFallbackUnderlyingPrice(e={}){const t=[e.currentUnderlyingPrice,e.currentPrice,e.marketPrice,e.lastUnderlyingPrice,e.lastPrice,e.markPrice,e.referencePrice,e.stockPriceAtEntry];for(const e of t){const t=Number(e);if(Number.isFinite(t)&&t>0)return t}return null}calculatePayoffSeries(e){const t=this.determinePayoffModel(e);if(!t||"unsupported"===t.type)return{message:t?.reason||"Payoff diagram not available for this strategy yet."};switch(t.type){case"single":return this.calculateSingleLegSeries(e,t);case"vertical":return this.calculateVerticalSpreadSeries(e,t);case"covered-call":return this.calculateCoveredCallSeries(e,t);case"pmcc":return this.calculatePmccSeries(e,t);default:return{message:"Payoff diagram not available for this strategy yet."}}}determinePayoffModel(e){const t=(e.strategy||"").toString().trim(),i=t.toLowerCase(),a=Number(e.definedRiskWidth);if(!i)return{type:"unsupported",reason:"Add a strategy name to unlock payoff diagrams."};const n=this.normalizeCycleType(e.cycleType,t);if(i.includes("poor man's covered call")||i.includes("poor man")||"pmcc"===n||this.isPmccBaseLeg(e)||this.isPmccShortCall(e)){const t=this.extractPmccLegs(e);return t.baseLeg?{type:"pmcc",strategy:i,...t}:{type:"unsupported",reason:"Add the PMCC base leg to this cycle to unlock the payoff diagram."}}if(i.includes("covered call"))return{type:"covered-call",strategy:i};const r=/(iron|straddle|strangle|butterfly|ratio|lizard|combo|synthetic|double|calendar|diagonal)/.test(i),s=i.includes("put")?"put":i.includes("call")?"call":null,o=/calendar|diagonal/.test(i);if(i.includes("spread")&&!o&&!(a>0))return{type:"unsupported",reason:"Add the defined risk width to visualize this spread."};if(a>0&&s&&i.includes("spread")&&!o){return{type:"vertical",optionType:s,orientation:i.includes("short")||i.includes("credit")||"short"===this.inferTradeDirection(e)?"short":"long",width:Number(a),strategy:i}}if(r)return{type:"unsupported",reason:"Visualization for multi-leg strategies such as condors, straddles, or ratios is coming soon."};if(!s)return{type:"unsupported",reason:"Unable to infer option type from the strategy name."};return{type:"single",optionType:s,direction:"short"===this.inferTradeDirection(e)?"short":"long",strategy:i}}calculateSingleLegSeries(e,t){const i=Number(e.strikePrice),a=Number(e.entryPrice),n=Number(e.fees)||0,r=Math.abs(Number(e.quantity)||1),s=Number(e.stockPriceAtEntry);if(!Number.isFinite(i)||!Number.isFinite(a))return{message:"Provide both a strike price and entry price to view this payoff."};const o=this.buildPriceRange({strikeValues:[i],spot:s}),l=100*r,c=[];for(let e=0;e<=40;e++){const r=o.minPrice+(o.maxPrice-o.minPrice)*e/40,s=this.optionIntrinsic(t.optionType,r,i),d=("long"===t.direction?s-a:a-s)*l-n;c.push({x:parseFloat(r.toFixed(2)),y:parseFloat(d.toFixed(2))})}const d=c.map(e=>({x:e.x,y:0})),u="call"===t.optionType?i+a:i-a,h=a*l;let m,p;"long"===t.direction?(m="call"===t.optionType?1/0:Math.max((i-a)*l-n,0),p=h+n):(m=Math.max(h-n,0),p="call"===t.optionType?1/0:Math.max((i-a)*l+n,0));return{points:c,zeroLinePoints:d,summary:this.buildPayoffSummary({profileLabel:`${"short"===t.direction?"Short":"Long"} ${t.optionType.toUpperCase()}`,breakeven:u,maxProfit:m,maxLoss:p,contracts:r,isCredit:"short"===t.direction}),breakeven:u,maxProfit:m,maxLoss:p}}calculateVerticalSpreadSeries(e,t){const i=Number(e.strikePrice),a=Number(e.entryPrice),n=Number(e.fees)||0,r=Math.abs(Number(e.quantity)||1),s=Number(e.stockPriceAtEntry);if(!Number.isFinite(i)||!Number.isFinite(a))return{message:"Provide strike and entry price to view this spread payoff."};if(!(t.width>0))return{message:"Add the defined risk width to visualize this spread."};let o,l;if("call"===t.optionType?"short"===t.orientation?(o=i,l=i+t.width):(l=i,o=i+t.width):"short"===t.orientation?(o=i,l=i-t.width):(l=i,o=i-t.width),!Number.isFinite(o)||!Number.isFinite(l))return{message:"Unable to determine both strikes for this spread."};const c=this.buildPriceRange({strikeValues:[o,l],spot:s}),d=100*r,u=[];for(let e=0;e<=40;e++){const i=c.minPrice+(c.maxPrice-c.minPrice)*e/40,r=this.optionIntrinsic(t.optionType,i,o),s=this.optionIntrinsic(t.optionType,i,l),h=("short"===t.orientation?a-(r-s):s-r-a)*d-n;u.push({x:parseFloat(i.toFixed(2)),y:parseFloat(h.toFixed(2))})}const h=u.map(e=>({x:e.x,y:0})),m=this.calculateSpreadBreakeven({model:t,shortStrike:o,longStrike:l,entryPrice:a}),p=Math.abs(o-l)*d,y=a*d;let g,f;"short"===t.orientation?(g=Math.max(y-n,0),f=Math.max(p-y,0)+n):(g=Math.max(Math.max(p-y,0)-n,0),f=y+n);return{points:u,zeroLinePoints:h,summary:this.buildPayoffSummary({profileLabel:`${"short"===t.orientation?"Short":"Long"} ${"call"===t.optionType?"Call":"Put"} Spread`,breakeven:m,maxProfit:g,maxLoss:f,contracts:r,isCredit:"short"===t.orientation}),breakeven:m,maxProfit:g,maxLoss:f}}calculateCoveredCallSeries(e){const t=Number(e.strikePrice),i=Number(e.entryPrice),a=Number(e.stockPriceAtEntry),n=Number(e.fees)||0,r=Math.abs(Number(e.quantity)||1);if(!Number.isFinite(t)||!Number.isFinite(i)||!Number.isFinite(a))return{message:"Covered call payoff requires strike, option premium, and stock cost basis."};const s=this.buildPriceRange({strikeValues:[t,a],spot:a}),o=100*r,l=[];for(let e=0;e<=40;e++){const r=s.minPrice+(s.maxPrice-s.minPrice)*e/40,c=(r-a+(i-this.optionIntrinsic("call",r,t)))*o-n;l.push({x:parseFloat(r.toFixed(2)),y:parseFloat(c.toFixed(2))})}const c=l.map(e=>({x:e.x,y:0})),d=a-i,u=Math.max((t-a+i)*o-n,0),h=Math.max((a-i)*o+n,0);return{points:l,zeroLinePoints:c,summary:this.buildPayoffSummary({profileLabel:"Covered Call (Stock + Short Call)",breakeven:d,maxProfit:u,maxLoss:h,contracts:r,isCredit:!0}),breakeven:d,maxProfit:u,maxLoss:h}}calculatePmccSeries(e,t){const i=t.baseLeg;if(!i)return{message:"Add the PMCC base leg to visualize this payoff."};const a=Number(i.strikePrice),n=Number(i.entryPrice),r=Number(i.fees)||0,s=Math.abs(Number(i.quantity)||1);if(!Number.isFinite(a)||!Number.isFinite(n))return{message:"Provide strike and entry price for the PMCC base leg to view this payoff."};const o=t.shortLeg,l=Number(o?.strikePrice),c=Number(o?.entryPrice),d=Number(o?.fees)||0,u=Math.abs(Number(o?.quantity)||0),h=o?this.inferTradeDirection(o):null,m=[a];Number.isFinite(l)&&m.push(l);const p=this.getFallbackUnderlyingPrice(i)??(o?this.getFallbackUnderlyingPrice(o):null)??Number(i.stockPriceAtEntry),y=this.buildPriceRange({strikeValues:m,spot:Number.isFinite(p)?p:Number.NaN}),g=100*s,f=u>0?100*u:g,b=[];for(let e=0;e<=80;e++){const t=y.minPrice+(y.maxPrice-y.minPrice)*e/80,i=(Math.max(t-a,0)-n)*g-r;let s=0;if(o&&Number.isFinite(l)&&Number.isFinite(c)){const e=Math.max(t-l,0);s=("short"===h?c-e:e-c)*f-d}const u=i+s;b.push({x:parseFloat(t.toFixed(2)),y:parseFloat(u.toFixed(2))})}const C=b.map(e=>({x:e.x,y:0})),v=n*g+r;let k=0;o&&Number.isFinite(c)&&(k="short"===h?c*f-d:-(c*f+d));const x=v-k,T=g>0?x/g:0,w=Number.isFinite(T)?a+T:null;let I=1/0;if(o&&Number.isFinite(l)&&"short"===h){const e=Math.max(Math.min(s,u),0);if(e>0){const t=l-a;Number.isFinite(t)&&(I=100*t*e-x)}}const N=x>0?x:0;return{points:b,zeroLinePoints:C,summary:this.buildPayoffSummary({profileLabel:"Poor Man's Covered Call",breakeven:w,maxProfit:I,maxLoss:N,contracts:s,isCredit:x<0}),breakeven:w,maxProfit:I,maxLoss:N}}calculateSpreadBreakeven({model:e,shortStrike:t,longStrike:i,entryPrice:a}){return"short"===e.orientation?"call"===e.optionType?t+a:t-a:"call"===e.optionType?i+a:i-a}optionIntrinsic(e,t,i){return Number.isFinite(t)&&Number.isFinite(i)?"call"===e?Math.max(t-i,0):Math.max(i-t,0):0}extractPmccLegs(e={}){const t=e=>(e||"").toString().trim().toUpperCase(),i=this.normalizeCycleId(e.cycleId);let a=[];if(i&&(a=this.trades.filter(e=>this.normalizeCycleId(e.cycleId)===i)),0===a.length){const i=t(e.ticker);i&&(a=this.trades.filter(e=>t(e.ticker)===i&&"pmcc"===this.normalizeCycleType(e.cycleType,e.strategy)))}a.includes(e)||a.push(e);const n=(e=[])=>[...e].sort((e,t)=>{const i=this.normalizeStatus(e.status),a=this.normalizeStatus(t.status);if("open"===i&&"open"!==a)return-1;if("open"!==i&&"open"===a)return 1;const n=new Date(e.entryDate||e.openDate||0).getTime();return new Date(t.entryDate||t.openDate||0).getTime()-n});let r=n(a.filter(e=>this.isPmccBaseLeg(e)))[0];if(!r){r=n(a.filter(e=>"long"===this.inferTradeDirection(e)&&(e.strategy||"").toLowerCase().includes("call")))[0]||("long"===this.inferTradeDirection(e)?e:null)}let s=n(a.filter(e=>this.isPmccShortCall(e)))[0];if(!s){s=n(a.filter(e=>"short"===this.inferTradeDirection(e)&&(e.strategy||"").toLowerCase().includes("call")))[0]||("short"===this.inferTradeDirection(e)?e:null)}return r&&s&&r===s&&(s=null),{baseLeg:r,shortLeg:s}}buildPriceRange({strikeValues:e=[],spot:t=Number.NaN}={}){const i=e.map(e=>Number(e)).filter(Number.isFinite);if(Number.isFinite(t)&&i.push(t),0===i.length)return{minPrice:0,maxPrice:100};let a=Math.max(Math.min(...i),0),n=Math.max(...i);if(a===n)a=Math.max(0,.7*a),n=1.3*n+1;else{const e=n-a;a=Math.max(0,a-.3*e),n+=.3*e}return n-a<5&&(a=Math.max(0,a-2.5),n+=2.5),{minPrice:a,maxPrice:n}}buildPayoffSummary({profileLabel:e,breakeven:t,maxProfit:i,maxLoss:a,contracts:n,isCredit:r=!1}){const s=[];return e&&s.push(e),Number.isFinite(t)&&s.push(`Breakeven ${this.formatCurrency(t)}`),i===1/0?s.push("Max profit unlimited"):Number.isFinite(i)&&s.push(`Max profit ${this.formatCurrency(i)}`),a===1/0?s.push("Max loss unlimited (theoretical)"):Number.isFinite(a)&&s.push(`Max loss ${this.formatCurrency(a)}`),Number.isFinite(n)&&s.push(`${n} contract${1===n?"":"s"}${r?" (credit)":""}`),s.join(" • ")||"Payoff preview unavailable."}formatPayoffFooter(e,t){const i=e=>e===1/0||e===-1/0?"Unlimited":Number.isFinite(e)?t.format(e):"—";return[`Max profit ${i(e?.maxProfit)}`,`Max loss ${i(e?.maxLoss)}`,`Breakeven ${i(e?.breakeven)}`].join(" • ")}getTradePayoffMeta(e){const t=(e.strategy||"Unspecified strategy").toString(),i=this.getTradeType(e)||"—",a=this.getDisplayStatus(e),n=Math.abs(Number(e.quantity));return[t,i,Number.isFinite(n)&&n>0?`${n} contract${1===n?"":"s"}`:null,a].filter(Boolean).join(" • ")}sortTrades(e){const t="asc"===this.sortDirection[e]?"desc":"asc";this.sortDirection[e]=t,document.querySelectorAll(".sortable").forEach(e=>{e.classList.remove("asc","desc")});const i=document.querySelector(`[data-sort="${e}"]`);i&&i.classList.add(t);const a=[...this.trades].sort((i,a)=>{let n=i[e],r=a[e];return e.includes("Date")&&(n=new Date(n),r=new Date(r)),"asc"===t?n<r?-1:n>r?1:0:n>r?-1:n<r?1:0});this.renderTradesTable(a)}deleteTrade(e){confirm("Are you sure you want to delete this trade?")&&(this.trades=this.trades.filter(t=>t.id!==e),this.saveToStorage(),this.markUnsavedChanges(),this.filterTrades(),this.updateDashboard())}editTrade(e){const t=this.trades.find(t=>t.id===e);if(t){this.currentEditingId=e;const i=document.getElementById("add-trade-form").elements;i.ticker.value=t.ticker,i.strategy.value=t.strategy;const a=this.getTradeType(t);i.tradeType.value=VALID_TRADE_TYPES.has(a)?a:"BTO",i.quantity.value=Math.abs(t.quantity),i.entryDate.value=this.formatDateForInput(t.entryDate),i.expirationDate.value=this.formatDateForInput(t.expirationDate),i.exitDate.value=this.formatDateForInput(t.exitDate),i.status.value=t.status,i.stockPriceAtEntry.value=t.stockPriceAtEntry,i.strikePrice.value=t.strikePrice,i.entryPrice.value=t.entryPrice,i.exitPrice.value=null!==t.exitPrice&&void 0!==t.exitPrice?t.exitPrice:"",i.fees.value=t.fees,i.ivRank.value=t.ivRank||"",i.delta.value=t.delta||"",i.gamma.value=t.gamma||"",i.theta.value=t.theta||"",i.vega.value=t.vega||"",i.definedRiskWidth&&(i.definedRiskWidth.value=Number.isFinite(Number(t.definedRiskWidth))?t.definedRiskWidth:""),i.maxRiskOverride&&(i.maxRiskOverride.value=Number.isFinite(Number(t.maxRiskOverride))?t.maxRiskOverride:""),i.marketCondition.value=t.marketCondition,i.convictionLevel.value=t.convictionLevel,i.notes.value=t.notes||"",i.exitReason.value=t.exitReason||"",i.cycleId&&(i.cycleId.value=t.cycleId||""),i.cycleType&&(i.cycleType.value=t.cycleType||""),i.cycleRole&&(i.cycleRole.value=t.cycleRole||""),document.getElementById("conviction-display").textContent=t.convictionLevel,this.updateTickerPreview(t.ticker),this.showView("add-trade")}}exportToCSV(){const e=[["Ticker","Strategy","Trade Type","Strike","Defined Risk Width","Qty","Entry Price","Exit Price","DTE","Days Held","Entry Date","Expiration Date","Exit Date","Max Risk","P&L","ROI %","Annual ROI %","Status","Stock Price at Entry","Fees","Max Risk Override","Delta","Gamma","Theta","Vega","IV Rank","Market Condition","Conviction Level","Notes","Exit Reason","Cycle ID","Cycle Type","Cycle Role"].join(","),...this.trades.map(e=>[e.ticker,`"${e.strategy}"`,this.getTradeType(e),e.strikePrice,Number.isFinite(Number(e.definedRiskWidth))?Number(e.definedRiskWidth).toFixed(2):"",Math.abs(e.quantity),e.entryPrice,null!==e.exitPrice&&void 0!==e.exitPrice?e.exitPrice:"",e.dte,e.daysHeld,e.entryDate,e.expirationDate,e.exitDate||"",e.maxRisk.toFixed(2),e.pl.toFixed(2),e.roi.toFixed(2),e.annualizedROI.toFixed(2),e.status,e.stockPriceAtEntry,e.fees,Number.isFinite(Number(e.maxRiskOverride))?Number(e.maxRiskOverride).toFixed(2):"",e.delta||"",e.gamma||"",e.theta||"",e.vega||"",e.ivRank||"",e.marketCondition,e.convictionLevel,`"${e.notes||""}"`,e.exitReason||"",e.cycleId||"",e.cycleType||"",e.cycleRole||""].join(","))].join("\n"),t=new Blob([e],{type:"text/csv"}),i=window.URL.createObjectURL(t),a=document.createElement("a");a.style.display="none",a.href=i,a.download="options_trades_enhanced.csv",document.body.appendChild(a),a.click(),window.URL.revokeObjectURL(i),document.body.removeChild(a)}async saveDatabase(){this.showLoadingIndicator("Saving...");try{const e=this.buildDatabasePayload();this.supportsFileSystemAccess?await this.saveWithFileSystemAPI(e):this.saveWithDownload(e),this.hasUnsavedChanges=!1,this.updateUnsavedIndicator(),this.showNotification("Database saved successfully!","success"),this.saveToStorage({fileName:this.currentFileName})}catch(e){if(console.error("Save error:",e),"AbortError"!==e.name)try{const e=this.buildDatabasePayload();this.saveWithDownload(e),this.hasUnsavedChanges=!1,this.updateUnsavedIndicator(),this.showNotification("Database saved as download!","success"),this.saveToStorage({fileName:this.currentFileName})}catch(e){this.showNotification("Failed to save database","error")}}this.hideLoadingIndicator()}buildDatabasePayload(){return{trades:this.trades,exportDate:(new Date).toISOString(),version:"2.2"}}async saveWithFileSystemAPI(e){try{this.currentFileHandle||(this.currentFileHandle=await window.showSaveFilePicker({suggestedName:"options_tracker.json",types:[{description:"JSON files",accept:{"application/json":[".json"]}}]}));const t=await this.currentFileHandle.createWritable();await t.write(JSON.stringify(e,null,2)),await t.close(),this.currentFileName=this.currentFileHandle.name,this.updateFileNameDisplay()}catch(e){throw e}}saveWithDownload(e){const t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),i=URL.createObjectURL(t),a=document.createElement("a");a.href=i,a.download="options_tracker.json",document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(i),this.currentFileName="options_tracker.json",this.updateFileNameDisplay()}async loadDatabase(){this.showLoadingIndicator("Loading...");try{this.supportsFileSystemAccess?await this.loadWithFileSystemAPI():this.loadWithFileInput()}catch(e){console.error("Load error:",e),"AbortError"!==e.name&&this.loadWithFileInput()}this.hideLoadingIndicator()}async loadWithFileSystemAPI(){const[e]=await window.showOpenFilePicker({types:[{description:"JSON files",accept:{"application/json":[".json"]}}]}),t=await e.getFile(),i=await t.text(),a=JSON.parse(i);this.processLoadedData(a,{fileName:e.name,source:"file-open"}),this.currentFileHandle=e,this.showNotification(`Loaded ${this.trades.length} trades successfully!`,"success")}loadWithFileInput(){const e=document.getElementById("file-input");e.onchange=t=>{const i=t.target.files[0];if(i){const t=new FileReader;t.onload=t=>{try{const e=JSON.parse(t.target.result);this.processLoadedData(e,{fileName:i.name,source:"file-open"}),this.showNotification(`Loaded ${this.trades.length} trades successfully!`,"success")}catch(e){this.showNotification("Invalid JSON file","error")}e.value=""},t.readAsText(i)}else e.value=""},e.click()}processLoadedData(e,t={}){if(!e||!Array.isArray(e.trades))throw new Error("Invalid data format");this.trades=e.trades.map(e=>{const t={...e};return t.tradeReasoning&&!t.notes&&(t.notes=t.tradeReasoning,delete t.tradeReasoning),this.enrichTradeData(t)}),t.fileName?this.currentFileName=t.fileName:this.currentFileName||(this.currentFileName="Unsaved Database"),this.hasUnsavedChanges=!1,this.updateUnsavedIndicator(),this.saveToStorage({fileName:this.currentFileName,source:t.source||"import"}),this.updateDashboard(),"trades-list"===this.currentView&&this.updateTradesList(),this.updateFileNameDisplay(),this.initializeAIChat()}newDatabase(){this.hasUnsavedChanges&&!confirm("You have unsaved changes. Are you sure you want to create a new database?")||(this.trades=[],this.currentFileHandle=null,this.currentFileName="Unsaved Database",this.hasUnsavedChanges=!1,this.updateFileNameDisplay(),this.updateUnsavedIndicator(),this.saveToStorage({fileName:this.currentFileName}),this.updateDashboard(),this.showNotification("New database created","success"),this.initializeAIChat())}updateFileNameDisplay(){const e=document.getElementById("current-file-name");e&&(e.textContent=this.currentFileName,"Unsaved Database"===this.currentFileName?e.classList.add("is-unsaved"):e.classList.remove("is-unsaved"))}updateUnsavedIndicator(){const e=document.getElementById("unsaved-indicator");this.hasUnsavedChanges?e.classList.remove("hidden"):e.classList.add("hidden")}showLoadingIndicator(e="Loading..."){const t=document.getElementById("loading-indicator");t&&(t.textContent=e,t.classList.remove("hidden"))}hideLoadingIndicator(){const e=document.getElementById("loading-indicator");e&&e.classList.add("hidden")}showNotification(e,t="info"){"error"===t?alert(`Error: ${e}`):console.log(`${t.toUpperCase()}: ${e}`)}markUnsavedChanges(){this.hasUnsavedChanges=!0,this.updateUnsavedIndicator()}saveToStorage(e={}){try{const t={version:"2.2",timestamp:(new Date).toISOString(),fileName:e.fileName||this.currentFileName||"Unsaved Database",trades:this.trades};localStorage.setItem(LOCAL_STORAGE_KEY,JSON.stringify(t)),localStorage.removeItem(LEGACY_STORAGE_KEY)}catch(e){console.warn("Failed to save to localStorage:",e)}}async loadFromStorage(){try{const e=localStorage.getItem(LOCAL_STORAGE_KEY);if(e){const t=JSON.parse(e);if(t&&Array.isArray(t.trades))return this.trades=t.trades.map(e=>{const t={...e};return t.tradeReasoning&&!t.notes&&(t.notes=t.tradeReasoning),delete t.tradeReasoning,this.enrichTradeData(t)}),t.fileName&&(this.currentFileName=t.fileName),this.hasUnsavedChanges=!1,this.updateUnsavedIndicator(),this.updateFileNameDisplay(),this.updateDashboard(),!0}const t=localStorage.getItem(LEGACY_STORAGE_KEY);if(t){const e=JSON.parse(t);if(Array.isArray(e))return this.trades=e.map(e=>{const t={...e};return t.tradeReasoning&&!t.notes&&(t.notes=t.tradeReasoning),delete t.tradeReasoning,this.enrichTradeData(t)}),this.currentFileName="Unsaved Database",this.hasUnsavedChanges=!1,this.updateUnsavedIndicator(),this.saveToStorage({fileName:this.currentFileName}),this.updateFileNameDisplay(),this.updateDashboard(),!0}}catch(e){console.warn("Failed to load from localStorage:",e)}return!1}formatPercent(e,t="—"){const i=Number(e);return Number.isFinite(i)?`${i.toFixed(2)}%`:t}formatCycleDateRange(e,t,i){if(!e)return"—";const a=new Date(e),n=t?new Date(t):null,r=new Intl.DateTimeFormat("en-US",{month:"short",day:"numeric",year:"numeric"}),s=isNaN(a.getTime())?"—":r.format(a);let o;return o=n&&!isNaN(n.getTime())?r.format(n):i?"Present":"—",o?`${s} — ${o}`:s}escapeHTML(e){return null==e?"":e.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}formatCurrency(e){const t=Number(e);return Number.isFinite(t)?new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(t):"—"}formatDate(e){const t=new Date(e);return isNaN(t.getTime())?"—":t.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}}class LocalInsightsAgent{constructor(e){this.app=e,this.context={stats:null,openTrades:[],closedTrades:[]}}updateContext({stats:e,openTrades:t,closedTrades:i}={}){e&&(this.context.stats=e),Array.isArray(t)&&(this.context.openTrades=t),Array.isArray(i)&&(this.context.closedTrades=i)}hasTradeHistory(){return(this.context.openTrades?.length||0)>0||(this.context.closedTrades?.length||0)>0}getGreeting(){if(!this.hasTradeHistory())return"Hi! I'm your local AI coach. Add or import a few trades and I'll help you analyze risk and performance.";const e=this.context.stats;if(!e)return"Hi! I'm your local AI coach. Ask about performance, risk, or next steps.";const t=this.context.openTrades?.length||0;return`Hi! I'm your local AI coach. You have ${t} active ${1===t?"position":"positions"} and ${this.context.closedTrades?.length||0} closed trades with realised P&L of ${this.formatCurrency(e.totalPL)}.`}generateResponse(e=""){if(!e.trim())return"I can run a portfolio health check, review risk exposure, or suggest strategy adjustments. Try asking for a quick portfolio health check.";if(!this.hasTradeHistory())return"Log a few trades first and I'll start surfacing insights about risk, performance, and strategy.";const t=[],i=this.buildPerformanceSummary();i&&t.push(i);const a=this.buildRiskHeadline();a&&t.push(a);const n=this.buildStrategyHeadline();n&&t.push(n);const r=this.buildCoachingHighlight();return r&&t.push(r),t.length||t.push("Portfolio data is limited, but keep logging trades and I'll highlight trends as they emerge."),t.join("\n\n")}buildPerformanceSummary(){const e=this.context.stats;if(!e)return"";const t=this.context.closedTrades?.length||0;if(!t)return"No closed trades yet. Once you realize some P&L I'll summarize your performance here.";const i=Number.isFinite(e.winRate)?`${e.winRate.toFixed(1)}%`:"—",a=Number.isFinite(e.profitFactor)?e.profitFactor.toFixed(2):"—",n=Number.isFinite(e.totalROI)?`${e.totalROI.toFixed(2)}%`:"—";return`Closed trades: ${t}, realised P&L ${this.formatCurrency(e.totalPL)}, win rate ${i}, profit factor ${a}, total ROI ${n}.`}buildRiskHeadline(){const e=this.context.openTrades||[];if(!e.length)return"No open positions right now, so live risk exposure is minimal.";let t=0,i=0,a=null;if(e.forEach(e=>{const n=Math.max(0,Number(this.app.getCapitalAtRisk(e))||0);t+=n,n>i&&(i=n,a=e)}),!t)return"Open positions detected, but max risk looks minimal based on current data.";if(a&&t){const n=(i/t*100).toFixed(0),r=(a.ticker||"Unknown").toUpperCase();return`Open risk across ${e.length} ${1===e.length?"position":"positions"} is ${this.formatCurrency(t)}. ${r} carries the largest share at ${n}% of exposure.`}return`Open risk across ${e.length} ${1===e.length?"position":"positions"} is ${this.formatCurrency(t)}.`}buildStrategyHeadline(){const e=this.getStrategyBreakdown();if(!e.length)return"";const t=e[0];if(!t)return"";const i=t.trades>0?(t.wins/t.trades*100).toFixed(0):"0";return`${t.name} leads with ${this.formatCurrency(t.pl)} across ${t.trades} trades (win rate ${i}%).`}buildCoachingHighlight(){const e=this.context.stats;if(!e)return"";const t=(this.context.closedTrades||[]).filter(e=>e.pl<0),i=(this.context.closedTrades||[]).filter(e=>e.pl>0),a=(e,t)=>{if(!e.length)return NaN;return e.reduce((e,i)=>e+t(i),0)/e.length},n=a(t,e=>Number(e.daysHeld)||0),r=a(i,e=>Number(e.daysHeld)||0);if(Number.isFinite(n)&&Number.isFinite(r)){const e=n-r;if(e>=2)return`Losing trades stay open about ${Math.round(e)} days longer than winners—tighten exits to cut risk sooner.`;if(e<=-2)return`You let winners run roughly ${Math.round(Math.abs(e))} days longer than losers—keep scaling out to lock in gains.`}return Number.isFinite(e.winRate)&&e.winRate<45&&(this.context.closedTrades?.length||0)>=5?"Win rate is under 45%. Focus on highest-conviction setups or scale size down until consistency improves.":""}getStrategyBreakdown(){const e=new Map;return(this.context.closedTrades||[]).forEach(t=>{const i=(t.strategy||"Unclassified").toString().trim()||"Unclassified";e.has(i)||e.set(i,{name:i,pl:0,trades:0,wins:0,losses:0});const a=e.get(i),n=Number(t.pl)||0;a.pl+=n,a.trades+=1,n>0?a.wins+=1:n<0&&(a.losses+=1)}),Array.from(e.values()).sort((e,t)=>t.pl-e.pl)}formatCurrency(e){return this.app.formatCurrency(e)}}class GeminiInsightsAgent{constructor(e){this.app=e,this.context={stats:null,openTrades:[],closedTrades:[]},this.fallback=new LocalInsightsAgent(e)}updateContext({stats:e,openTrades:t,closedTrades:i}={}){e&&(this.context.stats=e),Array.isArray(t)&&(this.context.openTrades=t),Array.isArray(i)&&(this.context.closedTrades=i),this.fallback.updateContext({stats:this.context.stats,openTrades:this.context.openTrades,closedTrades:this.context.closedTrades})}getGreeting(){return this.isConfigured()?this.fallback.getGreeting():"Connect your Gemini API key in [Settings](#settings) to get tailored analysis."}isConfigured(){const e=this.app?.gemini;return Boolean(e&&e.apiKey)}async generateResponse(e="",t={}){const i=e.trim();if(!i)return"Ask a question and I'll send it to Gemini along with a snapshot of your portfolio.";if(!this.isConfigured())return"Add a Gemini-compatible API key under [Settings](#settings) to enable AI-powered insights.";try{const e=this.buildRequestPayload(i,t),a=await this.callGemini(e);if(a)return a;throw new Error("Gemini returned an empty response")}catch(t){const i=this.fallback.generateResponse(e),a=t?.message||"Unknown error";return i?`Gemini request failed (${a}). Here's a local snapshot instead:\n\n${i}`:`Gemini request failed (${a}). Try again in a moment.`}}buildRequestPayload(e,t={}){const i=this.app?.gemini||{},a=GEMINI_ALLOWED_MODELS.includes(i.model)?i.model:DEFAULT_GEMINI_MODEL,n=.7,r=this.buildContextBlock(),s=[...this.buildHistoryContents(t.history||[]),{role:"user",parts:[{text:["You are a seasoned options-trading coach assisting a single trader.","### Portfolio Snapshot",r,"### User Question",e,"### Instructions","Provide clear, risk-aware guidance tailored to the data above. Reference relevant tickers or metrics when offering insights. Keep the response under 200 words, use bullet lists for multiple recommendations, and close with 2-3 suggested next steps. Remind the user that this is educational analysis, not financial advice."].join("\n\n")}]}],o={maxOutputTokens:800};return o.temperature=Number(n.toFixed(2)),{model:a,body:{contents:s,generationConfig:o}}}buildHistoryContents(e){return Array.isArray(e)&&0!==e.length?e.filter(e=>e&&!e.pending&&"string"==typeof e.text&&e.text.trim().length).slice(-8).map(e=>({role:"ai"===e.sender?"model":"user",parts:[{text:e.text.trim()}]})):[]}buildContextBlock(){const e=this.context.stats||{},t={totals:{totalPL:this.formatNumber(e.totalPL),winRate:this.formatNumber(e.winRate),profitFactor:this.formatNumber(e.profitFactor),totalROI:this.formatNumber(e.totalROI),annualizedROI:this.formatNumber(e.annualizedROI),maxDrawdown:this.formatNumber(e.maxDrawdown),closedTrades:e.closedTrades??(this.context.closedTrades?.length||0),openPositions:e.activePositions??(this.context.openTrades?.length||0)},riskHeadline:this.fallback.buildRiskHeadline(),strategyHighlight:this.fallback.buildStrategyHeadline(),coachingHighlight:this.fallback.buildCoachingHighlight(),performanceHighlight:this.fallback.buildPerformanceSummary?.()||"",openPositions:this.buildOpenPositionsSummary(),recentClosedTrades:this.buildRecentClosedTradesSummary(),topStrategies:this.buildStrategySummary(),cycles:this.buildCycleSummary()};return JSON.stringify(t,null,2)}buildOpenPositionsSummary(e=8){return(Array.isArray(this.context.openTrades)?this.context.openTrades:[]).slice(0,e).map(e=>{const t=Number.isFinite(e.dte)?e.dte:this.deriveDTE(e),i=Number(this.app.getCapitalAtRisk(e));return{ticker:(e.ticker||"").toString().toUpperCase(),strategy:e.strategy||"",status:e.status||"",dte:Number.isFinite(t)?Math.max(Math.round(t),0):null,maxRisk:Number.isFinite(i)?Number(i.toFixed(2)):null,conviction:Number.isFinite(e.convictionLevel)?e.convictionLevel:null,entryDate:e.entryDate||null,notes:this.cleanNote(e.notes)}})}deriveDTE(e){if(!e?.expirationDate)return null;try{return this.app.calculateDTE(e.expirationDate,e)}catch(e){return null}}buildRecentClosedTradesSummary(e=8){return(Array.isArray(this.context.closedTrades)?[...this.context.closedTrades]:[]).sort((e,t)=>new Date(t.exitDate||0)-new Date(e.exitDate||0)).slice(0,e).map(e=>({ticker:(e.ticker||"").toString().toUpperCase(),strategy:e.strategy||"",exitDate:e.exitDate||null,daysHeld:Number.isFinite(e.daysHeld)?e.daysHeld:null,pl:this.formatNumber(e.pl),roi:this.formatNumber(e.roi),exitReason:this.cleanNote(e.exitReason)}))}buildStrategySummary(e=5){return this.fallback.getStrategyBreakdown().slice(0,e).map(e=>({name:e.name,trades:e.trades,wins:e.wins,losses:e.losses,realisedPL:this.formatNumber(e.pl),winRate:e.trades>0?this.formatNumber(e.wins/e.trades*100):null}))}buildCycleSummary(e=3){return(Array.isArray(this.app.cycleAnalytics)&&this.app.cycleAnalytics.length?this.app.cycleAnalytics:this.app.calculateCycleAnalytics()).slice(0,e).map(e=>({cycleId:e.cycleId,type:e.cycleType,ticker:e.ticker,status:e.status,trades:Array.isArray(e.trades)?e.trades.length:0,totalPL:this.formatNumber(e.totalPL),roiPercent:this.formatNumber(e.roiPercent),keyMetric:e.keyMetricLabel||null,keyMetricValue:this.formatNumber(e.keyMetricValue),timeline:this.app.formatCycleDateRange(e.startDate,e.endDate,e.hasOpenTrade)}))}cleanNote(e){if(!e)return"";const t=e.toString().trim();return t.length<=180?t:`${t.slice(0,177)}…`}formatNumber(e){const t=Number(e);return Number.isFinite(t)?Number(t.toFixed(2)):null}async callGemini({model:e,body:t}){const i=this.app?.gemini?.apiKey;if(!i)throw new Error("Missing Gemini API key");const a=DEFAULT_GEMINI_ENDPOINT.replace(/\/+$/,""),n=(e||DEFAULT_GEMINI_MODEL).replace(/^models\//i,""),r=`${`${a}/${encodeURIComponent(n)}:generateContent`}?key=${encodeURIComponent(i)}`,s="undefined"!=typeof AbortController?new AbortController:null,o=s?setTimeout(()=>s.abort(),2e4):null;try{const e=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":i},body:JSON.stringify(t),signal:s?.signal}),a=await e.json().catch(()=>({}));if(!e.ok){const t=a?.error?.message||a?.message||`HTTP ${e.status}`;throw new Error(t)}if(a?.promptFeedback?.blockReason)throw new Error(`Request blocked (${a.promptFeedback.blockReason})`);const n=a?.candidates?.[0]?.content?.parts;if(!Array.isArray(n)||!n.length)return"";return n.map(e=>e&&"string"==typeof e.text?e.text:"").join("").trim()}finally{o&&clearTimeout(o)}}}document.addEventListener("DOMContentLoaded",function(){window.tracker=new GammaLedger});