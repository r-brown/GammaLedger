const APP_CONFIG=Object.freeze({GEMINI:{DEFAULT_MODEL:"gemini-2.5-flash",ALLOWED_MODELS:Object.freeze(["gemini-2.5-flash-lite","gemini-2.5-flash","gemini-2.5-pro"]),DEFAULT_TEMPERATURE:.25,DEFAULT_ENDPOINT:"https://generativelanguage.googleapis.com/v1beta/models"},STORAGE:{GEMINI_CONFIG:"GammaLedgerGeminiConfig",GEMINI_SECRET:"GammaLedgerGeminiSecret",DISCLAIMER:"GammaLedgerDisclaimerAcceptedAt",AI_COACH_CONSENT:"GammaLedgerAICoachConsentAt",SIDEBAR_COLLAPSED:"GammaLedgerSidebarCollapsed",LOCAL_DATABASE:"GammaLedgerLocalDatabase",LEGACY_KEYS:Object.freeze(["GammaLedgerTrades","GammaLedgerDatabase","GammaLedgerLocalState","GammaLedgerState"])},SHARE_CARD:{EXPORT_SIZE:1080,CHART_WIDTH_RATIO:.78,CHART_HEIGHT_RATIO:.42,CHART_MIN_HEIGHT:320},PL_RANGES:Object.freeze(["7D","MTD","1M","3M","YTD","1Y","ALL"])}),DEFAULT_GEMINI_MODEL=APP_CONFIG.GEMINI.DEFAULT_MODEL,GEMINI_ALLOWED_MODELS=APP_CONFIG.GEMINI.ALLOWED_MODELS,DEFAULT_GEMINI_TEMPERATURE=APP_CONFIG.GEMINI.DEFAULT_TEMPERATURE,DEFAULT_GEMINI_ENDPOINT=APP_CONFIG.GEMINI.DEFAULT_ENDPOINT,GEMINI_STORAGE_KEY=APP_CONFIG.STORAGE.GEMINI_CONFIG,GEMINI_SECRET_STORAGE_KEY=APP_CONFIG.STORAGE.GEMINI_SECRET,DISCLAIMER_STORAGE_KEY=APP_CONFIG.STORAGE.DISCLAIMER,AI_COACH_CONSENT_STORAGE_KEY=APP_CONFIG.STORAGE.AI_COACH_CONSENT,SIDEBAR_COLLAPSED_STORAGE_KEY=APP_CONFIG.STORAGE.SIDEBAR_COLLAPSED,LOCAL_STORAGE_KEY=APP_CONFIG.STORAGE.LOCAL_DATABASE,LEGACY_STORAGE_KEY=APP_CONFIG.STORAGE.LEGACY_KEYS[0],LEGACY_STORAGE_KEYS=APP_CONFIG.STORAGE.LEGACY_KEYS,SHARE_CARD_EXPORT_SIZE=APP_CONFIG.SHARE_CARD.EXPORT_SIZE,SHARE_CARD_CHART_WIDTH_RATIO=APP_CONFIG.SHARE_CARD.CHART_WIDTH_RATIO,SHARE_CARD_CHART_HEIGHT_RATIO=APP_CONFIG.SHARE_CARD.CHART_HEIGHT_RATIO,SHARE_CARD_CHART_MIN_HEIGHT=APP_CONFIG.SHARE_CARD.CHART_MIN_HEIGHT,CUMULATIVE_PL_RANGES=APP_CONFIG.PL_RANGES,RUNTIME_TRADE_FIELDS=new Set(["legsCount","openContracts","closeContracts","openLegs","rollLegs","totalFees","totalDebit","totalCredit","cashFlow","capitalAtRisk","fees","primaryLeg","tradeType","tradeDirection","quantity","strikePrice","multiplier","displayStrike","activeStrikePrice","entryPrice","exitPrice","pmccShortExpiration","longExpirationDate","entryDate","exitDate","pl","roi","maxRisk","maxRiskLabel","riskIsUnlimited","lifecycleMeta","lifecycleStatus","partialClose","rolledForward","autoExpired","daysHeld","dte","annualizedROI","tradeReasoning"]),RUNTIME_LEG_FIELDS=new Set(["externalId","importGroupId","importSource","importBatchId","tickerSymbol"]),BUILTIN_SAMPLE_DATA=(()=>{const e=new Date;e.setUTCHours(0,0,0,0);const t=t=>{const i=new Date(e);return i.setUTCDate(i.getUTCDate()+t),(e=>e.toISOString().slice(0,10))(i)};return{trades:[{id:"TRD-3001",ticker:"SPY",strategy:"Iron Condor",status:"Closed",openedDate:t(-280),closedDate:t(-265),expirationDate:t(-260),exitReason:"Closed at 60% of max profit.",notes:"Wide wings with low probability of touch.",legs:[{id:"TRD-3001-L1",orderType:"STO",type:"CALL",quantity:1,multiplier:100,executionDate:t(-280),expirationDate:t(-260),strike:585,premium:2.1,fees:.35},{id:"TRD-3001-L2",orderType:"BTO",type:"CALL",quantity:1,multiplier:100,executionDate:t(-280),expirationDate:t(-260),strike:595,premium:.85,fees:.25},{id:"TRD-3001-L3",orderType:"STO",type:"PUT",quantity:1,multiplier:100,executionDate:t(-280),expirationDate:t(-260),strike:545,premium:2.3,fees:.35},{id:"TRD-3001-L4",orderType:"BTO",type:"PUT",quantity:1,multiplier:100,executionDate:t(-280),expirationDate:t(-260),strike:535,premium:.9,fees:.25},{id:"TRD-3001-L5",orderType:"BTC",type:"CALL",quantity:1,multiplier:100,executionDate:t(-265),expirationDate:t(-260),strike:585,premium:.95,fees:.35},{id:"TRD-3001-L6",orderType:"STC",type:"CALL",quantity:1,multiplier:100,executionDate:t(-265),expirationDate:t(-260),strike:595,premium:.4,fees:.25},{id:"TRD-3001-L7",orderType:"BTC",type:"PUT",quantity:1,multiplier:100,executionDate:t(-265),expirationDate:t(-260),strike:545,premium:1,fees:.35},{id:"TRD-3001-L8",orderType:"STC",type:"PUT",quantity:1,multiplier:100,executionDate:t(-265),expirationDate:t(-260),strike:535,premium:.42,fees:.25}]},{id:"TRD-3002",ticker:"AAPL",strategy:"Put Credit Spread",status:"Closed",openedDate:t(-270),closedDate:t(-258),expirationDate:t(-250),exitReason:"Took profit before product announcement.",notes:"Bullish on seasonal strength.",legs:[{id:"TRD-3002-L1",orderType:"STO",type:"PUT",quantity:1,multiplier:100,executionDate:t(-270),expirationDate:t(-250),strike:220,premium:3.2,fees:.35},{id:"TRD-3002-L2",orderType:"BTO",type:"PUT",quantity:1,multiplier:100,executionDate:t(-270),expirationDate:t(-250),strike:210,premium:1.4,fees:.3},{id:"TRD-3002-L3",orderType:"BTC",type:"PUT",quantity:1,multiplier:100,executionDate:t(-258),expirationDate:t(-250),strike:220,premium:.85,fees:.35},{id:"TRD-3002-L4",orderType:"STC",type:"PUT",quantity:1,multiplier:100,executionDate:t(-258),expirationDate:t(-250),strike:210,premium:.38,fees:.25}]},{id:"TRD-3003",ticker:"MSFT",strategy:"Cash-Secured Put",status:"Closed",openedDate:t(-258),closedDate:t(-246),expirationDate:t(-238),exitReason:"Quick 70% profit capture.",notes:"Sold during cloud earnings optimism.",legs:[{id:"TRD-3003-L1",orderType:"STO",type:"PUT",quantity:1,multiplier:100,executionDate:t(-258),expirationDate:t(-238),strike:415,premium:2.6,fees:.35},{id:"TRD-3003-L2",orderType:"BTC",type:"PUT",quantity:1,multiplier:100,executionDate:t(-246),expirationDate:t(-238),strike:415,premium:.75,fees:.35}]},{id:"TRD-3004",ticker:"NVDA",strategy:"Strangle",status:"Closed",openedDate:t(-245),closedDate:t(-232),expirationDate:t(-225),exitReason:"Volatility collapsed post-earnings.",notes:"High IV rank play after AI chip announcement.",legs:[{id:"TRD-3004-L1",orderType:"STO",type:"CALL",quantity:1,multiplier:100,executionDate:t(-245),expirationDate:t(-225),strike:560,premium:8.5,fees:.45},{id:"TRD-3004-L2",orderType:"STO",type:"PUT",quantity:1,multiplier:100,executionDate:t(-245),expirationDate:t(-225),strike:420,premium:7.8,fees:.45},{id:"TRD-3004-L3",orderType:"BTC",type:"CALL",quantity:1,multiplier:100,executionDate:t(-232),expirationDate:t(-225),strike:560,premium:2.1,fees:.45},{id:"TRD-3004-L4",orderType:"BTC",type:"PUT",quantity:1,multiplier:100,executionDate:t(-232),expirationDate:t(-225),strike:420,premium:1.9,fees:.45}]},{id:"TRD-3005",ticker:"TSLA",strategy:"Call Credit Spread",status:"Closed",openedDate:t(-232),closedDate:t(-218),expirationDate:t(-210),exitReason:"Target profit reached.",notes:"Bearish setup at resistance.",legs:[{id:"TRD-3005-L1",orderType:"STO",type:"CALL",quantity:1,multiplier:100,executionDate:t(-232),expirationDate:t(-210),strike:285,premium:4.6,fees:.4},{id:"TRD-3005-L2",orderType:"BTO",type:"CALL",quantity:1,multiplier:100,executionDate:t(-232),expirationDate:t(-210),strike:300,premium:1.9,fees:.3},{id:"TRD-3005-L3",orderType:"BTC",type:"CALL",quantity:1,multiplier:100,executionDate:t(-218),expirationDate:t(-210),strike:285,premium:1.2,fees:.4},{id:"TRD-3005-L4",orderType:"STC",type:"CALL",quantity:1,multiplier:100,executionDate:t(-218),expirationDate:t(-210),strike:300,premium:.55,fees:.25}]},{id:"TRD-3006",ticker:"AMZN",strategy:"Iron Condor",status:"Closed",openedDate:t(-215),closedDate:t(-198),expirationDate:t(-190),exitReason:"Closed at 65% of max profit.",notes:"Theta play during consolidation.",legs:[{id:"TRD-3006-L1",orderType:"STO",type:"CALL",quantity:1,multiplier:100,executionDate:t(-215),expirationDate:t(-190),strike:205,premium:3.8,fees:.35},{id:"TRD-3006-L2",orderType:"BTO",type:"CALL",quantity:1,multiplier:100,executionDate:t(-215),expirationDate:t(-190),strike:215,premium:1.5,fees:.3},{id:"TRD-3006-L3",orderType:"STO",type:"PUT",quantity:1,multiplier:100,executionDate:t(-215),expirationDate:t(-190),strike:170,premium:3.4,fees:.35},{id:"TRD-3006-L4",orderType:"BTO",type:"PUT",quantity:1,multiplier:100,executionDate:t(-215),expirationDate:t(-190),strike:160,premium:1.3,fees:.3},{id:"TRD-3006-L5",orderType:"BTC",type:"CALL",quantity:1,multiplier:100,executionDate:t(-198),expirationDate:t(-190),strike:205,premium:1.45,fees:.35},{id:"TRD-3006-L6",orderType:"STC",type:"CALL",quantity:1,multiplier:100,executionDate:t(-198),expirationDate:t(-190),strike:215,premium:.6,fees:.25},{id:"TRD-3006-L7",orderType:"BTC",type:"PUT",quantity:1,multiplier:100,executionDate:t(-198),expirationDate:t(-190),strike:170,premium:1.25,fees:.35},{id:"TRD-3006-L8",orderType:"STC",type:"PUT",quantity:1,multiplier:100,executionDate:t(-198),expirationDate:t(-190),strike:160,premium:.5,fees:.25}]},{id:"TRD-3007",ticker:"META",strategy:"Put Credit Spread",status:"Closed",openedDate:t(-195),closedDate:t(-182),expirationDate:t(-175),exitReason:"Profit-taking before social media policy hearing.",notes:"Positioned for support bounce.",legs:[{id:"TRD-3007-L1",orderType:"STO",type:"PUT",quantity:1,multiplier:100,executionDate:t(-195),expirationDate:t(-175),strike:480,premium:3.2,fees:.35},{id:"TRD-3007-L2",orderType:"BTO",type:"PUT",quantity:1,multiplier:100,executionDate:t(-195),expirationDate:t(-175),strike:460,premium:1.55,fees:.3},{id:"TRD-3007-L3",orderType:"BTC",type:"PUT",quantity:1,multiplier:100,executionDate:t(-182),expirationDate:t(-175),strike:480,premium:1.1,fees:.35},{id:"TRD-3007-L4",orderType:"STC",type:"PUT",quantity:1,multiplier:100,executionDate:t(-182),expirationDate:t(-175),strike:460,premium:.6,fees:.3}]},{id:"TRD-3008",ticker:"GOOGL",strategy:"Call Credit Spread",status:"Closed",openedDate:t(-178),closedDate:t(-165),expirationDate:t(-160),exitReason:"Closed ahead of earnings volatility.",notes:"Selling premium into tech sector rotation.",legs:[{id:"TRD-3008-L1",orderType:"STO",type:"CALL",quantity:1,multiplier:100,executionDate:t(-178),expirationDate:t(-160),strike:145,premium:2.1,fees:.35},{id:"TRD-3008-L2",orderType:"BTO",type:"CALL",quantity:1,multiplier:100,executionDate:t(-178),expirationDate:t(-160),strike:155,premium:.85,fees:.3},{id:"TRD-3008-L3",orderType:"BTC",type:"CALL",quantity:1,multiplier:100,executionDate:t(-165),expirationDate:t(-160),strike:145,premium:.55,fees:.35},{id:"TRD-3008-L4",orderType:"STC",type:"CALL",quantity:1,multiplier:100,executionDate:t(-165),expirationDate:t(-160),strike:155,premium:.25,fees:.3}]},{id:"TRD-3009",ticker:"AMD",strategy:"Strangle",status:"Closed",openedDate:t(-162),closedDate:t(-148),expirationDate:t(-142),exitReason:"Closed after favorable semiconductor guidance.",notes:"Volatility trade around chip sector conference.",legs:[{id:"TRD-3009-L1",orderType:"STO",type:"CALL",quantity:1,multiplier:100,executionDate:t(-162),expirationDate:t(-142),strike:125,premium:3.2,fees:.35},{id:"TRD-3009-L2",orderType:"STO",type:"PUT",quantity:1,multiplier:100,executionDate:t(-162),expirationDate:t(-142),strike:90,premium:2.8,fees:.35},{id:"TRD-3009-L3",orderType:"BTC",type:"CALL",quantity:1,multiplier:100,executionDate:t(-148),expirationDate:t(-142),strike:125,premium:.95,fees:.35},{id:"TRD-3009-L4",orderType:"BTC",type:"PUT",quantity:1,multiplier:100,executionDate:t(-148),expirationDate:t(-142),strike:90,premium:.75,fees:.35}]},{id:"TRD-3010",ticker:"JPM",strategy:"Iron Condor",status:"Closed",openedDate:t(-142),closedDate:t(-128),expirationDate:t(-122),exitReason:"Closed at 60% max profit before banking sector volatility.",notes:"Balanced credit strategy in financial sector.",legs:[{id:"TRD-3010-L1",orderType:"STO",type:"CALL",quantity:1,multiplier:100,executionDate:t(-142),expirationDate:t(-122),strike:165,premium:1.45,fees:.3},{id:"TRD-3010-L2",orderType:"BTO",type:"CALL",quantity:1,multiplier:100,executionDate:t(-142),expirationDate:t(-122),strike:175,premium:.6,fees:.25},{id:"TRD-3010-L3",orderType:"STO",type:"PUT",quantity:1,multiplier:100,executionDate:t(-142),expirationDate:t(-122),strike:145,premium:1.35,fees:.3},{id:"TRD-3010-L4",orderType:"BTO",type:"PUT",quantity:1,multiplier:100,executionDate:t(-142),expirationDate:t(-122),strike:135,premium:.55,fees:.25},{id:"TRD-3010-L5",orderType:"BTC",type:"CALL",quantity:1,multiplier:100,executionDate:t(-128),expirationDate:t(-122),strike:165,premium:.5,fees:.3},{id:"TRD-3010-L6",orderType:"STC",type:"CALL",quantity:1,multiplier:100,executionDate:t(-128),expirationDate:t(-122),strike:175,premium:.2,fees:.25},{id:"TRD-3010-L7",orderType:"BTC",type:"PUT",quantity:1,multiplier:100,executionDate:t(-128),expirationDate:t(-122),strike:145,premium:.45,fees:.3},{id:"TRD-3010-L8",orderType:"STC",type:"PUT",quantity:1,multiplier:100,executionDate:t(-128),expirationDate:t(-122),strike:135,premium:.15,fees:.25}]},{id:"TRD-3011",ticker:"BAC",strategy:"Put Credit Spread",status:"Closed",openedDate:t(-122),closedDate:t(-108),expirationDate:t(-102),exitReason:"Took profit after favorable rate guidance.",notes:"Bullish banking sector play on regional strength.",legs:[{id:"TRD-3011-L1",orderType:"STO",type:"PUT",quantity:1,multiplier:100,executionDate:t(-122),expirationDate:t(-102),strike:32,premium:1.15,fees:.3},{id:"TRD-3011-L2",orderType:"BTO",type:"PUT",quantity:1,multiplier:100,executionDate:t(-122),expirationDate:t(-102),strike:28,premium:.45,fees:.25},{id:"TRD-3011-L3",orderType:"BTC",type:"PUT",quantity:1,multiplier:100,executionDate:t(-108),expirationDate:t(-102),strike:32,premium:.35,fees:.3},{id:"TRD-3011-L4",orderType:"STC",type:"PUT",quantity:1,multiplier:100,executionDate:t(-108),expirationDate:t(-102),strike:28,premium:.15,fees:.25}]},{id:"TRD-3012",ticker:"WMT",strategy:"Covered Call",status:"Closed",openedDate:t(-102),closedDate:t(-88),expirationDate:t(-82),exitReason:"Rolled forward after retail earnings strength.",notes:"Weekly premium income on long shares.",legs:[{id:"TRD-3012-L1",orderType:"STO",type:"CALL",quantity:1,multiplier:100,executionDate:t(-102),expirationDate:t(-82),strike:168,premium:1.3,fees:.3},{id:"TRD-3012-L2",orderType:"BTC",type:"CALL",quantity:1,multiplier:100,executionDate:t(-88),expirationDate:t(-82),strike:168,premium:.35,fees:.3}]},{id:"TRD-3013",ticker:"JNJ",strategy:"Cash-Secured Put",status:"Closed",openedDate:t(-82),closedDate:t(-68),expirationDate:t(-62),exitReason:"Closed after pharma sector rotation.",notes:"Selling premium on healthcare defensive play.",legs:[{id:"TRD-3013-L1",orderType:"STO",type:"PUT",quantity:1,multiplier:100,executionDate:t(-82),expirationDate:t(-62),strike:155,premium:1.85,fees:.35},{id:"TRD-3013-L2",orderType:"BTC",type:"PUT",quantity:1,multiplier:100,executionDate:t(-68),expirationDate:t(-62),strike:155,premium:.5,fees:.35}]},{id:"TRD-3014",ticker:"V",strategy:"Put Credit Spread",status:"Closed",openedDate:t(-62),closedDate:t(-48),expirationDate:t(-42),exitReason:"Exited before payment sector volatility.",notes:"Bullish on consumer spending trends.",legs:[{id:"TRD-3014-L1",orderType:"STO",type:"PUT",quantity:1,multiplier:100,executionDate:t(-62),expirationDate:t(-42),strike:270,premium:2.5,fees:.35},{id:"TRD-3014-L2",orderType:"BTO",type:"PUT",quantity:1,multiplier:100,executionDate:t(-62),expirationDate:t(-42),strike:260,premium:1.2,fees:.3},{id:"TRD-3014-L3",orderType:"BTC",type:"PUT",quantity:1,multiplier:100,executionDate:t(-48),expirationDate:t(-42),strike:270,premium:.85,fees:.35},{id:"TRD-3014-L4",orderType:"STC",type:"PUT",quantity:1,multiplier:100,executionDate:t(-48),expirationDate:t(-42),strike:260,premium:.45,fees:.3}]},{id:"TRD-3015",ticker:"MA",strategy:"Call Credit Spread",status:"Open",openedDate:t(-35),closedDate:"",expirationDate:t(28),exitReason:"",notes:"Bearish spread on payment sector resistance.",legs:[{id:"TRD-3015-L1",orderType:"STO",type:"CALL",quantity:1,multiplier:100,executionDate:t(-35),expirationDate:t(28),strike:510,premium:2.8,fees:.35},{id:"TRD-3015-L2",orderType:"BTO",type:"CALL",quantity:1,multiplier:100,executionDate:t(-35),expirationDate:t(28),strike:520,premium:1.4,fees:.3}]},{id:"TRD-3016",ticker:"DIS",strategy:"Cash-Secured Put",status:"Open",openedDate:t(-32),closedDate:"",expirationDate:t(35),exitReason:"",notes:"Premium collection on entertainment sector support.",legs:[{id:"TRD-3016-L1",orderType:"STO",type:"PUT",quantity:1,multiplier:100,executionDate:t(-32),expirationDate:t(35),strike:88,premium:1.95,fees:.35}]},{id:"TRD-3017",ticker:"NFLX",strategy:"Strangle",status:"Open",openedDate:t(-28),closedDate:"",expirationDate:t(42),exitReason:"",notes:"Volatility play around streaming earnings.",legs:[{id:"TRD-3017-L1",orderType:"STO",type:"CALL",quantity:1,multiplier:100,executionDate:t(-28),expirationDate:t(42),strike:740,premium:6.5,fees:.4},{id:"TRD-3017-L2",orderType:"STO",type:"PUT",quantity:1,multiplier:100,executionDate:t(-28),expirationDate:t(42),strike:620,premium:5.8,fees:.4}]},{id:"TRD-3018",ticker:"INTC",strategy:"Covered Call",status:"Open",openedDate:t(-25),closedDate:"",expirationDate:t(28),exitReason:"",notes:"Weekly income on chip sector holding.",legs:[{id:"TRD-3018-L1",orderType:"STO",type:"CALL",quantity:1,multiplier:100,executionDate:t(-25),expirationDate:t(28),strike:50,premium:1.05,fees:.3}]},{id:"TRD-3019",ticker:"ORCL",strategy:"Diagonal Put Spread",status:"Open",openedDate:t(-22),closedDate:"",expirationDate:t(50),exitReason:"",notes:"Long-dated protection with near-term premium income.",legs:[{id:"TRD-3019-L1",orderType:"BTO",type:"PUT",quantity:1,multiplier:100,executionDate:t(-22),expirationDate:t(120),strike:165,premium:7.2,fees:.4},{id:"TRD-3019-L2",orderType:"STO",type:"PUT",quantity:1,multiplier:100,executionDate:t(-22),expirationDate:t(50),strike:155,premium:3.5,fees:.35}]},{id:"TRD-3020",ticker:"XOM",strategy:"Put Credit Spread",status:"Open",openedDate:t(-18),closedDate:"",expirationDate:t(38),exitReason:"",notes:"Energy sector play on crude oil support.",legs:[{id:"TRD-3020-L1",orderType:"STO",type:"PUT",quantity:1,multiplier:100,executionDate:t(-18),expirationDate:t(38),strike:115,premium:2.1,fees:.35},{id:"TRD-3020-L2",orderType:"BTO",type:"PUT",quantity:1,multiplier:100,executionDate:t(-18),expirationDate:t(38),strike:105,premium:.95,fees:.3}]},{id:"TRD-3021",ticker:"CVX",strategy:"Call Credit Spread",status:"Open",openedDate:t(-15),closedDate:"",expirationDate:t(45),exitReason:"",notes:"Bearish energy sector spread on resistance.",legs:[{id:"TRD-3021-L1",orderType:"STO",type:"CALL",quantity:1,multiplier:100,executionDate:t(-15),expirationDate:t(45),strike:165,premium:1.85,fees:.35},{id:"TRD-3021-L2",orderType:"BTO",type:"CALL",quantity:1,multiplier:100,executionDate:t(-15),expirationDate:t(45),strike:175,premium:.75,fees:.3}]}],exportDate:e.toISOString(),version:"3.1"}})();class GammaLedger{constructor(){this.trades=[],this.currentView="dashboard",this.sortDirection={},this.charts={},this.tradeDetailCharts=new Map,this.latestStats=null,this.currentFileHandle=null,this.currentFileName="Unsaved Database",this.hasUnsavedChanges=!1,this.supportsFileSystemAccess="showOpenFilePicker"in window,this.currentEditingId=null,this.importControlsInitialized=!1,this.importLog=[],this.importSummary=null,this.importMergeSelection=new Set,this.tradeMergeSelection=new Set,this.tradesMergeInitialized=!1,this.tradesMergePanelOpen=!1,this.currentFilteredTrades=[],this.currentSort={key:null,direction:"asc"},this.cumulativePLRange="ALL",this.disclaimerBanner={element:null,body:null,agreeButton:null,agreeHandler:null,hideTimeoutId:null},this.disclaimerFadeMs=280,this.aiCoachConsent={element:null,panel:null,agreeButton:null,agreeHandler:null,dismissButtons:[],dismissHandlers:[],escapeHandler:null,restoreFocus:null,pendingAction:null,isVisible:!1},this.finnhub={apiKey:"",encryptionKey:null,cache:new Map,cacheTTL:6e4,outstandingRequests:new Map,rateLimitQueue:Promise.resolve(),maxRequestsPerMinute:60,timestamps:[],minIdleMs:1e3,lastRequestTime:0,statusTimeoutId:null,lastStatus:null,elements:{}},this.gemini={apiKey:"",encryptionKey:null,model:DEFAULT_GEMINI_MODEL,statusTimeoutId:null,lastStatus:null,pendingStatus:null,elements:{}},this.aiAgent=new GeminiInsightsAgent(this),this.aiChatMessages=[],this.aiChatSessionId=Date.now(),this.aiChatPendingRequest=!1,this.aiChatOpen=!1,this.activeQuoteEntries=new Map,this.quoteRefreshIntervalId=null,this.autoRefreshIntervalMs=this.computeAutoRefreshInterval(),this.quoteRefreshKeys=[],this.quoteRefreshCursor=0,this.positionHighlightConfig={expirationWarningDays:20,expirationCriticalDays:10},this.creditPlaybookStatus="active",this.creditPlaybookStrategy="all",this.creditPlaybookHorizon="all",this.creditPlaybookSymbol="",this.creditPlaybookSort={key:"entryDate",direction:"desc"},this.creditPlaybookEntries=[],this.creditPlaybookNeedsRefresh=!0,this.creditPlaybookInitialized=!1,this.creditPlaybookStrategyOptions=["Bear Call Ladder","Bear Call Spread","Bear Put Ladder","Bear Put Spread","Bull Call Ladder","Bull Call Spread","Bull Put Ladder","Bull Put Spread","Cash-Secured Put","Covered Call","Covered Put","Covered Short Straddle","Covered Short Strangle","Diagonal Call Spread","Diagonal Put Spread","Double Diagonal","Inverse Call Broken Wing","Inverse Iron Butterfly","Inverse Iron Condor","Inverse Put Broken Wing","Iron Albatross","Iron Butterfly","Iron Condor","Jade Lizard","Poor Man's Covered Call","Put Broken Wing","Put Ratio Backspread","Put Ratio Spread","Reverse Jade Lizard","Short Call","Short Call Butterfly","Short Call Condor","Short Guts","Short Put","Short Put Butterfly","Short Put Condor","Short Straddle","Short Strangle","Wheel"],this.assignedPositionsStatusFilter="open",this.sidebarState={container:null,sidebar:null,toggleButton:null,mediaQuery:null,mainContent:null,collapsed:!1,preferredCollapsed:!1},this.shareCard={root:null,card:null,button:null,chartCanvas:null,chartTitle:null,rangeLabel:null,chart:null,metrics:{},timestamp:null,exportSize:SHARE_CARD_EXPORT_SIZE},this.currentDate=new Date,this.init()}safeLocalStorage={getItem:e=>{try{return localStorage.getItem(e)}catch(t){return console.warn(`Failed to read from localStorage (key: ${e}):`,t),null}},setItem:(e,t)=>{try{return localStorage.setItem(e,t),!0}catch(t){return console.warn(`Failed to write to localStorage (key: ${e}):`,t),"QuotaExceededError"===t.name?alert("Storage quota exceeded. Please clear some data or use a different browser."):"SecurityError"===t.name&&console.warn("localStorage is disabled in this browser (private mode?)"),!1}},removeItem:e=>{try{return localStorage.removeItem(e),!0}catch(t){return console.warn(`Failed to remove from localStorage (key: ${e}):`,t),!1}}};validateNumber(e,t={}){const{min:i=-1/0,max:r=1/0,allowZero:a=!0,defaultValue:s=0}=t,n=Number(e);return Number.isFinite(n)&&(a||0!==n)?n<i||n>r?s:n:s}validateDate(e){if(!e||"string"!=typeof e)return null;const t=new Date(e);return isNaN(t.getTime())?null:e}sanitizeString(e,t=1e3){if(null==e)return"";const i=String(e).trim();return i.length>t?i.substring(0,t):i}destroyChart(e){if(e&&"function"==typeof e.destroy)try{e.destroy()}catch(e){console.warn("Failed to destroy chart:",e)}}cleanup(){this.disclaimerBanner?.hideTimeoutId&&clearTimeout(this.disclaimerBanner.hideTimeoutId),this.gemini?.statusTimeoutId&&clearTimeout(this.gemini.statusTimeoutId),this.finnhub?.statusTimeoutId&&clearTimeout(this.finnhub.statusTimeoutId),this.quoteRefreshIntervalId&&(clearInterval(this.quoteRefreshIntervalId),this.quoteRefreshIntervalId=null),Object.keys(this.charts).forEach(e=>{this.destroyChart(this.charts[e])}),this.charts={},this.tradeDetailCharts&&(this.tradeDetailCharts.forEach(e=>this.destroyChart(e)),this.tradeDetailCharts.clear()),this.shareCard?.chart&&(this.destroyChart(this.shareCard.chart),this.shareCard.chart=null)}async init(){try{await this.loadFromStorage(),await this.loadFinnhubConfigFromStorage(),await this.loadGeminiConfigFromStorage(),this.trades&&0!==this.trades.length?(this.updateFileNameDisplay(),this.updateDashboard()):await this.loadDefaultDatabase(),this.bindEvents(),this.initializeGeminiControls(),this.initializeAIChat(),this.initializeFinnhubControls(),this.initializeDisclaimerBanner(),this.initializeAICoachConsent(),this.initializeSidebarToggle(),this.initializeShareCard(),this.updateFileNameDisplay(),this.checkBrowserCompatibility(),setTimeout(()=>{this.updateDashboard(),this.showView("dashboard")},100)}catch(e){console.error("Failed to initialize application:",e);const t=document.getElementById("compatibility-notice");if(t){const e=t.querySelector(".notice-content");if(e){e.textContent="";const t=document.createElement("h4");t.textContent="⚠️ Initialization Error";const i=document.createElement("p");i.textContent="Failed to load the application. Please refresh the page or contact support if the issue persists.",e.appendChild(t),e.appendChild(i)}t.classList.remove("hidden")}}}computeAutoRefreshInterval(){const e=Number(this.finnhub?.maxRequestsPerMinute)||60,t=Math.min(Math.max(e-2,1),60);return Math.max(1600,Math.ceil(24e4/t))}checkBrowserCompatibility(){if(!this.supportsFileSystemAccess){const e=document.getElementById("compatibility-notice");e&&e.classList.remove("hidden"),console.log("File System Access API not supported, using fallback methods")}}async loadDefaultDatabase(){try{if(!BUILTIN_SAMPLE_DATA||!Array.isArray(BUILTIN_SAMPLE_DATA.trades))throw new Error("Built-in sample data unavailable.");const e=JSON.parse(JSON.stringify(BUILTIN_SAMPLE_DATA));this.processLoadedData(e,{fileName:"Sample Database (Built-in)",source:"default-sample"}),this.currentFileHandle=null}catch(e){console.warn("Default database not loaded:",e),this.trades=[],this.currentFileName="Unsaved Database",this.currentFileHandle=null,this.hasUnsavedChanges=!1,this.updateUnsavedIndicator(),this.saveToStorage({fileName:this.currentFileName}),this.updateFileNameDisplay(),this.updateDashboard()}}normalizeLegOrderType(e){const t=(e||"").toString().trim().toUpperCase();if(["BTO","STO","BTC","STC"].includes(t))return t;const i=t.replace("BUY TO OPEN","BTO").replace("SELL TO OPEN","STO").replace("BUY TO CLOSE","BTC").replace("SELL TO CLOSE","STC");return["BTO","STO","BTC","STC"].includes(i)?i:t.startsWith("B")?t.includes("C")?"BTC":"BTO":t.startsWith("S")?t.includes("C")?"STC":"STO":"BTO"}mapOrderTypeToActionSide(e){switch(this.normalizeLegOrderType(e)){case"BTO":default:return{action:"BUY",side:"OPEN"};case"STO":return{action:"SELL",side:"OPEN"};case"BTC":return{action:"BUY",side:"CLOSE"};case"STC":return{action:"SELL",side:"CLOSE"}}}getLegOrderDescriptor(e={}){const t=this.normalizeLegOrderType(e?.orderType||e?.order||e?.tradeType);if(t)return this.mapOrderTypeToActionSide(t);const i=this.normalizeLegAction(e?.action),r=this.normalizeLegSide(e?.side);return i||r?this.mapOrderTypeToActionSide(this.deriveOrderTypeFromActionSide(i||"BUY",r||"OPEN")):{action:"BUY",side:"OPEN"}}getLegAction(e={}){return this.getLegOrderDescriptor(e).action}getLegSide(e={}){return this.getLegOrderDescriptor(e).side}deriveOrderTypeFromActionSide(e,t){const i=this.normalizeLegAction(e),r=this.normalizeLegSide(t);return"ROLL"===r?"SELL"===i?"STO":"BTO":"BUY"===i&&"OPEN"===r?"BTO":"SELL"===i&&"OPEN"===r?"STO":"BUY"===i&&"CLOSE"===r?"BTC":"SELL"===i&&"CLOSE"===r?"STC":"BTO"}normalizeLegAction(e){const t=(e||"").toString().trim().toUpperCase();return["SELL","SHORT","STO","STC"].includes(t)?"SELL":"BUY"}normalizeLegSide(e){const t=(e||"").toString().trim().toUpperCase();return t.startsWith("ROL")?"ROLL":["CALL","PUT","STOCK"].includes(t)?"CLOSE":["CASH","FUTURE","ETF","SHARES","STK"].includes(t)?"STOCK":["BTO","STO"].includes(t)?"OPEN":["BTC","STC"].includes(t)?"CLOSE":"OPEN"}normalizeLegType(e){const t=(e||"").toString().trim().toUpperCase();return["CALL","PUT","STOCK","CASH","FUTURE","ETF"].includes(t)?t:"SHARES"===t?"STOCK":t||"UNKNOWN"}getLegMultiplier(e){const t=Number(e?.multiplier);if(Number.isFinite(t)&&t>0)return t;const i=this.normalizeLegType(e?.type);if("STOCK"===i||"CASH"===i)return 1;const r=this.normalizeUnderlyingType(e?.underlyingType,{fallback:"Stock"});return this.getDefaultMultiplierForLegType(i,r)}normalizeLeg(e,t=0){const i=Number(e?.quantity),r=Number.isFinite(i)?i:0,a=e?.executionDate?new Date(e.executionDate):null,s=a&&!Number.isNaN(a.getTime())?a.toISOString().slice(0,10):"",n=e?.expirationDate?new Date(e.expirationDate):null,o=n&&!Number.isNaN(n.getTime())?n.toISOString().slice(0,10):"",l=this.normalizeLegOrderType(e?.orderType||e?.tradeType||e?.order||this.deriveOrderTypeFromActionSide(e?.action,e?.side)),c=e?.externalId,d=e?.importGroupId,u=e?.importSource;return{id:e?.id||`LEG-${Date.now()}-${t}`,orderType:l,type:this.normalizeLegType(e?.type),quantity:r,multiplier:this.getLegMultiplier(e),executionDate:s,expirationDate:o,strike:Number.isFinite(Number(e?.strike))?Number(e.strike):null,premium:Number.isFinite(Number(e?.premium))?Number(e.premium):0,fees:Number.isFinite(Number(e?.fees))?Number(e.fees):0,underlyingPrice:Number.isFinite(Number(e?.underlyingPrice))?Number(e.underlyingPrice):null,underlyingType:this.normalizeUnderlyingType(e?.underlyingType,{fallback:"Stock"}),externalId:null==c?null:c.toString().trim()||null,importGroupId:null==d?null:d.toString().trim()||null,importSource:null==u?null:u.toString().trim()||null}}calculateLegCashFlow(e){if(!e)return 0;const t=Math.abs(Number(e.quantity)||0);if(!t)return-(Number(e.fees)||0);const i=this.getLegMultiplier(e),r=Number(e.premium)||0,a=Number(e.fees)||0;return("SELL"===this.getLegAction(e)?1:-1)*r*i*t-a}summarizeLegs(e=[]){const t={legs:[],legsCount:0,openLegs:0,closeLegs:0,rollLegs:0,totalFees:0,totalDebit:0,totalCredit:0,cashFlow:0,openCashFlow:0,closeCashFlow:0,openedDate:null,closedDate:null,earliestExpiration:null,latestExpiration:null,primaryLeg:null,openContracts:0,closeContracts:0,capitalAtRisk:0,entryPrice:null,exitPrice:null,openCreditGross:0,openDebitGross:0,openFees:0,openBaseContracts:0,verticalSpread:null,nearestShortCallExpiration:null,nextShortCallExpiration:null};if(!Array.isArray(e)||0===e.length)return t;const i=e.map((e,t)=>this.normalizeLeg(e,t));t.legs=i,t.legsCount=i.length;const r=new Map,a=this.currentDate instanceof Date?this.currentDate:new Date,s=new Map;i.forEach((i,a)=>{const n=Array.isArray(e)?e[a]:null,o=this.getLegAction(i),l=this.getLegSide(i),c=this.normalizeLegAction(n?.action),d=o||c,u="ROLL"===this.normalizeLegSide(n?.side)?"ROLL":l,m=this.calculateLegCashFlow(i);t.cashFlow+=m,t.totalFees+=Number(i.fees)||0;const h=Math.abs(Number(i.quantity)||0);if(h)if("OPEN"===u){t.openLegs+=1,t.openContracts+=h,t.openCashFlow+=m;const e=this.getLegMultiplier(i)||1,a=Math.abs(Number(i.premium)||0)*e*h;if("SELL"===d?t.openCreditGross+=a:t.openDebitGross+=a,t.openFees+=Number(i.fees)||0,h>t.openBaseContracts&&(t.openBaseContracts=h),["CALL","PUT"].includes(i.type)&&Number.isFinite(Number(i.strike))){const e=`${i.type}|${i.expirationDate||""}`;r.has(e)||r.set(e,[]),r.get(e).push({leg:i,action:d,side:u})}}else"CLOSE"===u?(t.closeLegs+=1,t.closeContracts+=h,t.closeCashFlow+=m):"ROLL"===u&&(t.rollLegs+=1);if("BUY"===d?t.totalDebit+=Math.abs(m+(Number(i.fees)||0)):t.totalCredit+=Math.abs(m+(Number(i.fees)||0)),i.executionDate){const e=new Date(i.executionDate);Number.isNaN(e.getTime())||((!t.openedDate||e<t.openedDate)&&(t.openedDate=e),(!t.closedDate||e>t.closedDate)&&(t.closedDate=e))}if(i.expirationDate){const e=new Date(i.expirationDate);if(!Number.isNaN(e.getTime()))if((!t.earliestExpiration||e<t.earliestExpiration)&&(t.earliestExpiration=e),(!t.latestExpiration||e>t.latestExpiration)&&(t.latestExpiration=e),"SELL"===d&&"CALL"===i.type){const e=`${i.strike}|${i.expirationDate}`,t=Math.abs(Number(i.quantity)||0);"OPEN"===u?s.set(e,(s.get(e)||0)+t):"CLOSE"===u&&s.set(e,(s.get(e)||0)-t)}else if("BUY"===d&&"CALL"===i.type&&"CLOSE"===u){const e=`${i.strike}|${i.expirationDate}`,t=Math.abs(Number(i.quantity)||0);s.set(e,(s.get(e)||0)-t)}}t.primaryLeg||"CLOSE"===u||(t.primaryLeg=i)}),t.primaryLeg||(t.primaryLeg=i[0]),s.forEach((e,i)=>{if(e<=0)return;const[r,s]=i.split("|"),n=s?new Date(s):null;if(!n||Number.isNaN(n.getTime()))return;(!t.nearestShortCallExpiration||n<t.nearestShortCallExpiration)&&(t.nearestShortCallExpiration=n);new Date(Date.UTC(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate(),21,0,0))>=a&&(!t.nextShortCallExpiration||n<t.nextShortCallExpiration)&&(t.nextShortCallExpiration=n)});let n=null;for(const e of r.values()){if(!Array.isArray(e)||e.length<2)continue;const i=e.some(({action:e})=>"BUY"===e),r=e.some(({action:e})=>"SELL"===e);if(!i||!r)continue;const a=e.map(({leg:e})=>Number(e.strike)).filter(Number.isFinite);if(a.length<2)continue;const s=Math.abs(Math.max(...a)-Math.min(...a));if(!(s>0))continue;const o=this.getLegMultiplier(e[0]?.leg)||1,l=e.map(({leg:e})=>Math.abs(Number(e.quantity)||0)).filter(e=>e>0);n={width:s,multiplier:o,contracts:(l.length?Math.min(...l):t.openBaseContracts||1)||1};break}t.verticalSpread=n;const o=this.getLegMultiplier(t.primaryLeg)||1,l=t.openContracts||Math.abs(Number(t.primaryLeg?.quantity)||0)||1,c=n?.contracts||t.openBaseContracts||l,d=t.closeContracts||0,u=Number(t.openCashFlow);return Number.isFinite(u)&&c>0&&o>0?t.entryPrice=Math.abs(u)/(c*o):l>0&&o>0&&(t.entryPrice=Math.abs(t.openCashFlow)/(l*o)),d>0&&(t.exitPrice=Math.abs(t.closeCashFlow)/(d*o)),t.capitalAtRisk=this.computeMaxRiskUsingFormula({legs:i},t),t}hasNetOpenOptionLegs(e={}){const t=Array.isArray(e?.legs)?e.legs:[];if(!t.length)return!1;const i=this.summarizeLegs(t),r=Array.isArray(i?.legs)?i.legs:[];if(!r.length)return!1;const a=new Map;return r.forEach(e=>{if(!e||!["CALL","PUT"].includes((e.type||"").toUpperCase()))return;const t=Math.abs(Number(e.quantity)||0);if(!t)return;const i=`${e.type}|${e.strike??""}|${e.expirationDate??""}`,r=this.getLegSide(e);"OPEN"===r?a.set(i,(a.get(i)||0)+t):"CLOSE"===r&&a.set(i,(a.get(i)||0)-t)}),!!a.size&&Array.from(a.values()).some(e=>e>0)}getNetOpenOptionContracts(e=[]){const t=Array.isArray(e)?e:[];if(!t.length)return 0;const i=new Map;return t.forEach(e=>{if(!e||!["CALL","PUT"].includes((e.type||"").toUpperCase()))return;const t=Math.abs(Number(e.quantity)||0);if(!t)return;const r=`${e.type}|${e.strike??""}|${e.expirationDate??""}`,a=this.getLegSide(e);"OPEN"===a?i.set(r,(i.get(r)||0)+t):"CLOSE"===a&&i.set(r,(i.get(r)||0)-t)}),i.size?Array.from(i.values()).reduce((e,t)=>e+Math.max(0,Number(t)||0),0):0}buildRiskFormulaContext(e={},t=null){const i=t||this.summarizeLegs(e?.legs||[]);if(!i)return null;let r=Number(e?.strikePrice);if(!(Number.isFinite(r)&&r>0)){const t=Number(e?.activeStrikePrice);Number.isFinite(t)&&t>0&&(r=t)}if(!(Number.isFinite(r)&&r>0)){const e=Number(i?.primaryLeg?.strike);if(Number.isFinite(e)&&e>0)r=e;else{const e=this.derivePrimaryStrike(i);Number.isFinite(e)&&e>0&&(r=e)}}let a=Math.abs(Number(e?.quantity))||0;if(!(a>0)){const e=Number(i?.openBaseContracts);Number.isFinite(e)&&e>0&&(a=e)}if(!(a>0)){const e=Number(i?.primaryLeg?.quantity);Number.isFinite(e)&&0!==e&&(a=Math.abs(e))}if(!(a>0))return null;let s=Math.abs(Number(e?.multiplier))||0;if(!(s>0)&&i?.primaryLeg){const e=this.getLegMultiplier(i.primaryLeg);Number.isFinite(e)&&e>0&&(s=e)}if(!(s>0)&&Array.isArray(i?.legs)){const e=i.legs.find(e=>Number.isFinite(Number(e?.multiplier))&&Number(e.multiplier)>0);e&&(s=Math.abs(Number(this.getLegMultiplier(e))))}const n=(Array.isArray(i?.legs)?i.legs.filter(e=>e&&"OPEN"===this.getLegSide(e)):[]).filter(e=>"STOCK"===e.type);if(n.length>0){const e=n.reduce((e,t)=>{const i=t.quantity*this.getLegMultiplier(t);return e+("BUY"===this.getLegAction(t)?i:-i)},0),t=Math.abs(Math.round(e));t>0?(a=t,s=1):s>0||(s=100)}else s>0||(s=100);const o=a*s;if(!(o>0))return null;const l=Number(i?.openCreditGross)||0,c=Number(i?.openDebitGross)||0,d=Number(i?.openFees)||0,u=o>0?l/o:0,m=o>0?c/o:0,h=u-m,p=Math.max(h,0),g=Math.max(-h,0),y=o>0?d/o:0,f=Array.isArray(i?.legs)?i.legs.filter(e=>e&&"OPEN"===this.getLegSide(e)):[],b=f.filter(e=>["CALL","PUT"].includes(e.type)&&Number.isFinite(Number(e.strike))),C=b.map(e=>Number(e.strike)).filter(e=>Number.isFinite(e)),S=Array.from(new Set(C)).sort((e,t)=>e-t),T=S[0]??null,L=S[1]??null,x=S[2]??null,k=S[3]??null,v=[];for(let e=1;e<S.length;e+=1){const t=S[e]-S[e-1];Number.isFinite(t)&&t>0&&v.push(t)}const N=v.length?Math.min(...v):null,D=v.length?Math.max(...v):null,I=e=>b.filter(e).map(e=>Number(e.strike)).filter(e=>Number.isFinite(e)).sort((e,t)=>e-t),E=I(e=>"CALL"===e.type&&"SELL"===this.getLegAction(e)),P=I(e=>"CALL"===e.type&&"BUY"===this.getLegAction(e)),F=I(e=>"PUT"===e.type&&"SELL"===this.getLegAction(e)),A=I(e=>"PUT"===e.type&&"BUY"===this.getLegAction(e)),w=E.length?E[0]:null,M=E.length?E[E.length-1]:null,R=P.length?P[0]:null,O=P.length?P[P.length-1]:null,B=F.length?F[0]:null,_=F.length?F[F.length-1]:null,$=A.length?A[0]:null,U=A.length?A[A.length-1]:null,K=Number.isFinite(T)&&Number.isFinite(L)?Math.max(L-T,0):null,G=Number.isFinite(L)&&Number.isFinite(x)?Math.max(x-L,0):null,q=Number.isFinite(x)&&Number.isFinite(k)?Math.max(k-x,0):null,H=Math.max(Number.isFinite(K)?K:0,Number.isFinite(q)?q:0)||null,z=Number.isFinite(H)&&H>0?H:Number.isFinite(G)&&G>0?G:Number.isFinite(N)&&N>0?N:null,V=f.filter(e=>"STOCK"===e.type),Y=[],W=e=>{const t=Number(e);Number.isFinite(t)&&t>0&&Y.push(t)};W(e?.entryUnderlyingPrice),W(e?.underlyingEntryPrice),W(e?.underlyingPrice),W(e?.underlyingPriceAtEntry),f.forEach(e=>W(e?.underlyingPrice)),!Y.length&&V.length&&V.map(e=>Number(e?.premium)).filter(e=>Number.isFinite(e)&&e>0).forEach(e=>Y.push(e));let Q=null;if(Y.length){const e=Y.reduce((e,t)=>e+t,0)/Y.length;Number.isFinite(e)&&e>0&&(Q=e)}const j=Number.isFinite(r)&&r>0?r:w??_??T??null,X=Number.isFinite(i?.verticalSpread?.width)&&i.verticalSpread.width>0?i.verticalSpread.width:null;return{trade:e,details:i,referenceStrike:j,contracts:a,multiplier:s,contractValue:o,netPremium:h,netCredit:p,netDebit:g,premiumPaid:m,premiumReceived:u,totalFeesPerShare:y,strikes:S,K:j,K1:T,K2:L,K3:x,K4:k,lowerWidth:K,middleWidth:G,upperWidth:q,minStrikeDiff:N,maxStrikeDiff:D,maxWingWidth:H,defaultWidth:z,shortCallStrike:w,shortCallStrikeHigh:M,longCallStrike:O,longCallStrikeLow:R,shortPutStrike:_,shortPutStrikeLow:B,longPutStrike:U,longPutStrikeLow:$,verticalSpreadWidth:X,S:Q,hasStockExposure:V.length>0,toNotional:e=>{if(null==e)return;if(e===Number.POSITIVE_INFINITY)return Number.POSITIVE_INFINITY;const t=Number(e);if(!Number.isFinite(t))return;return Math.max(t,0)*o},contractCount:a,multiplierValue:s}}computeDefaultMaxRisk(e){if(!(e&&e.contractValue>0))return 0;const t=Number(e.netDebit);if(Number.isFinite(t)&&t>0){const i=e.toNotional(t);return Number.isFinite(i)?i:0}return 0}getStrategyRiskHandlers(){if(!this.strategyRiskHandlersCache){const e=(e,t)=>Number.isFinite(e)&&Number.isFinite(t)?Math.max(t-e,0):null,t=(...e)=>{for(const t of e){const e=Number(t);if(Number.isFinite(e)&&e>0)return e}return null},i={},r=(e,t)=>(e&&(i[e]=t),t),a=e=>{const t=Number(e.netDebit);if(Number.isFinite(t)&&t>0)return e.toNotional(t);const i=Number(e.premiumPaid);return Number.isFinite(i)&&i>0?e.toNotional(i):void 0},s=(e,t)=>{const i=Number.isFinite(e.verticalSpreadWidth)&&e.verticalSpreadWidth>0?e.verticalSpreadWidth:t;if(Number.isFinite(i)&&!(i<=0))return e.netCredit>0?e.toNotional(i-e.netCredit):e.netDebit>0?e.toNotional(i+e.netDebit):e.toNotional(i)},n=(t,i,r)=>{const a=e(i,r);if(null!==a)return s(t,a)},o=(t,i,r)=>{const a=e(i,r);if(null!==a)return t.toNotional(a-t.netDebit)},l=t=>{const i=Number.isFinite(t.defaultWidth)&&t.defaultWidth>0?t.defaultWidth:e(t.K1,t.K2);if(Number.isFinite(i)&&!(i<=0))return s(t,i)};r("Bear Call Ladder",e=>n(e,e.K1,e.K2)),r("Bear Call Spread",e=>n(e,e.K1,e.K2)),r("Bear Put Ladder",t=>{const i=e(t.K2,t.K3);if(null!==i)return t.toNotional(t.netDebit-i)}),r("Bear Put Spread",e=>a(e)),r("Box Spread",e=>n(e,e.K1,e.K2)),r("Bull Call Ladder",t=>{const i=e(t.K1,t.K2);if(null!==i)return t.toNotional(t.netDebit+i)}),r("Bull Call Spread",e=>a(e)),r("Bull Put Ladder",e=>n(e,e.K1,e.K2)),r("Bull Put Spread",e=>n(e,e.K1,e.K2)),r("Calendar Call Spread",a),r("Calendar Put Spread",a),r("Calendar Straddle",a),r("Calendar Strangle",a),r("Call Broken Wing",e=>n(e,e.K1,e.K2)),r("Call Ratio Backspread",e=>n(e,e.K1,e.K2)),r("Call Ratio Spread",e=>n(e,e.K1,e.K2)),r("Cash-Secured Put",e=>{const i=t(e.shortPutStrike,e.shortPutStrikeLow,e.K,e.K1);if(Number.isFinite(i))return e.toNotional(i-e.netCredit)}),r("Collar",e=>{const i=t(e.S,e.referenceStrike),r=t(e.longPutStrike,e.shortPutStrike,e.K1);if(null!==i&&null!==r)return e.toNotional(i-r-e.netCredit)}),r("Covered Call",e=>{const i=t(e.S,e.referenceStrike);if(null!==i)return e.toNotional(i-e.netCredit)}),r("Covered Put",()=>Number.POSITIVE_INFINITY),r("Covered Short Straddle",()=>Number.POSITIVE_INFINITY),r("Covered Short Strangle",()=>Number.POSITIVE_INFINITY),r("Diagonal Call Spread",a),r("Diagonal Put Spread",a),r("Double Diagonal",a),r("Guts",a),r("Inverse Call Broken Wing",e=>o(e,e.K2,e.K3)),r("Inverse Iron Butterfly",t=>{const i=e(t.K1,t.K2);if(null!==i)return t.toNotional(t.netDebit-i)}),r("Inverse Iron Condor",a),r("Inverse Put Broken Wing",e=>o(e,e.K1,e.K2)),r("Iron Albatross",l),r("Iron Butterfly",e=>n(e,e.K1,e.K2)),r("Iron Condor",l),r("Jade Lizard",e=>{const i=t(e.shortCallStrike,e.shortCallStrikeHigh,e.K2,e.K3);if(Number.isFinite(i))return e.toNotional(i-e.netCredit)}),r("Long Call",a),r("Long Call Butterfly",a),r("Long Call Condor",a),r("Long Put",a),r("Long Put Butterfly",a),r("Long Put Condor",a),r("Long Straddle",a),r("Long Strangle",a),r("Poor Man's Covered Call",a),r("Protective Put",e=>{const i=t(e.S,e.referenceStrike),r=t(e.longPutStrike,e.longPutStrikeLow,e.K1);if(null!==i&&null!==r)return e.toNotional(i-r+e.netDebit)}),r("Put Broken Wing",e=>n(e,e.K1,e.K2)),r("Put Ratio Backspread",e=>n(e,e.K1,e.K2)),r("Put Ratio Spread",e=>n(e,e.K1,e.K2)),r("Reverse Jade Lizard",e=>{const i=t(e.shortPutStrike,e.shortPutStrikeLow,e.K1);if(Number.isFinite(i))return e.toNotional(i-e.netCredit)}),r("Short Call",()=>Number.POSITIVE_INFINITY),r("Short Call Butterfly",e=>n(e,e.K1,e.K2)),r("Short Call Condor",l),r("Short Guts",()=>Number.POSITIVE_INFINITY),r("Short Put",e=>{const i=t(e.shortPutStrike,e.shortPutStrikeLow,e.K,e.K1);if(Number.isFinite(i))return e.toNotional(i-e.netCredit)}),r("Short Put Butterfly",e=>n(e,e.K1,e.K2)),r("Short Put Condor",l),r("Short Straddle",()=>Number.POSITIVE_INFINITY),r("Short Strangle",()=>Number.POSITIVE_INFINITY),r("Strap",a),r("Strip",a),r("Synthetic Long Stock",()=>Number.POSITIVE_INFINITY),r("Synthetic Short Stock",()=>Number.POSITIVE_INFINITY),r("Synthetic Put",()=>Number.POSITIVE_INFINITY),r("Wheel",e=>{const i=t(e.shortPutStrike,e.shortPutStrikeLow,e.K1);if(Number.isFinite(i))return e.toNotional(i-e.netCredit)}),i["Calendar Call Spread"]&&r("Calendar Spread",i["Calendar Call Spread"]),i["Call Broken Wing"]&&(r("Call Broken Wing Butterfly",i["Call Broken Wing"]),r("Broken Wing Butterfly",i["Call Broken Wing"])),i["Put Broken Wing"]&&r("Put Broken Wing Butterfly",i["Put Broken Wing"]),i.Wheel&&r("Wheel Strategy",i.Wheel),i["Cash-Secured Put"]&&r("Cash Secured Put",i["Cash-Secured Put"]),i["Poor Man's Covered Call"]&&r("Poor Mans Covered Call",i["Poor Man's Covered Call"]),this.strategyRiskHandlersCache=i}return this.strategyRiskHandlersCache}evaluateStrategyMaxRisk(e,t){if(!t)return;const i=this.getStrategyRiskHandlers(),r=(e||"").toString().trim();if(!r)return;const a=i[r];return"function"==typeof a?a(t):void 0}computeMaxRiskUsingFormula(e={},t=null){const i=t||this.summarizeLegs(e?.legs||[]);if(!i)return 0;const r=this.buildRiskFormulaContext(e,i);if(!r)return 0;const a=this.getStrategyDisplayName(e?.strategy||"");let s=a?this.evaluateStrategyMaxRisk(a,r):void 0;return void 0===s&&(s=this.computeDefaultMaxRisk(r)),s===Number.POSITIVE_INFINITY?Number.POSITIVE_INFINITY:!Number.isFinite(s)||s<=0?0:parseFloat(s.toFixed(2))}formatStrikeValue(e){const t=Number(e);return Number.isFinite(t)?Math.abs(t)>=1e3?t.toFixed(0):Number.isInteger(t)?t.toString():t.toFixed(2).replace(/\.00$/,""):"—"}derivePrimaryStrike(e){if(!e||!Array.isArray(e.legs))return null;const t=e.legs.filter(e=>"OPEN"===this.getLegSide(e)),i=t.length?t:e.legs,r=i.find(e=>"SELL"===this.getLegAction(e)&&Number.isFinite(Number(e.strike)));if(r)return Number(r.strike);const a=i.find(e=>Number.isFinite(Number(e.strike)));return a?Number(a.strike):null}getActiveStrikeForDisplay(e){if(!e||!Array.isArray(e.legs)||0===e.legs.length)return null;const t=e.legs.filter(e=>Number.isFinite(Number(e?.strike)));if(0===t.length)return null;const i=t.filter(e=>["CALL","PUT"].includes((e.type||"").toUpperCase())),r=i.filter(e=>"OPEN"===this.getLegSide(e)),a=t.filter(e=>"OPEN"===this.getLegSide(e));let s=[];s=r.length?r:i.length?i:a.length?a:t;let n=null,o=Number.NEGATIVE_INFINITY,l=Number.NEGATIVE_INFINITY,c=-1;return s.forEach((e,t)=>{const i=e.executionDate?new Date(e.executionDate):null,r=i&&!Number.isNaN(i.getTime())?i.getTime():Number.NEGATIVE_INFINITY,a="SELL"===this.getLegAction(e)?1:0;(r>o||r===o&&a>l||r===o&&a===l&&t>c)&&(n=e,o=r,l=a,c=t)}),n?Number(n.strike):null}buildStrikeDisplay(e,t=null){const i=t||this.summarizeLegs(e?.legs||[]),r=i?.legs||[];if(0===r.length)return"—";const a=r.filter(e=>"OPEN"===this.getLegSide(e)),s=a.length?a:r,n=s.filter(e=>["CALL","PUT"].includes(e.type)&&Number.isFinite(Number(e.strike)));if(n.length>0){const e=n.reduce((e,t)=>{const i="CALL"===t.type?"C":"P";return e[i]||(e[i]=new Set),e[i].add(Number(t.strike)),e},{});return Object.entries(e).map(([e,t])=>`${e}${Array.from(t).sort((e,t)=>e-t).map(e=>this.formatStrikeValue(e)).join("/")}`).sort().join(" · ")||"—"}const o=s.filter(e=>"STOCK"===e.type);if(o.length>0){const e=o.reduce((e,t)=>{const i=t.quantity*this.getLegMultiplier(t);return e+("BUY"===this.getLegAction(t)?i:-i)},0),t=Math.abs(Math.round(e));if(t>0)return`${t} sh`}return"—"}assessRisk(e,t){const i=t||this.summarizeLegs(e?.legs||[]),r=this.computeMaxRiskUsingFormula(e,i),a={maxRiskValue:0,maxRiskLabel:"$0.00",unlimited:!1};return r===Number.POSITIVE_INFINITY?(a.maxRiskValue=Number.POSITIVE_INFINITY,a.maxRiskLabel="Unlimited",a.unlimited=!0,i.capitalAtRisk=Number.POSITIVE_INFINITY,a):(Number.isFinite(r)&&r>0?(a.maxRiskValue=r,a.maxRiskLabel=this.formatCurrency(r)):(a.maxRiskValue=0,a.maxRiskLabel="$0.00"),i.capitalAtRisk=a.maxRiskValue,a)}getFormulaData(){return this.formulaDataCache||(this.formulaDataCache={variableExplanations:{S_0:"Underlying price at entry",S_T:"Underlying price at expiry",K:"Strike price",K1:"Lower strike price",K2:"Mid strike price",K3:"Upper strike price",K4:"Highest strike price",K_put:"Put strike",K_call:"Call strike",D_spread:"Strike width (K2 - K1)",netDebit:"Net debit paid",netCredit:"Net credit received",M:"Contract multiplier (×100)","∞":"Unlimited (profit/loss)",maxRisk:"Max loss",maxGain:"Max gain"},strategies:{"Bear Call Ladder":{maxRiskFormula:"∞",maxGainFormula:"(K2 - K1 + netCredit) * M",explanation:"Unlimited upside risk; max gain at K2. (Assumes Call Ratio Spread: Buy K2, Sell 2 K1)."},"Bear Call Spread":{maxRiskFormula:"(K2 - K1 - netCredit) * M",maxGainFormula:"netCredit * M",explanation:"Limited risk and limited profit; bearish strategy. (Sell K1, Buy K2)"},"Bear Put Ladder":{maxRiskFormula:"∞",maxGainFormula:"(K2 - K1 + netCredit) * M",explanation:"Unlimited downside risk; max gain at K1. (Assumes Put Ratio Spread: Buy K2, Sell 2 K1)."},"Bear Put Spread":{maxRiskFormula:"netDebit * M",maxGainFormula:"(K2 - K1 - netDebit) * M",explanation:"Defined-risk bearish spread. (Buy K2, Sell K1)"},"Box Spread":{maxRiskFormula:"(netDebit - (K2 - K1)) * M",maxGainFormula:"(K2 - K1 - netDebit) * M",explanation:"Arbitrage strategy. Profit/loss is locked in at purchase."},"Bull Call Ladder":{maxRiskFormula:"(K2 - K1 - netCredit) * M",maxGainFormula:"∞",explanation:"Unlimited upside gain; risk limited at K2. (Assumes Call Ratio Backspread: Sell K1, Buy 2 K2)."},"Bull Call Spread":{maxRiskFormula:"netDebit * M",maxGainFormula:"(K2 - K1 - netDebit) * M",explanation:"Limited risk, limited reward bullish spread. (Buy K1, Sell K2)"},"Bull Put Ladder":{maxRiskFormula:"∞",maxGainFormula:"(K2 - K1 + netCredit) * M",explanation:"Unlimited downside risk; max gain at K1. (Assumes Put Ratio Spread: Buy K1, Sell 2 K2)."},"Bull Put Spread":{maxRiskFormula:"(K2 - K1 - netCredit) * M",maxGainFormula:"netCredit * M",explanation:"Defined-risk bullish spread. (Sell K2, Buy K1)"},"Calendar Call Spread":{maxRiskFormula:"netDebit * M",maxGainFormula:"Variable, typically near short strike at expiry",explanation:"Limited loss; profit depends on volatility and timing."},"Calendar Put Spread":{maxRiskFormula:"netDebit * M",maxGainFormula:"Variable, near short strike at expiry",explanation:"Neutral to bearish position with limited loss."},"Calendar Straddle":{maxRiskFormula:"netDebit * M",maxGainFormula:"Variable, peaks when stock stays near middle strike",explanation:"Limited loss; profit from time decay and volatility."},"Calendar Strangle":{maxRiskFormula:"netDebit * M",maxGainFormula:"Variable; profit from time decay",explanation:"Limited loss; profit depends on implied volatility."},"Call Broken Wing":{maxRiskFormula:"netDebit * M",maxGainFormula:"(K2 - K1 - netDebit) * M",explanation:"Variant of butterfly; formulas shown for standard Long Call Butterfly."},"Call Ratio Backspread":{maxRiskFormula:"(K2 - K1 - netCredit) * M",maxGainFormula:"∞",explanation:"Unlimited upside profit; limited downside loss. (Assumes net credit)."},"Call Ratio Spread":{maxRiskFormula:"∞",maxGainFormula:"(K2 - K1 + netCredit) * M",explanation:"Neutral to slightly bearish; unlimited risk, limited gain. (Assumes net credit)."},"Cash-Secured Put":{maxRiskFormula:"(K - netCredit) * M",maxGainFormula:"netCredit * M",explanation:"Limited profit (premium); risk if assigned and stock drops."},Collar:{maxRiskFormula:"(S_0 - K_put + netDebit) * M",maxGainFormula:"(K_call - S_0 - netDebit) * M",explanation:"Stock-protection strategy with capped loss and gain. (Assumes net debit)."},"Covered Call":{maxRiskFormula:"(S_0 - netCredit) * M",maxGainFormula:"(K_call - S_0 + netCredit) * M",explanation:"Income from premium; capped upside. (Own stock at S_0)."},"Covered Put":{maxRiskFormula:"∞",maxGainFormula:"(S_0 - K_put + netCredit) * M",explanation:"Unlimited risk if stock rises. (Short stock at S_0)."},"Covered Short Straddle":{maxRiskFormula:"∞",maxGainFormula:"(S_0 - K + netCredit) * M",explanation:"Unlimited risk if stock rises. (Assumes Short Stock @ S_0 + Short Straddle @ K)."},"Covered Short Strangle":{maxRiskFormula:"∞",maxGainFormula:"(S_0 - K1 + netCredit) * M",explanation:"Unlimited risk if stock rises. (Assumes Short Stock @ S_0 + Short Strangle @ K1/K2)."},"Diagonal Call Spread":{maxRiskFormula:"netDebit * M",maxGainFormula:"Variable near short strike",explanation:"Limited loss; profit from time and direction."},"Diagonal Put Spread":{maxRiskFormula:"netDebit * M",maxGainFormula:"Variable near short strike",explanation:"Limited risk and profit potential."},"Double Diagonal":{maxRiskFormula:"netDebit * M",maxGainFormula:"Variable near short strikes",explanation:"Limited loss, volatility-driven profit."},Guts:{maxRiskFormula:"(netDebit - (K2 - K1)) * M",maxGainFormula:"∞",explanation:"Buy ITM call (K1) and ITM put (K2). Max loss between strikes."},"Inverse Call Broken Wing":{maxRiskFormula:"(K2 - K1 - netCredit) * M",maxGainFormula:"netCredit * M",explanation:"Same as Short Call Butterfly. Limited loss and gain."},"Inverse Iron Butterfly":{maxRiskFormula:"netDebit * M",maxGainFormula:"(K2 - K1 - netDebit) * M",explanation:"Same as Long Iron Butterfly. Profit peaks at middle strike."},"Inverse Iron Condor":{maxRiskFormula:"netDebit * M",maxGainFormula:"(K2 - K1 - netDebit) * M",explanation:"Same as Long Iron Condor. Profit between middle strikes."},"Inverse Put Broken Wing":{maxRiskFormula:"(K2 - K1 - netCredit) * M",maxGainFormula:"netCredit * M",explanation:"Same as Short Put Butterfly. Limited loss and gain."},"Iron Albatross":{maxRiskFormula:"(D_spread - netCredit) * M",maxGainFormula:"netCredit * M",explanation:"Wide iron condor variant; low reward and risk."},"Iron Butterfly":{maxRiskFormula:"(K2 - K1 - netCredit) * M",maxGainFormula:"netCredit * M",explanation:"Limited loss and gain; centered around middle strike."},"Iron Condor":{maxRiskFormula:"(D_spread - netCredit) * M",maxGainFormula:"netCredit * M",explanation:"Limited risk, limited profit neutral strategy."},"Jade Lizard":{maxRiskFormula:"∞",maxGainFormula:"netCredit * M",explanation:"Credit strategy with unlimited downside risk from the naked put."},"Long Call":{maxRiskFormula:"netDebit * M",maxGainFormula:"∞",explanation:"Simple bullish bet; risk limited to premium."},"Long Call Butterfly":{maxRiskFormula:"netDebit * M",maxGainFormula:"(K2 - K1 - netDebit) * M",explanation:"Profit near middle strike; limited loss."},"Long Call Condor":{maxRiskFormula:"netDebit * M",maxGainFormula:"(K2 - K1 - netDebit) * M",explanation:"Profit between middle strikes (K2, K3); limited risk."},"Long Put":{maxRiskFormula:"netDebit * M",maxGainFormula:"(K - netDebit) * M",explanation:"Bearish position with limited loss, large potential gain."},"Long Put Butterfly":{maxRiskFormula:"netDebit * M",maxGainFormula:"(K2 - K1 - netDebit) * M",explanation:"Limited loss, profit near center strike."},"Long Put Condor":{maxRiskFormula:"netDebit * M",maxGainFormula:"(K2 - K1 - netDebit) * M",explanation:"Limited loss; profit between middle strikes."},"Long Straddle":{maxRiskFormula:"netDebit * M",maxGainFormula:"∞",explanation:"Volatility play; loss limited to premium."},"Long Strangle":{maxRiskFormula:"netDebit * M",maxGainFormula:"∞",explanation:"Profit if price moves far in either direction."},"Poor Man's Covered Call":{maxRiskFormula:"netDebit * M",maxGainFormula:"(K2 - K1 - netDebit) * M",explanation:"Synthetic covered call with defined risk. (Buy long-term K1, Sell short-term K2)."},"Protective Put":{maxRiskFormula:"(S_0 - K_put + netDebit) * M",maxGainFormula:"∞",explanation:"Downside protection for owned stock (at S_0) with unlimited upside."},"Put Broken Wing":{maxRiskFormula:"netDebit * M",maxGainFormula:"(K2 - K1 - netDebit) * M",explanation:"Variant of butterfly; formulas shown for standard Long Put Butterfly."},"Put Ratio Backspread":{maxRiskFormula:"(K2 - K1 - netCredit) * M",maxGainFormula:"∞",explanation:"Unlimited profit if price falls sharply. (Assumes net credit)."},"Put Ratio Spread":{maxRiskFormula:"∞",maxGainFormula:"(K2 - K1 + netCredit) * M",explanation:"Unlimited downside risk; limited profit. (Assumes net credit)."},"Reverse Jade Lizard":{maxRiskFormula:"netDebit * M",maxGainFormula:"∞",explanation:"Debit strategy with unlimited profit potential (long put + bull call spread)."},"Short Call":{maxRiskFormula:"∞",maxGainFormula:"netCredit * M",explanation:"Unlimited risk on upside; income from premium."},"Short Call Butterfly":{maxRiskFormula:"(K2 - K1 - netCredit) * M",maxGainFormula:"netCredit * M",explanation:"Reverse butterfly with limited loss and gain."},"Short Call Condor":{maxRiskFormula:"(D_spread - netCredit) * M",maxGainFormula:"netCredit * M",explanation:"Limited loss and gain. (e.g., Sell K1, Buy K2, Buy K3, Sell K4)."},"Short Guts":{maxRiskFormula:"∞",maxGainFormula:"(netCredit - (K2 - K1)) * M",explanation:"Unlimited risk, limited reward between strikes. (Sell ITM K1 Call, Sell ITM K2 Put)."},"Short Put":{maxRiskFormula:"(K - netCredit) * M",maxGainFormula:"netCredit * M",explanation:"Income from selling put; risk if stock drops."},"Short Put Butterfly":{maxRiskFormula:"(K2 - K1 - netCredit) * M",maxGainFormula:"netCredit * M",explanation:"Limited loss and gain."},"Short Put Condor":{maxRiskFormula:"(D_spread - netCredit) * M",maxGainFormula:"netCredit * M",explanation:"Limited loss and profit; neutral strategy."},"Short Straddle":{maxRiskFormula:"∞",maxGainFormula:"netCredit * M",explanation:"Unlimited risk on both sides."},"Short Strangle":{maxRiskFormula:"∞",maxGainFormula:"netCredit * M",explanation:"Unlimited loss; limited gain from credit."},Strap:{maxRiskFormula:"netDebit * M",maxGainFormula:"∞",explanation:"Bullish volatility play (Buy 2 Calls, Buy 1 Put); loss limited to premium."},Strip:{maxRiskFormula:"netDebit * M",maxGainFormula:"∞",explanation:"Bearish volatility play (Buy 1 Call, Buy 2 Puts); limited loss."},"Synthetic Long Stock":{maxRiskFormula:"∞",maxGainFormula:"∞",explanation:"Replicates long stock (Buy Call, Sell Put); unlimited gain and loss."},"Synthetic Short Stock":{maxRiskFormula:"∞",maxGainFormula:"∞",explanation:"Replicates short stock (Sell Call, Buy Put); unlimited risk both ways."},"Synthetic Put":{maxRiskFormula:"(K_call - S_0 + netDebit) * M",maxGainFormula:"(S_0 - netDebit) * M",explanation:"Replicates a long put (Short Stock at S_0, Buy Call at K_call)."},Wheel:{maxRiskFormula:"(K_put - netCredit) * M",maxGainFormula:"netCredit * M",explanation:"Multi-step strategy. Formulas shown are for Step 1 (selling the put)."}}}),this.formulaDataCache}buildFormulaTooltipContent(e,t){if(!e||!t)return null;const i=this.getStrategyDisplayName(e.strategy||""),r=this.getFormulaData().strategies[i];if(!r)return null;const a=this.summarizeLegs(e.legs||[]),s=this.buildRiskFormulaContext(e,a);return"maxRisk"===t?this.buildMaxRiskTooltip(i,r,s,e):"pl"===t?this.buildPLTooltip(e,a,s):null}buildMaxRiskTooltip(e,t,i,r){const a=[],s=this.getFormulaData();a.push('<div class="formula-tooltip__title">'),a.push(`<span class="formula-tooltip__strategy">${this.escapeHtml(e)}</span>`),a.push("Max Risk"),a.push("</div>"),t.explanation&&(a.push('<div class="formula-tooltip__section">'),a.push(`<div class="formula-tooltip__explanation">${this.escapeHtml(t.explanation)}</div>`),a.push("</div>")),a.push('<div class="formula-tooltip__section">'),a.push('<div class="formula-tooltip__label">Formula</div>'),a.push(`<div class="formula-tooltip__formula">${this.escapeHtml(t.maxRiskFormula)}</div>`),a.push("</div>");const n=this.buildVariablesWithExplanations(i,s,r);return n.length>0&&(a.push('<div class="formula-tooltip__section">'),a.push('<div class="formula-tooltip__label">Calculation</div>'),a.push('<div class="formula-tooltip__variables">'),n.forEach(e=>{a.push('<div class="formula-tooltip__variable">'),a.push(`<span class="formula-tooltip__variable-name">${this.escapeHtml(e.displayName)}</span>`),a.push(`<span class="formula-tooltip__variable-value">${this.escapeHtml(e.value)}</span>`),a.push("</div>")}),a.push("</div>"),a.push("</div>")),a.join("")}buildPLTooltip(e,t,i){const r=[];this.getFormulaData();r.push('<div class="formula-tooltip__title">'),r.push("P&L Calculation"),r.push("</div>");Number(e.pl);!this.isClosedStatus(e.status)&&(r.push('<div class="formula-tooltip__section">'),r.push('<div class="formula-tooltip__explanation">This position is currently open. P&L shown is unrealized.</div>'),r.push("</div>")),r.push('<div class="formula-tooltip__section">'),r.push('<div class="formula-tooltip__label">Formula</div>'),r.push('<div class="formula-tooltip__formula">P&L = Total Credits - Total Debits - Fees</div>'),r.push("</div>");const a=this.buildPLVariables(e,t);return a.length>0&&(r.push('<div class="formula-tooltip__section">'),r.push('<div class="formula-tooltip__label">Calculation</div>'),r.push('<div class="formula-tooltip__variables">'),a.forEach(e=>{r.push('<div class="formula-tooltip__variable">'),r.push(`<span class="formula-tooltip__variable-name">${this.escapeHtml(e.displayName)}</span>`),r.push(`<span class="formula-tooltip__variable-value">${this.escapeHtml(e.value)}</span>`),r.push("</div>")}),r.push("</div>"),r.push("</div>")),r.join("")}buildVariablesWithExplanations(e,t,i){const r=[],a=t.variableExplanations,s=Number(i.maxRisk);if(e.S){const t=a.S_0||"Underlying stock price at entry";r.push({displayName:`${t} (S_0)`,value:`$${e.S.toFixed(2)}`})}if([{contextKey:"K",formulaKey:"K",shouldShow:()=>e.K&&!e.K1},{contextKey:"K1",formulaKey:"K1"},{contextKey:"K2",formulaKey:"K2"},{contextKey:"K3",formulaKey:"K3"},{contextKey:"K4",formulaKey:"K4"},{contextKey:"shortPutStrike",formulaKey:"K_put",shouldShow:()=>e.shortPutStrike&&!e.K1},{contextKey:"longPutStrike",formulaKey:"K_put",shouldShow:()=>e.longPutStrike&&!e.K1&&!e.shortPutStrike},{contextKey:"shortCallStrike",formulaKey:"K_call",shouldShow:()=>e.shortCallStrike&&!e.K1},{contextKey:"longCallStrike",formulaKey:"K_call",shouldShow:()=>e.longCallStrike&&!e.K1&&!e.shortCallStrike}].forEach(t=>{const i=e[t.contextKey];if(i&&Number.isFinite(i)){if(!t.shouldShow||t.shouldShow()){const e=a[t.formulaKey]||"Strike price";r.some(e=>e.displayName.includes(t.formulaKey))||r.push({displayName:`${e} (${t.formulaKey})`,value:`$${i.toFixed(2)}`})}}}),e.K1&&e.K2){const t=Math.abs(e.K2-e.K1),i=a.D_spread||"Distance between strikes";r.push({displayName:`${i} (D_spread)`,value:`$${t.toFixed(2)}`})}else if(e.defaultWidth&&Number.isFinite(e.defaultWidth)){const t=a.D_spread||"Distance between strikes";r.push({displayName:`${t} (D_spread)`,value:`$${e.defaultWidth.toFixed(2)}`})}if(e.netCredit&&e.netCredit>0){const t=a.netCredit||"Net credit received";r.push({displayName:`${t} (netCredit)`,value:`$${e.netCredit.toFixed(2)}`})}if(e.netDebit&&e.netDebit>0){const t=a.netDebit||"Net debit paid";r.push({displayName:`${t} (netDebit)`,value:`$${e.netDebit.toFixed(2)}`})}if(e.contractValue){const t=a.M||"Contract multiplier",i=e.multiplier||100,s=e.contracts||1;r.push({displayName:`${t} (M)`,value:`${i} × ${s} = ${e.contractValue}`})}return!i.riskIsUnlimited&&Number.isFinite(s)&&s>0?r.push({displayName:"Max Risk (Result)",value:`$${s.toFixed(2)}`}):(i.riskIsUnlimited||s===Number.POSITIVE_INFINITY)&&r.push({displayName:"Max Risk (Result)",value:"∞ (Unlimited)"}),r}buildPLVariables(e,t){const i=[];t&&Number.isFinite(t.totalCredit)&&i.push({displayName:"Total Credits",value:`$${t.totalCredit.toFixed(2)}`}),t&&Number.isFinite(t.totalDebit)&&i.push({displayName:"Total Debits",value:`$${t.totalDebit.toFixed(2)}`}),t&&Number.isFinite(t.totalFees)&&i.push({displayName:"Fees",value:`$${t.totalFees.toFixed(2)}`});const r=Number(e.pl);return Number.isFinite(r)&&i.push({displayName:"P&L (Result)",value:`$${r.toFixed(2)}`}),i}escapeHtml(e){return this.escapeHTML(e)}createFormulaIcon(e,t){const i=document.createElement("span");i.className="formula-value-wrapper";const r=document.createElement("span");r.className="formula-info-icon",r.textContent="i",r.setAttribute("aria-label",`View ${"maxRisk"===t?"max risk":"P&L"} calculation`);const a=document.createElement("div");a.className="formula-tooltip",a.setAttribute("role","tooltip");const s=this.buildFormulaTooltipContent(e,t);if(s){a.innerHTML=s,i.appendChild(r),i.appendChild(a),i.addEventListener("mouseenter",e=>{this.positionFormulaTooltip(i,a)});const e=()=>{i.matches(":hover")&&this.positionFormulaTooltip(i,a)};return window.addEventListener("scroll",e,{passive:!0}),i.addEventListener("mouseleave",()=>{window.removeEventListener("scroll",e)},{once:!0}),i}return null}positionFormulaTooltip(e,t){if(!e||!t)return;const i=e.getBoundingClientRect(),r=t.getBoundingClientRect(),a=(window.innerHeight,window.innerWidth);let s=i.top-r.height-12,n=i.left+i.width/2-r.width/2;s<10&&(s=i.bottom+12),n<10?n=10:n+r.width>a-10&&(n=a-r.width-10),t.style.top=`${s}px`,t.style.left=`${n}px`}getLegsContainer(){return document.getElementById("trade-legs-container")}generateLegId(e=0){return`${this.currentEditingId||"NEW"}-LEG-${Date.now().toString(36)}-${e}-${Math.random().toString(36).slice(2,6)}`}clearLegFormRows(){const e=this.getLegsContainer();e&&(e.innerHTML="")}getSelectedUnderlyingType({fallback:e="Stock"}={}){const t=document.getElementById("underlyingType");return this.normalizeUnderlyingType(t?.value,{fallback:e})}getDefaultMultiplierForLegType(e,t="Stock"){const i=this.normalizeLegType(e||"CALL");if("STOCK"===i||"CASH"===i)return 1;this.normalizeUnderlyingType(t,{fallback:"Stock"});return 100}syncLegMultiplierVisibility(e,{defaultMultiplier:t=null}={}){if(!e)return;const i=e.querySelector('[data-leg-group="multiplier"]'),r=e.querySelector('[data-leg-field="multiplier"]'),a=e.querySelector(".trade-leg__multiplier-toggle"),s=e.querySelector('[data-leg-field="type"]');if(!(i&&r&&a&&s))return;const n=this.getSelectedUnderlyingType({fallback:"Stock"}),o=this.normalizeLegType(s.value||"CALL"),l=Number.isFinite(t)?t:this.getDefaultMultiplierForLegType(o,n),c=Number(r.value),d=Number.isFinite(c)&&c>0&&c!==l;if(e.classList.contains("trade-leg--multiplier-open"))return i.classList.remove("is-hidden"),void(a.textContent="Hide multiplier");i.classList.toggle("is-hidden",!d),a.textContent=d?"Hide multiplier":"Override multiplier"}applyUnderlyingTypeToLegMultipliers({row:e=null,force:t=!1}={}){const i=this.getLegsContainer();if(!i)return;const r=e?[e]:Array.from(i.querySelectorAll(".trade-leg"));if(!r.length)return;const a=this.getSelectedUnderlyingType({fallback:"Stock"});r.forEach(e=>{const i=e.querySelector('[data-leg-field="type"]'),r=e.querySelector('[data-leg-field="multiplier"]');if(!i||!r)return;const s=this.getDefaultMultiplierForLegType(i.value||"CALL",a),n=Number(r.value),o=e.classList.contains("trade-leg--multiplier-open");if(t||!Number.isFinite(n)||n<=0)r.value=s;else if(!o){0===n&&(r.value=s)}this.syncLegMultiplierVisibility(e,{defaultMultiplier:s})})}renderLegForms(e=[]){this.getLegsContainer()&&(this.clearLegFormRows(),Array.isArray(e)&&e.length>0?e.forEach(e=>this.addLegFormRow(e)):this.addLegFormRow(),this.updateLegRowNumbers(),this.applyUnderlyingTypeToLegMultipliers({force:!Array.isArray(e)||0===e.length}))}addLegFormRow(e=null){const t=this.getLegsContainer();if(!t)return null;const i=document.createElement("div");i.className="trade-leg";const r=t.querySelectorAll(".trade-leg").length,a=e?.id||this.generateLegId(r);i.dataset.legId=a,i.innerHTML='\n            <div class="trade-leg__header">\n                <span class="trade-leg__title" data-leg-label></span>\n                <button type="button" class="btn btn--sm btn--secondary trade-leg__remove">Remove Leg</button>\n            </div>\n            <div class="form-row">\n                <div class="form-group">\n                    <label class="form-label">Action</label>\n                    <select class="form-control" data-leg-field="orderType">\n                        <option value="BTO">BTO (Buy to Open)</option>\n                        <option value="STO">STO (Sell to Open)</option>\n                        <option value="BTC">BTC (Buy to Close)</option>\n                        <option value="STC">STC (Sell to Close)</option>\n                    </select>\n                </div>\n            </div>\n            <div class="form-row">\n                <div class="form-group">\n                    <label class="form-label">Instrument</label>\n                    <select class="form-control" data-leg-field="type">\n                        <option value="CALL">Call</option>\n                        <option value="PUT">Put</option>\n                        <option value="STOCK">Stock</option>\n                    </select>\n                </div>\n                <div class="form-group">\n                    <label class="form-label">Quantity</label>\n                    <input type="number" class="form-control" data-leg-field="quantity" min="0" step="1">\n                </div>\n            </div>\n            <div class="form-row">\n                <div class="form-group">\n                    <label class="form-label">Entry Date</label>\n                    <input type="date" class="form-control" data-leg-field="executionDate">\n                </div>\n                <div class="form-group">\n                    <label class="form-label">Expiration Date</label>\n                    <input type="date" class="form-control" data-leg-field="expirationDate">\n                </div>\n            </div>\n            <div class="form-row">\n                <div class="form-group">\n                    <label class="form-label">Strike</label>\n                    <input type="number" class="form-control" data-leg-field="strike" step="0.01">\n                </div>\n                <div class="form-group">\n                    <label class="form-label">Premium (per share)</label>\n                    <input type="number" class="form-control" data-leg-field="premium" step="0.000001" min="0">\n                </div>\n            </div>\n            <div class="form-row">\n                <div class="form-group">\n                    <label class="form-label">Fees</label>\n                    <input type="number" class="form-control" data-leg-field="fees" step="0.0000001">\n                </div>\n                <div class="form-group is-hidden" data-leg-group="multiplier">\n                    <label class="form-label">Multiplier</label>\n                    <input type="number" class="form-control" data-leg-field="multiplier" step="1" min="1">\n                    <span class="form-help-text">Used to scale option premiums (100 for standard contracts, 1 for stock).</span>\n                </div>\n            </div>\n            <div class="form-row trade-leg__multiplier-row">\n                <div class="form-group">\n                    <button type="button" class="btn btn--sm btn--secondary trade-leg__multiplier-toggle">Override multiplier</button>\n                    <span class="form-help-text">Hidden by default - standard contracts use 100, stock legs use 1.</span>\n                </div>\n            </div>\n            <div class="form-row">\n                <div class="form-group">\n                    <label class="form-label">Entry Underlying Price</label>\n                    <input type="number" class="form-control" data-leg-field="underlyingPrice" step="0.01" min="0">\n                </div>\n            </div>\n        ';const s=i.querySelector('[data-leg-field="orderType"]'),n=this.normalizeLegOrderType(e?.orderType||e?.tradeType||e?.order||this.deriveOrderTypeFromActionSide(e?.action,e?.side));s&&(s.value=n);const o=i.querySelector('[data-leg-field="type"]'),l=this.normalizeLegType(e?.type||"CALL");o&&(o.value=l,o.addEventListener("change",()=>{this.applyUnderlyingTypeToLegMultipliers({row:i,force:!0})}));const c=this.getSelectedUnderlyingType({fallback:"Stock"}),d=this.normalizeUnderlyingType(e?.underlyingType,{fallback:c}),u=i.querySelector('[data-leg-field="quantity"]');u&&(e&&Number.isFinite(Number(e.quantity))?u.value=Math.abs(Number(e.quantity)):u.value=1);const m=i.querySelector('[data-leg-field="executionDate"]');m&&(m.value=e?.executionDate||"");const h=i.querySelector('[data-leg-field="expirationDate"]');h&&(h.value=e?.expirationDate||"");const p=i.querySelector('[data-leg-field="strike"]');p&&(p.value=Number.isFinite(Number(e?.strike))?Number(e.strike):"");const g=i.querySelector('[data-leg-field="premium"]');g&&(g.value=Number.isFinite(Number(e?.premium))?Number(e.premium):"");const y=i.querySelector('[data-leg-field="fees"]');y&&(y.value=Number.isFinite(Number(e?.fees))?Number(e.fees):"");const f=i.querySelector('[data-leg-field="multiplier"]');if(f){const t=Number.isFinite(Number(e?.multiplier))&&Number(e.multiplier)>0?Number(e.multiplier):this.getDefaultMultiplierForLegType(l,d);f.value=t,["change","input"].forEach(e=>{f.addEventListener(e,()=>{this.syncLegMultiplierVisibility(i)})})}const b=i.querySelector(".trade-leg__multiplier-toggle");b&&b.addEventListener("click",e=>{e.preventDefault();i.classList.toggle("trade-leg--multiplier-open")||this.applyUnderlyingTypeToLegMultipliers({row:i,force:!1}),this.syncLegMultiplierVisibility(i)});const C=i.querySelector('[data-leg-field="underlyingPrice"]');C&&(C.value=Number.isFinite(Number(e?.underlyingPrice))?Number(e.underlyingPrice):"");const S=i.querySelector(".trade-leg__remove");return S&&S.addEventListener("click",()=>{this.removeLegFormRow(i)}),t.appendChild(i),this.applyUnderlyingTypeToLegMultipliers({row:i,force:!e}),this.syncLegMultiplierVisibility(i),this.updateLegRowNumbers(),i}removeLegFormRow(e){const t=this.getLegsContainer();t&&e&&(t.removeChild(e),0===t.children.length?this.addLegFormRow():(this.updateLegRowNumbers(),this.applyUnderlyingTypeToLegMultipliers({force:!1})))}updateLegRowNumbers(){const e=this.getLegsContainer();e&&Array.from(e.querySelectorAll(".trade-leg")).forEach((t,i)=>{const r=t.querySelector("[data-leg-label]");r&&(r.textContent=`Leg ${i+1}`);const a=t.querySelector(".trade-leg__remove");a&&(a.disabled=1===e.children.length)})}collectLegsFromForm(){const e=this.getLegsContainer();if(!e)return[];const t=Array.from(e.querySelectorAll(".trade-leg"));if(0===t.length)return[];const i=[],r=[],a=this.getSelectedUnderlyingType({fallback:"Stock"});return t.forEach((e,t)=>{const s=t=>{const i=e.querySelector(`[data-leg-field="${t}"]`);return i?i.value:""},n=this.normalizeLegOrderType(s("orderType")||"BTO"),o=this.normalizeLegType(s("type")||"CALL"),l=s("quantity"),c=this.parseInteger(l,null,{allowNegative:!1});if(!Number.isFinite(c)||c<=0)return void r.push(`Leg ${t+1} must have a quantity greater than 0.`);const d=s("multiplier"),u=this.parseInteger(d,null,{allowNegative:!1}),m=Number.isFinite(u)&&u>0?u:this.getDefaultMultiplierForLegType(o,a),h=s("strike"),p=this.parseDecimal(h,null,{allowNegative:!1}),g=s("premium"),y=this.parseDecimal(g,0,{allowNegative:!1}),f=s("fees"),b=this.parseDecimal(f,0,{allowNegative:!0}),C=s("underlyingPrice"),S=this.parseDecimal(C,null,{allowNegative:!1}),T=s("executionDate")||"",L=s("expirationDate")||"",x={id:e.dataset.legId||this.generateLegId(t),orderType:n,type:o,quantity:c,multiplier:m,executionDate:T,expirationDate:L,strike:p,premium:y,fees:b,underlyingPrice:S,underlyingType:a};i.push(x)}),r.length>0?(this.showNotification(r.join("\n"),"error"),null):i}getPrimaryLeg(e={}){if(e.primaryLeg&&e.primaryLeg.id)return this.normalizeLeg(e.primaryLeg);if(Array.isArray(e.legs)&&e.legs.length>0){const t=e.legs.map((e,t)=>this.normalizeLeg(e,t));return t.find(e=>"OPEN"===this.getLegSide(e))||t[0]}return null}deriveTradeTypeFromLeg(e){if(!e)return"BTO";const t=this.getLegAction(e),i=this.getLegSide(e);return"BUY"===t&&"OPEN"===i?"BTO":"SELL"===t&&"OPEN"===i?"STO":"SELL"===t&&"CLOSE"===i?"STC":"BUY"===t&&"CLOSE"===i?"BTC":"SELL"===t?"STO":"BTO"}deriveTradeDirectionFromLeg(e){if(!e)return"long";return"SELL"===this.getLegAction(e)?"short":"long"}getTradeType(e){const t=this.getPrimaryLeg(e);return this.deriveTradeTypeFromLeg(t)}inferTradeDirection(e){const t=this.getPrimaryLeg(e);return this.deriveTradeDirectionFromLeg(t)}normalizeStatus(e){return(e||"").toString().trim().toLowerCase()}normalizeTradeStatusInput(e){const t=(e||"").toString().trim().toLowerCase();return t?"open"===t?"Open":"closed"===t?"Closed":"expired"===t?"Expired":"assigned"===t?"Assigned":"rolling"===t||"rolled"===t?"Rolling":"":""}isClosedStatus(e){const t=this.normalizeStatus(e);return"closed"===t||"expired"===t}isAssignedStatus(e){return"assigned"===this.normalizeStatus(e)}isActiveStatus(e){const t=this.normalizeStatus(e);return"open"===t||"rolling"===t}isAssignmentReason(e){return(e||"").toString().trim().toLowerCase().includes("assign")}getDisplayStatus(e){if(!e)return"Unknown";const t=(e.status||"Unknown").toString().trim();if(!t)return"Unknown";const i=t.toLowerCase();return"closed"===i&&this.isAssignmentReason(e.exitReason)||"assigned"===i?"Assigned":"expired"===i?"Expired":"rolling"===i?"Rolling":t}calculateDTE(e,t){let i=this.parseDateValue(e);if(!i&&this.isPmccTrade(t)){const e=this.parseDateValue(t?.pmccShortExpiration);e&&(i=e)}if(!i)return 0;if(this.isClosedStatus(t.status))return 0;const r=i.getTime()-this.currentDate.getTime();if(!Number.isFinite(r))return 0;const a=Math.ceil(r/864e5);return Math.max(0,a)}calculatePL(e){if(!e)return 0;const t=this.summarizeLegs(e.legs||[]),i=Number.isFinite(Number(e.cashFlow))?Number(e.cashFlow):Number(t.cashFlow);return Number.isFinite(i)?parseFloat(i.toFixed(2)):0}calculateROI(e){const t=this.calculatePL(e),i=this.getCapitalAtRisk(e);if(!(i>0))return 0;const r=t/i*100;return Number.isFinite(r)?parseFloat(r.toFixed(2)):0}calculateDaysHeld(e){if(!e)return 0;const t=this.parseDateValue(e.entryDate||e.openedDate);if(!t)return 0;const i=this.parseDateValue(e.exitDate||e.closedDate),r=(this.isClosedStatus(e.status)&&i?i:this.currentDate).getTime()-t.getTime();if(!Number.isFinite(r)||r<0)return 0;const a=Math.ceil(r/864e5);return Math.max(1,a)}calculateMaxRisk(e){if(!e)return 0;const t=Number(e.maxRiskOverride);if(Number.isFinite(t)&&t>0)return t;const i=this.summarizeLegs(e.legs||[]),r=this.computeMaxRiskUsingFormula(e,i);if(r===Number.POSITIVE_INFINITY)return Number.POSITIVE_INFINITY;if(Number.isFinite(r)&&r>0)return r;const a=Number(e.capitalAtRisk);if(a===Number.POSITIVE_INFINITY)return Number.POSITIVE_INFINITY;if(Number.isFinite(a)&&a>0)return a;const s=Number(e.maxRisk);return s===Number.POSITIVE_INFINITY?Number.POSITIVE_INFINITY:Number.isFinite(s)&&s>0?s:0}getCapitalAtRisk(e){if(!e)return 0;const t=Number(e.maxRiskOverride);if(Number.isFinite(t)&&t>0)return t;const i=this.summarizeLegs(e.legs||[]),r=this.computeMaxRiskUsingFormula(e,i);if(r===Number.POSITIVE_INFINITY)return Number.POSITIVE_INFINITY;if(Number.isFinite(r)&&r>0)return r;const a=Number(e.capitalAtRisk);if(a===Number.POSITIVE_INFINITY)return Number.POSITIVE_INFINITY;if(Number.isFinite(a)&&a>0)return a;const s=Number(e.maxRisk);return s===Number.POSITIVE_INFINITY?Number.POSITIVE_INFINITY:Number.isFinite(s)&&s>0?s:0}calculateAnnualizedROI(e){if(!e||!this.isClosedStatus(e.status))return 0;const t=Number.isFinite(Number(e.roi))?Number(e.roi):this.calculateROI(e);if(!Number.isFinite(t))return 0;const i=Number(e.daysHeld)||this.calculateDaysHeld(e)||0,r=365*t/Math.max(1,i);return Number.isFinite(r)?parseFloat(r.toFixed(2)):0}buildLegLifecycleKey(e={}){const t=this.normalizeLegType(e.type),i=Number(e.strike);return`${t}|${Number.isFinite(i)?i.toFixed(4):"NA"}|${(e.expirationDate||"").toString()}|${this.getLegMultiplier(e)||1}`}getNormalizedLegOrderType(e={}){const t=e.orderType||e.tradeType||e.order,i=this.normalizeLegOrderType(t);if(i)return i;const{action:r,side:a}=this.getLegOrderDescriptor(e);return this.normalizeLegOrderType(this.deriveOrderTypeFromActionSide(r,a))}determineTradeLifecycleStatus(e={},t={}){const i=Array.isArray(t?.legs)?t.legs:[],r={status:"Open",exitReason:null,effectiveClosedDate:null,openContractsOverride:void 0,meta:{matchedPairs:!1,unmatchedExposure:0,expirationPassed:!1,hasRollLegs:!1,hasCloseActivity:!1,hasAssignmentEvent:!1,hasExpirationEvent:!1}};if(0===i.length)return r.meta.matchedPairs=!0,r;const a=new Map;let s=!1,n=!1,o=!1,l=!1;i.forEach(e=>{const t=Math.abs(Number(e.quantity)||0);if(!t)return;const i=this.buildLegLifecycleKey(e);a.has(i)||a.set(i,{longOpen:0,longClose:0,shortOpen:0,shortClose:0});const r=a.get(i);switch(this.getNormalizedLegOrderType(e)){case"BTO":r.longOpen+=t;break;case"STC":r.longClose+=t,n=!0;break;case"STO":r.shortOpen+=t;break;case"BTC":r.shortClose+=t,n=!0}const c=(e.orderType||e.tradeType||e.order||"").toString().toUpperCase();c.includes("ROLL")&&(s=!0),c.includes("ASSIGN")&&(o=!0),(c.includes("EXPIRE")||c.includes("EXPIRY"))&&(l=!0)});let c=!0,d=0;a.forEach(e=>{const t=Math.abs(e.longOpen-e.longClose),i=Math.abs(e.shortOpen-e.shortClose);(t>0||i>0)&&(c=!1),d+=t+i});const u=this.parseDateValue(e.expirationDate||t.latestExpiration),m=this.currentDate instanceof Date?this.currentDate:new Date,h=u?new Date(Date.UTC(u.getUTCFullYear(),u.getUTCMonth(),u.getUTCDate(),21,0,0)):null,p=!!h&&m.getTime()>h.getTime(),g=t.closedDate instanceof Date?t.closedDate:this.parseDateValue(e.closedDate||e.exitDate),y=!!(p&&g&&u)&&g.getTime()>=u.getTime();r.meta={matchedPairs:c,unmatchedExposure:d,expirationPassed:p,hasRollLegs:s,hasCloseActivity:n,hasAssignmentEvent:o,hasExpirationEvent:l,activityAfterExpiration:y};const f=this.normalizeStatus(e.status);return!o&&this.isAssignmentTrade(e)&&(o=!0),o?(r.status="Assigned",r.exitReason=e.exitReason||"Assigned",r.openContractsOverride=0,!r.effectiveClosedDate&&g&&(r.effectiveClosedDate=g.toISOString().slice(0,10)),r):c||0===d?(r.status="Closed",l&&!e.exitReason&&(r.exitReason="Expired OTM"),r.openContractsOverride=0,!r.effectiveClosedDate&&g&&(r.effectiveClosedDate=g.toISOString().slice(0,10)),r):p&&!o?(r.status="Expired",e.exitReason||(r.exitReason="Expired OTM"),r.openContractsOverride=0,u&&(r.effectiveClosedDate=u.toISOString().slice(0,10)),r):s||n&&d>0?(r.status="Rolling",r):y&&!o?(r.status="Closed",e.exitReason||(r.exitReason="Closed post-expiration"),r.openContractsOverride=0,g&&(r.effectiveClosedDate=g.toISOString().slice(0,10)),r):"expired"===f&&u?(r.status="Expired",r.openContractsOverride=0,e.exitReason||(r.exitReason="Expired OTM"),r.effectiveClosedDate||(r.effectiveClosedDate=u.toISOString().slice(0,10)),r):(r.status="Open",r)}enrichTradeData(e){const t={...e};delete t.optionType;const i=(t.strategy||"").toString().trim();t.strategy=this.getStrategyDisplayName(i),t.underlyingType=this.normalizeUnderlyingType(e.underlyingType,{fallback:"Stock"});const r=this.summarizeLegs(t.legs);t.legs=r.legs,t.legsCount=r.legsCount,t.openContracts=Math.max(0,r.openContracts-r.closeContracts),t.closeContracts=r.closeContracts,t.openLegs=Math.max(0,r.openLegs-r.closeLegs),t.rollLegs=r.rollLegs,t.totalFees=Number(r.totalFees.toFixed(4)),t.totalDebit=Number(r.totalDebit.toFixed(2)),t.totalCredit=Number(r.totalCredit.toFixed(2)),t.cashFlow=Number(r.cashFlow.toFixed(2));const a=Number(r.capitalAtRisk);t.capitalAtRisk=Number.isFinite(a)?Number(a.toFixed(2)):a,t.fees=t.totalFees,t.primaryLeg=r.primaryLeg;const s=Number(e.maxRiskOverride);Number.isFinite(s)&&s>0?t.maxRiskOverride=s:t.maxRiskOverride=null;const n=r.primaryLeg;t.tradeType=this.deriveTradeTypeFromLeg(n),t.tradeDirection=this.deriveTradeDirectionFromLeg(n);const o=r.legs.filter(e=>"OPEN"===this.getLegSide(e)).filter(e=>"STOCK"===e.type);if(o.length>0){const e=o.reduce((e,t)=>{const i=t.quantity*this.getLegMultiplier(t);return e+("BUY"===this.getLegAction(t)?i:-i)},0),i=Math.abs(Math.round(e));if(i>0)t.quantity=i;else{const e=n?Math.abs(Number(n.quantity)||0):0;t.quantity="short"===t.tradeDirection?-e:e}}else{const e=n?Math.abs(Number(n.quantity)||0):0;t.quantity="short"===t.tradeDirection?-e:e}t.strikePrice=this.derivePrimaryStrike(r),t.multiplier=this.getLegMultiplier(n),t.displayStrike=this.buildStrikeDisplay(t,r);const l=this.getActiveStrikeForDisplay(r);t.activeStrikePrice=Number.isFinite(l)?Number(l):null;const c=r.entryPrice,d=r.exitPrice;t.entryPrice=Number.isFinite(c)?Number(c.toFixed(4)):null,t.exitPrice=Number.isFinite(d)?Number(d.toFixed(4)):null;const u=this.assessRisk(t,r);t.maxRiskOverride&&(u.maxRiskValue=t.maxRiskOverride,u.maxRiskLabel=this.formatCurrency(t.maxRiskOverride),u.unlimited=!1,r.capitalAtRisk=t.maxRiskOverride),t.capitalAtRisk=u.maxRiskValue,Number.isFinite(t.capitalAtRisk)&&(t.capitalAtRisk=Number(t.capitalAtRisk.toFixed(2))),t.maxRiskLabel=u.maxRiskLabel,t.riskIsUnlimited=u.unlimited;const m=this.parseDateValue(t.openedDate||t.entryDate||r.openedDate),h=this.parseDateValue(t.closedDate||t.exitDate||(r.closeLegs>0?r.closedDate:null));let p=this.parseDateValue(t.expirationDate);!p&&r.latestExpiration&&(p=r.latestExpiration);const g=r.nextShortCallExpiration||r.nearestShortCallExpiration||null;if(this.isPmccTrade(t)&&g&&(p=g),!this.isPmccTrade(t)&&this.isWheelOrPmccTrade(t)&&g){this.hasNetOpenOptionLegs({...t,legs:r.legs})&&(p=g)}t.pmccShortExpiration=g?g.toISOString().slice(0,10):"",t.longExpirationDate=r.latestExpiration?r.latestExpiration.toISOString().slice(0,10):"",t.openedDate=m?m.toISOString().slice(0,10):"",t.closedDate=h?h.toISOString().slice(0,10):"",t.entryDate=t.openedDate,t.exitDate=t.closedDate,t.expirationDate=p?p.toISOString().slice(0,10):"",t.pl=this.calculatePL(t),t.roi=this.calculateROI(t),t.maxRisk=this.calculateMaxRisk(t),t.maxRiskLabel||(t.maxRiskLabel=Number.isFinite(t.maxRisk)?this.formatCurrency(t.maxRisk):t.maxRisk===Number.POSITIVE_INFINITY?"Unlimited":"—");const y=this.determineTradeLifecycleStatus(t,r);t.lifecycleMeta=y.meta,t.lifecycleStatus=y.status,"number"==typeof y.openContractsOverride&&(t.openContracts=Math.max(0,y.openContractsOverride)),y.effectiveClosedDate&&(t.closedDate=y.effectiveClosedDate,t.exitDate=y.effectiveClosedDate),y.exitReason&&!t.exitReason&&(t.exitReason=y.exitReason),t.partialClose=Boolean(y.meta?.hasCloseActivity&&y.meta?.unmatchedExposure>0),t.rolledForward=Boolean(y.meta?.hasRollLegs),t.autoExpired="Expired"===y.status&&Boolean(y.meta?.expirationPassed);const f=this.normalizeTradeStatusInput(e.statusOverride);return f?(t.statusOverride=f,t.status=f):("statusOverride"in t&&delete t.statusOverride,t.status=y.status),t.daysHeld=this.calculateDaysHeld(t),t.dte=this.calculateDTE(t.expirationDate,t),t.annualizedROI=this.calculateAnnualizedROI(t),t}formatDateForInput(e){if(!e)return"";const t=new Date(e);if(isNaN(t.getTime()))return"";return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}calculateDaysBetween(e,t){const i=new Date(e),r=new Date(t),a=Math.abs(r.getTime()-i.getTime());return Math.ceil(a/864e5)}generateTickerLink(e){const t=(e??"").toString().trim().toUpperCase();return t?`https://www.investing.com/search/?q=${encodeURIComponent(t)}`:"https://www.investing.com/search/"}createTickerElement(e,t="ticker-link",i={}){const r=(e??"").toString().trim().toUpperCase();if(!r){const e=document.createElement("span");return e.className=`${t} ticker-link--placeholder`.trim(),e.textContent="—",e}const{behavior:a="external",onClick:s=null,title:n=""}=i||{},o=document.createElement("a");return o.className=t,o.textContent=r,n&&(o.title=n),"filter"===a&&"function"==typeof s?(o.href="#",o.setAttribute("role","button"),o.dataset.ticker=r,o.addEventListener("click",e=>{e.preventDefault(),s(r)})):(o.href=this.generateTickerLink(r),o.target="_blank",o.rel="noopener noreferrer",o.addEventListener("click",e=>{e.preventDefault(),window.open(this.generateTickerLink(r),"_blank","noopener,noreferrer")})),o}applyResponsiveLabels(e,t=[]){if(!e||!Array.isArray(t)||0===t.length)return;Array.from(e.cells||[]).forEach((e,i)=>{const r=t[i];r?e.setAttribute("data-label",r):e.removeAttribute("data-label")})}normalizeUnderlyingType(e,{fallback:t="Stock"}={}){const i=(e||"").toString().trim().toLowerCase();return["stock","etf","index","future"].includes(i)?i.charAt(0).toUpperCase()+i.slice(1):t}isWheelPut(e={}){return(e.strategy||"").toLowerCase().includes("cash-secured put")}isWheelTrade(e={}){return(e.strategy||"").toString().trim().toLowerCase().includes("wheel")}isWheelOrPmccTrade(e={}){return this.isWheelTrade(e)||this.isPmccTrade(e)}isCoveredCall(e={}){return(e.strategy||"").toLowerCase().includes("covered call")}isPmccBaseLeg(e={}){const t=(e.strategy||"").toLowerCase(),i=e.tradeDirection||this.inferTradeDirection(e),r=this.getTradeType(e);return t.includes("poor man")&&("long"===i||"BTO"===r)}isPmccShortCall(e={}){const t=(e.strategy||"").toLowerCase(),i=e.tradeDirection||this.inferTradeDirection(e),r=this.getTradeType(e);return t.includes("poor man")&&("short"===i||"STO"===r)}isPmccTrade(e={}){if(!e)return!1;const t=(e.strategy||"").toLowerCase();return!(!t.includes("poor man")&&!t.includes("pmcc"))||(this.isPmccBaseLeg(e)||this.isPmccShortCall(e))}isAssignmentTrade(e={}){return"assigned"===this.normalizeStatus(e.status)||this.isAssignmentReason(e.exitReason)}calculateOptionPremium(e={}){const t=Math.abs(Number(e.quantity)||0);if(!t)return 0;const i=Number(e.entryPrice)||0,r=Number(e.exitPrice)||0,a=Number(e.fees)||0,s=(i-r)*t*100;return"short"===(e.tradeDirection||this.inferTradeDirection(e))?s-a:(r-i)*t*100-a}bindEvents(){document.querySelectorAll(".nav-item").forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-view");t&&this.showView(t)})});const e=document.getElementById("save-database-btn");e&&e.addEventListener("click",async e=>{e.preventDefault(),await this.saveDatabase()});const t=document.getElementById("load-database-btn");t&&t.addEventListener("click",async e=>{e.preventDefault(),await this.loadDatabase()});const i=document.getElementById("new-database-btn");i&&i.addEventListener("click",e=>{e.preventDefault(),this.newDatabase()}),this.setupImportControls(),this.setupTradesMergeControls();const r=document.getElementById("add-trade-form");r&&r.addEventListener("submit",e=>{e.preventDefault(),this.handleTradeSubmit()});const a=document.getElementById("add-leg-button");a&&a.addEventListener("click",()=>this.addLegFormRow());const s=document.getElementById("cancel-trade");s&&s.addEventListener("click",e=>{e.preventDefault(),this.resetAddTradeForm(),this.showView("trades-list")});const n=document.getElementById("ticker");n&&n.addEventListener("input",e=>{this.updateTickerPreview(e.target.value)});const o=document.getElementById("underlyingType");o&&o.addEventListener("change",()=>{this.applyUnderlyingTypeToLegMultipliers({force:!1})}),["filter-strategy","filter-status"].forEach(e=>{const t=document.getElementById(e);t&&(t.addEventListener("change",()=>{this.normalizeFilterSelect(t),this.filterTrades()}),this.normalizeFilterSelect(t))});const l=document.getElementById("search-ticker");l&&l.addEventListener("input",()=>this.filterTrades());const c=document.getElementById("export-csv");c&&c.addEventListener("click",()=>this.exportToCSV()),document.querySelectorAll(".sortable").forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-sort");if(!t)return;"credit-playbook"===(e.getAttribute("data-sort-context")||"trades")?this.sortCreditPlaybook(t):this.sortTrades(t)})});const d=document.getElementById("ai-chat-toggle");d&&d.addEventListener("click",()=>this.toggleAIChat());const u=document.getElementById("ai-chat-close");u&&u.addEventListener("click",()=>this.toggleAIChat(!1));const m=document.getElementById("ai-chat-form");m&&m.addEventListener("submit",e=>{e.preventDefault(),this.handleAIChatSubmit()}),document.querySelectorAll(".ai-chat__quick-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-ai-prompt");t&&this.handleAIQuickPrompt(t)})});const h=document.getElementById("ai-chat");h&&h.addEventListener("click",e=>{const t=e.target instanceof Element?e.target:null,i=t?.closest('a[href="#settings"]');if(!i)return;e.preventDefault(),this.showView("settings"),this.toggleAIChat(!1);const r=document.getElementById("gemini-api-key");r&&setTimeout(()=>r.focus(),120)}),this.renderLegForms([]),this.setupAIChatResizeHandle(),this.setTodayDate(),this.setupResponsiveFilters(),this.initializeCumulativePLControls(),this.initializeAssignedPositionsStatusFilter(),this.initializeCreditPlaybookControls()}setupResponsiveFilters(){const e=document.getElementById("trades-filters-panel"),t=document.getElementById("toggle-filters");if(!e||!t)return;const i=e=>{t.textContent=e?"Hide Filters":"Show Filters",t.setAttribute("aria-expanded",String(e))};let r=window.innerWidth<=768;const a=(t=!1)=>{const a=window.innerWidth<=768;a?(!t&&r||e.classList.remove("is-open"),i(e.classList.contains("is-open"))):(e.classList.add("is-open"),i(!0)),r=a};t.addEventListener("click",()=>{const t=e.classList.toggle("is-open");i(t)});let s=null;window.addEventListener("resize",()=>{clearTimeout(s),s=setTimeout(()=>a(!1),160)}),a(!0)}initializeCumulativePLControls(){const e=document.getElementById("cumulative-pl-controls");e&&("true"!==e.dataset.initialized?(e.addEventListener("click",e=>{const t=e.target instanceof HTMLElement?e.target.closest("button[data-range]"):null;if(!t)return;const{range:i}=t.dataset;i&&this.setCumulativePLRange(i)}),e.dataset.initialized="true",this.syncCumulativePLControls()):this.syncCumulativePLControls())}setCumulativePLRange(e){const t=this.normalizeCumulativePLRange(e);t!==this.cumulativePLRange&&(this.cumulativePLRange=t,this.syncCumulativePLControls(),this.updateCumulativePLChart(),this.refreshShareCardChart())}syncCumulativePLControls(){const e=document.getElementById("cumulative-pl-controls");if(!e)return;const t=this.normalizeCumulativePLRange(this.cumulativePLRange);e.querySelectorAll("button[data-range]").forEach(e=>{const i=this.normalizeCumulativePLRange(e.dataset.range)===t;e.classList.toggle("is-active",i),e.setAttribute("aria-pressed",String(i))})}initializeAssignedPositionsStatusFilter(){const e=document.getElementById("assigned-positions-status-filter");e&&("true"!==e.dataset.initialized?(e.addEventListener("click",e=>{const t=e.target instanceof HTMLElement?e.target.closest("button[data-status]"):null;if(!t)return;const{status:i}=t.dataset;i&&this.setAssignedPositionsStatusFilter(i)}),e.dataset.initialized="true",this.syncAssignedPositionsStatusFilter()):this.syncAssignedPositionsStatusFilter())}setAssignedPositionsStatusFilter(e){const t="closed"===e?"closed":"open";t!==this.assignedPositionsStatusFilter&&(this.assignedPositionsStatusFilter=t,this.syncAssignedPositionsStatusFilter(),this.updateAssignedPositionsTable())}syncAssignedPositionsStatusFilter(){const e=document.getElementById("assigned-positions-status-filter");if(!e)return;const t=this.assignedPositionsStatusFilter;e.querySelectorAll("button[data-status]").forEach(e=>{const i=e.dataset.status===t;e.classList.toggle("is-active",i),e.setAttribute("aria-pressed",String(i))})}setupAIChatResizeHandle(){const e=document.getElementById("ai-chat-panel"),t=document.getElementById("ai-chat-resize-handle")||e?.querySelector(".ai-chat__resize-handle");if(!e||!t||"true"===t.dataset.initialized)return void(t&&(t.dataset.initialized="true"));const i=(e,t,i)=>Math.min(Math.max(e,t),i),r={resizing:!1,startX:0,startY:0,startWidth:0,startHeight:0,maxWidth:0,maxHeight:0,minWidth:280,minHeight:280,rightMargin:24,bottomMargin:24,viewportPadding:24},a=i=>{if(r.resizing){if(r.resizing=!1,e.classList.remove("ai-chat__panel--resizing"),i)try{t.releasePointerCapture(i.pointerId)}catch(e){}document.removeEventListener("pointermove",s),document.removeEventListener("pointerup",a),document.removeEventListener("pointercancel",a)}},s=t=>{if(!r.resizing)return;t.preventDefault();const a=t.clientX-r.startX,s=t.clientY-r.startY,n=i(r.startWidth-a,r.minWidth,r.maxWidth),o=i(r.startHeight-s,r.minHeight,r.maxHeight);e.style.width=`${n}px`,e.style.height=`${o}px`};t.addEventListener("pointerdown",i=>{if(0!==i.button&&"touch"!==i.pointerType)return;i.preventDefault();const n=e.getBoundingClientRect();r.resizing=!0,r.startX=i.clientX,r.startY=i.clientY,r.startWidth=n.width,r.startHeight=n.height,r.rightMargin=Math.max(r.viewportPadding,Math.round(window.innerWidth-n.right)),r.bottomMargin=Math.max(r.viewportPadding,Math.round(window.innerHeight-n.bottom)),r.maxWidth=Math.max(r.minWidth,window.innerWidth-r.rightMargin-r.viewportPadding),r.maxHeight=Math.max(r.minHeight,window.innerHeight-r.bottomMargin-r.viewportPadding),e.classList.add("ai-chat__panel--resizing"),e.style.removeProperty("transform");try{t.setPointerCapture(i.pointerId)}catch(e){}document.addEventListener("pointermove",s,{passive:!1}),document.addEventListener("pointerup",a),document.addEventListener("pointercancel",a)}),t.dataset.initialized="true"}initializeAIChat(){if(this.updateAIChatHeader(),!this.aiAgent)return void(this.aiChatMessages=[]);const e=this.calculateAdvancedStats();this.aiAgent.updateContext({stats:e,openTrades:e.openTradesList,closedTrades:e.closedTradesList}),this.aiChatSessionId=Date.now(),this.aiChatMessages=[],this.aiChatPendingRequest=!1;const t=this.aiAgent.getGreeting();t?this.appendAIChatMessage("ai",t):this.renderAIChatMessages()}toggleAIChat(e=null){const t=document.getElementById("ai-chat-panel"),i=document.getElementById("ai-chat-toggle"),r=document.getElementById("ai-chat-input");if(!t||!i)return;if(null===e?t.classList.contains("hidden"):Boolean(e)){if(!this.hasAICoachConsent())return void this.promptAICoachConsent(()=>this.toggleAIChat(!0));t.classList.remove("hidden"),t.setAttribute("aria-hidden","false"),i.setAttribute("aria-expanded","true"),this.aiChatOpen=!0,r&&setTimeout(()=>r.focus(),80)}else t.classList.add("hidden"),t.setAttribute("aria-hidden","true"),i.setAttribute("aria-expanded","false"),this.aiChatOpen=!1}async handleAIChatSubmit(){if(this.aiChatPendingRequest)return;const e=document.getElementById("ai-chat-input");if(!e)return;const t=e.value.trim();if(!t)return;if(!this.hasAICoachConsent())return void this.promptAICoachConsent(()=>{e.value.trim()||(e.value=t),this.handleAIChatSubmit()});this.appendAIChatMessage("user",t),e.value="";const i=this.appendAIChatMessage("ai","Analyzing your portfolio...",{pending:!0}),r=this.aiChatMessages.filter(e=>e.id!==i).slice(-10).map(e=>({...e}));this.aiChatPendingRequest=!0;try{const e=this.aiAgent?await this.aiAgent.generateResponse(t,{history:r}):"AI assistant is unavailable at the moment.";this.appendAIChatMessage("ai",e,{replaceId:i,pending:!1})}catch(e){const t=e?.message||"Unknown error",r="Sorry, I could not reach Gemini right now. Please try again soon.";this.appendAIChatMessage("ai",`${r} (${t})`,{replaceId:i,pending:!1})}finally{this.aiChatPendingRequest=!1,e&&e.focus()}}async handleAIQuickPrompt(e){if(this.aiChatPendingRequest||!e)return;if(!this.hasAICoachConsent())return void this.promptAICoachConsent(()=>this.handleAIQuickPrompt(e));this.toggleAIChat(!0);const t=document.getElementById("ai-chat-input");t&&(t.value=""),this.appendAIChatMessage("user",e);const i=this.appendAIChatMessage("ai","Analyzing your portfolio...",{pending:!0}),r=this.aiChatMessages.filter(e=>e.id!==i).slice(-10).map(e=>({...e}));this.aiChatPendingRequest=!0;try{const t=this.aiAgent?await this.aiAgent.generateResponse(e,{history:r}):"AI assistant is unavailable at the moment.";this.appendAIChatMessage("ai",t,{replaceId:i,pending:!1})}catch(e){const t=e?.message||"Unknown error",r="Sorry, I could not reach Gemini right now. Please try again soon.";this.appendAIChatMessage("ai",`${r} (${t})`,{replaceId:i,pending:!1})}finally{this.aiChatPendingRequest=!1,t&&t.focus()}}appendAIChatMessage(e,t,i={}){const r="ai"===e?"ai":"user",{suppressRender:a=!1,replaceId:s=null,id:n=null,pending:o=!1}=i||{};if(!s&&("string"!=typeof t||0===t.length))return null;const l=new Date;if(s){const e=this.aiChatMessages.findIndex(e=>e.id===s);if(-1!==e){const i=this.aiChatMessages[e];return this.aiChatMessages[e]={...i,sender:r,text:t||"",timestamp:l,pending:Boolean(o)},a||this.renderAIChatMessages(),this.aiChatMessages[e].id}}const c={id:n||`${this.aiChatSessionId}-${Date.now()}-${Math.random().toString(16).slice(2)}`,sender:r,text:t||"",timestamp:l,pending:Boolean(o)};return this.aiChatMessages=[...this.aiChatMessages,c].slice(-200),a||this.renderAIChatMessages(),c.id}renderAIChatMessages(){const e=document.getElementById("ai-chat-history");e&&(e.innerHTML="",this.aiChatMessages.forEach(t=>{const i=document.createElement("div");i.className=`ai-chat__message ai-chat__message--${t.sender}`,t.pending&&i.classList.add("ai-chat__message--pending");const r=document.createElement("span");r.textContent="ai"===t.sender?this.getGeminiChatDisplayName():"You",i.appendChild(r);const a=document.createElement("div");a.className="ai-chat__bubble",t.pending&&a.setAttribute("data-pending","true"),"ai"===t.sender?a.innerHTML=this.renderMarkdownToHTML(t.text):a.textContent=t.text,i.appendChild(a),e.appendChild(i)}),e.scrollTop=e.scrollHeight)}renderMarkdownToHTML(e=""){if(!e)return"";const t=[],i=/```([\s\S]*?)```/g;let r,a=0;for(;null!==(r=i.exec(e));)r.index>a&&t.push({type:"text",value:e.slice(a,r.index)}),t.push({type:"code",value:r[1]}),a=r.index+r[0].length;return a<e.length&&t.push({type:"text",value:e.slice(a)}),t.map(e=>{if("code"===e.type){const t=e.value.replace(/^\n+|\n+$/g,"");return`<pre class="ai-chat__code"><code>${this.escapeHTML(t)}</code></pre>`}return this.renderMarkdownTextSegment(e.value)}).join("")}renderMarkdownTextSegment(e=""){if(!e)return"";const t=e.replace(/\r/g,"").split("\n"),i=[];let r=[],a=!1,s=!1;const n=()=>{a&&(i.push("</ul>"),a=!1),s&&(i.push("</ol>"),s=!1)},o=()=>{if(!r.length)return;const e=r.join(" ").trim();e&&i.push(`<p>${this.formatMarkdownInline(e)}</p>`),r=[]};return t.forEach(e=>{const t=e.trim();if(!t)return o(),void n();const l=t.match(/^(#{1,3})\s+(.*)$/);if(l){o(),n();const e=Math.min(l[1].length+2,6);return void i.push(`<h${e}>${this.formatMarkdownInline(l[2])}</h${e}>`)}if(/^([-*_])\1{2,}$/.test(t))return o(),n(),void i.push('<hr class="ai-chat__rule">');if(t.startsWith(">")){o(),n();const e=t.replace(/^>\s?/,"");return void i.push(`<blockquote class="ai-chat__quote">${this.formatMarkdownInline(e)}</blockquote>`)}const c=t.match(/^[-*]\s+(.*)$/);if(c)return o(),a||(n(),i.push("<ul>"),a=!0),void i.push(`<li>${this.formatMarkdownInline(c[1])}</li>`);const d=t.match(/^\d+\.\s+(.*)$/);if(d)return o(),s||(n(),i.push("<ol>"),s=!0),void i.push(`<li>${this.formatMarkdownInline(d[1])}</li>`);r.push(e)}),o(),n(),i.join("")}formatMarkdownInline(e=""){if(!e)return"";const t=/\[([^\]]+)\]\(([^)]+)\)/g;let i,r=0,a="";for(;null!==(i=t.exec(e));){if(i.index>r){const t=e.slice(r,i.index);a+=this.applyBasicInlineFormatting(t)}const t=this.applyBasicInlineFormatting(i[1]);a+=`<a href="${this.escapeHTML(this.sanitizeMarkdownUrl(i[2]))}" target="_blank" rel="noopener noreferrer">${t}</a>`,r=i.index+i[0].length}return r<e.length&&(a+=this.applyBasicInlineFormatting(e.slice(r))),a}applyBasicInlineFormatting(e=""){if(!e)return"";let t=this.escapeHTML(e);return t=t.replace(/`([^`]+)`/g,"<code>$1</code>"),t=t.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>"),t=t.replace(/__([^_]+)__/g,"<strong>$1</strong>"),t=t.replace(/\*(?!\s)([^*]+?)\*(?!\*)/g,"<em>$1</em>"),t=t.replace(/_([^_]+)_/g,"<em>$1</em>"),t}sanitizeMarkdownUrl(e=""){try{const t=e.trim();if(!t)return"#";if(t.startsWith("#")){const e=t.slice(1);return e&&/^[a-z0-9_-]{1,64}$/i.test(e)?`#${e}`:"#"}const i=t.toLowerCase();return i.startsWith("http://")||i.startsWith("https://")?t:"#"}catch(e){return"#"}}updateTickerPreview(e){const t=document.getElementById("ticker-preview");if(e&&e.trim()){const i=e.toUpperCase().trim(),r=this.generateTickerLink(i);t.innerHTML="";const a=document.createTextNode("Search ");t.appendChild(a);const s=document.createElement("a");s.href=r,s.target="_blank",s.rel="noopener noreferrer",s.className="ticker-link",s.textContent=i,s.addEventListener("click",e=>{e.preventDefault(),window.open(r,"_blank","noopener,noreferrer")}),t.appendChild(s);const n=document.createTextNode(" on Investing.com");t.appendChild(n)}else t.innerHTML=""}setTodayDate(){const e=this.currentDate,t=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`,i=document.getElementById("entryDate");i&&!this.currentEditingId&&(i.value=t)}showView(e){document.querySelectorAll(".nav-item").forEach(e=>{e.classList.remove("active")});const t=document.querySelector(`[data-view="${e}"]`);t&&t.classList.add("active"),document.querySelectorAll(".view").forEach(e=>{e.classList.remove("active")});const i=document.querySelector(`.${e}-view`);i&&i.classList.add("active");const r={dashboard:"Options Trading Dashboard","add-trade":this.currentEditingId?"Edit Trade":"Add New Trade","trades-list":"All Trades",import:"Import Trades",settings:"Settings","credit-playbook":"Credit Playbook (beta)"}[e]||"GammaLedger";switch(document.getElementById("page-title").textContent=r,this.currentView=e,e){case"dashboard":this.updateDashboard();break;case"add-trade":this.currentEditingId||this.resetAddTradeForm();break;case"trades-list":this.updateTradesList();break;case"import":this.setupImportControls(),this.renderImportLog();break;case"credit-playbook":this.initializeCreditPlaybookControls(),this.updateCreditPlaybookView();break;case"settings":{const e=this.finnhub?.lastStatus;e&&this.finnhub?.elements?.status&&this.updateFinnhubStatus(e.message,e.variant,0);break}}}resetAddTradeForm(){const e=document.getElementById("add-trade-form");e&&e.reset();const t=document.getElementById("underlyingType");t&&(t.value="Stock");const i=document.getElementById("tradeStatus");i&&(i.value=""),this.currentEditingId=null,this.renderLegForms([]),this.setTodayDate(),this.updateTickerPreview("")}parseDecimal(e,t=null,{allowNegative:i=!0}={}){if(null==e)return t;let r="string"==typeof e?e.trim():e;if("string"==typeof r){if(""===r)return t;let e=r.replace(/\s+/g,"");if(!e)return t;const i=e.includes(","),a=e.includes(".");if(i&&!a)e=e.replace(/,/g,".");else if(i&&a){const t=e.lastIndexOf(","),i=e.lastIndexOf(".");e=t>i?e.replace(/\./g,"").replace(/,/g,"."):e.replace(/,/g,"")}e=e.replace(/_/g,""),r=e}const a=Number(r);return Number.isFinite(a)?!i&&a<0?t:a:t}parseDateValue(e){if(!e)return null;if(e instanceof Date)return Number.isNaN(e.getTime())?null:e;const t=e.toString().trim();if(!t)return null;const i=new Date(t);return Number.isNaN(i.getTime())?null:i}parseInteger(e,t=null,{allowNegative:i=!0}={}){if(null==e)return t;const r="string"==typeof e?e.trim():e;if(""===r)return t;const a=parseInt(r,10);return Number.isFinite(a)?!i&&a<0?t:a:t}parseExitPrice(e){const t=this.parseDecimal(e,null,{allowNegative:!1});return null===t?null:t}handleTradeSubmit(){const e=document.getElementById("add-trade-form");if(!e)return;const t=new FormData(e),i=this.collectLegsFromForm();if(null===i)return;if(0===i.length)return void this.showNotification("Add at least one leg before saving the trade.","error");const r=(t.get("ticker")||"").toString().trim().toUpperCase();if(!r)return void this.showNotification("Ticker is required.","error");const a=(t.get("strategy")||"").toString().trim();if(!a)return void this.showNotification("Strategy is required.","error");const s=this.normalizeUnderlyingType(t.get("underlyingType"),{fallback:"Stock"}),n=this.normalizeTradeStatusInput(t.get("tradeStatus")),o={ticker:r,strategy:a,exitReason:(t.get("exitReason")||"").toString().trim(),notes:(t.get("notes")||"").toString().trim(),legs:i,underlyingType:s};if(n&&(o.statusOverride=n),this.currentEditingId)return o.id=this.currentEditingId,void(this.updateTrade(o)&&(this.showNotification("Trade updated successfully","success"),this.resetAddTradeForm(),this.showView("trades-list")));o.id=Date.now();const l=this.enrichTradeData(o);this.trades.push(l),this.saveToStorage(),this.markUnsavedChanges(),this.resetAddTradeForm(),this.showView("dashboard")}updateTrade(e){try{e.id=this.currentEditingId;const t=this.enrichTradeData(e),i=this.trades.findIndex(e=>e.id===this.currentEditingId);return-1!==i&&(this.trades[i]=t,this.saveToStorage(),this.markUnsavedChanges(),!0)}catch(e){return console.error("Error updating trade:",e),!1}}updateDashboard(){const e=this.calculateAdvancedStats(),{openTradesList:t,closedTradesList:i}=e;this.latestStats=e,this.aiAgent&&this.aiAgent.updateContext({stats:e,openTrades:t,closedTrades:i});const r=this.formatNumber(e.winRate,{style:"percent",decimals:1});document.getElementById("win-rate").textContent=r??"—",document.getElementById("win-loss-count").textContent=`${e.wins}W / ${e.losses}L`;const a=Number(e.profitFactor);document.getElementById("profit-factor").textContent=Number.isFinite(a)?this.formatNumber(a,{decimals:2,useGrouping:!1}).toString():"Infinite",document.getElementById("active-positions").textContent=e.activePositions,document.getElementById("assigned-positions").textContent=e.assignedPositions,document.getElementById("collateral-at-risk").textContent=this.formatCurrency(e.collateralAtRisk),document.getElementById("realized-pl").textContent=this.formatCurrency(e.realizedPL);const s=document.getElementById("unrealized-pl");s.textContent=this.formatCurrency(e.unrealizedPL),s.className="card-value",e.unrealizedPL>0?s.classList.add("pl-positive"):e.unrealizedPL<0&&s.classList.add("pl-negative"),document.getElementById("total-roi").textContent=this.formatNumber(e.totalROI,{style:"percent"})??"—",this.updateActivePositionsTable(t),this.updateRecentTradesTable(i,e.activePositions),this.updateAssignedPositionsTable(),this.updateShareCard(e),this.refreshShareCardChart(),this.syncCumulativePLControls(),this.creditPlaybookNeedsRefresh=!0,"credit-playbook"===this.currentView&&this.updateCreditPlaybookView(),setTimeout(()=>{this.updateAllCharts()},200)}calculateAdvancedStats(){const e=this.trades.filter(e=>this.isClosedStatus(e.status)),t=this.trades.filter(e=>this.isAssignedStatus(e.status));let i=this.trades.filter(e=>this.isActiveStatus(e.status));const r=this.trades.filter(e=>!!this.isWheelOrPmccTrade(e)||this.isAssignedStatus(e.status)),a=t.filter(e=>this.isWheelOrPmccTrade(e)&&this.hasNetOpenOptionLegs(e));if(a.length){const e=new Map;i.forEach(t=>{if(t){const i=String(t.id??`${t.ticker||"trade"}-${t.openedDate||""}`);e.set(i,t)}}),a.forEach(t=>{if(t){const i=String(t.id??`${t.ticker||"assigned"}-${t.openedDate||""}`);e.set(i,t)}}),i=Array.from(e.values())}const s=e.filter(e=>e.pl>0),n=e.filter(e=>e.pl<0),o=e.reduce((e,t)=>e+t.pl,0),l=e.reduce((e,t)=>{const i=this.getCapitalAtRisk(t);return Number.isFinite(i)&&i>0?e+i:e},0),c=e.length>0?s.length/e.length*100:0,d=s.reduce((e,t)=>e+Math.max(t.pl,0),0),u=n.reduce((e,t)=>e+Math.abs(t.pl),0);let m=0;u>0?m=d/u:d>0&&(m=Number.POSITIVE_INFINITY);let h=0,p=0,g=0;[...e].sort((e,t)=>new Date(e.exitDate)-new Date(t.exitDate)).forEach(e=>{g+=e.pl,g>p&&(p=g);const t=p>0?(p-g)/p*100:0;t>h&&(h=t)});const y=l>0?o/l*100:0,f=e.length>0?e.reduce((e,t)=>e+t.daysHeld,0)/e.length:0,b=f>0?100*(Math.pow(1+y/100,365/f)-1):0,C=e.reduce((e,t)=>{const i=Number(t.totalFees);if(Number.isFinite(i))return e+i;const r=Number(t.fees);return Number.isFinite(r)?e+r:e},0),S=C+d+u,T=S>0?C/S*100:0,L=e.map(e=>{const t=Number(e.roi),i=Math.max(1,Number(e.daysHeld)||0);if(Number.isFinite(t)){const e=1+t/100;return e>0?Math.pow(e,1/i)-1:t/100/i}const r=this.getCapitalAtRisk(e),a=Number(e.pl)||0;if(!(r>0))return null;const s=a/r*100;if(!Number.isFinite(s))return null;const n=1+s/100;return n>0?Math.pow(n,1/i)-1:s/100/i}).filter(e=>Number.isFinite(e)),x=L.length?L.reduce((e,t)=>e+t,0)/L.length:0;let k=0;if(L.length>1){const e=L.reduce((e,t)=>e+Math.pow(t-x,2),0)/(L.length-1);k=e>0?Math.sqrt(e):0}const v=L.filter(e=>e<0),N=v.length?Math.sqrt(v.reduce((e,t)=>e+t*t,0)/v.length):0,D=k>0?x/k*Math.sqrt(252):null,I=N>0?x/N*Math.sqrt(252):0===v.length&&x>0?Number.POSITIVE_INFINITY:null,E=s.length>0?s.reduce((e,t)=>e+(Number(t.daysHeld)||0),0)/s.length:0,P=n.length>0?n.reduce((e,t)=>e+(Number(t.daysHeld)||0),0)/n.length:0,F=this.calculateTickerPerformance(e),A=i.reduce((e,t)=>{const i=this.getCapitalAtRisk(t);return Number.isFinite(i)&&i>0?e+i:e},0),w=o,M=i.reduce((e,t)=>{const i=Number(t.pl);return Number.isFinite(i)?e+i:e},0),R=this.calculateAssignmentStats(r);return{totalTrades:this.trades.length,totalPL:o,winRate:c,wins:s.length,losses:n.length,profitFactor:m,activePositions:i.length,assignedPositions:R.totalAssignments,totalROI:y,annualizedROI:b,maxDrawdown:h,closedTrades:e.length,totalInvestment:l,totalMaxRisk:l,closedTradesList:e,openTradesList:i,assignedTradesList:R.assignments,totalFees:C,feeShareOfGross:T,dailyReturns:L,meanDailyReturn:x,dailyStdDev:k,downsideDeviation:N,sharpeRatio:D,sortinoRatio:I,avgWinnerDays:E,avgLoserDays:P,tickerPerformance:F,collateralAtRisk:A,realizedPL:w,unrealizedPL:M,assignmentStats:R}}calculateAssignmentStats(e){const t=e.map(e=>{const t=Array.isArray(e.legs)?e.legs:[];let i="other";this.isPmccTrade(e)?i="pmcc":this.isWheelOrPmccTrade(e)&&(i="wheel");const r=t.map(e=>({leg:e,type:(e.type||e.optionType||"").toString().trim().toUpperCase(),action:this.getLegAction(e),side:this.getLegSide(e),executionDate:this.parseDateValue(e.executionDate),quantity:Math.abs(Number(e.quantity)||0),multiplier:this.getLegMultiplier(e)||1,premium:Number(e.premium)||0})),a=r.filter(e=>"STOCK"===e.type&&"BUY"===e.action&&"OPEN"===e.side),s=a[0];"other"===i&&a.length>0&&(i="wheel");const n=s?.executionDate||null;let o=100;if(a.length>0){const e=a.reduce((e,t)=>e+(t.quantity||0)*(t.multiplier||1),0);e>0&&(o=e)}else{const e=r.find(e=>["CALL","PUT"].includes(e.type)&&e.quantity>0&&e.multiplier>0);if(e){const t=e.quantity*e.multiplier;t>0&&(o=t)}}let l=Number(e.strikePrice)||0;if(a.length>0){let e=0,t=0;a.forEach(i=>{const r=(i.quantity||0)*(i.multiplier||1),a=Number(i.leg.premium),s=Number(i.leg.strike);let n=0;Number.isFinite(s)&&s>0?n=s:Number.isFinite(a)&&a>0&&(n=a),n>0&&r>0&&(e+=n*r,t+=r)}),t>0&&(l=e/t)}const c=[],d=(e,t,i)=>{const r=e.leg.executionDate||(e.executionDate?e.executionDate.toISOString().slice(0,10):""),a=this.formatDate(r),s=[];"SELL"===e.action?s.push("Sell"):"BUY"===e.action&&s.push("Buy"),"CALL"===e.type?s.push("Call"):"PUT"===e.type&&s.push("Put"),"OPEN"===e.side?s.push("to Open"):"CLOSE"===e.side?s.push("to Close"):"ROLL"===e.side&&s.push("Roll");const n=s.length>0?`${a} · ${s.join(" ")}`:a;c.push({date:r,amount:t,label:n,category:i})},u=[...r].sort((e,t)=>{const i=e.executionDate instanceof Date?e.executionDate.getTime():Number.NEGATIVE_INFINITY,r=t.executionDate instanceof Date?t.executionDate.getTime():Number.NEGATIVE_INFINITY;return i===r?0:i-r});let m=0,h=0,p=0,g=0,y=0,f=0,b=0;const C="pmcc"===i?u.filter(e=>"CALL"===e.type&&"BUY"===e.action&&"OPEN"===e.side):[],S=new Set(C.map(e=>e.leg.id)),T=C.length>0?C.reduce((e,t)=>{const i=this.parseDateValue(e?.leg?.expirationDate)||this.parseDateValue(e?.leg?.expiration)||null,r=this.parseDateValue(t?.leg?.expirationDate)||this.parseDateValue(t?.leg?.expiration)||null;return!i&&r||r&&r.getTime()>i.getTime()?t:e}):null;let L,x=e.exitDate||e.closedDate||null;if("pmcc"===i){const e=T?.executionDate;e instanceof Date?x=e.toISOString().slice(0,10):T?.leg?.executionDate&&(x=T.leg.executionDate)}else n instanceof Date?x=n.toISOString().slice(0,10):s?.leg?.executionDate&&(x=s.leg.executionDate);if(u.forEach(e=>{if(!["PUT","CALL"].includes(e.type))return;const t=this.calculateLegCashFlow(e.leg);if(!Number.isFinite(t)||0===t)return;if("pmcc"===i){if("CALL"===e.type){if(S.has(e.leg.id)){if(g+=Math.abs(t),d(e,t,"LONG_CALL"),!l){const t=Number(e.leg.strike);Number.isFinite(t)&&t>0&&(l=t)}return}if(y+=t,d(e,t,"CALL"),"SELL"===e.action&&("OPEN"===e.side||"ROLL"===e.side)){b+=Math.max(e.quantity||1,1);const t=Number(e.leg.strike);Number.isFinite(t)&&t>0&&(f=t)}}return}const r=!n||(!e.executionDate||e.executionDate<=n),a=!n||(!e.executionDate||e.executionDate>=n);if("PUT"===e.type&&r){if(m+=t,d(e,t,"PUT"),!l){const t=Number(e.leg.strike);Number.isFinite(t)&&t>0&&(l=t)}}else if("CALL"===e.type&&a&&(h+=t,d(e,t,"CALL"),"SELL"===e.action&&("OPEN"===e.side||"ROLL"===e.side)&&(p+=Math.max(e.quantity||1,1),!l))){const t=Number(e.leg.strike);Number.isFinite(t)&&t>0&&(l=t)}}),c.sort((e,t)=>{const i=this.parseDateValue(e.date),r=this.parseDateValue(t.date);return(i?i.getTime():0)-(r?r.getTime():0)}),"pmcc"===i&&(f&&!s&&(l=f),!l&&T)){const e=Number(T.leg.strike);Number.isFinite(e)&&e>0&&(l=e)}let k=0,v=0,N=0,D=0,I=0;if("pmcc"===i){L=y;I=g;const e=g-y;D=e,N=o>0?e/o:0}else L=m+h,k=o>0?m/o:0,v=o>0?h/o:0,Number.isFinite(l)&&0!==l&&(N=l-k-v,D=o>0?N*o:0,I=l*o);return"pmcc"!==i||Number.isFinite(I)||(I=0),"pmcc"!==i||Number.isFinite(D)||(D=0,N=0),"other"===i?null:{trade:e,positionType:i,strike:l,initialPutPremium:m,callPremium:"pmcc"===i?y:h,longCallCost:"pmcc"===i?g:0,premiumCollected:L,premiumHistory:c,coveredCallCount:"pmcc"===i?b:p,costBasisPerShare:N,effectiveCostBasis:D,shares:o,assignmentCostBasis:I,assignmentDate:x}}).filter(Boolean),i=t.filter(e=>!this.isClosedStatus(e.trade.status)).length,r=t.reduce((e,t)=>e+t.premiumCollected,0);return{totalAssignments:i,totalPremiumCollected:r,avgPremiumPerAssignment:i>0?r/i:0,totalCoveredCalls:t.reduce((e,t)=>e+t.coveredCallCount,0),assignments:t}}calculateTickerPerformance(e=[]){const t=new Map;e.forEach(e=>{const i=(e.ticker||"Unknown").toString().trim().toUpperCase()||"UNKNOWN";t.has(i)||t.set(i,{ticker:i,totalPL:0,tradeCount:0,wins:0,losses:0});const r=t.get(i),a=Number(e.pl)||0;r.totalPL+=a,r.tradeCount+=1,a>0?r.wins+=1:a<0&&(r.losses+=1)});const i=Array.from(t.values()).map(e=>{const t=e.tradeCount>0?e.wins/e.tradeCount*100:0,i=e.tradeCount>0?e.totalPL/e.tradeCount:0;return{...e,avgPL:i,winRate:t}}).sort((e,t)=>Math.abs(t.totalPL)-Math.abs(e.totalPL)),r=i.length?Math.max(...i.map(e=>Math.abs(e.totalPL))):0;return{items:i,maxMagnitude:r}}updateActivePositionsTable(e=this.trades.filter(e=>!!this.isActiveStatus(e.status)||!!(this.isAssignmentTrade(e)&&this.isWheelOrPmccTrade(e)&&this.hasNetOpenOptionLegs(e)))){const t=document.querySelector("#active-positions-table tbody");if(t){t.innerHTML="";const i=[...Array.isArray(e)?e:[]].sort((e,t)=>this.parseInteger(e.dte,Number.POSITIVE_INFINITY,{allowNegative:!1})-this.parseInteger(t.dte,Number.POSITIVE_INFINITY,{allowNegative:!1})),r=["Ticker","Strategy","Strike","Current Price","DTE","Max Risk","Notes"],a=new Map;i.forEach(e=>{const i=t.insertRow();i.dataset.tradeId=String(e.id??"");const s=i.insertCell(0),n=(e.ticker??"").toString().trim().toUpperCase(),o=this.createTickerElement(e.ticker,"ticker-pill",{behavior:"filter",onClick:e=>this.openTradesFilteredByTicker(e),title:n?`View all trades for ${n}`:""});s.appendChild(o),i.dataset.ticker=n,i.insertCell(1).textContent=e.strategy||"—";const l=i.insertCell(2);let c=this.parseDecimal(e.activeStrikePrice,null,{allowNegative:!1});if(null===c&&Array.isArray(e.legs)&&e.legs.length>0){const t=this.summarizeLegs(e.legs),i=this.getActiveStrikeForDisplay(t);Number.isFinite(i)&&(c=i)}if(null===c&&(c=this.parseDecimal(e.strikePrice,null,{allowNegative:!1})),Number.isFinite(c)){const e=this.formatNumber(c,{style:"currency",decimals:2});l.textContent=e??"—",i.dataset.strikePrice=String(c)}else l.textContent="—",delete i.dataset.strikePrice;const d=i.insertCell(3);d.className="quote-cell";const u=`${this.getQuoteEntryKey(e)}|row:${a.size}`;i.dataset.quoteKey=u,this.populateQuoteCell(d,e,i,{deferNetworkFetch:!0}),a.set(u,{trade:e,row:i,cell:d,key:u});const m=this.parseInteger(e.dte,null,{allowNegative:!1}),h=i.insertCell(4);h.textContent=null!==m?m:"—",Number.isFinite(m)?i.dataset.dte=String(m):delete i.dataset.dte;const p=i.insertCell(5),g=this.parseDecimal(e.maxRisk,null,{allowNegative:!1});null!==g?(p.textContent=this.formatCurrency(g),p.className="pl-negative"):(p.textContent="—",p.className="pl-neutral");const y=i.insertCell(6),f=(e.notes||"").trim();y.textContent=f||"—",y.classList.add("notes-cell"),f&&(y.title=f),this.updateExpirationHighlight(h,e),this.applyResponsiveLabels(i,r)}),this.activeQuoteEntries=a,this.rebuildQuoteRefreshSchedule(),this.startQuoteAutoRefreshIfNeeded(),this.refreshActivePositionsQuotes({force:!0,immediate:!0})}}updateRecentTradesTable(e=this.trades.filter(e=>this.isClosedStatus(e.status)),t=this.trades.filter(e=>this.isActiveStatus(e.status)).length){const i=Number(t),r=Math.max(Number.isFinite(i)?i:0,10),a=[...Array.isArray(e)?e:[]].sort((e,t)=>new Date(t.exitDate)-new Date(e.exitDate)).slice(0,r),s=document.querySelector("#recent-trades-table tbody");if(s){s.innerHTML="";const e=["Ticker","Strategy","Exit Date","Days Held","P&L","ROI"];a.forEach(t=>{const i=s.insertRow(),r=i.insertCell(0),a=(t.ticker??"").toString().trim().toUpperCase(),n=this.createTickerElement(t.ticker,"ticker-pill",{behavior:"filter",onClick:e=>this.openTradesFilteredByTicker(e),title:a?`View all trades for ${a}`:""});r.appendChild(n),i.insertCell(1).textContent=t.strategy,i.insertCell(2).textContent=this.formatDate(t.exitDate);const o=i.insertCell(3),l=Number(t.daysHeld);o.textContent=Number.isFinite(l)?l:"—";const c=i.insertCell(4);c.textContent=this.formatCurrency(t.pl),c.className=t.pl>=0?"pl-positive":"pl-negative";const d=i.insertCell(5),u=Number(t.roi),m=this.formatPercent(u,"—");d.textContent=m,d.className="—"===m?"pl-neutral":u>=0?"pl-positive":"pl-negative",this.applyResponsiveLabels(i,e)})}}updateAssignedPositionsTable(){const e=this.latestStats,t=e?.assignmentStats,i=t?.assignments||[],r=document.querySelector("#assigned-positions-table tbody");if(r){r.innerHTML="";const e=["Ticker","Strategy","Status","Assignment Date","Shares","Strike Price","Assignment Cost Basis","Premium Collected","Eff. Cost Basis","Market Value","Unrealized Gain/Loss","Notes"],t=this.assignedPositionsStatusFilter,a=i.filter(({trade:e})=>"open"===t?!this.isClosedStatus(e.status):"closed"!==t||this.isClosedStatus(e.status)),s=new Map;a.forEach(({trade:t,strike:i,premiumCollected:a,premiumHistory:n,effectiveCostBasis:o,shares:l,initialPutPremium:c,callPremium:d,longCallCost:u,positionType:m,assignmentCostBasis:h,assignmentDate:p})=>{const g=r.insertRow(),y=g.insertCell(0),f=(t.ticker??"").toString().trim().toUpperCase(),b=this.createTickerElement(t.ticker,"ticker-pill",{behavior:"filter",onClick:e=>this.openTradesFilteredByTicker(e),title:f?`View all trades for ${f}`:""});y.appendChild(b);g.insertCell(1).textContent=t.strategy||"—";const C=g.insertCell(2),S=document.createElement("span");S.className="status-badge";(t.status||"").toLowerCase();const T=!this.isClosedStatus(t.status);S.classList.add(T?"open":"closed"),S.textContent=T?"Open":"Closed",C.appendChild(S),g.insertCell(3).textContent=this.formatDate(p);g.insertCell(4).textContent=this.formatNumber(l,{decimals:0,useGrouping:!0})??l.toString(),g.insertCell(5).textContent=this.formatCurrency(i);g.insertCell(6).textContent=this.formatCurrency(h);const L=g.insertCell(7),x=document.createElement("span");x.className="formula-value-wrapper";const k=document.createElement("span");k.textContent=this.formatCurrency(a),x.appendChild(k);const v=document.createElement("span");v.className="formula-info-icon",v.textContent="i",v.setAttribute("aria-label","View premium breakdown");const N=document.createElement("div");N.className="formula-tooltip",N.setAttribute("role","tooltip");let D="";D+='<div class="formula-tooltip__title">Premium Breakdown</div>',D+='<div class="formula-tooltip__section">',D+='<div class="formula-tooltip__label">Net Premium Collected</div>',D+=`<div class="formula-tooltip__formula">${this.escapeHtml(this.formatCurrency(a))}</div>`,D+="</div>";const I="pmcc"===m,E=I?[{name:"LEAP Cost",value:this.formatCurrency(-Math.abs(u))},{name:"Short Calls Net",value:this.formatCurrency(d)}]:[{name:"Initial CSP Net",value:this.formatCurrency(c)},{name:"Covered Calls Net",value:this.formatCurrency(d)}];D+='<div class="formula-tooltip__section">',D+='<div class="formula-tooltip__label">Components</div>',D+='<div class="formula-tooltip__variables">',E.forEach(e=>{D+='<div class="formula-tooltip__variable">',D+=`<span class="formula-tooltip__variable-name">${this.escapeHtml(e.name)}</span>`,D+=`<span class="formula-tooltip__variable-value">${this.escapeHtml(e.value)}</span>`,D+="</div>"}),D+="</div>",D+="</div>",D+='<div class="formula-tooltip__section">',D+='<div class="formula-tooltip__label">Activity Log</div>',n&&n.length>0?(D+='<div class="formula-tooltip__variables">',n.forEach(e=>{D+='<div class="formula-tooltip__variable">',D+=`<span class="formula-tooltip__variable-name">${this.escapeHtml(e.label)}</span>`,D+=`<span class="formula-tooltip__variable-value">${this.escapeHtml(this.formatCurrency(e.amount))}</span>`,D+="</div>"}),D+="</div>"):D+='<div class="formula-tooltip__explanation">No option premium activity recorded yet.</div>',D+="</div>",D+='<div class="formula-tooltip__section">',D+=I?'<div class="formula-tooltip__explanation">Net premium reflects short-call activity. Effective basis subtracts these credits from the LEAP cost.</div>':'<div class="formula-tooltip__explanation">Includes initial cash-secured put credit and all covered call legs net of buybacks and fees.</div>',D+="</div>",N.innerHTML=D,x.appendChild(v),x.appendChild(N),x.addEventListener("mouseenter",()=>{this.positionFormulaTooltip(x,N)});const P=()=>{x.matches(":hover")&&this.positionFormulaTooltip(x,N)};window.addEventListener("scroll",P,{passive:!0}),x.addEventListener("mouseleave",()=>{window.removeEventListener("scroll",P)},{once:!0}),L.appendChild(x),g.insertCell(8).textContent=this.formatCurrency(o);const F=g.insertCell(9);F.className="market-value-cell quote-dependent",F.textContent="—",F.dataset.shares=String(l),F.dataset.effectiveCostBasis=String(o);const A=g.insertCell(10);A.className="unrealized-gl-cell quote-dependent",A.textContent="—";if((t.ticker||"").toString().trim().toUpperCase()&&this.finnhub.apiKey){const e=`assigned|${this.getQuoteEntryKey(t)}|row:${s.size}`;g.dataset.quoteKey=e,s.set(e,{trade:t,row:g,marketValueCell:F,unrealizedGLCell:A,shares:l,effectiveCostBasis:o,key:e})}const w=g.insertCell(11);w.textContent=t.notes||"—",w.className="notes-col",this.applyResponsiveLabels(g,e)}),this.assignedPositionsQuoteEntries||(this.assignedPositionsQuoteEntries=new Map),this.assignedPositionsQuoteEntries=s,s.size>0&&(s.forEach((e,t)=>{this.activeQuoteEntries.set(t,e)}),this.rebuildQuoteRefreshSchedule(),this.startQuoteAutoRefreshIfNeeded(),this.refreshAssignedPositionsQuotes({immediate:!0}))}}refreshAssignedPositionsQuotes({force:e=!1,immediate:t=!1}={}){this.assignedPositionsQuoteEntries instanceof Map&&0!==this.assignedPositionsQuoteEntries.size&&this.assignedPositionsQuoteEntries.forEach(t=>{if(!t||!t.row?.isConnected)return;const i=(t.trade?.ticker||"").toString().trim().toUpperCase();i&&this.getCurrentPrice(i,{forceRefresh:e}).then(e=>{t.row?.isConnected&&this.updateAssignedPositionMetrics(t,e)}).catch(e=>{t.row?.isConnected&&(t.marketValueCell&&(t.marketValueCell.textContent="—"),t.unrealizedGLCell&&(t.unrealizedGLCell.textContent="—",t.unrealizedGLCell.classList.remove("pl-positive","pl-negative","pl-neutral")))})})}updateAssignedPositionMetrics(e,t){if(!e||!t)return;const i=Number(t?.price),r=Number(e.shares),a=Number(e.effectiveCostBasis);if(!Number.isFinite(i)||!Number.isFinite(r)||!Number.isFinite(a))return;const s=i*r,n=s-a,o=0!==a?n/a*100:0;if(e.marketValueCell&&(e.marketValueCell.textContent=this.formatCurrency(s)),e.unrealizedGLCell){e.unrealizedGLCell.innerHTML="";const t=document.createElement("span");t.className="gl-absolute",t.textContent=this.formatCurrency(n),e.unrealizedGLCell.appendChild(t);const i=document.createElement("span");i.className="gl-percent";const r=Math.abs(o),a=this.formatNumber(r,{decimals:2,useGrouping:!0})??r.toFixed(2),s=n>0?"+":n<0?"-":"";i.textContent=`${s}${a}%`,e.unrealizedGLCell.appendChild(i),e.unrealizedGLCell.classList.remove("pl-positive","pl-negative","pl-neutral"),n>0?e.unrealizedGLCell.classList.add("pl-positive"):n<0?e.unrealizedGLCell.classList.add("pl-negative"):e.unrealizedGLCell.classList.add("pl-neutral")}}initializeCreditPlaybookControls(){const e=document.getElementById("credit-playbook-status-filter");e&&"true"!==e.dataset.initialized&&(e.addEventListener("click",e=>{const t=e.target instanceof HTMLElement?e.target.closest("button[data-status]"):null;t&&this.setCreditPlaybookStatus(t.dataset.status)}),e.dataset.initialized="true"),this.syncCreditPlaybookStatusControls();const t=document.getElementById("credit-playbook-strategy-filter");t&&"true"!==t.dataset.initialized&&(t.addEventListener("change",()=>{this.setCreditPlaybookStrategy(t.value)}),t.dataset.initialized="true"),t&&t.value!==this.creditPlaybookStrategy&&(t.value=this.creditPlaybookStrategy);const i=document.getElementById("credit-playbook-horizon-filter");i&&"true"!==i.dataset.initialized&&(i.addEventListener("change",()=>{this.setCreditPlaybookHorizon(i.value)}),i.dataset.initialized="true"),i&&i.value!==this.creditPlaybookHorizon&&(i.value=this.creditPlaybookHorizon);const r=document.getElementById("credit-playbook-symbol-filter");r&&"true"!==r.dataset.initialized&&(r.addEventListener("input",()=>{this.setCreditPlaybookSymbol(r.value)}),r.dataset.initialized="true"),r&&r.value!==this.creditPlaybookSymbol&&(r.value=this.creditPlaybookSymbol),document.querySelectorAll("#credit-playbook-table .sortable").forEach(e=>e.setAttribute("data-sort-context","credit-playbook")),this.creditPlaybookInitialized=!0}syncCreditPlaybookStatusControls(){const e=document.getElementById("credit-playbook-status-filter");if(!e)return;const t=this.creditPlaybookStatus;e.querySelectorAll("button[data-status]").forEach(e=>{const i=(e.dataset.status||"all")===t;e.classList.toggle("is-active",i),e.setAttribute("aria-pressed",String(i))})}setCreditPlaybookStatus(e){const t=["active","closed","all"].includes(e)?e:"all";t!==this.creditPlaybookStatus&&(this.creditPlaybookStatus=t,this.syncCreditPlaybookStatusControls(),this.updateCreditPlaybookView())}normalizeCreditPlaybookStrategyValue(e){if(!e)return null;const t=e.toString().trim();if(!t)return null;const i=e=>e.replace(/[^a-z0-9]/gi,"").toLowerCase(),r=i(t);if(!r)return null;return this.creditPlaybookStrategyOptions.find(e=>i(e)===r)||null}setCreditPlaybookStrategy(e){const t="string"==typeof e&&"all"===e.toLowerCase()?"all":this.normalizeCreditPlaybookStrategyValue(e)||"all";if(t===this.creditPlaybookStrategy)return;this.creditPlaybookStrategy=t;const i=document.getElementById("credit-playbook-strategy-filter");i&&i.value!==t&&(i.value=t),this.updateCreditPlaybookView()}setCreditPlaybookHorizon(e){const t=new Set(["all","7d","14d","30d","90d","180d","365d","mtd","ytd"]).has(e)?e:"all";if(!(t!==this.creditPlaybookHorizon)){const e=document.getElementById("credit-playbook-horizon-filter");return void(e&&e.value!==t&&(e.value=t))}this.creditPlaybookHorizon=t;const i=document.getElementById("credit-playbook-horizon-filter");i&&i.value!==t&&(i.value=t),this.updateCreditPlaybookView()}setCreditPlaybookSymbol(e){const t=(e||"").toString().trim().toUpperCase();if(t===this.creditPlaybookSymbol)return;this.creditPlaybookSymbol=t;const i=document.getElementById("credit-playbook-symbol-filter");i&&i.value.toUpperCase()!==t&&(i.value=t),this.updateCreditPlaybookView()}updateCreditPlaybookView(){if("credit-playbook"!==this.currentView)return void(this.creditPlaybookNeedsRefresh=!0);const e=document.getElementById("credit-playbook-table"),t=document.getElementById("credit-playbook-metrics");if(!e||!t)return void(this.creditPlaybookNeedsRefresh=!0);const i=this.getCreditPlaybookEntries();this.creditPlaybookEntries=i;const r=this.extractCreditPlaybookLegPairs(i),a=this.filterCreditPlaybookLegPairs(r),s=this.applyCreditPlaybookSortToLegPairs(a);this.renderCreditPlaybookMetrics(a),this.renderCreditPlaybookTableFromLegPairs(s),this.applyCreditPlaybookSortIndicators(),this.creditPlaybookNeedsRefresh=!1}getCreditPlaybookEntries(){return this.trades.filter(e=>this.isCreditStrategyTrade(e)).map(e=>this.mapCreditTradeToEntry(e)).filter(Boolean)}isCreditStrategyTrade(e={}){const t=this.normalizeCreditPlaybookStrategyValue(e.strategy);return Boolean(t)}mapCreditTradeToEntry(e={}){const t=(e.ticker||"").toString().trim().toUpperCase();if(!t)return null;const i=this.normalizeCreditPlaybookStrategyValue(e.strategy)||(e.strategy||"").toString().trim(),r=this.normalizeStatus(e.status),a=!this.isClosedStatus(e.status),s=this.summarizeLegs(e.legs||[]),n=this.resolveCreditPlaybookOpenedAt(e,s),o=n?n.toISOString().slice(0,10):"";let l=this.parseInteger(e.dte,null,{allowNegative:!0});if(!Number.isFinite(l)&&s.latestExpiration instanceof Date){const e=s.latestExpiration.getTime()-this.currentDate.getTime();Number.isFinite(e)&&(l=Math.round(e/864e5))}const c=s.nextShortCallExpiration||s.nearestShortCallExpiration||s.latestExpiration||s.earliestExpiration,d=c instanceof Date?c.toISOString().slice(0,10):"",u=this.getNetOpenOptionContracts(s.legs),m=u>0?u:Number(s.openBaseContracts||s.openContracts||0),h=Number(s.openCashFlow)||0,p=this.getCapitalAtRisk(e),g=Number.isFinite(p)&&p>=0?p:null,y=Number(e.pl),f=Number(e.roi);let b=Number.isFinite(f)?f:null;null===b&&Number.isFinite(y)&&Number.isFinite(g)&&g>0&&(b=y/g*100);const C=this.deriveCreditPlaybookPrice(e),S=m>0?h/m:null,T=Number.isFinite(g)&&m>0?g/m:null;return{trade:e,ticker:t,strategy:i||"—",normalizedStatus:r,status:this.getDisplayStatus(e),isOpen:a,openedDate:o,openedDateValue:n,expiration:c,expirationLabel:d,dte:Number.isFinite(l)?l:null,premium:Number.isFinite(h)?h:0,capital:g,capitalAtRisk:g,premiumPerContract:Number.isFinite(S)?S:null,capitalPerContract:Number.isFinite(T)?T:null,contracts:m,currentPrice:Number.isFinite(C)?C:null,pl:Number.isFinite(y)?y:null,roi:Number.isFinite(b)?b:null,position:i||t,summary:s}}resolveCreditPlaybookOpenedAt(e={},t={}){const i=[this.parseDateValue(e.openedDate),this.parseDateValue(e.entryDate),this.parseDateValue(e.tradeDate),this.parseDateValue(e.openDate),t?.openedDate instanceof Date?t.openedDate:null];for(const e of i)if(e instanceof Date&&!Number.isNaN(e.getTime()))return e;if(Array.isArray(e.legs)){const t=e.legs.map(e=>this.parseDateValue(e?.executionDate)).filter(e=>e instanceof Date&&!Number.isNaN(e.getTime())).sort((e,t)=>e.getTime()-t.getTime());if(t.length>0)return t[0]}return null}deriveCreditPlaybookPrice(e={}){const t=[e.currentPrice,e.marketPrice,e.lastPrice,e.stockPrice,e.underlyingPrice,e.stockPriceAtEntry];for(const e of t){const t=this.parseDecimal(e,null,{allowNegative:!1});if(Number.isFinite(t))return t}return null}filterCreditPlaybookEntries(e=[]){const t=this.creditPlaybookStatus,i=this.creditPlaybookStrategy,r=this.creditPlaybookHorizon,a=this.creditPlaybookSymbol,s=this.currentDate instanceof Date?this.currentDate:new Date;return e.filter(e=>{if("active"===t&&!e.isOpen)return!1;if("closed"===t&&e.isOpen)return!1;if("all"!==i&&e.strategy!==i)return!1;if(a&&(!e.ticker||!e.ticker.includes(a)))return!1;if("all"!==r){const t=e.openedDateValue instanceof Date?e.openedDateValue:null;if(!t)return!1;if("ytd"===r){if(t.getFullYear()!==s.getFullYear())return!1}else if("mtd"===r){if(t.getFullYear()!==s.getFullYear()||t.getMonth()!==s.getMonth())return!1}else{const e=Number.parseInt(r,10);if(Number.isFinite(e)){if(t<new Date(s.getTime()-864e5*e))return!1}}}return!0})}filterCreditPlaybookLegPairs(e=[]){const t=this.creditPlaybookStrategy,i=this.creditPlaybookHorizon,r=this.creditPlaybookSymbol,a=this.currentDate instanceof Date?this.currentDate:new Date;return e.filter(e=>{if("all"!==t&&e.strategy!==t)return!1;if(r&&(!e.ticker||!e.ticker.includes(r)))return!1;if("all"!==i){const t=e.entryDate instanceof Date?e.entryDate:null;if(!t)return!1;if("ytd"===i){if(t.getFullYear()!==a.getFullYear())return!1}else if("mtd"===i){if(t.getFullYear()!==a.getFullYear()||t.getMonth()!==a.getMonth())return!1}else{const e=Number.parseInt(i,10);if(Number.isFinite(e)){if(t<new Date(a.getTime()-864e5*e))return!1}}}return!0})}applyCreditPlaybookSort(e=[]){const t=this.creditPlaybookSort?.key||"openedDate",i="asc"===this.creditPlaybookSort?.direction?"asc":"desc";return e.slice().sort((e,r)=>{const a=this.getSortableValue(e,t),s=this.getSortableValue(r,t),n=this.compareSortableValues(a,s);return"asc"===i?n:-n})}applyCreditPlaybookSortToLegPairs(e=[]){const t=this.creditPlaybookSort?.key||"entryDate",i="asc"===this.creditPlaybookSort?.direction?"asc":"desc";return e.slice().sort((e,r)=>{let a,s;switch(t){case"ticker":a=e.ticker||"",s=r.ticker||"";break;case"strategy":a=e.strategy||"",s=r.strategy||"";break;case"type":a=e.type||"",s=r.type||"";break;case"strike":a="string"==typeof e.strike&&e.strike.includes("/")?parseFloat(e.strike.split("/")[0])||0:Number(e.strike)||0,s="string"==typeof r.strike&&r.strike.includes("/")?parseFloat(r.strike.split("/")[0])||0:Number(r.strike)||0;break;case"status":a=e.isRolling?0:e.isExpired&&e.isOpen?2:e.isOpen?1:3,s=r.isRolling?0:r.isExpired&&r.isOpen?2:r.isOpen?1:3;break;case"quantity":a=Number(e.quantity)||0,s=Number(r.quantity)||0;break;case"pricePerContract":a=Number(e.pricePerContract)||0,s=Number(r.pricePerContract)||0;break;case"fees":a=Number(e.fees)||0,s=Number(r.fees)||0;break;case"premium":a=Number(e.premium)||0,s=Number(r.premium)||0;break;case"currentPrice":a=Number(e.currentPrice)||0,s=Number(r.currentPrice)||0;break;case"entryDate":a=e.entryDate instanceof Date?e.entryDate.getTime():0,s=r.entryDate instanceof Date?r.entryDate.getTime():0;break;case"expirationDate":a=e.expirationDate?new Date(e.expirationDate).getTime():0,s=r.expirationDate?new Date(r.expirationDate).getTime():0;break;case"dte":a=Number(e.dte)??1/0,s=Number(r.dte)??1/0;break;case"exitDate":a=e.exitDate instanceof Date?e.exitDate.getTime():0,s=r.exitDate instanceof Date?r.exitDate.getTime():0;break;case"daysHeld":a=Number(e.daysHeld)??0,s=Number(r.daysHeld)??0;break;default:a=e[t],s=r[t]}const n=this.compareSortableValues(a,s);return"asc"===i?n:-n})}applyCreditPlaybookSortIndicators(){const e=document.getElementById("credit-playbook-table");if(!e)return;e.querySelectorAll(".sortable").forEach(e=>{const t=e.getAttribute("data-sort")===this.creditPlaybookSort.key;e.classList.toggle("asc",t&&"asc"===this.creditPlaybookSort.direction),e.classList.toggle("desc",t&&"desc"===this.creditPlaybookSort.direction),e.setAttribute("aria-sort",t?"asc"===this.creditPlaybookSort.direction?"ascending":"descending":"none")})}renderCreditPlaybookMetrics(e=[]){const t=document.getElementById("credit-playbook-metrics");if(!t)return;t.innerHTML="";const i=e.length,r=e.filter(e=>e.isOpen).length,a=i-r,s=e.reduce((e,t)=>e+(Number(t.premium)||0),0),n=e.reduce((e,t)=>e+(Number(t.capital)||0),0),o=e.map(e=>Number(e.premium)).filter(Number.isFinite),l=e.map(e=>Number(e.capital)).filter(e=>Number.isFinite(e)&&e>0),c=o.length?s/o.length:null,d=l.length?n/l.length:null;[{label:"Positions",value:this.formatNumber(i,{decimals:0,useGrouping:!0})??String(i),sublabel:`${r} open • ${a} closed`},{label:"Total Premiums",value:this.formatCurrency(s),sublabel:"Net credit across filtered positions"},{label:"Avg Premium",value:Number.isFinite(c)?this.formatCurrency(c):"—",sublabel:o.length?`${o.length} trades with premium`:"No premium data"},{label:"Capital at Risk",value:this.formatCurrency(n),sublabel:l.length?`${l.length} trades with defined risk`:"No risk data available"},{label:"Avg Capital",value:Number.isFinite(d)?this.formatCurrency(d):"—",sublabel:"Per trade with capital defined"}].forEach(e=>{const i=document.createElement("div");i.className="card";const r=document.createElement("div");r.className="card__body";const a=document.createElement("div");a.className="card-value",a.textContent=e.value;const s=document.createElement("small");if(s.className="card-subtitle",s.textContent=e.label,r.appendChild(a),r.appendChild(s),e.sublabel){const t=document.createElement("span");t.className="credit-playbook-detail-meta",t.textContent=e.sublabel,r.appendChild(t)}i.appendChild(r),t.appendChild(i)})}renderCreditPlaybookTableFromLegPairs(e=[]){const t=document.getElementById("credit-playbook-table");if(!t)return;const i=t.querySelector("tbody");if(i){if(i.innerHTML="",!e.length){const e=i.insertRow().insertCell(),r=t.tHead?.rows?.[0]?.cells?.length||15;return e.colSpan=r,e.className="empty-table-message",void(e.textContent="No positions match the current filters.")}e.forEach(t=>{const r=i.insertRow();r.dataset.tradeId=t.tradeId||"",t.ticker&&(r.dataset.ticker=t.ticker);let a=0;r.insertCell(a++).appendChild(this.createTickerElement(t.ticker,"ticker-pill",{behavior:"filter",onClick:e=>this.openTradesFilteredByTicker(e),title:t.ticker?`View trades for ${t.ticker}`:""}));r.insertCell(a++).textContent=t.strategy||"—";const s=r.insertCell(a++),n=document.createElement("span");n.className="option-type-badge","CALL"===t.type?(n.classList.add("type-call"),n.textContent="CALL"):"PUT"===t.type?(n.classList.add("type-put"),n.textContent="PUT"):n.textContent=t.type||"—",s.appendChild(n);const o=r.insertCell(a++);"string"==typeof t.strike?o.textContent=t.strike:Number.isFinite(t.strike)?o.textContent=this.formatNumber(t.strike,{decimals:2,useGrouping:!1}):o.textContent="—";const l=r.insertCell(a++),c=document.createElement("span");let d,u;c.className="status-badge",t.isRolling?(d="rolling",u="Rolling"):t.isExpired&&t.isOpen?(d="expired",u="Expired"):t.isOpen?(d="open",u="Open"):(d="closed",u="Closed"),c.classList.add(d),c.textContent=u,l.appendChild(c);r.insertCell(a++).textContent=Number.isFinite(t.quantity)?t.quantity:"—";r.insertCell(a++).textContent=Number.isFinite(t.pricePerContract)?this.formatCurrency(t.pricePerContract):"—";const m=r.insertCell(a++);m.textContent=Number.isFinite(t.fees)?this.formatCurrency(Math.abs(t.fees)):"—",m.className="pl-negative";const h=r.insertCell(a++);h.textContent=Number.isFinite(t.premium)?this.formatCurrency(t.premium):"—",h.className=t.premium>=0?"pl-positive":"pl-negative";const p=r.insertCell(a++);if(p.className="quote-cell",t.isOpen&&"closed"!==d&&"expired"!==d){const i=`${`${t.ticker}|${t.tradeId}`}|creditPlaybook:${e.indexOf(t)}`;if(r.dataset.quoteKey=i,r.dataset.ticker=t.ticker,"string"==typeof t.strike&&t.strike.includes("/")){const e=t.strike.split("/").map(e=>parseFloat(e.trim()));r.dataset.strikePrice=String(e[0])}else Number.isFinite(t.strike)&&(r.dataset.strikePrice=String(t.strike));const a={ticker:t.ticker,optionType:t.type?.toLowerCase(),strategy:t.strategy,dte:t.dte};this.populateQuoteCell(p,a,r,{deferNetworkFetch:!0}),this.creditPlaybookQuoteEntries||(this.creditPlaybookQuoteEntries=new Map),this.creditPlaybookQuoteEntries.set(i,{trade:a,row:r,cell:p,key:i,pair:t})}else p.textContent="—";r.insertCell(a++).textContent=this.formatDate(t.entryDate);r.insertCell(a++).textContent=this.formatDate(t.expirationDate);const g=r.insertCell(a++);if(g.textContent=Number.isFinite(t.dte)?t.dte:"—",t.isOpen&&"closed"!==d){const e={dte:t.dte};this.updateExpirationHighlight(g,e)}r.insertCell(a++).textContent=t.exitDate?this.formatDate(t.exitDate):"—";r.insertCell(a++).textContent=Number.isFinite(t.daysHeld)?t.daysHeld:"—",this.applyResponsiveLabels(r,["Ticker","Strategy","Type","Strike Price","Status","Contracts","Price/Contract","Fees","Premium","Current Price","Entry Date","Expiration Date","DTE","Exit Date","Days Held"])}),this.creditPlaybookQuoteEntries&&this.creditPlaybookQuoteEntries.size>0&&(this.startQuoteAutoRefreshIfNeeded(),this.refreshCreditPlaybookQuotes({force:!0,immediate:!0}))}}extractCreditPlaybookLegPairs(e=[]){const t=[],i=this.currentDate instanceof Date?this.currentDate:new Date;return e.forEach(e=>{const r=e.trade,a=r?.legs||[];if(!a.length)return;(r.strategy||"").toLowerCase().includes("spread")?this.extractSpreadPair(r,a,i,t):this.extractIndividualLegPairs(r,a,i,t)}),t}extractSpreadPair(e,t,i,r){const a=t.filter(e=>"CALL"===e.type||"PUT"===e.type);if(0===a.length)return;const s=new Map;a.forEach(e=>{const t=e.expirationDate||"";s.has(t)||s.set(t,[]),s.get(t).push(e)});const n=s.size>1,o=(e.status||"").toLowerCase();if(n||("rolling"===o||"rolled"===o))this.extractRolledSpread(e,a,i,r);else{const t=Array.from(s.keys())[0],a=s.get(t);this.extractSingleSpread(e,a,t,i,r)}}extractRolledSpread(e,t,i,r){const a=t.slice().sort((e,t)=>{const i=this.parseDateValue(e.executionDate),r=this.parseDateValue(t.executionDate);return i&&r?i.getTime()-r.getTime():0}),s=a[0]?.type||"CALL";let n=0,o=0,l=0,c=null,d=null,u=null,m=[];const h=a.filter(e=>"OPEN"===this.getLegSide(e)),p=a.filter(e=>"CLOSE"===this.getLegSide(e));a.forEach(e=>{const t=this.getLegSide(e),i=this.getLegAction(e),r=Math.abs(Number(e.quantity)||0),a=Number(e.premium)||0,s=this.getLegMultiplier(e);if(n+=("SELL"===i?1:-1)*a*s*r,o+=Number(e.fees)||0,"OPEN"===t){l=Math.max(l,Math.abs(Number(e.quantity)||0)),u=e.expirationDate;const t=Number(e.strike);Number.isFinite(t)&&m.push(t)}const h=this.parseDateValue(e.executionDate);h&&((!c||h<c)&&(c=h),"CLOSE"===t&&(!d||h>d)&&(d=h))});const g=[...new Set(m)].sort((e,t)=>e-t),y=g.length>=2?`${g[0]}/${g[g.length-1]}`:1===g.length?String(g[0]):"—",f=u?this.parseDateValue(u):null,b=f&&f<i,C=h.length>0,S=p.length>0,T=C&&S,L=C&&!b,x=L&&f&&!T?Math.ceil((f.getTime()-i.getTime())/864e5):null,k=c&&(d||b)?Math.ceil(((d||f||i).getTime()-c.getTime())/864e5):c?Math.ceil((i.getTime()-c.getTime())/864e5):null,v=l>0?n/(100*l):0,N=g.length>=2?g[g.length-1]-g[0]:0,D=N>0?Math.abs(N*l*100):0,I=n-o,E=I,P=D>0?E/D*100:null;r.push({tradeId:e.id,ticker:e.ticker,strategy:e.strategy,strike:y,type:s,quantity:l,pricePerContract:v,fees:o,premium:I,entryDate:c,expirationDate:u,dte:x,exitDate:d||(b?f:null),daysHeld:k,pl:E,roi:P,isOpen:L,isExpired:b,isRolling:T,capital:D})}extractSingleSpread(e,t,i,r,a){const s=t.filter(e=>"OPEN"===this.getLegSide(e)),n=t.filter(e=>"CLOSE"===this.getLegSide(e)),o=s[0]?.type||n[0]?.type||"CALL",l=s.map(e=>Number(e.strike)).filter(e=>Number.isFinite(e)),c=l.length>=2?`${Math.min(...l)}/${Math.max(...l)}`:1===l.length?String(l[0]):"—";let d=0,u=0,m=null,h=null,p=0;s.forEach(e=>{const t=this.getLegAction(e),i=Math.abs(Number(e.quantity)||0),r=Number(e.premium)||0,a=this.getLegMultiplier(e);d+=("SELL"===t?1:-1)*r*a*i,u+=Number(e.fees)||0,p=Math.max(p,Math.abs(Number(e.quantity)||0));const s=this.parseDateValue(e.executionDate);s&&(!m||s<m)&&(m=s)}),n.forEach(e=>{const t=this.getLegAction(e),i=Math.abs(Number(e.quantity)||0),r=Number(e.premium)||0,a=this.getLegMultiplier(e);d+=("SELL"===t?1:-1)*r*a*i,u+=Number(e.fees)||0;const s=this.parseDateValue(e.executionDate);s&&(!h||s>h)&&(h=s)});const g=this.parseDateValue(i),y=g&&g<r,f=s.length>0&&0===n.length&&!y,b=f&&g?Math.ceil((g.getTime()-r.getTime())/864e5):null,C=m&&(h||y)?Math.ceil(((h||g||r).getTime()-m.getTime())/864e5):m?Math.ceil((r.getTime()-m.getTime())/864e5):null,S=p>0?d/(100*p):0,T=l.length>=2?Math.max(...l)-Math.min(...l):0,L=T>0?Math.abs(T*p*100):0,x=d-u,k=x,v=L>0?k/L*100:null;a.push({tradeId:e.id,ticker:e.ticker,strategy:e.strategy,strike:c,type:o,quantity:p,pricePerContract:S,fees:u,premium:x,entryDate:m,expirationDate:i,dte:b,exitDate:h||(y?g:null),daysHeld:C,pl:k,roi:v,isOpen:f,isExpired:y,isRolling:!1,capital:L})}extractIndividualLegPairs(e,t,i,r){const a=new Map;t.forEach(e=>{if("CALL"!==e.type&&"PUT"!==e.type)return;const t=Number(e.strike),i=`${e.type}|${t}`;a.has(i)||a.set(i,[]),a.get(i).push(e)}),a.forEach((t,a)=>{const[s,n]=a.split("|"),o=Number(n),l=new Map;t.forEach(e=>{const t=e.expirationDate||"";l.has(t)||l.set(t,[]),l.get(t).push(e)});const c=l.size>1,d=(e.status||"").toLowerCase();c||("rolling"===d||"rolled"===d)?this.extractRolledPosition(e,t,o,s,i,r):l.forEach((t,a)=>{this.extractSingleLegPair(e,t,o,s,a,i,r)})})}extractRolledPosition(e,t,i,r,a,s){const n=t.slice().sort((e,t)=>{const i=this.parseDateValue(e.executionDate),r=this.parseDateValue(t.executionDate);return i&&r?i.getTime()-r.getTime():0});let o=0,l=0,c=0,d=null,u=null,m=null;n.forEach(e=>{const t=this.getLegSide(e),i=this.getLegAction(e),r=Math.abs(Number(e.quantity)||0),a=Number(e.premium)||0,s=this.getLegMultiplier(e);o+=("SELL"===i?1:-1)*a*s*r,l+=Number(e.fees)||0,"OPEN"===t?"SELL"===i?(c+=r,m=e.expirationDate):"BUY"===i&&(c-=r):"CLOSE"===t&&("BUY"===i?c-=r:"SELL"===i&&(c+=r));const n=this.parseDateValue(e.executionDate);n&&((!d||n<d)&&(d=n),"CLOSE"===t&&(!u||n>u)&&(u=n))});const h=m?this.parseDateValue(m):null,p=h&&h<a,g=n.some(e=>"OPEN"===this.getLegSide(e)),y=n.some(e=>"CLOSE"===this.getLegSide(e)),f=g&&y&&0!==c,b=0!==c&&!p;0!==c||b||(c=Math.abs(n.filter(e=>"OPEN"===this.getLegSide(e)).reduce((e,t)=>e+Math.abs(Number(t.quantity)||0),0)));const C=Math.abs(c),S=b&&h&&!f?Math.ceil((h.getTime()-a.getTime())/864e5):null,T=d&&(u||p)?Math.ceil(((u||h||a).getTime()-d.getTime())/864e5):d?Math.ceil((a.getTime()-d.getTime())/864e5):null,L=C>0?o/(100*C):0,x=Math.abs(i*C*100),k=o-l,v=k,N=x>0?v/x*100:null;s.push({tradeId:e.id,ticker:e.ticker,strategy:e.strategy,strike:i,type:r,quantity:C,pricePerContract:L,fees:l,premium:k,entryDate:d,expirationDate:m,dte:S,exitDate:u||(p?h:null),daysHeld:T,pl:v,roi:N,isOpen:b,isExpired:p,isRolling:f,capital:x})}extractSingleLegPair(e,t,i,r,a,s,n){const o=t.filter(e=>"OPEN"===this.getLegSide(e)),l=t.filter(e=>"CLOSE"===this.getLegSide(e));let c=0,d=0,u=0,m=null,h=null;o.forEach(e=>{const t=this.getLegAction(e),i=Math.abs(Number(e.quantity)||0),r=Number(e.premium)||0,a=this.getLegMultiplier(e);"SELL"===t?c+=i:"BUY"===t&&(c-=i),d+=("SELL"===t?1:-1)*r*a*i,u+=Number(e.fees)||0;const s=this.parseDateValue(e.executionDate);s&&(!m||s<m)&&(m=s)}),l.forEach(e=>{const t=this.getLegAction(e),i=Math.abs(Number(e.quantity)||0),r=Number(e.premium)||0,a=this.getLegMultiplier(e);"BUY"===t?c-=i:"SELL"===t&&(c+=i),d+=("SELL"===t?1:-1)*r*a*i,u+=Number(e.fees)||0;const s=this.parseDateValue(e.executionDate);s&&(!h||s>h)&&(h=s)});const p=this.parseDateValue(a),g=p&&p<s,y=o.length>0&&0===l.length&&!g;0!==c||y||(c=Math.abs(o.reduce((e,t)=>Math.max(e,Math.abs(Number(t.quantity)||0)),0)));const f=Math.abs(c),b=y&&p?Math.ceil((p.getTime()-s.getTime())/864e5):null,C=m&&(h||g)?Math.ceil(((h||p||s).getTime()-m.getTime())/864e5):m?Math.ceil((s.getTime()-m.getTime())/864e5):null,S=f>0?d/(100*f):0,T=Math.abs(i*f*100),L=d-u,x=L,k=T>0?x/T*100:null;n.push({tradeId:e.id,ticker:e.ticker,strategy:e.strategy,strike:i,type:r,quantity:f,pricePerContract:S,fees:u,premium:L,entryDate:m,expirationDate:a,dte:b,exitDate:h||(g?p:null),daysHeld:C,pl:x,roi:k,isOpen:y,isExpired:g,isRolling:!1,capital:T})}renderCreditPlaybookDetailCell(e,t){e.innerHTML="";const i=document.createElement("div");i.className="credit-stage-group",e.appendChild(i);const r=t.summary,a=r?.primaryLeg;if(a){const e=this.getLegAction(a)||"",r=(a.type||"").toUpperCase(),s=Number(a.strike),n=a.expirationDate;let o=e?`${e.charAt(0)}${e.slice(1).toLowerCase()}`:"";if(Number.isFinite(s)&&["CALL","PUT"].includes(r)){if(o=`${o?`${o} `:""}${this.formatNumber(s,{decimals:2,useGrouping:!1})??s.toFixed(2)}${"CALL"===r?"C":"P"}`,n){const e=this.formatDate(n);e&&"—"!==e&&(o+=` ${e}`)}}else r&&(o=`${o?`${o} `:""}${r}`);i.appendChild(this.createCreditStage(o||t.strategy,"primary"))}else i.appendChild(this.createCreditStage(t.strategy||t.ticker,"primary"));if(r&&r.legsCount>1){const e=[];r.openLegs>0&&e.push(`${r.openLegs} open`),r.closeLegs>0&&e.push(`${r.closeLegs} close`),r.rollLegs>0&&e.push(`${r.rollLegs} roll`);const t=e.length?`${r.legsCount} legs (${e.join(", ")})`:`${r.legsCount} legs`;i.appendChild(this.createCreditStage(t))}if(Number.isFinite(t.premium)&&0!==t.premium){const e=t.premium>=0?`Credit ${this.formatCurrency(t.premium)}`:`Debit ${this.formatCurrency(Math.abs(t.premium))}`;i.appendChild(this.createCreditStage(e))}if(t.contracts>0){const e=`${t.contracts} contract${1===t.contracts?"":"s"}`;i.appendChild(this.createCreditStage(e))}if(t.expirationLabel){const e=this.formatDate(t.expirationLabel);if(e&&"—"!==e){const r=Number(t.dte),a=Number.isFinite(r)&&r<=this.positionHighlightConfig.expirationCriticalDays?"warning":"default",s=Number.isFinite(r)?` (${r}d)`:"";i.appendChild(this.createCreditStage(`Exp ${e}${s}`,a))}}const s=[];if(Number.isFinite(r?.entryPrice)&&r.entryPrice>0&&s.push(`Entry ${this.formatCurrency(r.entryPrice)}`),Number.isFinite(r?.exitPrice)&&r.exitPrice>0&&s.push(`Exit ${this.formatCurrency(r.exitPrice)}`),Number.isFinite(t.capitalAtRisk)&&t.capitalAtRisk>0&&s.push(`Risk ${this.formatCurrency(t.capitalAtRisk)}`),Number.isFinite(t.capitalPerContract)&&t.capitalPerContract>0&&s.push(`Risk/contract ${this.formatCurrency(t.capitalPerContract)}`),Number.isFinite(t.premiumPerContract)){const e=t.premiumPerContract>=0?`Credit/contract ${this.formatCurrency(t.premiumPerContract)}`:`Debit/contract ${this.formatCurrency(Math.abs(t.premiumPerContract))}`;s.push(e)}if(Number.isFinite(r?.totalFees)&&r.totalFees>0&&s.push(`Fees ${this.formatCurrency(r.totalFees)}`),s.length){const t=document.createElement("span");t.className="credit-playbook-detail-meta",t.textContent=s.join(" • "),e.appendChild(t)}}createCreditStage(e,t="default"){const i=document.createElement("span");return i.className="credit-stage",t&&"default"!==t&&i.classList.add(`credit-stage--${t}`),i.textContent=e,i}sortCreditPlaybook(e){if(!e)return;const t=this.creditPlaybookSort?.key,i=this.creditPlaybookSort?.direction||"desc",r=t===e,a=r&&"asc"===i?"desc":"asc";this.creditPlaybookSort={key:e,direction:r?a:"openedDate"===e?"desc":"asc"},this.applyCreditPlaybookSortIndicators(),this.updateCreditPlaybookView()}updateAllCharts(){this.updateMonthlyPLChart(),this.updateCumulativePLChart(),this.updateStrategyPerformanceChart(),this.updateWinRateByStrategyChart(),this.updatePerformanceGauges(),this.updateCommissionImpactChart(),this.updateTimeInTradeChart(),this.updateMonteCarloChart(),this.renderTickerHeatmap()}updatePerformanceGauges(){const e=this.latestStats;this.renderRatioGauge({chartKey:"sharpeGauge",canvasId:"sharpeGaugeChart",valueElementId:"sharpeGaugeValue",value:e?.sharpeRatio,min:-1,max:3}),this.renderRatioGauge({chartKey:"sortinoGauge",canvasId:"sortinoGaugeChart",valueElementId:"sortinoGaugeValue",value:e?.sortinoRatio,min:-1,max:4})}renderRatioGauge({chartKey:e,canvasId:t,valueElementId:i,value:r,min:a=0,max:s=1}){const n=document.getElementById(i);n&&(n.textContent=this.formatNumber(r,{decimals:2,useGrouping:!1})??"—");const o=document.getElementById(t);if(!o)return;if(!Number.isFinite(r))return void(this.charts[e]&&(this.charts[e].destroy(),delete this.charts[e]));const l=o.getContext("2d");if(!l)return;const c=(Math.min(Math.max(r,a),s)-a)/Math.max(s-a,1),d=Number.isFinite(c)?Math.max(Math.min(c,1),0):0,u=Math.max(1-d,0),m=r>=1.5?"#1FB8CD":r>=.75?"#FFC185":"#B4413C",h=this.formatNumber(r,{decimals:2,useGrouping:!1})??(Number.isFinite(r)?r.toFixed(2):"—");this.charts[e]&&this.charts[e].destroy(),this.charts[e]=new Chart(l,{type:"doughnut",data:{labels:["Ratio","Remaining"],datasets:[{data:[d,u],backgroundColor:[m,"rgba(148, 163, 184, 0.25)"],borderWidth:0}]},options:{responsive:!0,maintainAspectRatio:!1,rotation:-90,circumference:180,cutout:"70%",plugins:{legend:{display:!1},tooltip:{callbacks:{label:()=>`Ratio: ${h}`}}}}})}updateCommissionImpactChart(){const e=document.getElementById("commissionImpactChart"),t=document.getElementById("commissionImpactSummary"),i=this.latestStats;if(!e)return;if(!i)return t&&(t.textContent="No closed trades yet."),void(this.charts.commissionImpact&&(this.charts.commissionImpact.destroy(),delete this.charts.commissionImpact));const r=Number(i.totalFees)||0,a=Number(i.totalPL)||0,s=Number(i.feeShareOfGross)||0;if(t)if(0===r&&0===a)t.textContent="No closed trades yet.";else{const e=this.formatNumber(s,{decimals:1,useGrouping:!0})??"0.0";t.textContent=`${this.formatCurrency(r)} in fees (${e}% of realized turnover).`}const n=e.getContext("2d");if(!n)return;this.charts.commissionImpact&&this.charts.commissionImpact.destroy();const o=(e,t=2)=>this.formatCurrency(e,{decimals:t});this.charts.commissionImpact=new Chart(n,{type:"bar",data:{labels:["Net P&L","Fees"],datasets:[{label:"Amount",data:[a,r],backgroundColor:[a>=0?"#1FB8CD":"#B4413C","#B4413C"],borderRadius:8,borderSkipped:!1}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,scales:{x:{ticks:{callback:e=>o(e,0)},grid:{drawBorder:!1}},y:{grid:{display:!1}}},plugins:{legend:{display:!1},tooltip:{callbacks:{label:e=>`${e.label}: ${o(e.raw)}`}}}}})}renderTickerHeatmap(){const e=document.getElementById("tickerHeatmap");if(!e)return;e.innerHTML="";const t=this.latestStats,i=t?.tickerPerformance?.items||[];if(!i.length){const t=document.createElement("div");return t.className="heatmap-empty",t.textContent="Add more closed trades to see per-ticker performance.",void e.appendChild(t)}const r=t?.tickerPerformance?.maxMagnitude||1;i.slice(0,12).forEach(t=>{const i=document.createElement("div");i.className="heatmap-card";const a=t.totalPL>=0?[31,184,205]:[180,65,60],s=.15+.55*(r>0?Math.min(Math.abs(t.totalPL)/r,1):0),n=Math.min(s+.1,.9);i.style.backgroundColor=`rgba(${a[0]}, ${a[1]}, ${a[2]}, ${s.toFixed(2)})`,i.style.borderColor=`rgba(${a[0]}, ${a[1]}, ${a[2]}, ${n.toFixed(2)})`;const o=document.createElement("div");o.className="heatmap-card__ticker",o.textContent=t.ticker;const l=document.createElement("div");l.className="heatmap-card__pl "+(t.totalPL>=0?"pl-positive":"pl-negative"),l.textContent=this.formatCurrency(t.totalPL);const c=document.createElement("div");c.className="heatmap-card__meta";const d=this.formatNumber(t.tradeCount,{decimals:0,useGrouping:!0})??String(t.tradeCount??0),u=this.formatPercent(t.winRate,"0%",{decimals:0});c.textContent=`${d} trades • Win ${u}`,i.appendChild(o),i.appendChild(l),i.appendChild(c),e.appendChild(i)})}updateTimeInTradeChart(){const e=document.getElementById("timeInTradeChart"),t=this.latestStats;if(!e)return;if(!t||0===t.closedTrades||!Number.isFinite(t.avgWinnerDays)&&!Number.isFinite(t.avgLoserDays))return void(this.charts.timeInTrade&&(this.charts.timeInTrade.destroy(),delete this.charts.timeInTrade));const i=e.getContext("2d");if(!i)return;this.charts.timeInTrade&&this.charts.timeInTrade.destroy();const r=Number.isFinite(t.avgWinnerDays)?t.avgWinnerDays:0,a=Number.isFinite(t.avgLoserDays)?t.avgLoserDays:0,s=(e,t=1)=>{const i=Number(e);return Number.isFinite(i)?this.formatNumber(i,{decimals:t,useGrouping:!0})??i.toFixed(t):""};this.charts.timeInTrade=new Chart(i,{type:"bar",data:{labels:["Winners","Losers"],datasets:[{label:"Average Days Held",data:[r,a],backgroundColor:["#1FB8CD","#B4413C"],borderRadius:8,borderSkipped:!1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{callback:e=>{const t=s(e,0);return t?`${t}d`:`${e}d`}},grid:{drawBorder:!1}},x:{grid:{display:!1}}},plugins:{legend:{display:!1},tooltip:{callbacks:{label:e=>{const t=s(e.raw,1);return`${e.label}: ${t||e.raw} days`}}}}}})}updateMonteCarloChart(){const e=document.getElementById("monteCarloChart"),t=document.getElementById("monteCarloSummary"),i=this.latestStats;if(!e)return;if(!i||!Array.isArray(i.dailyReturns)||i.dailyReturns.length<2)return t&&(t.textContent="Need more closed trades to run projections."),void(this.charts.monteCarlo&&(this.charts.monteCarlo.destroy(),delete this.charts.monteCarlo));const r=this.generateMonteCarloProjection(i.dailyReturns,{periods:60,simulations:400});if(!r)return t&&(t.textContent="Need more closed trades to run projections."),void(this.charts.monteCarlo&&(this.charts.monteCarlo.destroy(),delete this.charts.monteCarlo));const a=e.getContext("2d");if(!a)return;this.charts.monteCarlo&&this.charts.monteCarlo.destroy();const s=r.percentiles.p50[r.percentiles.p50.length-1]||1;if(t){const e=100*(s-1),i=this.formatNumber(Math.abs(e),{decimals:1,useGrouping:!0})??Math.abs(e).toFixed(1),r=e>=0?"+":"-";t.textContent=`Median path suggests ${r}${i}% over 60 trading days.`}const n=e=>{const t=100*(Number(e)-1);return`${t>=0?"+":"-"}${this.formatNumber(Math.abs(t),{decimals:1,useGrouping:!0})??Math.abs(t).toFixed(1)}%`},o={id:"monteCarloBaseline",afterDatasetsDraw:e=>{this.ensureMonteCarloBaseline(e)}};this.charts.monteCarlo=new Chart(a,{type:"line",data:{labels:r.labels,datasets:[{label:"10th percentile",data:r.percentiles.p10,borderColor:"rgba(180, 65, 60, 0.6)",backgroundColor:"rgba(180, 65, 60, 0.12)",borderWidth:1.5,fill:!1,tension:.25},{label:"90th percentile",data:r.percentiles.p90,borderColor:"rgba(31, 184, 205, 0.6)",backgroundColor:"rgba(31, 184, 205, 0.12)",borderWidth:1.5,fill:"-1",tension:.25},{label:"Median",data:r.percentiles.p50,borderColor:"#1FB8CD",borderWidth:2,tension:.25,fill:!1}]},options:{responsive:!0,maintainAspectRatio:!1,interaction:{intersect:!1,mode:"index"},scales:{y:{ticks:{callback:e=>n(e)},grid:{drawBorder:!1}},x:{grid:{display:!1},ticks:{maxTicksLimit:12}}},plugins:{legend:{position:"bottom"},tooltip:{callbacks:{label:e=>`${e.dataset.label}: ${n(e.parsed.y)}`}}}},plugins:[o]})}ensureMonteCarloBaseline(e){if(!e)return;const t=e.ctx,i=e.scales?.y,r=e.chartArea;if(!t||!i||!r)return;const a=i.getPixelForValue(1);Number.isFinite(a)&&(t.save(),t.beginPath(),t.moveTo(r.left,a),t.lineTo(r.right,a),t.lineWidth=1.5,t.strokeStyle="rgba(146, 149, 152, 0.85)",t.setLineDash([]),t.stroke(),t.restore())}generateMonteCarloProjection(e=[],{periods:t=60,simulations:i=400}={}){if(!Array.isArray(e)||0===e.length)return null;const r=e.filter(e=>Number.isFinite(e));if(!r.length)return null;const a=Array.from({length:t},()=>[]);for(let e=0;e<i;e+=1){let e=1;for(let i=0;i<t;i+=1){let t=r[Math.floor(Math.random()*r.length)];Number.isFinite(t)||(t=0),t=Math.max(-.95,Math.min(t,5)),e*=1+t,e=Math.max(e,0),a[i].push(Number(e.toFixed(6)))}}const s=[.1,.25,.5,.75,.9],n=s.map(()=>[]);return a.forEach(e=>{if(!e.length)return void s.forEach((e,t)=>n[t].push(1));const t=e.slice().sort((e,t)=>e-t);s.forEach((e,i)=>{const r=(t.length-1)*e,a=Math.floor(r),s=Math.ceil(r);if(a===s)return void n[i].push(t[a]);const o=t[a],l=o+(t[s]-o)*(r-a);n[i].push(Number(l.toFixed(6)))})}),{labels:Array.from({length:t},(e,t)=>`Day ${t+1}`),percentiles:{p10:n[0],p25:n[1],p50:n[2],p75:n[3],p90:n[4]}}}initializeGeminiControls(){const e=document.getElementById("gemini-controls");if(!e)return;const t=document.getElementById("gemini-api-key"),i=document.getElementById("gemini-model"),r=document.getElementById("gemini-save"),a=document.getElementById("gemini-clear"),s=document.getElementById("gemini-status");if(this.gemini.elements={container:e,keyInput:t,modelSelect:i,saveButton:r,clearButton:a,status:s},GEMINI_ALLOWED_MODELS.includes(this.gemini.model)||(this.gemini.model=DEFAULT_GEMINI_MODEL),i){0===Array.from(i.options).map(e=>e.value).length&&GEMINI_ALLOWED_MODELS.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e.replace(/gemini-2\.5-/,"Gemini 2.5 ").replace(/-/g," ").replace(/\b([a-z])/g,(e,t)=>t.toUpperCase()),i.appendChild(t)});const e=GEMINI_ALLOWED_MODELS.includes(this.gemini.model)?this.gemini.model:DEFAULT_GEMINI_MODEL;i.value=e,this.gemini.model!==e&&this.setGeminiModel(e),i.addEventListener("change",e=>{const t=e.target.value;console.log("Gemini model dropdown changed to:",t),this.setGeminiModel(t),this.saveGeminiConfigToStorage()})}this.syncGeminiControlsFromState({preserveStatus:Boolean(this.gemini.pendingStatus)});const n=async()=>{const e=(t?.value||"").trim();this.setGeminiApiKey(e,{persist:!1,updateUI:!1});const i=this.gemini.apiKey,r=this.getCrypto();if(!e)return this.removeGeminiEncryptionKey(),this.saveGeminiConfigToStorage(),t&&(t.value=""),this.updateGeminiStatus("API key cleared. Connect your Gemini key via Settings to get tailored analysis.","neutral",6e3),this.initializeAIChat(),void this.updateAIChatHeader();if(!r?.subtle)return this.saveGeminiConfigToStorage({includeApiKey:!0}),this.updateGeminiStatus("Gemini API key saved (unencrypted — Web Crypto unavailable).","success",6e3),t&&(t.value=i),this.initializeAIChat(),void this.updateAIChatHeader();await this.encryptAndStoreGeminiApiKey(r)?this.updateGeminiStatus("Gemini API key saved securely.","success",5e3):(this.saveGeminiConfigToStorage({includeApiKey:!0}),this.updateGeminiStatus("Gemini API key saved (unencrypted fallback).","neutral",6e3)),t&&(t.value=i),this.initializeAIChat(),this.updateAIChatHeader()};r?.addEventListener("click",async e=>{e.preventDefault(),await n()}),t?.addEventListener("keydown",async e=>{"Enter"===e.key&&(e.preventDefault(),await n())}),a?.addEventListener("click",e=>{e.preventDefault(),t&&(t.value=""),this.setGeminiApiKey("",{persist:!1,updateUI:!1}),this.removeGeminiEncryptionKey(),this.saveGeminiConfigToStorage(),this.updateGeminiStatus("API key cleared. Connect your Gemini key via Settings to get tailored analysis.","neutral",6e3),this.initializeAIChat(),this.updateAIChatHeader()}),this.updateAIChatHeader(),this.flushPendingGeminiStatus()}syncGeminiControlsFromState({preserveStatus:e=!0}={}){const t=this.gemini?.elements?.keyInput,i=this.gemini?.apiKey?this.gemini.apiKey:"";t&&t.value!==i&&(t.value=i);const r=this.gemini?.elements?.modelSelect;r&&this.gemini?.model&&r.value!==this.gemini.model&&(r.value=this.gemini.model);const a=Boolean(i),s=!e&&!this.gemini?.pendingStatus,n=e&&!this.gemini?.lastStatus&&!this.gemini?.pendingStatus;if((s||n)&&this.updateGeminiStatus){const e=a?"API key loaded":"Not set",t=a?"success":"neutral";this.updateGeminiStatus(e,t)}this.updateAIChatHeader()}flushPendingGeminiStatus(){const e=this.gemini?.pendingStatus;e&&(this.updateGeminiStatus(e.message,e.variant,e.autoClearMs),this.gemini.pendingStatus=null)}getGeminiModelLabel(e=""){const t=(e||"").toLowerCase(),i={"gemini-2.5-flash-lite":"Gemini 2.5 Flash Lite","gemini-2.5-flash":"Gemini 2.5 Flash","gemini-2.5-pro":"Gemini 2.5 Pro"};if(i[t])return i[t];if(!t)return"";return t.replace(/^gemini[-\s]?/i,"Gemini ").replace(/-/g," ").replace(/\b([a-z])/g,(e,t)=>t.toUpperCase()).trim()||"Gemini"}getGeminiChatDisplayName(){const e=this.getGeminiModelLabel(this.gemini?.model);return e||"Gemini"}updateAIChatHeader(){const e=document.getElementById("ai-chat-title"),t=document.getElementById("ai-chat-subtitle");if(!e&&!t)return;if(e&&(e.textContent="Portfolio AI Coach"),!t)return;const i=Boolean(this.gemini?.apiKey),r=this.hasAICoachConsent();if(i)t.textContent=r?"Ask about your portfolio for AI-guided insights.":"Review and accept the AI Coach data-sharing notice to start asking questions.";else{t.textContent="";const e=document.createTextNode("Connect your Gemini API key in "),i=document.createElement("a");i.href="#settings",i.className="ai-chat__settings-link",i.textContent="Settings";const r=document.createTextNode(" to get tailored analysis.");t.appendChild(e),t.appendChild(i),t.appendChild(r)}}updateGeminiStatus(e,t="neutral",i=0){const r=this.gemini?.elements?.status;if(!r||!e)return;const a=["success","error","neutral"].includes(t)?t:"neutral";r.textContent=e,r.classList.remove("is-success","is-error"),"success"===a?r.classList.add("is-success"):"error"===a&&r.classList.add("is-error"),this.gemini.statusTimeoutId&&clearTimeout(this.gemini.statusTimeoutId),this.gemini.lastStatus={message:e,variant:a},this.gemini.pendingStatus=null,i>0&&(this.gemini.statusTimeoutId=setTimeout(()=>{r.isConnected&&(r.textContent="neutral"===a?"Not set":"",r.classList.remove("is-success","is-error"))},i))}setGeminiApiKey(e,{persist:t=!1,updateUI:i=!0}={}){const r=(e||"").trim();r!==this.gemini.apiKey&&(this.gemini.apiKey=r,i&&this.gemini.elements?.keyInput&&(this.gemini.elements.keyInput.value=r),t&&this.saveGeminiConfigToStorage({includeApiKey:!0}))}setGeminiModel(e){const t=(e||"").trim(),i=GEMINI_ALLOWED_MODELS.includes(t)?t:DEFAULT_GEMINI_MODEL,r=this.gemini.model;this.gemini.model=i;const a=this.gemini.elements?.modelSelect;a&&a.value!==this.gemini.model&&(a.value=this.gemini.model),this.gemini.model!==r&&(this.updateAIChatHeader(),this.renderAIChatMessages())}async loadGeminiConfigFromStorage(){let e="",t=null;try{const i=this.safeLocalStorage.getItem(GEMINI_STORAGE_KEY);if(!i)return this.setGeminiApiKey("",{persist:!1,updateUI:!1}),this.gemini.pendingStatus=null,this.syncGeminiControlsFromState({preserveStatus:!0}),!1;const r=JSON.parse(i);if(!r||"object"!=typeof r)return this.setGeminiApiKey("",{persist:!1,updateUI:!1}),this.gemini.pendingStatus=null,this.syncGeminiControlsFromState({preserveStatus:!0}),!1;if("string"==typeof r.model&&r.model.trim()&&this.setGeminiModel(r.model.trim()),r.enc&&r.payload){const i=this.getCrypto();if(i?.subtle)try{const t=await this.ensureGeminiEncryptionKey(i);if(!t)throw new Error("Encryption key unavailable");const a=await this.decryptString(r.payload,i,t);"string"==typeof a&&(e=a.trim())}catch(e){console.warn("Failed to decrypt stored Gemini API key:",e),t={message:"Failed to decrypt stored Gemini API key. Please re-enter it in Settings.",variant:"error",autoClearMs:9e3}}else console.warn("Encrypted Gemini API key stored but Web Crypto unavailable."),t={message:"Stored Gemini API key is encrypted, but this browser cannot decrypt it. Please re-enter it in Settings.",variant:"error",autoClearMs:9e3}}if(e||"string"!=typeof r.apiKey||(e=r.apiKey.trim()),!e&&"string"==typeof r.fallback&&r.fallback.trim())try{e=atob(r.fallback.trim()).trim()}catch(e){console.warn("Failed to decode Gemini API key fallback:",e)}e&&t&&(t={message:"Gemini API key loaded from local backup. Save it again to refresh secure storage when possible.",variant:"neutral",autoClearMs:9e3})}catch(e){console.warn("Failed to load Gemini configuration:",e),t||(t={message:"Failed to load Gemini configuration. Please verify your stored Gemini API key.",variant:"error",autoClearMs:9e3})}return this.setGeminiApiKey(e,{persist:!1,updateUI:!1}),this.gemini.pendingStatus=t,this.syncGeminiControlsFromState({preserveStatus:Boolean(t)}),Boolean(e)}saveGeminiConfigToStorage({includeApiKey:e=!1,encryptedPayload:t=null}={}){try{const i={model:this.gemini.model};if(t){if(i.enc=!0,i.payload=t,this.gemini.apiKey)try{i.fallback=btoa(this.gemini.apiKey)}catch(e){}}else if(e&&this.gemini.apiKey)i.apiKey=this.gemini.apiKey;else try{const e=this.safeLocalStorage.getItem(GEMINI_STORAGE_KEY);if(e){const t=JSON.parse(e);t?.enc&&t?.payload?(i.enc=!0,i.payload=t.payload,t.fallback&&(i.fallback=t.fallback)):t?.apiKey&&(i.apiKey=t.apiKey)}}catch(e){console.warn("Failed to preserve existing Gemini API key during save:",e)}this.safeLocalStorage.setItem(GEMINI_STORAGE_KEY,JSON.stringify(i))}catch(e){console.warn("Failed to save Gemini configuration:",e)}}removeGeminiEncryptionKey(){try{this.safeLocalStorage.removeItem(GEMINI_SECRET_STORAGE_KEY),this.gemini.encryptionKey=null}catch(e){console.warn("Failed to remove Gemini encryption key:",e)}}async ensureGeminiEncryptionKey(e=this.getCrypto()){if(!e?.subtle)return null;if(this.gemini.encryptionKey)return this.gemini.encryptionKey;let t=this.safeLocalStorage.getItem(GEMINI_SECRET_STORAGE_KEY);if(!t){const i=e.getRandomValues(new Uint8Array(32));t=this.arrayBufferToBase64(i.buffer),this.safeLocalStorage.setItem(GEMINI_SECRET_STORAGE_KEY,t)}const i=new Uint8Array(this.base64ToArrayBuffer(t)),r=await e.subtle.importKey("raw",i,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"]);return this.gemini.encryptionKey=r,r}async encryptAndStoreGeminiApiKey(e=this.getCrypto()){try{if(!e?.subtle)throw new Error("Web Crypto API unavailable");const t=this.gemini.apiKey||"";if(!t)return this.saveGeminiConfigToStorage(),!0;const i=await this.ensureGeminiEncryptionKey(e);if(!i)throw new Error("Failed to prepare encryption key");const r=await this.encryptString(t,e,i);return this.saveGeminiConfigToStorage({encryptedPayload:r}),!0}catch(e){return console.warn("Failed to encrypt Gemini API key:",e),!1}}initializeFinnhubControls(){const e=document.getElementById("finnhub-controls");if(!e)return;const t=document.getElementById("finnhub-api-key"),i=document.getElementById("finnhub-save"),r=document.getElementById("finnhub-status");if(this.finnhub.elements={container:e,input:t,saveButton:i,status:r},t&&(t.value=this.finnhub.apiKey),r){const e=this.finnhub.apiKey?"success":"neutral",t=this.finnhub.apiKey?"API key loaded":"Not set";this.updateFinnhubStatus(t,e,4e3)}const a=async()=>{const e=(t?.value||"").trim();this.setFinnhubApiKey(e,{persist:!1,updateUI:!0,markUnsaved:!1});const i=this.getCrypto();if(!e)return this.removeFinnhubConfigFromStorage(),this.updateFinnhubStatus("API key cleared. Live prices disabled.","neutral",5e3),void this.updateActivePositionsTable();if(!i?.subtle)return this.saveFinnhubConfigToStorage(),this.updateFinnhubStatus("Finnhub API key saved (unencrypted — Web Crypto unavailable).","success",6e3),void this.updateActivePositionsTable();await this.encryptAndStoreFinnhubApiKey(i)?this.updateFinnhubStatus("Finnhub API key saved securely.","success",5e3):(this.saveFinnhubConfigToStorage(),this.updateFinnhubStatus("Finnhub API key saved (unencrypted fallback).","neutral",6e3)),this.updateActivePositionsTable()};i?.addEventListener("click",async e=>{e.preventDefault(),await a()}),t?.addEventListener("keydown",async e=>{"Enter"===e.key&&(e.preventDefault(),await a())})}initializeDisclaimerBanner(){const e=document.getElementById("disclaimer-banner");if(!e)return;this.disclaimerBanner.agreeButton&&this.disclaimerBanner.agreeHandler&&this.disclaimerBanner.agreeButton.removeEventListener("click",this.disclaimerBanner.agreeHandler);const t=e.querySelector('[data-action="disclaimer-agree"]'),i=e.querySelector(".disclaimer-banner__body");this.disclaimerBanner.element=e,this.disclaimerBanner.body=i,this.disclaimerBanner.agreeButton=t;const r=()=>this.acceptDisclaimer();this.disclaimerBanner.agreeHandler=r,t&&t.addEventListener("click",r);this.getDisclaimerAcceptance()?this.hideDisclaimerBanner({immediate:!0}):this.showDisclaimerBanner()}showDisclaimerBanner(){const e=this.disclaimerBanner?.element;e&&(this.disclaimerBanner.hideTimeoutId&&(clearTimeout(this.disclaimerBanner.hideTimeoutId),this.disclaimerBanner.hideTimeoutId=null),e.classList.remove("is-hidden"),requestAnimationFrame(()=>{e.classList.add("is-visible"),e.setAttribute("aria-hidden","false");const t=this.disclaimerBanner?.body;if(t&&"function"==typeof t.focus)try{t.focus({preventScroll:!0})}catch(e){t.focus()}}))}hideDisclaimerBanner({immediate:e=!1}={}){const t=this.disclaimerBanner?.element;if(t){if(this.disclaimerBanner.hideTimeoutId&&(clearTimeout(this.disclaimerBanner.hideTimeoutId),this.disclaimerBanner.hideTimeoutId=null),e)return t.classList.remove("is-visible"),t.classList.add("is-hidden"),void t.setAttribute("aria-hidden","true");t.classList.remove("is-visible"),t.setAttribute("aria-hidden","true"),this.disclaimerBanner.hideTimeoutId=setTimeout(()=>{t.classList.add("is-hidden"),this.disclaimerBanner.hideTimeoutId=null},this.disclaimerFadeMs)}}acceptDisclaimer(){this.setDisclaimerAcceptance((new Date).toISOString()),this.hideDisclaimerBanner()}getDisclaimerAcceptance(){try{return localStorage.getItem(DISCLAIMER_STORAGE_KEY)||null}catch(e){return console.warn("Failed to read disclaimer acceptance from storage:",e),null}}setDisclaimerAcceptance(e){try{if(!e)return void localStorage.removeItem(DISCLAIMER_STORAGE_KEY);localStorage.setItem(DISCLAIMER_STORAGE_KEY,e)}catch(e){console.warn("Failed to persist disclaimer acceptance:",e)}}initializeAICoachConsent(){const e=this.aiCoachConsent,t=document.getElementById("ai-coach-consent");if(!t)return;e.element=t,e.panel=t.querySelector(".ai-consent-modal__panel")||t;const i=t.querySelector('[data-action="ai-consent-agree"]');e.agreeButton&&e.agreeHandler&&e.agreeButton.removeEventListener("click",e.agreeHandler),e.agreeButton=i;const r=()=>this.acceptAICoachConsent();e.agreeHandler=r,i&&i.addEventListener("click",r),e.dismissButtons.forEach((t,i)=>{const r=e.dismissHandlers[i];t&&r&&t.removeEventListener("click",r)});const a=Array.from(t.querySelectorAll('[data-action="ai-consent-dismiss"]'));e.dismissButtons=a,e.dismissHandlers=a.map(e=>{const t=e=>{e.preventDefault(),this.cancelAICoachConsent()};return e.addEventListener("click",t),t}),e.escapeHandler&&t.removeEventListener("keydown",e.escapeHandler);const s=e=>{"Escape"===e.key&&(e.preventDefault(),this.cancelAICoachConsent())};e.escapeHandler=s,t.addEventListener("keydown",s),t.setAttribute("aria-hidden","true"),t.classList.contains("is-hidden")||t.classList.add("is-hidden"),this.updateAIChatHeader()}showAICoachConsent(){const e=this.aiCoachConsent,{element:t,panel:i}=e;t&&(e.restoreFocus=document.activeElement instanceof HTMLElement?document.activeElement:null,t.classList.remove("is-hidden"),requestAnimationFrame(()=>{if(t.classList.add("is-visible"),t.setAttribute("aria-hidden","false"),e.isVisible=!0,i&&"function"==typeof i.focus){i.setAttribute("tabindex","-1");try{i.focus({preventScroll:!0})}catch(e){i.focus()}}}))}hideAICoachConsent({immediate:e=!1}={}){const t=this.aiCoachConsent,{element:i}=t;if(!i)return;const r=()=>{i.classList.add("is-hidden"),i.setAttribute("aria-hidden","true"),t.isVisible=!1;const e=t.restoreFocus;if(t.restoreFocus=null,e&&"function"==typeof e.focus)try{e.focus({preventScroll:!0})}catch(t){e.focus()}};if(e)return i.classList.remove("is-visible"),void r();i.classList.remove("is-visible"),i.setAttribute("aria-hidden","true"),t.isVisible=!1,setTimeout(()=>{i.classList.contains("is-visible")||r()},220)}promptAICoachConsent(e=null){if(this.aiCoachConsent.element||this.initializeAICoachConsent(),this.hasAICoachConsent()){if("function"==typeof e)try{e()}catch(e){console.error("AI Coach consent follow-up failed:",e)}return!0}return this.aiCoachConsent.pendingAction="function"==typeof e?e:null,this.showAICoachConsent(),!1}acceptAICoachConsent(){this.setAICoachConsent((new Date).toISOString());const e=this.aiCoachConsent.pendingAction;if(this.aiCoachConsent.pendingAction=null,this.hideAICoachConsent(),this.updateAIChatHeader(),"function"==typeof e)try{e()}catch(e){console.error("AI Coach consent follow-up failed:",e)}}cancelAICoachConsent(){this.aiCoachConsent.pendingAction=null,this.hideAICoachConsent(),this.updateAIChatHeader()}hasAICoachConsent(){return Boolean(this.getAICoachConsent())}getAICoachConsent(){try{return localStorage.getItem(AI_COACH_CONSENT_STORAGE_KEY)||null}catch(e){return console.warn("Failed to read AI Coach consent from storage:",e),null}}setAICoachConsent(e){try{if(!e)return void localStorage.removeItem(AI_COACH_CONSENT_STORAGE_KEY);localStorage.setItem(AI_COACH_CONSENT_STORAGE_KEY,e)}catch(e){console.warn("Failed to persist AI Coach consent:",e)}}initializeSidebarToggle(){const e=document.querySelector(".app-container"),t=document.querySelector(".sidebar"),i=document.getElementById("sidebar-toggle"),r=document.querySelector(".main-content");if(!e||!t||!i)return;this.sidebarState.container=e,this.sidebarState.sidebar=t,this.sidebarState.toggleButton=i,this.sidebarState.mainContent=r||null,"function"==typeof window.matchMedia?this.sidebarState.mediaQuery=window.matchMedia("(max-width: 768px)"):this.sidebarState.mediaQuery=null;const a=({animate:e=!0}={})=>{const t=this.getSidebarCollapsedPreference();this.setSidebarCollapsed(t,{persist:!1,animate:e})};i.addEventListener("click",()=>{const e=!this.sidebarState.preferredCollapsed;this.setSidebarCollapsed(e)});const s=this.sidebarState.mediaQuery;if(s){const e=()=>{a({animate:!0})};"function"==typeof s.addEventListener?s.addEventListener("change",e):"function"==typeof s.addListener&&s.addListener(e)}a({animate:!1})}getSidebarCollapsedPreference(){try{return"true"===localStorage.getItem(SIDEBAR_COLLAPSED_STORAGE_KEY)}catch(e){return console.warn("Failed to read sidebar preference from storage:",e),!1}}setSidebarCollapsedPreference(e){try{localStorage.setItem(SIDEBAR_COLLAPSED_STORAGE_KEY,String(Boolean(e)))}catch(e){console.warn("Failed to persist sidebar preference:",e)}}setSidebarCollapsed(e,{persist:t=!0,animate:i=!0}={}){const r=this.sidebarState,a=r?.container,s=r?.sidebar,n=r?.toggleButton,o=r?.mainContent;if(!a||!s||!n)return;const l=Boolean(e),c=!(r.mediaQuery?.matches??window.innerWidth<=768)&&l;r.preferredCollapsed=l,r.collapsed=c;const d=[a,s,o].filter(Boolean),u=e=>{d.forEach(t=>{t&&(e?t.classList.remove("no-transition"):t.classList.add("no-transition"))})};i||u(!1),a.classList.toggle("is-sidebar-collapsed",c),s.classList.toggle("is-collapsed",c),i||requestAnimationFrame(()=>u(!0));const m=(!c).toString(),h=c?"Expand navigation":"Collapse navigation";n.setAttribute("aria-expanded",m),n.setAttribute("aria-label",h),n.setAttribute("title",h),t&&this.setSidebarCollapsedPreference(l)}initializeShareCard(){const e=document.getElementById("share-portfolio-card"),t=document.getElementById("share-card-root"),i=t?.querySelector(".share-card"),r=document.getElementById("share-card-cumulative-chart");e&&t&&i&&r&&"true"!==e.dataset.initialized&&(this.shareCard.button=e,this.shareCard.root=t,this.shareCard.card=i,this.shareCard.chartCanvas=r,this.shareCard.chartTitle=i?.querySelector(".share-card__chart-title")||null,this.shareCard.rangeLabel=document.getElementById("share-card-range"),this.shareCard.metrics={totalPL:document.getElementById("share-card-total-pl"),winRate:document.getElementById("share-card-win-rate"),profitFactor:document.getElementById("share-card-profit-factor"),totalROI:document.getElementById("share-card-total-roi")},this.shareCard.timestamp=document.getElementById("share-card-date"),this.updateShareCardRangeLabel(),e.dataset.initialized="true",e.addEventListener("click",async e=>{e.preventDefault(),await this.downloadShareCard()}),this.latestStats&&this.updateShareCard(this.latestStats))}normalizeCumulativePLRange(e){const t=(e||"").toString().trim().toUpperCase();return CUMULATIVE_PL_RANGES.includes(t)?t:"ALL"}getCumulativePLRangeLabel(e=this.cumulativePLRange){switch(this.normalizeCumulativePLRange(e)){case"7D":return"Last 7 Days";case"MTD":return"Month to Date";case"1M":return"Last 30 Days";case"3M":return"Last 3 Months";case"YTD":return"Year to Date";case"1Y":return"Last 12 Months";default:return"All Time"}}getCumulativePLRangeWindow(e){const t=this.normalizeCumulativePLRange(e);if("ALL"===t)return{start:null,end:null};const i=new Date(this.currentDate);i.setHours(23,59,59,999);let r=new Date(this.currentDate);switch(r.setHours(0,0,0,0),t){case"7D":r=new Date(i),r.setDate(r.getDate()-6),r.setHours(0,0,0,0);break;case"MTD":r=new Date(i.getFullYear(),i.getMonth(),1);break;case"1M":r=new Date(i),r.setDate(r.getDate()-30),r.setHours(0,0,0,0);break;case"3M":r=new Date(i),r.setMonth(r.getMonth()-3),r.setHours(0,0,0,0);break;case"YTD":r=new Date(i.getFullYear(),0,1);break;case"1Y":r=new Date(i),r.setFullYear(r.getFullYear()-1),r.setHours(0,0,0,0);break;default:r=null}return r&&r>i?{start:null,end:i}:{start:r,end:i}}updateShareCardRangeLabel(e=this.cumulativePLRange){if(!this.shareCard)return;const t=this.getCumulativePLRangeLabel(e);if(this.shareCard.rangeLabel&&(this.shareCard.rangeLabel.textContent=`Range: ${t}`),this.shareCard.chartTitle&&(this.shareCard.chartTitle.textContent=t?`Cumulative P&L (${t})`:"Cumulative P&L"),this.shareCard.chartCanvas){const e=t?`Cumulative profit and loss chart for ${t.toLowerCase()}`:"Cumulative profit and loss chart";this.shareCard.chartCanvas.setAttribute("aria-label",e)}}computeCumulativePLSeries(e=this.cumulativePLRange){const t=this.trades.filter(e=>this.isClosedStatus(e.status)&&e.exitDate);if(0===t.length)return null;const i=e=>{if(!(e instanceof Date))return null;const t=new Date(e);return t.setHours(0,0,0,0),t},r=e=>`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`,a=new Map;let s=null,n=null;if(t.forEach(e=>{const t=this.parseDateValue(e.exitDate);if(!t)return;const o=i(t);if(!o)return;const l=this.parseDecimal(e.pl,0),c=Number.isFinite(l)?l:0,d=r(o);a.set(d,(a.get(d)||0)+c),(!s||o<s)&&(s=new Date(o)),(!n||o>n)&&(n=new Date(o))}),!s||!n)return null;const o=new Map,l=[];let c=0;const d=new Date(s);for(;d.getTime()<=n.getTime();){const e=new Date(d),t=r(e);c+=a.get(t)||0,o.set(t,c),l.push({date:e,value:c}),d.setDate(d.getDate()+1)}const u=this.normalizeCumulativePLRange(e);let{start:m,end:h}=this.getCumulativePLRangeWindow(u);if(m=m?i(m):null,h=h?i(h):null,(!m||m<s)&&(m=new Date(s)),(!h||h>n)&&(h=new Date(n)),m>h)return null;const p=l.filter(e=>e.date>=m&&e.date<=h);if(!p.length)return null;const g=Math.floor((h.getTime()-m.getTime())/864e5)+1<7,y=p[0].date,f=new Date(y);f.setDate(f.getDate()-1);const b=r(f),C=o.get(b)??0;if(g){return{labels:p.map(e=>this.formatDayLabel(e.date)),dataPoints:p.map(e=>{const t=e.value-C;return Math.abs(t)<1e-9?0:t}),dates:p.map(e=>new Date(e.date))}}const S=new Map;p.forEach(e=>{const t=this.getWeekEndingFriday(e.date);if(!t)return;const i=this.getWeekKey(t),r=S.get(i);(!r||e.date>r.entry.date)&&S.set(i,{weekEnding:new Date(t),entry:e})});const T=Array.from(S.values()).sort((e,t)=>e.entry.date.getTime()-t.entry.date.getTime());if(!T.length)return null;return{labels:T.map(e=>this.formatWeekLabel(e.weekEnding)),dataPoints:T.map(e=>{const t=e.entry.value-C;return Math.abs(t)<1e-9?0:t}),dates:T.map(e=>new Date(e.weekEnding))}}updateShareCard(e){if(!this.shareCard?.card)return;const t=this.shareCard.metrics||{},i=e||this.latestStats||this.calculateAdvancedStats(),r=(e,t=2)=>{const i=Number(e);if(!Number.isFinite(i))return"Infinite";const r=this.formatNumber(i,{decimals:t,useGrouping:!0});return r?`${r}%`:`${i.toFixed(t)}%`};if(t.totalPL&&(t.totalPL.textContent=this.formatCurrency(i.realizedPL||0)),t.winRate&&(t.winRate.textContent=r(i.winRate,1)),t.profitFactor){const e=Number(i.profitFactor);t.profitFactor.textContent=Number.isFinite(e)?e.toFixed(2):"Infinite"}if(t.totalROI&&(t.totalROI.textContent=r(i.totalROI,2)),this.shareCard.timestamp){const e=new Date;this.shareCard.timestamp.textContent=e.toLocaleString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"2-digit",minute:"2-digit"})}this.updateShareCardRangeLabel()}refreshShareCardChart(){if(!this.shareCard?.chartCanvas)return;this.updateShareCardRangeLabel();const e=this.shareCard.chartCanvas.getContext("2d");if(!e)return;const t=Number(this.shareCard?.exportSize)||SHARE_CARD_EXPORT_SIZE,i=this.shareCard.card?.clientWidth||t,r="true"===this.shareCard.card?.dataset.exportMode,a=r?t:i,s=Math.round(Math.max(320,a*SHARE_CARD_CHART_WIDTH_RATIO)),n=Math.round(Math.max(SHARE_CARD_CHART_MIN_HEIGHT,a*SHARE_CARD_CHART_HEIGHT_RATIO));this.shareCard.chartCanvas.width=s,this.shareCard.chartCanvas.height=n,r?this.shareCard.chartCanvas.style.setProperty("min-height",`${n}px`):this.shareCard.chartCanvas.style.removeProperty("min-height"),this.shareCard.chart&&(this.shareCard.chart.destroy(),this.shareCard.chart=null);const o=this.computeCumulativePLSeries(this.cumulativePLRange),l=Boolean(o?.labels?.length&&o?.dataPoints?.length),c=l?o.labels:["No Data"],d=l?o.dataPoints:[0],u=e.createLinearGradient(0,0,0,n);u.addColorStop(0,"rgba(79, 195, 247, 0.38)"),u.addColorStop(1,"rgba(79, 195, 247, 0.05)");const m=(e,t=2)=>this.formatCurrency(e,{decimals:t});this.shareCard.chart=new Chart(e,{type:"line",data:{labels:c,datasets:[{label:"Cumulative P&L",data:d,borderColor:"#4FC3F7",backgroundColor:u,fill:!0,tension:.35,pointRadius:l?3:0,pointHoverRadius:l?5:0,borderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!1,animation:!1,scales:{x:{grid:{display:!1},ticks:{color:"rgba(255, 255, 255, 0.58)",maxRotation:0,minRotation:0,font:{size:12}}},y:{grid:{color:"rgba(255, 255, 255, 0.08)"},ticks:{color:"rgba(255, 255, 255, 0.58)",callback:e=>m(e,0),font:{size:12}}}},plugins:{legend:{display:!1},tooltip:{callbacks:{label:e=>`Cumulative P&L: ${m(e.raw)}`}}}}})}async waitForShareCardChartRender(){const e="function"==typeof requestAnimationFrame?requestAnimationFrame:null;e?await new Promise(t=>{e(()=>{e(()=>t())})}):await new Promise(e=>setTimeout(e,200))}async downloadShareCard(){const e=this.shareCard?.button,t=this.shareCard?.root,i=this.shareCard?.card;if(!e||!t||!i)return void this.showNotification("Sharing is unavailable right now.","error");if("function"!=typeof window.html2canvas)return void this.showNotification("Image export library failed to load. Please refresh and try again.","error");const r=Number(this.shareCard?.exportSize)||SHARE_CARD_EXPORT_SIZE,a=e.disabled;e.disabled=!0,e.setAttribute("aria-busy","true"),e.blur();const s=i.dataset.exportMode,n=i.style.width,o=i.style.height,l=i.style.maxWidth,c=i.style.maxHeight;i.dataset.exportMode="true",i.style.width=`${r}px`,i.style.height=`${r}px`,i.style.maxWidth=`${r}px`,i.style.maxHeight=`${r}px`,this.updateShareCard(this.latestStats),t.classList.add("is-active"),t.setAttribute("aria-hidden","false"),await new Promise(e=>{requestAnimationFrame(()=>{this.refreshShareCardChart(),setTimeout(e,220)})}),await this.waitForShareCardChartRender();let d=null;try{const e=Math.max(2,Math.min(3,window.devicePixelRatio||2));d=await window.html2canvas(i,{width:r,height:r,scale:e,useCORS:!0,logging:!1,backgroundColor:"#050b1a"})}catch(e){console.error("Failed to capture share card:",e),this.showNotification("Unable to prepare the share card image. Please try again.","error")}if(t.classList.remove("is-active"),t.setAttribute("aria-hidden","true"),e.removeAttribute("aria-busy"),e.disabled=a,s?i.dataset.exportMode=s:delete i.dataset.exportMode,i.style.width=n,i.style.height=o,i.style.maxWidth=l,i.style.maxHeight=c,this.shareCard.chart&&(this.shareCard.chart.destroy(),this.shareCard.chart=null),this.shareCard.chartCanvas&&this.shareCard.chartCanvas.style.removeProperty("min-height"),d)try{const e=d.toDataURL("image/png"),t=new Date,i=[t.getFullYear(),String(t.getMonth()+1).padStart(2,"0"),String(t.getDate()).padStart(2,"0")].join(""),r=document.createElement("a");r.href=e,r.download=`gammaledger-portfolio-${i}.png`,document.body.appendChild(r),r.click(),document.body.removeChild(r),this.showNotification("Portfolio snapshot saved as an image.","success")}catch(e){console.error("Failed to download image:",e),this.showNotification("Image download failed. Please try again.","error")}}updateFinnhubStatus(e,t="neutral",i=0){const r=this.finnhub?.elements?.status;if(!r||!e)return;const a=["success","error","neutral"].includes(t)?t:"neutral";r.textContent=e,r.classList.remove("is-success","is-error"),"success"===a?r.classList.add("is-success"):"error"===a&&r.classList.add("is-error"),this.finnhub.statusTimeoutId&&clearTimeout(this.finnhub.statusTimeoutId),this.finnhub.lastStatus={message:e,variant:a},i>0&&(this.finnhub.statusTimeoutId=setTimeout(()=>{r.isConnected&&(r.textContent="neutral"===a?"Not set":"",r.classList.remove("is-success","is-error"))},i))}setFinnhubApiKey(e,{persist:t=!1,updateUI:i=!0,markUnsaved:r=!1}={}){const a=(e||"").trim();a!==this.finnhub.apiKey&&(this.finnhub.apiKey=a,this.finnhub.cache.clear(),this.finnhub.outstandingRequests.clear(),i&&this.finnhub.elements?.input&&(this.finnhub.elements.input.value=a),t&&this.saveFinnhubConfigToStorage(),r&&this.markUnsavedChanges())}getFinnhubStorageKey(){return"GammaLedgerFinnhubConfig"}async loadFinnhubConfigFromStorage(){try{const e=localStorage.getItem(this.getFinnhubStorageKey());if(!e)return;const t=JSON.parse(e);if(!t)return;if(t.enc&&t.payload){const e=this.getCrypto();if(!e?.subtle)return console.warn("Encrypted Finnhub API key stored but Web Crypto unavailable."),void this.updateFinnhubStatus("Stored Finnhub key is encrypted, but this browser cannot decrypt it.","error",7e3);try{const i=await this.ensureFinnhubEncryptionKey(e);if(!i)throw new Error("Encryption key unavailable");const r=await this.decryptString(t.payload,e,i);r&&(this.finnhub.apiKey=r)}catch(e){console.warn("Failed to decrypt stored Finnhub API key:",e),this.updateFinnhubStatus("Failed to decrypt stored Finnhub API key.","error",6e3)}return}"string"==typeof t.apiKey&&(this.finnhub.apiKey=t.apiKey)}catch(e){console.warn("Failed to load Finnhub configuration:",e)}}saveFinnhubConfigToStorage(){try{const e={apiKey:this.finnhub.apiKey};localStorage.setItem(this.getFinnhubStorageKey(),JSON.stringify(e))}catch(e){console.warn("Failed to save Finnhub configuration:",e)}}removeFinnhubConfigFromStorage(){try{localStorage.removeItem(this.getFinnhubStorageKey())}catch(e){console.warn("Failed to remove Finnhub configuration:",e)}}arrayBufferToBase64(e){const t=new Uint8Array(e);let i="";for(let e=0;e<t.byteLength;e++)i+=String.fromCharCode(t[e]);return btoa(i)}base64ToArrayBuffer(e){const t=atob(e),i=t.length,r=new Uint8Array(i);for(let e=0;e<i;e++)r[e]=t.charCodeAt(e);return r.buffer}getFinnhubSecretStorageKey(){return"GammaLedgerFinnhubSecret"}async ensureFinnhubEncryptionKey(e=this.getCrypto()){if(!e?.subtle)return null;if(this.finnhub.encryptionKey)return this.finnhub.encryptionKey;let t=localStorage.getItem(this.getFinnhubSecretStorageKey());if(!t){const i=e.getRandomValues(new Uint8Array(32));t=this.arrayBufferToBase64(i.buffer),localStorage.setItem(this.getFinnhubSecretStorageKey(),t)}const i=new Uint8Array(this.base64ToArrayBuffer(t)),r=await e.subtle.importKey("raw",i,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"]);return this.finnhub.encryptionKey=r,r}async encryptString(e,t,i){const r=t.getRandomValues(new Uint8Array(12)),a=new TextEncoder,s=await t.subtle.encrypt({name:"AES-GCM",iv:r},i,a.encode(e));return{iv:this.arrayBufferToBase64(r.buffer),ct:this.arrayBufferToBase64(s)}}getCrypto(){return"undefined"!=typeof globalThis&&globalThis.crypto?globalThis.crypto:"undefined"!=typeof window&&window.crypto?window.crypto:null}async decryptString(e,t,i){const r=new Uint8Array(this.base64ToArrayBuffer(e.iv)),a=this.base64ToArrayBuffer(e.ct),s=await t.subtle.decrypt({name:"AES-GCM",iv:r},i,a);return(new TextDecoder).decode(s)}async encryptAndStoreFinnhubApiKey(e=this.getCrypto()){try{if(!e?.subtle)throw new Error("Web Crypto API unavailable");const t=this.finnhub.apiKey||"";if(!t)return this.removeFinnhubConfigFromStorage(),!0;const i=await this.ensureFinnhubEncryptionKey(e);if(!i)throw new Error("Failed to prepare encryption key");const r=await this.encryptString(t,e,i);return localStorage.setItem(this.getFinnhubStorageKey(),JSON.stringify({enc:!0,payload:r})),!0}catch(e){return console.warn("Failed to encrypt Finnhub API key:",e),!1}}getQuoteEntryKey(e){if(!e||"object"!=typeof e)return"unknown";const t=e.id??e.tradeId??e.uid??e.uniqueId;if(null!=t&&""!==t)return`id:${t}`;return`fallback:${(e.ticker||"").toString().trim().toUpperCase()}|${e.entryDate||""}|${e.strikePrice||""}`}rebuildQuoteRefreshSchedule(){this.activeQuoteEntries instanceof Map||(this.activeQuoteEntries=new Map);const e={highPriority:[],lowPriority:[]};this.activeQuoteEntries.forEach((t,i)=>{const r=t.cell?.dataset?.priceState;"error"!==r&&"loading"!==r&&"idle"!==r&&r?e.lowPriority.push(i):e.highPriority.push(i)}),this.quoteRefreshKeys=[...e.highPriority,...e.lowPriority],this.quoteRefreshCursor=0}startQuoteAutoRefreshIfNeeded(){this.activeQuoteEntries instanceof Map||(this.activeQuoteEntries=new Map),this.creditPlaybookQuoteEntries instanceof Map||(this.creditPlaybookQuoteEntries=new Map),this.assignedPositionsQuoteEntries instanceof Map||(this.assignedPositionsQuoteEntries=new Map);if(0===this.activeQuoteEntries.size+this.creditPlaybookQuoteEntries.size+this.assignedPositionsQuoteEntries.size)return void this.stopQuoteAutoRefresh();const e=this.computeAutoRefreshInterval();if(e!==this.autoRefreshIntervalMs&&(this.autoRefreshIntervalMs=e,this.stopQuoteAutoRefresh()),this.quoteRefreshIntervalId)return;let t=0;this.quoteRefreshIntervalId=setInterval(()=>{const e=this.activeQuoteEntries.size>0,i=this.creditPlaybookQuoteEntries.size>0,r=this.assignedPositionsQuoteEntries.size>0;if(!e&&!i&&!r)return void this.stopQuoteAutoRefresh();const a=[{has:e,refresh:()=>this.refreshActivePositionsQuotes({force:!0})},{has:i,refresh:()=>this.refreshCreditPlaybookQuotes({force:!0})},{has:r,refresh:()=>this.refreshAssignedPositionsQuotes({force:!0})}].filter(e=>e.has);a.length>0&&(a[t%a.length].refresh(),t++)},this.autoRefreshIntervalMs)}stopQuoteAutoRefresh(){this.quoteRefreshIntervalId&&(clearInterval(this.quoteRefreshIntervalId),this.quoteRefreshIntervalId=null),0===this.activeQuoteEntries?.size&&(this.quoteRefreshKeys=[],this.quoteRefreshCursor=0)}refreshActivePositionsQuotes({force:e=!1,immediate:t=!1}={}){if(!(this.activeQuoteEntries instanceof Map)||0===this.activeQuoteEntries.size)return void this.stopQuoteAutoRefresh();if(Array.isArray(this.quoteRefreshKeys)&&0!==this.quoteRefreshKeys.length||this.rebuildQuoteRefreshSchedule(),0===this.quoteRefreshKeys.length)return void this.stopQuoteAutoRefresh();let i=0;const r=this.quoteRefreshKeys.length;for(;i<r&&this.quoteRefreshKeys.length>0;){const r=this.quoteRefreshCursor%this.quoteRefreshKeys.length,a=this.quoteRefreshKeys[r],s=this.activeQuoteEntries.get(a);if(this.quoteRefreshCursor=(r+1)%this.quoteRefreshKeys.length,i+=1,s&&s.cell?.isConnected&&s.row?.isConnected)return void this.populateQuoteCell(s.cell,s.trade,s.row,{forceRefresh:e,silentIfCached:!e,suppressLoadingText:!t});if(this.activeQuoteEntries.delete(a),this.quoteRefreshKeys.splice(r,1),0===this.quoteRefreshKeys.length)return void this.stopQuoteAutoRefresh()}0===this.activeQuoteEntries.size&&this.stopQuoteAutoRefresh()}refreshCreditPlaybookQuotes({force:e=!1,immediate:t=!1}={}){if(!(this.creditPlaybookQuoteEntries instanceof Map)||0===this.creditPlaybookQuoteEntries.size)return;let i=null,r=null;for(const[e,t]of this.creditPlaybookQuoteEntries.entries()){if(!t||!t.cell?.isConnected||!t.row?.isConnected){this.creditPlaybookQuoteEntries.delete(e);continue}const a=t.cell?.dataset?.priceState;if("error"===a||"loading"===a||"idle"===a||!a){i=t,r=e;break}}if(!i)for(const[e,t]of this.creditPlaybookQuoteEntries.entries()){if(t&&t.cell?.isConnected&&t.row?.isConnected){i=t,r=e;break}this.creditPlaybookQuoteEntries.delete(e)}i&&this.populateQuoteCell(i.cell,i.trade,i.row,{forceRefresh:e,silentIfCached:!e,suppressLoadingText:!t}),0===this.creditPlaybookQuoteEntries.size&&this.stopQuoteAutoRefresh()}populateQuoteCell(e,t,i,r={}){const{forceRefresh:a=!1,deferNetworkFetch:s=!1,silentIfCached:n=!1,suppressLoadingText:o=!1}=r;if(!e)return;const l=(t?.ticker||"").toString().trim().toUpperCase();if(!l)return e.dataset.priceState="idle",e.textContent="—",void e.classList.remove("quote-error");const c=a?null:this.getCachedQuote(l);if(c)this.renderQuoteValue(e,i,t,c.value);else{if(!this.finnhub.apiKey){e.dataset.priceState="error",this.setQuoteCellError(e,i,t,"Set API key");const r=this.finnhub.lastStatus?.message;return"Add your Finnhub API key to load live prices."!==r&&this.updateFinnhubStatus("Add your Finnhub API key to load live prices.","neutral",6e3),void this.updateItmHighlight(i,t,null)}e.dataset.priceState=a?"refreshing":"loading",a||o||n||(e.textContent="Loading…"),e.classList.remove("quote-error"),this.finnhub.apiKey&&!s&&this.getCurrentPrice(l,{forceRefresh:a}).then(r=>{e.isConnected&&this.renderQuoteValue(e,i,t,r)}).catch(r=>{if(!e.isConnected)return;const a=this.getQuoteErrorMessage(r);this.setQuoteCellError(e,i,t,a)})}}renderQuoteValue(e,t,i,r){if(!e)return;e.dataset.priceState="ready",e.classList.remove("quote-error");const a=Number(r?.price);if(!Number.isFinite(a))return e.textContent="—",void this.applyPositionHighlight(t,i,null);const s=this.getQuoteChangePercent(r),n=this.getQuoteChangeValue(r);e.innerHTML="";const o=document.createElement("span");if(o.className="quote-price",o.textContent=this.formatCurrency(a),e.appendChild(o),Number.isFinite(s)){const t=document.createElement("span");t.className="quote-change";const i=Math.abs(s),r=`${s>0?"+":s<0?"-":""}${this.formatNumber(i,{decimals:2,useGrouping:!0})??i.toFixed(2)}%`;if(t.textContent=r,s>0?t.classList.add("is-up"):s<0?t.classList.add("is-down"):t.classList.add("is-flat"),Number.isFinite(n)){const e=Math.abs(n),i=this.formatCurrency(e),a=n>0?"+":n<0?"-":"";t.title=`${a}${i} (${r})`}e.appendChild(t)}this.applyPositionHighlight(t,i,a)}getQuoteChangePercent(e){const t=Number(e?.changePercent);if(Number.isFinite(t))return t;const i=Number(e?.change),r=Number(e?.previousClose);if(Number.isFinite(i)&&Number.isFinite(r)&&0!==r)return i/r*100;const a=Number(e?.price);return Number.isFinite(a)&&Number.isFinite(r)&&0!==r?(a-r)/r*100:null}getQuoteChangeValue(e){const t=Number(e?.change);if(Number.isFinite(t))return t;const i=Number(e?.price),r=Number(e?.previousClose);return Number.isFinite(i)&&Number.isFinite(r)?i-r:null}setQuoteCellError(e,t,i,r){if(!e)return;e.dataset.priceState="error",e.classList.add("quote-error");const a=(r||"").trim();if("Set API key"===a){e.textContent="";const t=document.createElement("button");t.type="button",t.className="link-button link-button--inline",t.textContent="Set API key",t.addEventListener("click",e=>{e.preventDefault(),this.showView("settings")}),e.appendChild(t)}else e.textContent=a||"Unavailable";this.applyPositionHighlight(t,i,null)}getQuoteErrorMessage(e){const t=(e?.message||"").toLowerCase();return t?t.includes("api key")?"Set API key":t.includes("rate limit")?"Rate limited":t.includes("symbol")?"Bad ticker":t.includes("network")?"Network error":"Unavailable":"Unavailable"}getCachedQuote(e){if(!e)return null;const t=this.finnhub.cache.get(e);return t?Date.now()-t.timestamp>this.finnhub.cacheTTL?(this.finnhub.cache.delete(e),null):t:null}setCachedQuote(e,t){e&&this.finnhub.cache.set(e,{value:t,timestamp:Date.now()})}async getCurrentPrice(e,{forceRefresh:t=!1}={}){const i=(e||"").toString().trim().toUpperCase();if(!i)throw new Error("Invalid symbol");if(t)this.finnhub.cache.delete(i);else{const e=this.getCachedQuote(i);if(e)return e.value}if(!this.finnhub.apiKey)throw new Error("Finnhub API key missing");const r=this.finnhub.outstandingRequests.get(i);if(r)return r;const a=this.enqueueFinnhubRequest(i).then(e=>(this.setCachedQuote(i,e),e)).catch(e=>{throw this.updateFinnhubStatus(e.message||"Failed to load quote.","error",7e3),e}).finally(()=>{this.finnhub.outstandingRequests.delete(i)});return this.finnhub.outstandingRequests.set(i,a),a}enqueueFinnhubRequest(e){const t=this.finnhub.rateLimitQueue.catch(()=>{}).then(()=>this.performFinnhubFetch(e));return this.finnhub.rateLimitQueue=t.then(()=>{}).catch(()=>{}),t}async performFinnhubFetch(e){await this.enforceFinnhubRateLimit();const t=new URL("https://finnhub.io/api/v1/quote");let i,r;t.searchParams.set("symbol",e),t.searchParams.set("token",this.finnhub.apiKey);try{i=await fetch(t.toString(),{cache:"no-store"})}catch(e){throw new Error("Network error fetching price")}if(!i.ok)throw new Error(429===i.status?"Finnhub rate limit exceeded. Please wait.":"Finnhub API error");try{r=await i.json()}catch(e){throw new Error("Invalid response from Finnhub")}if(r&&"string"==typeof r.error)throw new Error(r.error);const a=Number(r?.c);if(!Number.isFinite(a))throw new Error("Price unavailable for symbol");const s=Number(r?.d),n=Number(r?.dp),o=Number(r?.pc),l=Number(r?.o),c=Number(r?.h),d=Number(r?.l);return{symbol:e,price:a,change:Number.isFinite(s)?s:null,changePercent:Number.isFinite(n)?n:null,previousClose:Number.isFinite(o)?o:null,open:Number.isFinite(l)?l:null,high:Number.isFinite(c)?c:null,low:Number.isFinite(d)?d:null,fetchedAt:(new Date).toISOString(),currency:"USD"}}async enforceFinnhubRateLimit(){const e=this.finnhub.timestamps,t=Date.now(),i=t-this.finnhub.lastRequestTime;if(i<this.finnhub.minIdleMs){const e=this.finnhub.minIdleMs-i;await new Promise(t=>setTimeout(t,e))}for(;e.length>0&&t-e[0]>=6e4;)e.shift();if(e.length>=this.finnhub.maxRequestsPerMinute){const i=6e4-(t-e[0])+50;await new Promise(e=>setTimeout(e,i))}const r=Date.now();e.push(r),this.finnhub.lastRequestTime=r}applyPositionHighlight(e,t,i=null){if(!e)return;const r=e.cells?.[4];r&&this.updateExpirationHighlight(r,t),this.updateItmHighlight(e,t,i)}updateExpirationHighlight(e,t){if(!e)return;e.classList.remove("position-expiring-critical","position-expiring-warning");const i=this.positionHighlightConfig?.expirationWarningDays??20,r=this.positionHighlightConfig?.expirationCriticalDays??10,a=t?.dte,s=this.parseInteger(a,null,{allowNegative:!0});!Number.isFinite(s)||s<0||(s<r?e.classList.add("position-expiring-critical"):s<i&&e.classList.add("position-expiring-warning"))}updateItmHighlight(e,t,i){if(!e)return;const r=this.isInTheMoney(t,i,e);e.classList.toggle("position-itm",Boolean(r))}resolveStrikeForHighlight(e,t){const i=[];void 0!==t?.dataset?.strikePrice&&i.push(t.dataset.strikePrice),e&&i.push(e.activeStrikePrice,e.strikePrice,e.primaryStrike,e.shortStrike,e.longStrike);for(const e of i){const t=this.parseDecimal(e,null,{allowNegative:!1});if(Number.isFinite(t))return t}if(e&&Array.isArray(e.legs)&&e.legs.length>0){const t=this.summarizeLegs(e.legs),i=this.getActiveStrikeForDisplay(t);if(Number.isFinite(i))return i;const r=this.derivePrimaryStrike(t);if(Number.isFinite(r))return r}return null}isInTheMoney(e,t,i){if(!Number.isFinite(t))return!1;const r=this.resolveStrikeForHighlight(e,i);if(!Number.isFinite(r))return!1;const a=this.inferOptionFlavor(e);return"call"===a?t>=r:"put"===a&&t<=r}inferOptionFlavor(e={}){const t=(e.optionType||e.optionFlavor||"").toString().trim().toLowerCase();if("call"===t||"put"===t)return t;const i=(e.strategy||"").toLowerCase(),r=i.includes("call"),a=i.includes("put");if(r&&!a)return"call";if(a&&!r)return"put";const s=(e.notes||"").toLowerCase(),n=s.includes("call"),o=s.includes("put");return n&&!o?"call":o&&!n?"put":null}updateMonthlyPLChart(){const e=document.getElementById("monthlyPLChart");if(!e)return;const t=e.getContext("2d");this.charts.monthlyPL&&this.charts.monthlyPL.destroy();const i=(e,t=2)=>this.formatCurrency(e,{decimals:t}),r={};this.trades.filter(e=>this.isClosedStatus(e.status)&&e.exitDate).forEach(e=>{const t=e.exitDate.substring(0,7);r[t]||(r[t]=0),r[t]+=e.pl});const a=Object.keys(r).sort(),s=a.map(e=>new Date(e+"-01").toLocaleDateString("en-US",{month:"short",year:"numeric"}));this.charts.monthlyPL=new Chart(t,{type:"bar",data:{labels:s,datasets:[{label:"Monthly P&L",data:a.map(e=>r[e]),backgroundColor:a.map(e=>r[e]>=0?"#1FB8CD":"#B4413C"),borderColor:a.map(e=>r[e]>=0?"#1FB8CD":"#B4413C"),borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{callback:e=>i(e,0)}},x:{ticks:{maxRotation:45,minRotation:45}}},plugins:{legend:{display:!1},tooltip:{callbacks:{label:e=>`P&L: ${i(e.raw)}`}}}}})}updateCumulativePLChart(){const e=document.getElementById("cumulativePLChart");if(!e)return void console.error("Cumulative P&L chart canvas not found");const t=e.getContext("2d");this.charts.cumulativePL&&this.charts.cumulativePL.destroy();const i=(e,t=2)=>this.formatCurrency(e,{decimals:t}),r=this.computeCumulativePLSeries(this.cumulativePLRange);r&&r.labels.length&&r.dataPoints.length?this.charts.cumulativePL=new Chart(t,{type:"line",data:{labels:r.labels,datasets:[{label:"Cumulative P&L",data:r.dataPoints,borderColor:"#1FB8CD",backgroundColor:"rgba(31, 184, 205, 0.1)",fill:!0,tension:.4,pointRadius:3,pointHoverRadius:6}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{x:{ticks:{callback:function(e){if("string"==typeof e)return e;if("number"==typeof e&&this&&"function"==typeof this.getLabelForValue){const t=this.getLabelForValue(e);if(t)return t}return""},maxRotation:45,minRotation:45}},y:{ticks:{callback:e=>i(e,0)}}},plugins:{legend:{display:!1},tooltip:{callbacks:{title:function(e){return e[0]?.label||""},label:e=>`Cumulative P&L: ${i(e.raw)}`}}}}}):this.charts.cumulativePL=new Chart(t,{type:"line",data:{labels:["No Data"],datasets:[{label:"Cumulative P&L",data:[0],borderColor:"#1FB8CD",backgroundColor:"rgba(31, 184, 205, 0.1)",fill:!1,tension:.4}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{ticks:{callback:e=>i(e,0)}}},plugins:{legend:{display:!1}}}})}getWeekEndingFriday(e){const t=new Date(e);if(isNaN(t.getTime()))return null;const i=new Date(t);i.setHours(0,0,0,0);const r=i.getDay();return 5===r?i:6===r?(i.setDate(i.getDate()-1),i):0===r?(i.setDate(i.getDate()-2),i):(i.setDate(i.getDate()+(5-r)),i)}getWeekKey(e){const t=new Date(e);if(isNaN(t.getTime()))return"";return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}formatDayLabel(e){const t=new Date(e);return Number.isNaN(t.getTime())?"":t.toLocaleDateString("en-US",{month:"short",day:"2-digit",year:"numeric"})}formatWeekLabel(e){const t=new Date(e);return isNaN(t.getTime())?"":t.toLocaleDateString("en-US",{month:"short",day:"2-digit",year:"numeric"})}updateStrategyPerformanceChart(){const e=document.getElementById("strategyChart");if(!e)return;const t=e.getContext("2d");this.charts.strategy&&this.charts.strategy.destroy();const i={};this.trades.filter(e=>this.isClosedStatus(e.status)).forEach(e=>{i[e.strategy]||(i[e.strategy]=0),i[e.strategy]+=e.pl});const r=Object.entries(i).sort(([,e],[,t])=>t-e).slice(0,8),a=(e,t=2)=>this.formatCurrency(e,{decimals:t});this.charts.strategy=new Chart(t,{type:"bar",data:{labels:r.map(([e])=>e),datasets:[{label:"Total P&L",data:r.map(([,e])=>e),backgroundColor:r.map(([,e])=>e>=0?"#1FB8CD":"#B4413C"),borderColor:r.map(([,e])=>e>=0?"#1FB8CD":"#B4413C"),borderWidth:1}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,scales:{x:{beginAtZero:!0,ticks:{callback:e=>a(e,0)}}},plugins:{legend:{display:!1},tooltip:{callbacks:{label:e=>`P&L: ${a(e.raw)}`}}}}})}updateWinRateByStrategyChart(){const e=document.getElementById("winRateChart");if(!e)return;const t=e.getContext("2d");this.charts.winRate&&this.charts.winRate.destroy();const i={};this.trades.forEach(e=>{i[e.strategy]||(i[e.strategy]={total:0,wins:0}),this.isClosedStatus(e.status)&&(i[e.strategy].total++,e.pl>0&&i[e.strategy].wins++)});const r=Object.entries(i).filter(([,e])=>e.total>=1).map(([e,t])=>({strategy:e,winRate:t.wins/t.total*100,total:t.total})).sort((e,t)=>t.winRate-e.winRate);this.charts.winRate=new Chart(t,{type:"doughnut",data:{labels:r.map(e=>`${e.strategy} (${e.total})`),datasets:[{data:r.map(e=>e.winRate),backgroundColor:["#1FB8CD","#FFC185","#B4413C","#ECEBD5","#5D878F","#DB4545","#D2BA4C","#964325","#944454","#13343B"].slice(0,r.length),borderWidth:2,borderColor:"#fff"}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"right",labels:{boxWidth:15,padding:15}},tooltip:{callbacks:{label:e=>{const t=this.formatPercent(e.raw,"0%",{decimals:2});return`${e.label}: ${t}`}}}}}})}updateTradesList(){this.populateFilters(),this.filterTrades()}getSelectedFilterValues(e){if(!e)return[];const t=Array.from(e.options||[]).filter(e=>e.selected).map(e=>e.value);return t.includes("")&&1===t.length?[]:t.filter(e=>""!==e)}normalizeFilterSelect(e){if(!e)return;const t=Array.from(e.options||[]),i=t.find(e=>""===e.value);if(!i)return;const r=t.filter(e=>e.selected).map(e=>e.value),a=r.includes("");a&&r.length>1?t.forEach(e=>{e.selected=""===e.value}):a||0!==r.length?a||(i.selected=!1):i.selected=!0}resetFilterSelect(e){e&&(Array.from(e.options||[]).forEach(e=>{e.selected=""===e.value}),this.normalizeFilterSelect(e))}restoreMultiSelectSelection(e,t=[]){if(!e)return;const i=Array.isArray(t)?t:[t],r=i.some(e=>e),a=new Set(r?i.filter(Boolean):[""]),s=Array.from(e.options||[]);let n=!1;if(s.forEach(e=>{a.has(e.value)?(e.selected=!0,n=!0):e.selected=!1}),!n){const e=s.find(e=>""===e.value);e&&(e.selected=!0)}this.normalizeFilterSelect(e)}getSortableValue(e,t){if(!e||!t)return null;const i=e[t];if(null==i)return null;if(t.toLowerCase().includes("date")){const e=new Date(i).getTime();return Number.isNaN(e)?null:e}if("status"===t)return this.normalizeStatus(i);const r=Number(i);return!Number.isNaN(r)&&Number.isFinite(r)&&""!==i?r:"string"==typeof i?i.toLowerCase():i}compareSortableValues(e,t){const i=e=>null==e||""===e,r=i(e),a=i(t);return r&&a?0:r?1:a||e<t?-1:e>t?1:0}applySortToTrades(e,t,i="asc"){if(!Array.isArray(e)||!t)return Array.isArray(e)?e.slice():[];const r="desc"===i?"desc":"asc";return e.slice().sort((e,i)=>{const a=this.getSortableValue(e,t),s=this.getSortableValue(i,t),n=this.compareSortableValues(a,s);return"asc"===r?n:-n})}populateFilters(){const e=document.getElementById("filter-strategy"),t=e?Array.from(e.options||[]).filter(e=>e.selected).map(e=>e.value):[""],i=[...new Set(this.trades.map(e=>e.strategy))].filter(Boolean).sort((e,t)=>e.localeCompare(t));if(e){e.innerHTML="";const r=document.createElement("option");r.value="",r.textContent="All Strategies",e.appendChild(r),i.forEach(t=>{const i=document.createElement("option");i.value=t,i.textContent=t,e.appendChild(i)}),this.restoreMultiSelectSelection(e,t)}const r=document.getElementById("filter-status");r&&this.normalizeFilterSelect(r)}filterTrades(){const e=document.getElementById("filter-strategy"),t=document.getElementById("filter-status");this.normalizeFilterSelect(e),this.normalizeFilterSelect(t);const i=this.getSelectedFilterValues(e),r=this.getSelectedFilterValues(t).map(e=>e.toLowerCase()),a=(document.getElementById("search-ticker")?.value||"").toString().trim().toLowerCase(),s=i.length>0,n=r.length>0,o=this.trades.filter(e=>{const t=(e.strategy??"").toString(),o=!s||i.includes(t),l=this.normalizeStatus(e.status);let c=!0;n&&(c=r.some(t=>"assigned"===t?"assigned"===l||"closed"===l&&this.isAssignmentReason(e.exitReason):l===t));const d=(e.ticker??"").toString().toLowerCase(),u=(e.strategy??"").toString().toLowerCase(),m=(e.notes??"").toString().toLowerCase(),h=!a||d.includes(a)||u.includes(a)||m.includes(a);return o&&c&&h}),l=this.currentSort?.key,c=l?this.sortDirection[l]||this.currentSort.direction||"asc":null,d=l?this.applySortToTrades(o,l,c):o.slice();this.currentFilteredTrades=d.slice(),this.renderTradesTable(d)}openTradesFilteredByTicker(e){const t=(e??"").toString().trim().toUpperCase();if(!t)return;this.showView("trades-list");const i=document.getElementById("search-ticker");i&&(i.value=t,i.focus()),["filter-strategy","filter-status"].forEach(e=>{const t=document.getElementById(e);t&&this.resetFilterSelect(t)}),this.filterTrades()}renderTradesTable(e=this.trades){const t=document.querySelector("#trades-table tbody");if(!t)return;const i=Array.isArray(e)?e.slice():[];this.currentFilteredTrades=i,"function"==typeof this.setupTradesMergeControls&&this.setupTradesMergeControls(),t.innerHTML="",this.tradeDetailCharts?.size&&(this.tradeDetailCharts.forEach(e=>{try{e.destroy()}catch(e){console.warn("Failed to destroy payoff chart:",e)}}),this.tradeDetailCharts.clear()),this.pruneTradeMergeSelection();const r=e=>{const t=Number(e);return Number.isFinite(t)?t:null},a=["","Ticker","Strategy","Strike","Qty","Entry Date","Expiration Date","DTE","Exit Date","Days Held","Max Risk","P&L","ROI","Annual ROI","Status","Actions"];i.forEach((e,i)=>{const s=t.insertRow();s.classList.add("trade-summary-row");const n=s.insertCell();n.className="trade-select-cell",n.classList.toggle("is-hidden",!this.tradesMergePanelOpen);const o=document.createElement("input");o.type="checkbox",o.className="trade-merge-checkbox",o.dataset.tradeId=e.id||"",o.checked=!!e.id&&this.tradeMergeSelection.has(e.id),o.disabled=!this.tradesMergePanelOpen,o.tabIndex=this.tradesMergePanelOpen?0:-1,o.setAttribute("aria-label",`Select trade ${e.ticker||""}`.trim()),o.addEventListener("change",t=>{if(t.stopPropagation(),!this.tradesMergePanelOpen)return void(t.target.checked=!!e.id&&this.tradeMergeSelection.has(e.id));const i=e.id;i?(t.target.checked?this.tradeMergeSelection.add(i):this.tradeMergeSelection.delete(i),this.syncSelectAllCheckbox(),this.refreshTradesMergePanelContents()):t.target.checked=!1}),n.appendChild(o);s.insertCell().appendChild(this.createTickerElement(e.ticker));s.insertCell().textContent=e.strategy||"—";const l=s.insertCell(),c=e.displayStrike||null,d=r(e.strikePrice);l.textContent=c||(null!==d?`$${d.toFixed(2)}`:"—");const u=s.insertCell(),m=r(e.quantity);u.textContent=null!==m?Math.abs(m):"—";s.insertCell().textContent=this.formatDate(e.entryDate);s.insertCell().textContent=this.formatDate(e.expirationDate);const h=s.insertCell(),p=r(e.dte);h.textContent=null!==p?p:"—";s.insertCell().textContent=e.exitDate?this.formatDate(e.exitDate):"—";const g=s.insertCell(),y=r(e.daysHeld);g.textContent=null!==y?y:"—";const f=s.insertCell(),b=r(e.maxRisk),C=document.createTextNode(e.maxRiskLabel||(null!==b?this.formatCurrency(b):"—"));if(f.appendChild(C),e.strategy&&(e.maxRiskLabel||null!==b)){const t=this.createFormulaIcon(e,"maxRisk");t&&f.appendChild(t)}e.maxRiskLabel?(f.className=e.riskIsUnlimited?"pl-negative":"pl-neutral",e.riskIsUnlimited||null===b||(f.className="pl-negative")):f.className=null!==b?"pl-negative":"pl-neutral";const S=s.insertCell(),T=r(e.pl),L=document.createTextNode(null!==T?this.formatCurrency(T):"—");if(S.appendChild(L),e.strategy&&null!==T){const t=this.createFormulaIcon(e,"pl");t&&S.appendChild(t)}S.className=null!==T?T>0?"pl-positive":T<0?"pl-negative":"pl-neutral":"pl-neutral";const x=s.insertCell(),k=r(e.roi),v=null!==k?this.formatPercent(k,"—"):"—";x.textContent=v,x.className="—"===v?"pl-neutral":k>0?"pl-positive":k<0?"pl-negative":"pl-neutral";const N=s.insertCell(),D=r(e.annualizedROI);if(this.isClosedStatus(e.status)&&null!==D){const e=this.formatPercent(D,"—");N.textContent=e,N.className=D>0?"pl-positive":D<0?"pl-negative":"pl-neutral"}else N.textContent="—",N.className="pl-neutral";const I=s.insertCell(),E=document.createElement("span"),P=this.getDisplayStatus(e),F=P.toLowerCase().replace(/\s+/g,"-");E.className=`status-badge ${F}`.trim(),E.textContent=P,I.appendChild(E);const A=s.insertCell();A.className="actions-cell";const w=`trade-pl-${e.id??e.tradeId??e.uniqueId??`${e.ticker||"trade"}-${i}`}`.toString().replace(/[^a-zA-Z0-9_-]/g,"-"),M=`${w}-footnote`,R=document.createElement("button");R.type="button",R.className="action-btn action-btn--pl",R.textContent="P&L",R.title="View payoff diagram",R.addEventListener("click",i=>{i.stopPropagation();const r=t.querySelector(`.trade-detail-row[data-chart-id="${w}"]`);r&&this.toggleTradePayoffDetail(s,r,e,w,M)});const O=document.createElement("button");O.type="button",O.className="action-btn action-btn--edit",O.textContent="Edit",O.addEventListener("click",t=>{t.stopPropagation(),this.editTrade(e.id)});const B=document.createElement("button");B.type="button",B.className="action-btn action-btn--delete",B.textContent="Delete",B.addEventListener("click",t=>{t.stopPropagation(),this.deleteTrade(e.id)}),A.append(R,O,B),s.setAttribute("tabindex","0"),s.setAttribute("aria-expanded","false"),s.setAttribute("aria-controls",w),s.dataset.chartId=w;const _=t.insertRow();_.className="trade-detail-row",_.setAttribute("aria-hidden","true"),_.style.display="none",_.dataset.chartId=w;const $=_.insertCell(0);$.colSpan=a.length;const U=document.createElement("div");U.className="trade-diagram",U.setAttribute("data-chart-container",w);const K=document.createElement("div");K.className="trade-diagram__canvas";const G=document.createElement("canvas");G.id=w,G.setAttribute("aria-hidden","true");const q=document.createElement("p");q.className="trade-diagram__footnote",q.id=M,q.textContent="Tap or click the trade row to generate the payoff diagram.",K.appendChild(G),U.appendChild(K),U.appendChild(q),$.appendChild(U);const H=()=>{this.toggleTradePayoffDetail(s,_,e,w,M)};s.addEventListener("click",e=>{e.target.closest("button")||e.target.closest("a")||e.target.closest("input")||e.target.closest(".trade-diagram")||H()}),s.addEventListener("keydown",e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),H())}),this.applyResponsiveLabels(s,a)}),this.syncTradeSelectionCheckboxes(),this.updateMergeColumnVisibility(),this.refreshTradesMergePanelContents()}toggleTradePayoffDetail(e,t,i,r,a){if(!t)return;const s=!t.classList.contains("is-open");t.classList.toggle("is-open",s),t.style.display=s?"table-row":"none",t.setAttribute("aria-hidden",String(!s)),e?.setAttribute("aria-expanded",String(s));const n=t.querySelector("canvas");if(n&&n.setAttribute("aria-hidden",String(!s)),s){const e=this.renderTradePayoffChart(i,r,a);e?.catch&&e.catch(e=>{console.error("Failed to render payoff chart:",e)})}else this.destroyTradePayoffChart(r,a)}async renderTradePayoffChart(e,t,i){const r=document.getElementById(t),a=document.getElementById(i),s=r?.parentElement;if(!r)return void(a&&(a.textContent="Canvas element missing; cannot generate payoff diagram."));if(this.tradeDetailCharts?.has(t))return;a&&(a.textContent="Loading live price and payoff data…");const n=this.calculatePayoffSeries(e);if(!n||!Array.isArray(n.points)||0===n.points.length)return s&&s.classList.add("trade-diagram__canvas--empty"),r.classList.add("hidden"),void(a&&(a.textContent=n?.message||"Payoff diagram not available for this strategy yet."));r.classList.remove("hidden"),s?.classList.remove("trade-diagram__canvas--empty");const o=r.getContext("2d");if(!o)return void(a&&(a.textContent="Unable to access canvas rendering context."));const l=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:2}),c="rgba(34, 197, 94, 1)",d="rgba(34, 197, 94, 0.15)",u="rgba(248, 113, 113, 0.15)",m=n.points.map(e=>e.y);let h=Math.min(...m,0),p=Math.max(...m,0);if(!Number.isFinite(h)||!Number.isFinite(p))return void(a&&(a.textContent="Unable to calculate payoff range."));const g=Number(e.maxRiskOverride||e.maxRisk);Number.isFinite(g)&&g>0&&(h=Math.min(h,-g));const y=Math.min(...n.points.map(e=>e.x)),f=Math.max(...n.points.map(e=>e.x)),b=[{x:y,y:0},...n.points.map(e=>({x:e.x,y:e.y>0?e.y:0})),{x:f,y:0}],C=[{x:y,y:0},...n.points.map(e=>({x:e.x,y:e.y<0?e.y:0})),{x:f,y:0}],S=await this.getUnderlyingPriceForPayoff(e),T=document.querySelector(`.trade-detail-row[data-chart-id="${t}"]`);if(T&&!T.classList.contains("is-open"))return void(a&&(a.textContent="Tap or click the trade row to generate the payoff diagram."));const L={id:`payoffPriceLineLabel-${t}`,afterDatasetsDraw:e=>{if(!Number.isFinite(S))return;const t=e.scales?.x,i=e.chartArea;if(!t||!i)return;const r=t.getPixelForValue(S);if(!Number.isFinite(r)||r<i.left||r>i.right)return;e.scales;const a=e.ctx;a.save(),a.font='12px "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',a.fillStyle="rgba(30, 41, 59, 0.9)",a.textBaseline="middle",a.textAlign="center";let s=i.bottom-10-50;(!Number.isFinite(s)||s<i.top+12)&&(s=i.top+12);const n=r<(i.left+i.right)/2?Math.min(i.right-18,r+18):Math.max(i.left+18,r-18),o=`Current ${l.format(S)}`;a.translate(n,s),a.rotate(-Math.PI/2),a.fillText(o,0,0),a.restore()}},x=[{id:"currentPriceLine",label:"Current Price",data:[],borderColor:"rgba(100, 116, 139, 0.95)",borderDash:[6,4],borderWidth:2,hoverBorderColor:"rgba(100, 116, 139, 0.95)",hoverBorderWidth:2,pointRadius:0,pointHitRadius:0,fill:!1,order:0,hidden:!0},{id:"breakevenLine",label:"Breakeven",data:[],borderColor:"rgba(59, 130, 246, 0.8)",borderDash:[2,4],borderWidth:1,pointRadius:0,pointHitRadius:0,fill:!1,order:0,hidden:!0},{id:"positiveFill",label:"Profit Region",data:b,borderColor:"rgba(0,0,0,0)",backgroundColor:d,hoverBackgroundColor:d,hoverBorderColor:"rgba(0, 0, 0, 0)",hoverBorderWidth:0,fill:"origin",pointRadius:0,pointHitRadius:0,tension:0,order:1,spanGaps:!0,showLine:!0},{id:"negativeFill",label:"Loss Region",data:C,borderColor:"rgba(0,0,0,0)",backgroundColor:u,hoverBackgroundColor:u,hoverBorderColor:"rgba(0, 0, 0, 0)",hoverBorderWidth:0,fill:"origin",pointRadius:0,pointHitRadius:0,tension:0,order:1,spanGaps:!0,showLine:!0},{id:"payoffLine",label:"P&L at Expiration",data:n.points,borderColor:c,hoverBorderColor:c,hoverBorderWidth:2,tension:0,pointRadius:0,pointHoverRadius:0,borderWidth:2,fill:!1,order:2,segment:{borderColor:e=>{const t=e.p0.parsed?.y,i=e.p1.parsed?.y;return t>=0&&i>=0?c:t<=0&&i<=0?"rgba(248, 113, 113, 1)":"rgba(148, 163, 184, 1)"}}},{id:"zeroLine",label:"Break-even Baseline",data:n.zeroLinePoints??n.points.map(e=>({x:e.x,y:0})),borderColor:"rgba(71, 85, 105, 0.9)",borderDash:[4,4],borderWidth:2,hoverBorderColor:"rgba(71, 85, 105, 0.95)",hoverBorderWidth:2,pointRadius:0,pointHitRadius:0,fill:!1,order:3}];if(Number.isFinite(S)){const e=x.findIndex(e=>"currentPriceLine"===e.id);-1!==e&&(x[e].data=[{x:S,y:h},{x:S,y:p}],x[e].hidden=!1)}const k=Array.isArray(n.breakeven)?n.breakeven[0]:n.breakeven;if(Number.isFinite(k)){const e=x.findIndex(e=>"breakevenLine"===e.id);-1!==e&&(x[e].data=[{x:k,y:h},{x:k,y:p}],x[e].hidden=!1)}const v=new Chart(o,{type:"line",data:{datasets:x},plugins:[L],options:{parsing:!1,responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},hover:{mode:"index",intersect:!1},layout:{padding:{top:10,right:10,bottom:5,left:5}},plugins:{legend:{display:!1},tooltip:{backgroundColor:"rgba(30, 41, 59, 0.95)",titleColor:"rgba(255, 255, 255, 0.95)",bodyColor:"rgba(255, 255, 255, 0.9)",borderColor:"rgba(148, 163, 184, 0.3)",borderWidth:1,padding:10,displayColors:!1,titleFont:{size:13,weight:"bold"},bodyFont:{size:12},callbacks:{title:e=>{const t=Number(e[0]?.parsed?.x);return Number.isFinite(t)?`At ${l.format(t)}`:""},label:e=>{if(!e.dataset||"payoffLine"!==e.dataset.id)return null;const t=Number(e.parsed?.y);if(!Number.isFinite(t))return null;return`${t>=0?"Profit":"Loss"}: ${l.format(t)}`}}}},scales:{x:{type:"linear",title:{display:!0,text:"Underlying Price",font:{size:11,weight:"600"},color:"rgba(100, 116, 139, 0.9)"},ticks:{font:{size:10},maxRotation:0,autoSkipPadding:20,callback:e=>l.format(Number(e)).replace(".00","")},grid:{color:"rgba(148, 163, 184, 0.1)",drawBorder:!1}},y:{title:{display:!0,text:"P&L",font:{size:11,weight:"600"},color:"rgba(100, 116, 139, 0.9)"},ticks:{font:{size:10},callback:e=>l.format(Number(e)).replace(".00","")},grid:{color:"rgba(148, 163, 184, 0.1)",drawBorder:!1},suggestedMin:h,suggestedMax:p}}}});this.tradeDetailCharts.set(t,v),a&&(a.textContent=this.formatPayoffFooter(n,l))}destroyTradePayoffChart(e,t){const i=this.tradeDetailCharts?.get(e);if(i){try{i.destroy()}catch(e){console.warn("Failed to destroy payoff chart:",e)}this.tradeDetailCharts.delete(e)}const r=document.getElementById(e),a=r?.parentElement;if(r){const e=r.getContext("2d");e&&e.clearRect(0,0,r.width,r.height),r.classList.remove("hidden")}if(a?.classList.remove("trade-diagram__canvas--empty"),t){const e=document.getElementById(t);e&&(e.textContent="Tap or click the trade row to generate the payoff diagram.")}}async getUnderlyingPriceForPayoff(e={}){const t=(e?.ticker||"").toString().trim().toUpperCase();if(t){const e=this.getCachedQuote(t);if(e?.value&&Number.isFinite(Number(e.value.price)))return Number(e.value.price);if(this.finnhub.apiKey)try{const e=await this.getCurrentPrice(t),i=Number(e?.price);if(Number.isFinite(i)&&i>0)return i}catch(e){console.warn("Live price lookup failed for payoff chart:",e)}}return this.getFallbackUnderlyingPrice(e)}getFallbackUnderlyingPrice(e={}){const t=[e.currentUnderlyingPrice,e.currentPrice,e.marketPrice,e.lastUnderlyingPrice,e.lastPrice,e.markPrice,e.referencePrice,e.stockPriceAtEntry];for(const e of t){const t=Number(e);if(Number.isFinite(t)&&t>0)return t}return null}calculatePayoffSeries(e){const t=this.determinePayoffModel(e);if(!t||"unsupported"===t.type)return{message:t?.reason||"Payoff diagram not available for this strategy yet."};switch(t.type){case"single":return this.calculateSingleLegSeries(e,t);case"vertical":return this.calculateVerticalSpreadSeries(e,t);case"multi-leg":return this.calculateMultiLegSeries(e,t);case"covered-call":return this.calculateCoveredCallSeries(e,t);case"pmcc":return this.calculatePmccSeries(e,t);default:return{message:"Payoff diagram not available for this strategy yet."}}}determinePayoffModel(e){const t=(e.strategy||"").toString().trim().toLowerCase(),i=Number(e.definedRiskWidth);if(!t)return{type:"unsupported",reason:"Add a strategy name to unlock payoff diagrams."};const r=(Array.isArray(e.legs)?e.legs:[]).filter(e=>{const t=this.getLegSide(e);return"OPEN"===t||"ROLL"===t});if(t.includes("poor man's covered call")||t.includes("poor man")||t.includes("pmcc")||this.isPmccBaseLeg(e)||this.isPmccShortCall(e)){const i=this.extractPmccLegs(e);return i.baseLeg?{type:"pmcc",strategy:t,...i}:{type:"unsupported",reason:"Add the PMCC base leg to this trade to unlock the payoff diagram."}}if(t.includes("covered call"))return{type:"covered-call",strategy:t};if(r.length>=2){const i=this.analyzeMultiLegStrategy(e,r,t);if(i)return i}const a=/(iron|straddle|strangle|butterfly|ratio|lizard|combo|synthetic|double|calendar|diagonal)/.test(t),s=t.includes("put")?"put":t.includes("call")?"call":null,n=/calendar|diagonal/.test(t);if(t.includes("spread")&&!n&&!(i>0)){if(r.length>=2){const i=this.analyzeMultiLegStrategy(e,r,t);if(i)return i}return{type:"unsupported",reason:"Add the defined risk width to visualize this spread."}}if(i>0&&s&&t.includes("spread")&&!n){return{type:"vertical",optionType:s,orientation:t.includes("short")||t.includes("credit")||"short"===this.inferTradeDirection(e)?"short":"long",width:Number(i),strategy:t,legs:r}}if(a){if(r.length>=2){const i=this.analyzeMultiLegStrategy(e,r,t);if(i)return i}return{type:"unsupported",reason:"Visualization for multi-leg strategies such as condors, straddles, or ratios is coming soon."}}if(!s)return{type:"unsupported",reason:"Unable to infer option type from the strategy name."};return{type:"single",optionType:s,direction:"short"===this.inferTradeDirection(e)?"short":"long",strategy:t}}analyzeMultiLegStrategy(e,t,i){const r=t.map(e=>{const t=this.getLegAction(e);return{type:(e.type||e.optionType||"").toString().trim().toUpperCase(),action:t,strike:Number(e.strike),premium:Number(e.premium)||0,quantity:Math.abs(Number(e.quantity)||1),raw:e}}).filter(e=>("CALL"===e.type||"PUT"===e.type)&&Number.isFinite(e.strike)&&e.strike>0);if(r.length<2)return null;const a=r.filter(e=>"CALL"===e.type),s=r.filter(e=>"PUT"===e.type);if(2===r.length&&(2===a.length||2===s.length)){const e=2===a.length?a:s,t=2===a.length?"call":"put",[n,o]=e;if(n.action!==o.action){const e="BUY"===n.action?n:o,a="SELL"===n.action?n:o;Math.abs(e.strike-a.strike);return{type:"multi-leg",subtype:"vertical",optionType:t,orientation:e.strike<a.strike?"long":"short",legs:r,strategy:i}}}return{type:"multi-leg",subtype:"generic",legs:r,strategy:i}}calculateSingleLegSeries(e,t){const i=Number(e.strikePrice),r=Number(e.entryPrice),a=Number(e.fees)||0,s=Math.abs(Number(e.quantity)||1),n=Number(e.stockPriceAtEntry);if(!Number.isFinite(i)||!Number.isFinite(r))return{message:"Provide both a strike price and entry price to view this payoff."};const o=this.buildPriceRange({strikeValues:[i],spot:n}),l=100*s,c=[];for(let e=0;e<=40;e++){const s=o.minPrice+(o.maxPrice-o.minPrice)*e/40,n=this.optionIntrinsic(t.optionType,s,i),d=("long"===t.direction?n-r:r-n)*l-a;c.push({x:parseFloat(s.toFixed(2)),y:parseFloat(d.toFixed(2))})}const d=c.map(e=>({x:e.x,y:0})),u="call"===t.optionType?i+r:i-r,m=r*l;let h,p;"long"===t.direction?(h="call"===t.optionType?1/0:Math.max((i-r)*l-a,0),p=m+a):(h=Math.max(m-a,0),p="call"===t.optionType?1/0:Math.max((i-r)*l+a,0));const g=Number(e.maxRiskOverride||e.maxRisk);Number.isFinite(g)&&g>0&&p!==1/0&&(p=g);return{points:c,zeroLinePoints:d,summary:this.buildPayoffSummary({profileLabel:`${"short"===t.direction?"Short":"Long"} ${t.optionType.toUpperCase()}`,breakeven:u,maxProfit:h,maxLoss:p,contracts:s,isCredit:"short"===t.direction}),breakeven:u,maxProfit:h,maxLoss:p}}calculateMultiLegSeries(e,t){const i=t.legs||[];if(i.length<2)return{message:"Multi-leg payoff requires at least 2 active option legs."};const r=i.map(e=>e.strike).filter(e=>Number.isFinite(e)&&e>0),a=Number(e.stockPriceAtEntry);if(r.length<2)return{message:"Unable to determine strike prices from legs."};const s=this.buildPriceRange({strikeValues:r,spot:a}),n=[];let o=0,l=Number(e.fees)||0;i.forEach(e=>{const t=Number(e.premium)||0,i=100*Math.abs(Number(e.quantity)||1);"BUY"===e.action?o-=Math.abs(t)*i:"SELL"===e.action&&(o+=Math.abs(t)*i)});for(let e=0;e<=40;e++){const t=s.minPrice+(s.maxPrice-s.minPrice)*e/40;let r=o-l;i.forEach(e=>{const i=100*Math.abs(Number(e.quantity)||1),a=this.optionIntrinsic(e.type.toLowerCase(),t,e.strike);"BUY"===e.action?r+=a*i:"SELL"===e.action&&(r-=a*i)}),n.push({x:parseFloat(t.toFixed(2)),y:parseFloat(r.toFixed(2))})}const c=[];for(let e=1;e<n.length;e++){const t=n[e-1],i=n[e];if(t.y<=0&&i.y>=0||t.y>=0&&i.y<=0){const e=(i.y-t.y)/(i.x-t.x),r=t.x-t.y/e;c.push(r)}}const d=n.map(e=>({x:e.x,y:0})),u=n.map(e=>e.y),m=Math.max(...u),h=Number(e.maxRiskOverride||e.maxRisk),p=Number.isFinite(h)&&h>0?h:Math.abs(Math.min(...u,0)),g=Math.min(...i.map(e=>Math.abs(Number(e.quantity)||1))),y=o>0;return{points:n,zeroLinePoints:d,summary:this.buildPayoffSummary({profileLabel:`${"vertical"===t.subtype?"Vertical Spread":"Multi-Leg"} (${i.length} legs)`,breakeven:c.length>0?c:null,maxProfit:m>0?m:null,maxLoss:p>0?p:null,contracts:g,isCredit:y}),breakeven:c.length>0?c:null,maxProfit:m>0?m:null,maxLoss:p>0?p:null}}calculateVerticalSpreadSeries(e,t){const i=Number(e.strikePrice),r=Number(e.entryPrice),a=Number(e.fees)||0,s=Math.abs(Number(e.quantity)||1),n=Number(e.stockPriceAtEntry);if(!Number.isFinite(i)||!Number.isFinite(r))return{message:"Provide strike and entry price to view this spread payoff."};if(!(t.width>0))return{message:"Add the defined risk width to visualize this spread."};let o,l;if("call"===t.optionType?"short"===t.orientation?(o=i,l=i+t.width):(l=i,o=i+t.width):"short"===t.orientation?(o=i,l=i-t.width):(l=i,o=i-t.width),!Number.isFinite(o)||!Number.isFinite(l))return{message:"Unable to determine both strikes for this spread."};const c=this.buildPriceRange({strikeValues:[o,l],spot:n}),d=100*s,u=[];for(let e=0;e<=40;e++){const i=c.minPrice+(c.maxPrice-c.minPrice)*e/40,s=this.optionIntrinsic(t.optionType,i,o),n=this.optionIntrinsic(t.optionType,i,l),m=("short"===t.orientation?r-(s-n):n-s-r)*d-a;u.push({x:parseFloat(i.toFixed(2)),y:parseFloat(m.toFixed(2))})}const m=u.map(e=>({x:e.x,y:0})),h=this.calculateSpreadBreakeven({model:t,shortStrike:o,longStrike:l,entryPrice:r}),p=Math.abs(o-l)*d,g=r*d;let y,f;"short"===t.orientation?(y=Math.max(g-a,0),f=Math.max(p-g,0)+a):(y=Math.max(Math.max(p-g,0)-a,0),f=g+a);const b=Number(e.maxRiskOverride||e.maxRisk);Number.isFinite(b)&&b>0&&(f=b);return{points:u,zeroLinePoints:m,summary:this.buildPayoffSummary({profileLabel:`${"short"===t.orientation?"Short":"Long"} ${"call"===t.optionType?"Call":"Put"} Spread`,breakeven:h,maxProfit:y,maxLoss:f,contracts:s,isCredit:"short"===t.orientation}),breakeven:h,maxProfit:y,maxLoss:f}}calculateCoveredCallSeries(e){const t=Number(e.strikePrice),i=Number(e.entryPrice),r=Number(e.stockPriceAtEntry),a=Number(e.fees)||0,s=Math.abs(Number(e.quantity)||1);if(!Number.isFinite(t)||!Number.isFinite(i)||!Number.isFinite(r))return{message:"Covered call payoff requires strike, option premium, and stock cost basis."};const n=this.buildPriceRange({strikeValues:[t,r],spot:r}),o=100*s,l=[];for(let e=0;e<=40;e++){const s=n.minPrice+(n.maxPrice-n.minPrice)*e/40,c=(s-r+(i-this.optionIntrinsic("call",s,t)))*o-a;l.push({x:parseFloat(s.toFixed(2)),y:parseFloat(c.toFixed(2))})}const c=l.map(e=>({x:e.x,y:0})),d=r-i,u=Math.max((t-r+i)*o-a,0);let m=Math.max((r-i)*o+a,0);const h=Number(e.maxRiskOverride||e.maxRisk);Number.isFinite(h)&&h>0&&(m=h);return{points:l,zeroLinePoints:c,summary:this.buildPayoffSummary({profileLabel:"Covered Call (Stock + Short Call)",breakeven:d,maxProfit:u,maxLoss:m,contracts:s,isCredit:!0}),breakeven:d,maxProfit:u,maxLoss:m}}calculatePmccSeries(e,t){const i=t.baseLeg;if(!i)return{message:"Add the PMCC base leg to visualize this payoff."};const r=Number(i.strikePrice),a=Number(i.entryPrice),s=Number(i.fees)||0,n=Math.abs(Number(i.quantity)||1);if(!Number.isFinite(r)||!Number.isFinite(a))return{message:"Provide strike and entry price for the PMCC base leg to view this payoff."};const o=t.shortLeg,l=Number(o?.strikePrice),c=Number(o?.entryPrice),d=Number(o?.fees)||0,u=Math.abs(Number(o?.quantity)||0),m=o?this.inferTradeDirection(o):null,h=[r];Number.isFinite(l)&&h.push(l);const p=this.getFallbackUnderlyingPrice(i)??(o?this.getFallbackUnderlyingPrice(o):null)??Number(i.stockPriceAtEntry),g=this.buildPriceRange({strikeValues:h,spot:Number.isFinite(p)?p:Number.NaN}),y=100*n,f=u>0?100*u:y,b=[];for(let e=0;e<=80;e++){const t=g.minPrice+(g.maxPrice-g.minPrice)*e/80,i=(Math.max(t-r,0)-a)*y-s;let n=0;if(o&&Number.isFinite(l)&&Number.isFinite(c)){const e=Math.max(t-l,0);n=("short"===m?c-e:e-c)*f-d}const u=i+n;b.push({x:parseFloat(t.toFixed(2)),y:parseFloat(u.toFixed(2))})}const C=b.map(e=>({x:e.x,y:0})),S=a*y+s;let T=0;o&&Number.isFinite(c)&&(T="short"===m?c*f-d:-(c*f+d));const L=S-T,x=y>0?L/y:0,k=Number.isFinite(x)?r+x:null;let v=1/0;if(o&&Number.isFinite(l)&&"short"===m){const e=Math.max(Math.min(n,u),0);if(e>0){const t=l-r;Number.isFinite(t)&&(v=100*t*e-L)}}let N=L>0?L:0;const D=Number(e.maxRiskOverride||e.maxRisk);Number.isFinite(D)&&D>0&&(N=D);return{points:b,zeroLinePoints:C,summary:this.buildPayoffSummary({profileLabel:"Poor Man's Covered Call",breakeven:k,maxProfit:v,maxLoss:N,contracts:n,isCredit:L<0}),breakeven:k,maxProfit:v,maxLoss:N}}calculateSpreadBreakeven({model:e,shortStrike:t,longStrike:i,entryPrice:r}){return"short"===e.orientation?"call"===e.optionType?t+r:t-r:"call"===e.optionType?i+r:i-r}optionIntrinsic(e,t,i){return Number.isFinite(t)&&Number.isFinite(i)?"call"===e?Math.max(t-i,0):Math.max(i-t,0):0}extractPmccLegs(e={}){const t=e=>(e||"").toString().trim().toUpperCase(),i=t(e.ticker),r=i?this.trades.filter(e=>t(e.ticker)===i):[];r.includes(e)||r.push(e);const a=(e=[])=>[...e].sort((e,t)=>{const i=this.normalizeStatus(e.status),r=this.normalizeStatus(t.status);if("open"===i&&"open"!==r)return-1;if("open"!==i&&"open"===r)return 1;const a=new Date(e.entryDate||e.openDate||0).getTime();return new Date(t.entryDate||t.openDate||0).getTime()-a});let s=a(r.filter(e=>this.isPmccBaseLeg(e)))[0];if(!s){s=a(r.filter(e=>"long"===this.inferTradeDirection(e)&&(e.strategy||"").toLowerCase().includes("call")))[0]||("long"===this.inferTradeDirection(e)?e:null)}let n=a(r.filter(e=>this.isPmccShortCall(e)))[0];if(!n){n=a(r.filter(e=>"short"===this.inferTradeDirection(e)&&(e.strategy||"").toLowerCase().includes("call")))[0]||("short"===this.inferTradeDirection(e)?e:null)}return s&&n&&s===n&&(n=null),{baseLeg:s,shortLeg:n}}buildPriceRange({strikeValues:e=[],spot:t=Number.NaN}={}){const i=e.map(e=>Number(e)).filter(Number.isFinite);if(Number.isFinite(t)&&i.push(t),0===i.length)return{minPrice:0,maxPrice:100};let r=Math.max(Math.min(...i),0),a=Math.max(...i);if(r===a)r=Math.max(0,.7*r),a=1.3*a+1;else{const e=a-r;r=Math.max(0,r-.3*e),a+=.3*e}return a-r<5&&(r=Math.max(0,r-2.5),a+=2.5),{minPrice:r,maxPrice:a}}buildPayoffSummary({profileLabel:e,breakeven:t,maxProfit:i,maxLoss:r,contracts:a,isCredit:s=!1}){const n=[];return e&&n.push(e),Number.isFinite(t)&&n.push(`Breakeven ${this.formatCurrency(t)}`),i===1/0?n.push("Max profit unlimited"):Number.isFinite(i)&&n.push(`Max profit ${this.formatCurrency(i)}`),r===1/0?n.push("Max loss unlimited (theoretical)"):Number.isFinite(r)&&n.push(`Max loss ${this.formatCurrency(r)}`),Number.isFinite(a)&&n.push(`${a} contract${1===a?"":"s"}${s?" (credit)":""}`),n.join(" • ")||"Payoff preview unavailable."}formatPayoffFooter(e,t){const i=e=>e===1/0||e===-1/0?"Unlimited":Number.isFinite(e)?t.format(e):"—";return[`Max profit ${i(e?.maxProfit)}`,`Max loss ${i(e?.maxLoss)}`,`Breakeven ${i(e?.breakeven)}`].join(" • ")}getTradePayoffMeta(e){const t=(e.strategy||"Unspecified strategy").toString(),i=this.getTradeType(e)||"—",r=this.getDisplayStatus(e),a=Math.abs(Number(e.quantity));return[t,i,Number.isFinite(a)&&a>0?`${a} contract${1===a?"":"s"}`:null,r].filter(Boolean).join(" • ")}sortTrades(e){if(!e)return;const t="asc"===this.sortDirection[e]?"desc":"asc";this.sortDirection[e]=t,this.currentSort={key:e,direction:t};const i=document.getElementById("trades-table");if(i){i.querySelectorAll(".sortable").forEach(e=>{e.classList.remove("asc","desc"),e.removeAttribute("aria-sort")});const r=i.querySelector(`[data-sort="${e}"]`);r&&(r.classList.add(t),r.setAttribute("aria-sort","asc"===t?"ascending":"descending"))}const r=Array.isArray(this.currentFilteredTrades)?this.currentFilteredTrades:this.trades,a=this.applySortToTrades(r,e,t);this.currentFilteredTrades=a.slice(),this.renderTradesTable(a)}deleteTrade(e){confirm("Are you sure you want to delete this trade?")&&(this.trades=this.trades.filter(t=>t.id!==e),this.saveToStorage(),this.markUnsavedChanges(),this.filterTrades(),this.updateDashboard())}editTrade(e){const t=this.trades.find(t=>t.id===e);if(!t)return;this.resetAddTradeForm(),this.currentEditingId=e;const i=document.getElementById("add-trade-form");if(!i)return;const r=i.elements;if(r.ticker&&(r.ticker.value=t.ticker||""),r.strategy&&(r.strategy.value=t.strategy||""),r.exitReason&&(r.exitReason.value=t.exitReason||""),r.notes&&(r.notes.value=t.notes||""),r.underlyingType){const e=this.normalizeUnderlyingType(t.underlyingType,{fallback:"Stock"})||"Stock";r.underlyingType.value=e}if(r.tradeStatus){const e=this.normalizeTradeStatusInput(t.statusOverride);r.tradeStatus.value=e||""}this.renderLegForms(t.legs||[]),this.updateTickerPreview(t.ticker||""),this.showView("add-trade")}exportToCSV(){const e=e=>{if(null==e)return"";const t=String(e);return""===t?"":/[",\n]/.test(t)?`"${t.replace(/"/g,'""')}"`:t},t=e=>null==e||"—"===e?"":e,i=e=>{const i=Number(e);return Number.isFinite(i)?t(this.formatCurrency(i)):""},r=(e,i=0)=>{const r=Number(e);return Number.isFinite(r)?t(this.formatNumber(r,{decimals:i,useGrouping:!0})):""},a=e=>{const i=Number(e);if(i===Number.POSITIVE_INFINITY)return"Infinite";if(!Number.isFinite(i))return"";const r=t(this.formatNumber(i,{decimals:2,useGrouping:!0}));return r?`${r}%`:`${i.toFixed(2)}%`},s=e=>null==e?"":i(e),n=(e,t=0)=>null==e?"":r(e,t),o=this.trades.map(t=>[t.ticker??"",t.strategy??"",this.getTradeType(t)??"",s(t.strikePrice),s(t.definedRiskWidth),n(Math.abs(t.quantity),0),s(t.exitPrice),n(t.dte,0),n(t.daysHeld,0),t.entryDate??"",t.expirationDate??"",t.exitDate??"",s(t.maxRisk),s(t.pl),a(t.roi),a(t.annualizedROI),t.status??"",s(t.stockPriceAtEntry),s(t.fees),s(t.maxRiskOverride),n(t.ivRank,2),t.notes??"",t.exitReason??""].map(e).join(",")),l=[["Ticker","Strategy","Trade Type","Strike","Defined Risk Width","Qty","Exit Price","DTE","Days Held","Entry Date","Expiration Date","Exit Date","Max Risk","P&L","ROI %","Annual ROI %","Status","Stock Price at Entry","Fees","Max Risk Override","IV Rank","Notes","Exit Reason"].map(e).join(","),...o].join("\n"),c=new Blob([l],{type:"text/csv"}),d=window.URL.createObjectURL(c),u=document.createElement("a");u.style.display="none",u.href=d,u.download="options_trades_enhanced.csv",document.body.appendChild(u),u.click(),window.URL.revokeObjectURL(d),document.body.removeChild(u)}async saveDatabase(){this.showLoadingIndicator("Saving...");try{const e=this.buildDatabasePayload();this.supportsFileSystemAccess?await this.saveWithFileSystemAPI(e):this.saveWithDownload(e),this.hasUnsavedChanges=!1,this.updateUnsavedIndicator(),this.showNotification("Database saved successfully!","success"),this.saveToStorage({fileName:this.currentFileName})}catch(e){if(console.error("Save error:",e),"AbortError"!==e.name)try{const e=this.buildDatabasePayload();this.saveWithDownload(e),this.hasUnsavedChanges=!1,this.updateUnsavedIndicator(),this.showNotification("Database saved as download!","success"),this.saveToStorage({fileName:this.currentFileName})}catch(e){this.showNotification("Failed to save database","error")}}this.hideLoadingIndicator()}getStorageTrades(){return Array.isArray(this.trades)?this.trades.map(e=>this.buildTradeStorageSnapshot(e)).filter(Boolean):[]}buildTradeStorageSnapshot(e){if(!e||"object"!=typeof e)return null;const t={};for(const[i,r]of Object.entries(e))if(!RUNTIME_TRADE_FIELDS.has(i))if("legs"!==i)void 0!==r&&(null!==r?Array.isArray(r)?t[i]=r.map(e=>"object"==typeof e&&null!==e?{...e}:e):t[i]="object"!=typeof r?r:{...r}:t[i]=null);else if(Array.isArray(r)){const e=r.map(e=>this.buildLegStorageSnapshot(e)).filter(Boolean);t.legs=e}else t.legs=[];return Array.isArray(t.legs)||(t.legs=[]),t}buildLegStorageSnapshot(e){if(!e||"object"!=typeof e)return null;const t={};for(const[i,r]of Object.entries(e))RUNTIME_LEG_FIELDS.has(i)||void 0!==r&&(null!==r?Array.isArray(r)?t[i]=r.slice():t[i]="object"!=typeof r?r:{...r}:t[i]=null);return t}buildDatabasePayload(){return{trades:this.getStorageTrades(),exportDate:(new Date).toISOString(),version:"2.5"}}async saveWithFileSystemAPI(e){try{this.currentFileHandle||(this.currentFileHandle=await window.showSaveFilePicker({suggestedName:"gammaledger.json",types:[{description:"JSON files",accept:{"application/json":[".json"]}}]}));const t=await this.currentFileHandle.createWritable();await t.write(JSON.stringify(e,null,2)),await t.close(),this.currentFileName=this.currentFileHandle.name,this.updateFileNameDisplay()}catch(e){throw e}}saveWithDownload(e){const t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),i=URL.createObjectURL(t),r=document.createElement("a");r.href=i,r.download="gammaledger.json",document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(i),this.currentFileName="gammaledger.json",this.updateFileNameDisplay()}async loadDatabase(){this.showLoadingIndicator("Loading...");try{this.supportsFileSystemAccess?await this.loadWithFileSystemAPI():this.loadWithFileInput()}catch(e){console.error("Load error:",e),"AbortError"!==e.name&&this.loadWithFileInput()}this.hideLoadingIndicator()}async loadWithFileSystemAPI(){const[e]=await window.showOpenFilePicker({types:[{description:"JSON files",accept:{"application/json":[".json"]}}]}),t=await e.getFile(),i=await t.text(),r=JSON.parse(i);this.processLoadedData(r,{fileName:e.name,source:"file-open"}),this.currentFileHandle=e,this.showNotification(`Loaded ${this.trades.length} trades successfully!`,"success")}loadWithFileInput(){const e=document.getElementById("file-input");e.onchange=t=>{const i=t.target.files[0];if(i){const t=new FileReader;t.onload=t=>{try{const e=JSON.parse(t.target.result);this.processLoadedData(e,{fileName:i.name,source:"file-open"}),this.showNotification(`Loaded ${this.trades.length} trades successfully!`,"success")}catch(e){this.showNotification("Invalid JSON file","error")}e.value=""},t.readAsText(i)}else e.value=""},e.click()}setupImportControls(){if(this.importControlsInitialized)return;const e=document.getElementById("import-ofx-btn"),t=document.getElementById("import-json-btn"),i=document.getElementById("import-ofx-input"),r=document.getElementById("import-json-input");e&&i&&(e.addEventListener("click",e=>{e.preventDefault(),i.value="",i.click()}),i.addEventListener("change",e=>{this.handleOfxFileSelection(e)})),t&&r&&(t.addEventListener("click",e=>{e.preventDefault(),r.value="",r.click()}),r.addEventListener("change",async e=>{const t=e?.target;if(!t||!t.files||0===t.files.length)return;const[i]=t.files;if(t.value="",i)try{this.showLoadingIndicator("Importing JSON...");const e=await i.text(),t=JSON.parse(e),r=Array.isArray(t?.trades)?t.trades.length:0;this.processLoadedData(t,{fileName:i.name||"Imported JSON",source:"json-import"}),this.appendImportLog({type:"success",message:`Imported ${r} trades from ${i.name||"JSON file"}.`,timestamp:new Date})}catch(e){console.error("JSON import error:",e),this.showNotification("Invalid JSON file","error"),this.appendImportLog({type:"error",message:`Failed to import JSON: ${e?.message||"Unknown error"}.`,timestamp:new Date})}finally{this.hideLoadingIndicator()}}));const a=document.getElementById("import-merge-btn");a&&a.addEventListener("click",e=>{e.preventDefault(),this.mergeSelectedImportTrades()});const s=document.getElementById("import-merge-hint-btn");s&&s.addEventListener("click",e=>{e.preventDefault(),this.showView("trades-list"),this.setupTradesMergeControls(),this.toggleTradesMergePanel(!0)}),this.renderImportSummary(),this.refreshImportMergeList(),this.importControlsInitialized=!0}setupTradesMergeControls(){const e=document.getElementById("trades-merge-panel");if(e){if(!this.tradesMergeInitialized){const t=document.getElementById("trades-merge-btn");t&&t.addEventListener("click",e=>{e.preventDefault(),this.mergeSelectedTradesFromList()});const i=document.getElementById("trades-select-all");i&&i.addEventListener("change",e=>{this.handleSelectAllTrades(Boolean(e.target.checked))});const r=document.getElementById("trades-merge-toggle");r&&r.addEventListener("click",e=>{e.preventDefault(),this.toggleTradesMergePanel()}),e.classList.add("is-collapsed"),e.setAttribute("aria-hidden","true"),this.tradesMergePanelOpen=!1,this.tradesMergeInitialized=!0}this.updateTradesMergeToggleLabel(),this.updateMergeColumnVisibility(),this.syncSelectAllCheckbox(),this.refreshTradesMergePanelContents()}}toggleTradesMergePanel(e=null){const t="boolean"==typeof e?e:!this.tradesMergePanelOpen;this.tradesMergePanelOpen=t;const i=document.getElementById("trades-merge-panel");i&&(i.classList.toggle("is-collapsed",!t),i.setAttribute("aria-hidden",String(!t))),this.updateTradesMergeToggleLabel(),this.updateMergeColumnVisibility(),this.syncSelectAllCheckbox(),this.refreshTradesMergePanelContents()}updateTradesMergeToggleLabel(){const e=document.getElementById("trades-merge-toggle");if(!e)return;const t=Boolean(this.tradesMergePanelOpen);e.textContent=t?"Hide Merge Trades":"Merge Trades",e.setAttribute("aria-expanded",String(t)),e.classList.toggle("is-active",t)}updateMergeColumnVisibility(){const e=!this.tradesMergePanelOpen,t=document.querySelector(".trade-select-header");t&&(t.classList.toggle("is-hidden",e),t.setAttribute("aria-hidden",String(e)));const i=document.getElementById("trades-select-all");i&&(e&&(i.checked=!1,i.indeterminate=!1),i.disabled=e),document.querySelectorAll(".trade-select-cell").forEach(t=>{t.classList.toggle("is-hidden",e)}),document.querySelectorAll(".trade-merge-checkbox").forEach(t=>{t.disabled=e,t.tabIndex=e?-1:0})}refreshTradesMergePanelContents(){const e=document.getElementById("trades-merge-summary"),t=document.getElementById("trades-merge-groups"),i=document.getElementById("trades-merge-btn");if(!this.tradesMergePanelOpen)return e&&(e.textContent='Select "Merge Trades" to analyze possible combinations grouped by ticker.'),t&&(t.innerHTML='<p class="trades-merge-groups__empty">Enable the merge panel to review grouped trades.</p>'),void(i&&(i.disabled=!0,i.textContent="Merge Selected Trades",i.title="Enable the merge panel to review trade combinations."));i&&(i.title="Merge selected trades that share a ticker."),this.renderTradeMergeSelectionSummary(),this.renderTradeMergeGroups(this.currentFilteredTrades),this.updateTradesMergeButtonState()}appendImportLog(e={}){const t=e.timestamp instanceof Date?e.timestamp:new Date,i=e.type||"info",r=e.message||"";r&&(this.importLog=[{timestamp:t,type:i,message:r},...this.importLog].slice(0,12),this.renderImportLog())}renderImportLog(){const e=document.getElementById("import-log");if(!e)return;if(!Array.isArray(this.importLog)||0===this.importLog.length)return void(e.innerHTML="<p>No imports recorded yet.</p>");const t=new Intl.DateTimeFormat("en-US",{dateStyle:"medium",timeStyle:"short"});e.innerHTML=this.importLog.map(e=>{const i=t.format(e.timestamp);return`<div class="import-log__entry"><strong>${"error"===e.type?"Error":"success"===e.type?"Success":"Info"} · ${i}</strong><span>${this.escapeHTML(e.message)}</span></div>`}).join("")}updateImportSummary(e={}){const t={timestamp:e.timestamp instanceof Date?e.timestamp:new Date(e.timestamp||Date.now()),fileName:e.fileName||"OFX import",batchId:e.batchId||null,stats:{...e.stats||{}},reviewTradeIds:Array.isArray(e.reviewTradeIds)?e.reviewTradeIds.slice():[],mergedTrades:Number.isFinite(e.mergedTrades)?Number(e.mergedTrades):0};this.importSummary=t,this.importMergeSelection.clear()}renderImportSummary(){const e=document.getElementById("import-summary");if(!e)return;if(!this.importSummary)return void(e.innerHTML='<p class="import-summary__empty">Run an OFX import to see how many trades and legs were created.</p>');const t=this.importSummary,i=t.stats||{},r=t.fileName||"OFX import",a=t.timestamp instanceof Date?t.timestamp:new Date(t.timestamp||Date.now()),s=new Intl.DateTimeFormat("en-US",{dateStyle:"medium",timeStyle:"short"}),n=Number.isNaN(a.getTime())?"—":s.format(a),o=e=>{const t=Number(e);return Number.isFinite(t)?this.formatNumber(t,{decimals:0,useGrouping:!0})??"0":null==e?"0":e.toString()},l=(i.legsAddedToNewTrades||0)+(i.legsAddedToUpdates||0),c=this.countImportReviewTrades(t.batchId),d=this.countImportReviewTrades(),u=[{label:"Transactions processed",value:i.totalTransactions??0},{label:"Trades created",value:i.totalTradesCreated??(i.tradesCreated||0)+(i.reviewTradesCreated||0)},{label:"Trades updated",value:i.tradesUpdated??0},{label:t.batchId?"Review trades (this import)":"Review trades pending",value:c},{label:"Legs imported",value:l},{label:"Duplicate legs skipped",value:i.duplicateLegs??0}];(t.mergedTrades||0)>0&&u.push({label:"Manual merges",value:t.mergedTrades}),t.batchId&&d>c&&u.push({label:"Review trades (all)",value:d}),e.innerHTML=`\n            <div class="import-summary__meta">\n                <span title="Imported file">${this.escapeHTML(r)}</span>\n                <span title="Imported at">${this.escapeHTML(n)}</span>\n            </div>\n            <div class="import-summary__grid">\n                ${u.map(e=>`\n                    <div class="import-summary__item">\n                        <span class="import-summary__value">${this.escapeHTML(o(e.value))}</span>\n                        <span class="import-summary__label">${this.escapeHTML(e.label)}</span>\n                    </div>\n                `).join("")}\n            </div>\n        `}countImportReviewTrades(e=null){return this.trades.filter(t=>!!t?.importReview&&(!e||t.importBatchId===e)).length}getImportReviewTrades(){return this.trades.filter(e=>e?.importReview).slice().sort((e,t)=>{const i=new Date(e.openedDate||e.entryDate||0).getTime();return new Date(t.openedDate||t.entryDate||0).getTime()-i})}refreshImportMergeList(){const e=document.getElementById("import-merge-list"),t=document.getElementById("import-merge-hint"),i=document.getElementById("import-merge-hint-btn"),r=document.getElementById("import-merge-btn"),a=this.getImportReviewTrades();if(a.length){const e=new Set(a.map(e=>e.id));Array.from(this.importMergeSelection).forEach(t=>{e.has(t)||this.importMergeSelection.delete(t)})}else this.importMergeSelection.clear();if(t)if(a.length){const e=1===a.length?"review trade":"review trades";t.textContent=`Detected ${a.length} ${e} that might be combined. Open the All Trades page and enable "Merge Trades" to review them.`}else t.textContent="No review trades require manual merging right now.";if(i&&(a.length?(i.disabled=!1,i.title="Review potential merges on the All Trades page."):(i.disabled=!0,i.title="No merge opportunities detected from the latest import.")),!e)return void(r&&(r.disabled=!0,r.textContent="Merge Selected Trades"));if(!a.length)return e.innerHTML='<p class="import-merge__empty">No review trades are waiting to be merged.</p>',void(r&&(r.disabled=!0,r.textContent="Merge Selected Trades"));const s=new Intl.DateTimeFormat("en-US",{dateStyle:"medium"});e.innerHTML=a.map(e=>{const t=this.importMergeSelection.has(e.id),i=Array.isArray(e.legs)?e.legs.length:0,r=e.openedDate||e.entryDate||"",a=r?new Date(r):null,n=a&&!Number.isNaN(a.getTime())?s.format(a):"—";let o=(e.notes||"").trim();o.length>140&&(o=`${o.slice(0,137)}…`);const l=e.importBatchId?`Batch ${e.importBatchId}`:"Manual Review",c=["import-merge-card"];return t&&c.push("is-selected"),`\n                <div class="${c.join(" ")}" data-trade-id="${this.escapeHTML(e.id)}">\n                    <label class="import-merge-card__label">\n                        <input type="checkbox" value="${this.escapeHTML(e.id)}" ${t?"checked":""} />\n                        <div class="import-merge-card__content">\n                            <div class="import-merge-card__header">\n                                <span class="import-merge-card__ticker">${this.escapeHTML(e.ticker||"—")}</span>\n                                <span class="import-merge-card__legs">${i} leg${1===i?"":"s"}</span>\n                            </div>\n                            <div class="import-merge-card__meta">\n                                <span>${this.escapeHTML(l)}</span>\n                                <span>${this.escapeHTML(n)}</span>\n                            </div>\n                            ${o?`<p class="import-merge-card__notes">${this.escapeHTML(o)}</p>`:""}\n                        </div>\n                    </label>\n                </div>\n            `}).join(""),e.querySelectorAll('input[type="checkbox"]').forEach(e=>{e.addEventListener("change",e=>{const t=e.target,i=t.value;if(!i)return;t.checked?this.importMergeSelection.add(i):this.importMergeSelection.delete(i);const r=t.closest(".import-merge-card");r&&r.classList.toggle("is-selected",t.checked),this.updateImportMergeButtonState()})}),this.updateImportMergeButtonState()}updateImportMergeButtonState(){const e=document.getElementById("import-merge-btn");if(!e)return;const t=this.importMergeSelection.size;e.disabled=t<2,e.textContent=t>=2?`Merge ${t} Trades`:"Merge Selected Trades"}resolveMergedExitReason(e=[]){const t=Array.isArray(e)?e.map(e=>(e?.exitReason||"").toString().trim()).filter(Boolean):[];if(0===t.length)return"";const i=Array.from(new Set(t));return 1===i.length?i[0]:`${i[0]} (+${i.length-1} more)`}buildMergedTradeNote(e=[],t=""){const i=new Date,r=(t||"").toString().trim().replace(/\.*$/,""),a=r?`${r}. `:"",s=Array.isArray(e)?e.length:0,n=`${a}Merged ${s} trade${1===s?"":"s"} on ${i.toLocaleDateString("en-US",{dateStyle:"medium"})} at ${i.toLocaleTimeString("en-US",{timeStyle:"short"})}.`,o=`Source trades: ${e.map(e=>e.id).join(", ")}.`,l=e.map(e=>(e.notes||"").trim()).filter(Boolean);return l.length?`${n} ${o}\n\n${l.join("\n\n")}`:`${n} ${o}`}createMergedTradeFromTrades(e=[],t={}){const i=Array.isArray(e)?e.filter(e=>e&&Array.isArray(e.legs)&&e.legs.length>0):[];if(i.length<2)throw new Error("At least two trades with legs are required to merge.");const r=new Set(i.map(e=>(e.ticker||"").toUpperCase()).filter(Boolean));if(r.size>1)throw new Error("Trades must share the same ticker before merging.");const a=[];let s="string"==typeof t.batchId?t.batchId:null;if(i.forEach(e=>{!s&&e.importBatchId&&(s=e.importBatchId),(e.legs||[]).forEach((t,i)=>{if(!t)return;const r={...t};r.id||(r.id=`LEG-${e.id}-${i}`),s&&!r.importBatchId&&(r.importBatchId=s),a.push(r)})}),!a.length)throw new Error("No legs were found to merge.");const n=`${t.idPrefix||"MERGED"}-${Date.now()}-${Math.random().toString(16).slice(2,6)}`,o=t.baseTrade||i[0],l=r.size?Array.from(r)[0]:"UNKNOWN",c=t.strategyOverride&&t.strategyOverride.toString().trim(),d=i.map(e=>(e.strategy||"").toString().trim()).filter(Boolean),u=d.find(e=>e&&"Import Review"!==e&&"Imported Multi-Leg"!==e),m=d[0]||"Imported Multi-Leg",h=c||u||m,p=this.normalizeUnderlyingType(o?.underlyingType,{fallback:"Stock"}),g=this.normalizeTradeStatusInput(o?.statusOverride);return this.enrichTradeData({id:n,ticker:l,strategy:h,status:o?.status||"Open",statusOverride:g||null,notes:this.buildMergedTradeNote(i,t.notePrefix||""),legs:a,importBatchId:s||null,importReview:!1,exitReason:t.exitReasonOverride||this.resolveMergedExitReason(i),underlyingType:p})}mergeSelectedImportTrades(){const e=Array.from(this.importMergeSelection);if(e.length<2)return void this.showNotification("Select at least two review trades to merge.","info");const t=e.map(e=>this.trades.find(t=>t.id===e)).filter(Boolean);if(t.length<2)return this.showNotification("Unable to locate all selected trades. Refresh the list and try again.","error"),void this.refreshImportMergeList();let i;try{i=this.createMergedTradeFromTrades(t,{idPrefix:"IMP-MERGED",notePrefix:"Import review merge"})}catch(e){return void this.showNotification(e.message,"error")}const r=new Set(t.map(e=>e.id));this.trades=this.trades.filter(e=>!r.has(e.id)),this.trades.push(i),this.importSummary&&(this.importSummary.mergedTrades=(this.importSummary.mergedTrades||0)+1,Array.isArray(this.importSummary.reviewTradeIds)&&(this.importSummary.reviewTradeIds=this.importSummary.reviewTradeIds.filter(e=>!r.has(e)))),this.importMergeSelection.clear(),t.forEach(e=>this.tradeMergeSelection.delete(e.id)),this.saveToStorage({fileName:this.currentFileName}),this.markUnsavedChanges(),this.updateDashboard(),"function"==typeof this.updateTradesList&&this.updateTradesList();const a=i.ticker||"Trade";this.appendImportLog({type:"success",message:`Merged ${t.length} review trades into a ${i.legsCount}-leg trade for ${a}.`,timestamp:new Date}),this.showNotification("Review trades merged into a single multi-leg trade.","success"),this.renderImportSummary(),this.refreshImportMergeList(),this.refreshTradesMergePanelContents()}mergeSelectedTradesFromList(){const e=Array.from(this.tradeMergeSelection);if(e.length<2)return void this.showNotification("Select at least two trades to merge.","info");const t=e.map(e=>this.trades.find(t=>t.id===e)).filter(Boolean);if(t.length<2)return this.showNotification("Unable to locate all selected trades. Refresh the table and try again.","error"),void this.pruneTradeMergeSelection();const i=new Set(t.map(e=>(e.ticker||"").toUpperCase()).filter(Boolean));if(1!==i.size)return void this.showNotification("Trades must share the same ticker before merging.","error");const r=Array.from(i)[0],a=t.reduce((e,t)=>e+((t.legs||[]).length||0),0),s=Array.from(new Set(t.map(e=>this.getDisplayStatus(e)))).filter(Boolean),n=t.map(e=>this.parseDateValue(e.entryDate||e.openedDate)).filter(e=>e instanceof Date&&!Number.isNaN(e.getTime())).sort((e,t)=>e.getTime()-t.getTime()),o=new Intl.DateTimeFormat("en-US",{dateStyle:"medium"}),l=n.length?`${o.format(n[0])} - ${o.format(n[n.length-1])}`:"N/A",c=t.reduce((e,t)=>e+Math.max(0,Number(t.openContracts)||0),0),d=[`Merge ${t.length} trades for ${r}?`,`Total legs: ${a}`,`Status mix: ${s.join(", ")||"N/A"}`,`Entry range: ${l}`,`Open contracts (net): ${c}`,"The original trades will be replaced by a single multi-leg trade.","Continue?"].join("\n");if(!window.confirm(d))return;let u;try{u=this.createMergedTradeFromTrades(t,{idPrefix:"MANUAL-MERGED",notePrefix:"Manual merge"})}catch(e){return void this.showNotification(e.message,"error")}const m=new Set(t.map(e=>e.id));this.trades=this.trades.filter(e=>!m.has(e.id)),this.trades.push(u),this.importSummary&&(this.importSummary.mergedTrades=(this.importSummary.mergedTrades||0)+1),this.tradeMergeSelection.clear(),this.saveToStorage({fileName:this.currentFileName}),this.markUnsavedChanges(),this.filterTrades(),this.updateDashboard(),this.renderImportSummary(),this.refreshImportMergeList(),this.appendImportLog({type:"success",message:`Merged ${t.length} trades into a ${u.legsCount}-leg trade for ${u.ticker}.`,timestamp:new Date}),this.showNotification(`Merged ${t.length} trades for ${u.ticker}.`,"success")}renderTradeMergeSelectionSummary(){const e=document.getElementById("trades-merge-summary");if(!e)return;const t=Array.from(this.tradeMergeSelection);if(!t.length)return void(e.textContent="Select two or more trades with the same ticker to enable merging.");const i=t.map(e=>this.trades.find(t=>t.id===e)).filter(Boolean);if(!i.length)return this.tradeMergeSelection.clear(),void(e.textContent="Select two or more trades with the same ticker to enable merging.");const r=Array.from(new Set(i.map(e=>(e.ticker||"").toUpperCase()).filter(Boolean))),a=i.reduce((e,t)=>e+((t.legs||[]).length||0),0),s=Array.from(new Set(i.map(e=>this.getDisplayStatus(e)))).filter(Boolean),n=[`<strong>${this.escapeHTML(`${i.length} trade${1===i.length?"":"s"} selected`)}</strong>`,r.length?`<span>${this.escapeHTML(1===r.length?`Ticker: ${r[0]}`:`Tickers: ${r.join(", ")}`)}</span>`:"",`<span>${this.escapeHTML(`Total legs: ${a}`)}</span>`,s.length?`<span>${this.escapeHTML(`Status mix: ${s.join(", ")}`)}</span>`:""];r.length>1&&n.push(`<span>${this.escapeHTML("Different tickers selected - merge disabled")}</span>`),e.innerHTML=n.filter(Boolean).join(" ")}renderTradeMergeGroups(e=this.currentFilteredTrades){const t=document.getElementById("trades-merge-groups");if(!t)return;const i=(Array.isArray(e)?e:[]).reduce((e,t)=>{const i=(t.ticker||"").toUpperCase();return i?(e.has(i)||e.set(i,[]),e.get(i).push(t),e):e},new Map),r=Array.from(i.entries()).filter(([,e])=>e.length>=2).sort(([e],[t])=>e.localeCompare(t));r.length?(t.innerHTML=r.map(([e,t])=>{const i=t.filter(e=>this.tradeMergeSelection.has(e.id)).length,r=Array.from(new Set(t.map(e=>this.getDisplayStatus(e)))).filter(Boolean),a=t.reduce((e,t)=>e+((t.legs||[]).length||0),0),s=i===t.length,n=t.length-i,o=s?`Clear ${e} selection`:n===t.length?`Select ${t.length} trades`:`Select remaining (${n})`;return`\n                <div class="trades-merge-group" data-ticker="${this.escapeHTML(e)}">\n                    <div class="trades-merge-group__header">\n                        <span class="trades-merge-group__ticker">${this.escapeHTML(e)}</span>\n                        <span class="trades-merge-group__count">${this.escapeHTML(`${t.length} trades • ${a} legs`)}</span>\n                    </div>\n                    <div class="trades-merge-group__body">\n                        ${r.length?`<span>Statuses: ${this.escapeHTML(r.join(", "))}</span>`:""}\n                        <span>Selected: ${this.escapeHTML(`${i}/${t.length}`)}</span>\n                    </div>\n                    <div class="trades-merge-group__actions">\n                        <button type="button" class="btn btn--sm btn--secondary trades-merge-group__toggle" data-ticker="${this.escapeHTML(e)}">${this.escapeHTML(o)}</button>\n                    </div>\n                </div>\n            `}).join(""),t.querySelectorAll(".trades-merge-group__toggle").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const i=(e.getAttribute("data-ticker")||"").toUpperCase();if(!i)return;const r=(Array.isArray(this.currentFilteredTrades)?this.currentFilteredTrades:[]).filter(e=>(e.ticker||"").toUpperCase()===i);if(!r.length)return;const a=r.every(e=>this.tradeMergeSelection.has(e.id));r.forEach(e=>{a?this.tradeMergeSelection.delete(e.id):this.tradeMergeSelection.add(e.id)}),this.syncTradeSelectionCheckboxes(),this.refreshTradesMergePanelContents()})})):t.innerHTML='<p class="trades-merge-groups__empty">Need at least two trades sharing a ticker to merge.</p>'}updateTradesMergeButtonState(){const e=document.getElementById("trades-merge-btn");if(!e)return;if(!this.tradesMergePanelOpen)return e.disabled=!0,e.textContent="Merge Selected Trades",void(e.title="Enable the merge panel to review trade combinations.");const t=Array.from(this.tradeMergeSelection).map(e=>this.trades.find(t=>t.id===e)).filter(Boolean);if(t.length<2)return e.disabled=!0,e.textContent="Merge Selected Trades",void(e.title="Select at least two trades to merge.");const i=new Set(t.map(e=>(e.ticker||"").toUpperCase()).filter(Boolean));if(1!==i.size)return e.disabled=!0,e.textContent="Merge Selected Trades",void(e.title="Select trades that share the same ticker.");e.disabled=!1,e.textContent=`Merge ${t.length} Trades`,e.title=`Merge ${t.length} trades for ${Array.from(i)[0]}.`}syncTradeSelectionCheckboxes(){document.querySelectorAll(".trade-merge-checkbox").forEach(e=>{const t=e.dataset.tradeId;e.checked=!!t&&this.tradeMergeSelection.has(t)}),this.syncSelectAllCheckbox()}syncSelectAllCheckbox(){const e=document.getElementById("trades-select-all");if(!e)return;const t=Array.from(document.querySelectorAll(".trade-merge-checkbox"));if(!(this.tradesMergePanelOpen&&t.length))return e.checked=!1,e.indeterminate=!1,void(e.disabled=!0);e.disabled=!1;const i=t.filter(e=>{const t=e.dataset.tradeId;return t&&this.tradeMergeSelection.has(t)}).length;0===i?(e.checked=!1,e.indeterminate=!1):i===t.length?(e.checked=!0,e.indeterminate=!1):(e.checked=!1,e.indeterminate=!0)}handleSelectAllTrades(e){if(!this.tradesMergePanelOpen)return;const t=Array.from(document.querySelectorAll(".trade-merge-checkbox"));t.length&&(t.forEach(t=>{const i=t.dataset.tradeId;i&&(e?this.tradeMergeSelection.add(i):this.tradeMergeSelection.delete(i),t.checked=e)}),this.syncSelectAllCheckbox(),this.refreshTradesMergePanelContents())}pruneTradeMergeSelection(){if(!(this.tradeMergeSelection instanceof Set)||0===this.tradeMergeSelection.size)return;const e=new Set(this.trades.map(e=>e.id));let t=!1;this.tradeMergeSelection.forEach(i=>{e.has(i)||(this.tradeMergeSelection.delete(i),t=!0)}),t&&(this.syncTradeSelectionCheckboxes(),this.refreshTradesMergePanelContents())}async handleOfxFileSelection(e){const t=e?.target;if(!t||!t.files||0===t.files.length)return;const[i]=t.files;if(t.value="",i)try{this.showLoadingIndicator("Importing OFX..."),await this.importOfxFile(i,{fileName:i.name||"OFX import"})}catch(e){console.error("OFX import error:",e);const t=e?.message||"Unknown error";this.showNotification(`Failed to import OFX: ${t}`,"error"),this.appendImportLog({type:"error",message:`Failed to import ${i.name||"OFX file"}: ${t}`,timestamp:new Date})}finally{this.hideLoadingIndicator()}}async importOfxFile(e,t={}){if(!e)throw new Error("No file selected.");const i=await e.text();await this.importOfxContent(i,{...t,fileSize:e.size||0})}async importOfxContent(e,t={}){const i=t.batchId||`OFX-${Date.now()}-${Math.random().toString(16).slice(2,8)}`,r={...t,batchId:i},a=this.parseOfx(e),s=this.buildOfxImportPayload(a,r);this.applyOfxImportResult(s,r)}parseOfx(e){if("string"!=typeof e)throw new Error("OFX payload is invalid.");const t=e.indexOf("<OFX");if(-1===t)throw new Error("Invalid OFX file: missing OFX root.");const i=e.slice(t).trim(),r=(new DOMParser).parseFromString(i,"application/xml");if(r.querySelector("parsererror"))throw new Error("Unable to parse OFX document.");const a=this.extractOfxSecurities(r);return{securities:a,transactions:this.extractOfxTransactions(r,a)}}extractOfxSecurities(e){const t=new Map,i=e.getElementsByTagName("SECLIST")[0];if(!i)return t;const r=(e,t)=>{if(!e)return"";const i=e.getElementsByTagName(t)[0];return i?i.textContent.trim():""};return Array.from(i.children).forEach(e=>{if(!(e instanceof Element))return;const i=e.tagName,a=e.getElementsByTagName("SECINFO")[0];if(!a)return;const s=r(a,"UNIQUEID");if(!s)return;const n=r(a,"TICKER"),o=r(a,"SECNAME"),l={id:s,tag:i,ticker:n,name:o,option:null};if("OPTINFO"===i){const t=r(e,"STRIKEPRICE"),i=r(e,"SHPERCTRCT"),a=r(e,"DTEXPIRE"),s=r(e,"OPTTYPE"),c=this.parseOptionContractSymbol(n||o),d=this.parseOfxDate(a);l.option={underlying:c?.underlying||(n?n.split(" ")[0].trim():""),type:(s||c?.type||"").toUpperCase(),strike:t?Number(t):c?.strike??null,expiration:d?d.toISOString().slice(0,10):c?.expiration||"",multiplier:i?Number(i):c?.multiplier??100}}t.set(s,l)}),t}parseOptionContractSymbol(e=""){const t=(e||"").toString().replace(/\s+/g,"").toUpperCase().match(/^([A-Z]{1,6})(\d{6})([CP])(\d{8})/);if(!t)return null;const i=t[1],r=t[2],a=t[3],s=t[4],n=this.parseOfxDate(r),o=Number(parseInt(s,10)/1e3);return{underlying:i,expiration:n?n.toISOString().slice(0,10):"",type:"P"===a?"PUT":"CALL",strike:o,multiplier:100}}parseOfxDate(e){if(!e)return null;const t=e.toString().replace(/[^0-9]/g,"");if(!t)return null;if(6===t.length){const e=Number(t.slice(0,2));if(!Number.isFinite(e))return null;const i=e>=70?1900+e:2e3+e,r=Number(t.slice(2,4))-1,a=Number(t.slice(4,6)),s=new Date(Date.UTC(i,r,a));return Number.isNaN(s.getTime())?null:s}if(t.length>=8){const e=Number(t.slice(0,4)),i=Number(t.slice(4,6))-1,r=Number(t.slice(6,8)),a=t.length>=10?Number(t.slice(8,10)):0,s=t.length>=12?Number(t.slice(10,12)):0,n=t.length>=14?Number(t.slice(12,14)):0,o=new Date(Date.UTC(e,i,r,a,s,n));return Number.isNaN(o.getTime())?null:o}return null}mapOfxOrderType(e,t,i=0){const r=(t||"").toString().trim().toUpperCase();switch(e){case"BUYOPT":return"BUYTOCLOSE"===r?"BTC":"BTO";case"SELLOPT":return"SELLTOCLOSE"===r?"STC":"STO";case"BUYSTOCK":return"BUYTOCOVER"===r?"BTC":"BTO";case"SELLSTOCK":return"SELLSHORT"===r?"STO":"SELLTOCLOSE"===r?"STC":i<0?"STO":"STC";default:return"BTO"}}extractOfxTransactions(e,t){const i=[],r=e.getElementsByTagName("INVTRANLIST")[0];if(!r)return i;const a=(e,t)=>{if(!e)return"";const i=e.getElementsByTagName(t)[0];return i?i.textContent.trim():""};return Array.from(r.children).forEach(e=>{if(!(e instanceof Element))return;const r=e.tagName;if(!["BUYOPT","SELLOPT","BUYSTOCK","SELLSTOCK"].includes(r))return;const s="BUYOPT"===r||"BUYSTOCK"===r?e.getElementsByTagName("INVBUY")[0]:e.getElementsByTagName("INVSELL")[0];if(!s)return;const n=s.getElementsByTagName("INVTRAN")[0],o=a(n,"FITID")||a(e,"FITID"),l=this.sanitizeExternalLegId(o);if(!l)return;const c=a(n,"DTTRADE")||a(e,"DTTRADE"),d=this.parseOfxDate(c),u=d?d.toISOString().slice(0,10):"",m=(c||"").replace(/[^0-9]/g,""),h=m.length>=14?m.slice(0,14):m.slice(0,8)||u.replace(/-/g,""),p=a(s,"UNIQUEID"),g=p?t.get(p):null,y=Number(a(s,"UNITS")||"0"),f=Number(a(s,"UNITPRICE")||"0"),b=Number(a(s,"TOTAL")||"0"),C=Number(a(s,"COMMISSION")||"0"),S=a(e,"BUYOPT"===r?"OPTBUYTYPE":"SELLOPT"===r?"OPTSELLTYPE":"BUYSTOCK"===r?"BUYTYPE":"SELLTYPE"),T=this.mapOfxOrderType(r,S,y),L=this.mapOrderTypeToActionSide(T),x=r.includes("OPT");let k="",v="",N=null,D="",I=x?100:1,E="";if(g&&g.option)k=(g.option.underlying||"").toUpperCase(),v=g.option.type||"",N=Number.isFinite(Number(g.option.strike))?Number(g.option.strike):null,D=g.option.expiration||"",I=g.option.multiplier||I,E=k;else if(g){if(E=(g.ticker||g.name||"").split(" ")[0].trim().toUpperCase(),x){const e=this.parseOptionContractSymbol(g.ticker||g.name||"");e&&(k=e.underlying.toUpperCase(),v=e.type,N=e.strike,D=e.expiration,I=e.multiplier||I,E=k)}else k=E}E||(E=(k||"").toUpperCase());const P=(k||E||"").toUpperCase(),F=x?"OPTION":"STOCK",A=[h||u.replace(/-/g,""),P,L.side,F];x&&A.push(D||"");const w=A.filter(Boolean).join("|")||l;i.push({externalId:l,groupKey:w,tag:r,orderType:T,tradeDate:u,tradeTimeKey:h,ticker:E,underlying:(k||E||"").toUpperCase(),optionType:v||(x?S&&S.includes("CALL")?"CALL":"PUT":""),strike:N,expiration:D,multiplier:I||(x?100:1),quantity:Math.abs(y),price:Math.abs(f),total:b,fees:Math.abs(C),category:x?"OPTION":"STOCK",securityId:p,memo:a(n,"MEMO")||"",currency:a(s,"CURSYM")||a(e,"CURSYM")||"USD"})}),i}sanitizeExternalLegId(e){return e?e.toString().replace(/[^A-Za-z0-9]/g,""):""}groupTransactionsForImport(e=[]){const t=new Map;return e.forEach(e=>{if(!e||!e.groupKey)return;let i=t.get(e.groupKey);i||(i={key:e.groupKey,ticker:(e.underlying||e.ticker||"").toUpperCase(),transactions:[]},t.set(e.groupKey,i)),i.ticker||!e.underlying&&!e.ticker||(i.ticker=(e.underlying||e.ticker||"").toUpperCase()),i.transactions.push(e)}),t}buildLegFromTransaction(e){if(!e)return null;const t=Math.abs(Number(e.quantity)||0);if(!t)return null;const i=e.optionType||("STOCK"===e.category?"STOCK":"UNKNOWN");return{id:e.externalId?`EXT-${e.externalId}`:`LEG-${Date.now()}-${Math.random().toString(16).slice(2,6)}`,orderType:this.normalizeLegOrderType(e.orderType),type:i,quantity:t,multiplier:e.multiplier||("STOCK"===i?1:100),executionDate:e.tradeDate||"",expirationDate:e.expiration||"",strike:Number.isFinite(Number(e.strike))?Number(e.strike):null,premium:Number.isFinite(Number(e.price))?Number(e.price):0,fees:Number.isFinite(Number(e.fees))?Number(e.fees):0,underlyingPrice:null,externalId:e.externalId||null,importGroupId:e.groupKey||null,importSource:"OFX",tickerSymbol:(e.underlying||e.ticker||"").toUpperCase()}}sanitizeImportedLeg(e){if(!e)return null;const t={...e};return delete t.tickerSymbol,t}buildPositionKey(e,t){if(!t)return"";const i=(e||"").toString().trim().toUpperCase();if(!i)return"";const r=(t.type||"").toString().trim().toUpperCase();if(!r)return"";const a="SELL"===this.getLegAction(t)?"short":"long";if("STOCK"===r)return[i,r,a].join("|");return[i,r,(Number.isFinite(Number(t.strike))?Number(t.strike):0)||0,(t.expirationDate||"").toString().trim()||"",a].join("|")}buildPositionIndex(e=[]){const t=new Map;return e.forEach(e=>{if(!e||!Array.isArray(e.legs)||0===e.legs.length)return;const i=(e.ticker||"").toUpperCase();if(!i)return;const r=new Map;e.legs.forEach(e=>{if(!e)return;const t=this.buildPositionKey(i,e);if(!t)return;const a=Math.abs(Number(e.quantity)||0);if(!a)return;const s=this.getLegSide(e);let n=0;if("OPEN"===s?n=1:"CLOSE"===s&&(n=-1),!n)return;const o=r.get(t)||0;r.set(t,o+n*a)}),r.forEach((i,r)=>{if(i>0){const a=t.get(r)||[];a.push({trade:e,remaining:i}),t.set(r,a)}})}),t}consumePositionMatches(e,t,i){const r={matched:[],unmatched:Math.abs(Number(i?.quantity)||0)};if(!t||!e.has(t)||!i)return r;let a=r.unmatched;const s=e.get(t)||[];s.forEach(e=>{if(a<=0||e.remaining<=0)return;const t=Math.min(e.remaining,a);r.matched.push({trade:e.trade,quantity:t}),e.remaining-=t,a-=t}),r.unmatched=a;const n=s.filter(e=>e.remaining>0);return n.length>0?e.set(t,n):e.delete(t),r}buildExistingExternalIdSet(){const e=new Set;return this.trades.forEach(t=>{t&&Array.isArray(t.legs)&&t.legs.forEach(t=>{t?.externalId&&e.add(t.externalId)})}),e}tradeContainsExternalId(e,t){return!!(t&&e&&Array.isArray(e.legs))&&e.legs.some(e=>e?.externalId&&e.externalId===t)}inferStrategyFromLegs(e=[]){if(!Array.isArray(e)||0===e.length)return"Imported Trade";const t=e.filter(e=>"OPEN"===this.getLegSide(e)),i=t.length?t:e;if(1===i.length){const e=i[0];if(!e)return"Imported Trade";if("PUT"===e.type)return"SELL"===this.getLegAction(e)?"Cash-Secured Put":"Long Put";if("CALL"===e.type)return"SELL"===this.getLegAction(e)?"Short Call":"Long Call";if("STOCK"===e.type)return"SELL"===this.getLegAction(e)?"Stock Sale":"Stock Purchase"}const r=i.filter(e=>"PUT"===e.type||"CALL"===e.type);if(2===r.length){const[e,t]=r;if(e&&t&&e.type===t.type){const e=r.find(e=>"SELL"===this.getLegAction(e));if(e){const t=r.find(t=>t!==e);if(t){const i=Number(e.strike)||0,r=Number(t.strike)||0;return"PUT"===e.type?i>r?"Bull Put Spread":"Bear Put Spread":i<r?"Bear Call Spread":"Bull Call Spread"}}}}return"Imported Multi-Leg"}composeImportNotes(e={},t={}){const i=e.fileName||"OFX file",r=new Date,a=[`Imported from ${i} on ${r.toLocaleDateString("en-US",{dateStyle:"medium"})} at ${r.toLocaleTimeString("en-US",{timeStyle:"short"})}.`];return t.legCount&&a.push(`${t.legCount} leg${1===t.legCount?"":"s"} detected.`),t.hasClosings&&a.push("Includes adjustments to existing positions."),t.note&&a.push(t.note),a.join(" ")}buildOfxImportPayload(e,t={}){const i=Array.isArray(e?.transactions)?e.transactions:[],r=t.batchId||null,a=new Map,s=[],n=[],o={totalTransactions:i.length,totalGroups:0,openingLegs:0,closingLegs:0,matchedClosingLegs:0,unmatchedClosingLegs:0,duplicateLegs:0,legsAddedToUpdates:0,legsAddedToNewTrades:0,tradesCreated:0,reviewTradesCreated:0,totalTradesCreated:0,tradesUpdated:0,reviewLegs:0};if(!i.length)return{newTrades:s,updates:a,stats:o,batchId:r,reviewTradeIds:n};const l=this.groupTransactionsForImport(i),c=this.buildPositionIndex(this.trades),d=this.buildExistingExternalIdSet(),u=new Set;return o.totalGroups=l.size,l.forEach(e=>{if(!e||!Array.isArray(e.transactions)||0===e.transactions.length)return;const i=[];if(e.transactions.forEach(e=>{const t=this.buildLegFromTransaction(e);t&&(t.externalId&&(d.has(t.externalId)||u.has(t.externalId))?o.duplicateLegs+=1:(r&&(t.importBatchId=r),i.push(t)))}),!i.length)return;const l=(e.ticker||i[0]?.tickerSymbol||"").toUpperCase(),m=i.filter(e=>"OPEN"===this.getLegSide(e)),h=i.filter(e=>"CLOSE"===this.getLegSide(e)),p=[];if(o.openingLegs+=m.length,o.closingLegs+=h.length,h.forEach(e=>{const t=this.buildPositionKey(l,e),i=this.consumePositionMatches(c,t,e);i.matched.length&&i.matched.forEach(t=>{const i=t.trade;if(this.tradeContainsExternalId(i,e.externalId))return;if(e.externalId&&(d.has(e.externalId)||u.has(e.externalId)))return;const s=a.get(i.id)||[],n={...e,quantity:t.quantity};r&&(n.importBatchId=r),s.push(this.sanitizeImportedLeg(n)),a.set(i.id,s),o.legsAddedToUpdates+=1,o.matchedClosingLegs+=t.quantity});const s=Math.max(0,i.unmatched);if(!i.matched.length||s>0){const t={...e};s>0&&t.quantity!==s&&(t.quantity=s),i.matched.length&&t.externalId&&(t.externalId=`${t.externalId}-UNMATCHED`),r&&(t.importBatchId=r),p.push(t),o.unmatchedClosingLegs+=t.quantity||0}e.externalId&&u.add(e.externalId)}),m.length>0){const e=this.composeImportNotes(t,{legCount:m.length,hasClosings:h.length>0}),i=m.map(e=>(e.externalId&&u.add(e.externalId),this.sanitizeImportedLeg(e))),a=(l||m[0]?.tickerSymbol||"").toUpperCase()||"UNKNOWN",n=`IMP-${Date.now()}-${Math.random().toString(16).slice(2,8)}`;s.push({id:n,ticker:a,strategy:this.inferStrategyFromLegs(m),exitReason:"",notes:e,legs:i,importBatchId:r,importReview:!1}),o.tradesCreated+=1,o.legsAddedToNewTrades+=i.length}if(p.length>0){const e=this.composeImportNotes(t,{legCount:p.length,note:"Review required: closing legs have no matching open position."}),i=p.map(e=>(e.externalId&&u.add(e.externalId),this.sanitizeImportedLeg(e))),a=(l||p[0]?.tickerSymbol||"").toUpperCase()||"UNKNOWN",c=`IMP-REVIEW-${Date.now()}-${Math.random().toString(16).slice(2,8)}`;s.push({id:c,ticker:a,strategy:"Import Review",exitReason:"",notes:e,legs:i,importBatchId:r,importReview:!0}),n.push(c),o.reviewTradesCreated+=1,o.legsAddedToNewTrades+=i.length}}),o.totalTradesCreated=s.length,o.tradesUpdated=a.size,o.reviewLegs=s.filter(e=>e.importReview).reduce((e,t)=>e+(t.legs||[]).length,0),{newTrades:s,updates:a,stats:o,batchId:r,reviewTradeIds:n}}applyOfxImportResult(e,t={}){if(!e)return;const i=e.stats||{},r=e.batchId||t.batchId||null,a=Array.isArray(e.reviewTradeIds)?e.reviewTradeIds.slice():[];let s=0,n=0;e.updates instanceof Map&&e.updates.forEach((e,i)=>{if(!Array.isArray(e)||0===e.length)return;const r=this.trades.findIndex(e=>e.id===i);if(-1===r)return;const a=this.trades[r],s=[...a.legs,...e.map(e=>({...e}))],o=this.composeImportNotes(t,{legCount:e.length,note:"Existing trade updated from OFX import."}),l=this.enrichTradeData({...a,legs:s,notes:a.notes?`${a.notes}\n${o}`:o});this.trades[r]=l,n+=1}),Array.isArray(e.newTrades)&&e.newTrades.forEach(e=>{if(!e||!Array.isArray(e.legs)||0===e.legs.length)return;e.importReview&&!a.includes(e.id)&&a.push(e.id);const t=this.enrichTradeData(e);this.trades.push(t),s+=1});const o=t?.fileName||"OFX file";if(i.totalTradesCreated=i.totalTradesCreated??s,i.tradesUpdated=n,i.reviewTradesCreated=i.reviewTradesCreated??a.length,s||n){this.saveToStorage(),this.markUnsavedChanges(),this.updateDashboard();const e=[];s&&e.push(`${s} new trade${1===s?"":"s"}`),n&&e.push(`${n} trade${1===n?"":"s"} updated`);const t=e.length?`OFX import completed: ${e.join(", ")}.`:"OFX import completed.";this.showNotification(t,"success"),this.appendImportLog({type:"success",message:`${t} Source: ${o}.`,timestamp:new Date})}else this.showNotification("OFX import completed. No changes detected.","info"),this.appendImportLog({type:"info",message:`OFX import from ${o} completed with no changes.`,timestamp:new Date});this.updateImportSummary({fileName:o,batchId:r,stats:i,reviewTradeIds:a,timestamp:new Date}),this.renderImportSummary(),this.refreshImportMergeList(),this.initializeAIChat()}processLoadedData(e,t={}){if(!e||!Array.isArray(e.trades))throw new Error("Invalid data format");this.trades=e.trades.map(e=>{const t={...e};return t.tradeReasoning&&!t.notes&&(t.notes=t.tradeReasoning,delete t.tradeReasoning),this.enrichTradeData(t)}),t.fileName?this.currentFileName=t.fileName:this.currentFileName||(this.currentFileName="Unsaved Database"),this.hasUnsavedChanges=!1,this.updateUnsavedIndicator(),this.saveToStorage({fileName:this.currentFileName,source:t.source||"import"}),this.updateDashboard(),"trades-list"===this.currentView&&this.updateTradesList(),this.updateFileNameDisplay(),this.initializeAIChat(),this.importSummary=null,this.importMergeSelection.clear(),this.renderImportSummary(),this.refreshImportMergeList()}newDatabase(){this.hasUnsavedChanges&&!confirm("You have unsaved changes. Are you sure you want to create a new database?")||(this.trades=[],this.currentFileHandle=null,this.currentFileName="Unsaved Database",this.hasUnsavedChanges=!1,this.updateFileNameDisplay(),this.updateUnsavedIndicator(),this.saveToStorage({fileName:this.currentFileName}),this.updateDashboard(),this.showNotification("New database created","success"),this.initializeAIChat())}updateFileNameDisplay(){const e=document.getElementById("current-file-name");e&&(e.textContent=this.currentFileName,"Unsaved Database"===this.currentFileName?e.classList.add("is-unsaved"):e.classList.remove("is-unsaved"))}updateUnsavedIndicator(){const e=document.getElementById("unsaved-indicator");this.hasUnsavedChanges?e.classList.remove("hidden"):e.classList.add("hidden")}showLoadingIndicator(e="Loading..."){const t=document.getElementById("loading-indicator");t&&(t.textContent=e,t.classList.remove("hidden"))}hideLoadingIndicator(){const e=document.getElementById("loading-indicator");e&&e.classList.add("hidden")}showNotification(e,t="info"){"error"===t?alert(`Error: ${e}`):console.log(`${t.toUpperCase()}: ${e}`)}markUnsavedChanges(){this.hasUnsavedChanges=!0,this.updateUnsavedIndicator()}saveToStorage(e={}){try{const t={version:"2.5",timestamp:(new Date).toISOString(),fileName:e.fileName||this.currentFileName||"Unsaved Database",trades:this.getStorageTrades()};localStorage.setItem(LOCAL_STORAGE_KEY,JSON.stringify(t)),LEGACY_STORAGE_KEYS.forEach(e=>{e&&e!==LOCAL_STORAGE_KEY&&localStorage.removeItem(e)})}catch(e){console.warn("Failed to save to localStorage:",e)}}async loadFromStorage(){try{const e=localStorage.getItem(LOCAL_STORAGE_KEY);if(e){const t=JSON.parse(e);if(t&&Array.isArray(t.trades))return this.trades=t.trades.map(e=>{const t={...e};return t.tradeReasoning&&!t.notes&&(t.notes=t.tradeReasoning),delete t.tradeReasoning,this.enrichTradeData(t)}),t.fileName&&(this.currentFileName=t.fileName),this.currentFileHandle=null,this.hasUnsavedChanges=!1,this.updateUnsavedIndicator(),this.updateFileNameDisplay(),this.updateDashboard(),!0}for(const e of LEGACY_STORAGE_KEYS){if(!e||e===LOCAL_STORAGE_KEY)continue;const t=localStorage.getItem(e);if(!t)continue;const i=JSON.parse(t);if(Array.isArray(i))return this.trades=i.map(e=>{const t={...e};return t.tradeReasoning&&!t.notes&&(t.notes=t.tradeReasoning),delete t.tradeReasoning,this.enrichTradeData(t)}),this.currentFileName="Unsaved Database",this.hasUnsavedChanges=!1,this.updateUnsavedIndicator(),this.saveToStorage({fileName:this.currentFileName}),this.updateFileNameDisplay(),this.updateDashboard(),!0}}catch(e){console.warn("Failed to load from localStorage:",e)}return!1}formatNumber(e,t={}){const i=Number(e);if(!Number.isFinite(i))return null;const r=t.style||"number",a=Number.isInteger(t.decimals)?Math.max(0,t.decimals):2,s=t.currency||"USD",n="currency"===r,o="boolean"==typeof t.useGrouping?t.useGrouping:n,l=(e,t=a)=>new Intl.NumberFormat("en-US",{useGrouping:o,minimumFractionDigits:t,maximumFractionDigits:t}).format(e);if("currency"===r)return new Intl.NumberFormat("en-US",{style:"currency",currency:s,useGrouping:o,minimumFractionDigits:a,maximumFractionDigits:a}).format(i);if("percent"===r){return`${l(i,Number.isInteger(t.decimals)?Math.max(0,t.decimals):a)}%`}return l(i,a)}formatPercent(e,t="—",i={}){const r=Number(e);if(r===Number.POSITIVE_INFINITY)return"Infinite";if(!Number.isFinite(r))return t;const a=Number.isInteger(i.decimals)?Math.max(0,i.decimals):2,s=this.formatNumber(r,{decimals:a,useGrouping:!0});return s?`${s}%`:`${r.toFixed(a)}%`}getStrategyDisplayName(e=""){const t=(e||"").toString().trim();return t?"PMCC"===t.toUpperCase()?"Poor Man's Covered Call":t:""}escapeHTML(e){return null==e?"":e.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}formatCurrency(e,t={}){const i=Number(e);if(!Number.isFinite(i))return"—";const r=t.currency||"USD",a=Number.isInteger(t.decimals)?Math.max(0,t.decimals):2,s=void 0===t.useGrouping||Boolean(t.useGrouping);return new Intl.NumberFormat("en-US",{style:"currency",currency:r,useGrouping:s,minimumFractionDigits:a,maximumFractionDigits:a}).format(i)}formatDate(e){const t=new Date(e);return isNaN(t.getTime())?"—":t.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}}class LocalInsightsAgent{constructor(e){this.app=e,this.context={stats:null,openTrades:[],closedTrades:[]}}updateContext({stats:e,openTrades:t,closedTrades:i}={}){e&&(this.context.stats=e),Array.isArray(t)&&(this.context.openTrades=t),Array.isArray(i)&&(this.context.closedTrades=i)}hasTradeHistory(){return(this.context.openTrades?.length||0)>0||(this.context.closedTrades?.length||0)>0}getGreeting(){if(!this.hasTradeHistory())return"Hi! I'm your local AI coach. Add or import a few trades and I'll help you analyze risk and performance.";const e=this.context.stats;if(!e)return"Hi! I'm your local AI coach. Ask about performance, risk, or next steps.";const t=this.context.openTrades?.length||0;return`Hi! I'm your local AI coach. You have ${t} active ${1===t?"position":"positions"} and ${this.context.closedTrades?.length||0} closed trades with realised P&L of ${this.formatCurrency(e.totalPL)}.`}generateResponse(e=""){if(!e.trim())return"I can run a portfolio health check, review risk exposure, or suggest strategy adjustments. Try asking for a quick portfolio health check.";if(!this.hasTradeHistory())return"Log a few trades first and I'll start surfacing insights about risk, performance, and strategy.";const t=[],i=this.buildPerformanceSummary();i&&t.push(i);const r=this.buildRiskHeadline();r&&t.push(r);const a=this.buildStrategyHeadline();a&&t.push(a);const s=this.buildCoachingHighlight();return s&&t.push(s),t.length||t.push("Portfolio data is limited, but keep logging trades and I'll highlight trends as they emerge."),t.join("\n\n")}buildPerformanceSummary(){const e=this.context.stats;if(!e)return"";const t=this.context.closedTrades?.length||0;if(!t)return"No closed trades yet. Once you realize some P&L I'll summarize your performance here.";const i=this.formatPercent(e.winRate,"—",{decimals:1}),r=e.profitFactor===Number.POSITIVE_INFINITY?"Infinite":Number.isFinite(e.profitFactor)?e.profitFactor.toFixed(2):"—",a=this.formatPercent(e.totalROI,"—");return`Closed trades: ${t}, realised P&L ${this.formatCurrency(e.totalPL)}, win rate ${i}, profit factor ${r}, total ROI ${a}.`}buildRiskHeadline(){const e=this.context.openTrades||[];if(!e.length)return"No open positions right now, so live risk exposure is minimal.";let t=0,i=0,r=null;if(e.forEach(e=>{const a=Math.max(0,Number(this.app.getCapitalAtRisk(e))||0);t+=a,a>i&&(i=a,r=e)}),!t)return"Open positions detected, but max risk looks minimal based on current data.";if(r&&t){const a=(i/t*100).toFixed(0),s=(r.ticker||"Unknown").toUpperCase();return`Open risk across ${e.length} ${1===e.length?"position":"positions"} is ${this.formatCurrency(t)}. ${s} carries the largest share at ${a}% of exposure.`}return`Open risk across ${e.length} ${1===e.length?"position":"positions"} is ${this.formatCurrency(t)}.`}buildStrategyHeadline(){const e=this.getStrategyBreakdown();if(!e.length)return"";const t=e[0];if(!t)return"";const i=t.trades>0?(t.wins/t.trades*100).toFixed(0):"0";return`${t.name} leads with ${this.formatCurrency(t.pl)} across ${t.trades} trades (win rate ${i}%).`}buildCoachingHighlight(){const e=this.context.stats;if(!e)return"";const t=(this.context.closedTrades||[]).filter(e=>e.pl<0),i=(this.context.closedTrades||[]).filter(e=>e.pl>0),r=(e,t)=>{if(!e.length)return NaN;return e.reduce((e,i)=>e+t(i),0)/e.length},a=r(t,e=>Number(e.daysHeld)||0),s=r(i,e=>Number(e.daysHeld)||0);if(Number.isFinite(a)&&Number.isFinite(s)){const e=a-s;if(e>=2)return`Losing trades stay open about ${Math.round(e)} days longer than winners—tighten exits to cut risk sooner.`;if(e<=-2)return`You let winners run roughly ${Math.round(Math.abs(e))} days longer than losers—keep scaling out to lock in gains.`}return Number.isFinite(e.winRate)&&e.winRate<45&&(this.context.closedTrades?.length||0)>=5?"Win rate is under 45%. Focus on highest-conviction setups or scale size down until consistency improves.":""}getStrategyBreakdown(){const e=new Map;return(this.context.closedTrades||[]).forEach(t=>{const i=(t.strategy||"Unclassified").toString().trim()||"Unclassified";e.has(i)||e.set(i,{name:i,pl:0,trades:0,wins:0,losses:0});const r=e.get(i),a=Number(t.pl)||0;r.pl+=a,r.trades+=1,a>0?r.wins+=1:a<0&&(r.losses+=1)}),Array.from(e.values()).sort((e,t)=>t.pl-e.pl)}formatCurrency(e,t){return this.app.formatCurrency(e,t)}formatPercent(e,t="—",i={}){if(this.app&&"function"==typeof this.app.formatPercent)return this.app.formatPercent(e,t,i);const r=Number(e);if(!Number.isFinite(r))return t;const a=i&&Number.isInteger(i.decimals)?Math.max(0,i.decimals):2;return`${r.toFixed(a)}%`}}class GeminiInsightsAgent{constructor(e){this.app=e,this.context={stats:null,openTrades:[],closedTrades:[]},this.fallback=new LocalInsightsAgent(e)}updateContext({stats:e,openTrades:t,closedTrades:i}={}){e&&(this.context.stats=e),Array.isArray(t)&&(this.context.openTrades=t),Array.isArray(i)&&(this.context.closedTrades=i),this.fallback.updateContext({stats:this.context.stats,openTrades:this.context.openTrades,closedTrades:this.context.closedTrades})}getGreeting(){return this.isConfigured()?this.fallback.getGreeting():"Connect your Gemini API key in [Settings](#settings) to get tailored analysis."}isConfigured(){const e=this.app?.gemini;return Boolean(e&&e.apiKey)}async generateResponse(e="",t={}){const i=e.trim();if(!i)return"Ask a question and I'll send it to Gemini along with a snapshot of your portfolio.";if(!this.isConfigured())return"Add a Gemini-compatible API key under [Settings](#settings) to enable AI-powered insights.";try{const e=this.buildRequestPayload(i,t),r=await this.callGemini(e);if(r)return r;throw new Error("Gemini returned an empty response")}catch(t){const i=this.fallback.generateResponse(e),r=t?.message||"Unknown error";return i?`Gemini request failed (${r}). Here's a local snapshot instead:\n\n${i}`:`Gemini request failed (${r}). Try again in a moment.`}}buildRequestPayload(e,t={}){const i=this.app?.gemini||{},r=GEMINI_ALLOWED_MODELS.includes(i.model)?i.model:DEFAULT_GEMINI_MODEL,a=DEFAULT_GEMINI_TEMPERATURE,s=this.buildContextBlock(),n=[...this.buildHistoryContents(t.history||[]),{role:"user",parts:[{text:["# ROLE & PHILOSOPHY","You are an expert options trading coach. Your philosophy is rooted in rigorous risk management, capital preservation, and generating consistent returns. You are assisting an intermediate trader who wants to refine their strategy and tighten their risk controls. Your goal is to provide a concise, data-driven portfolio health check that identifies key risks and offers actionable, educational insights.","# CONTEXT: PORTFOLIO DATA",s,"# TRADER'S OBJECTIVE",e,"# ANALYSIS FRAMEWORK & INSTRUCTIONS",'1.  **Acknowledge Strengths:** Briefly highlight the **strong overall performance** (e.g., win rate, profit factor, successful strategies).\n2.  **Prioritize Top Risks:** Scrutinize the data to identify and explain the **top 2-3 risks**. In addition to the systemic risks below, **identify open positions near expiration (low DTE) or those with previous rolls/adjustments (in the "notes") as potential immediate risks.** Focus specifically on:\n    * **Concentration Risk:** Explicitly cite and explain the **`riskHeadline`**.\n    * **Behavioral Risk:** Connect the **`coachingHighlight`** to the risk.\n3.  **Provide Actionable Recommendations:** Based on the identified risks, provide **clear, bulleted recommendations**. Link them directly to the data.\n    * Suggest a specific rule for **position sizing**.\n    * Propose a concrete action to address the **behavioral risk**.\n4.  **Suggest Next Steps:** Conclude with **2-3 forward-looking actions** for process improvement.',"# OUTPUT FORMATTING","- **Tone:** Professional, direct, and risk-aware coach.\n- **Length:** Keep the response under 400 words.\n- **Structure:** Use bullet points for recommendations and next steps.\n- **Disclaimer:** End with a clear statement that this is educational analysis, not financial advice."].join("\n\n")}]}],o={maxOutputTokens:65536};return o.temperature=Number(a.toFixed(2)),{model:r,body:{contents:n,generationConfig:o}}}buildHistoryContents(e){return Array.isArray(e)&&0!==e.length?e.filter(e=>e&&!e.pending&&"string"==typeof e.text&&e.text.trim().length).slice(-8).map(e=>({role:"ai"===e.sender?"model":"user",parts:[{text:e.text.trim()}]})):[]}buildContextBlock(){const e=this.context.stats||{},t={totals:{totalPL:this.formatNumber(e.totalPL,{style:"currency"}),winRate:this.formatNumber(e.winRate,{style:"percent"}),profitFactor:Number.isFinite(e.profitFactor)?this.formatNumber(e.profitFactor):e.profitFactor===Number.POSITIVE_INFINITY?"Infinite":null,totalROI:this.formatNumber(e.totalROI,{style:"percent"}),annualizedROI:this.formatNumber(e.annualizedROI,{style:"percent"}),maxDrawdown:this.formatNumber(e.maxDrawdown,{style:"percent"}),closedTrades:e.closedTrades??(this.context.closedTrades?.length||0),openPositions:e.activePositions??(this.context.openTrades?.length||0)},riskHeadline:this.fallback.buildRiskHeadline(),strategyHighlight:this.fallback.buildStrategyHeadline(),coachingHighlight:this.fallback.buildCoachingHighlight(),performanceHighlight:this.fallback.buildPerformanceSummary?.()||"",openPositions:this.buildOpenPositionsSummary(),recentClosedTrades:this.buildRecentClosedTradesSummary(),topStrategies:this.buildStrategySummary()};return JSON.stringify(t,null,2)}buildOpenPositionsSummary(e=8){return(Array.isArray(this.context.openTrades)?this.context.openTrades:[]).slice(0,e).map(e=>{const t=this.snapshotObjectForPrompt(e),i={},r=Number.isFinite(e?.dte)?Number(e.dte):this.deriveDTE(e);Number.isFinite(r)&&(i.calculatedDTE=Math.max(Math.round(r),0));const a=Number(this.app.getCapitalAtRisk(e));Number.isFinite(a)&&(i.calculatedMaxRisk=Number(a.toFixed(2)));const s=this.cleanNote(e?.notes);return s&&(i.notePreview=s),Object.keys(i).length&&(t.__promptDerived=i),t})}deriveDTE(e){if(!e?.expirationDate)return null;try{return this.app.calculateDTE(e.expirationDate,e)}catch(e){return null}}buildRecentClosedTradesSummary(e=8){return(Array.isArray(this.context.closedTrades)?[...this.context.closedTrades]:[]).sort((e,t)=>new Date(t.exitDate||0)-new Date(e.exitDate||0)).slice(0,e).map(e=>{const t=this.snapshotObjectForPrompt(e),i={plRounded:this.formatNumber(e?.pl,{style:"currency"}),roiRounded:this.formatNumber(e?.roi,{style:"percent"})},r=this.cleanNote(e?.exitReason);return r&&(i.exitReasonPreview=r),Number.isFinite(e?.daysHeld)&&(i.daysHeld=Number(e.daysHeld)),t.__promptDerived=Object.fromEntries(Object.entries(i).filter(([,e])=>null!=e)),Object.keys(t.__promptDerived).length||delete t.__promptDerived,t})}buildStrategySummary(e=5){return this.fallback.getStrategyBreakdown().slice(0,e).map(e=>({name:e.name,trades:e.trades,wins:e.wins,losses:e.losses,realisedPL:this.formatNumber(e.pl,{style:"currency"}),winRate:e.trades>0?this.formatNumber(e.wins/e.trades*100,{style:"percent"}):null}))}snapshotObjectForPrompt(e){const t=this.snapshotForPrompt(e);return t&&"object"==typeof t&&!Array.isArray(t)?t:{}}snapshotForPrompt(e){if(null==e)return null;if("number"==typeof e)return Number.isFinite(e)?Number(e):null;if("string"==typeof e||"boolean"==typeof e)return e;if(e instanceof Date)return e.toISOString();if(Array.isArray(e))return e.map(e=>this.snapshotForPrompt(e));if("object"==typeof e){const t={};for(const[i,r]of Object.entries(e))"function"!=typeof r&&(t[i]=this.snapshotForPrompt(r));return t}return null}cleanNote(e){if(!e)return"";const t=e.toString().trim();return t.length<=180?t:`${t.slice(0,177)}…`}formatNumber(e,t={}){const i=Object.prototype.hasOwnProperty.call(t||{},"fallback")?t.fallback:null;if(!this.app||"function"!=typeof this.app.formatNumber)return i;const r={...t||{}};if(delete r.fallback,"string"===r.style&&(r.style="number"),"percent"===r.style){const t={};return Number.isInteger(r.decimals)&&(t.decimals=r.decimals),this.app.formatPercent(e,i,t)}return this.app.formatNumber(e,r)??i}formatPercent(e,t,i){return this.app&&"function"==typeof this.app.formatPercent?this.app.formatPercent(e,t,i):t??null}async callGemini({model:e,body:t}){const i=this.app?.gemini?.apiKey;if(!i)throw new Error("Missing Gemini API key");const r=DEFAULT_GEMINI_ENDPOINT.replace(/\/+$/,""),a=(e||DEFAULT_GEMINI_MODEL).replace(/^models\//i,""),s=`${`${r}/${encodeURIComponent(a)}:generateContent`}?key=${encodeURIComponent(i)}`,n="undefined"!=typeof AbortController?new AbortController:null,o=n?setTimeout(()=>n.abort(),2e4):null;try{const e=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":i},body:JSON.stringify(t),signal:n?.signal}),r=await e.json().catch(()=>({}));if(!e.ok){const t=r?.error?.message||r?.message||`HTTP ${e.status}`;throw new Error(t)}if(r?.promptFeedback?.blockReason)throw new Error(`Request blocked (${r.promptFeedback.blockReason})`);const a=r?.candidates?.[0]?.content?.parts;if(!Array.isArray(a)||!a.length)return"";return a.map(e=>e&&"string"==typeof e.text?e.text:"").join("").trim()}finally{o&&clearTimeout(o)}}}document.addEventListener("DOMContentLoaded",function(){window.tracker=new GammaLedger}),window.addEventListener("error",e=>{console.error("Global error caught:",e.error),e.preventDefault()}),window.addEventListener("unhandledrejection",e=>{console.error("Unhandled promise rejection:",e.reason),e.preventDefault()}),window.addEventListener("beforeunload",()=>{window.tracker&&"function"==typeof window.tracker.cleanup&&window.tracker.cleanup()});