const DEFAULT_GEMINI_MODEL="gemini-2.5-flash",GEMINI_ALLOWED_MODELS=["gemini-2.5-flash-lite","gemini-2.5-flash","gemini-2.5-pro"],DEFAULT_GEMINI_TEMPERATURE=.25,DEFAULT_GEMINI_ENDPOINT="https://generativelanguage.googleapis.com/v1beta/models",GEMINI_STORAGE_KEY="GammaLedgerGeminiConfig",GEMINI_SECRET_STORAGE_KEY="GammaLedgerGeminiSecret",DISCLAIMER_STORAGE_KEY="GammaLedgerDisclaimerAcceptedAt",AI_COACH_CONSENT_STORAGE_KEY="GammaLedgerAICoachConsentAt",SIDEBAR_COLLAPSED_STORAGE_KEY="GammaLedgerSidebarCollapsed",LOCAL_STORAGE_KEY="GammaLedgerLocalDatabase",LEGACY_STORAGE_KEY="GammaLedgerTrades",LEGACY_STORAGE_KEYS=[LEGACY_STORAGE_KEY,"GammaLedgerDatabase","GammaLedgerLocalState","GammaLedgerState"],RUNTIME_TRADE_FIELDS=new Set(["legsCount","openContracts","closeContracts","openLegs","rollLegs","netPremium","totalFees","totalDebit","totalCredit","cashFlow","capitalAtRisk","fees","primaryLeg","tradeType","tradeDirection","quantity","strikePrice","multiplier","displayStrike","activeStrikePrice","entryPrice","exitPrice","entryPriceLabel","pmccShortExpiration","longExpirationDate","openedDate","closedDate","entryDate","exitDate","expirationDate","pl","roi","maxRisk","maxRiskLabel","riskIsUnlimited","lifecycleMeta","lifecycleStatus","partialClose","rolledForward","autoExpired","status","daysHeld","dte","annualizedROI","tradeReasoning"]),RUNTIME_LEG_FIELDS=new Set(["externalId","importGroupId","importSource","importBatchId","tickerSymbol"]),SHARE_CARD_EXPORT_SIZE=1080,SHARE_CARD_CHART_WIDTH_RATIO=.78,SHARE_CARD_CHART_HEIGHT_RATIO=.42,SHARE_CARD_CHART_MIN_HEIGHT=320,BUILTIN_SAMPLE_DATA=createBuiltinSampleData();function createBuiltinSampleData(){const e=new Date,t=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate())),i=e=>{const i=new Date(t);return i.setUTCDate(i.getUTCDate()+e),(e=>e.toISOString().slice(0,10))(i)};return{trades:[{id:"TRD-2001",ticker:"SPY",strategy:"Iron Condor",status:"Closed",openedDate:i(-210),closedDate:i(-182),expirationDate:i(-174),exitReason:"Closed early for 70% max profit.",notes:"Monthly condor sized at 3% of capital with 12 delta wings.",legs:[{id:"TRD-2001-L1",action:"SELL",side:"OPEN",type:"CALL",quantity:1,multiplier:100,executionDate:i(-210),expirationDate:i(-174),strike:455,premium:1.2,fees:.35,underlyingPrice:450.6},{id:"TRD-2001-L2",action:"BUY",side:"OPEN",type:"CALL",quantity:1,multiplier:100,executionDate:i(-210),expirationDate:i(-174),strike:460,premium:.45,fees:.2},{id:"TRD-2001-L3",action:"SELL",side:"OPEN",type:"PUT",quantity:1,multiplier:100,executionDate:i(-210),expirationDate:i(-174),strike:430,premium:1.35,fees:.35},{id:"TRD-2001-L4",action:"BUY",side:"OPEN",type:"PUT",quantity:1,multiplier:100,executionDate:i(-210),expirationDate:i(-174),strike:425,premium:.5,fees:.2},{id:"TRD-2001-L5",action:"BUY",side:"CLOSE",type:"CALL",quantity:1,multiplier:100,executionDate:i(-182),expirationDate:i(-174),strike:455,premium:.35,fees:.35},{id:"TRD-2001-L6",action:"SELL",side:"CLOSE",type:"CALL",quantity:1,multiplier:100,executionDate:i(-182),expirationDate:i(-174),strike:460,premium:.15,fees:.2},{id:"TRD-2001-L7",action:"BUY",side:"CLOSE",type:"PUT",quantity:1,multiplier:100,executionDate:i(-182),expirationDate:i(-174),strike:430,premium:.45,fees:.35},{id:"TRD-2001-L8",action:"SELL",side:"CLOSE",type:"PUT",quantity:1,multiplier:100,executionDate:i(-182),expirationDate:i(-174),strike:425,premium:.18,fees:.2}]},{id:"TRD-2002",ticker:"QQQ",strategy:"Bull Put Spread",status:"Closed",openedDate:i(-195),closedDate:i(-168),expirationDate:i(-160),exitReason:"Profit target hit at 65% of credit.",notes:"Put spread aligned with rising 50-day moving average.",legs:[{id:"TRD-2002-L1",action:"SELL",side:"OPEN",type:"PUT",quantity:1,multiplier:100,executionDate:i(-195),expirationDate:i(-160),strike:290,premium:2.05,fees:.3,underlyingPrice:302.4},{id:"TRD-2002-L2",action:"BUY",side:"OPEN",type:"PUT",quantity:1,multiplier:100,executionDate:i(-195),expirationDate:i(-160),strike:280,premium:.9,fees:.2},{id:"TRD-2002-L3",action:"BUY",side:"CLOSE",type:"PUT",quantity:1,multiplier:100,executionDate:i(-168),expirationDate:i(-160),strike:290,premium:.75,fees:.3},{id:"TRD-2002-L4",action:"SELL",side:"CLOSE",type:"PUT",quantity:1,multiplier:100,executionDate:i(-168),expirationDate:i(-160),strike:280,premium:.38,fees:.2}]},{id:"TRD-2003",ticker:"IWM",strategy:"Calendar Spread",status:"Closed",openedDate:i(-180),closedDate:i(-152),expirationDate:i(-150),exitReason:"Closed before near-term expiration to avoid pin risk.",notes:"Theta harvest with seasonal small-cap rally expectations.",legs:[{id:"TRD-2003-L1",action:"BUY",side:"OPEN",type:"CALL",quantity:1,multiplier:100,executionDate:i(-180),expirationDate:i(-90),strike:205,premium:8.9,fees:.45},{id:"TRD-2003-L2",action:"SELL",side:"OPEN",type:"CALL",quantity:1,multiplier:100,executionDate:i(-180),expirationDate:i(-150),strike:205,premium:4.1,fees:.3},{id:"TRD-2003-L3",action:"BUY",side:"CLOSE",type:"CALL",quantity:1,multiplier:100,executionDate:i(-152),expirationDate:i(-150),strike:205,premium:1.25,fees:.3},{id:"TRD-2003-L4",action:"SELL",side:"CLOSE",type:"CALL",quantity:1,multiplier:100,executionDate:i(-152),expirationDate:i(-90),strike:205,premium:10.3,fees:.45}]},{id:"TRD-2004",ticker:"AAPL",strategy:"Covered Call",status:"Closed",openedDate:i(-165),closedDate:i(-135),expirationDate:i(-128),exitReason:"Shares called away at target strike.",notes:"Income overlay on core share position with rolling plan at 21 DTE.",legs:[{id:"TRD-2004-L1",action:"SELL",side:"OPEN",type:"CALL",quantity:1,multiplier:100,executionDate:i(-165),expirationDate:i(-128),strike:190,premium:2.4,fees:.35,underlyingPrice:184.2},{id:"TRD-2004-L2",action:"BUY",side:"CLOSE",type:"CALL",quantity:1,multiplier:100,executionDate:i(-135),expirationDate:i(-128),strike:190,premium:.58,fees:.35}]},{id:"TRD-2005",ticker:"TSLA",strategy:"Short Strangle",status:"Closed",openedDate:i(-150),closedDate:i(-120),expirationDate:i(-112),exitReason:"Closed for risk management after breakout.",notes:"Accepted a small loss after upside breach; drawdown contained to <1R.",legs:[{id:"TRD-2005-L1",action:"SELL",side:"OPEN",type:"CALL",quantity:1,multiplier:100,executionDate:i(-150),expirationDate:i(-112),strike:320,premium:3.9,fees:.45},{id:"TRD-2005-L2",action:"SELL",side:"OPEN",type:"PUT",quantity:1,multiplier:100,executionDate:i(-150),expirationDate:i(-112),strike:260,premium:3.6,fees:.45},{id:"TRD-2005-L3",action:"BUY",side:"CLOSE",type:"CALL",quantity:1,multiplier:100,executionDate:i(-120),expirationDate:i(-112),strike:320,premium:6.2,fees:.45},{id:"TRD-2005-L4",action:"BUY",side:"CLOSE",type:"PUT",quantity:1,multiplier:100,executionDate:i(-120),expirationDate:i(-112),strike:260,premium:1.4,fees:.45}]},{id:"TRD-2006",ticker:"MSFT",strategy:"Diagonal Call Spread",status:"Closed",openedDate:i(-135),closedDate:i(-108),expirationDate:i(-100),exitReason:"Delta target reached ahead of earnings.",notes:"Diagonalized to express bullish momentum while capping risk.",legs:[{id:"TRD-2006-L1",action:"BUY",side:"OPEN",type:"CALL",quantity:1,multiplier:100,executionDate:i(-135),expirationDate:i(-30),strike:320,premium:23.5,fees:.6},{id:"TRD-2006-L2",action:"SELL",side:"OPEN",type:"CALL",quantity:1,multiplier:100,executionDate:i(-135),expirationDate:i(-100),strike:340,premium:5.1,fees:.3},{id:"TRD-2006-L3",action:"BUY",side:"CLOSE",type:"CALL",quantity:1,multiplier:100,executionDate:i(-108),expirationDate:i(-100),strike:340,premium:1.65,fees:.3},{id:"TRD-2006-L4",action:"SELL",side:"CLOSE",type:"CALL",quantity:1,multiplier:100,executionDate:i(-108),expirationDate:i(-30),strike:320,premium:27.8,fees:.6}]},{id:"TRD-2007",ticker:"AMZN",strategy:"Iron Condor",status:"Closed",openedDate:i(-120),closedDate:i(-92),expirationDate:i(-84),exitReason:"Closed for 75% of credit heading into earnings.",notes:"Condor sized at 2% of portfolio; trimmed risk into catalyst.",legs:[{id:"TRD-2007-L1",action:"SELL",side:"OPEN",type:"CALL",quantity:1,multiplier:100,executionDate:i(-120),expirationDate:i(-84),strike:150,premium:1.65,fees:.32},{id:"TRD-2007-L2",action:"BUY",side:"OPEN",type:"CALL",quantity:1,multiplier:100,executionDate:i(-120),expirationDate:i(-84),strike:155,premium:.62,fees:.22},{id:"TRD-2007-L3",action:"SELL",side:"OPEN",type:"PUT",quantity:1,multiplier:100,executionDate:i(-120),expirationDate:i(-84),strike:130,premium:1.72,fees:.32},{id:"TRD-2007-L4",action:"BUY",side:"OPEN",type:"PUT",quantity:1,multiplier:100,executionDate:i(-120),expirationDate:i(-84),strike:125,premium:.58,fees:.22},{id:"TRD-2007-L5",action:"BUY",side:"CLOSE",type:"CALL",quantity:1,multiplier:100,executionDate:i(-92),expirationDate:i(-84),strike:150,premium:.48,fees:.32},{id:"TRD-2007-L6",action:"SELL",side:"CLOSE",type:"CALL",quantity:1,multiplier:100,executionDate:i(-92),expirationDate:i(-84),strike:155,premium:.22,fees:.22},{id:"TRD-2007-L7",action:"BUY",side:"CLOSE",type:"PUT",quantity:1,multiplier:100,executionDate:i(-92),expirationDate:i(-84),strike:130,premium:.62,fees:.32},{id:"TRD-2007-L8",action:"SELL",side:"CLOSE",type:"PUT",quantity:1,multiplier:100,executionDate:i(-92),expirationDate:i(-84),strike:125,premium:.26,fees:.22}]},{id:"TRD-2008",ticker:"XOP",strategy:"Bear Call Spread",status:"Closed",openedDate:i(-105),closedDate:i(-78),expirationDate:i(-70),exitReason:"Trend broke lower, captured 80% of credit.",notes:"Energy ETF roll-down after OPEC meeting volatility.",legs:[{id:"TRD-2008-L1",action:"SELL",side:"OPEN",type:"CALL",quantity:1,multiplier:100,executionDate:i(-105),expirationDate:i(-70),strike:155,premium:1.95,fees:.28},{id:"TRD-2008-L2",action:"BUY",side:"OPEN",type:"CALL",quantity:1,multiplier:100,executionDate:i(-105),expirationDate:i(-70),strike:160,premium:.75,fees:.2},{id:"TRD-2008-L3",action:"BUY",side:"CLOSE",type:"CALL",quantity:1,multiplier:100,executionDate:i(-78),expirationDate:i(-70),strike:155,premium:.48,fees:.28},{id:"TRD-2008-L4",action:"SELL",side:"CLOSE",type:"CALL",quantity:1,multiplier:100,executionDate:i(-78),expirationDate:i(-70),strike:160,premium:.18,fees:.2}]},{id:"TRD-2009",ticker:"RUT",strategy:"Iron Butterfly",status:"Closed",openedDate:i(-90),closedDate:i(-61),expirationDate:i(-56),exitReason:"Took profit at 65% after mean reversion.",notes:"Focused on slow grind environment with flattening skew.",legs:[{id:"TRD-2009-L1",action:"SELL",side:"OPEN",type:"CALL",quantity:1,multiplier:100,executionDate:i(-90),expirationDate:i(-56),strike:2050,premium:5.6,fees:.5},{id:"TRD-2009-L2",action:"SELL",side:"OPEN",type:"PUT",quantity:1,multiplier:100,executionDate:i(-90),expirationDate:i(-56),strike:1950,premium:6.2,fees:.5},{id:"TRD-2009-L3",action:"BUY",side:"OPEN",type:"CALL",quantity:1,multiplier:100,executionDate:i(-90),expirationDate:i(-56),strike:2075,premium:2.4,fees:.4},{id:"TRD-2009-L4",action:"BUY",side:"OPEN",type:"PUT",quantity:1,multiplier:100,executionDate:i(-90),expirationDate:i(-56),strike:1925,premium:2.6,fees:.4},{id:"TRD-2009-L5",action:"BUY",side:"CLOSE",type:"CALL",quantity:1,multiplier:100,executionDate:i(-61),expirationDate:i(-56),strike:2050,premium:1.85,fees:.5},{id:"TRD-2009-L6",action:"BUY",side:"CLOSE",type:"PUT",quantity:1,multiplier:100,executionDate:i(-61),expirationDate:i(-56),strike:1950,premium:2.05,fees:.5},{id:"TRD-2009-L7",action:"SELL",side:"CLOSE",type:"CALL",quantity:1,multiplier:100,executionDate:i(-61),expirationDate:i(-56),strike:2075,premium:.92,fees:.4},{id:"TRD-2009-L8",action:"SELL",side:"CLOSE",type:"PUT",quantity:1,multiplier:100,executionDate:i(-61),expirationDate:i(-56),strike:1925,premium:1.08,fees:.4}]},{id:"TRD-2010",ticker:"GLD",strategy:"Long Straddle",status:"Closed",openedDate:i(-75),closedDate:i(-48),expirationDate:i(-40),exitReason:"Exited on breakout momentum.",notes:"Volatility expansion play into CPI release.",legs:[{id:"TRD-2010-L1",action:"BUY",side:"OPEN",type:"CALL",quantity:1,multiplier:100,executionDate:i(-75),expirationDate:i(-40),strike:190,premium:3.05,fees:.35},{id:"TRD-2010-L2",action:"BUY",side:"OPEN",type:"PUT",quantity:1,multiplier:100,executionDate:i(-75),expirationDate:i(-40),strike:190,premium:2.85,fees:.35},{id:"TRD-2010-L3",action:"SELL",side:"CLOSE",type:"CALL",quantity:1,multiplier:100,executionDate:i(-48),expirationDate:i(-40),strike:190,premium:5.1,fees:.35},{id:"TRD-2010-L4",action:"SELL",side:"CLOSE",type:"PUT",quantity:1,multiplier:100,executionDate:i(-48),expirationDate:i(-40),strike:190,premium:3.95,fees:.35}]},{id:"TRD-2011",ticker:"NVDA",strategy:"Poor Man's Covered Call",status:"Closed",openedDate:i(-60),closedDate:i(-32),expirationDate:i(320),exitReason:"Rolled to capture additional upside after runaway rally.",notes:"Diagonal structure managed by delta and theta thresholds.",legs:[{id:"TRD-2011-L1",action:"BUY",side:"OPEN",type:"CALL",quantity:1,multiplier:100,executionDate:i(-60),expirationDate:i(320),strike:900,premium:78.5,fees:.75},{id:"TRD-2011-L2",action:"SELL",side:"OPEN",type:"CALL",quantity:1,multiplier:100,executionDate:i(-60),expirationDate:i(-20),strike:1150,premium:14.2,fees:.35},{id:"TRD-2011-L3",action:"BUY",side:"CLOSE",type:"CALL",quantity:1,multiplier:100,executionDate:i(-32),expirationDate:i(-20),strike:1150,premium:4.1,fees:.35},{id:"TRD-2011-L4",action:"SELL",side:"CLOSE",type:"CALL",quantity:1,multiplier:100,executionDate:i(-32),expirationDate:i(320),strike:900,premium:82.9,fees:.75}]},{id:"TRD-2012",ticker:"AMD",strategy:"Iron Condor",status:"Closed",openedDate:i(-48),closedDate:i(-24),expirationDate:i(-18),exitReason:"Hit trailing stop after volatility compression.",notes:"Short premium targeting 21 DTE roll cadence.",legs:[{id:"TRD-2012-L1",action:"SELL",side:"OPEN",type:"CALL",quantity:1,multiplier:100,executionDate:i(-48),expirationDate:i(-18),strike:150,premium:2.15,fees:.32},{id:"TRD-2012-L2",action:"BUY",side:"OPEN",type:"CALL",quantity:1,multiplier:100,executionDate:i(-48),expirationDate:i(-18),strike:155,premium:.78,fees:.22},{id:"TRD-2012-L3",action:"SELL",side:"OPEN",type:"PUT",quantity:1,multiplier:100,executionDate:i(-48),expirationDate:i(-18),strike:130,premium:1.98,fees:.32},{id:"TRD-2012-L4",action:"BUY",side:"OPEN",type:"PUT",quantity:1,multiplier:100,executionDate:i(-48),expirationDate:i(-18),strike:125,premium:.68,fees:.22},{id:"TRD-2012-L5",action:"BUY",side:"CLOSE",type:"CALL",quantity:1,multiplier:100,executionDate:i(-24),expirationDate:i(-18),strike:150,premium:.68,fees:.32},{id:"TRD-2012-L6",action:"SELL",side:"CLOSE",type:"CALL",quantity:1,multiplier:100,executionDate:i(-24),expirationDate:i(-18),strike:155,premium:.28,fees:.22},{id:"TRD-2012-L7",action:"BUY",side:"CLOSE",type:"PUT",quantity:1,multiplier:100,executionDate:i(-24),expirationDate:i(-18),strike:130,premium:.75,fees:.32},{id:"TRD-2012-L8",action:"SELL",side:"CLOSE",type:"PUT",quantity:1,multiplier:100,executionDate:i(-24),expirationDate:i(-18),strike:125,premium:.26,fees:.22}]},{id:"TRD-2013",ticker:"META",strategy:"Broken Wing Butterfly",status:"Closed",openedDate:i(-36),closedDate:i(-16),expirationDate:i(-12),exitReason:"Closed near pinned short strike for planned profit.",notes:"Risk-defined structure into product launch event.",legs:[{id:"TRD-2013-L1",action:"BUY",side:"OPEN",type:"CALL",quantity:1,multiplier:100,executionDate:i(-36),expirationDate:i(-12),strike:500,premium:4.1,fees:.3},{id:"TRD-2013-L2",action:"SELL",side:"OPEN",type:"CALL",quantity:2,multiplier:100,executionDate:i(-36),expirationDate:i(-12),strike:520,premium:3.25,fees:.45},{id:"TRD-2013-L3",action:"BUY",side:"OPEN",type:"CALL",quantity:1,multiplier:100,executionDate:i(-36),expirationDate:i(-12),strike:545,premium:1.35,fees:.3},{id:"TRD-2013-L4",action:"SELL",side:"CLOSE",type:"CALL",quantity:1,multiplier:100,executionDate:i(-16),expirationDate:i(-12),strike:520,premium:2.15,fees:.45},{id:"TRD-2013-L5",action:"SELL",side:"CLOSE",type:"CALL",quantity:1,multiplier:100,executionDate:i(-16),expirationDate:i(-12),strike:520,premium:2.1,fees:.45},{id:"TRD-2013-L6",action:"BUY",side:"CLOSE",type:"CALL",quantity:1,multiplier:100,executionDate:i(-16),expirationDate:i(-12),strike:500,premium:3.85,fees:.3},{id:"TRD-2013-L7",action:"BUY",side:"CLOSE",type:"CALL",quantity:1,multiplier:100,executionDate:i(-16),expirationDate:i(-12),strike:545,premium:.65,fees:.3}]},{id:"TRD-2014",ticker:"SPX",strategy:"Iron Condor",status:"Closed",openedDate:i(-24),closedDate:i(-8),expirationDate:i(-4),exitReason:"Closed at 60% profit to avoid NFP volatility.",notes:"Wide wings with automated scaling rules.",legs:[{id:"TRD-2014-L1",action:"SELL",side:"OPEN",type:"CALL",quantity:1,multiplier:100,executionDate:i(-24),expirationDate:i(-4),strike:5650,premium:2.6,fees:.55},{id:"TRD-2014-L2",action:"BUY",side:"OPEN",type:"CALL",quantity:1,multiplier:100,executionDate:i(-24),expirationDate:i(-4),strike:5750,premium:1.1,fees:.45},{id:"TRD-2014-L3",action:"SELL",side:"OPEN",type:"PUT",quantity:1,multiplier:100,executionDate:i(-24),expirationDate:i(-4),strike:5300,premium:3.1,fees:.55},{id:"TRD-2014-L4",action:"BUY",side:"OPEN",type:"PUT",quantity:1,multiplier:100,executionDate:i(-24),expirationDate:i(-4),strike:5200,premium:1.25,fees:.45},{id:"TRD-2014-L5",action:"BUY",side:"CLOSE",type:"CALL",quantity:1,multiplier:100,executionDate:i(-8),expirationDate:i(-4),strike:5650,premium:1.02,fees:.55},{id:"TRD-2014-L6",action:"SELL",side:"CLOSE",type:"CALL",quantity:1,multiplier:100,executionDate:i(-8),expirationDate:i(-4),strike:5750,premium:.44,fees:.45},{id:"TRD-2014-L7",action:"BUY",side:"CLOSE",type:"PUT",quantity:1,multiplier:100,executionDate:i(-8),expirationDate:i(-4),strike:5300,premium:1.18,fees:.55},{id:"TRD-2014-L8",action:"SELL",side:"CLOSE",type:"PUT",quantity:1,multiplier:100,executionDate:i(-8),expirationDate:i(-4),strike:5200,premium:.42,fees:.45}]},{id:"TRD-2015",ticker:"CRM",strategy:"Calendar Spread",status:"Closed",openedDate:i(-18),closedDate:i(-6),expirationDate:i(-4),exitReason:"Closed at 80% of planned target.",notes:"Focused on repeatable monthly ROI with low drawdown.",legs:[{id:"TRD-2015-L1",action:"BUY",side:"OPEN",type:"CALL",quantity:1,multiplier:100,executionDate:i(-18),expirationDate:i(180),strike:280,premium:12.4,fees:.45},{id:"TRD-2015-L2",action:"SELL",side:"OPEN",type:"CALL",quantity:1,multiplier:100,executionDate:i(-18),expirationDate:i(-4),strike:280,premium:4.65,fees:.3},{id:"TRD-2015-L3",action:"BUY",side:"CLOSE",type:"CALL",quantity:1,multiplier:100,executionDate:i(-6),expirationDate:i(-4),strike:280,premium:1.95,fees:.3},{id:"TRD-2015-L4",action:"SELL",side:"CLOSE",type:"CALL",quantity:1,multiplier:100,executionDate:i(-6),expirationDate:i(180),strike:280,premium:14.8,fees:.45}]},{id:"TRD-2016",ticker:"SPY",strategy:"Iron Condor",status:"Open",openedDate:i(-14),closedDate:null,expirationDate:i(28),notes:"Current focus trade sized at 2% risk, monitoring gamma into FOMC.",legs:[{id:"TRD-2016-L1",action:"SELL",side:"OPEN",type:"CALL",quantity:1,multiplier:100,executionDate:i(-14),expirationDate:i(28),strike:560,premium:1.48,fees:.32,underlyingPrice:548.1},{id:"TRD-2016-L2",action:"BUY",side:"OPEN",type:"CALL",quantity:1,multiplier:100,executionDate:i(-14),expirationDate:i(28),strike:570,premium:.62,fees:.22},{id:"TRD-2016-L3",action:"SELL",side:"OPEN",type:"PUT",quantity:1,multiplier:100,executionDate:i(-14),expirationDate:i(28),strike:520,premium:1.62,fees:.32},{id:"TRD-2016-L4",action:"BUY",side:"OPEN",type:"PUT",quantity:1,multiplier:100,executionDate:i(-14),expirationDate:i(28),strike:510,premium:.68,fees:.22}]},{id:"TRD-2017",ticker:"NVDA",strategy:"Diagonal Call Spread",status:"Open",openedDate:i(-10),closedDate:null,expirationDate:i(60),notes:"Scaling call diagonal as part of trend-following play.",legs:[{id:"TRD-2017-L1",action:"BUY",side:"OPEN",type:"CALL",quantity:1,multiplier:100,executionDate:i(-10),expirationDate:i(240),strike:980,premium:88.4,fees:.75,underlyingPrice:928.5},{id:"TRD-2017-L2",action:"SELL",side:"OPEN",type:"CALL",quantity:1,multiplier:100,executionDate:i(-10),expirationDate:i(60),strike:1150,premium:17.6,fees:.35}]},{id:"TRD-2018",ticker:"IWM",strategy:"Short Strangle",status:"Open",openedDate:i(-21),closedDate:null,expirationDate:i(35),notes:"Defined monitoring triggers at 2x credit and 21 DTE roll.",legs:[{id:"TRD-2018-L1",action:"SELL",side:"OPEN",type:"CALL",quantity:1,multiplier:100,executionDate:i(-21),expirationDate:i(35),strike:230,premium:1.92,fees:.3,underlyingPrice:213.7},{id:"TRD-2018-L2",action:"SELL",side:"OPEN",type:"PUT",quantity:1,multiplier:100,executionDate:i(-21),expirationDate:i(35),strike:195,premium:1.98,fees:.3}]},{id:"TRD-2019",ticker:"TSLA",strategy:"Covered Call",status:"Open",openedDate:i(-5),closedDate:null,expirationDate:i(40),notes:"Income overlay targeting 2% monthly yield; ready to roll at 0.35 delta.",legs:[{id:"TRD-2019-L1",action:"SELL",side:"OPEN",type:"CALL",quantity:1,multiplier:100,executionDate:i(-5),expirationDate:i(40),strike:305,premium:3.25,fees:.35,underlyingPrice:292.4}]},{id:"TRD-2020",ticker:"GLD",strategy:"Bull Put Spread",status:"Open",openedDate:i(-17),closedDate:null,expirationDate:i(45),notes:"Risk-defined bullish structure aligned with macro trend.",legs:[{id:"TRD-2020-L1",action:"SELL",side:"OPEN",type:"PUT",quantity:1,multiplier:100,executionDate:i(-17),expirationDate:i(45),strike:180,premium:2.1,fees:.3,underlyingPrice:187.6},{id:"TRD-2020-L2",action:"BUY",side:"OPEN",type:"PUT",quantity:1,multiplier:100,executionDate:i(-17),expirationDate:i(45),strike:175,premium:.9,fees:.2}]}],exportDate:t.toISOString(),version:"3.1"}}class GammaLedger{constructor(){this.trades=[],this.currentView="dashboard",this.sortDirection={},this.charts={},this.tradeDetailCharts=new Map,this.cycleAnalytics=[],this.latestStats=null,this.currentFileHandle=null,this.currentFileName="Unsaved Database",this.hasUnsavedChanges=!1,this.supportsFileSystemAccess="showOpenFilePicker"in window,this.currentEditingId=null,this.importControlsInitialized=!1,this.importLog=[],this.importSummary=null,this.importMergeSelection=new Set,this.tradeMergeSelection=new Set,this.tradesMergeInitialized=!1,this.tradesMergePanelOpen=!1,this.currentFilteredTrades=[],this.disclaimerBanner={element:null,body:null,agreeButton:null,agreeHandler:null,hideTimeoutId:null},this.disclaimerFadeMs=280,this.aiCoachConsent={element:null,panel:null,agreeButton:null,agreeHandler:null,dismissButtons:[],dismissHandlers:[],escapeHandler:null,restoreFocus:null,pendingAction:null,isVisible:!1},this.finnhub={apiKey:"",encryptionKey:null,cache:new Map,cacheTTL:6e4,outstandingRequests:new Map,rateLimitQueue:Promise.resolve(),maxRequestsPerMinute:60,timestamps:[],statusTimeoutId:null,lastStatus:null,elements:{}},this.gemini={apiKey:"",encryptionKey:null,model:"gemini-2.5-flash",statusTimeoutId:null,lastStatus:null,pendingStatus:null,elements:{}},this.aiAgent=new GeminiInsightsAgent(this),this.aiChatMessages=[],this.aiChatSessionId=Date.now(),this.aiChatPendingRequest=!1,this.aiChatOpen=!1,this.activeQuoteEntries=new Map,this.quoteRefreshIntervalId=null,this.autoRefreshIntervalMs=this.computeAutoRefreshInterval(),this.quoteRefreshKeys=[],this.quoteRefreshCursor=0,this.positionHighlightConfig={expirationWarningDays:20,expirationCriticalDays:10},this.sidebarState={container:null,sidebar:null,toggleButton:null,mediaQuery:null,mainContent:null,collapsed:!1,preferredCollapsed:!1},this.shareCard={root:null,card:null,button:null,chartCanvas:null,chart:null,metrics:{},timestamp:null,exportSize:1080},this.currentDate=new Date,this.init()}async init(){await this.loadFromStorage(),await this.loadFinnhubConfigFromStorage(),await this.loadGeminiConfigFromStorage(),this.trades&&0!==this.trades.length?(this.updateFileNameDisplay(),this.updateDashboard()):await this.loadDefaultDatabase(),this.bindEvents(),this.initializeGeminiControls(),this.initializeAIChat(),this.initializeFinnhubControls(),this.initializeDisclaimerBanner(),this.initializeAICoachConsent(),this.initializeSidebarToggle(),this.initializeShareCard(),this.updateFileNameDisplay(),this.checkBrowserCompatibility(),setTimeout(()=>{this.updateDashboard(),this.showView("dashboard")},100)}computeAutoRefreshInterval(){const e=Number(this.finnhub?.maxRequestsPerMinute)||60,t=Math.min(Math.max(e-2,1),60);return Math.max(800,Math.ceil(12e4/t))}checkBrowserCompatibility(){if(!this.supportsFileSystemAccess){const e=document.getElementById("compatibility-notice");e&&e.classList.remove("hidden"),console.log("File System Access API not supported, using fallback methods")}}async loadDefaultDatabase(){try{if(!BUILTIN_SAMPLE_DATA||!Array.isArray(BUILTIN_SAMPLE_DATA.trades))throw new Error("Built-in sample data unavailable.");const e=JSON.parse(JSON.stringify(BUILTIN_SAMPLE_DATA));this.processLoadedData(e,{fileName:"Sample Database (Built-in)",source:"default-sample"}),this.currentFileHandle=null}catch(e){console.warn("Default database not loaded:",e),this.trades=[],this.currentFileName="Unsaved Database",this.currentFileHandle=null,this.hasUnsavedChanges=!1,this.updateUnsavedIndicator(),this.saveToStorage({fileName:this.currentFileName}),this.updateFileNameDisplay(),this.updateDashboard()}}normalizeLegOrderType(e){const t=(e||"").toString().trim().toUpperCase();if(["BTO","STO","BTC","STC"].includes(t))return t;const i=t.replace("BUY TO OPEN","BTO").replace("SELL TO OPEN","STO").replace("BUY TO CLOSE","BTC").replace("SELL TO CLOSE","STC");return["BTO","STO","BTC","STC"].includes(i)?i:t.startsWith("B")?t.includes("C")?"BTC":"BTO":t.startsWith("S")?t.includes("C")?"STC":"STO":"BTO"}mapOrderTypeToActionSide(e){switch(this.normalizeLegOrderType(e)){case"BTO":default:return{action:"BUY",side:"OPEN"};case"STO":return{action:"SELL",side:"OPEN"};case"BTC":return{action:"BUY",side:"CLOSE"};case"STC":return{action:"SELL",side:"CLOSE"}}}deriveOrderTypeFromActionSide(e,t){const i=this.normalizeLegAction(e),r=this.normalizeLegSide(t);return"ROLL"===r?"SELL"===i?"STO":"BTO":"BUY"===i&&"OPEN"===r?"BTO":"SELL"===i&&"OPEN"===r?"STO":"BUY"===i&&"CLOSE"===r?"BTC":"SELL"===i&&"CLOSE"===r?"STC":"BTO"}normalizeLegAction(e){const t=(e||"").toString().trim().toUpperCase();return["SELL","SHORT","STO","STC"].includes(t)?"SELL":"BUY"}normalizeLegSide(e){const t=(e||"").toString().trim().toUpperCase();return["CALL","PUT","STOCK"].includes(t)?"CLOSE":["CASH","FUTURE","ETF","SHARES","STK"].includes(t)?"STOCK":["BTO","STO"].includes(t)?"OPEN":["BTC","STC"].includes(t)?"CLOSE":"OPEN"}normalizeLegType(e){const t=(e||"").toString().trim().toUpperCase();return["CALL","PUT","STOCK","CASH","FUTURE","ETF"].includes(t)?t:"SHARES"===t?"STOCK":t||"UNKNOWN"}getLegMultiplier(e){const t=Number(e?.multiplier);if(Number.isFinite(t)&&t>0)return t;const i=this.normalizeLegType(e?.type);if("STOCK"===i||"CASH"===i)return 1;const r=this.normalizeUnderlyingType(e?.underlyingType,{fallback:"Stock"});return this.getDefaultMultiplierForLegType(i,r)}normalizeLeg(e,t=0){const i=Number(e?.quantity),r=Number.isFinite(i)?i:0,a=e?.executionDate?new Date(e.executionDate):null,n=a&&!Number.isNaN(a.getTime())?a.toISOString().slice(0,10):"",s=e?.expirationDate?new Date(e.expirationDate):null,o=s&&!Number.isNaN(s.getTime())?s.toISOString().slice(0,10):"",l=this.normalizeLegOrderType(e?.orderType||e?.tradeType||e?.order||this.deriveOrderTypeFromActionSide(e?.action,e?.side)),c=this.mapOrderTypeToActionSide(l),d=this.normalizeLegAction(e?.action||c.action),u=this.normalizeLegSide(e?.side||c.side),m=e?.fitId,h=e?.externalId,p=e?.importGroupId,g=e?.importSource;return{id:e?.id||`LEG-${Date.now()}-${t}`,orderType:l,action:d,side:u,type:this.normalizeLegType(e?.type),quantity:r,multiplier:this.getLegMultiplier(e),executionDate:n,expirationDate:o,strike:Number.isFinite(Number(e?.strike))?Number(e.strike):null,premium:Number.isFinite(Number(e?.premium))?Number(e.premium):0,fees:Number.isFinite(Number(e?.fees))?Number(e.fees):0,underlyingPrice:Number.isFinite(Number(e?.underlyingPrice))?Number(e.underlyingPrice):null,underlyingType:this.normalizeUnderlyingType(e?.underlyingType,{fallback:"Stock"}),fitId:null==m?null:m.toString().trim()||null,externalId:null==h?null:h.toString().trim()||null,importGroupId:null==p?null:p.toString().trim()||null,importSource:null==g?null:g.toString().trim()||null}}calculateLegCashFlow(e){if(!e)return 0;const t=Math.abs(Number(e.quantity)||0);if(!t)return-(Number(e.fees)||0);const i=this.getLegMultiplier(e),r=Number(e.premium)||0,a=Number(e.fees)||0;return("SELL"===this.normalizeLegAction(e.action)?1:-1)*r*i*t-a}summarizeLegs(e=[]){const t={legs:[],legsCount:0,openLegs:0,closeLegs:0,rollLegs:0,totalFees:0,totalDebit:0,totalCredit:0,netPremium:0,cashFlow:0,openCashFlow:0,closeCashFlow:0,openedDate:null,closedDate:null,earliestExpiration:null,latestExpiration:null,primaryLeg:null,openContracts:0,closeContracts:0,capitalAtRisk:0,entryPrice:null,exitPrice:null,openCreditGross:0,openDebitGross:0,openFees:0,openBaseContracts:0,entryNetCredit:0,verticalSpread:null,nearestShortCallExpiration:null,nextShortCallExpiration:null};if(!Array.isArray(e)||0===e.length)return t;const i=e.map((e,t)=>this.normalizeLeg(e,t));t.legs=i,t.legsCount=i.length;const r=new Map,a=this.currentDate instanceof Date?this.currentDate:new Date;i.forEach(e=>{const i=this.calculateLegCashFlow(e);t.cashFlow+=i,t.totalFees+=Number(e.fees)||0;const n=Math.abs(Number(e.quantity)||0);if(n)if("OPEN"===e.side){t.openLegs+=1,t.openContracts+=n,t.openCashFlow+=i;const a=this.getLegMultiplier(e)||1,s=Math.abs(Number(e.premium)||0)*a*n;if("SELL"===e.action?t.openCreditGross+=s:t.openDebitGross+=s,t.openFees+=Number(e.fees)||0,n>t.openBaseContracts&&(t.openBaseContracts=n),["CALL","PUT"].includes(e.type)&&Number.isFinite(Number(e.strike))){const t=`${e.type}|${e.expirationDate||""}`;r.has(t)||r.set(t,[]),r.get(t).push(e)}}else"CLOSE"===e.side?(t.closeLegs+=1,t.closeContracts+=n,t.closeCashFlow+=i):"ROLL"===e.side&&(t.rollLegs+=1);if("BUY"===e.action?t.totalDebit+=Math.abs(i+(Number(e.fees)||0)):t.totalCredit+=Math.abs(i+(Number(e.fees)||0)),e.executionDate){const i=new Date(e.executionDate);Number.isNaN(i.getTime())||((!t.openedDate||i<t.openedDate)&&(t.openedDate=i),(!t.closedDate||i>t.closedDate)&&(t.closedDate=i))}if(e.expirationDate){const i=new Date(e.expirationDate);Number.isNaN(i.getTime())||((!t.earliestExpiration||i<t.earliestExpiration)&&(t.earliestExpiration=i),(!t.latestExpiration||i>t.latestExpiration)&&(t.latestExpiration=i),"OPEN"===e.side&&"SELL"===e.action&&"CALL"===e.type&&((!t.nearestShortCallExpiration||i<t.nearestShortCallExpiration)&&(t.nearestShortCallExpiration=i),i>=a&&(!t.nextShortCallExpiration||i<t.nextShortCallExpiration)&&(t.nextShortCallExpiration=i)))}t.primaryLeg||"CLOSE"===e.side||(t.primaryLeg=e)}),t.primaryLeg||(t.primaryLeg=i[0]);const n=t.openCreditGross-t.openDebitGross-t.openFees;t.entryNetCredit=n;let s=null;for(const e of r.values()){if(!Array.isArray(e)||e.length<2)continue;const i=e.some(e=>"BUY"===e.action),r=e.some(e=>"SELL"===e.action);if(!i||!r)continue;const a=e.map(e=>Number(e.strike)).filter(Number.isFinite);if(a.length<2)continue;const n=Math.abs(Math.max(...a)-Math.min(...a));if(!(n>0))continue;const o=this.getLegMultiplier(e[0])||1,l=e.map(e=>Math.abs(Number(e.quantity)||0)).filter(e=>e>0);s={width:n,multiplier:o,contracts:(l.length?Math.min(...l):t.openBaseContracts||1)||1};break}t.verticalSpread=s;const o=this.getLegMultiplier(t.primaryLeg)||1,l=t.openContracts||Math.abs(Number(t.primaryLeg?.quantity)||0)||1,c=s?.contracts||t.openBaseContracts||l,d=t.closeContracts||0;return Number.isFinite(n)&&c>0&&o>0?t.entryPrice=Math.abs(n)/(c*o):l>0&&o>0&&(t.entryPrice=Math.abs(t.openCashFlow)/(l*o)),d>0&&(t.exitPrice=Math.abs(t.closeCashFlow)/(d*o)),t.netPremium=n,t.capitalAtRisk=this.computeMaxRiskUsingFormula({legs:i},t),t}buildRiskFormulaContext(e={},t=null){const i=t||this.summarizeLegs(e?.legs||[]);if(!i)return null;let r=Number(e?.strikePrice);if(!(Number.isFinite(r)&&r>0)){const t=Number(e?.activeStrikePrice);Number.isFinite(t)&&t>0&&(r=t)}if(!(Number.isFinite(r)&&r>0)){const e=Number(i?.primaryLeg?.strike);if(Number.isFinite(e)&&e>0)r=e;else{const e=this.derivePrimaryStrike(i);Number.isFinite(e)&&e>0&&(r=e)}}let a=Math.abs(Number(e?.quantity))||0;if(!(a>0)){const e=Number(i?.openBaseContracts);Number.isFinite(e)&&e>0&&(a=e)}if(!(a>0)){const e=Number(i?.primaryLeg?.quantity);Number.isFinite(e)&&0!==e&&(a=Math.abs(e))}if(!(a>0))return null;let n=Math.abs(Number(e?.multiplier))||0;if(!(n>0)&&i?.primaryLeg){const e=this.getLegMultiplier(i.primaryLeg);Number.isFinite(e)&&e>0&&(n=e)}if(!(n>0)&&Array.isArray(i?.legs)){const e=i.legs.find(e=>Number.isFinite(Number(e?.multiplier))&&Number(e.multiplier)>0);e&&(n=Math.abs(Number(this.getLegMultiplier(e))))}n>0||(n=100);const s=a*n;if(!(s>0))return null;const o=Number(i?.entryNetCredit),l=Number(i?.openCreditGross)||0,c=Number(i?.openDebitGross)||0,d=Number(i?.openFees)||0,u=s>0?l/s:0,m=s>0?c/s:0,h=u-m,p=Math.max(h,0),g=Math.max(-h,0),y=s>0&&Number.isFinite(o)?o/s:0,f=s>0?d/s:0,b=Array.isArray(i?.legs)?i.legs.filter(e=>e&&"OPEN"===e.side):[],C=b.filter(e=>["CALL","PUT"].includes(e.type)&&Number.isFinite(Number(e.strike))),S=C.map(e=>Number(e.strike)).filter(e=>Number.isFinite(e)),L=Array.from(new Set(S)).sort((e,t)=>e-t),T=L[0]??null,N=L[1]??null,I=L[2]??null,v=L[3]??null,x=[];for(let e=1;e<L.length;e+=1){const t=L[e]-L[e-1];Number.isFinite(t)&&t>0&&x.push(t)}const D=x.length?Math.min(...x):null,k=x.length?Math.max(...x):null,E=e=>C.filter(e).map(e=>Number(e.strike)).filter(e=>Number.isFinite(e)).sort((e,t)=>e-t),w=E(e=>"CALL"===e.type&&"SELL"===this.normalizeLegAction(e.action)),A=E(e=>"CALL"===e.type&&"BUY"===this.normalizeLegAction(e.action)),P=E(e=>"PUT"===e.type&&"SELL"===this.normalizeLegAction(e.action)),F=E(e=>"PUT"===e.type&&"BUY"===this.normalizeLegAction(e.action)),R=w.length?w[0]:null,M=w.length?w[w.length-1]:null,O=A.length?A[0]:null,B=A.length?A[A.length-1]:null,U=P.length?P[0]:null,$=P.length?P[P.length-1]:null,_=F.length?F[0]:null,q=F.length?F[F.length-1]:null,G=Number.isFinite(T)&&Number.isFinite(N)?Math.max(N-T,0):null,H=Number.isFinite(N)&&Number.isFinite(I)?Math.max(I-N,0):null,K=Number.isFinite(I)&&Number.isFinite(v)?Math.max(v-I,0):null,z=Math.max(Number.isFinite(G)?G:0,Number.isFinite(K)?K:0)||null,Y=Number.isFinite(z)&&z>0?z:Number.isFinite(H)&&H>0?H:Number.isFinite(D)&&D>0?D:null,V=b.filter(e=>"STOCK"===e.type),W=[],j=e=>{const t=Number(e);Number.isFinite(t)&&t>0&&W.push(t)};j(e?.entryUnderlyingPrice),j(e?.underlyingEntryPrice),j(e?.underlyingPrice),j(e?.underlyingPriceAtEntry),b.forEach(e=>j(e?.underlyingPrice)),!W.length&&V.length&&V.map(e=>Number(e?.premium)).filter(e=>Number.isFinite(e)&&e>0).forEach(e=>W.push(e));let Q=null;if(W.length){const e=W.reduce((e,t)=>e+t,0)/W.length;Number.isFinite(e)&&e>0&&(Q=e)}const X=Number.isFinite(r)&&r>0?r:R??$??T??null;return{trade:e,details:i,referenceStrike:X,contracts:a,multiplier:n,contractValue:s,entryNetCreditDollars:o,entryNetPremiumPerShare:y,netPremium:h,netCredit:p,netDebit:g,premiumPaid:m,premiumReceived:u,totalFeesPerShare:f,strikes:L,K:X,K1:T,K2:N,K3:I,K4:v,lowerWidth:G,middleWidth:H,upperWidth:K,minStrikeDiff:D,maxStrikeDiff:k,maxWingWidth:z,defaultWidth:Y,shortCallStrike:R,shortCallStrikeHigh:M,longCallStrike:B,longCallStrikeLow:O,shortPutStrike:$,shortPutStrikeLow:U,longPutStrike:q,longPutStrikeLow:_,S:Q,hasStockExposure:V.length>0,toNotional:e=>{if(null==e)return;if(e===Number.POSITIVE_INFINITY)return Number.POSITIVE_INFINITY;const t=Number(e);if(!Number.isFinite(t))return;return Math.max(t,0)*s},contractCount:a,multiplierValue:n}}computeDefaultMaxRisk(e){if(!(e&&e.contractValue>0))return 0;const t=Number(e.referenceStrike);if(!Number.isFinite(t)||t<=0)return 0;const i=Number(e.entryNetPremiumPerShare);if(!Number.isFinite(i))return 0;const r=t-i;if(!Number.isFinite(r))return 0;const a=Math.max(r,0)*e.contractValue;return Number.isFinite(a)?a:0}getStrategyRiskHandlers(){if(!this.strategyRiskHandlersCache){const e=(e,t)=>Number.isFinite(e)&&Number.isFinite(t)?Math.max(t-e,0):null,t=(...e)=>{for(const t of e){const e=Number(t);if(Number.isFinite(e)&&e>0)return e}return null},i={},r=(e,t)=>(e&&(i[e]=t),t),a=e=>e.toNotional(e.netDebit),n=(t,i,r)=>{const a=e(i,r);if(null!==a)return t.toNotional(a-t.netCredit)},s=(t,i,r)=>{const a=e(i,r);if(null!==a)return t.toNotional(a-t.netDebit)},o=t=>{const i=Number.isFinite(t.defaultWidth)&&t.defaultWidth>0?t.defaultWidth:e(t.K1,t.K2);if(Number.isFinite(i)&&!(i<=0))return t.toNotional(i-t.netCredit)};r("Bear Call Ladder",e=>n(e,e.K1,e.K2)),r("Bear Call Spread",e=>n(e,e.K1,e.K2)),r("Bear Put Ladder",t=>{const i=e(t.K2,t.K3);if(null!==i)return t.toNotional(t.netDebit-i)}),r("Bear Put Spread",e=>a(e)),r("Box Spread",e=>n(e,e.K1,e.K2)),r("Bull Call Ladder",t=>{const i=e(t.K1,t.K2);if(null!==i)return t.toNotional(t.netDebit+i)}),r("Bull Call Spread",e=>a(e)),r("Bull Put Ladder",e=>n(e,e.K1,e.K2)),r("Bull Put Spread",e=>n(e,e.K1,e.K2)),r("Calendar Call Spread",a),r("Calendar Put Spread",a),r("Calendar Straddle",a),r("Calendar Strangle",a),r("Call Broken Wing",e=>n(e,e.K1,e.K2)),r("Call Ratio Backspread",e=>n(e,e.K1,e.K2)),r("Call Ratio Spread",e=>n(e,e.K1,e.K2)),r("Cash-Secured Put",e=>{const i=t(e.shortPutStrike,e.shortPutStrikeLow,e.K,e.K1);if(Number.isFinite(i))return e.toNotional(i-e.netCredit)}),r("Collar",e=>{const i=t(e.S,e.referenceStrike),r=t(e.longPutStrike,e.shortPutStrike,e.K1);if(null!==i&&null!==r)return e.toNotional(i-r-e.netCredit)}),r("Covered Call",e=>{const i=t(e.S,e.referenceStrike);if(null!==i)return e.toNotional(i-e.netCredit)}),r("Covered Put",()=>Number.POSITIVE_INFINITY),r("Covered Short Straddle",()=>Number.POSITIVE_INFINITY),r("Covered Short Strangle",()=>Number.POSITIVE_INFINITY),r("Diagonal Call Spread",a),r("Diagonal Put Spread",a),r("Double Diagonal",a),r("Guts",a),r("Inverse Call Broken Wing",e=>s(e,e.K2,e.K3)),r("Inverse Iron Butterfly",t=>{const i=e(t.K1,t.K2);if(null!==i)return t.toNotional(t.netDebit-i)}),r("Inverse Iron Condor",a),r("Inverse Put Broken Wing",e=>s(e,e.K1,e.K2)),r("Iron Albatross",o),r("Iron Butterfly",e=>n(e,e.K1,e.K2)),r("Iron Condor",o),r("Jade Lizard",e=>{const i=t(e.shortCallStrike,e.shortCallStrikeHigh,e.K2,e.K3);if(Number.isFinite(i))return e.toNotional(i-e.netCredit)}),r("Long Call",a),r("Long Call Butterfly",a),r("Long Call Condor",a),r("Long Put",a),r("Long Put Butterfly",a),r("Long Put Condor",a),r("Long Straddle",a),r("Long Strangle",a),r("Poor Man's Covered Call",a),r("Protective Put",e=>{const i=t(e.S,e.referenceStrike),r=t(e.longPutStrike,e.longPutStrikeLow,e.K1);if(null!==i&&null!==r)return e.toNotional(i-r+e.netDebit)}),r("Put Broken Wing",e=>n(e,e.K1,e.K2)),r("Put Ratio Backspread",e=>n(e,e.K1,e.K2)),r("Put Ratio Spread",e=>n(e,e.K1,e.K2)),r("Reverse Jade Lizard",e=>{const i=t(e.shortPutStrike,e.shortPutStrikeLow,e.K1);if(Number.isFinite(i))return e.toNotional(i-e.netCredit)}),r("Short Call",()=>Number.POSITIVE_INFINITY),r("Short Call Butterfly",e=>n(e,e.K1,e.K2)),r("Short Call Condor",o),r("Short Guts",()=>Number.POSITIVE_INFINITY),r("Short Put",e=>{const i=t(e.shortPutStrike,e.shortPutStrikeLow,e.K,e.K1);if(Number.isFinite(i))return e.toNotional(i-e.netCredit)}),r("Short Put Butterfly",e=>n(e,e.K1,e.K2)),r("Short Put Condor",o),r("Short Straddle",()=>Number.POSITIVE_INFINITY),r("Short Strangle",()=>Number.POSITIVE_INFINITY),r("Strap",a),r("Strip",a),r("Synthetic Long Stock",()=>Number.POSITIVE_INFINITY),r("Synthetic Short Stock",()=>Number.POSITIVE_INFINITY),r("Synthetic Put",()=>Number.POSITIVE_INFINITY),r("Wheel",e=>{const i=t(e.shortPutStrike,e.shortPutStrikeLow,e.K1);if(Number.isFinite(i))return e.toNotional(i-e.netCredit)}),i["Calendar Call Spread"]&&r("Calendar Spread",i["Calendar Call Spread"]),i["Call Broken Wing"]&&(r("Call Broken Wing Butterfly",i["Call Broken Wing"]),r("Broken Wing Butterfly",i["Call Broken Wing"])),i["Put Broken Wing"]&&r("Put Broken Wing Butterfly",i["Put Broken Wing"]),i.Wheel&&r("Wheel Strategy",i.Wheel),i["Cash-Secured Put"]&&r("Cash Secured Put",i["Cash-Secured Put"]),i["Poor Man's Covered Call"]&&r("Poor Mans Covered Call",i["Poor Man's Covered Call"]),this.strategyRiskHandlersCache=i}return this.strategyRiskHandlersCache}evaluateStrategyMaxRisk(e,t){if(!t)return;const i=this.getStrategyRiskHandlers(),r=(e||"").toString().trim();if(!r)return;const a=i[r];return"function"==typeof a?a(t):void 0}computeMaxRiskUsingFormula(e={},t=null){const i=t||this.summarizeLegs(e?.legs||[]);if(!i)return 0;const r=this.buildRiskFormulaContext(e,i);if(!r)return 0;const a=this.getStrategyDisplayName(e?.strategy||"");let n=a?this.evaluateStrategyMaxRisk(a,r):void 0;return void 0===n&&(n=this.computeDefaultMaxRisk(r)),n===Number.POSITIVE_INFINITY?Number.POSITIVE_INFINITY:!Number.isFinite(n)||n<=0?0:parseFloat(n.toFixed(2))}formatStrikeValue(e){const t=Number(e);return Number.isFinite(t)?Math.abs(t)>=1e3?t.toFixed(0):Number.isInteger(t)?t.toString():t.toFixed(2).replace(/\.00$/,""):"—"}derivePrimaryStrike(e){if(!e||!Array.isArray(e.legs))return null;const t=e.legs.filter(e=>"OPEN"===e.side),i=t.length?t:e.legs,r=i.find(e=>"SELL"===e.action&&Number.isFinite(Number(e.strike)));if(r)return Number(r.strike);const a=i.find(e=>Number.isFinite(Number(e.strike)));return a?Number(a.strike):null}getActiveStrikeForDisplay(e){if(!e||!Array.isArray(e.legs)||0===e.legs.length)return null;const t=e.legs.filter(e=>Number.isFinite(Number(e?.strike)));if(0===t.length)return null;const i=t.filter(e=>"OPEN"===e.side),r=i.length?i:t;let a=null,n=Number.NEGATIVE_INFINITY,s=Number.NEGATIVE_INFINITY,o=-1;return r.forEach((e,t)=>{const i=e.executionDate?new Date(e.executionDate):null,r=i&&!Number.isNaN(i.getTime())?i.getTime():Number.NEGATIVE_INFINITY,l="SELL"===e.action?1:0;(r>n||r===n&&l>s||r===n&&l===s&&t>o)&&(a=e,n=r,s=l,o=t)}),a?Number(a.strike):null}buildStrikeDisplay(e,t=null){const i=t||this.summarizeLegs(e?.legs||[]),r=i?.legs||[];if(0===r.length)return"—";const a=r.filter(e=>"OPEN"===e.side),n=a.length?a:r,s=n.filter(e=>["CALL","PUT"].includes(e.type)&&Number.isFinite(Number(e.strike)));if(s.length>0){const e=s.reduce((e,t)=>{const i="CALL"===t.type?"C":"P";return e[i]||(e[i]=new Set),e[i].add(Number(t.strike)),e},{});return Object.entries(e).map(([e,t])=>`${e}${Array.from(t).sort((e,t)=>e-t).map(e=>this.formatStrikeValue(e)).join("/")}`).sort().join(" · ")||"—"}const o=n.filter(e=>"STOCK"===e.type);if(o.length>0){const e=o.reduce((e,t)=>{const i=t.quantity*this.getLegMultiplier(t);return e+("BUY"===t.action?i:-i)},0),t=Math.abs(Math.round(e));if(t>0)return`${t} sh`}return"—"}buildEntryPriceDisplay(e,t=null){const i=Number(e?.entryPrice);if(!Number.isFinite(i))return"—";const r=t||this.summarizeLegs(e?.legs||[]),a=Number(r?.openCashFlow)||0,n=this.formatCurrency(Math.abs(i));return a>1e-4?`Cr ${n}`:a<-1e-4?`Db ${n}`:n}assessRisk(e,t){const i=t||this.summarizeLegs(e?.legs||[]),r=this.computeMaxRiskUsingFormula(e,i),a={maxRiskValue:0,maxRiskLabel:"$0.00",unlimited:!1};return r===Number.POSITIVE_INFINITY?(a.maxRiskValue=Number.POSITIVE_INFINITY,a.maxRiskLabel="Unlimited",a.unlimited=!0,i.capitalAtRisk=Number.POSITIVE_INFINITY,a):(Number.isFinite(r)&&r>0?(a.maxRiskValue=r,a.maxRiskLabel=this.formatCurrency(r)):(a.maxRiskValue=0,a.maxRiskLabel="$0.00"),i.capitalAtRisk=a.maxRiskValue,a)}getLegsContainer(){return document.getElementById("trade-legs-container")}generateLegId(e=0){return`${this.currentEditingId||"NEW"}-LEG-${Date.now().toString(36)}-${e}-${Math.random().toString(36).slice(2,6)}`}clearLegFormRows(){const e=this.getLegsContainer();e&&(e.innerHTML="")}getSelectedUnderlyingType({fallback:e="Stock"}={}){const t=document.getElementById("underlyingType");return this.normalizeUnderlyingType(t?.value,{fallback:e})}getDefaultMultiplierForLegType(e,t="Stock"){const i=this.normalizeLegType(e||"CALL");if("STOCK"===i||"CASH"===i)return 1;this.normalizeUnderlyingType(t,{fallback:"Stock"});return 100}syncLegMultiplierVisibility(e,{defaultMultiplier:t=null}={}){if(!e)return;const i=e.querySelector('[data-leg-group="multiplier"]'),r=e.querySelector('[data-leg-field="multiplier"]'),a=e.querySelector(".trade-leg__multiplier-toggle"),n=e.querySelector('[data-leg-field="type"]');if(!(i&&r&&a&&n))return;const s=this.getSelectedUnderlyingType({fallback:"Stock"}),o=this.normalizeLegType(n.value||"CALL"),l=Number.isFinite(t)?t:this.getDefaultMultiplierForLegType(o,s),c=Number(r.value),d=Number.isFinite(c)&&c>0&&c!==l;if(e.classList.contains("trade-leg--multiplier-open"))return i.classList.remove("is-hidden"),void(a.textContent="Hide multiplier");i.classList.toggle("is-hidden",!d),a.textContent=d?"Hide multiplier":"Override multiplier"}applyUnderlyingTypeToLegMultipliers({row:e=null,force:t=!1}={}){const i=this.getLegsContainer();if(!i)return;const r=e?[e]:Array.from(i.querySelectorAll(".trade-leg"));if(!r.length)return;const a=this.getSelectedUnderlyingType({fallback:"Stock"});r.forEach(e=>{const i=e.querySelector('[data-leg-field="type"]'),r=e.querySelector('[data-leg-field="multiplier"]');if(!i||!r)return;const n=this.getDefaultMultiplierForLegType(i.value||"CALL",a),s=Number(r.value),o=e.classList.contains("trade-leg--multiplier-open");if(t||!Number.isFinite(s)||s<=0)r.value=n;else if(!o){0===s&&(r.value=n)}this.syncLegMultiplierVisibility(e,{defaultMultiplier:n})})}renderLegForms(e=[]){this.getLegsContainer()&&(this.clearLegFormRows(),Array.isArray(e)&&e.length>0?e.forEach(e=>this.addLegFormRow(e)):this.addLegFormRow(),this.updateLegRowNumbers(),this.applyUnderlyingTypeToLegMultipliers({force:!Array.isArray(e)||0===e.length}))}addLegFormRow(e=null){const t=this.getLegsContainer();if(!t)return null;const i=document.createElement("div");i.className="trade-leg";const r=t.querySelectorAll(".trade-leg").length,a=e?.id||this.generateLegId(r);i.dataset.legId=a,i.innerHTML='\n            <div class="trade-leg__header">\n                <span class="trade-leg__title" data-leg-label></span>\n                <button type="button" class="btn btn--sm btn--secondary trade-leg__remove">Remove Leg</button>\n            </div>\n            <div class="form-row">\n                <div class="form-group">\n                    <label class="form-label">Action</label>\n                    <select class="form-control" data-leg-field="orderType">\n                        <option value="BTO">BTO (Buy to Open)</option>\n                        <option value="STO">STO (Sell to Open)</option>\n                        <option value="BTC">BTC (Buy to Close)</option>\n                        <option value="STC">STC (Sell to Close)</option>\n                    </select>\n                </div>\n            </div>\n            <div class="form-row">\n                <div class="form-group">\n                    <label class="form-label">Instrument</label>\n                    <select class="form-control" data-leg-field="type">\n                        <option value="CALL">Call</option>\n                        <option value="PUT">Put</option>\n                        <option value="STOCK">Stock</option>\n                    </select>\n                </div>\n                <div class="form-group">\n                    <label class="form-label">Quantity</label>\n                    <input type="number" class="form-control" data-leg-field="quantity" min="0" step="1">\n                </div>\n            </div>\n            <div class="form-row">\n                <div class="form-group">\n                    <label class="form-label">Entry Date</label>\n                    <input type="date" class="form-control" data-leg-field="executionDate">\n                </div>\n                <div class="form-group">\n                    <label class="form-label">Expiration Date</label>\n                    <input type="date" class="form-control" data-leg-field="expirationDate">\n                </div>\n            </div>\n            <div class="form-row">\n                <div class="form-group">\n                    <label class="form-label">Strike</label>\n                    <input type="number" class="form-control" data-leg-field="strike" step="0.01">\n                </div>\n                <div class="form-group">\n                    <label class="form-label">Premium (per share)</label>\n                    <input type="number" class="form-control" data-leg-field="premium" step="0.000001" min="0">\n                </div>\n            </div>\n            <div class="form-row">\n                <div class="form-group">\n                    <label class="form-label">Fees</label>\n                    <input type="number" class="form-control" data-leg-field="fees" step="0.0000001" min="0">\n                </div>\n                <div class="form-group is-hidden" data-leg-group="multiplier">\n                    <label class="form-label">Multiplier</label>\n                    <input type="number" class="form-control" data-leg-field="multiplier" step="1" min="1">\n                    <span class="form-help-text">Used to scale option premiums (100 for standard contracts, 1 for stock).</span>\n                </div>\n            </div>\n            <div class="form-row trade-leg__multiplier-row">\n                <div class="form-group">\n                    <button type="button" class="btn btn--sm btn--secondary trade-leg__multiplier-toggle">Override multiplier</button>\n                    <span class="form-help-text">Hidden by default - standard contracts use 100, stock legs use 1.</span>\n                </div>\n            </div>\n            <div class="form-row">\n                <div class="form-group">\n                    <label class="form-label">Entry Underlying Price</label>\n                    <input type="number" class="form-control" data-leg-field="underlyingPrice" step="0.01" min="0">\n                </div>\n            </div>\n        ';const n=i.querySelector('[data-leg-field="orderType"]'),s=this.normalizeLegOrderType(e?.orderType||e?.tradeType||e?.order||this.deriveOrderTypeFromActionSide(e?.action,e?.side));n&&(n.value=s);const o=i.querySelector('[data-leg-field="type"]'),l=this.normalizeLegType(e?.type||"CALL");o&&(o.value=l,o.addEventListener("change",()=>{this.applyUnderlyingTypeToLegMultipliers({row:i,force:!0})}));const c=this.getSelectedUnderlyingType({fallback:"Stock"}),d=this.normalizeUnderlyingType(e?.underlyingType,{fallback:c}),u=i.querySelector('[data-leg-field="quantity"]');u&&(e&&Number.isFinite(Number(e.quantity))?u.value=Math.abs(Number(e.quantity)):u.value=1);const m=i.querySelector('[data-leg-field="executionDate"]');m&&(m.value=e?.executionDate||"");const h=i.querySelector('[data-leg-field="expirationDate"]');h&&(h.value=e?.expirationDate||"");const p=i.querySelector('[data-leg-field="strike"]');p&&(p.value=Number.isFinite(Number(e?.strike))?Number(e.strike):"");const g=i.querySelector('[data-leg-field="premium"]');g&&(g.value=Number.isFinite(Number(e?.premium))?Number(e.premium):"");const y=i.querySelector('[data-leg-field="fees"]');y&&(y.value=Number.isFinite(Number(e?.fees))?Number(e.fees):"");const f=i.querySelector('[data-leg-field="multiplier"]');if(f){const t=Number.isFinite(Number(e?.multiplier))&&Number(e.multiplier)>0?Number(e.multiplier):this.getDefaultMultiplierForLegType(l,d);f.value=t,["change","input"].forEach(e=>{f.addEventListener(e,()=>{this.syncLegMultiplierVisibility(i)})})}const b=i.querySelector(".trade-leg__multiplier-toggle");b&&b.addEventListener("click",e=>{e.preventDefault();i.classList.toggle("trade-leg--multiplier-open")||this.applyUnderlyingTypeToLegMultipliers({row:i,force:!1}),this.syncLegMultiplierVisibility(i)});const C=i.querySelector('[data-leg-field="underlyingPrice"]');C&&(C.value=Number.isFinite(Number(e?.underlyingPrice))?Number(e.underlyingPrice):"");const S=i.querySelector(".trade-leg__remove");return S&&S.addEventListener("click",()=>{this.removeLegFormRow(i)}),t.appendChild(i),this.applyUnderlyingTypeToLegMultipliers({row:i,force:!e}),this.syncLegMultiplierVisibility(i),this.updateLegRowNumbers(),i}removeLegFormRow(e){const t=this.getLegsContainer();t&&e&&(t.removeChild(e),0===t.children.length?this.addLegFormRow():(this.updateLegRowNumbers(),this.applyUnderlyingTypeToLegMultipliers({force:!1})))}updateLegRowNumbers(){const e=this.getLegsContainer();e&&Array.from(e.querySelectorAll(".trade-leg")).forEach((t,i)=>{const r=t.querySelector("[data-leg-label]");r&&(r.textContent=`Leg ${i+1}`);const a=t.querySelector(".trade-leg__remove");a&&(a.disabled=1===e.children.length)})}collectLegsFromForm(){const e=this.getLegsContainer();if(!e)return[];const t=Array.from(e.querySelectorAll(".trade-leg"));if(0===t.length)return[];const i=[],r=[],a=this.getSelectedUnderlyingType({fallback:"Stock"});return t.forEach((e,t)=>{const n=t=>{const i=e.querySelector(`[data-leg-field="${t}"]`);return i?i.value:""},s=this.normalizeLegOrderType(n("orderType")||"BTO"),o=this.mapOrderTypeToActionSide(s),l=this.normalizeLegAction(o.action),c=this.normalizeLegSide(o.side),d=this.normalizeLegType(n("type")||"CALL"),u=n("quantity"),m=this.parseInteger(u,null,{allowNegative:!1});if(!Number.isFinite(m)||m<=0)return void r.push(`Leg ${t+1} must have a quantity greater than 0.`);const h=n("multiplier"),p=this.parseInteger(h,null,{allowNegative:!1}),g=Number.isFinite(p)&&p>0?p:this.getDefaultMultiplierForLegType(d,a),y=n("strike"),f=this.parseDecimal(y,null,{allowNegative:!1}),b=n("premium"),C=this.parseDecimal(b,0,{allowNegative:!1}),S=n("fees"),L=this.parseDecimal(S,0,{allowNegative:!1}),T=n("underlyingPrice"),N=this.parseDecimal(T,null,{allowNegative:!1}),I=n("executionDate")||"",v=n("expirationDate")||"",x={id:e.dataset.legId||this.generateLegId(t),orderType:s,action:l,side:c,type:d,quantity:m,multiplier:g,executionDate:I,expirationDate:v,strike:f,premium:C,fees:L,underlyingPrice:N,underlyingType:a};i.push(x)}),r.length>0?(this.showNotification(r.join("\n"),"error"),null):i}getPrimaryLeg(e={}){if(e.primaryLeg&&e.primaryLeg.id)return this.normalizeLeg(e.primaryLeg);if(Array.isArray(e.legs)&&e.legs.length>0){const t=e.legs.map((e,t)=>this.normalizeLeg(e,t));return t.find(e=>"OPEN"===e.side)||t[0]}return null}deriveTradeTypeFromLeg(e){if(!e)return"BTO";const t=this.normalizeLegAction(e.action),i=this.normalizeLegSide(e.side);return"BUY"===t&&"OPEN"===i?"BTO":"SELL"===t&&"OPEN"===i?"STO":"SELL"===t&&"CLOSE"===i?"STC":"BUY"===t&&"CLOSE"===i?"BTC":"SELL"===t?"STO":"BTO"}deriveTradeDirectionFromLeg(e){if(!e)return"long";return"SELL"===this.normalizeLegAction(e.action)?"short":"long"}getTradeType(e){const t=this.getPrimaryLeg(e);return this.deriveTradeTypeFromLeg(t)}inferTradeDirection(e){const t=this.getPrimaryLeg(e);return this.deriveTradeDirectionFromLeg(t)}normalizeStatus(e){return(e||"").toString().trim().toLowerCase()}normalizeTradeStatusInput(e){const t=(e||"").toString().trim().toLowerCase();return t?"open"===t?"Open":"closed"===t?"Closed":"expired"===t?"Expired":"assigned"===t?"Assigned":"rolling"===t||"rolled"===t?"Rolling":"":""}isClosedStatus(e){const t=this.normalizeStatus(e);return"closed"===t||"assigned"===t||"expired"===t}isActiveStatus(e){const t=this.normalizeStatus(e);return"open"===t||"rolling"===t}isAssignmentReason(e){return(e||"").toString().trim().toLowerCase().includes("assign")}getDisplayStatus(e){if(!e)return"Unknown";const t=(e.status||"Unknown").toString().trim();if(!t)return"Unknown";const i=t.toLowerCase();return"closed"===i&&this.isAssignmentReason(e.exitReason)||"assigned"===i?"Assigned":"expired"===i?"Expired":"rolling"===i?"Rolling":t}calculateDTE(e,t){let i=this.parseDateValue(e);if(!i&&this.isPmccTrade(t)){const e=this.parseDateValue(t?.pmccShortExpiration);e&&(i=e)}if(!i)return 0;if(this.isClosedStatus(t.status))return 0;const r=i.getTime()-this.currentDate.getTime();if(!Number.isFinite(r))return 0;const a=Math.ceil(r/864e5);return Math.max(0,a)}calculatePL(e){if(!e)return 0;const t=this.summarizeLegs(e.legs||[]),i=Number.isFinite(Number(e.cashFlow))?Number(e.cashFlow):Number(t.cashFlow);return Number.isFinite(i)?parseFloat(i.toFixed(2)):0}calculateROI(e){const t=this.calculatePL(e),i=this.getCapitalAtRisk(e);if(!(i>0))return 0;const r=t/i*100;return Number.isFinite(r)?parseFloat(r.toFixed(2)):0}calculateDaysHeld(e){if(!e)return 0;const t=this.parseDateValue(e.entryDate||e.openedDate);if(!t)return 0;const i=this.parseDateValue(e.exitDate||e.closedDate),r=(this.isClosedStatus(e.status)&&i?i:this.currentDate).getTime()-t.getTime();if(!Number.isFinite(r)||r<0)return 0;const a=Math.ceil(r/864e5);return Math.max(1,a)}calculateMaxRisk(e){if(!e)return 0;const t=Number(e.maxRiskOverride);if(Number.isFinite(t)&&t>0)return t;const i=this.summarizeLegs(e.legs||[]),r=this.computeMaxRiskUsingFormula(e,i);if(r===Number.POSITIVE_INFINITY)return Number.POSITIVE_INFINITY;if(Number.isFinite(r)&&r>0)return r;const a=Number(e.capitalAtRisk);if(a===Number.POSITIVE_INFINITY)return Number.POSITIVE_INFINITY;if(Number.isFinite(a)&&a>0)return a;const n=Number(e.maxRisk);return n===Number.POSITIVE_INFINITY?Number.POSITIVE_INFINITY:Number.isFinite(n)&&n>0?n:0}getCapitalAtRisk(e){if(!e)return 0;const t=Number(e.maxRiskOverride);if(Number.isFinite(t)&&t>0)return t;const i=this.summarizeLegs(e.legs||[]),r=this.computeMaxRiskUsingFormula(e,i);if(r===Number.POSITIVE_INFINITY)return Number.POSITIVE_INFINITY;if(Number.isFinite(r)&&r>0)return r;const a=Number(e.capitalAtRisk);if(a===Number.POSITIVE_INFINITY)return Number.POSITIVE_INFINITY;if(Number.isFinite(a)&&a>0)return a;const n=Number(e.maxRisk);return n===Number.POSITIVE_INFINITY?Number.POSITIVE_INFINITY:Number.isFinite(n)&&n>0?n:0}calculateAnnualizedROI(e){if(!e||!this.isClosedStatus(e.status))return 0;const t=Number.isFinite(Number(e.roi))?Number(e.roi):this.calculateROI(e);if(!Number.isFinite(t))return 0;const i=Number(e.daysHeld)||this.calculateDaysHeld(e)||0,r=365*t/Math.max(1,i);return Number.isFinite(r)?parseFloat(r.toFixed(2)):0}buildLegLifecycleKey(e={}){const t=this.normalizeLegType(e.type),i=Number(e.strike);return`${t}|${Number.isFinite(i)?i.toFixed(4):"NA"}|${(e.expirationDate||"").toString()}|${this.getLegMultiplier(e)||1}`}getNormalizedLegOrderType(e={}){const t=e.orderType||e.tradeType||e.order;return this.normalizeLegOrderType(t||this.deriveOrderTypeFromActionSide(e.action,e.side))}determineTradeLifecycleStatus(e={},t={}){const i=Array.isArray(t?.legs)?t.legs:[],r={status:"Open",exitReason:null,effectiveClosedDate:null,openContractsOverride:void 0,meta:{matchedPairs:!1,unmatchedExposure:0,expirationPassed:!1,hasRollLegs:!1,hasCloseActivity:!1,hasAssignmentEvent:!1,hasExpirationEvent:!1}};if(0===i.length)return r.meta.matchedPairs=!0,r;const a=new Map;let n=!1,s=!1,o=!1,l=!1;i.forEach(e=>{const t=Math.abs(Number(e.quantity)||0);if(!t)return;const i=this.buildLegLifecycleKey(e);a.has(i)||a.set(i,{longOpen:0,longClose:0,shortOpen:0,shortClose:0});const r=a.get(i);switch(this.getNormalizedLegOrderType(e)){case"BTO":r.longOpen+=t;break;case"STC":r.longClose+=t,s=!0;break;case"STO":r.shortOpen+=t;break;case"BTC":r.shortClose+=t,s=!0}"ROLL"===(e.side||"").toString().toUpperCase()&&(n=!0);const c=(e.orderType||e.tradeType||e.order||"").toString().toUpperCase(),d=(e.action||"").toString().toUpperCase();(c.includes("ASSIGN")||d.includes("ASSIGN"))&&(o=!0),(c.includes("EXPIRE")||c.includes("EXPIRY")||d.includes("EXPIRE"))&&(l=!0)});let c=!0,d=0;a.forEach(e=>{const t=Math.abs(e.longOpen-e.longClose),i=Math.abs(e.shortOpen-e.shortClose);(t>0||i>0)&&(c=!1),d+=t+i});const u=this.parseDateValue(e.expirationDate||t.latestExpiration),m=this.currentDate instanceof Date?this.currentDate:new Date,h=!!u&&m.getTime()>u.getTime(),p=t.closedDate instanceof Date?t.closedDate:this.parseDateValue(e.closedDate||e.exitDate),g=!!(h&&p&&u)&&p.getTime()>=u.getTime();r.meta={matchedPairs:c,unmatchedExposure:d,expirationPassed:h,hasRollLegs:n,hasCloseActivity:s,hasAssignmentEvent:o,hasExpirationEvent:l,activityAfterExpiration:g};const y=this.normalizeStatus(e.status);return!o&&this.isAssignmentTrade(e)&&(o=!0),o?(r.status="Assigned",r.exitReason=e.exitReason||"Assigned",r.openContractsOverride=0,!r.effectiveClosedDate&&p&&(r.effectiveClosedDate=p.toISOString().slice(0,10)),r):c||0===d?(r.status="Closed",l&&!e.exitReason&&(r.exitReason="Expired OTM"),r.openContractsOverride=0,!r.effectiveClosedDate&&p&&(r.effectiveClosedDate=p.toISOString().slice(0,10)),r):h&&!o?(r.status="Expired",e.exitReason||(r.exitReason="Expired OTM"),r.openContractsOverride=0,u&&(r.effectiveClosedDate=u.toISOString().slice(0,10)),r):n||s&&d>0?(r.status="Rolling",r):g&&!o?(r.status="Closed",e.exitReason||(r.exitReason="Closed post-expiration"),r.openContractsOverride=0,p&&(r.effectiveClosedDate=p.toISOString().slice(0,10)),r):"expired"===y&&u?(r.status="Expired",r.openContractsOverride=0,e.exitReason||(r.exitReason="Expired OTM"),r.effectiveClosedDate||(r.effectiveClosedDate=u.toISOString().slice(0,10)),r):(r.status="Open",r)}enrichTradeData(e){const t={...e};delete t.optionType;const i=(t.strategy||"").toString().trim();t.strategy=this.getStrategyDisplayName(i),t.underlyingType=this.normalizeUnderlyingType(e.underlyingType,{fallback:"Stock"});const r=this.summarizeLegs(t.legs);t.legs=r.legs,t.legsCount=r.legsCount,t.openContracts=Math.max(0,r.openContracts-r.closeContracts),t.closeContracts=r.closeContracts,t.openLegs=Math.max(0,r.openLegs-r.closeLegs),t.rollLegs=r.rollLegs,t.netPremium=Number(r.netPremium.toFixed(2)),t.totalFees=Number(r.totalFees.toFixed(4)),t.totalDebit=Number(r.totalDebit.toFixed(2)),t.totalCredit=Number(r.totalCredit.toFixed(2)),t.cashFlow=Number(r.cashFlow.toFixed(2));const a=Number(r.capitalAtRisk);t.capitalAtRisk=Number.isFinite(a)?Number(a.toFixed(2)):a,t.fees=t.totalFees,t.primaryLeg=r.primaryLeg;const n=Number(e.maxRiskOverride);Number.isFinite(n)&&n>0?t.maxRiskOverride=n:t.maxRiskOverride=null;const s=r.primaryLeg;t.tradeType=this.deriveTradeTypeFromLeg(s),t.tradeDirection=this.deriveTradeDirectionFromLeg(s);const o=s?Math.abs(Number(s.quantity)||0):0;t.quantity="short"===t.tradeDirection?-o:o,t.strikePrice=this.derivePrimaryStrike(r),t.multiplier=this.getLegMultiplier(s),t.displayStrike=this.buildStrikeDisplay(t,r);const l=this.getActiveStrikeForDisplay(r);t.activeStrikePrice=Number.isFinite(l)?Number(l):null;const c=r.entryPrice,d=r.exitPrice;t.entryPrice=Number.isFinite(c)?Number(c.toFixed(4)):null,t.exitPrice=Number.isFinite(d)?Number(d.toFixed(4)):null,t.entryPriceLabel=this.buildEntryPriceDisplay(t,r);const u=this.assessRisk(t,r);t.maxRiskOverride&&(u.maxRiskValue=t.maxRiskOverride,u.maxRiskLabel=this.formatCurrency(t.maxRiskOverride),u.unlimited=!1,r.capitalAtRisk=t.maxRiskOverride),t.capitalAtRisk=u.maxRiskValue,Number.isFinite(t.capitalAtRisk)&&(t.capitalAtRisk=Number(t.capitalAtRisk.toFixed(2))),t.maxRiskLabel=u.maxRiskLabel,t.riskIsUnlimited=u.unlimited;const m=this.parseDateValue(t.openedDate||t.entryDate||r.openedDate),h=this.parseDateValue(t.closedDate||t.exitDate||(r.closeLegs>0?r.closedDate:null));let p=this.parseDateValue(t.expirationDate);!p&&r.latestExpiration&&(p=r.latestExpiration);const g=r.nextShortCallExpiration||r.nearestShortCallExpiration||null;this.isPmccTrade(t)&&g&&(p=g),t.pmccShortExpiration=g?g.toISOString().slice(0,10):"",t.longExpirationDate=r.latestExpiration?r.latestExpiration.toISOString().slice(0,10):"",t.openedDate=m?m.toISOString().slice(0,10):"",t.closedDate=h?h.toISOString().slice(0,10):"",t.entryDate=t.openedDate,t.exitDate=t.closedDate,t.expirationDate=p?p.toISOString().slice(0,10):"",t.pl=this.calculatePL(t),t.roi=this.calculateROI(t),t.maxRisk=this.calculateMaxRisk(t),t.maxRiskLabel||(t.maxRiskLabel=Number.isFinite(t.maxRisk)?this.formatCurrency(t.maxRisk):t.maxRisk===Number.POSITIVE_INFINITY?"Unlimited":"—");const y=this.determineTradeLifecycleStatus(t,r);t.lifecycleMeta=y.meta,t.lifecycleStatus=y.status,"number"==typeof y.openContractsOverride&&(t.openContracts=Math.max(0,y.openContractsOverride)),y.effectiveClosedDate&&(t.closedDate=y.effectiveClosedDate,t.exitDate=y.effectiveClosedDate),y.exitReason&&!t.exitReason&&(t.exitReason=y.exitReason),t.partialClose=Boolean(y.meta?.hasCloseActivity&&y.meta?.unmatchedExposure>0),t.rolledForward=Boolean(y.meta?.hasRollLegs),t.autoExpired="Expired"===y.status&&Boolean(y.meta?.expirationPassed);const f=this.normalizeTradeStatusInput(e.statusOverride);return f?(t.statusOverride=f,t.status=f):("statusOverride"in t&&delete t.statusOverride,t.status=y.status),t.daysHeld=this.calculateDaysHeld(t),t.dte=this.calculateDTE(t.expirationDate,t),t.annualizedROI=this.calculateAnnualizedROI(t),t}formatDateForInput(e){if(!e)return"";const t=new Date(e);if(isNaN(t.getTime()))return"";return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}calculateDaysBetween(e,t){const i=new Date(e),r=new Date(t),a=Math.abs(r.getTime()-i.getTime());return Math.ceil(a/864e5)}generateTickerLink(e){const t=(e??"").toString().trim().toUpperCase();return t?`https://www.investing.com/search/?q=${encodeURIComponent(t)}`:"https://www.investing.com/search/"}createTickerElement(e,t="ticker-link",i={}){const r=(e??"").toString().trim().toUpperCase();if(!r){const e=document.createElement("span");return e.className=`${t} ticker-link--placeholder`.trim(),e.textContent="—",e}const{behavior:a="external",onClick:n=null,title:s=""}=i||{},o=document.createElement("a");return o.className=t,o.textContent=r,s&&(o.title=s),"filter"===a&&"function"==typeof n?(o.href="#",o.setAttribute("role","button"),o.dataset.ticker=r,o.addEventListener("click",e=>{e.preventDefault(),n(r)})):(o.href=this.generateTickerLink(r),o.target="_blank",o.rel="noopener noreferrer",o.addEventListener("click",e=>{e.preventDefault(),window.open(this.generateTickerLink(r),"_blank","noopener,noreferrer")})),o}applyResponsiveLabels(e,t=[]){if(!e||!Array.isArray(t)||0===t.length)return;Array.from(e.cells||[]).forEach((e,i)=>{const r=t[i];r?e.setAttribute("data-label",r):e.removeAttribute("data-label")})}normalizeCycleId(e){return(e||"").toString().trim()}normalizeUnderlyingType(e,{fallback:t="Stock"}={}){const i=(e||"").toString().trim().toLowerCase();return["stock","etf","index","future"].includes(i)?i.charAt(0).toUpperCase()+i.slice(1):t}normalizeCycleType(e,t=""){const i=(e||"").toString().trim().toLowerCase();if("wheel"===i)return"wheel";if("pmcc"===i||"pmc"===i)return"pmcc";return this.inferCycleTypeFromStrategy(t)||i||""}inferCycleTypeFromStrategy(e=""){const t=e.toString().trim().toLowerCase();return t?t.includes("poor man")||t.includes("pmcc")?"pmcc":t.includes("cash-secured put")||t.includes("covered call")||t.includes("wheel")?"wheel":"":""}normalizeCycleRole(e,t={}){const i=(e||"").toString().trim().toLowerCase();return i||this.inferCycleRole(t)}inferCycleRole(e={}){const t=(e.strategy||"").toString().toLowerCase(),i=e.tradeDirection||this.inferTradeDirection(e),r=this.getTradeType(e);if(t.includes("cash-secured put"))return"wheel-put";if(t.includes("covered call"))return"wheel-call";if(t.includes("poor man")){if("long"===i||"BTO"===r)return"pmcc-base";if("short"===i||"STO"===r)return"pmcc-short"}return this.isAssignmentTrade(e)?"assignment":""}isWheelPut(e={}){if("wheel-put"===(e.cycleRole||"").toLowerCase())return!0;return(e.strategy||"").toLowerCase().includes("cash-secured put")}isCoveredCall(e={}){const t=(e.cycleRole||"").toLowerCase();if("wheel-call"===t||"covered-call"===t)return!0;return(e.strategy||"").toLowerCase().includes("covered call")}isPmccBaseLeg(e={}){if("pmcc-base"===(e.cycleRole||"").toLowerCase())return!0;return(e.strategy||"").toLowerCase().includes("poor man")&&("long"===e.tradeDirection||"BTO"===this.getTradeType(e))}isPmccShortCall(e={}){if("pmcc-short"===(e.cycleRole||"").toLowerCase())return!0;return(e.strategy||"").toLowerCase().includes("poor man")&&("short"===e.tradeDirection||"STO"===this.getTradeType(e))}isPmccTrade(e={}){if(!e)return!1;const t=(e.strategy||"").toLowerCase();if(t.includes("poor man")||t.includes("pmcc"))return!0;return"pmcc"===this.normalizeCycleType(e.cycleType,e.strategy)||(this.isPmccBaseLeg(e)||this.isPmccShortCall(e))}isAssignmentTrade(e={}){return"assigned"===this.normalizeStatus(e.status)||this.isAssignmentReason(e.exitReason)}calculateOptionPremium(e={}){const t=Math.abs(Number(e.quantity)||0);if(!t)return 0;const i=Number(e.entryPrice)||0,r=Number(e.exitPrice)||0,a=Number(e.fees)||0,n=(i-r)*t*100;return"short"===(e.tradeDirection||this.inferTradeDirection(e))?n-a:(r-i)*t*100-a}bindEvents(){document.querySelectorAll(".nav-item").forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-view");t&&this.showView(t)})});const e=document.getElementById("save-database-btn");e&&e.addEventListener("click",async e=>{e.preventDefault(),await this.saveDatabase()});const t=document.getElementById("load-database-btn");t&&t.addEventListener("click",async e=>{e.preventDefault(),await this.loadDatabase()});const i=document.getElementById("new-database-btn");i&&i.addEventListener("click",e=>{e.preventDefault(),this.newDatabase()}),this.setupImportControls(),this.setupTradesMergeControls();const r=document.getElementById("add-trade-form");r&&r.addEventListener("submit",e=>{e.preventDefault(),this.handleTradeSubmit()});const a=document.getElementById("add-leg-button");a&&a.addEventListener("click",()=>this.addLegFormRow());const n=document.getElementById("cancel-trade");n&&n.addEventListener("click",e=>{e.preventDefault(),this.resetAddTradeForm(),this.showView("trades-list")});const s=document.getElementById("ticker");s&&s.addEventListener("input",e=>{this.updateTickerPreview(e.target.value)});const o=document.getElementById("underlyingType");o&&o.addEventListener("change",()=>{this.applyUnderlyingTypeToLegMultipliers({force:!1})}),["filter-strategy","filter-status"].forEach(e=>{const t=document.getElementById(e);t&&t.addEventListener("change",()=>this.filterTrades())});const l=document.getElementById("search-ticker");l&&l.addEventListener("input",()=>this.filterTrades());const c=document.getElementById("export-csv");c&&c.addEventListener("click",()=>this.exportToCSV()),document.querySelectorAll(".sortable").forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-sort");t&&this.sortTrades(t)})});const d=document.getElementById("ai-chat-toggle");d&&d.addEventListener("click",()=>this.toggleAIChat());const u=document.getElementById("ai-chat-close");u&&u.addEventListener("click",()=>this.toggleAIChat(!1));const m=document.getElementById("ai-chat-form");m&&m.addEventListener("submit",e=>{e.preventDefault(),this.handleAIChatSubmit()}),document.querySelectorAll(".ai-chat__quick-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-ai-prompt");t&&this.handleAIQuickPrompt(t)})});const h=document.getElementById("ai-chat");h&&h.addEventListener("click",e=>{const t=e.target instanceof Element?e.target:null,i=t?.closest('a[href="#settings"]');if(!i)return;e.preventDefault(),this.showView("settings"),this.toggleAIChat(!1);const r=document.getElementById("gemini-api-key");r&&setTimeout(()=>r.focus(),120)}),this.renderLegForms([]),this.setupAIChatResizeHandle(),this.setTodayDate(),this.setupResponsiveFilters()}setupResponsiveFilters(){const e=document.getElementById("trades-filters-panel"),t=document.getElementById("toggle-filters");if(!e||!t)return;const i=e=>{t.textContent=e?"Hide Filters":"Show Filters",t.setAttribute("aria-expanded",String(e))};let r=window.innerWidth<=768;const a=(t=!1)=>{const a=window.innerWidth<=768;a?(!t&&r||e.classList.remove("is-open"),i(e.classList.contains("is-open"))):(e.classList.add("is-open"),i(!0)),r=a};t.addEventListener("click",()=>{const t=e.classList.toggle("is-open");i(t)});let n=null;window.addEventListener("resize",()=>{clearTimeout(n),n=setTimeout(()=>a(!1),160)}),a(!0)}setupAIChatResizeHandle(){const e=document.getElementById("ai-chat-panel"),t=document.getElementById("ai-chat-resize-handle")||e?.querySelector(".ai-chat__resize-handle");if(!e||!t||"true"===t.dataset.initialized)return void(t&&(t.dataset.initialized="true"));const i=(e,t,i)=>Math.min(Math.max(e,t),i),r={resizing:!1,startX:0,startY:0,startWidth:0,startHeight:0,maxWidth:0,maxHeight:0,minWidth:280,minHeight:280,rightMargin:24,bottomMargin:24,viewportPadding:24},a=i=>{if(r.resizing){if(r.resizing=!1,e.classList.remove("ai-chat__panel--resizing"),i)try{t.releasePointerCapture(i.pointerId)}catch(e){}document.removeEventListener("pointermove",n),document.removeEventListener("pointerup",a),document.removeEventListener("pointercancel",a)}},n=t=>{if(!r.resizing)return;t.preventDefault();const a=t.clientX-r.startX,n=t.clientY-r.startY,s=i(r.startWidth-a,r.minWidth,r.maxWidth),o=i(r.startHeight-n,r.minHeight,r.maxHeight);e.style.width=`${s}px`,e.style.height=`${o}px`};t.addEventListener("pointerdown",i=>{if(0!==i.button&&"touch"!==i.pointerType)return;i.preventDefault();const s=e.getBoundingClientRect();r.resizing=!0,r.startX=i.clientX,r.startY=i.clientY,r.startWidth=s.width,r.startHeight=s.height,r.rightMargin=Math.max(r.viewportPadding,Math.round(window.innerWidth-s.right)),r.bottomMargin=Math.max(r.viewportPadding,Math.round(window.innerHeight-s.bottom)),r.maxWidth=Math.max(r.minWidth,window.innerWidth-r.rightMargin-r.viewportPadding),r.maxHeight=Math.max(r.minHeight,window.innerHeight-r.bottomMargin-r.viewportPadding),e.classList.add("ai-chat__panel--resizing"),e.style.removeProperty("transform");try{t.setPointerCapture(i.pointerId)}catch(e){}document.addEventListener("pointermove",n,{passive:!1}),document.addEventListener("pointerup",a),document.addEventListener("pointercancel",a)}),t.dataset.initialized="true"}initializeAIChat(){if(this.updateAIChatHeader(),!this.aiAgent)return void(this.aiChatMessages=[]);const e=this.calculateAdvancedStats();this.aiAgent.updateContext({stats:e,openTrades:e.openTradesList,closedTrades:e.closedTradesList}),this.aiChatSessionId=Date.now(),this.aiChatMessages=[],this.aiChatPendingRequest=!1;const t=this.aiAgent.getGreeting();t?this.appendAIChatMessage("ai",t):this.renderAIChatMessages()}toggleAIChat(e=null){const t=document.getElementById("ai-chat-panel"),i=document.getElementById("ai-chat-toggle"),r=document.getElementById("ai-chat-input");if(!t||!i)return;if(null===e?t.classList.contains("hidden"):Boolean(e)){if(!this.hasAICoachConsent())return void this.promptAICoachConsent(()=>this.toggleAIChat(!0));t.classList.remove("hidden"),t.setAttribute("aria-hidden","false"),i.setAttribute("aria-expanded","true"),this.aiChatOpen=!0,r&&setTimeout(()=>r.focus(),80)}else t.classList.add("hidden"),t.setAttribute("aria-hidden","true"),i.setAttribute("aria-expanded","false"),this.aiChatOpen=!1}async handleAIChatSubmit(){if(this.aiChatPendingRequest)return;const e=document.getElementById("ai-chat-input");if(!e)return;const t=e.value.trim();if(!t)return;if(!this.hasAICoachConsent())return void this.promptAICoachConsent(()=>{e.value.trim()||(e.value=t),this.handleAIChatSubmit()});this.appendAIChatMessage("user",t),e.value="";const i=this.appendAIChatMessage("ai","Analyzing your portfolio...",{pending:!0}),r=this.aiChatMessages.filter(e=>e.id!==i).slice(-10).map(e=>({...e}));this.aiChatPendingRequest=!0;try{const e=this.aiAgent?await this.aiAgent.generateResponse(t,{history:r}):"AI assistant is unavailable at the moment.";this.appendAIChatMessage("ai",e,{replaceId:i,pending:!1})}catch(e){const t=e?.message||"Unknown error",r="Sorry, I could not reach Gemini right now. Please try again soon.";this.appendAIChatMessage("ai",`${r} (${t})`,{replaceId:i,pending:!1})}finally{this.aiChatPendingRequest=!1,e&&e.focus()}}async handleAIQuickPrompt(e){if(this.aiChatPendingRequest||!e)return;if(!this.hasAICoachConsent())return void this.promptAICoachConsent(()=>this.handleAIQuickPrompt(e));this.toggleAIChat(!0);const t=document.getElementById("ai-chat-input");t&&(t.value=""),this.appendAIChatMessage("user",e);const i=this.appendAIChatMessage("ai","Analyzing your portfolio...",{pending:!0}),r=this.aiChatMessages.filter(e=>e.id!==i).slice(-10).map(e=>({...e}));this.aiChatPendingRequest=!0;try{const t=this.aiAgent?await this.aiAgent.generateResponse(e,{history:r}):"AI assistant is unavailable at the moment.";this.appendAIChatMessage("ai",t,{replaceId:i,pending:!1})}catch(e){const t=e?.message||"Unknown error",r="Sorry, I could not reach Gemini right now. Please try again soon.";this.appendAIChatMessage("ai",`${r} (${t})`,{replaceId:i,pending:!1})}finally{this.aiChatPendingRequest=!1,t&&t.focus()}}appendAIChatMessage(e,t,i={}){const r="ai"===e?"ai":"user",{suppressRender:a=!1,replaceId:n=null,id:s=null,pending:o=!1}=i||{};if(!n&&("string"!=typeof t||0===t.length))return null;const l=new Date;if(n){const e=this.aiChatMessages.findIndex(e=>e.id===n);if(-1!==e){const i=this.aiChatMessages[e];return this.aiChatMessages[e]={...i,sender:r,text:t||"",timestamp:l,pending:Boolean(o)},a||this.renderAIChatMessages(),this.aiChatMessages[e].id}}const c={id:s||`${this.aiChatSessionId}-${Date.now()}-${Math.random().toString(16).slice(2)}`,sender:r,text:t||"",timestamp:l,pending:Boolean(o)};return this.aiChatMessages=[...this.aiChatMessages,c].slice(-200),a||this.renderAIChatMessages(),c.id}renderAIChatMessages(){const e=document.getElementById("ai-chat-history");e&&(e.innerHTML="",this.aiChatMessages.forEach(t=>{const i=document.createElement("div");i.className=`ai-chat__message ai-chat__message--${t.sender}`,t.pending&&i.classList.add("ai-chat__message--pending");const r=document.createElement("span");r.textContent="ai"===t.sender?this.getGeminiChatDisplayName():"You",i.appendChild(r);const a=document.createElement("div");a.className="ai-chat__bubble",t.pending&&a.setAttribute("data-pending","true"),"ai"===t.sender?a.innerHTML=this.renderMarkdownToHTML(t.text):a.textContent=t.text,i.appendChild(a),e.appendChild(i)}),e.scrollTop=e.scrollHeight)}renderMarkdownToHTML(e=""){if(!e)return"";const t=[],i=/```([\s\S]*?)```/g;let r,a=0;for(;null!==(r=i.exec(e));)r.index>a&&t.push({type:"text",value:e.slice(a,r.index)}),t.push({type:"code",value:r[1]}),a=r.index+r[0].length;return a<e.length&&t.push({type:"text",value:e.slice(a)}),t.map(e=>{if("code"===e.type){const t=e.value.replace(/^\n+|\n+$/g,"");return`<pre class="ai-chat__code"><code>${this.escapeHTML(t)}</code></pre>`}return this.renderMarkdownTextSegment(e.value)}).join("")}renderMarkdownTextSegment(e=""){if(!e)return"";const t=e.replace(/\r/g,"").split("\n"),i=[];let r=[],a=!1,n=!1;const s=()=>{a&&(i.push("</ul>"),a=!1),n&&(i.push("</ol>"),n=!1)},o=()=>{if(!r.length)return;const e=r.join(" ").trim();e&&i.push(`<p>${this.formatMarkdownInline(e)}</p>`),r=[]};return t.forEach(e=>{const t=e.trim();if(!t)return o(),void s();const l=t.match(/^(#{1,3})\s+(.*)$/);if(l){o(),s();const e=Math.min(l[1].length+2,6);return void i.push(`<h${e}>${this.formatMarkdownInline(l[2])}</h${e}>`)}if(/^([-*_])\1{2,}$/.test(t))return o(),s(),void i.push('<hr class="ai-chat__rule">');if(t.startsWith(">")){o(),s();const e=t.replace(/^>\s?/,"");return void i.push(`<blockquote class="ai-chat__quote">${this.formatMarkdownInline(e)}</blockquote>`)}const c=t.match(/^[-*]\s+(.*)$/);if(c)return o(),a||(s(),i.push("<ul>"),a=!0),void i.push(`<li>${this.formatMarkdownInline(c[1])}</li>`);const d=t.match(/^\d+\.\s+(.*)$/);if(d)return o(),n||(s(),i.push("<ol>"),n=!0),void i.push(`<li>${this.formatMarkdownInline(d[1])}</li>`);r.push(e)}),o(),s(),i.join("")}formatMarkdownInline(e=""){if(!e)return"";const t=/\[([^\]]+)\]\(([^)]+)\)/g;let i,r=0,a="";for(;null!==(i=t.exec(e));){if(i.index>r){const t=e.slice(r,i.index);a+=this.applyBasicInlineFormatting(t)}const t=this.applyBasicInlineFormatting(i[1]);a+=`<a href="${this.escapeHTML(this.sanitizeMarkdownUrl(i[2]))}" target="_blank" rel="noopener noreferrer">${t}</a>`,r=i.index+i[0].length}return r<e.length&&(a+=this.applyBasicInlineFormatting(e.slice(r))),a}applyBasicInlineFormatting(e=""){if(!e)return"";let t=this.escapeHTML(e);return t=t.replace(/`([^`]+)`/g,"<code>$1</code>"),t=t.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>"),t=t.replace(/__([^_]+)__/g,"<strong>$1</strong>"),t=t.replace(/\*(?!\s)([^*]+?)\*(?!\*)/g,"<em>$1</em>"),t=t.replace(/_([^_]+)_/g,"<em>$1</em>"),t}sanitizeMarkdownUrl(e=""){try{const t=e.trim();if(!t)return"#";if(t.startsWith("#")){const e=t.slice(1);return e&&/^[a-z0-9_-]{1,64}$/i.test(e)?`#${e}`:"#"}const i=t.toLowerCase();return i.startsWith("http://")||i.startsWith("https://")?t:"#"}catch(e){return"#"}}updateTickerPreview(e){const t=document.getElementById("ticker-preview");if(e&&e.trim()){const i=e.toUpperCase().trim(),r=this.generateTickerLink(i);t.innerHTML="";const a=document.createTextNode("Search ");t.appendChild(a);const n=document.createElement("a");n.href=r,n.target="_blank",n.rel="noopener noreferrer",n.className="ticker-link",n.textContent=i,n.addEventListener("click",e=>{e.preventDefault(),window.open(r,"_blank","noopener,noreferrer")}),t.appendChild(n);const s=document.createTextNode(" on Investing.com");t.appendChild(s)}else t.innerHTML=""}setTodayDate(){const e=this.currentDate,t=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`,i=document.getElementById("entryDate");i&&!this.currentEditingId&&(i.value=t)}showView(e){document.querySelectorAll(".nav-item").forEach(e=>{e.classList.remove("active")});const t=document.querySelector(`[data-view="${e}"]`);t&&t.classList.add("active"),document.querySelectorAll(".view").forEach(e=>{e.classList.remove("active")});const i=document.querySelector(`.${e}-view`);i&&i.classList.add("active");const r={dashboard:"Options Trading Dashboard","add-trade":this.currentEditingId?"Edit Trade":"Add New Trade","trades-list":"All Trades",import:"Import Trades",settings:"Settings"}[e]||"GammaLedger";switch(document.getElementById("page-title").textContent=r,this.currentView=e,e){case"dashboard":this.updateDashboard();break;case"add-trade":this.currentEditingId||this.resetAddTradeForm();break;case"trades-list":this.updateTradesList();break;case"import":this.setupImportControls(),this.renderImportLog();break;case"settings":{const e=this.finnhub?.lastStatus;e&&this.finnhub?.elements?.status&&this.updateFinnhubStatus(e.message,e.variant,0);break}}}resetAddTradeForm(){const e=document.getElementById("add-trade-form");e&&e.reset();const t=document.getElementById("underlyingType");t&&(t.value="Stock");const i=document.getElementById("tradeStatus");i&&(i.value=""),this.currentEditingId=null,this.renderLegForms([]),this.setTodayDate(),this.updateTickerPreview(""),["cycleId","cycleType","cycleRole"].forEach(e=>{const t=document.getElementById(e);t&&(t.value="")})}parseDecimal(e,t=null,{allowNegative:i=!0}={}){if(null==e)return t;let r="string"==typeof e?e.trim():e;if("string"==typeof r){if(""===r)return t;let e=r.replace(/\s+/g,"");if(!e)return t;const i=e.includes(","),a=e.includes(".");if(i&&!a)e=e.replace(/,/g,".");else if(i&&a){const t=e.lastIndexOf(","),i=e.lastIndexOf(".");e=t>i?e.replace(/\./g,"").replace(/,/g,"."):e.replace(/,/g,"")}e=e.replace(/_/g,""),r=e}const a=Number(r);return Number.isFinite(a)?!i&&a<0?t:a:t}parseDateValue(e){if(!e)return null;if(e instanceof Date)return Number.isNaN(e.getTime())?null:e;const t=e.toString().trim();if(!t)return null;const i=new Date(t);return Number.isNaN(i.getTime())?null:i}parseInteger(e,t=null,{allowNegative:i=!0}={}){if(null==e)return t;const r="string"==typeof e?e.trim():e;if(""===r)return t;const a=parseInt(r,10);return Number.isFinite(a)?!i&&a<0?t:a:t}parseExitPrice(e){const t=this.parseDecimal(e,null,{allowNegative:!1});return null===t?null:t}handleTradeSubmit(){const e=document.getElementById("add-trade-form");if(!e)return;const t=new FormData(e),i=this.collectLegsFromForm();if(null===i)return;if(0===i.length)return void this.showNotification("Add at least one leg before saving the trade.","error");const r=(t.get("ticker")||"").toString().trim().toUpperCase();if(!r)return void this.showNotification("Ticker is required.","error");const a=(t.get("strategy")||"").toString().trim();if(!a)return void this.showNotification("Strategy is required.","error");const n=this.normalizeUnderlyingType(t.get("underlyingType"),{fallback:"Stock"}),s=this.normalizeTradeStatusInput(t.get("tradeStatus")),o={ticker:r,strategy:a,exitReason:(t.get("exitReason")||"").toString().trim(),notes:(t.get("notes")||"").toString().trim(),legs:i,cycleId:(t.get("cycleId")||"").toString().trim(),cycleType:(t.get("cycleType")||"").toString().trim(),cycleRole:(t.get("cycleRole")||"").toString().trim(),underlyingType:n};if(s&&(o.statusOverride=s),this.currentEditingId)return o.id=this.currentEditingId,void(this.updateTrade(o)&&(this.showNotification("Trade updated successfully","success"),this.resetAddTradeForm(),this.showView("trades-list")));o.id=Date.now();const l=this.enrichTradeData(o);this.trades.push(l),this.saveToStorage(),this.markUnsavedChanges(),this.resetAddTradeForm(),this.showView("dashboard")}updateTrade(e){try{e.id=this.currentEditingId;const t=this.enrichTradeData(e),i=this.trades.findIndex(e=>e.id===this.currentEditingId);return-1!==i&&(this.trades[i]=t,this.saveToStorage(),this.markUnsavedChanges(),!0)}catch(e){return console.error("Error updating trade:",e),!1}}updateDashboard(){const e=this.calculateAdvancedStats(),{openTradesList:t,closedTradesList:i}=e;this.latestStats=e,this.aiAgent&&this.aiAgent.updateContext({stats:e,openTrades:t,closedTrades:i}),this.cycleAnalytics=this.calculateCycleAnalytics(),document.getElementById("total-pl").textContent=this.formatCurrency(e.totalPL);const r=this.formatNumber(e.totalROI,{style:"percent"});document.getElementById("pl-percentage").textContent=r?`${r} Return`:"—";const a=this.formatNumber(e.winRate,{style:"percent",decimals:1});document.getElementById("win-rate").textContent=a??"—",document.getElementById("win-loss-count").textContent=`${e.wins}W / ${e.losses}L`;const n=Number(e.profitFactor);document.getElementById("profit-factor").textContent=Number.isFinite(n)?this.formatNumber(n,{decimals:2,useGrouping:!1}).toString():"Infinite",document.getElementById("active-positions").textContent=e.activePositions,document.getElementById("total-roi").textContent=this.formatNumber(e.totalROI,{style:"percent"})??"—",document.getElementById("max-drawdown").textContent=this.formatNumber(e.maxDrawdown,{style:"percent",decimals:1})??"—",this.updateActivePositionsTable(t),this.updateRecentTradesTable(i,e.activePositions),this.updateCycleSummaryTable(this.cycleAnalytics),this.updateShareCard(e),setTimeout(()=>{this.updateAllCharts()},200)}calculateAdvancedStats(){const e=this.trades.filter(e=>this.isClosedStatus(e.status)),t=this.trades.filter(e=>this.isActiveStatus(e.status)),i=e.filter(e=>e.pl>0),r=e.filter(e=>e.pl<0),a=e.reduce((e,t)=>e+t.pl,0),n=e.reduce((e,t)=>{const i=this.getCapitalAtRisk(t);return Number.isFinite(i)&&i>0?e+i:e},0),s=e.length>0?i.length/e.length*100:0,o=i.reduce((e,t)=>e+Math.max(t.pl,0),0),l=r.reduce((e,t)=>e+Math.abs(t.pl),0);let c=0;l>0?c=o/l:o>0&&(c=Number.POSITIVE_INFINITY);let d=0,u=0,m=0;[...e].sort((e,t)=>new Date(e.exitDate)-new Date(t.exitDate)).forEach(e=>{m+=e.pl,m>u&&(u=m);const t=u>0?(u-m)/u*100:0;t>d&&(d=t)});const h=n>0?a/n*100:0,p=e.length>0?e.reduce((e,t)=>e+t.daysHeld,0)/e.length:0,g=p>0?100*(Math.pow(1+h/100,365/p)-1):0,y=e.reduce((e,t)=>{const i=Number(t.totalFees);if(Number.isFinite(i))return e+i;const r=Number(t.fees);return Number.isFinite(r)?e+r:e},0),f=y+o+l,b=f>0?y/f*100:0,C=e.map(e=>{const t=Number(e.roi),i=Math.max(1,Number(e.daysHeld)||0);if(Number.isFinite(t)){const e=1+t/100;return e>0?Math.pow(e,1/i)-1:t/100/i}const r=this.getCapitalAtRisk(e),a=Number(e.pl)||0;if(!(r>0))return null;const n=a/r*100;if(!Number.isFinite(n))return null;const s=1+n/100;return s>0?Math.pow(s,1/i)-1:n/100/i}).filter(e=>Number.isFinite(e)),S=C.length?C.reduce((e,t)=>e+t,0)/C.length:0;let L=0;if(C.length>1){const e=C.reduce((e,t)=>e+Math.pow(t-S,2),0)/(C.length-1);L=e>0?Math.sqrt(e):0}const T=C.filter(e=>e<0),N=T.length?Math.sqrt(T.reduce((e,t)=>e+t*t,0)/T.length):0,I=L>0?S/L*Math.sqrt(252):null,v=N>0?S/N*Math.sqrt(252):0===T.length&&S>0?Number.POSITIVE_INFINITY:null,x=i.length>0?i.reduce((e,t)=>e+(Number(t.daysHeld)||0),0)/i.length:0,D=r.length>0?r.reduce((e,t)=>e+(Number(t.daysHeld)||0),0)/r.length:0,k=this.calculateTickerPerformance(e);return{totalTrades:this.trades.length,totalPL:a,winRate:s,wins:i.length,losses:r.length,profitFactor:c,activePositions:t.length,totalROI:h,annualizedROI:g,maxDrawdown:d,closedTrades:e.length,totalInvestment:n,totalMaxRisk:n,closedTradesList:e,openTradesList:t,totalFees:y,feeShareOfGross:b,dailyReturns:C,meanDailyReturn:S,dailyStdDev:L,downsideDeviation:N,sharpeRatio:I,sortinoRatio:v,avgWinnerDays:x,avgLoserDays:D,tickerPerformance:k}}calculateTickerPerformance(e=[]){const t=new Map;e.forEach(e=>{const i=(e.ticker||"Unknown").toString().trim().toUpperCase()||"UNKNOWN";t.has(i)||t.set(i,{ticker:i,totalPL:0,tradeCount:0,wins:0,losses:0});const r=t.get(i),a=Number(e.pl)||0;r.totalPL+=a,r.tradeCount+=1,a>0?r.wins+=1:a<0&&(r.losses+=1)});const i=Array.from(t.values()).map(e=>{const t=e.tradeCount>0?e.wins/e.tradeCount*100:0,i=e.tradeCount>0?e.totalPL/e.tradeCount:0;return{...e,avgPL:i,winRate:t}}).sort((e,t)=>Math.abs(t.totalPL)-Math.abs(e.totalPL)),r=i.length?Math.max(...i.map(e=>Math.abs(e.totalPL))):0;return{items:i,maxMagnitude:r}}calculateCycleAnalytics(){const e=new Map;this.trades.forEach(t=>{const i=this.normalizeCycleId(t.cycleId);if(!i)return;const r=e.get(i)||{cycleId:i,cycleType:this.normalizeCycleType(t.cycleType,t.strategy),trades:[],ticker:t.ticker||""};!r.ticker&&t.ticker&&(r.ticker=t.ticker),r.cycleType||(r.cycleType=this.normalizeCycleType(t.cycleType,t.strategy)),r.trades.push(t),e.set(i,r)});const t=Array.from(e.values()).map(e=>this.computeCycleMetrics(e));return t.sort((e,t)=>{const i=e.startDate?new Date(e.startDate).getTime():0;return(t.startDate?new Date(t.startDate).getTime():0)-i}),t}computeCycleMetrics(e){const t=[...e.trades].sort((e,t)=>new Date(e.entryDate)-new Date(t.entryDate)),i=this.normalizeCycleType(e.cycleType,t[0]?.strategy||"");let r=null,a=null,n=!1,s=0,o=0,l=0,c=0,d=0,u=0,m=0,h=null,p=null,g=null,y=0,f=0;t.forEach(e=>{const t=e.entryDate?new Date(e.entryDate):null;t&&!isNaN(t.getTime())&&(!r||t<r)&&(r=t);const i=e.exitDate?new Date(e.exitDate):null;i&&!isNaN(i.getTime())?(!a||i>a)&&(a=i):n=!0;const b=Number(e.pl)||0;o+=b;const C=Math.abs(Number(e.quantity)||0);C>f&&(f=C);if("short"===(e.tradeDirection||this.inferTradeDirection(e))){const t=this.calculateOptionPremium(e);if(s+=t,this.isWheelPut(e)){l+=t;const i=Number(e.strikePrice)||0;!h&&i>0&&(h=i);const r=i*C*100;r>m&&(m=r)}(this.isCoveredCall(e)||this.isPmccShortCall(e))&&(c+=t)}else if(this.isPmccBaseLeg(e)){const t=Number(e.entryPrice),i=Number(e.exitPrice),r=Number(e.fees),a=Number.isFinite(t)?t*C*100:0,n=Number.isFinite(i)?i*C*100:0,s=Number.isFinite(r)?Math.max(r,0):0;d+=a-n+s,a>0&&(u+=a+s);const o=Number(e.strikePrice);Number.isFinite(o)&&o>0&&(this.isClosedStatus(e.status)||(g=o),p=o)}if(this.isAssignmentTrade(e)){y+=C;const t=Number(e.strikePrice)||Number(e.stockPriceAtEntry)||null;if(!h&&Number.isFinite(t)&&t>0&&(h=t),Number.isFinite(t)&&t>0){const e=t*C*100;e>m&&(m=e)}}}),Number.isFinite(g)&&g>0&&(p=g);const b=n?"In Progress":"Closed",C=r?r.toISOString():null,S=!n&&a?a.toISOString():null;let L=null,T=null,N=null,I=null;if("wheel"===i&&h&&f>0)L=h-s/(100*f),T=L,N=m||h*f*100;else if("pmcc"===i){I=d-c;const e=Number.isFinite(I)&&I>0?I:null,t=d>0?d:null,i=u>0?u:null;e?N=e:t?N=t:i&&(N=i);const r=e||t||i;r&&r>m&&(m=r),Number.isFinite(p)&&p>0&&f>0&&Number.isFinite(I)&&(T=p+I/(100*f))}Number.isFinite(d)&&Math.abs(d)<1e-6&&(d=0),Number.isFinite(I)&&Math.abs(I)<1e-6&&(I=0);let v=N;if((!v||v<=0)&&("wheel"===i?v=m||(h&&f>0?h*f*100:null):"pmcc"===i&&(Number.isFinite(I)&&I>0?v=I:d>0?v=d:u>0&&(v=u))),!v||v<=0){const e=t.reduce((e,t)=>{const i=Math.abs(Number(t.quantity)||0);if(!i)return e;const r=Number(t.entryPrice),a=Number(t.fees)||0,n=this.getTradeType(t);if("BTO"===n||"BTC"===n){const t=(Number.isFinite(r)?r:0)*i*100+(Number.isFinite(a)?Math.max(a,0):0);return e+Math.max(t,0)}return e},0);v=e>0?e:null}(!N||N<=0)&&(N=v&&v>0?v:null);const x=N?o/N*100:null;let D="",k=null;return"wheel"===i&&null!==L?(D="Eff. Basis",k=L):"pmcc"===i&&null!==I&&(D="Net Basis",k=I),{cycleId:e.cycleId,cycleType:i,typeLabel:"pmcc"===i?"Poor Man's Covered Call":"wheel"===i?"Wheel":i?i.toUpperCase():"Custom",ticker:e.ticker||t[0]?.ticker||"—",trades:t,startDate:C,endDate:S,status:b,totalPremiums:s,totalPL:o,putPremiums:l,callPremiums:c,baseCost:d,baseInitialCost:u,capitalAtRisk:m,effectiveCostBasis:L,netBasis:I,costBasis:v,assignments:y,maxContracts:f,roiPercent:x,keyMetricLabel:D,keyMetricValue:k,breakevenPrice:T,hasOpenTrade:n,durationDays:r?this.calculateDaysBetween(r,a||this.currentDate):0}}updateCycleSummaryTable(e=this.cycleAnalytics||[]){const t=document.querySelector("#cycle-summary-table tbody"),i=document.getElementById("cycle-summary-empty");if(!t)return;if(t.innerHTML="",!Array.isArray(e)||0===e.length)return void(i&&i.classList.remove("hidden"));i&&i.classList.add("hidden");const r=["Cycle","Type","Ticker","Status","Trades","Premiums","Total P&L","ROI","Cost Basis","Key Metrics","Timeline"];e.forEach(e=>{const i=t.insertRow(),a=i.insertCell(0),n=this.normalizeCycleId(e.cycleId);if(n){const t=document.createElement("button");t.type="button",t.className="cycle-chip cycle-chip--link",t.textContent=n,t.title="Open All Trades filtered by this cycle",t.addEventListener("click",()=>{this.openTradesFilteredByCycle(n,e.ticker)}),a.appendChild(t)}else a.textContent="—";i.insertCell(1).textContent=e.typeLabel,i.insertCell(2).textContent=e.ticker||"—";const s=i.insertCell(3),o=document.createElement("span"),l="Closed"===e.status?"closed":"open";o.className=`status-badge ${l}`,o.textContent=e.status,s.appendChild(o),i.insertCell(4).textContent=e.trades.length;i.insertCell(5).textContent=this.formatCurrency(e.totalPremiums);const c=i.insertCell(6);c.textContent=this.formatCurrency(e.totalPL),e.totalPL>0?c.className="pl-positive":e.totalPL<0?c.className="pl-negative":c.className="pl-neutral";const d=i.insertCell(7);d.textContent=this.formatPercent(e.roiPercent),e.roiPercent>0?d.className="pl-positive":e.roiPercent<0?d.className="pl-negative":d.className="pl-neutral";const u=i.insertCell(8);Number.isFinite(e.costBasis)?u.textContent=this.formatCurrency(e.costBasis):(u.textContent="—",u.className="pl-neutral");const m=i.insertCell(9);if(e.keyMetricLabel&&Number.isFinite(e.keyMetricValue)){const t=document.createElement("div");if(t.className="cell-metric__label",t.textContent=`${e.keyMetricLabel}: ${this.formatCurrency(e.keyMetricValue)}`,m.appendChild(t),e.breakevenPrice&&Number.isFinite(e.breakevenPrice)){const t=document.createElement("div");t.className="cell-metric__subtext",t.textContent=`Breakeven: ${this.formatCurrency(e.breakevenPrice)}`,m.appendChild(t)}if("wheel"===e.cycleType&&e.assignments){const t=document.createElement("div");t.className="cell-metric__subtext",t.textContent=`Assignments: ${e.assignments}`,m.appendChild(t)}}else if(Number.isFinite(e.costBasis)){const t=document.createElement("div");if(t.className="cell-metric__label",t.textContent=`Cost Basis: ${this.formatCurrency(e.costBasis)}`,m.appendChild(t),e.breakevenPrice&&Number.isFinite(e.breakevenPrice)){const t=document.createElement("div");t.className="cell-metric__subtext",t.textContent=`Breakeven: ${this.formatCurrency(e.breakevenPrice)}`,m.appendChild(t)}if("wheel"===e.cycleType&&e.assignments){const t=document.createElement("div");t.className="cell-metric__subtext",t.textContent=`Assignments: ${e.assignments}`,m.appendChild(t)}}else"wheel"===e.cycleType&&e.assignments?m.textContent=`Assignments: ${e.assignments}`:m.textContent="—";i.insertCell(10).textContent=this.formatCycleDateRange(e.startDate,e.endDate,e.hasOpenTrade),this.applyResponsiveLabels(i,r)})}updateActivePositionsTable(e=this.trades.filter(e=>this.isActiveStatus(e.status))){const t=document.querySelector("#active-positions-table tbody");if(t){t.innerHTML="";const i=[...Array.isArray(e)?e:[]].sort((e,t)=>this.parseInteger(e.dte,Number.POSITIVE_INFINITY,{allowNegative:!1})-this.parseInteger(t.dte,Number.POSITIVE_INFINITY,{allowNegative:!1})),r=["Ticker","Strategy","Strike","Current Price","DTE","Max Risk","Notes"],a=new Map;i.forEach(e=>{const i=t.insertRow();i.dataset.tradeId=String(e.id??"");const n=i.insertCell(0),s=(e.ticker??"").toString().trim().toUpperCase(),o=this.createTickerElement(e.ticker,"ticker-pill",{behavior:"filter",onClick:e=>this.openTradesFilteredByTicker(e),title:s?`View all trades for ${s}`:""});n.appendChild(o),i.dataset.ticker=s,i.insertCell(1).textContent=e.strategy||"—";const l=i.insertCell(2);let c=this.parseDecimal(e.activeStrikePrice,null,{allowNegative:!1});if(null===c&&Array.isArray(e.legs)&&e.legs.length>0){const t=this.summarizeLegs(e.legs),i=this.getActiveStrikeForDisplay(t);Number.isFinite(i)&&(c=i)}if(null===c&&(c=this.parseDecimal(e.strikePrice,null,{allowNegative:!1})),Number.isFinite(c)){const e=this.formatNumber(c,{style:"currency",decimals:2});l.textContent=e??"—",i.dataset.strikePrice=String(c)}else l.textContent="—",delete i.dataset.strikePrice;const d=i.insertCell(3);d.className="quote-cell";const u=`${this.getQuoteEntryKey(e)}|row:${a.size}`;i.dataset.quoteKey=u,this.populateQuoteCell(d,e,i,{deferNetworkFetch:!0}),a.set(u,{trade:e,row:i,cell:d,key:u});const m=this.parseInteger(e.dte,null,{allowNegative:!1});i.insertCell(4).textContent=null!==m?m:"—",Number.isFinite(m)?i.dataset.dte=String(m):delete i.dataset.dte;const h=i.insertCell(5),p=this.parseDecimal(e.maxRisk,null,{allowNegative:!1});null!==p?(h.textContent=this.formatCurrency(p),h.className="pl-negative"):(h.textContent="—",h.className="pl-neutral");const g=i.insertCell(6),y=(e.notes||"").trim();g.textContent=y||"—",g.classList.add("notes-cell"),y&&(g.title=y),this.updateExpirationHighlight(i,e),this.applyResponsiveLabels(i,r)}),this.activeQuoteEntries=a,this.rebuildQuoteRefreshSchedule(),this.startQuoteAutoRefreshIfNeeded(),this.refreshActivePositionsQuotes({force:!0,immediate:!0})}}updateRecentTradesTable(e=this.trades.filter(e=>this.isClosedStatus(e.status)),t=this.trades.filter(e=>this.isActiveStatus(e.status)).length){const i=Number(t),r=Math.max(Number.isFinite(i)?i:0,10),a=[...Array.isArray(e)?e:[]].sort((e,t)=>new Date(t.exitDate)-new Date(e.exitDate)).slice(0,r),n=document.querySelector("#recent-trades-table tbody");if(n){n.innerHTML="";const e=["Ticker","Strategy","Exit Date","Days Held","P&L","ROI"];a.forEach(t=>{const i=n.insertRow(),r=i.insertCell(0),a=(t.ticker??"").toString().trim().toUpperCase(),s=this.createTickerElement(t.ticker,"ticker-pill",{behavior:"filter",onClick:e=>this.openTradesFilteredByTicker(e),title:a?`View all trades for ${a}`:""});r.appendChild(s),i.insertCell(1).textContent=t.strategy,i.insertCell(2).textContent=this.formatDate(t.exitDate);const o=i.insertCell(3),l=Number(t.daysHeld);o.textContent=Number.isFinite(l)?l:"—";const c=i.insertCell(4);c.textContent=this.formatCurrency(t.pl),c.className=t.pl>=0?"pl-positive":"pl-negative";const d=i.insertCell(5),u=Number(t.roi),m=this.formatPercent(u,"—");d.textContent=m,d.className="—"===m?"pl-neutral":u>=0?"pl-positive":"pl-negative",this.applyResponsiveLabels(i,e)})}}updateAllCharts(){this.updateMonthlyPLChart(),this.updateCumulativePLChart(),this.updateStrategyPerformanceChart(),this.updateWinRateByStrategyChart(),this.updatePerformanceGauges(),this.updateCommissionImpactChart(),this.updateTimeInTradeChart(),this.updateMonteCarloChart(),this.renderTickerHeatmap()}updatePerformanceGauges(){const e=this.latestStats;this.renderRatioGauge({chartKey:"sharpeGauge",canvasId:"sharpeGaugeChart",valueElementId:"sharpeGaugeValue",value:e?.sharpeRatio,min:-1,max:3}),this.renderRatioGauge({chartKey:"sortinoGauge",canvasId:"sortinoGaugeChart",valueElementId:"sortinoGaugeValue",value:e?.sortinoRatio,min:-1,max:4})}renderRatioGauge({chartKey:e,canvasId:t,valueElementId:i,value:r,min:a=0,max:n=1}){const s=document.getElementById(i);s&&(s.textContent=this.formatNumber(r,{decimals:2,useGrouping:!1})??"—");const o=document.getElementById(t);if(!o)return;if(!Number.isFinite(r))return void(this.charts[e]&&(this.charts[e].destroy(),delete this.charts[e]));const l=o.getContext("2d");if(!l)return;const c=(Math.min(Math.max(r,a),n)-a)/Math.max(n-a,1),d=Number.isFinite(c)?Math.max(Math.min(c,1),0):0,u=Math.max(1-d,0),m=r>=1.5?"#1FB8CD":r>=.75?"#FFC185":"#B4413C",h=this.formatNumber(r,{decimals:2,useGrouping:!1})??(Number.isFinite(r)?r.toFixed(2):"—");this.charts[e]&&this.charts[e].destroy(),this.charts[e]=new Chart(l,{type:"doughnut",data:{labels:["Ratio","Remaining"],datasets:[{data:[d,u],backgroundColor:[m,"rgba(148, 163, 184, 0.25)"],borderWidth:0}]},options:{responsive:!0,maintainAspectRatio:!1,rotation:-90,circumference:180,cutout:"70%",plugins:{legend:{display:!1},tooltip:{callbacks:{label:()=>`Ratio: ${h}`}}}}})}updateCommissionImpactChart(){const e=document.getElementById("commissionImpactChart"),t=document.getElementById("commissionImpactSummary"),i=this.latestStats;if(!e)return;if(!i)return t&&(t.textContent="No closed trades yet."),void(this.charts.commissionImpact&&(this.charts.commissionImpact.destroy(),delete this.charts.commissionImpact));const r=Number(i.totalFees)||0,a=Number(i.totalPL)||0,n=Number(i.feeShareOfGross)||0;if(t)if(0===r&&0===a)t.textContent="No closed trades yet.";else{const e=this.formatNumber(n,{decimals:1,useGrouping:!0})??"0.0";t.textContent=`${this.formatCurrency(r)} in fees (${e}% of realized turnover).`}const s=e.getContext("2d");if(!s)return;this.charts.commissionImpact&&this.charts.commissionImpact.destroy();const o=(e,t=2)=>this.formatCurrency(e,{decimals:t});this.charts.commissionImpact=new Chart(s,{type:"bar",data:{labels:["Net P&L","Fees"],datasets:[{label:"Amount",data:[a,r],backgroundColor:[a>=0?"#1FB8CD":"#B4413C","#B4413C"],borderRadius:8,borderSkipped:!1}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,scales:{x:{ticks:{callback:e=>o(e,0)},grid:{drawBorder:!1}},y:{grid:{display:!1}}},plugins:{legend:{display:!1},tooltip:{callbacks:{label:e=>`${e.label}: ${o(e.raw)}`}}}}})}renderTickerHeatmap(){const e=document.getElementById("tickerHeatmap");if(!e)return;e.innerHTML="";const t=this.latestStats,i=t?.tickerPerformance?.items||[];if(!i.length){const t=document.createElement("div");return t.className="heatmap-empty",t.textContent="Add more closed trades to see per-ticker performance.",void e.appendChild(t)}const r=t?.tickerPerformance?.maxMagnitude||1;i.slice(0,12).forEach(t=>{const i=document.createElement("div");i.className="heatmap-card";const a=t.totalPL>=0?[31,184,205]:[180,65,60],n=.15+.55*(r>0?Math.min(Math.abs(t.totalPL)/r,1):0),s=Math.min(n+.1,.9);i.style.backgroundColor=`rgba(${a[0]}, ${a[1]}, ${a[2]}, ${n.toFixed(2)})`,i.style.borderColor=`rgba(${a[0]}, ${a[1]}, ${a[2]}, ${s.toFixed(2)})`;const o=document.createElement("div");o.className="heatmap-card__ticker",o.textContent=t.ticker;const l=document.createElement("div");l.className="heatmap-card__pl "+(t.totalPL>=0?"pl-positive":"pl-negative"),l.textContent=this.formatCurrency(t.totalPL);const c=document.createElement("div");c.className="heatmap-card__meta";const d=this.formatNumber(t.tradeCount,{decimals:0,useGrouping:!0})??String(t.tradeCount??0),u=this.formatPercent(t.winRate,"0%",{decimals:0});c.textContent=`${d} trades • Win ${u}`,i.appendChild(o),i.appendChild(l),i.appendChild(c),e.appendChild(i)})}updateTimeInTradeChart(){const e=document.getElementById("timeInTradeChart"),t=this.latestStats;if(!e)return;if(!t||0===t.closedTrades||!Number.isFinite(t.avgWinnerDays)&&!Number.isFinite(t.avgLoserDays))return void(this.charts.timeInTrade&&(this.charts.timeInTrade.destroy(),delete this.charts.timeInTrade));const i=e.getContext("2d");if(!i)return;this.charts.timeInTrade&&this.charts.timeInTrade.destroy();const r=Number.isFinite(t.avgWinnerDays)?t.avgWinnerDays:0,a=Number.isFinite(t.avgLoserDays)?t.avgLoserDays:0,n=(e,t=1)=>{const i=Number(e);return Number.isFinite(i)?this.formatNumber(i,{decimals:t,useGrouping:!0})??i.toFixed(t):""};this.charts.timeInTrade=new Chart(i,{type:"bar",data:{labels:["Winners","Losers"],datasets:[{label:"Average Days Held",data:[r,a],backgroundColor:["#1FB8CD","#B4413C"],borderRadius:8,borderSkipped:!1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{callback:e=>{const t=n(e,0);return t?`${t}d`:`${e}d`}},grid:{drawBorder:!1}},x:{grid:{display:!1}}},plugins:{legend:{display:!1},tooltip:{callbacks:{label:e=>{const t=n(e.raw,1);return`${e.label}: ${t||e.raw} days`}}}}}})}updateMonteCarloChart(){const e=document.getElementById("monteCarloChart"),t=document.getElementById("monteCarloSummary"),i=this.latestStats;if(!e)return;if(!i||!Array.isArray(i.dailyReturns)||i.dailyReturns.length<2)return t&&(t.textContent="Need more closed trades to run projections."),void(this.charts.monteCarlo&&(this.charts.monteCarlo.destroy(),delete this.charts.monteCarlo));const r=this.generateMonteCarloProjection(i.dailyReturns,{periods:60,simulations:400});if(!r)return t&&(t.textContent="Need more closed trades to run projections."),void(this.charts.monteCarlo&&(this.charts.monteCarlo.destroy(),delete this.charts.monteCarlo));const a=e.getContext("2d");if(!a)return;this.charts.monteCarlo&&this.charts.monteCarlo.destroy();const n=r.percentiles.p50[r.percentiles.p50.length-1]||1;if(t){const e=100*(n-1),i=this.formatNumber(Math.abs(e),{decimals:1,useGrouping:!0})??Math.abs(e).toFixed(1),r=e>=0?"+":"-";t.textContent=`Median path suggests ${r}${i}% over 60 trading days.`}const s=e=>{const t=100*(Number(e)-1);return`${t>=0?"+":"-"}${this.formatNumber(Math.abs(t),{decimals:1,useGrouping:!0})??Math.abs(t).toFixed(1)}%`};this.charts.monteCarlo=new Chart(a,{type:"line",data:{labels:r.labels,datasets:[{label:"10th percentile",data:r.percentiles.p10,borderColor:"rgba(180, 65, 60, 0.6)",backgroundColor:"rgba(180, 65, 60, 0.12)",borderWidth:1.5,fill:!1,tension:.25},{label:"90th percentile",data:r.percentiles.p90,borderColor:"rgba(31, 184, 205, 0.6)",backgroundColor:"rgba(31, 184, 205, 0.12)",borderWidth:1.5,fill:"-1",tension:.25},{label:"Median",data:r.percentiles.p50,borderColor:"#1FB8CD",borderWidth:2,tension:.25,fill:!1}]},options:{responsive:!0,maintainAspectRatio:!1,interaction:{intersect:!1,mode:"index"},scales:{y:{ticks:{callback:e=>s(e)},grid:{drawBorder:!1}},x:{grid:{display:!1},ticks:{maxTicksLimit:12}}},plugins:{legend:{position:"bottom"},tooltip:{callbacks:{label:e=>`${e.dataset.label}: ${s(e.parsed.y)}`}}}}})}generateMonteCarloProjection(e=[],{periods:t=60,simulations:i=400}={}){if(!Array.isArray(e)||0===e.length)return null;const r=e.filter(e=>Number.isFinite(e));if(!r.length)return null;const a=Array.from({length:t},()=>[]);for(let e=0;e<i;e+=1){let e=1;for(let i=0;i<t;i+=1){let t=r[Math.floor(Math.random()*r.length)];Number.isFinite(t)||(t=0),t=Math.max(-.95,Math.min(t,5)),e*=1+t,e=Math.max(e,0),a[i].push(Number(e.toFixed(6)))}}const n=[.1,.25,.5,.75,.9],s=n.map(()=>[]);return a.forEach(e=>{if(!e.length)return void n.forEach((e,t)=>s[t].push(1));const t=e.slice().sort((e,t)=>e-t);n.forEach((e,i)=>{const r=(t.length-1)*e,a=Math.floor(r),n=Math.ceil(r);if(a===n)return void s[i].push(t[a]);const o=t[a],l=o+(t[n]-o)*(r-a);s[i].push(Number(l.toFixed(6)))})}),{labels:Array.from({length:t},(e,t)=>`Day ${t+1}`),percentiles:{p10:s[0],p25:s[1],p50:s[2],p75:s[3],p90:s[4]}}}initializeGeminiControls(){const e=document.getElementById("gemini-controls");if(!e)return;const t=document.getElementById("gemini-api-key"),i=document.getElementById("gemini-model"),r=document.getElementById("gemini-save"),a=document.getElementById("gemini-clear"),n=document.getElementById("gemini-status");if(this.gemini.elements={container:e,keyInput:t,modelSelect:i,saveButton:r,clearButton:a,status:n},this.syncGeminiControlsFromState({preserveStatus:Boolean(this.gemini.pendingStatus)}),GEMINI_ALLOWED_MODELS.includes(this.gemini.model)||(this.gemini.model="gemini-2.5-flash"),i){0===Array.from(i.options).map(e=>e.value).length&&GEMINI_ALLOWED_MODELS.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e.replace(/gemini-2\.5-/,"Gemini 2.5 ").replace(/-/g," ").replace(/\b([a-z])/g,(e,t)=>t.toUpperCase()),i.appendChild(t)}),i.value=GEMINI_ALLOWED_MODELS.includes(this.gemini.model)?this.gemini.model:"gemini-2.5-flash",this.setGeminiModel(i.value),i.addEventListener("change",()=>{this.setGeminiModel(i.value),this.saveGeminiConfigToStorage()})}const s=async()=>{const e=(t?.value||"").trim();this.setGeminiApiKey(e,{persist:!1,updateUI:!1});const i=this.gemini.apiKey,r=this.getCrypto();if(!e)return this.removeGeminiEncryptionKey(),this.saveGeminiConfigToStorage(),t&&(t.value=""),this.updateGeminiStatus("API key cleared. Connect your Gemini key via Settings to get tailored analysis.","neutral",6e3),this.initializeAIChat(),void this.updateAIChatHeader();if(!r?.subtle)return this.saveGeminiConfigToStorage({includeApiKey:!0}),this.updateGeminiStatus("Gemini API key saved (unencrypted — Web Crypto unavailable).","success",6e3),t&&(t.value=i),this.initializeAIChat(),void this.updateAIChatHeader();await this.encryptAndStoreGeminiApiKey(r)?this.updateGeminiStatus("Gemini API key saved securely.","success",5e3):(this.saveGeminiConfigToStorage({includeApiKey:!0}),this.updateGeminiStatus("Gemini API key saved (unencrypted fallback).","neutral",6e3)),t&&(t.value=i),this.initializeAIChat(),this.updateAIChatHeader()};r?.addEventListener("click",async e=>{e.preventDefault(),await s()}),t?.addEventListener("keydown",async e=>{"Enter"===e.key&&(e.preventDefault(),await s())}),a?.addEventListener("click",e=>{e.preventDefault(),t&&(t.value=""),this.setGeminiApiKey("",{persist:!1,updateUI:!1}),this.removeGeminiEncryptionKey(),this.saveGeminiConfigToStorage(),this.updateGeminiStatus("API key cleared. Connect your Gemini key via Settings to get tailored analysis.","neutral",6e3),this.initializeAIChat(),this.updateAIChatHeader()}),this.updateAIChatHeader(),this.flushPendingGeminiStatus()}syncGeminiControlsFromState({preserveStatus:e=!0}={}){const t=this.gemini?.elements?.keyInput,i=this.gemini?.apiKey?this.gemini.apiKey:"";t&&t.value!==i&&(t.value=i);const r=Boolean(i),a=!e&&!this.gemini?.pendingStatus,n=e&&!this.gemini?.lastStatus&&!this.gemini?.pendingStatus;if((a||n)&&this.updateGeminiStatus){const e=r?"API key loaded":"Not set",t=r?"success":"neutral";this.updateGeminiStatus(e,t)}this.updateAIChatHeader()}flushPendingGeminiStatus(){const e=this.gemini?.pendingStatus;e&&(this.updateGeminiStatus(e.message,e.variant,e.autoClearMs),this.gemini.pendingStatus=null)}getGeminiModelLabel(e=""){const t=(e||"").toLowerCase(),i={"gemini-2.5-flash-lite":"Gemini 2.5 Flash Lite","gemini-2.5-flash":"Gemini 2.5 Flash","gemini-2.5-pro":"Gemini 2.5 Pro"};if(i[t])return i[t];if(!t)return"";return t.replace(/^gemini[-\s]?/i,"Gemini ").replace(/-/g," ").replace(/\b([a-z])/g,(e,t)=>t.toUpperCase()).trim()||"Gemini"}getGeminiChatDisplayName(){const e=this.getGeminiModelLabel(this.gemini?.model);return e||"Gemini"}updateAIChatHeader(){const e=document.getElementById("ai-chat-title"),t=document.getElementById("ai-chat-subtitle");if(!e&&!t)return;if(e&&(e.textContent="Portfolio AI Coach"),!t)return;const i=Boolean(this.gemini?.apiKey),r=this.hasAICoachConsent();i?t.textContent=r?"Ask about your portfolio for AI-guided insights.":"Review and accept the AI Coach data-sharing notice to start asking questions.":t.innerHTML='Connect your Gemini API key in <a href="#settings" class="ai-chat__settings-link">Settings</a> to get tailored analysis.'}updateGeminiStatus(e,t="neutral",i=0){const r=this.gemini?.elements?.status;if(!r||!e)return;const a=["success","error","neutral"].includes(t)?t:"neutral";r.textContent=e,r.classList.remove("is-success","is-error"),"success"===a?r.classList.add("is-success"):"error"===a&&r.classList.add("is-error"),this.gemini.statusTimeoutId&&clearTimeout(this.gemini.statusTimeoutId),this.gemini.lastStatus={message:e,variant:a},this.gemini.pendingStatus=null,i>0&&(this.gemini.statusTimeoutId=setTimeout(()=>{r.isConnected&&(r.textContent="neutral"===a?"Not set":"",r.classList.remove("is-success","is-error"))},i))}setGeminiApiKey(e,{persist:t=!1,updateUI:i=!0}={}){const r=(e||"").trim();r!==this.gemini.apiKey&&(this.gemini.apiKey=r,i&&this.gemini.elements?.keyInput&&(this.gemini.elements.keyInput.value=r),t&&this.saveGeminiConfigToStorage({includeApiKey:!0}))}setGeminiModel(e){const t=(e||"").trim(),i=GEMINI_ALLOWED_MODELS.includes(t)?t:"gemini-2.5-flash",r=this.gemini.model;this.gemini.model=i;const a=this.gemini.elements?.modelSelect;a&&a.value!==this.gemini.model&&(a.value=this.gemini.model),this.gemini.model!==r&&(this.updateAIChatHeader(),this.renderAIChatMessages())}async loadGeminiConfigFromStorage(){let e="",t=null;try{const i=localStorage.getItem(GEMINI_STORAGE_KEY);if(!i)return this.setGeminiApiKey("",{persist:!1,updateUI:!1}),this.gemini.pendingStatus=null,this.syncGeminiControlsFromState({preserveStatus:!0}),!1;const r=JSON.parse(i);if(!r||"object"!=typeof r)return this.setGeminiApiKey("",{persist:!1,updateUI:!1}),this.gemini.pendingStatus=null,this.syncGeminiControlsFromState({preserveStatus:!0}),!1;if("string"==typeof r.model&&r.model.trim()&&this.setGeminiModel(r.model.trim()),r.enc&&r.payload){const i=this.getCrypto();if(i?.subtle)try{const t=await this.ensureGeminiEncryptionKey(i);if(!t)throw new Error("Encryption key unavailable");const a=await this.decryptString(r.payload,i,t);"string"==typeof a&&(e=a.trim())}catch(e){console.warn("Failed to decrypt stored Gemini API key:",e),t={message:"Failed to decrypt stored Gemini API key. Please re-enter it in Settings.",variant:"error",autoClearMs:9e3}}else console.warn("Encrypted Gemini API key stored but Web Crypto unavailable."),t={message:"Stored Gemini API key is encrypted, but this browser cannot decrypt it. Please re-enter it in Settings.",variant:"error",autoClearMs:9e3}}if(e||"string"!=typeof r.apiKey||(e=r.apiKey.trim()),!e&&"string"==typeof r.fallback&&r.fallback.trim())try{e=atob(r.fallback.trim()).trim()}catch(e){console.warn("Failed to decode Gemini API key fallback:",e)}e&&t&&(t={message:"Gemini API key loaded from local backup. Save it again to refresh secure storage when possible.",variant:"neutral",autoClearMs:9e3})}catch(e){console.warn("Failed to load Gemini configuration:",e),t||(t={message:"Failed to load Gemini configuration. Please verify your stored Gemini API key.",variant:"error",autoClearMs:9e3})}return this.setGeminiApiKey(e,{persist:!1,updateUI:!1}),this.gemini.pendingStatus=t,this.syncGeminiControlsFromState({preserveStatus:Boolean(t)}),Boolean(e)}saveGeminiConfigToStorage({includeApiKey:e=!1,encryptedPayload:t=null}={}){try{const i={model:this.gemini.model};if(t){if(i.enc=!0,i.payload=t,this.gemini.apiKey)try{i.fallback=btoa(this.gemini.apiKey)}catch(e){}}else e&&this.gemini.apiKey&&(i.apiKey=this.gemini.apiKey);localStorage.setItem(GEMINI_STORAGE_KEY,JSON.stringify(i))}catch(e){console.warn("Failed to save Gemini configuration:",e)}}removeGeminiEncryptionKey(){try{localStorage.removeItem("GammaLedgerGeminiSecret"),this.gemini.encryptionKey=null}catch(e){console.warn("Failed to remove Gemini encryption key:",e)}}async ensureGeminiEncryptionKey(e=this.getCrypto()){if(!e?.subtle)return null;if(this.gemini.encryptionKey)return this.gemini.encryptionKey;let t=localStorage.getItem("GammaLedgerGeminiSecret");if(!t){const i=e.getRandomValues(new Uint8Array(32));t=this.arrayBufferToBase64(i.buffer),localStorage.setItem("GammaLedgerGeminiSecret",t)}const i=new Uint8Array(this.base64ToArrayBuffer(t)),r=await e.subtle.importKey("raw",i,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"]);return this.gemini.encryptionKey=r,r}async encryptAndStoreGeminiApiKey(e=this.getCrypto()){try{if(!e?.subtle)throw new Error("Web Crypto API unavailable");const t=this.gemini.apiKey||"";if(!t)return this.saveGeminiConfigToStorage(),!0;const i=await this.ensureGeminiEncryptionKey(e);if(!i)throw new Error("Failed to prepare encryption key");const r=await this.encryptString(t,e,i);return this.saveGeminiConfigToStorage({encryptedPayload:r}),!0}catch(e){return console.warn("Failed to encrypt Gemini API key:",e),!1}}initializeFinnhubControls(){const e=document.getElementById("finnhub-controls");if(!e)return;const t=document.getElementById("finnhub-api-key"),i=document.getElementById("finnhub-save"),r=document.getElementById("finnhub-status");if(this.finnhub.elements={container:e,input:t,saveButton:i,status:r},t&&(t.value=this.finnhub.apiKey),r){const e=this.finnhub.apiKey?"success":"neutral",t=this.finnhub.apiKey?"API key loaded":"Not set";this.updateFinnhubStatus(t,e,4e3)}const a=async()=>{const e=(t?.value||"").trim();this.setFinnhubApiKey(e,{persist:!1,updateUI:!0,markUnsaved:!1});const i=this.getCrypto();if(!e)return this.removeFinnhubConfigFromStorage(),this.updateFinnhubStatus("API key cleared. Live prices disabled.","neutral",5e3),void this.updateActivePositionsTable();if(!i?.subtle)return this.saveFinnhubConfigToStorage(),this.updateFinnhubStatus("Finnhub API key saved (unencrypted — Web Crypto unavailable).","success",6e3),void this.updateActivePositionsTable();await this.encryptAndStoreFinnhubApiKey(i)?this.updateFinnhubStatus("Finnhub API key saved securely.","success",5e3):(this.saveFinnhubConfigToStorage(),this.updateFinnhubStatus("Finnhub API key saved (unencrypted fallback).","neutral",6e3)),this.updateActivePositionsTable()};i?.addEventListener("click",async e=>{e.preventDefault(),await a()}),t?.addEventListener("keydown",async e=>{"Enter"===e.key&&(e.preventDefault(),await a())})}initializeDisclaimerBanner(){const e=document.getElementById("disclaimer-banner");if(!e)return;this.disclaimerBanner.agreeButton&&this.disclaimerBanner.agreeHandler&&this.disclaimerBanner.agreeButton.removeEventListener("click",this.disclaimerBanner.agreeHandler);const t=e.querySelector('[data-action="disclaimer-agree"]'),i=e.querySelector(".disclaimer-banner__body");this.disclaimerBanner.element=e,this.disclaimerBanner.body=i,this.disclaimerBanner.agreeButton=t;const r=()=>this.acceptDisclaimer();this.disclaimerBanner.agreeHandler=r,t&&t.addEventListener("click",r);this.getDisclaimerAcceptance()?this.hideDisclaimerBanner({immediate:!0}):this.showDisclaimerBanner()}showDisclaimerBanner(){const e=this.disclaimerBanner?.element;e&&(this.disclaimerBanner.hideTimeoutId&&(clearTimeout(this.disclaimerBanner.hideTimeoutId),this.disclaimerBanner.hideTimeoutId=null),e.classList.remove("is-hidden"),requestAnimationFrame(()=>{e.classList.add("is-visible"),e.setAttribute("aria-hidden","false");const t=this.disclaimerBanner?.body;if(t&&"function"==typeof t.focus)try{t.focus({preventScroll:!0})}catch(e){t.focus()}}))}hideDisclaimerBanner({immediate:e=!1}={}){const t=this.disclaimerBanner?.element;if(t){if(this.disclaimerBanner.hideTimeoutId&&(clearTimeout(this.disclaimerBanner.hideTimeoutId),this.disclaimerBanner.hideTimeoutId=null),e)return t.classList.remove("is-visible"),t.classList.add("is-hidden"),void t.setAttribute("aria-hidden","true");t.classList.remove("is-visible"),t.setAttribute("aria-hidden","true"),this.disclaimerBanner.hideTimeoutId=setTimeout(()=>{t.classList.add("is-hidden"),this.disclaimerBanner.hideTimeoutId=null},this.disclaimerFadeMs)}}acceptDisclaimer(){this.setDisclaimerAcceptance((new Date).toISOString()),this.hideDisclaimerBanner()}getDisclaimerAcceptance(){try{return localStorage.getItem(DISCLAIMER_STORAGE_KEY)||null}catch(e){return console.warn("Failed to read disclaimer acceptance from storage:",e),null}}setDisclaimerAcceptance(e){try{if(!e)return void localStorage.removeItem(DISCLAIMER_STORAGE_KEY);localStorage.setItem(DISCLAIMER_STORAGE_KEY,e)}catch(e){console.warn("Failed to persist disclaimer acceptance:",e)}}initializeAICoachConsent(){const e=this.aiCoachConsent,t=document.getElementById("ai-coach-consent");if(!t)return;e.element=t,e.panel=t.querySelector(".ai-consent-modal__panel")||t;const i=t.querySelector('[data-action="ai-consent-agree"]');e.agreeButton&&e.agreeHandler&&e.agreeButton.removeEventListener("click",e.agreeHandler),e.agreeButton=i;const r=()=>this.acceptAICoachConsent();e.agreeHandler=r,i&&i.addEventListener("click",r),e.dismissButtons.forEach((t,i)=>{const r=e.dismissHandlers[i];t&&r&&t.removeEventListener("click",r)});const a=Array.from(t.querySelectorAll('[data-action="ai-consent-dismiss"]'));e.dismissButtons=a,e.dismissHandlers=a.map(e=>{const t=e=>{e.preventDefault(),this.cancelAICoachConsent()};return e.addEventListener("click",t),t}),e.escapeHandler&&t.removeEventListener("keydown",e.escapeHandler);const n=e=>{"Escape"===e.key&&(e.preventDefault(),this.cancelAICoachConsent())};e.escapeHandler=n,t.addEventListener("keydown",n),t.setAttribute("aria-hidden","true"),t.classList.contains("is-hidden")||t.classList.add("is-hidden"),this.updateAIChatHeader()}showAICoachConsent(){const e=this.aiCoachConsent,{element:t,panel:i}=e;t&&(e.restoreFocus=document.activeElement instanceof HTMLElement?document.activeElement:null,t.classList.remove("is-hidden"),requestAnimationFrame(()=>{if(t.classList.add("is-visible"),t.setAttribute("aria-hidden","false"),e.isVisible=!0,i&&"function"==typeof i.focus){i.setAttribute("tabindex","-1");try{i.focus({preventScroll:!0})}catch(e){i.focus()}}}))}hideAICoachConsent({immediate:e=!1}={}){const t=this.aiCoachConsent,{element:i}=t;if(!i)return;const r=()=>{i.classList.add("is-hidden"),i.setAttribute("aria-hidden","true"),t.isVisible=!1;const e=t.restoreFocus;if(t.restoreFocus=null,e&&"function"==typeof e.focus)try{e.focus({preventScroll:!0})}catch(t){e.focus()}};if(e)return i.classList.remove("is-visible"),void r();i.classList.remove("is-visible"),i.setAttribute("aria-hidden","true"),t.isVisible=!1,setTimeout(()=>{i.classList.contains("is-visible")||r()},220)}promptAICoachConsent(e=null){if(this.aiCoachConsent.element||this.initializeAICoachConsent(),this.hasAICoachConsent()){if("function"==typeof e)try{e()}catch(e){console.error("AI Coach consent follow-up failed:",e)}return!0}return this.aiCoachConsent.pendingAction="function"==typeof e?e:null,this.showAICoachConsent(),!1}acceptAICoachConsent(){this.setAICoachConsent((new Date).toISOString());const e=this.aiCoachConsent.pendingAction;if(this.aiCoachConsent.pendingAction=null,this.hideAICoachConsent(),this.updateAIChatHeader(),"function"==typeof e)try{e()}catch(e){console.error("AI Coach consent follow-up failed:",e)}}cancelAICoachConsent(){this.aiCoachConsent.pendingAction=null,this.hideAICoachConsent(),this.updateAIChatHeader()}hasAICoachConsent(){return Boolean(this.getAICoachConsent())}getAICoachConsent(){try{return localStorage.getItem(AI_COACH_CONSENT_STORAGE_KEY)||null}catch(e){return console.warn("Failed to read AI Coach consent from storage:",e),null}}setAICoachConsent(e){try{if(!e)return void localStorage.removeItem(AI_COACH_CONSENT_STORAGE_KEY);localStorage.setItem(AI_COACH_CONSENT_STORAGE_KEY,e)}catch(e){console.warn("Failed to persist AI Coach consent:",e)}}initializeSidebarToggle(){const e=document.querySelector(".app-container"),t=document.querySelector(".sidebar"),i=document.getElementById("sidebar-toggle"),r=document.querySelector(".main-content");if(!e||!t||!i)return;this.sidebarState.container=e,this.sidebarState.sidebar=t,this.sidebarState.toggleButton=i,this.sidebarState.mainContent=r||null,"function"==typeof window.matchMedia?this.sidebarState.mediaQuery=window.matchMedia("(max-width: 768px)"):this.sidebarState.mediaQuery=null;const a=({animate:e=!0}={})=>{const t=this.getSidebarCollapsedPreference();this.setSidebarCollapsed(t,{persist:!1,animate:e})};i.addEventListener("click",()=>{const e=!this.sidebarState.preferredCollapsed;this.setSidebarCollapsed(e)});const n=this.sidebarState.mediaQuery;if(n){const e=()=>{a({animate:!0})};"function"==typeof n.addEventListener?n.addEventListener("change",e):"function"==typeof n.addListener&&n.addListener(e)}a({animate:!1})}getSidebarCollapsedPreference(){try{return"true"===localStorage.getItem("GammaLedgerSidebarCollapsed")}catch(e){return console.warn("Failed to read sidebar preference from storage:",e),!1}}setSidebarCollapsedPreference(e){try{localStorage.setItem("GammaLedgerSidebarCollapsed",String(Boolean(e)))}catch(e){console.warn("Failed to persist sidebar preference:",e)}}setSidebarCollapsed(e,{persist:t=!0,animate:i=!0}={}){const r=this.sidebarState,a=r?.container,n=r?.sidebar,s=r?.toggleButton,o=r?.mainContent;if(!a||!n||!s)return;const l=Boolean(e),c=!(r.mediaQuery?.matches??window.innerWidth<=768)&&l;r.preferredCollapsed=l,r.collapsed=c;const d=[a,n,o].filter(Boolean),u=e=>{d.forEach(t=>{t&&(e?t.classList.remove("no-transition"):t.classList.add("no-transition"))})};i||u(!1),a.classList.toggle("is-sidebar-collapsed",c),n.classList.toggle("is-collapsed",c),i||requestAnimationFrame(()=>u(!0));const m=(!c).toString(),h=c?"Expand navigation":"Collapse navigation";s.setAttribute("aria-expanded",m),s.setAttribute("aria-label",h),s.setAttribute("title",h),t&&this.setSidebarCollapsedPreference(l)}initializeShareCard(){const e=document.getElementById("share-portfolio-card"),t=document.getElementById("share-card-root"),i=t?.querySelector(".share-card"),r=document.getElementById("share-card-cumulative-chart");e&&t&&i&&r&&"true"!==e.dataset.initialized&&(this.shareCard.button=e,this.shareCard.root=t,this.shareCard.card=i,this.shareCard.chartCanvas=r,this.shareCard.metrics={totalPL:document.getElementById("share-card-total-pl"),winRate:document.getElementById("share-card-win-rate"),profitFactor:document.getElementById("share-card-profit-factor"),totalROI:document.getElementById("share-card-total-roi")},this.shareCard.timestamp=document.getElementById("share-card-date"),e.dataset.initialized="true",e.addEventListener("click",async e=>{e.preventDefault(),await this.downloadShareCard()}),this.latestStats&&this.updateShareCard(this.latestStats))}computeCumulativePLSeries(){const e=this.trades.filter(e=>this.isClosedStatus(e.status)&&e.exitDate);if(0===e.length)return null;const t=new Map;let i=null,r=null;if(e.forEach(e=>{const a=this.getWeekEndingFriday(e.exitDate);if(!a)return;const n=this.getWeekKey(a);t.set(n,(t.get(n)||0)+e.pl),(!i||a<i)&&(i=new Date(a)),(!r||a>r)&&(r=new Date(a))}),!i||!r)return null;i.setHours(0,0,0,0),r.setHours(0,0,0,0);const a=[],n=[];let s=0;const o=new Date(i);for(;o.getTime()<=r.getTime();){const e=this.getWeekKey(o);s+=t.get(e)||0,a.push(this.formatWeekLabel(o)),n.push(s),o.setDate(o.getDate()+7)}return{labels:a,dataPoints:n}}updateShareCard(e){if(!this.shareCard?.card)return;const t=this.shareCard.metrics||{},i=e||this.latestStats||this.calculateAdvancedStats(),r=(e,t=2)=>{const i=Number(e);if(!Number.isFinite(i))return"Infinite";const r=this.formatNumber(i,{decimals:t,useGrouping:!0});return r?`${r}%`:`${i.toFixed(t)}%`};if(t.totalPL&&(t.totalPL.textContent=this.formatCurrency(i.totalPL||0)),t.winRate&&(t.winRate.textContent=r(i.winRate,1)),t.profitFactor){const e=Number(i.profitFactor);t.profitFactor.textContent=Number.isFinite(e)?e.toFixed(2):"Infinite"}if(t.totalROI&&(t.totalROI.textContent=r(i.totalROI,2)),this.shareCard.timestamp){const e=new Date;this.shareCard.timestamp.textContent=e.toLocaleString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"2-digit",minute:"2-digit"})}}refreshShareCardChart(){if(!this.shareCard?.chartCanvas)return;const e=this.shareCard.chartCanvas.getContext("2d");if(!e)return;const t=Number(this.shareCard?.exportSize)||1080,i=this.shareCard.card?.clientWidth||t,r="true"===this.shareCard.card?.dataset.exportMode,a=r?t:i,n=Math.round(Math.max(320,.78*a)),s=Math.round(Math.max(320,.42*a));this.shareCard.chartCanvas.width=n,this.shareCard.chartCanvas.height=s,r?this.shareCard.chartCanvas.style.setProperty("min-height",`${s}px`):this.shareCard.chartCanvas.style.removeProperty("min-height"),this.shareCard.chart&&(this.shareCard.chart.destroy(),this.shareCard.chart=null);const o=this.computeCumulativePLSeries(),l=Boolean(o?.labels?.length&&o?.dataPoints?.length),c=l?o.labels:["No Data"],d=l?o.dataPoints:[0],u=e.createLinearGradient(0,0,0,s);u.addColorStop(0,"rgba(79, 195, 247, 0.38)"),u.addColorStop(1,"rgba(79, 195, 247, 0.05)");const m=(e,t=2)=>this.formatCurrency(e,{decimals:t});this.shareCard.chart=new Chart(e,{type:"line",data:{labels:c,datasets:[{label:"Cumulative P&L",data:d,borderColor:"#4FC3F7",backgroundColor:u,fill:!0,tension:.35,pointRadius:l?3:0,pointHoverRadius:l?5:0,borderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!1,animation:!1,scales:{x:{grid:{display:!1},ticks:{color:"rgba(255, 255, 255, 0.58)",maxRotation:0,minRotation:0,font:{size:12}}},y:{grid:{color:"rgba(255, 255, 255, 0.08)"},ticks:{color:"rgba(255, 255, 255, 0.58)",callback:e=>m(e,0),font:{size:12}}}},plugins:{legend:{display:!1},tooltip:{callbacks:{label:e=>`Cumulative P&L: ${m(e.raw)}`}}}}})}async downloadShareCard(){const e=this.shareCard?.button,t=this.shareCard?.root,i=this.shareCard?.card;if(!e||!t||!i)return void this.showNotification("Sharing is unavailable right now.","error");if("function"!=typeof window.html2canvas)return void this.showNotification("Image export library failed to load. Please refresh and try again.","error");const r=Number(this.shareCard?.exportSize)||1080,a=e.disabled;e.disabled=!0,e.setAttribute("aria-busy","true"),e.blur();const n=i.dataset.exportMode,s=i.style.width,o=i.style.height,l=i.style.maxWidth,c=i.style.maxHeight;i.dataset.exportMode="true",i.style.width=`${r}px`,i.style.height=`${r}px`,i.style.maxWidth=`${r}px`,i.style.maxHeight=`${r}px`,this.updateShareCard(this.latestStats),t.classList.add("is-active"),t.setAttribute("aria-hidden","false"),await new Promise(e=>{requestAnimationFrame(()=>{this.refreshShareCardChart(),setTimeout(e,180)})});let d=null;try{const e=Math.max(2,Math.min(3,window.devicePixelRatio||2));d=await window.html2canvas(i,{width:r,height:r,scale:e,useCORS:!0,logging:!1,backgroundColor:"#050b1a"})}catch(e){console.error("Failed to capture share card:",e),this.showNotification("Unable to prepare the share card image. Please try again.","error")}if(t.classList.remove("is-active"),t.setAttribute("aria-hidden","true"),e.removeAttribute("aria-busy"),e.disabled=a,n?i.dataset.exportMode=n:delete i.dataset.exportMode,i.style.width=s,i.style.height=o,i.style.maxWidth=l,i.style.maxHeight=c,this.shareCard.chart&&(this.shareCard.chart.destroy(),this.shareCard.chart=null),this.shareCard.chartCanvas&&this.shareCard.chartCanvas.style.removeProperty("min-height"),d)try{const e=d.toDataURL("image/png"),t=new Date,i=[t.getFullYear(),String(t.getMonth()+1).padStart(2,"0"),String(t.getDate()).padStart(2,"0")].join(""),r=document.createElement("a");r.href=e,r.download=`gammaledger-portfolio-${i}.png`,document.body.appendChild(r),r.click(),document.body.removeChild(r),this.showNotification("Portfolio snapshot saved as an image.","success")}catch(e){console.error("Failed to download image:",e),this.showNotification("Image download failed. Please try again.","error")}}updateFinnhubStatus(e,t="neutral",i=0){const r=this.finnhub?.elements?.status;if(!r||!e)return;const a=["success","error","neutral"].includes(t)?t:"neutral";r.textContent=e,r.classList.remove("is-success","is-error"),"success"===a?r.classList.add("is-success"):"error"===a&&r.classList.add("is-error"),this.finnhub.statusTimeoutId&&clearTimeout(this.finnhub.statusTimeoutId),this.finnhub.lastStatus={message:e,variant:a},i>0&&(this.finnhub.statusTimeoutId=setTimeout(()=>{r.isConnected&&(r.textContent="neutral"===a?"Not set":"",r.classList.remove("is-success","is-error"))},i))}setFinnhubApiKey(e,{persist:t=!1,updateUI:i=!0,markUnsaved:r=!1}={}){const a=(e||"").trim();a!==this.finnhub.apiKey&&(this.finnhub.apiKey=a,this.finnhub.cache.clear(),this.finnhub.outstandingRequests.clear(),i&&this.finnhub.elements?.input&&(this.finnhub.elements.input.value=a),t&&this.saveFinnhubConfigToStorage(),r&&this.markUnsavedChanges())}getFinnhubStorageKey(){return"GammaLedgerFinnhubConfig"}async loadFinnhubConfigFromStorage(){try{const e=localStorage.getItem(this.getFinnhubStorageKey());if(!e)return;const t=JSON.parse(e);if(!t)return;if(t.enc&&t.payload){const e=this.getCrypto();if(!e?.subtle)return console.warn("Encrypted Finnhub API key stored but Web Crypto unavailable."),void this.updateFinnhubStatus("Stored Finnhub key is encrypted, but this browser cannot decrypt it.","error",7e3);try{const i=await this.ensureFinnhubEncryptionKey(e);if(!i)throw new Error("Encryption key unavailable");const r=await this.decryptString(t.payload,e,i);r&&(this.finnhub.apiKey=r)}catch(e){console.warn("Failed to decrypt stored Finnhub API key:",e),this.updateFinnhubStatus("Failed to decrypt stored Finnhub API key.","error",6e3)}return}"string"==typeof t.apiKey&&(this.finnhub.apiKey=t.apiKey)}catch(e){console.warn("Failed to load Finnhub configuration:",e)}}saveFinnhubConfigToStorage(){try{const e={apiKey:this.finnhub.apiKey};localStorage.setItem(this.getFinnhubStorageKey(),JSON.stringify(e))}catch(e){console.warn("Failed to save Finnhub configuration:",e)}}removeFinnhubConfigFromStorage(){try{localStorage.removeItem(this.getFinnhubStorageKey())}catch(e){console.warn("Failed to remove Finnhub configuration:",e)}}arrayBufferToBase64(e){const t=new Uint8Array(e);let i="";for(let e=0;e<t.byteLength;e++)i+=String.fromCharCode(t[e]);return btoa(i)}base64ToArrayBuffer(e){const t=atob(e),i=t.length,r=new Uint8Array(i);for(let e=0;e<i;e++)r[e]=t.charCodeAt(e);return r.buffer}getFinnhubSecretStorageKey(){return"GammaLedgerFinnhubSecret"}async ensureFinnhubEncryptionKey(e=this.getCrypto()){if(!e?.subtle)return null;if(this.finnhub.encryptionKey)return this.finnhub.encryptionKey;let t=localStorage.getItem(this.getFinnhubSecretStorageKey());if(!t){const i=e.getRandomValues(new Uint8Array(32));t=this.arrayBufferToBase64(i.buffer),localStorage.setItem(this.getFinnhubSecretStorageKey(),t)}const i=new Uint8Array(this.base64ToArrayBuffer(t)),r=await e.subtle.importKey("raw",i,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"]);return this.finnhub.encryptionKey=r,r}async encryptString(e,t,i){const r=t.getRandomValues(new Uint8Array(12)),a=new TextEncoder,n=await t.subtle.encrypt({name:"AES-GCM",iv:r},i,a.encode(e));return{iv:this.arrayBufferToBase64(r.buffer),ct:this.arrayBufferToBase64(n)}}getCrypto(){return"undefined"!=typeof globalThis&&globalThis.crypto?globalThis.crypto:"undefined"!=typeof window&&window.crypto?window.crypto:null}async decryptString(e,t,i){const r=new Uint8Array(this.base64ToArrayBuffer(e.iv)),a=this.base64ToArrayBuffer(e.ct),n=await t.subtle.decrypt({name:"AES-GCM",iv:r},i,a);return(new TextDecoder).decode(n)}async encryptAndStoreFinnhubApiKey(e=this.getCrypto()){try{if(!e?.subtle)throw new Error("Web Crypto API unavailable");const t=this.finnhub.apiKey||"";if(!t)return this.removeFinnhubConfigFromStorage(),!0;const i=await this.ensureFinnhubEncryptionKey(e);if(!i)throw new Error("Failed to prepare encryption key");const r=await this.encryptString(t,e,i);return localStorage.setItem(this.getFinnhubStorageKey(),JSON.stringify({enc:!0,payload:r})),!0}catch(e){return console.warn("Failed to encrypt Finnhub API key:",e),!1}}getQuoteEntryKey(e){if(!e||"object"!=typeof e)return"unknown";const t=e.id??e.tradeId??e.uid??e.uniqueId;if(null!=t&&""!==t)return`id:${t}`;return`fallback:${(e.ticker||"").toString().trim().toUpperCase()}|${e.entryDate||""}|${e.strikePrice||""}`}rebuildQuoteRefreshSchedule(){this.activeQuoteEntries instanceof Map||(this.activeQuoteEntries=new Map),this.quoteRefreshKeys=Array.from(this.activeQuoteEntries.keys()),this.quoteRefreshCursor=0}startQuoteAutoRefreshIfNeeded(){if(this.activeQuoteEntries instanceof Map||(this.activeQuoteEntries=new Map),0===this.activeQuoteEntries.size)return void this.stopQuoteAutoRefresh();const e=this.computeAutoRefreshInterval();e!==this.autoRefreshIntervalMs&&(this.autoRefreshIntervalMs=e,this.stopQuoteAutoRefresh()),this.quoteRefreshIntervalId||(this.quoteRefreshIntervalId=setInterval(()=>{this.refreshActivePositionsQuotes({force:!0})},this.autoRefreshIntervalMs))}stopQuoteAutoRefresh(){this.quoteRefreshIntervalId&&(clearInterval(this.quoteRefreshIntervalId),this.quoteRefreshIntervalId=null),0===this.activeQuoteEntries?.size&&(this.quoteRefreshKeys=[],this.quoteRefreshCursor=0)}refreshActivePositionsQuotes({force:e=!1,immediate:t=!1}={}){if(!(this.activeQuoteEntries instanceof Map)||0===this.activeQuoteEntries.size)return void this.stopQuoteAutoRefresh();if(Array.isArray(this.quoteRefreshKeys)&&0!==this.quoteRefreshKeys.length||this.rebuildQuoteRefreshSchedule(),0===this.quoteRefreshKeys.length)return void this.stopQuoteAutoRefresh();let i=0;const r=this.quoteRefreshKeys.length;for(;i<r&&this.quoteRefreshKeys.length>0;){const r=this.quoteRefreshCursor%this.quoteRefreshKeys.length,a=this.quoteRefreshKeys[r],n=this.activeQuoteEntries.get(a);if(this.quoteRefreshCursor=(r+1)%this.quoteRefreshKeys.length,i+=1,n&&n.cell?.isConnected&&n.row?.isConnected)return void this.populateQuoteCell(n.cell,n.trade,n.row,{forceRefresh:e,silentIfCached:!e,suppressLoadingText:!t});if(this.activeQuoteEntries.delete(a),this.quoteRefreshKeys.splice(r,1),0===this.quoteRefreshKeys.length)return void this.stopQuoteAutoRefresh()}0===this.activeQuoteEntries.size&&this.stopQuoteAutoRefresh()}populateQuoteCell(e,t,i,r={}){const{forceRefresh:a=!1,deferNetworkFetch:n=!1,silentIfCached:s=!1,suppressLoadingText:o=!1}=r;if(!e)return;const l=(t?.ticker||"").toString().trim().toUpperCase();if(!l)return e.dataset.priceState="idle",e.textContent="—",void e.classList.remove("quote-error");const c=a?null:this.getCachedQuote(l);if(c)this.renderQuoteValue(e,i,t,c.value);else{if(!this.finnhub.apiKey){e.dataset.priceState="error",this.setQuoteCellError(e,i,t,"Set API key");const r=this.finnhub.lastStatus?.message;return"Add your Finnhub API key to load live prices."!==r&&this.updateFinnhubStatus("Add your Finnhub API key to load live prices.","neutral",6e3),void this.updateItmHighlight(i,t,null)}e.dataset.priceState=a?"refreshing":"loading",a||o||s||(e.textContent="Loading…"),e.classList.remove("quote-error"),this.finnhub.apiKey&&!n&&this.getCurrentPrice(l,{forceRefresh:a}).then(r=>{e.isConnected&&this.renderQuoteValue(e,i,t,r)}).catch(r=>{if(!e.isConnected)return;const a=this.getQuoteErrorMessage(r);this.setQuoteCellError(e,i,t,a)})}}renderQuoteValue(e,t,i,r){if(!e)return;e.dataset.priceState="ready",e.classList.remove("quote-error");const a=Number(r?.price);if(!Number.isFinite(a))return e.textContent="—",void this.applyPositionHighlight(t,i,null);const n=this.getQuoteChangePercent(r),s=this.getQuoteChangeValue(r);e.innerHTML="";const o=document.createElement("span");if(o.className="quote-price",o.textContent=this.formatCurrency(a),e.appendChild(o),Number.isFinite(n)){const t=document.createElement("span");t.className="quote-change";const i=Math.abs(n),r=`${n>0?"+":n<0?"-":""}${this.formatNumber(i,{decimals:2,useGrouping:!0})??i.toFixed(2)}%`;if(t.textContent=r,n>0?t.classList.add("is-up"):n<0?t.classList.add("is-down"):t.classList.add("is-flat"),Number.isFinite(s)){const e=Math.abs(s),i=this.formatCurrency(e),a=s>0?"+":s<0?"-":"";t.title=`${a}${i} (${r})`}e.appendChild(t)}this.applyPositionHighlight(t,i,a)}getQuoteChangePercent(e){const t=Number(e?.changePercent);if(Number.isFinite(t))return t;const i=Number(e?.change),r=Number(e?.previousClose);if(Number.isFinite(i)&&Number.isFinite(r)&&0!==r)return i/r*100;const a=Number(e?.price);return Number.isFinite(a)&&Number.isFinite(r)&&0!==r?(a-r)/r*100:null}getQuoteChangeValue(e){const t=Number(e?.change);if(Number.isFinite(t))return t;const i=Number(e?.price),r=Number(e?.previousClose);return Number.isFinite(i)&&Number.isFinite(r)?i-r:null}setQuoteCellError(e,t,i,r){if(!e)return;e.dataset.priceState="error",e.classList.add("quote-error");const a=(r||"").trim();if("Set API key"===a){e.textContent="";const t=document.createElement("button");t.type="button",t.className="link-button link-button--inline",t.textContent="Set API key",t.addEventListener("click",e=>{e.preventDefault(),this.showView("settings")}),e.appendChild(t)}else e.textContent=a||"Unavailable";this.applyPositionHighlight(t,i,null)}getQuoteErrorMessage(e){const t=(e?.message||"").toLowerCase();return t?t.includes("api key")?"Set API key":t.includes("rate limit")?"Rate limited":t.includes("symbol")?"Bad ticker":t.includes("network")?"Network error":"Unavailable":"Unavailable"}getCachedQuote(e){if(!e)return null;const t=this.finnhub.cache.get(e);return t?Date.now()-t.timestamp>this.finnhub.cacheTTL?(this.finnhub.cache.delete(e),null):t:null}setCachedQuote(e,t){e&&this.finnhub.cache.set(e,{value:t,timestamp:Date.now()})}async getCurrentPrice(e,{forceRefresh:t=!1}={}){const i=(e||"").toString().trim().toUpperCase();if(!i)throw new Error("Invalid symbol");if(t)this.finnhub.cache.delete(i);else{const e=this.getCachedQuote(i);if(e)return e.value}if(!this.finnhub.apiKey)throw new Error("Finnhub API key missing");const r=this.finnhub.outstandingRequests.get(i);if(r)return r;const a=this.enqueueFinnhubRequest(i).then(e=>(this.setCachedQuote(i,e),e)).catch(e=>{throw this.updateFinnhubStatus(e.message||"Failed to load quote.","error",7e3),e}).finally(()=>{this.finnhub.outstandingRequests.delete(i)});return this.finnhub.outstandingRequests.set(i,a),a}enqueueFinnhubRequest(e){const t=this.finnhub.rateLimitQueue.catch(()=>{}).then(()=>this.performFinnhubFetch(e));return this.finnhub.rateLimitQueue=t.then(()=>{}).catch(()=>{}),t}async performFinnhubFetch(e){await this.enforceFinnhubRateLimit();const t=new URL("https://finnhub.io/api/v1/quote");let i,r;t.searchParams.set("symbol",e),t.searchParams.set("token",this.finnhub.apiKey);try{i=await fetch(t.toString(),{cache:"no-store"})}catch(e){throw new Error("Network error fetching price")}if(!i.ok)throw new Error(429===i.status?"Finnhub rate limit exceeded. Please wait.":"Finnhub API error");try{r=await i.json()}catch(e){throw new Error("Invalid response from Finnhub")}if(r&&"string"==typeof r.error)throw new Error(r.error);const a=Number(r?.c);if(!Number.isFinite(a))throw new Error("Price unavailable for symbol");const n=Number(r?.d),s=Number(r?.dp),o=Number(r?.pc),l=Number(r?.o),c=Number(r?.h),d=Number(r?.l);return{price:a,change:Number.isFinite(n)?n:null,changePercent:Number.isFinite(s)?s:null,previousClose:Number.isFinite(o)?o:null,open:Number.isFinite(l)?l:null,high:Number.isFinite(c)?c:null,low:Number.isFinite(d)?d:null,fetchedAt:(new Date).toISOString(),currency:"USD"}}async enforceFinnhubRateLimit(){const e=this.finnhub.timestamps,t=Date.now();for(;e.length>0&&t-e[0]>=6e4;)e.shift();if(e.length>=this.finnhub.maxRequestsPerMinute){const i=6e4-(t-e[0])+50;await new Promise(e=>setTimeout(e,i))}e.push(Date.now())}applyPositionHighlight(e,t,i=null){e&&(this.updateExpirationHighlight(e,t),this.updateItmHighlight(e,t,i))}updateExpirationHighlight(e,t){if(!e)return;e.classList.remove("position-expiring-critical","position-expiring-warning");const i=this.positionHighlightConfig?.expirationWarningDays??20,r=this.positionHighlightConfig?.expirationCriticalDays??7,a=t?.dte,n=this.parseInteger(a,null,{allowNegative:!0});!Number.isFinite(n)||n<0||(n<r?e.classList.add("position-expiring-critical"):n<i&&e.classList.add("position-expiring-warning"))}updateItmHighlight(e,t,i){if(!e)return;const r=this.isInTheMoney(t,i,e);e.classList.toggle("position-itm",Boolean(r))}resolveStrikeForHighlight(e,t){const i=[];void 0!==t?.dataset?.strikePrice&&i.push(t.dataset.strikePrice),e&&i.push(e.activeStrikePrice,e.strikePrice,e.primaryStrike,e.shortStrike,e.longStrike);for(const e of i){const t=this.parseDecimal(e,null,{allowNegative:!1});if(Number.isFinite(t))return t}if(e&&Array.isArray(e.legs)&&e.legs.length>0){const t=this.summarizeLegs(e.legs),i=this.getActiveStrikeForDisplay(t);if(Number.isFinite(i))return i;const r=this.derivePrimaryStrike(t);if(Number.isFinite(r))return r}return null}isInTheMoney(e,t,i){if(!Number.isFinite(t))return!1;const r=this.resolveStrikeForHighlight(e,i);if(!Number.isFinite(r))return!1;const a=this.inferOptionFlavor(e);return"call"===a?t>=r:"put"===a&&t<=r}inferOptionFlavor(e={}){const t=(e.optionType||e.optionFlavor||"").toString().trim().toLowerCase();if("call"===t||"put"===t)return t;const i=(e.strategy||"").toLowerCase(),r=i.includes("call"),a=i.includes("put");if(r&&!a)return"call";if(a&&!r)return"put";const n=(e.notes||"").toLowerCase(),s=n.includes("call"),o=n.includes("put");return s&&!o?"call":o&&!s?"put":null}updateMonthlyPLChart(){const e=document.getElementById("monthlyPLChart");if(!e)return;const t=e.getContext("2d");this.charts.monthlyPL&&this.charts.monthlyPL.destroy();const i=(e,t=2)=>this.formatCurrency(e,{decimals:t}),r={};this.trades.filter(e=>this.isClosedStatus(e.status)&&e.exitDate).forEach(e=>{const t=e.exitDate.substring(0,7);r[t]||(r[t]=0),r[t]+=e.pl});const a=Object.keys(r).sort(),n=a.map(e=>new Date(e+"-01").toLocaleDateString("en-US",{month:"short",year:"numeric"}));this.charts.monthlyPL=new Chart(t,{type:"bar",data:{labels:n,datasets:[{label:"Monthly P&L",data:a.map(e=>r[e]),backgroundColor:a.map(e=>r[e]>=0?"#1FB8CD":"#B4413C"),borderColor:a.map(e=>r[e]>=0?"#1FB8CD":"#B4413C"),borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{callback:e=>i(e,0)}},x:{ticks:{maxRotation:45,minRotation:45}}},plugins:{legend:{display:!1},tooltip:{callbacks:{label:e=>`P&L: ${i(e.raw)}`}}}}})}updateCumulativePLChart(){const e=document.getElementById("cumulativePLChart");if(!e)return void console.error("Cumulative P&L chart canvas not found");const t=e.getContext("2d");this.charts.cumulativePL&&this.charts.cumulativePL.destroy();const i=(e,t=2)=>this.formatCurrency(e,{decimals:t}),r=this.computeCumulativePLSeries();r&&r.labels.length&&r.dataPoints.length?this.charts.cumulativePL=new Chart(t,{type:"line",data:{labels:r.labels,datasets:[{label:"Cumulative P&L",data:r.dataPoints,borderColor:"#1FB8CD",backgroundColor:"rgba(31, 184, 205, 0.1)",fill:!0,tension:.4,pointRadius:3,pointHoverRadius:6}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{x:{ticks:{callback:function(e){if("string"==typeof e)return e;if("number"==typeof e&&this&&"function"==typeof this.getLabelForValue){const t=this.getLabelForValue(e);if(t)return t}return""},maxRotation:45,minRotation:45}},y:{ticks:{callback:e=>i(e,0)}}},plugins:{legend:{display:!1},tooltip:{callbacks:{title:function(e){return e[0]?.label||""},label:e=>`Cumulative P&L: ${i(e.raw)}`}}}}}):this.charts.cumulativePL=new Chart(t,{type:"line",data:{labels:["No Data"],datasets:[{label:"Cumulative P&L",data:[0],borderColor:"#1FB8CD",backgroundColor:"rgba(31, 184, 205, 0.1)",fill:!1,tension:.4}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{ticks:{callback:e=>i(e,0)}}},plugins:{legend:{display:!1}}}})}getWeekEndingFriday(e){const t=new Date(e);if(isNaN(t.getTime()))return null;const i=new Date(t);i.setHours(0,0,0,0);const r=i.getDay();return 5===r?i:6===r?(i.setDate(i.getDate()-1),i):0===r?(i.setDate(i.getDate()-2),i):(i.setDate(i.getDate()+(5-r)),i)}getWeekKey(e){const t=new Date(e);if(isNaN(t.getTime()))return"";return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}formatWeekLabel(e){const t=new Date(e);return isNaN(t.getTime())?"":t.toLocaleDateString("en-US",{month:"short",day:"2-digit",year:"numeric"})}updateStrategyPerformanceChart(){const e=document.getElementById("strategyChart");if(!e)return;const t=e.getContext("2d");this.charts.strategy&&this.charts.strategy.destroy();const i={};this.trades.filter(e=>this.isClosedStatus(e.status)).forEach(e=>{i[e.strategy]||(i[e.strategy]=0),i[e.strategy]+=e.pl});const r=Object.entries(i).sort(([,e],[,t])=>t-e).slice(0,8),a=(e,t=2)=>this.formatCurrency(e,{decimals:t});this.charts.strategy=new Chart(t,{type:"bar",data:{labels:r.map(([e])=>e),datasets:[{label:"Total P&L",data:r.map(([,e])=>e),backgroundColor:r.map(([,e])=>e>=0?"#1FB8CD":"#B4413C"),borderColor:r.map(([,e])=>e>=0?"#1FB8CD":"#B4413C"),borderWidth:1}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,scales:{x:{beginAtZero:!0,ticks:{callback:e=>a(e,0)}}},plugins:{legend:{display:!1},tooltip:{callbacks:{label:e=>`P&L: ${a(e.raw)}`}}}}})}updateWinRateByStrategyChart(){const e=document.getElementById("winRateChart");if(!e)return;const t=e.getContext("2d");this.charts.winRate&&this.charts.winRate.destroy();const i={};this.trades.forEach(e=>{i[e.strategy]||(i[e.strategy]={total:0,wins:0}),this.isClosedStatus(e.status)&&(i[e.strategy].total++,e.pl>0&&i[e.strategy].wins++)});const r=Object.entries(i).filter(([,e])=>e.total>=1).map(([e,t])=>({strategy:e,winRate:t.wins/t.total*100,total:t.total})).sort((e,t)=>t.winRate-e.winRate);this.charts.winRate=new Chart(t,{type:"doughnut",data:{labels:r.map(e=>`${e.strategy} (${e.total})`),datasets:[{data:r.map(e=>e.winRate),backgroundColor:["#1FB8CD","#FFC185","#B4413C","#ECEBD5","#5D878F","#DB4545","#D2BA4C","#964325","#944454","#13343B"].slice(0,r.length),borderWidth:2,borderColor:"#fff"}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"right",labels:{boxWidth:15,padding:15}},tooltip:{callbacks:{label:e=>{const t=this.formatPercent(e.raw,"0%",{decimals:2});return`${e.label}: ${t}`}}}}}})}updateTradesList(){this.populateFilters(),this.filterTrades()}populateFilters(){const e=document.getElementById("filter-strategy"),t=e?.value||"",i=[...new Set(this.trades.map(e=>e.strategy))].filter(Boolean).sort((e,t)=>e.localeCompare(t));e&&(e.innerHTML='<option value="">All Strategies</option>',i.forEach(t=>{const i=document.createElement("option");i.value=t,i.textContent=t,e.appendChild(i)}),t&&i.includes(t)&&(e.value=t))}filterTrades(){const e=document.getElementById("filter-strategy")?.value||"",t=document.getElementById("filter-status")?.value||"",i=(document.getElementById("search-ticker")?.value||"").toString().trim().toLowerCase(),r=this.trades.filter(r=>{const a=!e||r.strategy===e,n=this.normalizeStatus(r.status);let s=!0;if(t){const e=t.toLowerCase();s="assigned"===e?"assigned"===n||"closed"===n&&this.isAssignmentReason(r.exitReason):n===e}const o=(r.ticker??"").toString().toLowerCase(),l=this.normalizeCycleId(r.cycleId).toLowerCase(),c=(this.normalizeCycleType(r.cycleType,r.strategy)||"").toLowerCase(),d=(r.notes??"").toString().toLowerCase(),u=!i||o.includes(i)||l.includes(i)||c&&c.includes(i)||d.includes(i);return a&&s&&u});this.currentFilteredTrades=r.slice(),this.renderTradesTable(r)}openTradesFilteredByTicker(e){const t=(e??"").toString().trim().toUpperCase();if(!t)return;this.showView("trades-list");const i=document.getElementById("search-ticker");i&&(i.value=t,i.focus()),["filter-strategy","filter-status"].forEach(e=>{const t=document.getElementById(e);t&&""!==t.value&&(t.value="")}),this.filterTrades()}openTradesFilteredByCycle(e,t=""){const i=this.normalizeCycleId(e);if(!i)return;this.showView("trades-list");const r=document.getElementById("search-ticker");r&&(r.value=i,r.focus()),this.filterTrades()}renderTradesTable(e=this.trades){const t=document.querySelector("#trades-table tbody");if(!t)return;const i=Array.isArray(e)?e.slice():[];this.currentFilteredTrades=i,"function"==typeof this.setupTradesMergeControls&&this.setupTradesMergeControls(),t.innerHTML="",this.tradeDetailCharts?.size&&(this.tradeDetailCharts.forEach(e=>{try{e.destroy()}catch(e){console.warn("Failed to destroy payoff chart:",e)}}),this.tradeDetailCharts.clear()),this.pruneTradeMergeSelection();const r=e=>{const t=Number(e);return Number.isFinite(t)?t:null},a=["","Ticker","Strategy","Strike","Qty","Net Credit/Debit","Entry Date","Expiration Date","DTE","Exit Date","Days Held","Max Risk","P&L","ROI","Annual ROI","Status","Actions"];i.forEach((e,i)=>{const n=t.insertRow();n.classList.add("trade-summary-row");const s=n.insertCell();s.className="trade-select-cell",s.classList.toggle("is-hidden",!this.tradesMergePanelOpen);const o=document.createElement("input");o.type="checkbox",o.className="trade-merge-checkbox",o.dataset.tradeId=e.id||"",o.checked=!!e.id&&this.tradeMergeSelection.has(e.id),o.disabled=!this.tradesMergePanelOpen,o.tabIndex=this.tradesMergePanelOpen?0:-1,o.setAttribute("aria-label",`Select trade ${e.ticker||""}`.trim()),o.addEventListener("change",t=>{if(t.stopPropagation(),!this.tradesMergePanelOpen)return void(t.target.checked=!!e.id&&this.tradeMergeSelection.has(e.id));const i=e.id;i?(t.target.checked?this.tradeMergeSelection.add(i):this.tradeMergeSelection.delete(i),this.syncSelectAllCheckbox(),this.refreshTradesMergePanelContents()):t.target.checked=!1}),s.appendChild(o);n.insertCell().appendChild(this.createTickerElement(e.ticker));n.insertCell().textContent=e.strategy||"—";const l=n.insertCell(),c=e.displayStrike||null,d=r(e.strikePrice);l.textContent=c||(null!==d?`$${d.toFixed(2)}`:"—");const u=n.insertCell(),m=r(e.quantity);u.textContent=null!==m?Math.abs(m):"—";const h=n.insertCell(),p=e.entryPriceLabel||null,g=r(e.entryPrice);h.textContent=p&&"—"!==p?p:null!==g?`$${g.toFixed(2)}`:"—";n.insertCell().textContent=this.formatDate(e.entryDate);n.insertCell().textContent=this.formatDate(e.expirationDate);const y=n.insertCell(),f=r(e.dte);y.textContent=null!==f?f:"—";n.insertCell().textContent=e.exitDate?this.formatDate(e.exitDate):"—";const b=n.insertCell(),C=r(e.daysHeld);b.textContent=null!==C?C:"—";const S=n.insertCell(),L=r(e.maxRisk);e.maxRiskLabel?(S.textContent=e.maxRiskLabel,S.className=e.riskIsUnlimited?"pl-negative":"pl-neutral",e.riskIsUnlimited||null===L||(S.className="pl-negative")):null!==L?(S.textContent=this.formatCurrency(L),S.className="pl-negative"):(S.textContent="—",S.className="pl-neutral");const T=n.insertCell(),N=r(e.pl);null!==N?(T.textContent=this.formatCurrency(N),T.className=N>0?"pl-positive":N<0?"pl-negative":"pl-neutral"):(T.textContent="—",T.className="pl-neutral");const I=n.insertCell(),v=r(e.roi),x=null!==v?this.formatPercent(v,"—"):"—";I.textContent=x,I.className="—"===x?"pl-neutral":v>0?"pl-positive":v<0?"pl-negative":"pl-neutral";const D=n.insertCell(),k=r(e.annualizedROI);if(this.isClosedStatus(e.status)&&null!==k){const e=this.formatPercent(k,"—");D.textContent=e,D.className=k>0?"pl-positive":k<0?"pl-negative":"pl-neutral"}else D.textContent="—",D.className="pl-neutral";const E=n.insertCell(),w=document.createElement("span"),A=this.getDisplayStatus(e),P=A.toLowerCase().replace(/\s+/g,"-");w.className=`status-badge ${P}`.trim(),w.textContent=A,E.appendChild(w);const F=n.insertCell();F.className="actions-cell";const R=`trade-pl-${e.id??e.tradeId??e.uniqueId??`${e.ticker||"trade"}-${i}`}`.toString().replace(/[^a-zA-Z0-9_-]/g,"-"),M=`${R}-footnote`,O=document.createElement("button");O.type="button",O.className="action-btn action-btn--edit",O.textContent="Edit",O.addEventListener("click",t=>{t.stopPropagation(),this.editTrade(e.id)});const B=document.createElement("button");B.type="button",B.className="action-btn action-btn--delete",B.textContent="Delete",B.addEventListener("click",t=>{t.stopPropagation(),this.deleteTrade(e.id)}),F.append(O,B),n.setAttribute("tabindex","0"),n.setAttribute("aria-expanded","false"),n.setAttribute("aria-controls",R),n.dataset.chartId=R;const U=t.insertRow();U.className="trade-detail-row",U.setAttribute("aria-hidden","true"),U.style.display="none",U.dataset.chartId=R;const $=U.insertCell(0);$.colSpan=a.length,$.innerHTML=`\n                <div class="trade-diagram" data-chart-container="${R}">\n                    <div class="trade-diagram__canvas">\n                        <canvas id="${R}" aria-hidden="true"></canvas>\n                    </div>\n                    <p class="trade-diagram__footnote" id="${M}">Tap or click the trade row to generate the payoff diagram.</p>\n                </div>\n            `;const _=()=>{this.toggleTradePayoffDetail(n,U,e,R,M)};n.addEventListener("click",e=>{e.target.closest("button")||e.target.closest("a")||e.target.closest("input")||e.target.closest(".trade-diagram")||_()}),n.addEventListener("keydown",e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),_())}),this.applyResponsiveLabels(n,a)}),this.syncTradeSelectionCheckboxes(),this.updateMergeColumnVisibility(),this.refreshTradesMergePanelContents()}toggleTradePayoffDetail(e,t,i,r,a){if(!t)return;const n=!t.classList.contains("is-open");t.classList.toggle("is-open",n),t.style.display=n?"table-row":"none",t.setAttribute("aria-hidden",String(!n)),e?.setAttribute("aria-expanded",String(n));const s=t.querySelector("canvas");if(s&&s.setAttribute("aria-hidden",String(!n)),n){const e=this.renderTradePayoffChart(i,r,a);e?.catch&&e.catch(e=>{console.error("Failed to render payoff chart:",e)})}else this.destroyTradePayoffChart(r,a)}async renderTradePayoffChart(e,t,i){const r=document.getElementById(t),a=document.getElementById(i),n=r?.parentElement;if(!r)return void(a&&(a.textContent="Canvas element missing; cannot generate payoff diagram."));if(this.tradeDetailCharts?.has(t))return;a&&(a.textContent="Loading live price and payoff data…");const s=this.calculatePayoffSeries(e);if(!s||!Array.isArray(s.points)||0===s.points.length)return n&&n.classList.add("trade-diagram__canvas--empty"),r.classList.add("hidden"),void(a&&(a.textContent=s?.message||"Payoff diagram not available for this strategy yet."));r.classList.remove("hidden"),n?.classList.remove("trade-diagram__canvas--empty");const o=r.getContext("2d");if(!o)return void(a&&(a.textContent="Unable to access canvas rendering context."));const l=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:2}),c="rgba(34, 197, 94, 1)",d=s.points.map(e=>e.y);let u=Math.min(...d,0),m=Math.max(...d,0);Number.isFinite(u)&&Number.isFinite(m)||(u=0,m=0),u===m&&(u-=1,m+=1);const h=s.points.map(e=>({x:e.x,y:e.y>=0?e.y:null})),p=s.points.map(e=>({x:e.x,y:e.y<=0?e.y:null})),g=o.createLinearGradient(0,0,0,r.height);g.addColorStop(0,"rgba(34, 197, 94, 0.18)"),g.addColorStop(1,"rgba(34, 197, 94, 0.02)");const y=o.createLinearGradient(0,0,0,r.height);y.addColorStop(0,"rgba(248, 113, 113, 0.18)"),y.addColorStop(1,"rgba(248, 113, 113, 0.02)");const f=await this.getUnderlyingPriceForPayoff(e),b=document.querySelector(`.trade-detail-row[data-chart-id="${t}"]`);if(b&&!b.classList.contains("is-open"))return void(a&&(a.textContent="Tap or click the trade row to generate the payoff diagram."));const C={id:`payoffPriceLineLabel-${t}`,afterDatasetsDraw:e=>{if(!Number.isFinite(f))return;const t=e.scales?.x,i=e.chartArea;if(!t||!i)return;const r=t.getPixelForValue(f);if(!Number.isFinite(r)||r<i.left||r>i.right)return;e.scales;const a=e.ctx;a.save(),a.font='12px "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',a.fillStyle="rgba(30, 41, 59, 0.9)",a.textBaseline="middle",a.textAlign="center";let n=i.bottom-10-50;(!Number.isFinite(n)||n<i.top+12)&&(n=i.top+12);const s=r<(i.left+i.right)/2?Math.min(i.right-18,r+18):Math.max(i.left+18,r-18),o=`Current ${l.format(f)}`;a.translate(s,n),a.rotate(-Math.PI/2),a.fillText(o,0,0),a.restore()}},S=[{id:"currentPriceLine",label:"Current Price",data:[],borderColor:"rgba(100, 116, 139, 0.95)",borderDash:[6,4],borderWidth:2,hoverBorderColor:"rgba(100, 116, 139, 0.95)",hoverBorderWidth:2,pointRadius:0,pointHitRadius:0,fill:!1,order:0,hidden:!0},{id:"breakevenLine",label:"Breakeven",data:[],borderColor:"rgba(59, 130, 246, 0.8)",borderDash:[2,4],borderWidth:1,pointRadius:0,pointHitRadius:0,fill:!1,order:0,hidden:!0},{id:"positiveFill",label:"Profit Region",data:h,borderColor:"rgba(0,0,0,0)",backgroundColor:g,hoverBackgroundColor:g,hoverBorderColor:"rgba(0, 0, 0, 0)",hoverBorderWidth:0,fill:"origin",pointRadius:0,pointHitRadius:0,tension:0,order:1,spanGaps:!0,showLine:!0},{id:"negativeFill",label:"Loss Region",data:p,borderColor:"rgba(0,0,0,0)",backgroundColor:y,hoverBackgroundColor:y,hoverBorderColor:"rgba(0, 0, 0, 0)",hoverBorderWidth:0,fill:"origin",pointRadius:0,pointHitRadius:0,tension:0,order:1,spanGaps:!0,showLine:!0},{id:"payoffLine",label:"P&L at Expiration",data:s.points,borderColor:c,hoverBorderColor:c,hoverBorderWidth:2,tension:0,pointRadius:0,pointHoverRadius:0,borderWidth:2,fill:!1,order:2,segment:{borderColor:e=>{const t=e.p0.parsed?.y,i=e.p1.parsed?.y;return t>=0&&i>=0?c:t<=0&&i<=0?"rgba(248, 113, 113, 1)":"rgba(148, 163, 184, 1)"}}},{id:"zeroLine",label:"Break-even Baseline",data:s.zeroLinePoints??s.points.map(e=>({x:e.x,y:0})),borderColor:"rgba(71, 85, 105, 0.9)",borderDash:[4,4],borderWidth:2,hoverBorderColor:"rgba(71, 85, 105, 0.95)",hoverBorderWidth:2,pointRadius:0,pointHitRadius:0,fill:!1,order:3}];if(Number.isFinite(f)){const e=S.findIndex(e=>"currentPriceLine"===e.id);-1!==e&&(S[e].data=[{x:f,y:u},{x:f,y:m}],S[e].hidden=!1)}if(Number.isFinite(s.breakeven)){const e=S.findIndex(e=>"breakevenLine"===e.id);-1!==e&&(S[e].data=[{x:s.breakeven,y:u},{x:s.breakeven,y:m}])}const L=new Chart(o,{type:"line",data:{datasets:S},plugins:[C],options:{parsing:!1,responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},hover:{mode:"index",intersect:!1},plugins:{legend:{display:!1},tooltip:{callbacks:{label:e=>{if(!e.dataset||"payoffLine"!==e.dataset.id)return null;const t=Number(e.parsed?.x),i=Number(e.parsed?.y);if(!Number.isFinite(t)||!Number.isFinite(i))return null;const r=l.format(i),a=l.format(t);return`${e.dataset.label||"P&L"}: ${r} @ ${a}`}}}},scales:{x:{type:"linear",title:{display:!0,text:"Underlying Price ($)"},ticks:{callback:e=>l.format(Number(e))}},y:{title:{display:!0,text:"P&L ($)"},ticks:{callback:e=>l.format(Number(e))},suggestedMin:u,suggestedMax:m}}}});this.tradeDetailCharts.set(t,L),a&&(a.textContent=this.formatPayoffFooter(s,l))}destroyTradePayoffChart(e,t){const i=this.tradeDetailCharts?.get(e);if(i){try{i.destroy()}catch(e){console.warn("Failed to destroy payoff chart:",e)}this.tradeDetailCharts.delete(e)}const r=document.getElementById(e),a=r?.parentElement;if(r){const e=r.getContext("2d");e&&e.clearRect(0,0,r.width,r.height),r.classList.remove("hidden")}if(a?.classList.remove("trade-diagram__canvas--empty"),t){const e=document.getElementById(t);e&&(e.textContent="Tap or click the trade row to generate the payoff diagram.")}}async getUnderlyingPriceForPayoff(e={}){const t=(e?.ticker||"").toString().trim().toUpperCase();if(t){const e=this.getCachedQuote(t);if(e?.value&&Number.isFinite(Number(e.value.price)))return Number(e.value.price);if(this.finnhub.apiKey)try{const e=await this.getCurrentPrice(t),i=Number(e?.price);if(Number.isFinite(i)&&i>0)return i}catch(e){console.warn("Live price lookup failed for payoff chart:",e)}}return this.getFallbackUnderlyingPrice(e)}getFallbackUnderlyingPrice(e={}){const t=[e.currentUnderlyingPrice,e.currentPrice,e.marketPrice,e.lastUnderlyingPrice,e.lastPrice,e.markPrice,e.referencePrice,e.stockPriceAtEntry];for(const e of t){const t=Number(e);if(Number.isFinite(t)&&t>0)return t}return null}calculatePayoffSeries(e){const t=this.determinePayoffModel(e);if(!t||"unsupported"===t.type)return{message:t?.reason||"Payoff diagram not available for this strategy yet."};switch(t.type){case"single":return this.calculateSingleLegSeries(e,t);case"vertical":return this.calculateVerticalSpreadSeries(e,t);case"covered-call":return this.calculateCoveredCallSeries(e,t);case"pmcc":return this.calculatePmccSeries(e,t);default:return{message:"Payoff diagram not available for this strategy yet."}}}determinePayoffModel(e){const t=(e.strategy||"").toString().trim(),i=t.toLowerCase(),r=Number(e.definedRiskWidth);if(!i)return{type:"unsupported",reason:"Add a strategy name to unlock payoff diagrams."};const a=this.normalizeCycleType(e.cycleType,t);if(i.includes("poor man's covered call")||i.includes("poor man")||"pmcc"===a||this.isPmccBaseLeg(e)||this.isPmccShortCall(e)){const t=this.extractPmccLegs(e);return t.baseLeg?{type:"pmcc",strategy:i,...t}:{type:"unsupported",reason:"Add the PMCC base leg to this cycle to unlock the payoff diagram."}}if(i.includes("covered call"))return{type:"covered-call",strategy:i};const n=/(iron|straddle|strangle|butterfly|ratio|lizard|combo|synthetic|double|calendar|diagonal)/.test(i),s=i.includes("put")?"put":i.includes("call")?"call":null,o=/calendar|diagonal/.test(i);if(i.includes("spread")&&!o&&!(r>0))return{type:"unsupported",reason:"Add the defined risk width to visualize this spread."};if(r>0&&s&&i.includes("spread")&&!o){return{type:"vertical",optionType:s,orientation:i.includes("short")||i.includes("credit")||"short"===this.inferTradeDirection(e)?"short":"long",width:Number(r),strategy:i}}if(n)return{type:"unsupported",reason:"Visualization for multi-leg strategies such as condors, straddles, or ratios is coming soon."};if(!s)return{type:"unsupported",reason:"Unable to infer option type from the strategy name."};return{type:"single",optionType:s,direction:"short"===this.inferTradeDirection(e)?"short":"long",strategy:i}}calculateSingleLegSeries(e,t){const i=Number(e.strikePrice),r=Number(e.entryPrice),a=Number(e.fees)||0,n=Math.abs(Number(e.quantity)||1),s=Number(e.stockPriceAtEntry);if(!Number.isFinite(i)||!Number.isFinite(r))return{message:"Provide both a strike price and entry price to view this payoff."};const o=this.buildPriceRange({strikeValues:[i],spot:s}),l=100*n,c=[];for(let e=0;e<=40;e++){const n=o.minPrice+(o.maxPrice-o.minPrice)*e/40,s=this.optionIntrinsic(t.optionType,n,i),d=("long"===t.direction?s-r:r-s)*l-a;c.push({x:parseFloat(n.toFixed(2)),y:parseFloat(d.toFixed(2))})}const d=c.map(e=>({x:e.x,y:0})),u="call"===t.optionType?i+r:i-r,m=r*l;let h,p;"long"===t.direction?(h="call"===t.optionType?1/0:Math.max((i-r)*l-a,0),p=m+a):(h=Math.max(m-a,0),p="call"===t.optionType?1/0:Math.max((i-r)*l+a,0));return{points:c,zeroLinePoints:d,summary:this.buildPayoffSummary({profileLabel:`${"short"===t.direction?"Short":"Long"} ${t.optionType.toUpperCase()}`,breakeven:u,maxProfit:h,maxLoss:p,contracts:n,isCredit:"short"===t.direction}),breakeven:u,maxProfit:h,maxLoss:p}}calculateVerticalSpreadSeries(e,t){const i=Number(e.strikePrice),r=Number(e.entryPrice),a=Number(e.fees)||0,n=Math.abs(Number(e.quantity)||1),s=Number(e.stockPriceAtEntry);if(!Number.isFinite(i)||!Number.isFinite(r))return{message:"Provide strike and entry price to view this spread payoff."};if(!(t.width>0))return{message:"Add the defined risk width to visualize this spread."};let o,l;if("call"===t.optionType?"short"===t.orientation?(o=i,l=i+t.width):(l=i,o=i+t.width):"short"===t.orientation?(o=i,l=i-t.width):(l=i,o=i-t.width),!Number.isFinite(o)||!Number.isFinite(l))return{message:"Unable to determine both strikes for this spread."};const c=this.buildPriceRange({strikeValues:[o,l],spot:s}),d=100*n,u=[];for(let e=0;e<=40;e++){const i=c.minPrice+(c.maxPrice-c.minPrice)*e/40,n=this.optionIntrinsic(t.optionType,i,o),s=this.optionIntrinsic(t.optionType,i,l),m=("short"===t.orientation?r-(n-s):s-n-r)*d-a;u.push({x:parseFloat(i.toFixed(2)),y:parseFloat(m.toFixed(2))})}const m=u.map(e=>({x:e.x,y:0})),h=this.calculateSpreadBreakeven({model:t,shortStrike:o,longStrike:l,entryPrice:r}),p=Math.abs(o-l)*d,g=r*d;let y,f;"short"===t.orientation?(y=Math.max(g-a,0),f=Math.max(p-g,0)+a):(y=Math.max(Math.max(p-g,0)-a,0),f=g+a);return{points:u,zeroLinePoints:m,summary:this.buildPayoffSummary({profileLabel:`${"short"===t.orientation?"Short":"Long"} ${"call"===t.optionType?"Call":"Put"} Spread`,breakeven:h,maxProfit:y,maxLoss:f,contracts:n,isCredit:"short"===t.orientation}),breakeven:h,maxProfit:y,maxLoss:f}}calculateCoveredCallSeries(e){const t=Number(e.strikePrice),i=Number(e.entryPrice),r=Number(e.stockPriceAtEntry),a=Number(e.fees)||0,n=Math.abs(Number(e.quantity)||1);if(!Number.isFinite(t)||!Number.isFinite(i)||!Number.isFinite(r))return{message:"Covered call payoff requires strike, option premium, and stock cost basis."};const s=this.buildPriceRange({strikeValues:[t,r],spot:r}),o=100*n,l=[];for(let e=0;e<=40;e++){const n=s.minPrice+(s.maxPrice-s.minPrice)*e/40,c=(n-r+(i-this.optionIntrinsic("call",n,t)))*o-a;l.push({x:parseFloat(n.toFixed(2)),y:parseFloat(c.toFixed(2))})}const c=l.map(e=>({x:e.x,y:0})),d=r-i,u=Math.max((t-r+i)*o-a,0),m=Math.max((r-i)*o+a,0);return{points:l,zeroLinePoints:c,summary:this.buildPayoffSummary({profileLabel:"Covered Call (Stock + Short Call)",breakeven:d,maxProfit:u,maxLoss:m,contracts:n,isCredit:!0}),breakeven:d,maxProfit:u,maxLoss:m}}calculatePmccSeries(e,t){const i=t.baseLeg;if(!i)return{message:"Add the PMCC base leg to visualize this payoff."};const r=Number(i.strikePrice),a=Number(i.entryPrice),n=Number(i.fees)||0,s=Math.abs(Number(i.quantity)||1);if(!Number.isFinite(r)||!Number.isFinite(a))return{message:"Provide strike and entry price for the PMCC base leg to view this payoff."};const o=t.shortLeg,l=Number(o?.strikePrice),c=Number(o?.entryPrice),d=Number(o?.fees)||0,u=Math.abs(Number(o?.quantity)||0),m=o?this.inferTradeDirection(o):null,h=[r];Number.isFinite(l)&&h.push(l);const p=this.getFallbackUnderlyingPrice(i)??(o?this.getFallbackUnderlyingPrice(o):null)??Number(i.stockPriceAtEntry),g=this.buildPriceRange({strikeValues:h,spot:Number.isFinite(p)?p:Number.NaN}),y=100*s,f=u>0?100*u:y,b=[];for(let e=0;e<=80;e++){const t=g.minPrice+(g.maxPrice-g.minPrice)*e/80,i=(Math.max(t-r,0)-a)*y-n;let s=0;if(o&&Number.isFinite(l)&&Number.isFinite(c)){const e=Math.max(t-l,0);s=("short"===m?c-e:e-c)*f-d}const u=i+s;b.push({x:parseFloat(t.toFixed(2)),y:parseFloat(u.toFixed(2))})}const C=b.map(e=>({x:e.x,y:0})),S=a*y+n;let L=0;o&&Number.isFinite(c)&&(L="short"===m?c*f-d:-(c*f+d));const T=S-L,N=y>0?T/y:0,I=Number.isFinite(N)?r+N:null;let v=1/0;if(o&&Number.isFinite(l)&&"short"===m){const e=Math.max(Math.min(s,u),0);if(e>0){const t=l-r;Number.isFinite(t)&&(v=100*t*e-T)}}const x=T>0?T:0;return{points:b,zeroLinePoints:C,summary:this.buildPayoffSummary({profileLabel:"Poor Man's Covered Call",breakeven:I,maxProfit:v,maxLoss:x,contracts:s,isCredit:T<0}),breakeven:I,maxProfit:v,maxLoss:x}}calculateSpreadBreakeven({model:e,shortStrike:t,longStrike:i,entryPrice:r}){return"short"===e.orientation?"call"===e.optionType?t+r:t-r:"call"===e.optionType?i+r:i-r}optionIntrinsic(e,t,i){return Number.isFinite(t)&&Number.isFinite(i)?"call"===e?Math.max(t-i,0):Math.max(i-t,0):0}extractPmccLegs(e={}){const t=e=>(e||"").toString().trim().toUpperCase(),i=this.normalizeCycleId(e.cycleId);let r=[];if(i&&(r=this.trades.filter(e=>this.normalizeCycleId(e.cycleId)===i)),0===r.length){const i=t(e.ticker);i&&(r=this.trades.filter(e=>t(e.ticker)===i&&"pmcc"===this.normalizeCycleType(e.cycleType,e.strategy)))}r.includes(e)||r.push(e);const a=(e=[])=>[...e].sort((e,t)=>{const i=this.normalizeStatus(e.status),r=this.normalizeStatus(t.status);if("open"===i&&"open"!==r)return-1;if("open"!==i&&"open"===r)return 1;const a=new Date(e.entryDate||e.openDate||0).getTime();return new Date(t.entryDate||t.openDate||0).getTime()-a});let n=a(r.filter(e=>this.isPmccBaseLeg(e)))[0];if(!n){n=a(r.filter(e=>"long"===this.inferTradeDirection(e)&&(e.strategy||"").toLowerCase().includes("call")))[0]||("long"===this.inferTradeDirection(e)?e:null)}let s=a(r.filter(e=>this.isPmccShortCall(e)))[0];if(!s){s=a(r.filter(e=>"short"===this.inferTradeDirection(e)&&(e.strategy||"").toLowerCase().includes("call")))[0]||("short"===this.inferTradeDirection(e)?e:null)}return n&&s&&n===s&&(s=null),{baseLeg:n,shortLeg:s}}buildPriceRange({strikeValues:e=[],spot:t=Number.NaN}={}){const i=e.map(e=>Number(e)).filter(Number.isFinite);if(Number.isFinite(t)&&i.push(t),0===i.length)return{minPrice:0,maxPrice:100};let r=Math.max(Math.min(...i),0),a=Math.max(...i);if(r===a)r=Math.max(0,.7*r),a=1.3*a+1;else{const e=a-r;r=Math.max(0,r-.3*e),a+=.3*e}return a-r<5&&(r=Math.max(0,r-2.5),a+=2.5),{minPrice:r,maxPrice:a}}buildPayoffSummary({profileLabel:e,breakeven:t,maxProfit:i,maxLoss:r,contracts:a,isCredit:n=!1}){const s=[];return e&&s.push(e),Number.isFinite(t)&&s.push(`Breakeven ${this.formatCurrency(t)}`),i===1/0?s.push("Max profit unlimited"):Number.isFinite(i)&&s.push(`Max profit ${this.formatCurrency(i)}`),r===1/0?s.push("Max loss unlimited (theoretical)"):Number.isFinite(r)&&s.push(`Max loss ${this.formatCurrency(r)}`),Number.isFinite(a)&&s.push(`${a} contract${1===a?"":"s"}${n?" (credit)":""}`),s.join(" • ")||"Payoff preview unavailable."}formatPayoffFooter(e,t){const i=e=>e===1/0||e===-1/0?"Unlimited":Number.isFinite(e)?t.format(e):"—";return[`Max profit ${i(e?.maxProfit)}`,`Max loss ${i(e?.maxLoss)}`,`Breakeven ${i(e?.breakeven)}`].join(" • ")}getTradePayoffMeta(e){const t=(e.strategy||"Unspecified strategy").toString(),i=this.getTradeType(e)||"—",r=this.getDisplayStatus(e),a=Math.abs(Number(e.quantity));return[t,i,Number.isFinite(a)&&a>0?`${a} contract${1===a?"":"s"}`:null,r].filter(Boolean).join(" • ")}sortTrades(e){const t="asc"===this.sortDirection[e]?"desc":"asc";this.sortDirection[e]=t,document.querySelectorAll(".sortable").forEach(e=>{e.classList.remove("asc","desc")});const i=document.querySelector(`[data-sort="${e}"]`);i&&i.classList.add(t);const r=[...this.trades].sort((i,r)=>{let a=i[e],n=r[e];return e.includes("Date")&&(a=new Date(a),n=new Date(n)),"asc"===t?a<n?-1:a>n?1:0:a>n?-1:a<n?1:0});this.renderTradesTable(r)}deleteTrade(e){confirm("Are you sure you want to delete this trade?")&&(this.trades=this.trades.filter(t=>t.id!==e),this.saveToStorage(),this.markUnsavedChanges(),this.filterTrades(),this.updateDashboard())}editTrade(e){const t=this.trades.find(t=>t.id===e);if(!t)return;this.resetAddTradeForm(),this.currentEditingId=e;const i=document.getElementById("add-trade-form");if(!i)return;const r=i.elements;if(r.ticker&&(r.ticker.value=t.ticker||""),r.strategy&&(r.strategy.value=t.strategy||""),r.exitReason&&(r.exitReason.value=t.exitReason||""),r.notes&&(r.notes.value=t.notes||""),r.cycleId&&(r.cycleId.value=t.cycleId||""),r.cycleType&&(r.cycleType.value=t.cycleType||""),r.cycleRole&&(r.cycleRole.value=t.cycleRole||""),r.underlyingType){const e=this.normalizeUnderlyingType(t.underlyingType,{fallback:"Stock"})||"Stock";r.underlyingType.value=e}if(r.tradeStatus){const e=this.normalizeTradeStatusInput(t.statusOverride);r.tradeStatus.value=e||""}this.renderLegForms(t.legs||[]),this.updateTickerPreview(t.ticker||""),this.showView("add-trade")}exportToCSV(){const e=e=>{if(null==e)return"";const t=String(e);return""===t?"":/[",\n]/.test(t)?`"${t.replace(/"/g,'""')}"`:t},t=e=>null==e||"—"===e?"":e,i=e=>{const i=Number(e);return Number.isFinite(i)?t(this.formatCurrency(i)):""},r=(e,i=0)=>{const r=Number(e);return Number.isFinite(r)?t(this.formatNumber(r,{decimals:i,useGrouping:!0})):""},a=e=>{const i=Number(e);if(i===Number.POSITIVE_INFINITY)return"Infinite";if(!Number.isFinite(i))return"";const r=t(this.formatNumber(i,{decimals:2,useGrouping:!0}));return r?`${r}%`:`${i.toFixed(2)}%`},n=e=>null==e?"":i(e),s=(e,t=0)=>null==e?"":r(e,t),o=this.trades.map(t=>[t.ticker??"",t.strategy??"",this.getTradeType(t)??"",n(t.strikePrice),n(t.definedRiskWidth),s(Math.abs(t.quantity),0),n(t.entryPrice),n(t.exitPrice),s(t.dte,0),s(t.daysHeld,0),t.entryDate??"",t.expirationDate??"",t.exitDate??"",n(t.maxRisk),n(t.pl),a(t.roi),a(t.annualizedROI),t.status??"",n(t.stockPriceAtEntry),n(t.fees),n(t.maxRiskOverride),s(t.ivRank,2),t.notes??"",t.exitReason??"",t.cycleId??"",t.cycleType??"",t.cycleRole??""].map(e).join(",")),l=[["Ticker","Strategy","Trade Type","Strike","Defined Risk Width","Qty","Net Credit/Debit","Exit Price","DTE","Days Held","Entry Date","Expiration Date","Exit Date","Max Risk","P&L","ROI %","Annual ROI %","Status","Stock Price at Entry","Fees","Max Risk Override","IV Rank","Notes","Exit Reason","Cycle ID","Cycle Type","Cycle Role"].map(e).join(","),...o].join("\n"),c=new Blob([l],{type:"text/csv"}),d=window.URL.createObjectURL(c),u=document.createElement("a");u.style.display="none",u.href=d,u.download="options_trades_enhanced.csv",document.body.appendChild(u),u.click(),window.URL.revokeObjectURL(d),document.body.removeChild(u)}async saveDatabase(){this.showLoadingIndicator("Saving...");try{const e=this.buildDatabasePayload();this.supportsFileSystemAccess?await this.saveWithFileSystemAPI(e):this.saveWithDownload(e),this.hasUnsavedChanges=!1,this.updateUnsavedIndicator(),this.showNotification("Database saved successfully!","success"),this.saveToStorage({fileName:this.currentFileName})}catch(e){if(console.error("Save error:",e),"AbortError"!==e.name)try{const e=this.buildDatabasePayload();this.saveWithDownload(e),this.hasUnsavedChanges=!1,this.updateUnsavedIndicator(),this.showNotification("Database saved as download!","success"),this.saveToStorage({fileName:this.currentFileName})}catch(e){this.showNotification("Failed to save database","error")}}this.hideLoadingIndicator()}getStorageTrades(){return Array.isArray(this.trades)?this.trades.map(e=>this.buildTradeStorageSnapshot(e)).filter(Boolean):[]}buildTradeStorageSnapshot(e){if(!e||"object"!=typeof e)return null;const t={};for(const[i,r]of Object.entries(e))if(!RUNTIME_TRADE_FIELDS.has(i))if("legs"!==i)void 0!==r&&(null!==r?Array.isArray(r)?t[i]=r.map(e=>"object"==typeof e&&null!==e?{...e}:e):t[i]="object"!=typeof r?r:{...r}:t[i]=null);else if(Array.isArray(r)){const e=r.map(e=>this.buildLegStorageSnapshot(e)).filter(Boolean);t.legs=e}else t.legs=[];return Array.isArray(t.legs)||(t.legs=[]),t}buildLegStorageSnapshot(e){if(!e||"object"!=typeof e)return null;const t={};for(const[i,r]of Object.entries(e))RUNTIME_LEG_FIELDS.has(i)||void 0!==r&&(null!==r?Array.isArray(r)?t[i]=r.slice():t[i]="object"!=typeof r?r:{...r}:t[i]=null);return t}buildDatabasePayload(){return{trades:this.getStorageTrades(),exportDate:(new Date).toISOString(),version:"2.5"}}async saveWithFileSystemAPI(e){try{this.currentFileHandle||(this.currentFileHandle=await window.showSaveFilePicker({suggestedName:"gammaledger.json",types:[{description:"JSON files",accept:{"application/json":[".json"]}}]}));const t=await this.currentFileHandle.createWritable();await t.write(JSON.stringify(e,null,2)),await t.close(),this.currentFileName=this.currentFileHandle.name,this.updateFileNameDisplay()}catch(e){throw e}}saveWithDownload(e){const t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),i=URL.createObjectURL(t),r=document.createElement("a");r.href=i,r.download="gammaledger.json",document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(i),this.currentFileName="gammaledger.json",this.updateFileNameDisplay()}async loadDatabase(){this.showLoadingIndicator("Loading...");try{this.supportsFileSystemAccess?await this.loadWithFileSystemAPI():this.loadWithFileInput()}catch(e){console.error("Load error:",e),"AbortError"!==e.name&&this.loadWithFileInput()}this.hideLoadingIndicator()}async loadWithFileSystemAPI(){const[e]=await window.showOpenFilePicker({types:[{description:"JSON files",accept:{"application/json":[".json"]}}]}),t=await e.getFile(),i=await t.text(),r=JSON.parse(i);this.processLoadedData(r,{fileName:e.name,source:"file-open"}),this.currentFileHandle=e,this.showNotification(`Loaded ${this.trades.length} trades successfully!`,"success")}loadWithFileInput(){const e=document.getElementById("file-input");e.onchange=t=>{const i=t.target.files[0];if(i){const t=new FileReader;t.onload=t=>{try{const e=JSON.parse(t.target.result);this.processLoadedData(e,{fileName:i.name,source:"file-open"}),this.showNotification(`Loaded ${this.trades.length} trades successfully!`,"success")}catch(e){this.showNotification("Invalid JSON file","error")}e.value=""},t.readAsText(i)}else e.value=""},e.click()}setupImportControls(){if(this.importControlsInitialized)return;const e=document.getElementById("import-ofx-btn"),t=document.getElementById("import-json-btn"),i=document.getElementById("import-ofx-input"),r=document.getElementById("import-json-input");e&&i&&(e.addEventListener("click",e=>{e.preventDefault(),i.value="",i.click()}),i.addEventListener("change",e=>{this.handleOfxFileSelection(e)})),t&&r&&(t.addEventListener("click",e=>{e.preventDefault(),r.value="",r.click()}),r.addEventListener("change",async e=>{const t=e?.target;if(!t||!t.files||0===t.files.length)return;const[i]=t.files;if(t.value="",i)try{this.showLoadingIndicator("Importing JSON...");const e=await i.text(),t=JSON.parse(e),r=Array.isArray(t?.trades)?t.trades.length:0;this.processLoadedData(t,{fileName:i.name||"Imported JSON",source:"json-import"}),this.appendImportLog({type:"success",message:`Imported ${r} trades from ${i.name||"JSON file"}.`,timestamp:new Date})}catch(e){console.error("JSON import error:",e),this.showNotification("Invalid JSON file","error"),this.appendImportLog({type:"error",message:`Failed to import JSON: ${e?.message||"Unknown error"}.`,timestamp:new Date})}finally{this.hideLoadingIndicator()}}));const a=document.getElementById("import-merge-btn");a&&a.addEventListener("click",e=>{e.preventDefault(),this.mergeSelectedImportTrades()});const n=document.getElementById("import-merge-hint-btn");n&&n.addEventListener("click",e=>{e.preventDefault(),this.showView("trades-list"),this.setupTradesMergeControls(),this.toggleTradesMergePanel(!0)}),this.renderImportSummary(),this.refreshImportMergeList(),this.importControlsInitialized=!0}setupTradesMergeControls(){const e=document.getElementById("trades-merge-panel");if(e){if(!this.tradesMergeInitialized){const t=document.getElementById("trades-merge-btn");t&&t.addEventListener("click",e=>{e.preventDefault(),this.mergeSelectedTradesFromList()});const i=document.getElementById("trades-select-all");i&&i.addEventListener("change",e=>{this.handleSelectAllTrades(Boolean(e.target.checked))});const r=document.getElementById("trades-merge-toggle");r&&r.addEventListener("click",e=>{e.preventDefault(),this.toggleTradesMergePanel()}),e.classList.add("is-collapsed"),e.setAttribute("aria-hidden","true"),this.tradesMergePanelOpen=!1,this.tradesMergeInitialized=!0}this.updateTradesMergeToggleLabel(),this.updateMergeColumnVisibility(),this.syncSelectAllCheckbox(),this.refreshTradesMergePanelContents()}}toggleTradesMergePanel(e=null){const t="boolean"==typeof e?e:!this.tradesMergePanelOpen;this.tradesMergePanelOpen=t;const i=document.getElementById("trades-merge-panel");i&&(i.classList.toggle("is-collapsed",!t),i.setAttribute("aria-hidden",String(!t))),this.updateTradesMergeToggleLabel(),this.updateMergeColumnVisibility(),this.syncSelectAllCheckbox(),this.refreshTradesMergePanelContents()}updateTradesMergeToggleLabel(){const e=document.getElementById("trades-merge-toggle");if(!e)return;const t=Boolean(this.tradesMergePanelOpen);e.textContent=t?"Hide Merge Trades":"Merge Trades",e.setAttribute("aria-expanded",String(t)),e.classList.toggle("is-active",t)}updateMergeColumnVisibility(){const e=!this.tradesMergePanelOpen,t=document.querySelector(".trade-select-header");t&&(t.classList.toggle("is-hidden",e),t.setAttribute("aria-hidden",String(e)));const i=document.getElementById("trades-select-all");i&&(e&&(i.checked=!1,i.indeterminate=!1),i.disabled=e),document.querySelectorAll(".trade-select-cell").forEach(t=>{t.classList.toggle("is-hidden",e)}),document.querySelectorAll(".trade-merge-checkbox").forEach(t=>{t.disabled=e,t.tabIndex=e?-1:0})}refreshTradesMergePanelContents(){const e=document.getElementById("trades-merge-summary"),t=document.getElementById("trades-merge-groups"),i=document.getElementById("trades-merge-btn");if(!this.tradesMergePanelOpen)return e&&(e.textContent='Select "Merge Trades" to analyze possible combinations grouped by ticker.'),t&&(t.innerHTML='<p class="trades-merge-groups__empty">Enable the merge panel to review grouped trades.</p>'),void(i&&(i.disabled=!0,i.textContent="Merge Selected Trades",i.title="Enable the merge panel to review trade combinations."));i&&(i.title="Merge selected trades that share a ticker."),this.renderTradeMergeSelectionSummary(),this.renderTradeMergeGroups(this.currentFilteredTrades),this.updateTradesMergeButtonState()}appendImportLog(e={}){const t=e.timestamp instanceof Date?e.timestamp:new Date,i=e.type||"info",r=e.message||"";r&&(this.importLog=[{timestamp:t,type:i,message:r},...this.importLog].slice(0,12),this.renderImportLog())}renderImportLog(){const e=document.getElementById("import-log");if(!e)return;if(!Array.isArray(this.importLog)||0===this.importLog.length)return void(e.innerHTML="<p>No imports recorded yet.</p>");const t=new Intl.DateTimeFormat("en-US",{dateStyle:"medium",timeStyle:"short"});e.innerHTML=this.importLog.map(e=>{const i=t.format(e.timestamp);return`<div class="import-log__entry"><strong>${"error"===e.type?"Error":"success"===e.type?"Success":"Info"} · ${i}</strong><span>${this.escapeHTML(e.message)}</span></div>`}).join("")}updateImportSummary(e={}){const t={timestamp:e.timestamp instanceof Date?e.timestamp:new Date(e.timestamp||Date.now()),fileName:e.fileName||"OFX import",batchId:e.batchId||null,stats:{...e.stats||{}},reviewTradeIds:Array.isArray(e.reviewTradeIds)?e.reviewTradeIds.slice():[],mergedTrades:Number.isFinite(e.mergedTrades)?Number(e.mergedTrades):0};this.importSummary=t,this.importMergeSelection.clear()}renderImportSummary(){const e=document.getElementById("import-summary");if(!e)return;if(!this.importSummary)return void(e.innerHTML='<p class="import-summary__empty">Run an OFX import to see how many trades and legs were created.</p>');const t=this.importSummary,i=t.stats||{},r=t.fileName||"OFX import",a=t.timestamp instanceof Date?t.timestamp:new Date(t.timestamp||Date.now()),n=new Intl.DateTimeFormat("en-US",{dateStyle:"medium",timeStyle:"short"}),s=Number.isNaN(a.getTime())?"—":n.format(a),o=e=>{const t=Number(e);return Number.isFinite(t)?this.formatNumber(t,{decimals:0,useGrouping:!0})??"0":null==e?"0":e.toString()},l=(i.legsAddedToNewTrades||0)+(i.legsAddedToUpdates||0),c=this.countImportReviewTrades(t.batchId),d=this.countImportReviewTrades(),u=[{label:"Transactions processed",value:i.totalTransactions??0},{label:"Trades created",value:i.totalTradesCreated??(i.tradesCreated||0)+(i.reviewTradesCreated||0)},{label:"Trades updated",value:i.tradesUpdated??0},{label:t.batchId?"Review trades (this import)":"Review trades pending",value:c},{label:"Legs imported",value:l},{label:"Duplicate legs skipped",value:i.duplicateLegs??0}];(t.mergedTrades||0)>0&&u.push({label:"Manual merges",value:t.mergedTrades}),t.batchId&&d>c&&u.push({label:"Review trades (all)",value:d}),e.innerHTML=`\n            <div class="import-summary__meta">\n                <span title="Imported file">${this.escapeHTML(r)}</span>\n                <span title="Imported at">${this.escapeHTML(s)}</span>\n            </div>\n            <div class="import-summary__grid">\n                ${u.map(e=>`\n                    <div class="import-summary__item">\n                        <span class="import-summary__value">${this.escapeHTML(o(e.value))}</span>\n                        <span class="import-summary__label">${this.escapeHTML(e.label)}</span>\n                    </div>\n                `).join("")}\n            </div>\n        `}countImportReviewTrades(e=null){return this.trades.filter(t=>!!t?.importReview&&(!e||t.importBatchId===e)).length}getImportReviewTrades(){return this.trades.filter(e=>e?.importReview).slice().sort((e,t)=>{const i=new Date(e.openedDate||e.entryDate||0).getTime();return new Date(t.openedDate||t.entryDate||0).getTime()-i})}refreshImportMergeList(){const e=document.getElementById("import-merge-list"),t=document.getElementById("import-merge-hint"),i=document.getElementById("import-merge-hint-btn"),r=document.getElementById("import-merge-btn"),a=this.getImportReviewTrades();if(a.length){const e=new Set(a.map(e=>e.id));Array.from(this.importMergeSelection).forEach(t=>{e.has(t)||this.importMergeSelection.delete(t)})}else this.importMergeSelection.clear();if(t)if(a.length){const e=1===a.length?"review trade":"review trades";t.textContent=`Detected ${a.length} ${e} that might be combined. Open the All Trades page and enable "Merge Trades" to review them.`}else t.textContent="No review trades require manual merging right now.";if(i&&(a.length?(i.disabled=!1,i.title="Review potential merges on the All Trades page."):(i.disabled=!0,i.title="No merge opportunities detected from the latest import.")),!e)return void(r&&(r.disabled=!0,r.textContent="Merge Selected Trades"));if(!a.length)return e.innerHTML='<p class="import-merge__empty">No review trades are waiting to be merged.</p>',void(r&&(r.disabled=!0,r.textContent="Merge Selected Trades"));const n=new Intl.DateTimeFormat("en-US",{dateStyle:"medium"});e.innerHTML=a.map(e=>{const t=this.importMergeSelection.has(e.id),i=Array.isArray(e.legs)?e.legs.length:0,r=e.openedDate||e.entryDate||"",a=r?new Date(r):null,s=a&&!Number.isNaN(a.getTime())?n.format(a):"—";let o=(e.notes||"").trim();o.length>140&&(o=`${o.slice(0,137)}…`);const l=e.importBatchId?`Batch ${e.importBatchId}`:"Manual Review",c=["import-merge-card"];return t&&c.push("is-selected"),`\n                <div class="${c.join(" ")}" data-trade-id="${this.escapeHTML(e.id)}">\n                    <label class="import-merge-card__label">\n                        <input type="checkbox" value="${this.escapeHTML(e.id)}" ${t?"checked":""} />\n                        <div class="import-merge-card__content">\n                            <div class="import-merge-card__header">\n                                <span class="import-merge-card__ticker">${this.escapeHTML(e.ticker||"—")}</span>\n                                <span class="import-merge-card__legs">${i} leg${1===i?"":"s"}</span>\n                            </div>\n                            <div class="import-merge-card__meta">\n                                <span>${this.escapeHTML(l)}</span>\n                                <span>${this.escapeHTML(s)}</span>\n                            </div>\n                            ${o?`<p class="import-merge-card__notes">${this.escapeHTML(o)}</p>`:""}\n                        </div>\n                    </label>\n                </div>\n            `}).join(""),e.querySelectorAll('input[type="checkbox"]').forEach(e=>{e.addEventListener("change",e=>{const t=e.target,i=t.value;if(!i)return;t.checked?this.importMergeSelection.add(i):this.importMergeSelection.delete(i);const r=t.closest(".import-merge-card");r&&r.classList.toggle("is-selected",t.checked),this.updateImportMergeButtonState()})}),this.updateImportMergeButtonState()}updateImportMergeButtonState(){const e=document.getElementById("import-merge-btn");if(!e)return;const t=this.importMergeSelection.size;e.disabled=t<2,e.textContent=t>=2?`Merge ${t} Trades`:"Merge Selected Trades"}resolveMergedExitReason(e=[]){const t=Array.isArray(e)?e.map(e=>(e?.exitReason||"").toString().trim()).filter(Boolean):[];if(0===t.length)return"";const i=Array.from(new Set(t));return 1===i.length?i[0]:`${i[0]} (+${i.length-1} more)`}buildMergedTradeNote(e=[],t=""){const i=new Date,r=(t||"").toString().trim().replace(/\.*$/,""),a=r?`${r}. `:"",n=Array.isArray(e)?e.length:0,s=`${a}Merged ${n} trade${1===n?"":"s"} on ${i.toLocaleDateString("en-US",{dateStyle:"medium"})} at ${i.toLocaleTimeString("en-US",{timeStyle:"short"})}.`,o=`Source trades: ${e.map(e=>e.id).join(", ")}.`,l=e.map(e=>(e.notes||"").trim()).filter(Boolean);return l.length?`${s} ${o}\n\n${l.join("\n\n")}`:`${s} ${o}`}createMergedTradeFromTrades(e=[],t={}){const i=Array.isArray(e)?e.filter(e=>e&&Array.isArray(e.legs)&&e.legs.length>0):[];if(i.length<2)throw new Error("At least two trades with legs are required to merge.");const r=new Set(i.map(e=>(e.ticker||"").toUpperCase()).filter(Boolean));if(r.size>1)throw new Error("Trades must share the same ticker before merging.");const a=[];let n="string"==typeof t.batchId?t.batchId:null;if(i.forEach(e=>{!n&&e.importBatchId&&(n=e.importBatchId),(e.legs||[]).forEach((t,i)=>{if(!t)return;const r={...t};r.id||(r.id=`LEG-${e.id}-${i}`),n&&!r.importBatchId&&(r.importBatchId=n),a.push(r)})}),!a.length)throw new Error("No legs were found to merge.");const s=`${t.idPrefix||"MERGED"}-${Date.now()}-${Math.random().toString(16).slice(2,6)}`,o=t.baseTrade||i[0],l=r.size?Array.from(r)[0]:"UNKNOWN",c=t.strategyOverride&&t.strategyOverride.toString().trim(),d=i.map(e=>(e.strategy||"").toString().trim()).filter(Boolean),u=d.find(e=>e&&"Import Review"!==e&&"Imported Multi-Leg"!==e),m=d[0]||"Imported Multi-Leg",h=c||u||m,p=this.normalizeUnderlyingType(o?.underlyingType,{fallback:"Stock"}),g=this.normalizeTradeStatusInput(o?.statusOverride);return this.enrichTradeData({id:s,ticker:l,strategy:h,status:o?.status||"Open",statusOverride:g||null,notes:this.buildMergedTradeNote(i,t.notePrefix||""),legs:a,importBatchId:n||null,importReview:!1,exitReason:t.exitReasonOverride||this.resolveMergedExitReason(i),cycleId:o?.cycleId||"",cycleType:o?.cycleType||"",cycleRole:o?.cycleRole||"",underlyingType:p})}mergeSelectedImportTrades(){const e=Array.from(this.importMergeSelection);if(e.length<2)return void this.showNotification("Select at least two review trades to merge.","info");const t=e.map(e=>this.trades.find(t=>t.id===e)).filter(Boolean);if(t.length<2)return this.showNotification("Unable to locate all selected trades. Refresh the list and try again.","error"),void this.refreshImportMergeList();let i;try{i=this.createMergedTradeFromTrades(t,{idPrefix:"IMP-MERGED",notePrefix:"Import review merge"})}catch(e){return void this.showNotification(e.message,"error")}const r=new Set(t.map(e=>e.id));this.trades=this.trades.filter(e=>!r.has(e.id)),this.trades.push(i),this.importSummary&&(this.importSummary.mergedTrades=(this.importSummary.mergedTrades||0)+1,Array.isArray(this.importSummary.reviewTradeIds)&&(this.importSummary.reviewTradeIds=this.importSummary.reviewTradeIds.filter(e=>!r.has(e)))),this.importMergeSelection.clear(),t.forEach(e=>this.tradeMergeSelection.delete(e.id)),this.saveToStorage({fileName:this.currentFileName}),this.markUnsavedChanges(),this.updateDashboard(),"function"==typeof this.updateTradesList&&this.updateTradesList();const a=i.ticker||"Trade";this.appendImportLog({type:"success",message:`Merged ${t.length} review trades into a ${i.legsCount}-leg trade for ${a}.`,timestamp:new Date}),this.showNotification("Review trades merged into a single multi-leg trade.","success"),this.renderImportSummary(),this.refreshImportMergeList(),this.refreshTradesMergePanelContents()}mergeSelectedTradesFromList(){const e=Array.from(this.tradeMergeSelection);if(e.length<2)return void this.showNotification("Select at least two trades to merge.","info");const t=e.map(e=>this.trades.find(t=>t.id===e)).filter(Boolean);if(t.length<2)return this.showNotification("Unable to locate all selected trades. Refresh the table and try again.","error"),void this.pruneTradeMergeSelection();const i=new Set(t.map(e=>(e.ticker||"").toUpperCase()).filter(Boolean));if(1!==i.size)return void this.showNotification("Trades must share the same ticker before merging.","error");const r=Array.from(i)[0],a=t.reduce((e,t)=>e+((t.legs||[]).length||0),0),n=Array.from(new Set(t.map(e=>this.getDisplayStatus(e)))).filter(Boolean),s=t.map(e=>this.parseDateValue(e.entryDate||e.openedDate)).filter(e=>e instanceof Date&&!Number.isNaN(e.getTime())).sort((e,t)=>e.getTime()-t.getTime()),o=new Intl.DateTimeFormat("en-US",{dateStyle:"medium"}),l=s.length?`${o.format(s[0])} - ${o.format(s[s.length-1])}`:"N/A",c=t.reduce((e,t)=>e+Math.max(0,Number(t.openContracts)||0),0),d=[`Merge ${t.length} trades for ${r}?`,`Total legs: ${a}`,`Status mix: ${n.join(", ")||"N/A"}`,`Entry range: ${l}`,`Open contracts (net): ${c}`,"The original trades will be replaced by a single multi-leg trade.","Continue?"].join("\n");if(!window.confirm(d))return;let u;try{u=this.createMergedTradeFromTrades(t,{idPrefix:"MANUAL-MERGED",notePrefix:"Manual merge"})}catch(e){return void this.showNotification(e.message,"error")}const m=new Set(t.map(e=>e.id));this.trades=this.trades.filter(e=>!m.has(e.id)),this.trades.push(u),this.importSummary&&(this.importSummary.mergedTrades=(this.importSummary.mergedTrades||0)+1),this.tradeMergeSelection.clear(),this.saveToStorage({fileName:this.currentFileName}),this.markUnsavedChanges(),this.filterTrades(),this.updateDashboard(),this.renderImportSummary(),this.refreshImportMergeList(),this.appendImportLog({type:"success",message:`Merged ${t.length} trades into a ${u.legsCount}-leg trade for ${u.ticker}.`,timestamp:new Date}),this.showNotification(`Merged ${t.length} trades for ${u.ticker}.`,"success")}renderTradeMergeSelectionSummary(){const e=document.getElementById("trades-merge-summary");if(!e)return;const t=Array.from(this.tradeMergeSelection);if(!t.length)return void(e.textContent="Select two or more trades with the same ticker to enable merging.");const i=t.map(e=>this.trades.find(t=>t.id===e)).filter(Boolean);if(!i.length)return this.tradeMergeSelection.clear(),void(e.textContent="Select two or more trades with the same ticker to enable merging.");const r=Array.from(new Set(i.map(e=>(e.ticker||"").toUpperCase()).filter(Boolean))),a=i.reduce((e,t)=>e+((t.legs||[]).length||0),0),n=Array.from(new Set(i.map(e=>this.getDisplayStatus(e)))).filter(Boolean),s=[`<strong>${this.escapeHTML(`${i.length} trade${1===i.length?"":"s"} selected`)}</strong>`,r.length?`<span>${this.escapeHTML(1===r.length?`Ticker: ${r[0]}`:`Tickers: ${r.join(", ")}`)}</span>`:"",`<span>${this.escapeHTML(`Total legs: ${a}`)}</span>`,n.length?`<span>${this.escapeHTML(`Status mix: ${n.join(", ")}`)}</span>`:""];r.length>1&&s.push(`<span>${this.escapeHTML("Different tickers selected - merge disabled")}</span>`),e.innerHTML=s.filter(Boolean).join(" ")}renderTradeMergeGroups(e=this.currentFilteredTrades){const t=document.getElementById("trades-merge-groups");if(!t)return;const i=(Array.isArray(e)?e:[]).reduce((e,t)=>{const i=(t.ticker||"").toUpperCase();return i?(e.has(i)||e.set(i,[]),e.get(i).push(t),e):e},new Map),r=Array.from(i.entries()).filter(([,e])=>e.length>=2).sort(([e],[t])=>e.localeCompare(t));r.length?(t.innerHTML=r.map(([e,t])=>{const i=t.filter(e=>this.tradeMergeSelection.has(e.id)).length,r=Array.from(new Set(t.map(e=>this.getDisplayStatus(e)))).filter(Boolean),a=t.reduce((e,t)=>e+((t.legs||[]).length||0),0),n=i===t.length,s=t.length-i,o=n?`Clear ${e} selection`:s===t.length?`Select ${t.length} trades`:`Select remaining (${s})`;return`\n                <div class="trades-merge-group" data-ticker="${this.escapeHTML(e)}">\n                    <div class="trades-merge-group__header">\n                        <span class="trades-merge-group__ticker">${this.escapeHTML(e)}</span>\n                        <span class="trades-merge-group__count">${this.escapeHTML(`${t.length} trades • ${a} legs`)}</span>\n                    </div>\n                    <div class="trades-merge-group__body">\n                        ${r.length?`<span>Statuses: ${this.escapeHTML(r.join(", "))}</span>`:""}\n                        <span>Selected: ${this.escapeHTML(`${i}/${t.length}`)}</span>\n                    </div>\n                    <div class="trades-merge-group__actions">\n                        <button type="button" class="btn btn--sm btn--secondary trades-merge-group__toggle" data-ticker="${this.escapeHTML(e)}">${this.escapeHTML(o)}</button>\n                    </div>\n                </div>\n            `}).join(""),t.querySelectorAll(".trades-merge-group__toggle").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const i=(e.getAttribute("data-ticker")||"").toUpperCase();if(!i)return;const r=(Array.isArray(this.currentFilteredTrades)?this.currentFilteredTrades:[]).filter(e=>(e.ticker||"").toUpperCase()===i);if(!r.length)return;const a=r.every(e=>this.tradeMergeSelection.has(e.id));r.forEach(e=>{a?this.tradeMergeSelection.delete(e.id):this.tradeMergeSelection.add(e.id)}),this.syncTradeSelectionCheckboxes(),this.refreshTradesMergePanelContents()})})):t.innerHTML='<p class="trades-merge-groups__empty">Need at least two trades sharing a ticker to merge.</p>'}updateTradesMergeButtonState(){const e=document.getElementById("trades-merge-btn");if(!e)return;if(!this.tradesMergePanelOpen)return e.disabled=!0,e.textContent="Merge Selected Trades",void(e.title="Enable the merge panel to review trade combinations.");const t=Array.from(this.tradeMergeSelection).map(e=>this.trades.find(t=>t.id===e)).filter(Boolean);if(t.length<2)return e.disabled=!0,e.textContent="Merge Selected Trades",void(e.title="Select at least two trades to merge.");const i=new Set(t.map(e=>(e.ticker||"").toUpperCase()).filter(Boolean));if(1!==i.size)return e.disabled=!0,e.textContent="Merge Selected Trades",void(e.title="Select trades that share the same ticker.");e.disabled=!1,e.textContent=`Merge ${t.length} Trades`,e.title=`Merge ${t.length} trades for ${Array.from(i)[0]}.`}syncTradeSelectionCheckboxes(){document.querySelectorAll(".trade-merge-checkbox").forEach(e=>{const t=e.dataset.tradeId;e.checked=!!t&&this.tradeMergeSelection.has(t)}),this.syncSelectAllCheckbox()}syncSelectAllCheckbox(){const e=document.getElementById("trades-select-all");if(!e)return;const t=Array.from(document.querySelectorAll(".trade-merge-checkbox"));if(!(this.tradesMergePanelOpen&&t.length))return e.checked=!1,e.indeterminate=!1,void(e.disabled=!0);e.disabled=!1;const i=t.filter(e=>{const t=e.dataset.tradeId;return t&&this.tradeMergeSelection.has(t)}).length;0===i?(e.checked=!1,e.indeterminate=!1):i===t.length?(e.checked=!0,e.indeterminate=!1):(e.checked=!1,e.indeterminate=!0)}handleSelectAllTrades(e){if(!this.tradesMergePanelOpen)return;const t=Array.from(document.querySelectorAll(".trade-merge-checkbox"));t.length&&(t.forEach(t=>{const i=t.dataset.tradeId;i&&(e?this.tradeMergeSelection.add(i):this.tradeMergeSelection.delete(i),t.checked=e)}),this.syncSelectAllCheckbox(),this.refreshTradesMergePanelContents())}pruneTradeMergeSelection(){if(!(this.tradeMergeSelection instanceof Set)||0===this.tradeMergeSelection.size)return;const e=new Set(this.trades.map(e=>e.id));let t=!1;this.tradeMergeSelection.forEach(i=>{e.has(i)||(this.tradeMergeSelection.delete(i),t=!0)}),t&&(this.syncTradeSelectionCheckboxes(),this.refreshTradesMergePanelContents())}async handleOfxFileSelection(e){const t=e?.target;if(!t||!t.files||0===t.files.length)return;const[i]=t.files;if(t.value="",i)try{this.showLoadingIndicator("Importing OFX..."),await this.importOfxFile(i,{fileName:i.name||"OFX import"})}catch(e){console.error("OFX import error:",e);const t=e?.message||"Unknown error";this.showNotification(`Failed to import OFX: ${t}`,"error"),this.appendImportLog({type:"error",message:`Failed to import ${i.name||"OFX file"}: ${t}`,timestamp:new Date})}finally{this.hideLoadingIndicator()}}async importOfxFile(e,t={}){if(!e)throw new Error("No file selected.");const i=await e.text();await this.importOfxContent(i,{...t,fileSize:e.size||0})}async importOfxContent(e,t={}){const i=t.batchId||`OFX-${Date.now()}-${Math.random().toString(16).slice(2,8)}`,r={...t,batchId:i},a=this.parseOfx(e),n=this.buildOfxImportPayload(a,r);this.applyOfxImportResult(n,r)}parseOfx(e){if("string"!=typeof e)throw new Error("OFX payload is invalid.");const t=e.indexOf("<OFX");if(-1===t)throw new Error("Invalid OFX file: missing OFX root.");const i=e.slice(t).trim(),r=(new DOMParser).parseFromString(i,"application/xml");if(r.querySelector("parsererror"))throw new Error("Unable to parse OFX document.");const a=this.extractOfxSecurities(r);return{securities:a,transactions:this.extractOfxTransactions(r,a)}}extractOfxSecurities(e){const t=new Map,i=e.getElementsByTagName("SECLIST")[0];if(!i)return t;const r=(e,t)=>{if(!e)return"";const i=e.getElementsByTagName(t)[0];return i?i.textContent.trim():""};return Array.from(i.children).forEach(e=>{if(!(e instanceof Element))return;const i=e.tagName,a=e.getElementsByTagName("SECINFO")[0];if(!a)return;const n=r(a,"UNIQUEID");if(!n)return;const s=r(a,"TICKER"),o=r(a,"SECNAME"),l={id:n,tag:i,ticker:s,name:o,option:null};if("OPTINFO"===i){const t=r(e,"STRIKEPRICE"),i=r(e,"SHPERCTRCT"),a=r(e,"DTEXPIRE"),n=r(e,"OPTTYPE"),c=this.parseOptionContractSymbol(s||o),d=this.parseOfxDate(a);l.option={underlying:c?.underlying||(s?s.split(" ")[0].trim():""),type:(n||c?.type||"").toUpperCase(),strike:t?Number(t):c?.strike??null,expiration:d?d.toISOString().slice(0,10):c?.expiration||"",multiplier:i?Number(i):c?.multiplier??100}}t.set(n,l)}),t}parseOptionContractSymbol(e=""){const t=(e||"").toString().replace(/\s+/g,"").toUpperCase().match(/^([A-Z]{1,6})(\d{6})([CP])(\d{8})/);if(!t)return null;const i=t[1],r=t[2],a=t[3],n=t[4],s=this.parseOfxDate(r),o=Number(parseInt(n,10)/1e3);return{underlying:i,expiration:s?s.toISOString().slice(0,10):"",type:"P"===a?"PUT":"CALL",strike:o,multiplier:100}}parseOfxDate(e){if(!e)return null;const t=e.toString().replace(/[^0-9]/g,"");if(!t)return null;if(6===t.length){const e=Number(t.slice(0,2));if(!Number.isFinite(e))return null;const i=e>=70?1900+e:2e3+e,r=Number(t.slice(2,4))-1,a=Number(t.slice(4,6)),n=new Date(Date.UTC(i,r,a));return Number.isNaN(n.getTime())?null:n}if(t.length>=8){const e=Number(t.slice(0,4)),i=Number(t.slice(4,6))-1,r=Number(t.slice(6,8)),a=t.length>=10?Number(t.slice(8,10)):0,n=t.length>=12?Number(t.slice(10,12)):0,s=t.length>=14?Number(t.slice(12,14)):0,o=new Date(Date.UTC(e,i,r,a,n,s));return Number.isNaN(o.getTime())?null:o}return null}mapOfxOrderType(e,t,i=0){const r=(t||"").toString().trim().toUpperCase();switch(e){case"BUYOPT":return"BUYTOCLOSE"===r?"BTC":"BTO";case"SELLOPT":return"SELLTOCLOSE"===r?"STC":"STO";case"BUYSTOCK":return"BUYTOCOVER"===r?"BTC":"BTO";case"SELLSTOCK":return"SELLSHORT"===r?"STO":"SELLTOCLOSE"===r?"STC":i<0?"STO":"STC";default:return"BTO"}}extractOfxTransactions(e,t){const i=[],r=e.getElementsByTagName("INVTRANLIST")[0];if(!r)return i;const a=(e,t)=>{if(!e)return"";const i=e.getElementsByTagName(t)[0];return i?i.textContent.trim():""};return Array.from(r.children).forEach(e=>{if(!(e instanceof Element))return;const r=e.tagName;if(!["BUYOPT","SELLOPT","BUYSTOCK","SELLSTOCK"].includes(r))return;const n="BUYOPT"===r||"BUYSTOCK"===r?e.getElementsByTagName("INVBUY")[0]:e.getElementsByTagName("INVSELL")[0];if(!n)return;const s=n.getElementsByTagName("INVTRAN")[0],o=a(s,"FITID")||a(e,"FITID"),l=this.sanitizeFitId(o);if(!l)return;const c=a(s,"DTTRADE")||a(e,"DTTRADE"),d=this.parseOfxDate(c),u=d?d.toISOString().slice(0,10):"",m=(c||"").replace(/[^0-9]/g,""),h=m.length>=14?m.slice(0,14):m.slice(0,8)||u.replace(/-/g,""),p=a(n,"UNIQUEID"),g=p?t.get(p):null,y=Number(a(n,"UNITS")||"0"),f=Number(a(n,"UNITPRICE")||"0"),b=Number(a(n,"TOTAL")||"0"),C=Number(a(n,"COMMISSION")||"0"),S=a(e,"BUYOPT"===r?"OPTBUYTYPE":"SELLOPT"===r?"OPTSELLTYPE":"BUYSTOCK"===r?"BUYTYPE":"SELLTYPE"),L=this.mapOfxOrderType(r,S,y),T=this.mapOrderTypeToActionSide(L),N=r.includes("OPT");let I="",v="",x=null,D="",k=N?100:1,E="";if(g&&g.option)I=(g.option.underlying||"").toUpperCase(),v=g.option.type||"",x=Number.isFinite(Number(g.option.strike))?Number(g.option.strike):null,D=g.option.expiration||"",k=g.option.multiplier||k,E=I;else if(g){if(E=(g.ticker||g.name||"").split(" ")[0].trim().toUpperCase(),N){const e=this.parseOptionContractSymbol(g.ticker||g.name||"");e&&(I=e.underlying.toUpperCase(),v=e.type,x=e.strike,D=e.expiration,k=e.multiplier||k,E=I)}else I=E}E||(E=(I||"").toUpperCase());const w=(I||E||"").toUpperCase(),A=N?"OPTION":"STOCK",P=[h||u.replace(/-/g,""),w,T.side,A];N&&P.push(D||"");const F=P.filter(Boolean).join("|")||l;i.push({fitId:l,originalFitId:o,groupKey:F,tag:r,orderType:L,tradeDate:u,tradeTimeKey:h,ticker:E,underlying:(I||E||"").toUpperCase(),optionType:v||(N?S&&S.includes("CALL")?"CALL":"PUT":""),strike:x,expiration:D,multiplier:k||(N?100:1),quantity:Math.abs(y),price:Math.abs(f),total:b,fees:Math.abs(C),side:T.side,action:T.action,category:N?"OPTION":"STOCK",securityId:p,memo:a(s,"MEMO")||"",currency:a(n,"CURSYM")||a(e,"CURSYM")||"USD"})}),i}sanitizeFitId(e){return e?e.toString().replace(/[^A-Za-z0-9]/g,""):""}groupTransactionsForImport(e=[]){const t=new Map;return e.forEach(e=>{if(!e||!e.groupKey)return;let i=t.get(e.groupKey);i||(i={key:e.groupKey,ticker:(e.underlying||e.ticker||"").toUpperCase(),transactions:[]},t.set(e.groupKey,i)),i.ticker||!e.underlying&&!e.ticker||(i.ticker=(e.underlying||e.ticker||"").toUpperCase()),i.transactions.push(e)}),t}buildLegFromTransaction(e){if(!e)return null;const t=Math.abs(Number(e.quantity)||0);if(!t)return null;const i=e.optionType||("STOCK"===e.category?"STOCK":"UNKNOWN");return{id:e.fitId?`FIT-${e.fitId}`:`LEG-${Date.now()}-${Math.random().toString(16).slice(2,6)}`,orderType:e.orderType,action:e.action,side:e.side,type:i,quantity:t,multiplier:e.multiplier||("STOCK"===i?1:100),executionDate:e.tradeDate||"",expirationDate:e.expiration||"",strike:Number.isFinite(Number(e.strike))?Number(e.strike):null,premium:Number.isFinite(Number(e.price))?Number(e.price):0,fees:Number.isFinite(Number(e.fees))?Number(e.fees):0,underlyingPrice:null,fitId:e.fitId||null,importGroupId:e.groupKey||null,importSource:"OFX",tickerSymbol:(e.underlying||e.ticker||"").toUpperCase()}}sanitizeImportedLeg(e){if(!e)return null;const t={...e};return delete t.tickerSymbol,t}buildPositionKey(e,t){if(!t)return"";const i=(e||"").toString().trim().toUpperCase();if(!i)return"";const r=(t.type||"").toString().trim().toUpperCase();if(!r)return"";const a="SELL"===this.normalizeLegAction(t.action)?"short":"long";if("STOCK"===r)return[i,r,a].join("|");return[i,r,(Number.isFinite(Number(t.strike))?Number(t.strike):0)||0,(t.expirationDate||"").toString().trim()||"",a].join("|")}buildPositionIndex(e=[]){const t=new Map;return e.forEach(e=>{if(!e||!Array.isArray(e.legs)||0===e.legs.length)return;const i=(e.ticker||"").toUpperCase();if(!i)return;const r=new Map;e.legs.forEach(e=>{if(!e)return;const t=this.buildPositionKey(i,e);if(!t)return;const a=Math.abs(Number(e.quantity)||0);if(!a)return;let n=0;if("OPEN"===e.side?n=1:"CLOSE"===e.side&&(n=-1),!n)return;const s=r.get(t)||0;r.set(t,s+n*a)}),r.forEach((i,r)=>{if(i>0){const a=t.get(r)||[];a.push({trade:e,remaining:i}),t.set(r,a)}})}),t}consumePositionMatches(e,t,i){const r={matched:[],unmatched:Math.abs(Number(i?.quantity)||0)};if(!t||!e.has(t)||!i)return r;let a=r.unmatched;const n=e.get(t)||[];n.forEach(e=>{if(a<=0||e.remaining<=0)return;const t=Math.min(e.remaining,a);r.matched.push({trade:e.trade,quantity:t}),e.remaining-=t,a-=t}),r.unmatched=a;const s=n.filter(e=>e.remaining>0);return s.length>0?e.set(t,s):e.delete(t),r}buildExistingFitIdSet(){const e=new Set;return this.trades.forEach(t=>{t&&Array.isArray(t.legs)&&t.legs.forEach(t=>{t?.fitId&&e.add(t.fitId)})}),e}tradeContainsFitId(e,t){return!!(t&&e&&Array.isArray(e.legs))&&e.legs.some(e=>e?.fitId&&e.fitId===t)}inferStrategyFromLegs(e=[]){if(!Array.isArray(e)||0===e.length)return"Imported Trade";const t=e.filter(e=>"OPEN"===e.side),i=t.length?t:e;if(1===i.length){const e=i[0];if(!e)return"Imported Trade";if("PUT"===e.type)return"SELL"===e.action?"Cash-Secured Put":"Long Put";if("CALL"===e.type)return"SELL"===e.action?"Short Call":"Long Call";if("STOCK"===e.type)return"SELL"===e.action?"Stock Sale":"Stock Purchase"}const r=i.filter(e=>"PUT"===e.type||"CALL"===e.type);if(2===r.length){const[e,t]=r;if(e&&t&&e.type===t.type){const e=r.find(e=>"SELL"===e.action);if(e){const t=r.find(t=>t!==e);if(t){const i=Number(e.strike)||0,r=Number(t.strike)||0;return"PUT"===e.type?i>r?"Bull Put Spread":"Bear Put Spread":i<r?"Bear Call Spread":"Bull Call Spread"}}}}return"Imported Multi-Leg"}composeImportNotes(e={},t={}){const i=e.fileName||"OFX file",r=new Date,a=[`Imported from ${i} on ${r.toLocaleDateString("en-US",{dateStyle:"medium"})} at ${r.toLocaleTimeString("en-US",{timeStyle:"short"})}.`];return t.legCount&&a.push(`${t.legCount} leg${1===t.legCount?"":"s"} detected.`),t.hasClosings&&a.push("Includes adjustments to existing positions."),t.note&&a.push(t.note),a.join(" ")}buildOfxImportPayload(e,t={}){const i=Array.isArray(e?.transactions)?e.transactions:[],r=t.batchId||null,a=new Map,n=[],s=[],o={totalTransactions:i.length,totalGroups:0,openingLegs:0,closingLegs:0,matchedClosingLegs:0,unmatchedClosingLegs:0,duplicateLegs:0,legsAddedToUpdates:0,legsAddedToNewTrades:0,tradesCreated:0,reviewTradesCreated:0,totalTradesCreated:0,tradesUpdated:0,reviewLegs:0};if(!i.length)return{newTrades:n,updates:a,stats:o,batchId:r,reviewTradeIds:s};const l=this.groupTransactionsForImport(i),c=this.buildPositionIndex(this.trades),d=this.buildExistingFitIdSet(),u=new Set;return o.totalGroups=l.size,l.forEach(e=>{if(!e||!Array.isArray(e.transactions)||0===e.transactions.length)return;const i=[];if(e.transactions.forEach(e=>{const t=this.buildLegFromTransaction(e);t&&(t.fitId&&(d.has(t.fitId)||u.has(t.fitId))?o.duplicateLegs+=1:(r&&(t.importBatchId=r),i.push(t)))}),!i.length)return;const l=(e.ticker||i[0]?.tickerSymbol||"").toUpperCase(),m=i.filter(e=>"OPEN"===e.side),h=i.filter(e=>"CLOSE"===e.side),p=[];if(o.openingLegs+=m.length,o.closingLegs+=h.length,h.forEach(e=>{const t=this.buildPositionKey(l,e),i=this.consumePositionMatches(c,t,e);i.matched.length&&i.matched.forEach(t=>{const i=t.trade;if(this.tradeContainsFitId(i,e.fitId))return;if(e.fitId&&(d.has(e.fitId)||u.has(e.fitId)))return;const n=a.get(i.id)||[],s={...e,quantity:t.quantity};r&&(s.importBatchId=r),n.push(this.sanitizeImportedLeg(s)),a.set(i.id,n),o.legsAddedToUpdates+=1,o.matchedClosingLegs+=t.quantity});const n=Math.max(0,i.unmatched);if(!i.matched.length||n>0){const t={...e};n>0&&t.quantity!==n&&(t.quantity=n),i.matched.length&&t.fitId&&(t.fitId=`${t.fitId}-UNMATCHED`),r&&(t.importBatchId=r),p.push(t),o.unmatchedClosingLegs+=t.quantity||0}e.fitId&&u.add(e.fitId)}),m.length>0){const e=this.composeImportNotes(t,{legCount:m.length,hasClosings:h.length>0}),i=m.map(e=>(e.fitId&&u.add(e.fitId),this.sanitizeImportedLeg(e))),a=(l||m[0]?.tickerSymbol||"").toUpperCase()||"UNKNOWN",s=`IMP-${Date.now()}-${Math.random().toString(16).slice(2,8)}`;n.push({id:s,ticker:a,strategy:this.inferStrategyFromLegs(m),exitReason:"",notes:e,legs:i,cycleId:"",cycleType:"",cycleRole:"",importBatchId:r,importReview:!1}),o.tradesCreated+=1,o.legsAddedToNewTrades+=i.length}if(p.length>0){const e=this.composeImportNotes(t,{legCount:p.length,note:"Review required: closing legs have no matching open position."}),i=p.map(e=>(e.fitId&&u.add(e.fitId),this.sanitizeImportedLeg(e))),a=(l||p[0]?.tickerSymbol||"").toUpperCase()||"UNKNOWN",c=`IMP-REVIEW-${Date.now()}-${Math.random().toString(16).slice(2,8)}`;n.push({id:c,ticker:a,strategy:"Import Review",exitReason:"",notes:e,legs:i,cycleId:"",cycleType:"",cycleRole:"",importBatchId:r,importReview:!0}),s.push(c),o.reviewTradesCreated+=1,o.legsAddedToNewTrades+=i.length}}),o.totalTradesCreated=n.length,o.tradesUpdated=a.size,o.reviewLegs=n.filter(e=>e.importReview).reduce((e,t)=>e+(t.legs||[]).length,0),{newTrades:n,updates:a,stats:o,batchId:r,reviewTradeIds:s}}applyOfxImportResult(e,t={}){if(!e)return;const i=e.stats||{},r=e.batchId||t.batchId||null,a=Array.isArray(e.reviewTradeIds)?e.reviewTradeIds.slice():[];let n=0,s=0;e.updates instanceof Map&&e.updates.forEach((e,i)=>{if(!Array.isArray(e)||0===e.length)return;const r=this.trades.findIndex(e=>e.id===i);if(-1===r)return;const a=this.trades[r],n=[...a.legs,...e.map(e=>({...e}))],o=this.composeImportNotes(t,{legCount:e.length,note:"Existing trade updated from OFX import."}),l=this.enrichTradeData({...a,legs:n,notes:a.notes?`${a.notes}\n${o}`:o});this.trades[r]=l,s+=1}),Array.isArray(e.newTrades)&&e.newTrades.forEach(e=>{if(!e||!Array.isArray(e.legs)||0===e.legs.length)return;e.importReview&&!a.includes(e.id)&&a.push(e.id);const t=this.enrichTradeData(e);this.trades.push(t),n+=1});const o=t?.fileName||"OFX file";if(i.totalTradesCreated=i.totalTradesCreated??n,i.tradesUpdated=s,i.reviewTradesCreated=i.reviewTradesCreated??a.length,n||s){this.saveToStorage(),this.markUnsavedChanges(),this.updateDashboard();const e=[];n&&e.push(`${n} new trade${1===n?"":"s"}`),s&&e.push(`${s} trade${1===s?"":"s"} updated`);const t=e.length?`OFX import completed: ${e.join(", ")}.`:"OFX import completed.";this.showNotification(t,"success"),this.appendImportLog({type:"success",message:`${t} Source: ${o}.`,timestamp:new Date})}else this.showNotification("OFX import completed. No changes detected.","info"),this.appendImportLog({type:"info",message:`OFX import from ${o} completed with no changes.`,timestamp:new Date});this.updateImportSummary({fileName:o,batchId:r,stats:i,reviewTradeIds:a,timestamp:new Date}),this.renderImportSummary(),this.refreshImportMergeList(),this.initializeAIChat()}processLoadedData(e,t={}){if(!e||!Array.isArray(e.trades))throw new Error("Invalid data format");this.trades=e.trades.map(e=>{const t={...e};return t.tradeReasoning&&!t.notes&&(t.notes=t.tradeReasoning,delete t.tradeReasoning),this.enrichTradeData(t)}),t.fileName?this.currentFileName=t.fileName:this.currentFileName||(this.currentFileName="Unsaved Database"),this.hasUnsavedChanges=!1,this.updateUnsavedIndicator(),this.saveToStorage({fileName:this.currentFileName,source:t.source||"import"}),this.updateDashboard(),"trades-list"===this.currentView&&this.updateTradesList(),this.updateFileNameDisplay(),this.initializeAIChat(),this.importSummary=null,this.importMergeSelection.clear(),this.renderImportSummary(),this.refreshImportMergeList()}newDatabase(){this.hasUnsavedChanges&&!confirm("You have unsaved changes. Are you sure you want to create a new database?")||(this.trades=[],this.currentFileHandle=null,this.currentFileName="Unsaved Database",this.hasUnsavedChanges=!1,this.updateFileNameDisplay(),this.updateUnsavedIndicator(),this.saveToStorage({fileName:this.currentFileName}),this.updateDashboard(),this.showNotification("New database created","success"),this.initializeAIChat())}updateFileNameDisplay(){const e=document.getElementById("current-file-name");e&&(e.textContent=this.currentFileName,"Unsaved Database"===this.currentFileName?e.classList.add("is-unsaved"):e.classList.remove("is-unsaved"))}updateUnsavedIndicator(){const e=document.getElementById("unsaved-indicator");this.hasUnsavedChanges?e.classList.remove("hidden"):e.classList.add("hidden")}showLoadingIndicator(e="Loading..."){const t=document.getElementById("loading-indicator");t&&(t.textContent=e,t.classList.remove("hidden"))}hideLoadingIndicator(){const e=document.getElementById("loading-indicator");e&&e.classList.add("hidden")}showNotification(e,t="info"){"error"===t?alert(`Error: ${e}`):console.log(`${t.toUpperCase()}: ${e}`)}markUnsavedChanges(){this.hasUnsavedChanges=!0,this.updateUnsavedIndicator()}saveToStorage(e={}){try{const t={version:"2.5",timestamp:(new Date).toISOString(),fileName:e.fileName||this.currentFileName||"Unsaved Database",trades:this.getStorageTrades()};localStorage.setItem(LOCAL_STORAGE_KEY,JSON.stringify(t)),LEGACY_STORAGE_KEYS.forEach(e=>{e&&e!==LOCAL_STORAGE_KEY&&localStorage.removeItem(e)})}catch(e){console.warn("Failed to save to localStorage:",e)}}async loadFromStorage(){try{const e=localStorage.getItem(LOCAL_STORAGE_KEY);if(e){const t=JSON.parse(e);if(t&&Array.isArray(t.trades))return this.trades=t.trades.map(e=>{const t={...e};return t.tradeReasoning&&!t.notes&&(t.notes=t.tradeReasoning),delete t.tradeReasoning,this.enrichTradeData(t)}),t.fileName&&(this.currentFileName=t.fileName),this.currentFileHandle=null,this.hasUnsavedChanges=!1,this.updateUnsavedIndicator(),this.updateFileNameDisplay(),this.updateDashboard(),!0}for(const e of LEGACY_STORAGE_KEYS){if(!e||e===LOCAL_STORAGE_KEY)continue;const t=localStorage.getItem(e);if(!t)continue;const i=JSON.parse(t);if(Array.isArray(i))return this.trades=i.map(e=>{const t={...e};return t.tradeReasoning&&!t.notes&&(t.notes=t.tradeReasoning),delete t.tradeReasoning,this.enrichTradeData(t)}),this.currentFileName="Unsaved Database",this.hasUnsavedChanges=!1,this.updateUnsavedIndicator(),this.saveToStorage({fileName:this.currentFileName}),this.updateFileNameDisplay(),this.updateDashboard(),!0}}catch(e){console.warn("Failed to load from localStorage:",e)}return!1}formatNumber(e,t={}){const i=Number(e);if(!Number.isFinite(i))return null;const r=t.style||"number",a=Number.isInteger(t.decimals)?Math.max(0,t.decimals):2,n=t.currency||"USD",s="currency"===r,o="boolean"==typeof t.useGrouping?t.useGrouping:s,l=(e,t=a)=>new Intl.NumberFormat("en-US",{useGrouping:o,minimumFractionDigits:t,maximumFractionDigits:t}).format(e);if("currency"===r)return new Intl.NumberFormat("en-US",{style:"currency",currency:n,useGrouping:o,minimumFractionDigits:a,maximumFractionDigits:a}).format(i);if("percent"===r){return`${l(i,Number.isInteger(t.decimals)?Math.max(0,t.decimals):a)}%`}return l(i,a)}formatPercent(e,t="—",i={}){const r=Number(e);if(r===Number.POSITIVE_INFINITY)return"Infinite";if(!Number.isFinite(r))return t;const a=Number.isInteger(i.decimals)?Math.max(0,i.decimals):2,n=this.formatNumber(r,{decimals:a,useGrouping:!0});return n?`${n}%`:`${r.toFixed(a)}%`}getStrategyDisplayName(e=""){const t=(e||"").toString().trim();return t?"PMCC"===t.toUpperCase()?"Poor Man's Covered Call":t:""}formatCycleDateRange(e,t,i){if(!e)return"—";const r=new Date(e),a=t?new Date(t):null,n=new Intl.DateTimeFormat("en-US",{month:"short",day:"numeric",year:"numeric"}),s=isNaN(r.getTime())?"—":n.format(r);let o;return o=a&&!isNaN(a.getTime())?n.format(a):i?"Present":"—",o?`${s} — ${o}`:s}escapeHTML(e){return null==e?"":e.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}formatCurrency(e,t={}){const i=Number(e);if(!Number.isFinite(i))return"—";const r=t.currency||"USD",a=Number.isInteger(t.decimals)?Math.max(0,t.decimals):2,n=void 0===t.useGrouping||Boolean(t.useGrouping);return new Intl.NumberFormat("en-US",{style:"currency",currency:r,useGrouping:n,minimumFractionDigits:a,maximumFractionDigits:a}).format(i)}formatDate(e){const t=new Date(e);return isNaN(t.getTime())?"—":t.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}}class LocalInsightsAgent{constructor(e){this.app=e,this.context={stats:null,openTrades:[],closedTrades:[]}}updateContext({stats:e,openTrades:t,closedTrades:i}={}){e&&(this.context.stats=e),Array.isArray(t)&&(this.context.openTrades=t),Array.isArray(i)&&(this.context.closedTrades=i)}hasTradeHistory(){return(this.context.openTrades?.length||0)>0||(this.context.closedTrades?.length||0)>0}getGreeting(){if(!this.hasTradeHistory())return"Hi! I'm your local AI coach. Add or import a few trades and I'll help you analyze risk and performance.";const e=this.context.stats;if(!e)return"Hi! I'm your local AI coach. Ask about performance, risk, or next steps.";const t=this.context.openTrades?.length||0;return`Hi! I'm your local AI coach. You have ${t} active ${1===t?"position":"positions"} and ${this.context.closedTrades?.length||0} closed trades with realised P&L of ${this.formatCurrency(e.totalPL)}.`}generateResponse(e=""){if(!e.trim())return"I can run a portfolio health check, review risk exposure, or suggest strategy adjustments. Try asking for a quick portfolio health check.";if(!this.hasTradeHistory())return"Log a few trades first and I'll start surfacing insights about risk, performance, and strategy.";const t=[],i=this.buildPerformanceSummary();i&&t.push(i);const r=this.buildRiskHeadline();r&&t.push(r);const a=this.buildStrategyHeadline();a&&t.push(a);const n=this.buildCoachingHighlight();return n&&t.push(n),t.length||t.push("Portfolio data is limited, but keep logging trades and I'll highlight trends as they emerge."),t.join("\n\n")}buildPerformanceSummary(){const e=this.context.stats;if(!e)return"";const t=this.context.closedTrades?.length||0;if(!t)return"No closed trades yet. Once you realize some P&L I'll summarize your performance here.";const i=this.formatPercent(e.winRate,"—",{decimals:1}),r=e.profitFactor===Number.POSITIVE_INFINITY?"Infinite":Number.isFinite(e.profitFactor)?e.profitFactor.toFixed(2):"—",a=this.formatPercent(e.totalROI,"—");return`Closed trades: ${t}, realised P&L ${this.formatCurrency(e.totalPL)}, win rate ${i}, profit factor ${r}, total ROI ${a}.`}buildRiskHeadline(){const e=this.context.openTrades||[];if(!e.length)return"No open positions right now, so live risk exposure is minimal.";let t=0,i=0,r=null;if(e.forEach(e=>{const a=Math.max(0,Number(this.app.getCapitalAtRisk(e))||0);t+=a,a>i&&(i=a,r=e)}),!t)return"Open positions detected, but max risk looks minimal based on current data.";if(r&&t){const a=(i/t*100).toFixed(0),n=(r.ticker||"Unknown").toUpperCase();return`Open risk across ${e.length} ${1===e.length?"position":"positions"} is ${this.formatCurrency(t)}. ${n} carries the largest share at ${a}% of exposure.`}return`Open risk across ${e.length} ${1===e.length?"position":"positions"} is ${this.formatCurrency(t)}.`}buildStrategyHeadline(){const e=this.getStrategyBreakdown();if(!e.length)return"";const t=e[0];if(!t)return"";const i=t.trades>0?(t.wins/t.trades*100).toFixed(0):"0";return`${t.name} leads with ${this.formatCurrency(t.pl)} across ${t.trades} trades (win rate ${i}%).`}buildCoachingHighlight(){const e=this.context.stats;if(!e)return"";const t=(this.context.closedTrades||[]).filter(e=>e.pl<0),i=(this.context.closedTrades||[]).filter(e=>e.pl>0),r=(e,t)=>{if(!e.length)return NaN;return e.reduce((e,i)=>e+t(i),0)/e.length},a=r(t,e=>Number(e.daysHeld)||0),n=r(i,e=>Number(e.daysHeld)||0);if(Number.isFinite(a)&&Number.isFinite(n)){const e=a-n;if(e>=2)return`Losing trades stay open about ${Math.round(e)} days longer than winners—tighten exits to cut risk sooner.`;if(e<=-2)return`You let winners run roughly ${Math.round(Math.abs(e))} days longer than losers—keep scaling out to lock in gains.`}return Number.isFinite(e.winRate)&&e.winRate<45&&(this.context.closedTrades?.length||0)>=5?"Win rate is under 45%. Focus on highest-conviction setups or scale size down until consistency improves.":""}getStrategyBreakdown(){const e=new Map;return(this.context.closedTrades||[]).forEach(t=>{const i=(t.strategy||"Unclassified").toString().trim()||"Unclassified";e.has(i)||e.set(i,{name:i,pl:0,trades:0,wins:0,losses:0});const r=e.get(i),a=Number(t.pl)||0;r.pl+=a,r.trades+=1,a>0?r.wins+=1:a<0&&(r.losses+=1)}),Array.from(e.values()).sort((e,t)=>t.pl-e.pl)}formatCurrency(e,t){return this.app.formatCurrency(e,t)}}class GeminiInsightsAgent{constructor(e){this.app=e,this.context={stats:null,openTrades:[],closedTrades:[]},this.fallback=new LocalInsightsAgent(e)}updateContext({stats:e,openTrades:t,closedTrades:i}={}){e&&(this.context.stats=e),Array.isArray(t)&&(this.context.openTrades=t),Array.isArray(i)&&(this.context.closedTrades=i),this.fallback.updateContext({stats:this.context.stats,openTrades:this.context.openTrades,closedTrades:this.context.closedTrades})}getGreeting(){return this.isConfigured()?this.fallback.getGreeting():"Connect your Gemini API key in [Settings](#settings) to get tailored analysis."}isConfigured(){const e=this.app?.gemini;return Boolean(e&&e.apiKey)}async generateResponse(e="",t={}){const i=e.trim();if(!i)return"Ask a question and I'll send it to Gemini along with a snapshot of your portfolio.";if(!this.isConfigured())return"Add a Gemini-compatible API key under [Settings](#settings) to enable AI-powered insights.";try{const e=this.buildRequestPayload(i,t),r=await this.callGemini(e);if(r)return r;throw new Error("Gemini returned an empty response")}catch(t){const i=this.fallback.generateResponse(e),r=t?.message||"Unknown error";return i?`Gemini request failed (${r}). Here's a local snapshot instead:\n\n${i}`:`Gemini request failed (${r}). Try again in a moment.`}}buildRequestPayload(e,t={}){const i=this.app?.gemini||{},r=GEMINI_ALLOWED_MODELS.includes(i.model)?i.model:"gemini-2.5-flash",a=.25,n=this.buildContextBlock(),s=[...this.buildHistoryContents(t.history||[]),{role:"user",parts:[{text:["# ROLE & PHILOSOPHY","You are an expert options trading coach. Your philosophy is rooted in rigorous risk management, capital preservation, and generating consistent returns. You are assisting an intermediate trader who wants to refine their strategy and tighten their risk controls. Your goal is to provide a concise, data-driven portfolio health check that identifies key risks and offers actionable, educational insights.","# CONTEXT: PORTFOLIO DATA",n,"# TRADER'S OBJECTIVE",e,"# ANALYSIS FRAMEWORK & INSTRUCTIONS",'1.  **Acknowledge Strengths:** Briefly highlight the **strong overall performance** (e.g., win rate, profit factor, successful strategies).\n2.  **Prioritize Top Risks:** Scrutinize the data to identify and explain the **top 2-3 risks**. In addition to the systemic risks below, **identify open positions near expiration (low DTE) or those with previous rolls/adjustments (in the "notes") as potential immediate risks.** Focus specifically on:\n    * **Concentration Risk:** Explicitly cite and explain the **`riskHeadline`**.\n    * **Behavioral Risk:** Connect the **`coachingHighlight`** to the risk.\n3.  **Provide Actionable Recommendations:** Based on the identified risks, provide **clear, bulleted recommendations**. Link them directly to the data.\n    * Suggest a specific rule for **position sizing**.\n    * Propose a concrete action to address the **behavioral risk**.\n4.  **Suggest Next Steps:** Conclude with **2-3 forward-looking actions** for process improvement.',"# OUTPUT FORMATTING","- **Tone:** Professional, direct, and risk-aware coach.\n- **Length:** Keep the response under 400 words.\n- **Structure:** Use bullet points for recommendations and next steps.\n- **Disclaimer:** End with a clear statement that this is educational analysis, not financial advice."].join("\n\n")}]}],o={maxOutputTokens:65536};return o.temperature=Number(a.toFixed(2)),{model:r,body:{contents:s,generationConfig:o}}}buildHistoryContents(e){return Array.isArray(e)&&0!==e.length?e.filter(e=>e&&!e.pending&&"string"==typeof e.text&&e.text.trim().length).slice(-8).map(e=>({role:"ai"===e.sender?"model":"user",parts:[{text:e.text.trim()}]})):[]}buildContextBlock(){const e=this.context.stats||{},t={totals:{totalPL:this.formatNumber(e.totalPL,{style:"currency"}),winRate:this.formatNumber(e.winRate,{style:"percent"}),profitFactor:Number.isFinite(e.profitFactor)?this.formatNumber(e.profitFactor):e.profitFactor===Number.POSITIVE_INFINITY?"Infinite":null,totalROI:this.formatNumber(e.totalROI,{style:"percent"}),annualizedROI:this.formatNumber(e.annualizedROI,{style:"percent"}),maxDrawdown:this.formatNumber(e.maxDrawdown,{style:"percent"}),closedTrades:e.closedTrades??(this.context.closedTrades?.length||0),openPositions:e.activePositions??(this.context.openTrades?.length||0)},riskHeadline:this.fallback.buildRiskHeadline(),strategyHighlight:this.fallback.buildStrategyHeadline(),coachingHighlight:this.fallback.buildCoachingHighlight(),performanceHighlight:this.fallback.buildPerformanceSummary?.()||"",openPositions:this.buildOpenPositionsSummary(),recentClosedTrades:this.buildRecentClosedTradesSummary(),topStrategies:this.buildStrategySummary(),cycles:this.buildCycleSummary()};return JSON.stringify(t,null,2)}buildOpenPositionsSummary(e=8){return(Array.isArray(this.context.openTrades)?this.context.openTrades:[]).slice(0,e).map(e=>{const t=this.snapshotObjectForPrompt(e),i={},r=Number.isFinite(e?.dte)?Number(e.dte):this.deriveDTE(e);Number.isFinite(r)&&(i.calculatedDTE=Math.max(Math.round(r),0));const a=Number(this.app.getCapitalAtRisk(e));Number.isFinite(a)&&(i.calculatedMaxRisk=Number(a.toFixed(2)));const n=this.cleanNote(e?.notes);return n&&(i.notePreview=n),Object.keys(i).length&&(t.__promptDerived=i),t})}deriveDTE(e){if(!e?.expirationDate)return null;try{return this.app.calculateDTE(e.expirationDate,e)}catch(e){return null}}buildRecentClosedTradesSummary(e=8){return(Array.isArray(this.context.closedTrades)?[...this.context.closedTrades]:[]).sort((e,t)=>new Date(t.exitDate||0)-new Date(e.exitDate||0)).slice(0,e).map(e=>{const t=this.snapshotObjectForPrompt(e),i={plRounded:this.formatNumber(e?.pl,{style:"currency"}),roiRounded:this.formatNumber(e?.roi,{style:"percent"})},r=this.cleanNote(e?.exitReason);return r&&(i.exitReasonPreview=r),Number.isFinite(e?.daysHeld)&&(i.daysHeld=Number(e.daysHeld)),t.__promptDerived=Object.fromEntries(Object.entries(i).filter(([,e])=>null!=e)),Object.keys(t.__promptDerived).length||delete t.__promptDerived,t})}buildStrategySummary(e=5){return this.fallback.getStrategyBreakdown().slice(0,e).map(e=>({name:e.name,trades:e.trades,wins:e.wins,losses:e.losses,realisedPL:this.formatNumber(e.pl,{style:"currency"}),winRate:e.trades>0?this.formatNumber(e.wins/e.trades*100,{style:"percent"}):null}))}buildCycleSummary(e=3){return(Array.isArray(this.app.cycleAnalytics)&&this.app.cycleAnalytics.length?this.app.cycleAnalytics:this.app.calculateCycleAnalytics()).slice(0,e).map(e=>{const t=this.snapshotObjectForPrompt(e),i={tradeCount:Array.isArray(e?.trades)?e.trades.length:0,totalPLRounded:this.formatNumber(e?.totalPL,{style:"currency"}),roiPercentRounded:this.formatNumber(e?.roiPercent,{style:"percent"}),keyMetricLabel:e?.keyMetricLabel||null,keyMetricValueRounded:this.formatCycleMetricValue(e?.keyMetricValue,e?.keyMetricLabel),timelineLabel:this.app.formatCycleDateRange(e?.startDate,e?.endDate,e?.hasOpenTrade)};return t.__promptDerived=Object.fromEntries(Object.entries(i).filter(([,e])=>null!=e)),Object.keys(t.__promptDerived).length||delete t.__promptDerived,t})}snapshotObjectForPrompt(e){const t=this.snapshotForPrompt(e);return t&&"object"==typeof t&&!Array.isArray(t)?t:{}}snapshotForPrompt(e){if(null==e)return null;if("number"==typeof e)return Number.isFinite(e)?Number(e):null;if("string"==typeof e||"boolean"==typeof e)return e;if(e instanceof Date)return e.toISOString();if(Array.isArray(e))return e.map(e=>this.snapshotForPrompt(e));if("object"==typeof e){const t={};for(const[i,r]of Object.entries(e))"function"!=typeof r&&(t[i]=this.snapshotForPrompt(r));return t}return null}cleanNote(e){if(!e)return"";const t=e.toString().trim();return t.length<=180?t:`${t.slice(0,177)}…`}formatNumber(e,t={}){const i=Object.prototype.hasOwnProperty.call(t||{},"fallback")?t.fallback:null;if(!this.app||"function"!=typeof this.app.formatNumber)return i;const r={...t||{}};if(delete r.fallback,"string"===r.style&&(r.style="number"),"percent"===r.style){const t={};return Number.isInteger(r.decimals)&&(t.decimals=r.decimals),this.app.formatPercent(e,i,t)}return this.app.formatNumber(e,r)??i}formatPercent(e,t,i){return this.app&&"function"==typeof this.app.formatPercent?this.app.formatPercent(e,t,i):t??null}formatCycleMetricValue(e,t=""){const i=(t||"").toString().toLowerCase();return i?/(%|percent|roi|return|drawdown|rate|yield)/.test(i)?this.formatNumber(e,{style:"percent"}):/(\$|pl|p&l|profit|premium|risk|cost|credit|debit|revenue|balance|capital|cash|amount|value|exposure|loss)/.test(i)?this.formatNumber(e,{style:"currency"}):this.formatNumber(e):this.formatNumber(e)}async callGemini({model:e,body:t}){const i=this.app?.gemini?.apiKey;if(!i)throw new Error("Missing Gemini API key");const r=DEFAULT_GEMINI_ENDPOINT.replace(/\/+$/,""),a=(e||"gemini-2.5-flash").replace(/^models\//i,""),n=`${`${r}/${encodeURIComponent(a)}:generateContent`}?key=${encodeURIComponent(i)}`,s="undefined"!=typeof AbortController?new AbortController:null,o=s?setTimeout(()=>s.abort(),2e4):null;try{const e=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":i},body:JSON.stringify(t),signal:s?.signal}),r=await e.json().catch(()=>({}));if(!e.ok){const t=r?.error?.message||r?.message||`HTTP ${e.status}`;throw new Error(t)}if(r?.promptFeedback?.blockReason)throw new Error(`Request blocked (${r.promptFeedback.blockReason})`);const a=r?.candidates?.[0]?.content?.parts;if(!Array.isArray(a)||!a.length)return"";return a.map(e=>e&&"string"==typeof e.text?e.text:"").join("").trim()}finally{o&&clearTimeout(o)}}}document.addEventListener("DOMContentLoaded",function(){window.tracker=new GammaLedger});