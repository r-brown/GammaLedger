const VALID_TRADE_TYPES=new Set(["BTO","STO","STC","BTC"]),SHORT_STRATEGY_PATTERNS=["cash-secured put","covered call","the wheel","bear call spread","bull put spread","iron condor","iron butterfly","short straddle","short strangle","credit spread"],LONG_STRATEGY_PATTERNS=["long ","protective put","bull call spread","bear put spread","calendar spread","diagonal spread","pmcc","straddle","strangle","debit spread"],LOCAL_STORAGE_KEY="GammaLedgerCache",LEGACY_STORAGE_KEY="GammaLedgerTrades",GEMINI_STORAGE_KEY="GammaLedgerGeminiConfig",GEMINI_SECRET_STORAGE_KEY="GammaLedgerGeminiSecret",DEFAULT_GEMINI_ENDPOINT="https://generativelanguage.googleapis.com/v1beta/models",DEFAULT_GEMINI_MODEL="gemini-2.5-flash-lite",DEFAULT_GEMINI_TEMPERATURE=.7,GEMINI_ALLOWED_MODELS=["gemini-2.5-flash-lite","gemini-2.5-flash","gemini-2.5-pro"],BUILTIN_SAMPLE_DATA={trades:[{ticker:"AAPL",strategy:"Long Call",tradeType:"BTO",quantity:1,entryDate:"2025-02-20",expirationDate:"2025-04-19",exitDate:"2025-03-12",status:"Closed",stockPriceAtEntry:175.6,strikePrice:175,entryPrice:1.45,exitPrice:2.89,fees:1,ivRank:32,marketCondition:"Bullish",convictionLevel:7,notes:"Breakout continuation",exitReason:"Profit target reached",id:1001,tradeDirection:"long",daysHeld:21,dte:38,pl:144,roi:98.63,annualizedROI:512.4,maxRisk:146,cycleId:"",cycleType:"",cycleRole:"",definedRiskWidth:null,maxRiskOverride:null},{ticker:"MSFT",strategy:"Covered Call",tradeType:"STO",quantity:-1,entryDate:"2025-03-24",expirationDate:"2025-05-16",exitDate:"2025-04-18",status:"Closed",stockPriceAtEntry:318.2,strikePrice:325,entryPrice:1.95,exitPrice:.45,fees:1.5,ivRank:27,marketCondition:"Neutral",convictionLevel:5,notes:"Rolled after earnings",exitReason:"Profit target reached",id:1002,tradeDirection:"short",daysHeld:25,dte:28,pl:148.5,roi:39.23,annualizedROI:286.7,maxRisk:81.6,cycleId:"",cycleType:"",cycleRole:"",definedRiskWidth:null,maxRiskOverride:null},{ticker:"SPY",strategy:"Bull Put Spread",tradeType:"BTO",quantity:1,entryDate:"2025-04-22",expirationDate:"2025-05-31",exitDate:"2025-05-18",status:"Closed",stockPriceAtEntry:507.4,strikePrice:500,entryPrice:1.95,exitPrice:.5,fees:1.1,ivRank:25,marketCondition:"Bullish",convictionLevel:6,notes:"Bounce off 50-day moving average",exitReason:"Hit 70% max profit",id:1011,tradeDirection:"long",daysHeld:26,dte:13,pl:144,roi:73.85,annualizedROI:411.2,maxRisk:195,cycleId:"SPY-2025-05",cycleType:"defined-risk",cycleRole:"primary",definedRiskWidth:5,maxRiskOverride:null},{ticker:"META",strategy:"Iron Condor",tradeType:"BTO",quantity:1,entryDate:"2025-05-28",expirationDate:"2025-06-28",exitDate:"2025-06-21",status:"Closed",stockPriceAtEntry:301.7,strikePrice:300,entryPrice:2.35,exitPrice:.85,fees:1.3,ivRank:41,marketCondition:"Neutral",convictionLevel:5,notes:"Captured IV crush into FOMC week",exitReason:"50% max profit",id:1006,tradeDirection:"long",daysHeld:24,dte:7,pl:148.7,roi:42.48,annualizedROI:532.1,maxRisk:350,cycleId:"META-2025-06",cycleType:"iron-condor",cycleRole:"primary",definedRiskWidth:10,maxRiskOverride:null},{ticker:"DIS",strategy:"Cash-Secured Put",tradeType:"STO",quantity:-1,entryDate:"2025-06-24",expirationDate:"2025-07-19",exitDate:"2025-07-18",status:"Closed",stockPriceAtEntry:101.6,strikePrice:100,entryPrice:2.3,exitPrice:.35,fees:.85,ivRank:38,marketCondition:"Neutral",convictionLevel:6,notes:"Earnings gap fill support held",exitReason:"Premium decay captured",id:1012,tradeDirection:"short",daysHeld:24,dte:1,pl:194.15,roi:1.99,annualizedROI:30.3,maxRisk:9770,cycleId:"DIS-2025-07",cycleType:"wheel",cycleRole:"wheel-put",definedRiskWidth:null,maxRiskOverride:null},{ticker:"SMH",strategy:"Bear Call Spread",tradeType:"STO",quantity:-1,entryDate:"2025-07-22",expirationDate:"2025-08-23",exitDate:"2025-08-16",status:"Closed",stockPriceAtEntry:250.1,strikePrice:255,entryPrice:2.1,exitPrice:.6,fees:1.1,ivRank:47,marketCondition:"Bearish",convictionLevel:5,notes:"Rejected weekly resistance",exitReason:"90% max profit captured",id:1013,tradeDirection:"short",daysHeld:25,dte:7,pl:148.9,roi:70.9,annualizedROI:413.4,maxRisk:210,cycleId:"SMH-2025-08",cycleType:"defined-risk",cycleRole:"hedge",definedRiskWidth:5,maxRiskOverride:null},{ticker:"AVGO",strategy:"Covered Call",tradeType:"STO",quantity:-1,entryDate:"2025-08-26",expirationDate:"2025-09-20",exitDate:"2025-09-19",status:"Closed",stockPriceAtEntry:950.7,strikePrice:980,entryPrice:6.8,exitPrice:1.1,fees:1.75,ivRank:29,marketCondition:"Neutral",convictionLevel:6,notes:"Monthly income against core holding",exitReason:"Roll candidate after profit",id:1014,tradeDirection:"short",daysHeld:24,dte:1,pl:489.25,roi:35.75,annualizedROI:544.1,maxRisk:0,cycleId:"AVGO-2025-09",cycleType:"covered",cycleRole:"income",definedRiskWidth:null,maxRiskOverride:95e3},{ticker:"TSLA",strategy:"Cash-Secured Put",tradeType:"STO",quantity:-1,entryDate:"2025-09-15",expirationDate:"2025-10-17",exitDate:null,status:"Open",stockPriceAtEntry:260.5,strikePrice:250,entryPrice:3.4,exitPrice:null,fees:.75,ivRank:60,marketCondition:"Neutral",convictionLevel:6,notes:"Prefer assignment for long-term hold",exitReason:null,id:1003,tradeDirection:"short",daysHeld:10,dte:32,pl:0,roi:0,annualizedROI:0,maxRisk:2466,cycleId:"TSLA-2025-10",cycleType:"wheel",cycleRole:"wheel-put",definedRiskWidth:null,maxRiskOverride:null},{ticker:"AMZN",strategy:"Short Put Spread",tradeType:"BTO",quantity:1,entryDate:"2025-09-05",expirationDate:"2025-10-11",exitDate:null,status:"Open",stockPriceAtEntry:138.2,strikePrice:134,entryPrice:1.1,exitPrice:null,fees:1.05,ivRank:48,marketCondition:"Bullish",convictionLevel:6,notes:"High IV setup",exitReason:null,id:1004,tradeDirection:"long",daysHeld:5,dte:15,pl:0,roi:0,annualizedROI:0,maxRisk:390,cycleId:"AMZN-2025-10",cycleType:"defined-risk",cycleRole:"base",definedRiskWidth:5,maxRiskOverride:null},{ticker:"NVDA",strategy:"Poor Man's Covered Call",tradeType:"BTO",quantity:1,entryDate:"2025-06-20",expirationDate:"2026-01-17",exitDate:null,status:"Open",stockPriceAtEntry:440,strikePrice:400,entryPrice:38.6,exitPrice:null,fees:1.25,ivRank:52,marketCondition:"Bullish",convictionLevel:8,notes:"Synthetic stock core position",exitReason:null,id:1005,tradeDirection:"long",daysHeld:110,dte:99,pl:0,roi:0,annualizedROI:0,maxRisk:3860,cycleId:"NVDA-2026-01",cycleType:"pmcc",cycleRole:"base",definedRiskWidth:null,maxRiskOverride:null},{ticker:"GOOG",strategy:"Diagonal Call Spread",tradeType:"BTO",quantity:1,entryDate:"2025-07-30",expirationDate:"2025-11-15",exitDate:null,status:"Open",stockPriceAtEntry:132.5,strikePrice:133,entryPrice:4.6,exitPrice:null,fees:1.1,ivRank:30,marketCondition:"Neutral",convictionLevel:6,notes:"Diagonal with short weekly calls",exitReason:null,id:1007,tradeDirection:"long",daysHeld:70,dte:45,pl:0,roi:0,annualizedROI:0,maxRisk:460,cycleId:"GOOG-2025-11",cycleType:"diagonal",cycleRole:"long-leg",definedRiskWidth:null,maxRiskOverride:null},{ticker:"AMD",strategy:"Short Call",tradeType:"STO",quantity:-1,entryDate:"2025-09-12",expirationDate:"2025-09-27",exitDate:null,status:"Open",stockPriceAtEntry:108.3,strikePrice:115,entryPrice:1.45,exitPrice:null,fees:.9,ivRank:55,marketCondition:"Bearish",convictionLevel:5,notes:"Overbought daily chart",exitReason:null,id:1008,tradeDirection:"short",daysHeld:4,dte:14,pl:0,roi:0,annualizedROI:0,maxRisk:0,cycleId:"AMD-2025-09",cycleType:"short-call",cycleRole:"overlay",definedRiskWidth:null,maxRiskOverride:1e3},{ticker:"NFLX",strategy:"Strangle",tradeType:"BTO",quantity:1,entryDate:"2025-09-18",expirationDate:"2025-10-18",exitDate:null,status:"Open",stockPriceAtEntry:405.4,strikePrice:400,entryPrice:6.8,exitPrice:null,fees:1.35,ivRank:58,marketCondition:"Volatile",convictionLevel:6,notes:"Pre-earnings volatility play",exitReason:null,id:1009,tradeDirection:"long",daysHeld:1,dte:30,pl:0,roi:0,annualizedROI:0,maxRisk:680,cycleId:"NFLX-2025-10",cycleType:"strangle",cycleRole:"earnings",definedRiskWidth:null,maxRiskOverride:null},{ticker:"JPM",strategy:"Covered Call",tradeType:"STO",quantity:-1,entryDate:"2025-09-02",expirationDate:"2025-10-04",exitDate:null,status:"Open",stockPriceAtEntry:147.2,strikePrice:150,entryPrice:1.05,exitPrice:null,fees:.8,ivRank:22,marketCondition:"Neutral",convictionLevel:4,notes:"Monthly income trade",exitReason:null,id:1010,tradeDirection:"short",daysHeld:8,dte:24,pl:0,roi:0,annualizedROI:0,maxRisk:0,cycleId:"JPM-2025-10",cycleType:"covered",cycleRole:"income",definedRiskWidth:null,maxRiskOverride:null}],exportDate:"2025-09-25T12:00:00.000Z",version:"2.4"};class GammaLedger{constructor(){this.trades=[],this.currentView="dashboard",this.sortDirection={},this.charts={},this.tradeDetailCharts=new Map,this.cycleAnalytics=[],this.currentFileHandle=null,this.currentFileName="Unsaved Database",this.hasUnsavedChanges=!1,this.supportsFileSystemAccess="showOpenFilePicker"in window,this.currentEditingId=null,this.finnhub={apiKey:"",encryptionKey:null,cache:new Map,cacheTTL:6e4,outstandingRequests:new Map,rateLimitQueue:Promise.resolve(),maxRequestsPerMinute:60,timestamps:[],statusTimeoutId:null,lastStatus:null,elements:{}},this.gemini={apiKey:"",encryptionKey:null,model:DEFAULT_GEMINI_MODEL,statusTimeoutId:null,lastStatus:null,elements:{}},this.aiAgent=new GeminiInsightsAgent(this),this.aiChatMessages=[],this.aiChatSessionId=Date.now(),this.aiChatPendingRequest=!1,this.aiChatOpen=!1,this.activeQuoteEntries=new Map,this.quoteRefreshIntervalId=null,this.autoRefreshIntervalMs=this.computeAutoRefreshInterval(),this.quoteRefreshKeys=[],this.quoteRefreshCursor=0,this.positionHighlightConfig={expirationWarningDays:20,expirationCriticalDays:10},this.currentDate=new Date,this.init()}async init(){await this.loadFromStorage(),await this.loadFinnhubConfigFromStorage(),await this.loadGeminiConfigFromStorage(),this.trades&&0!==this.trades.length?(this.updateFileNameDisplay(),this.updateDashboard()):await this.loadDefaultDatabase(),this.bindEvents(),this.initializeGeminiControls(),this.initializeAIChat(),this.initializeFinnhubControls(),this.updateFileNameDisplay(),this.checkBrowserCompatibility(),setTimeout(()=>{this.updateDashboard(),this.showView("dashboard")},100)}computeAutoRefreshInterval(){const e=Number(this.finnhub?.maxRequestsPerMinute)||60,t=Math.min(Math.max(e-2,1),60);return Math.max(800,Math.ceil(12e4/t))}checkBrowserCompatibility(){if(!this.supportsFileSystemAccess){const e=document.getElementById("compatibility-notice");e&&e.classList.remove("hidden"),console.log("File System Access API not supported, using fallback methods")}}async loadDefaultDatabase(){try{if(!BUILTIN_SAMPLE_DATA||!Array.isArray(BUILTIN_SAMPLE_DATA.trades))throw new Error("Built-in sample data unavailable.");const e=JSON.parse(JSON.stringify(BUILTIN_SAMPLE_DATA));this.processLoadedData(e,{fileName:"Sample Database (Built-in)",source:"default-sample"}),this.currentFileHandle=null}catch(e){console.warn("Default database not loaded:",e),this.trades=[],this.currentFileName="Unsaved Database",this.currentFileHandle=null,this.hasUnsavedChanges=!1,this.updateUnsavedIndicator(),this.saveToStorage({fileName:this.currentFileName}),this.updateFileNameDisplay(),this.updateDashboard()}}getTradeType(e){return e.tradeType&&VALID_TRADE_TYPES.has(e.tradeType.toUpperCase())?e.tradeType.toUpperCase():this.normalizeTradeType(e)}normalizeTradeType(e){const t=(e.tradeType||"").toUpperCase();if(VALID_TRADE_TYPES.has(t))return t;const i=this.inferTradeDirection(e);return this.isClosedStatus(e.status)?"short"===i?"BTC":"STC":"short"===i?"STO":"BTO"}inferTradeDirection(e){const t=(e.tradeType||"").toUpperCase();if("BTO"===t||"STC"===t)return"long";if("STO"===t||"BTC"===t)return"short";const i=Number(e.quantity);if(!Number.isNaN(i)&&0!==i&&i<0)return"short";const n=(e.strategy||"").toLowerCase();return n.includes("short ")||SHORT_STRATEGY_PATTERNS.some(e=>n.includes(e))?"short":(LONG_STRATEGY_PATTERNS.some(e=>n.includes(e)),"long")}normalizeStatus(e){return(e||"").toString().trim().toLowerCase()}isClosedStatus(e){const t=this.normalizeStatus(e);return"closed"===t||"assigned"===t||"expired"===t}isAssignmentReason(e){return(e||"").toString().trim().toLowerCase().includes("assign")}getDisplayStatus(e){if(!e)return"Unknown";const t=(e.status||"Unknown").toString().trim();if(!t)return"Unknown";const i=t.toLowerCase();return"closed"===i&&this.isAssignmentReason(e.exitReason)||"assigned"===i?"Assigned":"expired"===i?"Expired":t}calculateDTE(e,t){const i=new Date(e);let n=this.currentDate;if(this.isClosedStatus(t.status))return 0;const r=i.getTime()-n.getTime(),a=Math.ceil(r/864e5);return Math.max(0,a)}calculatePL(e){if(!this.isClosedStatus(e.status)||null===e.exitPrice||void 0===e.exitPrice)return 0;const t=Math.abs(Number(e.quantity)||0);if(0===t)return 0;const i=Number(e.entryPrice)||0,n=Number(e.exitPrice)||0,r=Number(e.fees)||0,a=this.getTradeType(e);return("STO"===a||"BTC"===a?i-n:n-i)*t*100-r}calculateROI(e){const t=this.calculatePL(e),i=this.getCapitalAtRisk(e);if(!(i>0))return 0;const n=t/i*100;return Number.isFinite(n)?parseFloat(n.toFixed(2)):0}calculateDaysHeld(e){const t=new Date(e.entryDate);let i;i=this.isClosedStatus(e.status)&&e.exitDate?new Date(e.exitDate):this.currentDate;const n=i-t,r=Math.ceil(n/864e5);return Math.max(1,r)}calculateMaxRisk(e){const t=Math.abs(Number(e.quantity)||0);if(0===t)return 0;const i=Number(e.maxRiskOverride);if(Number.isFinite(i)&&i>0)return i;const n=Math.abs(Number(e.entryPrice)||0),r=Number(e.fees)||0,a=(e.strategy||"").toLowerCase(),s=this.getTradeType(e),o="STO"===s||"BTC"===s,l=Number(e.definedRiskWidth),c=Number.isFinite(l)&&l>0;if(!o)return n*t*100+r;if(c){return Math.max(100*(l-n),0)*t+r}a.includes("spread")||a.includes("condor")||a.includes("collar")||a.includes("butterfly");if(a.includes("put")){const i=Number(e.strikePrice)||0;if(i>0){return Math.max(100*(i-n),0)*t+r}}return n*t*100+r}getCapitalAtRisk(e){const t=Number(e.maxRisk);return Number.isFinite(t)&&t>0?t:this.calculateMaxRisk(e)}calculateAnnualizedROI(e){if(!this.isClosedStatus(e.status))return 0;const t=this.calculateROI(e);if(!Number.isFinite(t))return 0;const i=this.calculateDaysHeld(e),n=365*t/Math.max(1,Number(i)||0);return Number.isFinite(n)?parseFloat(n.toFixed(2)):0}enrichTradeData(e){const t={...e};delete t.optionType;const i=this.normalizeTradeType(t);t.tradeType=i;const n=this.inferTradeDirection({...t,tradeType:i});t.tradeDirection=n;const r=Number(t.definedRiskWidth);t.definedRiskWidth=Number.isFinite(r)&&r>0?r:null;const a=Number(t.maxRiskOverride);t.maxRiskOverride=Number.isFinite(a)&&a>0?a:null;const s=Number(t.quantity),o=Math.abs(Number.isNaN(s)?0:s);return t.quantity=o>0&&"short"===n?-o:o,t.daysHeld=this.calculateDaysHeld(t),t.dte=this.calculateDTE(t.expirationDate,t),t.pl=this.calculatePL(t),t.roi=this.calculateROI(t),t.annualizedROI=this.calculateAnnualizedROI(t),t.maxRisk=this.calculateMaxRisk(t),t.cycleId=this.normalizeCycleId(t.cycleId),t.cycleType=this.normalizeCycleType(t.cycleType,t.strategy),t.cycleRole=this.normalizeCycleRole(t.cycleRole,t),t}formatDateForInput(e){if(!e)return"";const t=new Date(e);if(isNaN(t.getTime()))return"";return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}calculateDaysBetween(e,t){const i=new Date(e),n=new Date(t),r=Math.abs(n.getTime()-i.getTime());return Math.ceil(r/864e5)}generateTickerLink(e){const t=(e??"").toString().trim().toUpperCase();return t?`https://www.investing.com/search/?q=${encodeURIComponent(t)}`:"https://www.investing.com/search/"}createTickerElement(e,t="ticker-link",i={}){const n=(e??"").toString().trim().toUpperCase();if(!n){const e=document.createElement("span");return e.className=`${t} ticker-link--placeholder`.trim(),e.textContent="—",e}const{behavior:r="external",onClick:a=null,title:s=""}=i||{},o=document.createElement("a");return o.className=t,o.textContent=n,s&&(o.title=s),"filter"===r&&"function"==typeof a?(o.href="#",o.setAttribute("role","button"),o.dataset.ticker=n,o.addEventListener("click",e=>{e.preventDefault(),a(n)})):(o.href=this.generateTickerLink(n),o.target="_blank",o.rel="noopener noreferrer",o.addEventListener("click",e=>{e.preventDefault(),window.open(this.generateTickerLink(n),"_blank","noopener,noreferrer")})),o}applyResponsiveLabels(e,t=[]){if(!e||!Array.isArray(t)||0===t.length)return;Array.from(e.cells||[]).forEach((e,i)=>{const n=t[i];n?e.setAttribute("data-label",n):e.removeAttribute("data-label")})}normalizeCycleId(e){return(e||"").toString().trim()}normalizeCycleType(e,t=""){const i=(e||"").toString().trim().toLowerCase();if("wheel"===i)return"wheel";if("pmcc"===i||"pmc"===i)return"pmcc";return this.inferCycleTypeFromStrategy(t)||i||""}inferCycleTypeFromStrategy(e=""){const t=e.toString().trim().toLowerCase();return t?t.includes("poor man")||t.includes("pmcc")?"pmcc":t.includes("cash-secured put")||t.includes("covered call")||t.includes("wheel")?"wheel":"":""}normalizeCycleRole(e,t={}){const i=(e||"").toString().trim().toLowerCase();return i||this.inferCycleRole(t)}inferCycleRole(e={}){const t=(e.strategy||"").toString().toLowerCase(),i=e.tradeDirection||this.inferTradeDirection(e),n=this.getTradeType(e);if(t.includes("cash-secured put"))return"wheel-put";if(t.includes("covered call"))return"wheel-call";if(t.includes("poor man")){if("long"===i||"BTO"===n)return"pmcc-base";if("short"===i||"STO"===n)return"pmcc-short"}return this.isAssignmentTrade(e)?"assignment":""}isWheelPut(e={}){if("wheel-put"===(e.cycleRole||"").toLowerCase())return!0;return(e.strategy||"").toLowerCase().includes("cash-secured put")}isCoveredCall(e={}){const t=(e.cycleRole||"").toLowerCase();if("wheel-call"===t||"covered-call"===t)return!0;return(e.strategy||"").toLowerCase().includes("covered call")}isPmccBaseLeg(e={}){if("pmcc-base"===(e.cycleRole||"").toLowerCase())return!0;return(e.strategy||"").toLowerCase().includes("poor man")&&("long"===e.tradeDirection||"BTO"===this.getTradeType(e))}isPmccShortCall(e={}){if("pmcc-short"===(e.cycleRole||"").toLowerCase())return!0;return(e.strategy||"").toLowerCase().includes("poor man")&&("short"===e.tradeDirection||"STO"===this.getTradeType(e))}isAssignmentTrade(e={}){return"assigned"===this.normalizeStatus(e.status)||this.isAssignmentReason(e.exitReason)}calculateOptionPremium(e={}){const t=Math.abs(Number(e.quantity)||0);if(!t)return 0;const i=Number(e.entryPrice)||0,n=Number(e.exitPrice)||0,r=Number(e.fees)||0,a=(i-n)*t*100;return"short"===(e.tradeDirection||this.inferTradeDirection(e))?a-r:(n-i)*t*100-r}bindEvents(){document.querySelectorAll(".nav-item").forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-view");t&&this.showView(t)})});const e=document.getElementById("save-database-btn");e&&e.addEventListener("click",async e=>{e.preventDefault(),await this.saveDatabase()});const t=document.getElementById("load-database-btn");t&&t.addEventListener("click",async e=>{e.preventDefault(),await this.loadDatabase()});const i=document.getElementById("new-database-btn");i&&i.addEventListener("click",e=>{e.preventDefault(),this.newDatabase()});const n=document.getElementById("add-trade-form");n&&n.addEventListener("submit",e=>{e.preventDefault(),this.handleTradeSubmit()});const r=document.getElementById("ticker");r&&r.addEventListener("input",e=>{this.updateTickerPreview(e.target.value)});const a=document.getElementById("convictionLevel");a&&a.addEventListener("input",e=>{const t=document.getElementById("conviction-display");t&&(t.textContent=e.target.value)}),["filter-strategy","filter-status","filter-market-condition","filter-trade-type"].forEach(e=>{const t=document.getElementById(e);t&&t.addEventListener("change",()=>this.filterTrades())});const s=document.getElementById("search-ticker");s&&s.addEventListener("input",()=>this.filterTrades());const o=document.getElementById("export-csv");o&&o.addEventListener("click",()=>this.exportToCSV()),document.querySelectorAll(".sortable").forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-sort");t&&this.sortTrades(t)})});const l=document.getElementById("ai-chat-toggle");l&&l.addEventListener("click",()=>this.toggleAIChat());const c=document.getElementById("ai-chat-close");c&&c.addEventListener("click",()=>this.toggleAIChat(!1));const d=document.getElementById("ai-chat-form");d&&d.addEventListener("submit",e=>{e.preventDefault(),this.handleAIChatSubmit()}),document.querySelectorAll(".ai-chat__quick-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-ai-prompt");t&&this.handleAIQuickPrompt(t)})});const u=document.getElementById("ai-chat");u&&u.addEventListener("click",e=>{const t=e.target instanceof Element?e.target:null,i=t?.closest('a[href="#settings"]');if(!i)return;e.preventDefault(),this.showView("settings"),this.toggleAIChat(!1);const n=document.getElementById("gemini-api-key");n&&setTimeout(()=>n.focus(),120)}),this.setupAIChatResizeHandle(),this.setTodayDate(),this.setupResponsiveFilters()}setupResponsiveFilters(){const e=document.getElementById("trades-filters-panel"),t=document.getElementById("toggle-filters");if(!e||!t)return;const i=e=>{t.textContent=e?"Hide Filters":"Show Filters",t.setAttribute("aria-expanded",String(e))};let n=window.innerWidth<=768;const r=(t=!1)=>{const r=window.innerWidth<=768;r?(!t&&n||e.classList.remove("is-open"),i(e.classList.contains("is-open"))):(e.classList.add("is-open"),i(!0)),n=r};t.addEventListener("click",()=>{const t=e.classList.toggle("is-open");i(t)});let a=null;window.addEventListener("resize",()=>{clearTimeout(a),a=setTimeout(()=>r(!1),160)}),r(!0)}setupAIChatResizeHandle(){const e=document.getElementById("ai-chat-panel"),t=document.getElementById("ai-chat-resize-handle")||e?.querySelector(".ai-chat__resize-handle");if(!e||!t||"true"===t.dataset.initialized)return void(t&&(t.dataset.initialized="true"));const i=(e,t,i)=>Math.min(Math.max(e,t),i),n={resizing:!1,startX:0,startY:0,startWidth:0,startHeight:0,maxWidth:0,maxHeight:0,minWidth:280,minHeight:280,rightMargin:24,bottomMargin:24,viewportPadding:24},r=i=>{if(n.resizing){if(n.resizing=!1,e.classList.remove("ai-chat__panel--resizing"),i)try{t.releasePointerCapture(i.pointerId)}catch(e){}document.removeEventListener("pointermove",a),document.removeEventListener("pointerup",r),document.removeEventListener("pointercancel",r)}},a=t=>{if(!n.resizing)return;t.preventDefault();const r=t.clientX-n.startX,a=t.clientY-n.startY,s=i(n.startWidth-r,n.minWidth,n.maxWidth),o=i(n.startHeight-a,n.minHeight,n.maxHeight);e.style.width=`${s}px`,e.style.height=`${o}px`};t.addEventListener("pointerdown",i=>{if(0!==i.button&&"touch"!==i.pointerType)return;i.preventDefault();const s=e.getBoundingClientRect();n.resizing=!0,n.startX=i.clientX,n.startY=i.clientY,n.startWidth=s.width,n.startHeight=s.height,n.rightMargin=Math.max(n.viewportPadding,Math.round(window.innerWidth-s.right)),n.bottomMargin=Math.max(n.viewportPadding,Math.round(window.innerHeight-s.bottom)),n.maxWidth=Math.max(n.minWidth,window.innerWidth-n.rightMargin-n.viewportPadding),n.maxHeight=Math.max(n.minHeight,window.innerHeight-n.bottomMargin-n.viewportPadding),e.classList.add("ai-chat__panel--resizing"),e.style.removeProperty("transform");try{t.setPointerCapture(i.pointerId)}catch(e){}document.addEventListener("pointermove",a,{passive:!1}),document.addEventListener("pointerup",r),document.addEventListener("pointercancel",r)}),t.dataset.initialized="true"}initializeAIChat(){if(this.updateAIChatHeader(),!this.aiAgent)return void(this.aiChatMessages=[]);const e=this.calculateAdvancedStats();this.aiAgent.updateContext({stats:e,openTrades:e.openTradesList,closedTrades:e.closedTradesList}),this.aiChatSessionId=Date.now(),this.aiChatMessages=[],this.aiChatPendingRequest=!1;const t=this.aiAgent.getGreeting();t?this.appendAIChatMessage("ai",t):this.renderAIChatMessages()}toggleAIChat(e=null){const t=document.getElementById("ai-chat-panel"),i=document.getElementById("ai-chat-toggle"),n=document.getElementById("ai-chat-input");if(!t||!i)return;(null===e?t.classList.contains("hidden"):Boolean(e))?(t.classList.remove("hidden"),t.setAttribute("aria-hidden","false"),i.setAttribute("aria-expanded","true"),this.aiChatOpen=!0,n&&setTimeout(()=>n.focus(),80)):(t.classList.add("hidden"),t.setAttribute("aria-hidden","true"),i.setAttribute("aria-expanded","false"),this.aiChatOpen=!1)}async handleAIChatSubmit(){if(this.aiChatPendingRequest)return;const e=document.getElementById("ai-chat-input");if(!e)return;const t=e.value.trim();if(!t)return;this.appendAIChatMessage("user",t),e.value="";const i=this.appendAIChatMessage("ai","Analyzing your portfolio...",{pending:!0}),n=this.aiChatMessages.filter(e=>e.id!==i).slice(-10).map(e=>({...e}));this.aiChatPendingRequest=!0;try{const e=this.aiAgent?await this.aiAgent.generateResponse(t,{history:n}):"AI assistant is unavailable at the moment.";this.appendAIChatMessage("ai",e,{replaceId:i,pending:!1})}catch(e){const t=e?.message||"Unknown error",n="Sorry, I could not reach Gemini right now. Please try again soon.";this.appendAIChatMessage("ai",`${n} (${t})`,{replaceId:i,pending:!1})}finally{this.aiChatPendingRequest=!1,e&&e.focus()}}async handleAIQuickPrompt(e){if(this.aiChatPendingRequest||!e)return;this.toggleAIChat(!0);const t=document.getElementById("ai-chat-input");t&&(t.value=""),this.appendAIChatMessage("user",e);const i=this.appendAIChatMessage("ai","Analyzing your portfolio...",{pending:!0}),n=this.aiChatMessages.filter(e=>e.id!==i).slice(-10).map(e=>({...e}));this.aiChatPendingRequest=!0;try{const t=this.aiAgent?await this.aiAgent.generateResponse(e,{history:n}):"AI assistant is unavailable at the moment.";this.appendAIChatMessage("ai",t,{replaceId:i,pending:!1})}catch(e){const t=e?.message||"Unknown error",n="Sorry, I could not reach Gemini right now. Please try again soon.";this.appendAIChatMessage("ai",`${n} (${t})`,{replaceId:i,pending:!1})}finally{this.aiChatPendingRequest=!1,t&&t.focus()}}appendAIChatMessage(e,t,i={}){const n="ai"===e?"ai":"user",{suppressRender:r=!1,replaceId:a=null,id:s=null,pending:o=!1}=i||{};if(!a&&("string"!=typeof t||0===t.length))return null;const l=new Date;if(a){const e=this.aiChatMessages.findIndex(e=>e.id===a);if(-1!==e){const i=this.aiChatMessages[e];return this.aiChatMessages[e]={...i,sender:n,text:t||"",timestamp:l,pending:Boolean(o)},r||this.renderAIChatMessages(),this.aiChatMessages[e].id}}const c={id:s||`${this.aiChatSessionId}-${Date.now()}-${Math.random().toString(16).slice(2)}`,sender:n,text:t||"",timestamp:l,pending:Boolean(o)};return this.aiChatMessages=[...this.aiChatMessages,c].slice(-200),r||this.renderAIChatMessages(),c.id}renderAIChatMessages(){const e=document.getElementById("ai-chat-history");e&&(e.innerHTML="",this.aiChatMessages.forEach(t=>{const i=document.createElement("div");i.className=`ai-chat__message ai-chat__message--${t.sender}`,t.pending&&i.classList.add("ai-chat__message--pending");const n=document.createElement("span");n.textContent="ai"===t.sender?this.getGeminiChatDisplayName():"You",i.appendChild(n);const r=document.createElement("div");r.className="ai-chat__bubble",t.pending&&r.setAttribute("data-pending","true"),"ai"===t.sender?r.innerHTML=this.renderMarkdownToHTML(t.text):r.textContent=t.text,i.appendChild(r),e.appendChild(i)}),e.scrollTop=e.scrollHeight)}renderMarkdownToHTML(e=""){if(!e)return"";const t=[],i=/```([\s\S]*?)```/g;let n,r=0;for(;null!==(n=i.exec(e));)n.index>r&&t.push({type:"text",value:e.slice(r,n.index)}),t.push({type:"code",value:n[1]}),r=n.index+n[0].length;return r<e.length&&t.push({type:"text",value:e.slice(r)}),t.map(e=>{if("code"===e.type){const t=e.value.replace(/^\n+|\n+$/g,"");return`<pre class="ai-chat__code"><code>${this.escapeHTML(t)}</code></pre>`}return this.renderMarkdownTextSegment(e.value)}).join("")}renderMarkdownTextSegment(e=""){if(!e)return"";const t=e.replace(/\r/g,"").split("\n"),i=[];let n=[],r=!1,a=!1;const s=()=>{r&&(i.push("</ul>"),r=!1),a&&(i.push("</ol>"),a=!1)},o=()=>{if(!n.length)return;const e=n.join(" ").trim();e&&i.push(`<p>${this.formatMarkdownInline(e)}</p>`),n=[]};return t.forEach(e=>{const t=e.trim();if(!t)return o(),void s();const l=t.match(/^(#{1,3})\s+(.*)$/);if(l){o(),s();const e=Math.min(l[1].length+2,6);return void i.push(`<h${e}>${this.formatMarkdownInline(l[2])}</h${e}>`)}if(/^([-*_])\1{2,}$/.test(t))return o(),s(),void i.push('<hr class="ai-chat__rule">');if(t.startsWith(">")){o(),s();const e=t.replace(/^>\s?/,"");return void i.push(`<blockquote class="ai-chat__quote">${this.formatMarkdownInline(e)}</blockquote>`)}const c=t.match(/^[-*]\s+(.*)$/);if(c)return o(),r||(s(),i.push("<ul>"),r=!0),void i.push(`<li>${this.formatMarkdownInline(c[1])}</li>`);const d=t.match(/^\d+\.\s+(.*)$/);if(d)return o(),a||(s(),i.push("<ol>"),a=!0),void i.push(`<li>${this.formatMarkdownInline(d[1])}</li>`);n.push(e)}),o(),s(),i.join("")}formatMarkdownInline(e=""){if(!e)return"";const t=/\[([^\]]+)\]\(([^)]+)\)/g;let i,n=0,r="";for(;null!==(i=t.exec(e));){if(i.index>n){const t=e.slice(n,i.index);r+=this.applyBasicInlineFormatting(t)}const t=this.applyBasicInlineFormatting(i[1]);r+=`<a href="${this.escapeHTML(this.sanitizeMarkdownUrl(i[2]))}" target="_blank" rel="noopener noreferrer">${t}</a>`,n=i.index+i[0].length}return n<e.length&&(r+=this.applyBasicInlineFormatting(e.slice(n))),r}applyBasicInlineFormatting(e=""){if(!e)return"";let t=this.escapeHTML(e);return t=t.replace(/`([^`]+)`/g,"<code>$1</code>"),t=t.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>"),t=t.replace(/__([^_]+)__/g,"<strong>$1</strong>"),t=t.replace(/\*(?!\s)([^*]+?)\*(?!\*)/g,"<em>$1</em>"),t=t.replace(/_([^_]+)_/g,"<em>$1</em>"),t}sanitizeMarkdownUrl(e=""){try{const t=e.trim();if(!t)return"#";if(t.startsWith("#")){const e=t.slice(1);return e&&/^[a-z0-9_-]{1,64}$/i.test(e)?`#${e}`:"#"}const i=t.toLowerCase();return i.startsWith("http://")||i.startsWith("https://")?t:"#"}catch(e){return"#"}}updateTickerPreview(e){const t=document.getElementById("ticker-preview");if(e&&e.trim()){const i=e.toUpperCase().trim(),n=this.generateTickerLink(i);t.innerHTML="";const r=document.createTextNode("Search ");t.appendChild(r);const a=document.createElement("a");a.href=n,a.target="_blank",a.rel="noopener noreferrer",a.className="ticker-link",a.textContent=i,a.addEventListener("click",e=>{e.preventDefault(),window.open(n,"_blank","noopener,noreferrer")}),t.appendChild(a);const s=document.createTextNode(" on Investing.com");t.appendChild(s)}else t.innerHTML=""}setTodayDate(){const e=this.currentDate,t=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`,i=document.getElementById("entryDate");i&&!this.currentEditingId&&(i.value=t)}showView(e){document.querySelectorAll(".nav-item").forEach(e=>{e.classList.remove("active")});const t=document.querySelector(`[data-view="${e}"]`);t&&t.classList.add("active"),document.querySelectorAll(".view").forEach(e=>{e.classList.remove("active")});const i=document.querySelector(`.${e}-view`);i&&i.classList.add("active");const n={dashboard:"Options Trading Dashboard","add-trade":this.currentEditingId?"Edit Trade":"Add New Trade","trades-list":"All Trades",settings:"Settings"}[e]||"GammaLedger";switch(document.getElementById("page-title").textContent=n,this.currentView=e,e){case"dashboard":this.updateDashboard();break;case"add-trade":this.currentEditingId||this.resetAddTradeForm();break;case"trades-list":this.updateTradesList();break;case"settings":{const e=this.finnhub?.lastStatus;e&&this.finnhub?.elements?.status&&this.updateFinnhubStatus(e.message,e.variant,0);break}}}resetAddTradeForm(){document.getElementById("add-trade-form").reset(),this.setTodayDate(),this.updateTickerPreview(""),document.getElementById("conviction-display").textContent="5";const e=document.getElementById("cycleId"),t=document.getElementById("cycleType"),i=document.getElementById("cycleRole");e&&(e.value=""),t&&(t.value=""),i&&(i.value=""),this.currentEditingId=null}parseDecimal(e,t=null,{allowNegative:i=!0}={}){if(null==e)return t;const n="string"==typeof e?e.trim():e;if(""===n)return t;const r=Number(n);return Number.isFinite(r)?!i&&r<0?t:r:t}parseInteger(e,t=null,{allowNegative:i=!0}={}){if(null==e)return t;const n="string"==typeof e?e.trim():e;if(""===n)return t;const r=parseInt(n,10);return Number.isFinite(r)?!i&&r<0?t:r:t}parseExitPrice(e){const t=this.parseDecimal(e,null,{allowNegative:!1});return null===t?null:t}handleTradeSubmit(){const e=document.getElementById("add-trade-form"),t=new FormData(e),i=t.get("tradeType"),n=Math.abs(this.parseInteger(t.get("quantity"),0,{allowNegative:!1})||0);let r=n;["STO","BTC"].includes(i)&&(r=-n);const a=this.parseDecimal(t.get("definedRiskWidth"),null,{allowNegative:!1}),s=this.parseDecimal(t.get("maxRiskOverride"),null,{allowNegative:!1}),o={ticker:t.get("ticker").toUpperCase(),strategy:t.get("strategy"),tradeType:i,quantity:r,entryDate:t.get("entryDate"),expirationDate:t.get("expirationDate"),exitDate:t.get("exitDate")||null,status:t.get("status"),stockPriceAtEntry:this.parseDecimal(t.get("stockPriceAtEntry")),strikePrice:this.parseDecimal(t.get("strikePrice")),entryPrice:this.parseDecimal(t.get("entryPrice")),exitPrice:this.parseExitPrice(t.get("exitPrice")),fees:this.parseDecimal(t.get("fees"),0),ivRank:this.parseInteger(t.get("ivRank")),marketCondition:t.get("marketCondition"),convictionLevel:this.parseInteger(t.get("convictionLevel"),5,{allowNegative:!1}),notes:t.get("notes"),exitReason:t.get("exitReason")||null,cycleId:t.get("cycleId"),cycleType:t.get("cycleType"),cycleRole:t.get("cycleRole"),definedRiskWidth:null!==a&&a>0?a:null,maxRiskOverride:null!==s&&s>0?s:null};if(this.currentEditingId)this.updateTrade(o)&&(this.showNotification("Trade updated successfully","success"),this.currentEditingId=null,document.getElementById("page-title").textContent="All Trades",this.resetAddTradeForm(),this.showView("trades-list"));else{o.id=Date.now();const e=this.enrichTradeData(o);this.trades.push(e),this.saveToStorage(),this.markUnsavedChanges(),this.resetAddTradeForm(),this.showView("dashboard")}}updateTrade(e){try{e.id=this.currentEditingId;const t=this.enrichTradeData(e),i=this.trades.findIndex(e=>e.id===this.currentEditingId);return-1!==i&&(this.trades[i]=t,this.saveToStorage(),this.markUnsavedChanges(),!0)}catch(e){return console.error("Error updating trade:",e),!1}}updateDashboard(){const e=this.calculateAdvancedStats(),{openTradesList:t,closedTradesList:i}=e;this.aiAgent&&this.aiAgent.updateContext({stats:e,openTrades:t,closedTrades:i}),this.cycleAnalytics=this.calculateCycleAnalytics(),document.getElementById("total-pl").textContent=this.formatCurrency(e.totalPL),document.getElementById("pl-percentage").textContent=`${e.totalROI.toFixed(2)}% Return`,document.getElementById("win-rate").textContent=`${e.winRate.toFixed(1)}%`,document.getElementById("win-loss-count").textContent=`${e.wins}W / ${e.losses}L`,document.getElementById("profit-factor").textContent=e.profitFactor.toFixed(2),document.getElementById("active-positions").textContent=e.activePositions,document.getElementById("total-roi").textContent=`${e.annualizedROI.toFixed(2)}%`,document.getElementById("max-drawdown").textContent=`${e.maxDrawdown.toFixed(1)}%`,this.updateRiskMetrics(i,e),this.updateActivePositionsTable(t),this.updateRecentTradesTable(i,e.activePositions),this.updateCycleSummaryTable(this.cycleAnalytics),setTimeout(()=>{this.updateAllCharts()},200)}calculateAdvancedStats(){const e=this.trades.filter(e=>this.isClosedStatus(e.status)),t=this.trades.filter(e=>"open"===this.normalizeStatus(e.status)),i=e.filter(e=>e.pl>0),n=e.filter(e=>e.pl<0),r=e.reduce((e,t)=>e+t.pl,0),a=e.reduce((e,t)=>{const i=this.getCapitalAtRisk(t);return i>0?e+i:e},0),s=e.length>0?i.length/e.length*100:0,o=i.reduce((e,t)=>e+t.pl,0),l=Math.abs(n.reduce((e,t)=>e+t.pl,0)),c=l>0?o/l:o>0?999:0;let d=0,u=0,h=0;[...e].sort((e,t)=>new Date(e.exitDate)-new Date(t.exitDate)).forEach(e=>{h+=e.pl,h>u&&(u=h);const t=u>0?(u-h)/u*100:0;t>d&&(d=t)});const m=a>0?r/a*100:0,p=e.length>0?e.reduce((e,t)=>e+t.daysHeld,0)/e.length:0,y=p>0?100*(Math.pow(1+m/100,365/p)-1):0;return{totalTrades:this.trades.length,totalPL:r,winRate:s,wins:i.length,losses:n.length,profitFactor:c,activePositions:t.length,totalROI:m,annualizedROI:y,maxDrawdown:d,closedTrades:e.length,totalInvestment:a,closedTradesList:e,openTradesList:t}}calculateCycleAnalytics(){const e=new Map;this.trades.forEach(t=>{const i=this.normalizeCycleId(t.cycleId);if(!i)return;const n=e.get(i)||{cycleId:i,cycleType:this.normalizeCycleType(t.cycleType,t.strategy),trades:[],ticker:t.ticker||""};!n.ticker&&t.ticker&&(n.ticker=t.ticker),n.cycleType||(n.cycleType=this.normalizeCycleType(t.cycleType,t.strategy)),n.trades.push(t),e.set(i,n)});const t=Array.from(e.values()).map(e=>this.computeCycleMetrics(e));return t.sort((e,t)=>{const i=e.startDate?new Date(e.startDate).getTime():0;return(t.startDate?new Date(t.startDate).getTime():0)-i}),t}computeCycleMetrics(e){const t=[...e.trades].sort((e,t)=>new Date(e.entryDate)-new Date(t.entryDate)),i=this.normalizeCycleType(e.cycleType,t[0]?.strategy||"");let n=null,r=null,a=!1,s=0,o=0,l=0,c=0,d=0,u=0,h=0,m=null,p=null,y=null,g=0,f=0;t.forEach(e=>{const t=e.entryDate?new Date(e.entryDate):null;t&&!isNaN(t.getTime())&&(!n||t<n)&&(n=t);const i=e.exitDate?new Date(e.exitDate):null;i&&!isNaN(i.getTime())?(!r||i>r)&&(r=i):a=!0;const b=Number(e.pl)||0;o+=b;const C=Math.abs(Number(e.quantity)||0);C>f&&(f=C);if("short"===(e.tradeDirection||this.inferTradeDirection(e))){const t=this.calculateOptionPremium(e);if(s+=t,this.isWheelPut(e)){l+=t;const i=Number(e.strikePrice)||0;!m&&i>0&&(m=i);const n=i*C*100;n>h&&(h=n)}(this.isCoveredCall(e)||this.isPmccShortCall(e))&&(c+=t)}else if(this.isPmccBaseLeg(e)){const t=Number(e.entryPrice),i=Number(e.exitPrice),n=Number(e.fees),r=Number.isFinite(t)?t*C*100:0,a=Number.isFinite(i)?i*C*100:0,s=Number.isFinite(n)?Math.max(n,0):0;d+=r-a+s,r>0&&(u+=r+s);const o=Number(e.strikePrice);Number.isFinite(o)&&o>0&&(this.isClosedStatus(e.status)||(y=o),p=o)}if(this.isAssignmentTrade(e)){g+=C;const t=Number(e.strikePrice)||Number(e.stockPriceAtEntry)||null;if(!m&&Number.isFinite(t)&&t>0&&(m=t),Number.isFinite(t)&&t>0){const e=t*C*100;e>h&&(h=e)}}}),Number.isFinite(y)&&y>0&&(p=y);const b=a?"In Progress":"Closed",C=n?n.toISOString():null,v=!a&&r?r.toISOString():null;let k=null,x=null,T=null,w=null;if("wheel"===i&&m&&f>0)k=m-s/(100*f),x=k,T=h||m*f*100;else if("pmcc"===i){w=d-c;const e=Number.isFinite(w)&&w>0?w:null,t=d>0?d:null,i=u>0?u:null;e?T=e:t?T=t:i&&(T=i);const n=e||t||i;n&&n>h&&(h=n),Number.isFinite(p)&&p>0&&f>0&&Number.isFinite(w)&&(x=p+w/(100*f))}Number.isFinite(d)&&Math.abs(d)<1e-6&&(d=0),Number.isFinite(w)&&Math.abs(w)<1e-6&&(w=0);let I=T;if((!I||I<=0)&&("wheel"===i?I=h||(m&&f>0?m*f*100:null):"pmcc"===i&&(Number.isFinite(w)&&w>0?I=w:d>0?I=d:u>0&&(I=u))),!I||I<=0){const e=t.reduce((e,t)=>{const i=Math.abs(Number(t.quantity)||0);if(!i)return e;const n=Number(t.entryPrice),r=Number(t.fees)||0,a=this.getTradeType(t);if("BTO"===a||"BTC"===a){const t=(Number.isFinite(n)?n:0)*i*100+(Number.isFinite(r)?Math.max(r,0):0);return e+Math.max(t,0)}return e},0);I=e>0?e:null}(!T||T<=0)&&(T=I&&I>0?I:null);const N=T?o/T*100:null;let S="",P=null;return"wheel"===i&&null!==k?(S="Eff. Basis",P=k):"pmcc"===i&&null!==w&&(S="Net Basis",P=w),{cycleId:e.cycleId,cycleType:i,typeLabel:"pmcc"===i?"PMCC":"wheel"===i?"Wheel":i?i.toUpperCase():"Custom",ticker:e.ticker||t[0]?.ticker||"—",trades:t,startDate:C,endDate:v,status:b,totalPremiums:s,totalPL:o,putPremiums:l,callPremiums:c,baseCost:d,baseInitialCost:u,capitalAtRisk:h,effectiveCostBasis:k,netBasis:w,costBasis:I,assignments:g,maxContracts:f,roiPercent:N,keyMetricLabel:S,keyMetricValue:P,breakevenPrice:x,hasOpenTrade:a,durationDays:n?this.calculateDaysBetween(n,r||this.currentDate):0}}updateCycleSummaryTable(e=this.cycleAnalytics||[]){const t=document.querySelector("#cycle-summary-table tbody"),i=document.getElementById("cycle-summary-empty");if(!t)return;if(t.innerHTML="",!Array.isArray(e)||0===e.length)return void(i&&i.classList.remove("hidden"));i&&i.classList.add("hidden");const n=["Cycle","Type","Ticker","Status","Trades","Premiums","Total P&L","ROI","Cost Basis","Key Metrics","Timeline"];e.forEach(e=>{const i=t.insertRow(),r=i.insertCell(0),a=this.normalizeCycleId(e.cycleId);if(a){const t=document.createElement("button");t.type="button",t.className="cycle-chip cycle-chip--link",t.textContent=a,t.title="Open All Trades filtered by this cycle",t.addEventListener("click",()=>{this.openTradesFilteredByCycle(a,e.ticker)}),r.appendChild(t)}else r.textContent="—";i.insertCell(1).textContent=e.typeLabel,i.insertCell(2).textContent=e.ticker||"—";const s=i.insertCell(3),o=document.createElement("span"),l="Closed"===e.status?"closed":"open";o.className=`status-badge ${l}`,o.textContent=e.status,s.appendChild(o),i.insertCell(4).textContent=e.trades.length;i.insertCell(5).textContent=this.formatCurrency(e.totalPremiums);const c=i.insertCell(6);c.textContent=this.formatCurrency(e.totalPL),e.totalPL>0?c.className="pl-positive":e.totalPL<0?c.className="pl-negative":c.className="pl-neutral";const d=i.insertCell(7);d.textContent=this.formatPercent(e.roiPercent),e.roiPercent>0?d.className="pl-positive":e.roiPercent<0?d.className="pl-negative":d.className="pl-neutral";const u=i.insertCell(8);Number.isFinite(e.costBasis)?u.textContent=this.formatCurrency(e.costBasis):(u.textContent="—",u.className="pl-neutral");const h=i.insertCell(9);if(e.keyMetricLabel&&Number.isFinite(e.keyMetricValue)){const t=document.createElement("div");if(t.className="cell-metric__label",t.textContent=`${e.keyMetricLabel}: ${this.formatCurrency(e.keyMetricValue)}`,h.appendChild(t),e.breakevenPrice&&Number.isFinite(e.breakevenPrice)){const t=document.createElement("div");t.className="cell-metric__subtext",t.textContent=`Breakeven: ${this.formatCurrency(e.breakevenPrice)}`,h.appendChild(t)}if("wheel"===e.cycleType&&e.assignments){const t=document.createElement("div");t.className="cell-metric__subtext",t.textContent=`Assignments: ${e.assignments}`,h.appendChild(t)}}else if(Number.isFinite(e.costBasis)){const t=document.createElement("div");if(t.className="cell-metric__label",t.textContent=`Cost Basis: ${this.formatCurrency(e.costBasis)}`,h.appendChild(t),e.breakevenPrice&&Number.isFinite(e.breakevenPrice)){const t=document.createElement("div");t.className="cell-metric__subtext",t.textContent=`Breakeven: ${this.formatCurrency(e.breakevenPrice)}`,h.appendChild(t)}if("wheel"===e.cycleType&&e.assignments){const t=document.createElement("div");t.className="cell-metric__subtext",t.textContent=`Assignments: ${e.assignments}`,h.appendChild(t)}}else"wheel"===e.cycleType&&e.assignments?h.textContent=`Assignments: ${e.assignments}`:h.textContent="—";i.insertCell(10).textContent=this.formatCycleDateRange(e.startDate,e.endDate,e.hasOpenTrade),this.applyResponsiveLabels(i,n)})}updateRiskMetrics(e=this.trades.filter(e=>this.isClosedStatus(e.status)),t=null){const i=Array.isArray(e)?e:[];if(0===i.length)return document.getElementById("sharpe-ratio").textContent="0.00",document.getElementById("calmar-ratio").textContent="0.00",document.getElementById("volatility").textContent="0.00%",void(document.getElementById("expectancy").textContent="$0.00");const n=i.map(e=>Number(e.roi)/100).filter(e=>Number.isFinite(e));if(0===n.length)return document.getElementById("sharpe-ratio").textContent="0.00",document.getElementById("calmar-ratio").textContent="0.00",document.getElementById("volatility").textContent="0.00%",void(document.getElementById("expectancy").textContent="$0.00");const r=n.reduce((e,t)=>e+t,0)/n.length,a=n.reduce((e,t)=>e+Math.pow(t-r,2),0)/n.length,s=Math.sqrt(a),o=100*s,l=s>0?r*Math.sqrt(252)/s:0,c=i.filter(e=>e.pl>0),d=i.filter(e=>e.pl<0),u=c.length>0?c.reduce((e,t)=>e+t.pl,0)/c.length:0,h=d.length>0?Math.abs(d.reduce((e,t)=>e+t.pl,0)/d.length):0,m=u*(c.length/i.length)-h*(d.length/i.length),p=t??this.calculateAdvancedStats(),y=p.totalPL,g=p.totalInvestment,f=g>0?y/g*100:0,b=p.maxDrawdown>0?f/p.maxDrawdown:0;document.getElementById("sharpe-ratio").textContent=l.toFixed(2),document.getElementById("calmar-ratio").textContent=b.toFixed(2),document.getElementById("volatility").textContent=`${o.toFixed(2)}%`,document.getElementById("expectancy").textContent=this.formatCurrency(m)}updateActivePositionsTable(e=this.trades.filter(e=>"Open"===e.status)){const t=document.querySelector("#active-positions-table tbody");if(t){t.innerHTML="";const i=[...Array.isArray(e)?e:[]].sort((e,t)=>this.parseInteger(e.dte,Number.POSITIVE_INFINITY,{allowNegative:!1})-this.parseInteger(t.dte,Number.POSITIVE_INFINITY,{allowNegative:!1})),n=["Ticker","Strategy","Trade Type","Strike","Current Price","DTE","Max Risk","Notes"],r=new Map;i.forEach(e=>{const i=t.insertRow();i.dataset.tradeId=String(e.id??"");const a=i.insertCell(0),s=(e.ticker??"").toString().trim().toUpperCase(),o=this.createTickerElement(e.ticker,"ticker-pill",{behavior:"filter",onClick:e=>this.openTradesFilteredByTicker(e),title:s?`View all trades for ${s}`:""});a.appendChild(o),i.dataset.ticker=s,i.insertCell(1).textContent=e.strategy||"—";const l=i.insertCell(2),c=this.getTradeType(e);l.textContent=c;l.className={BTO:"trade-type-bto",STO:"trade-type-sto",STC:"trade-type-stc",BTC:"trade-type-btc"}[c]||"";const d=this.parseDecimal(e.strikePrice);i.insertCell(3).textContent=null!==d?`$${d.toFixed(2)}`:"—",Number.isFinite(d)?i.dataset.strikePrice=String(d):delete i.dataset.strikePrice;const u=i.insertCell(4);u.className="quote-cell";const h=`${this.getQuoteEntryKey(e)}|row:${r.size}`;i.dataset.quoteKey=h,this.populateQuoteCell(u,e,i,{deferNetworkFetch:!0}),r.set(h,{trade:e,row:i,cell:u,key:h});const m=this.parseInteger(e.dte,null,{allowNegative:!1});i.insertCell(5).textContent=null!==m?m:"—",Number.isFinite(m)?i.dataset.dte=String(m):delete i.dataset.dte;const p=i.insertCell(6),y=this.parseDecimal(e.maxRisk,null,{allowNegative:!1});null!==y?(p.textContent=this.formatCurrency(y),p.className="pl-negative"):(p.textContent="—",p.className="pl-neutral");const g=i.insertCell(7),f=(e.notes||"").trim();g.textContent=f||"—",this.updateExpirationHighlight(i,e),this.applyResponsiveLabels(i,n)}),this.activeQuoteEntries=r,this.rebuildQuoteRefreshSchedule(),this.startQuoteAutoRefreshIfNeeded(),this.refreshActivePositionsQuotes({force:!0,immediate:!0})}}updateRecentTradesTable(e=this.trades.filter(e=>this.isClosedStatus(e.status)),t=this.trades.filter(e=>"open"===this.normalizeStatus(e.status)).length){const i=Number(t),n=Math.max(Number.isFinite(i)?i:0,10),r=[...Array.isArray(e)?e:[]].sort((e,t)=>new Date(t.exitDate)-new Date(e.exitDate)).slice(0,n),a=document.querySelector("#recent-trades-table tbody");if(a){a.innerHTML="";const e=["Ticker","Strategy","Exit Date","Days Held","P&L","ROI"];r.forEach(t=>{const i=a.insertRow(),n=i.insertCell(0),r=(t.ticker??"").toString().trim().toUpperCase(),s=this.createTickerElement(t.ticker,"ticker-pill",{behavior:"filter",onClick:e=>this.openTradesFilteredByTicker(e),title:r?`View all trades for ${r}`:""});n.appendChild(s),i.insertCell(1).textContent=t.strategy,i.insertCell(2).textContent=this.formatDate(t.exitDate);const o=i.insertCell(3),l=Number(t.daysHeld);o.textContent=Number.isFinite(l)?l:"—";const c=i.insertCell(4);c.textContent=this.formatCurrency(t.pl),c.className=t.pl>=0?"pl-positive":"pl-negative";const d=i.insertCell(5),u=Number(t.roi);Number.isFinite(u)?(d.textContent=`${u.toFixed(2)}%`,d.className=u>=0?"pl-positive":"pl-negative"):(d.textContent="—",d.className="pl-neutral"),this.applyResponsiveLabels(i,e)})}}updateAllCharts(){this.updateMonthlyPLChart(),this.updateCumulativePLChart(),this.updateStrategyPerformanceChart(),this.updateWinRateByStrategyChart(),this.updateMarketConditionChart()}initializeGeminiControls(){const e=document.getElementById("gemini-controls");if(!e)return;const t=document.getElementById("gemini-api-key"),i=document.getElementById("gemini-model"),n=document.getElementById("gemini-save"),r=document.getElementById("gemini-clear"),a=document.getElementById("gemini-status");if(this.gemini.elements={container:e,keyInput:t,modelSelect:i,saveButton:n,clearButton:r,status:a},t&&(t.value=this.gemini.apiKey),GEMINI_ALLOWED_MODELS.includes(this.gemini.model)||(this.gemini.model=DEFAULT_GEMINI_MODEL),i){0===Array.from(i.options).map(e=>e.value).length&&GEMINI_ALLOWED_MODELS.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e.replace(/gemini-2\.5-/,"Gemini 2.5 ").replace(/-/g," ").replace(/\b([a-z])/g,(e,t)=>t.toUpperCase()),i.appendChild(t)}),i.value=GEMINI_ALLOWED_MODELS.includes(this.gemini.model)?this.gemini.model:DEFAULT_GEMINI_MODEL,this.setGeminiModel(i.value),i.addEventListener("change",()=>{this.setGeminiModel(i.value),this.saveGeminiConfigToStorage()})}if(a){const e=this.gemini.apiKey?"success":"neutral",t=this.gemini.apiKey?"API key loaded":"Not set";this.updateGeminiStatus(t,e)}const s=async()=>{const e=(t?.value||"").trim();this.setGeminiApiKey(e,{persist:!1,updateUI:!1});const i=this.gemini.apiKey,n=this.getCrypto();if(!e)return this.removeGeminiEncryptionKey(),this.saveGeminiConfigToStorage(),t&&(t.value=""),this.updateGeminiStatus("API key cleared. Connect your Gemini key via Settings to get tailored analysis.","neutral",6e3),this.initializeAIChat(),void this.updateAIChatHeader();if(!n?.subtle)return this.saveGeminiConfigToStorage({includeApiKey:!0}),this.updateGeminiStatus("Gemini API key saved (unencrypted — Web Crypto unavailable).","success",6e3),t&&(t.value=i),this.initializeAIChat(),void this.updateAIChatHeader();await this.encryptAndStoreGeminiApiKey(n)?this.updateGeminiStatus("Gemini API key saved securely.","success",5e3):(this.saveGeminiConfigToStorage({includeApiKey:!0}),this.updateGeminiStatus("Gemini API key saved (unencrypted fallback).","neutral",6e3)),t&&(t.value=i),this.initializeAIChat(),this.updateAIChatHeader()};n?.addEventListener("click",async e=>{e.preventDefault(),await s()}),t?.addEventListener("keydown",async e=>{"Enter"===e.key&&(e.preventDefault(),await s())}),r?.addEventListener("click",e=>{e.preventDefault(),t&&(t.value=""),this.setGeminiApiKey("",{persist:!1,updateUI:!1}),this.removeGeminiEncryptionKey(),this.saveGeminiConfigToStorage(),this.updateGeminiStatus("API key cleared. Connect your Gemini key via Settings to get tailored analysis.","neutral",6e3),this.initializeAIChat(),this.updateAIChatHeader()}),this.updateAIChatHeader()}getGeminiModelLabel(e=""){const t=(e||"").toLowerCase(),i={"gemini-2.5-flash-lite":"Gemini 2.5 Flash Lite","gemini-2.5-flash":"Gemini 2.5 Flash","gemini-2.5-pro":"Gemini 2.5 Pro"};if(i[t])return i[t];if(!t)return"";return t.replace(/^gemini[-\s]?/i,"Gemini ").replace(/-/g," ").replace(/\b([a-z])/g,(e,t)=>t.toUpperCase()).trim()||"Gemini"}getGeminiChatDisplayName(){const e=this.getGeminiModelLabel(this.gemini?.model);return e||"Gemini"}updateAIChatHeader(){const e=document.getElementById("ai-chat-title"),t=document.getElementById("ai-chat-subtitle");if(!e&&!t)return;if(e&&(e.textContent="Portfolio AI Coach"),!t)return;Boolean(this.gemini?.apiKey)?t.textContent="Ask about your portfolio for AI-guided insights.":t.innerHTML='Connect your Gemini API key in <a href="#settings" class="ai-chat__settings-link">Settings</a> to get tailored analysis.'}updateGeminiStatus(e,t="neutral",i=0){const n=this.gemini?.elements?.status;if(!n||!e)return;const r=["success","error","neutral"].includes(t)?t:"neutral";n.textContent=e,n.classList.remove("is-success","is-error"),"success"===r?n.classList.add("is-success"):"error"===r&&n.classList.add("is-error"),this.gemini.statusTimeoutId&&clearTimeout(this.gemini.statusTimeoutId),this.gemini.lastStatus={message:e,variant:r},i>0&&(this.gemini.statusTimeoutId=setTimeout(()=>{n.isConnected&&(n.textContent="neutral"===r?"Not set":"",n.classList.remove("is-success","is-error"))},i))}setGeminiApiKey(e,{persist:t=!1,updateUI:i=!0}={}){const n=(e||"").trim();n!==this.gemini.apiKey&&(this.gemini.apiKey=n,i&&this.gemini.elements?.keyInput&&(this.gemini.elements.keyInput.value=n),t&&this.saveGeminiConfigToStorage({includeApiKey:!0}))}setGeminiModel(e){const t=(e||"").trim(),i=GEMINI_ALLOWED_MODELS.includes(t)?t:DEFAULT_GEMINI_MODEL,n=this.gemini.model;this.gemini.model=i;const r=this.gemini.elements?.modelSelect;r&&r.value!==this.gemini.model&&(r.value=this.gemini.model),this.gemini.model!==n&&(this.updateAIChatHeader(),this.renderAIChatMessages())}async loadGeminiConfigFromStorage(){try{const e=localStorage.getItem(GEMINI_STORAGE_KEY);if(!e)return;const t=JSON.parse(e);if(!t||"object"!=typeof t)return;if("string"==typeof t.model&&t.model.trim()&&this.setGeminiModel(t.model.trim()),t.enc&&t.payload){const e=this.getCrypto();if(!e?.subtle)return void console.warn("Encrypted Gemini API key stored but Web Crypto unavailable.");try{const i=await this.ensureGeminiEncryptionKey(e);if(!i)throw new Error("Encryption key unavailable");const n=await this.decryptString(t.payload,e,i);n&&(this.gemini.apiKey=n)}catch(e){console.warn("Failed to decrypt stored Gemini API key:",e)}}else"string"==typeof t.apiKey&&(this.gemini.apiKey=t.apiKey)}catch(e){console.warn("Failed to load Gemini configuration:",e)}}saveGeminiConfigToStorage({includeApiKey:e=!1,encryptedPayload:t=null}={}){try{const i={model:this.gemini.model};t?(i.enc=!0,i.payload=t):e&&this.gemini.apiKey&&(i.apiKey=this.gemini.apiKey),localStorage.setItem(GEMINI_STORAGE_KEY,JSON.stringify(i))}catch(e){console.warn("Failed to save Gemini configuration:",e)}}removeGeminiEncryptionKey(){try{localStorage.removeItem("GammaLedgerGeminiSecret"),this.gemini.encryptionKey=null}catch(e){console.warn("Failed to remove Gemini encryption key:",e)}}async ensureGeminiEncryptionKey(e=this.getCrypto()){if(!e?.subtle)return null;if(this.gemini.encryptionKey)return this.gemini.encryptionKey;let t=localStorage.getItem("GammaLedgerGeminiSecret");if(!t){const i=e.getRandomValues(new Uint8Array(32));t=this.arrayBufferToBase64(i.buffer),localStorage.setItem("GammaLedgerGeminiSecret",t)}const i=new Uint8Array(this.base64ToArrayBuffer(t)),n=await e.subtle.importKey("raw",i,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"]);return this.gemini.encryptionKey=n,n}async encryptAndStoreGeminiApiKey(e=this.getCrypto()){try{if(!e?.subtle)throw new Error("Web Crypto API unavailable");const t=this.gemini.apiKey||"";if(!t)return this.saveGeminiConfigToStorage(),!0;const i=await this.ensureGeminiEncryptionKey(e);if(!i)throw new Error("Failed to prepare encryption key");const n=await this.encryptString(t,e,i);return this.saveGeminiConfigToStorage({encryptedPayload:n}),!0}catch(e){return console.warn("Failed to encrypt Gemini API key:",e),!1}}initializeFinnhubControls(){const e=document.getElementById("finnhub-controls");if(!e)return;const t=document.getElementById("finnhub-api-key"),i=document.getElementById("finnhub-save"),n=document.getElementById("finnhub-status");if(this.finnhub.elements={container:e,input:t,saveButton:i,status:n},t&&(t.value=this.finnhub.apiKey),n){const e=this.finnhub.apiKey?"success":"neutral",t=this.finnhub.apiKey?"API key loaded":"Not set";this.updateFinnhubStatus(t,e,4e3)}const r=async()=>{const e=(t?.value||"").trim();this.setFinnhubApiKey(e,{persist:!1,updateUI:!0,markUnsaved:!1});const i=this.getCrypto();if(!e)return this.removeFinnhubConfigFromStorage(),this.updateFinnhubStatus("API key cleared. Live prices disabled.","neutral",5e3),void this.updateActivePositionsTable();if(!i?.subtle)return this.saveFinnhubConfigToStorage(),this.updateFinnhubStatus("Finnhub API key saved (unencrypted — Web Crypto unavailable).","success",6e3),void this.updateActivePositionsTable();await this.encryptAndStoreFinnhubApiKey(i)?this.updateFinnhubStatus("Finnhub API key saved securely.","success",5e3):(this.saveFinnhubConfigToStorage(),this.updateFinnhubStatus("Finnhub API key saved (unencrypted fallback).","neutral",6e3)),this.updateActivePositionsTable()};i?.addEventListener("click",async e=>{e.preventDefault(),await r()}),t?.addEventListener("keydown",async e=>{"Enter"===e.key&&(e.preventDefault(),await r())})}updateFinnhubStatus(e,t="neutral",i=0){const n=this.finnhub?.elements?.status;if(!n||!e)return;const r=["success","error","neutral"].includes(t)?t:"neutral";n.textContent=e,n.classList.remove("is-success","is-error"),"success"===r?n.classList.add("is-success"):"error"===r&&n.classList.add("is-error"),this.finnhub.statusTimeoutId&&clearTimeout(this.finnhub.statusTimeoutId),this.finnhub.lastStatus={message:e,variant:r},i>0&&(this.finnhub.statusTimeoutId=setTimeout(()=>{n.isConnected&&(n.textContent="neutral"===r?"Not set":"",n.classList.remove("is-success","is-error"))},i))}setFinnhubApiKey(e,{persist:t=!1,updateUI:i=!0,markUnsaved:n=!1}={}){const r=(e||"").trim();r!==this.finnhub.apiKey&&(this.finnhub.apiKey=r,this.finnhub.cache.clear(),this.finnhub.outstandingRequests.clear(),i&&this.finnhub.elements?.input&&(this.finnhub.elements.input.value=r),t&&this.saveFinnhubConfigToStorage(),n&&this.markUnsavedChanges())}getFinnhubStorageKey(){return"GammaLedgerFinnhubConfig"}async loadFinnhubConfigFromStorage(){try{const e=localStorage.getItem(this.getFinnhubStorageKey());if(!e)return;const t=JSON.parse(e);if(!t)return;if(t.enc&&t.payload){const e=this.getCrypto();if(!e?.subtle)return console.warn("Encrypted Finnhub API key stored but Web Crypto unavailable."),void this.updateFinnhubStatus("Stored Finnhub key is encrypted, but this browser cannot decrypt it.","error",7e3);try{const i=await this.ensureFinnhubEncryptionKey(e);if(!i)throw new Error("Encryption key unavailable");const n=await this.decryptString(t.payload,e,i);n&&(this.finnhub.apiKey=n)}catch(e){console.warn("Failed to decrypt stored Finnhub API key:",e),this.updateFinnhubStatus("Failed to decrypt stored Finnhub API key.","error",6e3)}return}"string"==typeof t.apiKey&&(this.finnhub.apiKey=t.apiKey)}catch(e){console.warn("Failed to load Finnhub configuration:",e)}}saveFinnhubConfigToStorage(){try{const e={apiKey:this.finnhub.apiKey};localStorage.setItem(this.getFinnhubStorageKey(),JSON.stringify(e))}catch(e){console.warn("Failed to save Finnhub configuration:",e)}}removeFinnhubConfigFromStorage(){try{localStorage.removeItem(this.getFinnhubStorageKey())}catch(e){console.warn("Failed to remove Finnhub configuration:",e)}}arrayBufferToBase64(e){const t=new Uint8Array(e);let i="";for(let e=0;e<t.byteLength;e++)i+=String.fromCharCode(t[e]);return btoa(i)}base64ToArrayBuffer(e){const t=atob(e),i=t.length,n=new Uint8Array(i);for(let e=0;e<i;e++)n[e]=t.charCodeAt(e);return n.buffer}getFinnhubSecretStorageKey(){return"GammaLedgerFinnhubSecret"}async ensureFinnhubEncryptionKey(e=this.getCrypto()){if(!e?.subtle)return null;if(this.finnhub.encryptionKey)return this.finnhub.encryptionKey;let t=localStorage.getItem(this.getFinnhubSecretStorageKey());if(!t){const i=e.getRandomValues(new Uint8Array(32));t=this.arrayBufferToBase64(i.buffer),localStorage.setItem(this.getFinnhubSecretStorageKey(),t)}const i=new Uint8Array(this.base64ToArrayBuffer(t)),n=await e.subtle.importKey("raw",i,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"]);return this.finnhub.encryptionKey=n,n}async encryptString(e,t,i){const n=t.getRandomValues(new Uint8Array(12)),r=new TextEncoder,a=await t.subtle.encrypt({name:"AES-GCM",iv:n},i,r.encode(e));return{iv:this.arrayBufferToBase64(n.buffer),ct:this.arrayBufferToBase64(a)}}getCrypto(){return"undefined"!=typeof globalThis&&globalThis.crypto?globalThis.crypto:"undefined"!=typeof window&&window.crypto?window.crypto:null}async decryptString(e,t,i){const n=new Uint8Array(this.base64ToArrayBuffer(e.iv)),r=this.base64ToArrayBuffer(e.ct),a=await t.subtle.decrypt({name:"AES-GCM",iv:n},i,r);return(new TextDecoder).decode(a)}async encryptAndStoreFinnhubApiKey(e=this.getCrypto()){try{if(!e?.subtle)throw new Error("Web Crypto API unavailable");const t=this.finnhub.apiKey||"";if(!t)return this.removeFinnhubConfigFromStorage(),!0;const i=await this.ensureFinnhubEncryptionKey(e);if(!i)throw new Error("Failed to prepare encryption key");const n=await this.encryptString(t,e,i);return localStorage.setItem(this.getFinnhubStorageKey(),JSON.stringify({enc:!0,payload:n})),!0}catch(e){return console.warn("Failed to encrypt Finnhub API key:",e),!1}}getQuoteEntryKey(e){if(!e||"object"!=typeof e)return"unknown";const t=e.id??e.tradeId??e.uid??e.uniqueId;if(null!=t&&""!==t)return`id:${t}`;return`fallback:${(e.ticker||"").toString().trim().toUpperCase()}|${e.entryDate||""}|${e.strikePrice||""}`}rebuildQuoteRefreshSchedule(){this.activeQuoteEntries instanceof Map||(this.activeQuoteEntries=new Map),this.quoteRefreshKeys=Array.from(this.activeQuoteEntries.keys()),this.quoteRefreshCursor=0}startQuoteAutoRefreshIfNeeded(){if(this.activeQuoteEntries instanceof Map||(this.activeQuoteEntries=new Map),0===this.activeQuoteEntries.size)return void this.stopQuoteAutoRefresh();const e=this.computeAutoRefreshInterval();e!==this.autoRefreshIntervalMs&&(this.autoRefreshIntervalMs=e,this.stopQuoteAutoRefresh()),this.quoteRefreshIntervalId||(this.quoteRefreshIntervalId=setInterval(()=>{this.refreshActivePositionsQuotes({force:!0})},this.autoRefreshIntervalMs))}stopQuoteAutoRefresh(){this.quoteRefreshIntervalId&&(clearInterval(this.quoteRefreshIntervalId),this.quoteRefreshIntervalId=null),0===this.activeQuoteEntries?.size&&(this.quoteRefreshKeys=[],this.quoteRefreshCursor=0)}refreshActivePositionsQuotes({force:e=!1,immediate:t=!1}={}){if(!(this.activeQuoteEntries instanceof Map)||0===this.activeQuoteEntries.size)return void this.stopQuoteAutoRefresh();if(Array.isArray(this.quoteRefreshKeys)&&0!==this.quoteRefreshKeys.length||this.rebuildQuoteRefreshSchedule(),0===this.quoteRefreshKeys.length)return void this.stopQuoteAutoRefresh();let i=0;const n=this.quoteRefreshKeys.length;for(;i<n&&this.quoteRefreshKeys.length>0;){const n=this.quoteRefreshCursor%this.quoteRefreshKeys.length,r=this.quoteRefreshKeys[n],a=this.activeQuoteEntries.get(r);if(this.quoteRefreshCursor=(n+1)%this.quoteRefreshKeys.length,i+=1,a&&a.cell?.isConnected&&a.row?.isConnected)return void this.populateQuoteCell(a.cell,a.trade,a.row,{forceRefresh:e,silentIfCached:!e,suppressLoadingText:!t});if(this.activeQuoteEntries.delete(r),this.quoteRefreshKeys.splice(n,1),0===this.quoteRefreshKeys.length)return void this.stopQuoteAutoRefresh()}0===this.activeQuoteEntries.size&&this.stopQuoteAutoRefresh()}populateQuoteCell(e,t,i,n={}){const{forceRefresh:r=!1,deferNetworkFetch:a=!1,silentIfCached:s=!1,suppressLoadingText:o=!1}=n;if(!e)return;const l=(t?.ticker||"").toString().trim().toUpperCase();if(!l)return e.dataset.priceState="idle",e.textContent="—",void e.classList.remove("quote-error");const c=r?null:this.getCachedQuote(l);if(c)this.renderQuoteValue(e,i,t,c.value);else{if(!this.finnhub.apiKey){e.dataset.priceState="error",this.setQuoteCellError(e,i,t,"Set API key");const n=this.finnhub.lastStatus?.message;return"Add your Finnhub API key to load live prices."!==n&&this.updateFinnhubStatus("Add your Finnhub API key to load live prices.","neutral",6e3),void this.updateItmHighlight(i,t,null)}e.dataset.priceState=r?"refreshing":"loading",r||o||s||(e.textContent="Loading…"),e.classList.remove("quote-error"),this.finnhub.apiKey&&!a&&this.getCurrentPrice(l,{forceRefresh:r}).then(n=>{e.isConnected&&this.renderQuoteValue(e,i,t,n)}).catch(n=>{if(!e.isConnected)return;const r=this.getQuoteErrorMessage(n);this.setQuoteCellError(e,i,t,r)})}}renderQuoteValue(e,t,i,n){if(!e)return;e.dataset.priceState="ready",e.classList.remove("quote-error");const r=Number(n?.price);if(!Number.isFinite(r))return e.textContent="—",void this.applyPositionHighlight(t,i,null);const a=this.getQuoteChangePercent(n),s=this.getQuoteChangeValue(n);e.innerHTML="";const o=document.createElement("span");if(o.className="quote-price",o.textContent=this.formatCurrency(r),e.appendChild(o),Number.isFinite(a)){const t=document.createElement("span");t.className="quote-change";const i=`${a>0?"+":""}${a.toFixed(2)}%`;if(t.textContent=i,a>0?t.classList.add("is-up"):a<0?t.classList.add("is-down"):t.classList.add("is-flat"),Number.isFinite(s)){const e=`${s>0?"+":""}${s.toFixed(2)}`;t.title=`${e} (${i})`}e.appendChild(t)}this.applyPositionHighlight(t,i,r)}getQuoteChangePercent(e){const t=Number(e?.changePercent);if(Number.isFinite(t))return t;const i=Number(e?.change),n=Number(e?.previousClose);if(Number.isFinite(i)&&Number.isFinite(n)&&0!==n)return i/n*100;const r=Number(e?.price);return Number.isFinite(r)&&Number.isFinite(n)&&0!==n?(r-n)/n*100:null}getQuoteChangeValue(e){const t=Number(e?.change);if(Number.isFinite(t))return t;const i=Number(e?.price),n=Number(e?.previousClose);return Number.isFinite(i)&&Number.isFinite(n)?i-n:null}setQuoteCellError(e,t,i,n){if(!e)return;e.dataset.priceState="error",e.classList.add("quote-error");const r=(n||"").trim();if("Set API key"===r){e.textContent="";const t=document.createElement("button");t.type="button",t.className="link-button link-button--inline",t.textContent="Set API key",t.addEventListener("click",e=>{e.preventDefault(),this.showView("settings")}),e.appendChild(t)}else e.textContent=r||"Unavailable";this.applyPositionHighlight(t,i,null)}getQuoteErrorMessage(e){const t=(e?.message||"").toLowerCase();return t?t.includes("api key")?"Set API key":t.includes("rate limit")?"Rate limited":t.includes("symbol")?"Bad ticker":t.includes("network")?"Network error":"Unavailable":"Unavailable"}getCachedQuote(e){if(!e)return null;const t=this.finnhub.cache.get(e);return t?Date.now()-t.timestamp>this.finnhub.cacheTTL?(this.finnhub.cache.delete(e),null):t:null}setCachedQuote(e,t){e&&this.finnhub.cache.set(e,{value:t,timestamp:Date.now()})}async getCurrentPrice(e,{forceRefresh:t=!1}={}){const i=(e||"").toString().trim().toUpperCase();if(!i)throw new Error("Invalid symbol");if(t)this.finnhub.cache.delete(i);else{const e=this.getCachedQuote(i);if(e)return e.value}if(!this.finnhub.apiKey)throw new Error("Finnhub API key missing");const n=this.finnhub.outstandingRequests.get(i);if(n)return n;const r=this.enqueueFinnhubRequest(i).then(e=>(this.setCachedQuote(i,e),e)).catch(e=>{throw this.updateFinnhubStatus(e.message||"Failed to load quote.","error",7e3),e}).finally(()=>{this.finnhub.outstandingRequests.delete(i)});return this.finnhub.outstandingRequests.set(i,r),r}enqueueFinnhubRequest(e){const t=this.finnhub.rateLimitQueue.catch(()=>{}).then(()=>this.performFinnhubFetch(e));return this.finnhub.rateLimitQueue=t.then(()=>{}).catch(()=>{}),t}async performFinnhubFetch(e){await this.enforceFinnhubRateLimit();const t=new URL("https://finnhub.io/api/v1/quote");let i,n;t.searchParams.set("symbol",e),t.searchParams.set("token",this.finnhub.apiKey);try{i=await fetch(t.toString(),{cache:"no-store"})}catch(e){throw new Error("Network error fetching price")}if(!i.ok)throw new Error(429===i.status?"Finnhub rate limit exceeded. Please wait.":"Finnhub API error");try{n=await i.json()}catch(e){throw new Error("Invalid response from Finnhub")}if(n&&"string"==typeof n.error)throw new Error(n.error);const r=Number(n?.c);if(!Number.isFinite(r))throw new Error("Price unavailable for symbol");const a=Number(n?.d),s=Number(n?.dp),o=Number(n?.pc),l=Number(n?.o),c=Number(n?.h),d=Number(n?.l);return{price:r,change:Number.isFinite(a)?a:null,changePercent:Number.isFinite(s)?s:null,previousClose:Number.isFinite(o)?o:null,open:Number.isFinite(l)?l:null,high:Number.isFinite(c)?c:null,low:Number.isFinite(d)?d:null,fetchedAt:(new Date).toISOString(),currency:"USD"}}async enforceFinnhubRateLimit(){const e=this.finnhub.timestamps,t=Date.now();for(;e.length>0&&t-e[0]>=6e4;)e.shift();if(e.length>=this.finnhub.maxRequestsPerMinute){const i=6e4-(t-e[0])+50;await new Promise(e=>setTimeout(e,i))}e.push(Date.now())}applyPositionHighlight(e,t,i=null){e&&(this.updateExpirationHighlight(e,t),this.updateItmHighlight(e,t,i))}updateExpirationHighlight(e,t){if(!e)return;e.classList.remove("position-expiring-critical","position-expiring-warning");const i=this.positionHighlightConfig?.expirationWarningDays??20,n=this.positionHighlightConfig?.expirationCriticalDays??7,r=t?.dte,a=this.parseInteger(r,null,{allowNegative:!0});!Number.isFinite(a)||a<0||(a<n?e.classList.add("position-expiring-critical"):a<i&&e.classList.add("position-expiring-warning"))}updateItmHighlight(e,t,i){if(!e)return;const n=this.isInTheMoney(t,i);e.classList.toggle("position-itm",Boolean(n))}isInTheMoney(e,t){if(!Number.isFinite(t))return!1;const i=Number(e?.strikePrice);if(!Number.isFinite(i))return!1;const n=this.inferOptionFlavor(e);return"call"===n?t>=i:"put"===n&&t<=i}inferOptionFlavor(e={}){const t=(e.optionType||e.optionFlavor||"").toString().trim().toLowerCase();if("call"===t||"put"===t)return t;const i=(e.strategy||"").toLowerCase(),n=i.includes("call"),r=i.includes("put");if(n&&!r)return"call";if(r&&!n)return"put";const a=(e.notes||"").toLowerCase(),s=a.includes("call"),o=a.includes("put");return s&&!o?"call":o&&!s?"put":null}updateMonthlyPLChart(){const e=document.getElementById("monthlyPLChart");if(!e)return;const t=e.getContext("2d");this.charts.monthlyPL&&this.charts.monthlyPL.destroy();const i={};this.trades.filter(e=>this.isClosedStatus(e.status)&&e.exitDate).forEach(e=>{const t=e.exitDate.substring(0,7);i[t]||(i[t]=0),i[t]+=e.pl});const n=Object.keys(i).sort(),r=n.map(e=>new Date(e+"-01").toLocaleDateString("en-US",{month:"short",year:"numeric"}));this.charts.monthlyPL=new Chart(t,{type:"bar",data:{labels:r,datasets:[{label:"Monthly P&L",data:n.map(e=>i[e]),backgroundColor:n.map(e=>i[e]>=0?"#1FB8CD":"#B4413C"),borderColor:n.map(e=>i[e]>=0?"#1FB8CD":"#B4413C"),borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{callback:function(e){return"$"+e.toLocaleString()}}},x:{ticks:{maxRotation:45,minRotation:45}}},plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(e){return"P&L: $"+e.raw.toLocaleString()}}}}}})}updateCumulativePLChart(){const e=document.getElementById("cumulativePLChart");if(!e)return void console.error("Cumulative P&L chart canvas not found");const t=e.getContext("2d");this.charts.cumulativePL&&this.charts.cumulativePL.destroy();const i=this.trades.filter(e=>this.isClosedStatus(e.status)&&e.exitDate),n=()=>{this.charts.cumulativePL=new Chart(t,{type:"line",data:{labels:["No Data"],datasets:[{label:"Cumulative P&L",data:[0],borderColor:"#1FB8CD",backgroundColor:"rgba(31, 184, 205, 0.1)",fill:!1,tension:.4}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{ticks:{callback:function(e){return"$"+e.toLocaleString()}}}},plugins:{legend:{display:!1}}}})};if(0===i.length)return void n();const r=new Map;let a=null,s=null;if(i.forEach(e=>{const t=this.getWeekEndingFriday(e.exitDate);if(!t)return;const i=this.getWeekKey(t);r.set(i,(r.get(i)||0)+e.pl),(!a||t<a)&&(a=new Date(t)),(!s||t>s)&&(s=new Date(t))}),!a||!s)return void n();a.setHours(0,0,0,0),s.setHours(0,0,0,0);const o=[],l=[];let c=0;const d=new Date(a);for(;d.getTime()<=s.getTime();){const e=this.getWeekKey(d);c+=r.get(e)||0,o.push(this.formatWeekLabel(d)),l.push(c),d.setDate(d.getDate()+7)}this.charts.cumulativePL=new Chart(t,{type:"line",data:{labels:o,datasets:[{label:"Cumulative P&L",data:l,borderColor:"#1FB8CD",backgroundColor:"rgba(31, 184, 205, 0.1)",fill:!0,tension:.4,pointRadius:3,pointHoverRadius:6}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{x:{ticks:{callback:function(e){if("string"==typeof e)return e;if("number"==typeof e&&this&&"function"==typeof this.getLabelForValue){const t=this.getLabelForValue(e);if(t)return t}return""},maxRotation:45,minRotation:45}},y:{ticks:{callback:function(e){return"$"+e.toLocaleString()}}}},plugins:{legend:{display:!1},tooltip:{callbacks:{title:function(e){return e[0]?.label||""},label:function(e){return"Cumulative P&L: $"+e.raw.toLocaleString()}}}}}})}getWeekEndingFriday(e){const t=new Date(e);if(isNaN(t.getTime()))return null;const i=new Date(t);i.setHours(0,0,0,0);const n=i.getDay();return 5===n?i:6===n?(i.setDate(i.getDate()-1),i):0===n?(i.setDate(i.getDate()-2),i):(i.setDate(i.getDate()+(5-n)),i)}getWeekKey(e){const t=new Date(e);if(isNaN(t.getTime()))return"";return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}formatWeekLabel(e){const t=new Date(e);return isNaN(t.getTime())?"":t.toLocaleDateString("en-US",{month:"short",day:"2-digit",year:"numeric"})}updateStrategyPerformanceChart(){const e=document.getElementById("strategyChart");if(!e)return;const t=e.getContext("2d");this.charts.strategy&&this.charts.strategy.destroy();const i={};this.trades.filter(e=>this.isClosedStatus(e.status)).forEach(e=>{i[e.strategy]||(i[e.strategy]=0),i[e.strategy]+=e.pl});const n=Object.entries(i).sort(([,e],[,t])=>t-e).slice(0,8);this.charts.strategy=new Chart(t,{type:"bar",data:{labels:n.map(([e])=>e),datasets:[{label:"Total P&L",data:n.map(([,e])=>e),backgroundColor:n.map(([,e])=>e>=0?"#1FB8CD":"#B4413C"),borderColor:n.map(([,e])=>e>=0?"#1FB8CD":"#B4413C"),borderWidth:1}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,scales:{x:{beginAtZero:!0,ticks:{callback:function(e){return"$"+e.toLocaleString()}}}},plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(e){return"P&L: $"+e.raw.toLocaleString()}}}}}})}updateWinRateByStrategyChart(){const e=document.getElementById("winRateChart");if(!e)return;const t=e.getContext("2d");this.charts.winRate&&this.charts.winRate.destroy();const i={};this.trades.forEach(e=>{i[e.strategy]||(i[e.strategy]={total:0,wins:0}),this.isClosedStatus(e.status)&&(i[e.strategy].total++,e.pl>0&&i[e.strategy].wins++)});const n=Object.entries(i).filter(([,e])=>e.total>=1).map(([e,t])=>({strategy:e,winRate:t.wins/t.total*100,total:t.total})).sort((e,t)=>t.winRate-e.winRate);this.charts.winRate=new Chart(t,{type:"doughnut",data:{labels:n.map(e=>`${e.strategy} (${e.total})`),datasets:[{data:n.map(e=>e.winRate),backgroundColor:["#1FB8CD","#FFC185","#B4413C","#ECEBD5","#5D878F","#DB4545","#D2BA4C","#964325","#944454","#13343B"].slice(0,n.length),borderWidth:2,borderColor:"#fff"}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"right",labels:{boxWidth:15,padding:15}},tooltip:{callbacks:{label:function(e){return e.label+": "+e.raw.toFixed(2)+"%"}}}}}})}updateMarketConditionChart(){const e=document.getElementById("marketConditionChart");if(!e)return;const t=e.getContext("2d");this.charts.marketCondition&&this.charts.marketCondition.destroy();const i={};this.trades.filter(e=>this.isClosedStatus(e.status)).forEach(e=>{i[e.marketCondition]||(i[e.marketCondition]=0),i[e.marketCondition]+=e.pl}),this.charts.marketCondition=new Chart(t,{type:"bar",data:{labels:Object.keys(i),datasets:[{label:"P&L by Market Condition",data:Object.values(i),backgroundColor:Object.values(i).map(e=>e>=0?"#1FB8CD":"#B4413C"),borderColor:Object.values(i).map(e=>e>=0?"#1FB8CD":"#B4413C"),borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{callback:function(e){return"$"+e.toLocaleString()}}}},plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(e){return"P&L: $"+e.raw.toLocaleString()}}}}}})}updateTradesList(){this.populateFilters(),this.filterTrades()}populateFilters(){const e=document.getElementById("filter-strategy"),t=document.getElementById("filter-trade-type"),i={strategy:e?.value||"",tradeType:t?.value||""},n=[...new Set(this.trades.map(e=>e.strategy))].filter(Boolean).sort((e,t)=>e.localeCompare(t)),r=[...new Set(this.trades.map(e=>this.getTradeType(e)))].filter(e=>e&&"—"!==e).sort((e,t)=>e.localeCompare(t));e&&(e.innerHTML='<option value="">All Strategies</option>',n.forEach(t=>{const i=document.createElement("option");i.value=t,i.textContent=t,e.appendChild(i)}),i.strategy&&n.includes(i.strategy)&&(e.value=i.strategy)),t&&(t.innerHTML='<option value="">All Trade Types</option>',r.forEach(e=>{const i=document.createElement("option");i.value=e,i.textContent=e,t.appendChild(i)}),i.tradeType&&r.includes(i.tradeType)&&(t.value=i.tradeType))}filterTrades(){const e=document.getElementById("filter-strategy")?.value||"",t=document.getElementById("filter-status")?.value||"",i=document.getElementById("filter-market-condition")?.value||"",n=document.getElementById("filter-trade-type")?.value||"",r=(document.getElementById("search-ticker")?.value||"").toString().trim().toLowerCase(),a=this.trades.filter(a=>{const s=!e||a.strategy===e,o=this.normalizeStatus(a.status);let l=!0;if(t){const e=t.toLowerCase();l="assigned"===e?"assigned"===o||"closed"===o&&this.isAssignmentReason(a.exitReason):o===e}const c=!i||a.marketCondition===i,d=this.getTradeType(a),u=!n||d===n,h=(a.ticker??"").toString().toLowerCase(),m=this.normalizeCycleId(a.cycleId).toLowerCase(),p=(this.normalizeCycleType(a.cycleType,a.strategy)||"").toLowerCase(),y=!r||h.includes(r)||m.includes(r)||p&&p.includes(r);return s&&l&&c&&u&&y});this.renderTradesTable(a)}openTradesFilteredByTicker(e){const t=(e??"").toString().trim().toUpperCase();if(!t)return;this.showView("trades-list");const i=document.getElementById("search-ticker");i&&(i.value=t,i.focus()),["filter-strategy","filter-status","filter-market-condition","filter-trade-type"].forEach(e=>{const t=document.getElementById(e);t&&""!==t.value&&(t.value="")}),this.filterTrades()}openTradesFilteredByCycle(e,t=""){const i=this.normalizeCycleId(e);if(!i)return;this.showView("trades-list");const n=document.getElementById("search-ticker");n&&(n.value=i,n.focus()),this.filterTrades()}renderTradesTable(e=this.trades){const t=document.querySelector("#trades-table tbody");if(!t)return;t.innerHTML="",this.tradeDetailCharts?.size&&(this.tradeDetailCharts.forEach(e=>{try{e.destroy()}catch(e){console.warn("Failed to destroy payoff chart:",e)}}),this.tradeDetailCharts.clear());const i=e=>{const t=Number(e);return Number.isFinite(t)?t:null},n=["Ticker","Strategy","Cycle","Trade Type","Strike","Qty","Entry Price","Exit Price","Entry Date","Expiration","DTE","Exit Date","Days Held","Max Risk","P&L","ROI","Annual ROI","Status","Actions"];e.forEach((e,r)=>{const a=t.insertRow();a.classList.add("trade-summary-row");a.insertCell(0).appendChild(this.createTickerElement(e.ticker)),a.insertCell(1).textContent=e.strategy||"—";const s=a.insertCell(2),o=this.normalizeCycleId(e.cycleId);if(o){const t=this.normalizeCycleType(e.cycleType,e.strategy),i=document.createElement("button");i.type="button",i.className="cycle-chip cycle-chip--link",i.textContent=t?`${o} (${t.toUpperCase()})`:o,i.addEventListener("click",t=>{t.stopPropagation(),this.openTradesFilteredByCycle(o,e.ticker)}),i.title="View trades in this cycle",s.appendChild(i)}else s.textContent="—";const l=a.insertCell(3),c=this.getTradeType(e);l.textContent=c;l.className={BTO:"trade-type-bto",STO:"trade-type-sto",STC:"trade-type-stc",BTC:"trade-type-btc"}[c]||"";const d=a.insertCell(4),u=i(e.strikePrice);d.textContent=null!==u?`$${u.toFixed(2)}`:"—";const h=a.insertCell(5),m=i(e.quantity);h.textContent=null!==m?Math.abs(m):"—";const p=a.insertCell(6),y=i(e.entryPrice);p.textContent=null!==y?`$${y.toFixed(2)}`:"—";const g=a.insertCell(7),f=i(e.exitPrice);g.textContent=null!==f?`$${f.toFixed(2)}`:"-",a.insertCell(8).textContent=this.formatDate(e.entryDate),a.insertCell(9).textContent=this.formatDate(e.expirationDate);const b=a.insertCell(10),C=i(e.dte);b.textContent=null!==C?C:"—";a.insertCell(11).textContent=e.exitDate?this.formatDate(e.exitDate):"-";const v=a.insertCell(12),k=i(e.daysHeld);v.textContent=null!==k?k:"—";const x=a.insertCell(13),T=i(e.maxRisk);null!==T?(x.textContent=this.formatCurrency(T),x.className="pl-negative"):(x.textContent="—",x.className="pl-neutral");const w=a.insertCell(14),I=i(e.pl);null!==I?(w.textContent=this.formatCurrency(I),w.className=I>0?"pl-positive":I<0?"pl-negative":"pl-neutral"):(w.textContent="—",w.className="pl-neutral");const N=a.insertCell(15),S=i(e.roi);null!==S?(N.textContent=`${S.toFixed(2)}%`,N.className=S>0?"pl-positive":S<0?"pl-negative":"pl-neutral"):(N.textContent="—",N.className="pl-neutral");const P=a.insertCell(16),E=i(e.annualizedROI);this.isClosedStatus(e.status)&&null!==E?(P.textContent=`${E.toFixed(2)}%`,P.className=E>0?"pl-positive":E<0?"pl-negative":"pl-neutral"):(P.textContent="-",P.className="pl-neutral");const D=a.insertCell(17),L=document.createElement("span"),R=this.getDisplayStatus(e),A=R.toLowerCase().replace(/\s+/g,"-");L.className=`status-badge ${A}`.trim(),L.textContent=R,D.appendChild(L);const F=a.insertCell(18);F.className="actions-cell";const M=`trade-pl-${e.id??e.tradeId??e.uniqueId??`${e.ticker||"trade"}-${r}`}`.toString().replace(/[^a-zA-Z0-9_-]/g,"-"),B=`${M}-footnote`,O=document.createElement("button");O.type="button",O.className="action-btn action-btn--edit",O.textContent="Edit",O.addEventListener("click",t=>{t.stopPropagation(),this.editTrade(e.id)});const $=document.createElement("button");$.type="button",$.className="action-btn action-btn--delete",$.textContent="Delete",$.addEventListener("click",t=>{t.stopPropagation(),this.deleteTrade(e.id)}),F.append(O,$),a.setAttribute("tabindex","0"),a.setAttribute("aria-expanded","false"),a.setAttribute("aria-controls",M),a.dataset.chartId=M;const _=t.insertRow();_.className="trade-detail-row",_.setAttribute("aria-hidden","true"),_.style.display="none",_.dataset.chartId=M;const G=_.insertCell(0);G.colSpan=n.length,G.innerHTML=`\n                <div class="trade-diagram" data-chart-container="${M}">\n                    <div class="trade-diagram__canvas">\n                        <canvas id="${M}" aria-hidden="true"></canvas>\n                    </div>\n                    <p class="trade-diagram__footnote" id="${B}">Tap or click the trade row to generate the payoff diagram.</p>\n                </div>\n            `;const U=()=>{this.toggleTradePayoffDetail(a,_,e,M,B)};a.addEventListener("click",e=>{e.target.closest("button")||e.target.closest("a")||e.target.closest("input")||e.target.closest(".trade-diagram")||U()}),a.addEventListener("keydown",e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),U())}),this.applyResponsiveLabels(a,n)})}toggleTradePayoffDetail(e,t,i,n,r){if(!t)return;const a=!t.classList.contains("is-open");t.classList.toggle("is-open",a),t.style.display=a?"table-row":"none",t.setAttribute("aria-hidden",String(!a)),e?.setAttribute("aria-expanded",String(a));const s=t.querySelector("canvas");if(s&&s.setAttribute("aria-hidden",String(!a)),a){const e=this.renderTradePayoffChart(i,n,r);e?.catch&&e.catch(e=>{console.error("Failed to render payoff chart:",e)})}else this.destroyTradePayoffChart(n,r)}async renderTradePayoffChart(e,t,i){const n=document.getElementById(t),r=document.getElementById(i),a=n?.parentElement;if(!n)return void(r&&(r.textContent="Canvas element missing; cannot generate payoff diagram."));if(this.tradeDetailCharts?.has(t))return;r&&(r.textContent="Loading live price and payoff data…");const s=this.calculatePayoffSeries(e);if(!s||!Array.isArray(s.points)||0===s.points.length)return a&&a.classList.add("trade-diagram__canvas--empty"),n.classList.add("hidden"),void(r&&(r.textContent=s?.message||"Payoff diagram not available for this strategy yet."));n.classList.remove("hidden"),a?.classList.remove("trade-diagram__canvas--empty");const o=n.getContext("2d");if(!o)return void(r&&(r.textContent="Unable to access canvas rendering context."));const l=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:2}),c="rgba(34, 197, 94, 1)",d=s.points.map(e=>e.y);let u=Math.min(...d,0),h=Math.max(...d,0);Number.isFinite(u)&&Number.isFinite(h)||(u=0,h=0),u===h&&(u-=1,h+=1);const m=s.points.map(e=>({x:e.x,y:e.y>=0?e.y:null})),p=s.points.map(e=>({x:e.x,y:e.y<=0?e.y:null})),y=o.createLinearGradient(0,0,0,n.height);y.addColorStop(0,"rgba(34, 197, 94, 0.18)"),y.addColorStop(1,"rgba(34, 197, 94, 0.02)");const g=o.createLinearGradient(0,0,0,n.height);g.addColorStop(0,"rgba(248, 113, 113, 0.18)"),g.addColorStop(1,"rgba(248, 113, 113, 0.02)");const f=await this.getUnderlyingPriceForPayoff(e),b=document.querySelector(`.trade-detail-row[data-chart-id="${t}"]`);if(b&&!b.classList.contains("is-open"))return void(r&&(r.textContent="Tap or click the trade row to generate the payoff diagram."));const C={id:`payoffPriceLineLabel-${t}`,afterDatasetsDraw:e=>{if(!Number.isFinite(f))return;const t=e.scales?.x,i=e.chartArea;if(!t||!i)return;const n=t.getPixelForValue(f);if(!Number.isFinite(n)||n<i.left||n>i.right)return;e.scales;const r=e.ctx;r.save(),r.font='12px "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',r.fillStyle="rgba(30, 41, 59, 0.9)",r.textBaseline="middle",r.textAlign="center";let a=i.bottom-10-50;(!Number.isFinite(a)||a<i.top+12)&&(a=i.top+12);const s=n<(i.left+i.right)/2?Math.min(i.right-18,n+18):Math.max(i.left+18,n-18),o=`Current ${l.format(f)}`;r.translate(s,a),r.rotate(-Math.PI/2),r.fillText(o,0,0),r.restore()}},v=[{id:"currentPriceLine",label:"Current Price",data:[],borderColor:"rgba(100, 116, 139, 0.95)",borderDash:[6,4],borderWidth:2,hoverBorderColor:"rgba(100, 116, 139, 0.95)",hoverBorderWidth:2,pointRadius:0,pointHitRadius:0,fill:!1,order:0,hidden:!0},{id:"breakevenLine",label:"Breakeven",data:[],borderColor:"rgba(59, 130, 246, 0.8)",borderDash:[2,4],borderWidth:1,pointRadius:0,pointHitRadius:0,fill:!1,order:0,hidden:!0},{id:"positiveFill",label:"Profit Region",data:m,borderColor:"rgba(0,0,0,0)",backgroundColor:y,hoverBackgroundColor:y,hoverBorderColor:"rgba(0, 0, 0, 0)",hoverBorderWidth:0,fill:"origin",pointRadius:0,pointHitRadius:0,tension:0,order:1,spanGaps:!0,showLine:!0},{id:"negativeFill",label:"Loss Region",data:p,borderColor:"rgba(0,0,0,0)",backgroundColor:g,hoverBackgroundColor:g,hoverBorderColor:"rgba(0, 0, 0, 0)",hoverBorderWidth:0,fill:"origin",pointRadius:0,pointHitRadius:0,tension:0,order:1,spanGaps:!0,showLine:!0},{id:"payoffLine",label:"P&L at Expiration",data:s.points,borderColor:c,hoverBorderColor:c,hoverBorderWidth:2,tension:0,pointRadius:0,pointHoverRadius:0,borderWidth:2,fill:!1,order:2,segment:{borderColor:e=>{const t=e.p0.parsed?.y,i=e.p1.parsed?.y;return t>=0&&i>=0?c:t<=0&&i<=0?"rgba(248, 113, 113, 1)":"rgba(148, 163, 184, 1)"}}},{id:"zeroLine",label:"Break-even Baseline",data:s.zeroLinePoints??s.points.map(e=>({x:e.x,y:0})),borderColor:"rgba(71, 85, 105, 0.9)",borderDash:[4,4],borderWidth:2,hoverBorderColor:"rgba(71, 85, 105, 0.95)",hoverBorderWidth:2,pointRadius:0,pointHitRadius:0,fill:!1,order:3}];if(Number.isFinite(f)){const e=v.findIndex(e=>"currentPriceLine"===e.id);-1!==e&&(v[e].data=[{x:f,y:u},{x:f,y:h}],v[e].hidden=!1)}if(Number.isFinite(s.breakeven)){const e=v.findIndex(e=>"breakevenLine"===e.id);-1!==e&&(v[e].data=[{x:s.breakeven,y:u},{x:s.breakeven,y:h}])}const k=new Chart(o,{type:"line",data:{datasets:v},plugins:[C],options:{parsing:!1,responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},hover:{mode:"index",intersect:!1},plugins:{legend:{display:!1},tooltip:{callbacks:{label:e=>{if(!e.dataset||"payoffLine"!==e.dataset.id)return null;const t=Number(e.parsed?.x),i=Number(e.parsed?.y);if(!Number.isFinite(t)||!Number.isFinite(i))return null;const n=l.format(i),r=l.format(t);return`${e.dataset.label||"P&L"}: ${n} @ ${r}`}}}},scales:{x:{type:"linear",title:{display:!0,text:"Underlying Price ($)"},ticks:{callback:e=>l.format(Number(e))}},y:{title:{display:!0,text:"P&L ($)"},ticks:{callback:e=>l.format(Number(e))},suggestedMin:u,suggestedMax:h}}}});this.tradeDetailCharts.set(t,k),r&&(r.textContent=this.formatPayoffFooter(s,l))}destroyTradePayoffChart(e,t){const i=this.tradeDetailCharts?.get(e);if(i){try{i.destroy()}catch(e){console.warn("Failed to destroy payoff chart:",e)}this.tradeDetailCharts.delete(e)}const n=document.getElementById(e),r=n?.parentElement;if(n){const e=n.getContext("2d");e&&e.clearRect(0,0,n.width,n.height),n.classList.remove("hidden")}if(r?.classList.remove("trade-diagram__canvas--empty"),t){const e=document.getElementById(t);e&&(e.textContent="Tap or click the trade row to generate the payoff diagram.")}}async getUnderlyingPriceForPayoff(e={}){const t=(e?.ticker||"").toString().trim().toUpperCase();if(t){const e=this.getCachedQuote(t);if(e?.value&&Number.isFinite(Number(e.value.price)))return Number(e.value.price);if(this.finnhub.apiKey)try{const e=await this.getCurrentPrice(t),i=Number(e?.price);if(Number.isFinite(i)&&i>0)return i}catch(e){console.warn("Live price lookup failed for payoff chart:",e)}}return this.getFallbackUnderlyingPrice(e)}getFallbackUnderlyingPrice(e={}){const t=[e.currentUnderlyingPrice,e.currentPrice,e.marketPrice,e.lastUnderlyingPrice,e.lastPrice,e.markPrice,e.referencePrice,e.stockPriceAtEntry];for(const e of t){const t=Number(e);if(Number.isFinite(t)&&t>0)return t}return null}calculatePayoffSeries(e){const t=this.determinePayoffModel(e);if(!t||"unsupported"===t.type)return{message:t?.reason||"Payoff diagram not available for this strategy yet."};switch(t.type){case"single":return this.calculateSingleLegSeries(e,t);case"vertical":return this.calculateVerticalSpreadSeries(e,t);case"covered-call":return this.calculateCoveredCallSeries(e,t);case"pmcc":return this.calculatePmccSeries(e,t);default:return{message:"Payoff diagram not available for this strategy yet."}}}determinePayoffModel(e){const t=(e.strategy||"").toString().trim(),i=t.toLowerCase(),n=Number(e.definedRiskWidth);if(!i)return{type:"unsupported",reason:"Add a strategy name to unlock payoff diagrams."};const r=this.normalizeCycleType(e.cycleType,t);if(i.includes("poor man's covered call")||i.includes("poor man")||"pmcc"===r||this.isPmccBaseLeg(e)||this.isPmccShortCall(e)){const t=this.extractPmccLegs(e);return t.baseLeg?{type:"pmcc",strategy:i,...t}:{type:"unsupported",reason:"Add the PMCC base leg to this cycle to unlock the payoff diagram."}}if(i.includes("covered call"))return{type:"covered-call",strategy:i};const a=/(iron|straddle|strangle|butterfly|ratio|lizard|combo|synthetic|double|calendar|diagonal)/.test(i),s=i.includes("put")?"put":i.includes("call")?"call":null,o=/calendar|diagonal/.test(i);if(i.includes("spread")&&!o&&!(n>0))return{type:"unsupported",reason:"Add the defined risk width to visualize this spread."};if(n>0&&s&&i.includes("spread")&&!o){return{type:"vertical",optionType:s,orientation:i.includes("short")||i.includes("credit")||"short"===this.inferTradeDirection(e)?"short":"long",width:Number(n),strategy:i}}if(a)return{type:"unsupported",reason:"Visualization for multi-leg strategies such as condors, straddles, or ratios is coming soon."};if(!s)return{type:"unsupported",reason:"Unable to infer option type from the strategy name."};return{type:"single",optionType:s,direction:"short"===this.inferTradeDirection(e)?"short":"long",strategy:i}}calculateSingleLegSeries(e,t){const i=Number(e.strikePrice),n=Number(e.entryPrice),r=Number(e.fees)||0,a=Math.abs(Number(e.quantity)||1),s=Number(e.stockPriceAtEntry);if(!Number.isFinite(i)||!Number.isFinite(n))return{message:"Provide both a strike price and entry price to view this payoff."};const o=this.buildPriceRange({strikeValues:[i],spot:s}),l=100*a,c=[];for(let e=0;e<=40;e++){const a=o.minPrice+(o.maxPrice-o.minPrice)*e/40,s=this.optionIntrinsic(t.optionType,a,i),d=("long"===t.direction?s-n:n-s)*l-r;c.push({x:parseFloat(a.toFixed(2)),y:parseFloat(d.toFixed(2))})}const d=c.map(e=>({x:e.x,y:0})),u="call"===t.optionType?i+n:i-n,h=n*l;let m,p;"long"===t.direction?(m="call"===t.optionType?1/0:Math.max((i-n)*l-r,0),p=h+r):(m=Math.max(h-r,0),p="call"===t.optionType?1/0:Math.max((i-n)*l+r,0));return{points:c,zeroLinePoints:d,summary:this.buildPayoffSummary({profileLabel:`${"short"===t.direction?"Short":"Long"} ${t.optionType.toUpperCase()}`,breakeven:u,maxProfit:m,maxLoss:p,contracts:a,isCredit:"short"===t.direction}),breakeven:u,maxProfit:m,maxLoss:p}}calculateVerticalSpreadSeries(e,t){const i=Number(e.strikePrice),n=Number(e.entryPrice),r=Number(e.fees)||0,a=Math.abs(Number(e.quantity)||1),s=Number(e.stockPriceAtEntry);if(!Number.isFinite(i)||!Number.isFinite(n))return{message:"Provide strike and entry price to view this spread payoff."};if(!(t.width>0))return{message:"Add the defined risk width to visualize this spread."};let o,l;if("call"===t.optionType?"short"===t.orientation?(o=i,l=i+t.width):(l=i,o=i+t.width):"short"===t.orientation?(o=i,l=i-t.width):(l=i,o=i-t.width),!Number.isFinite(o)||!Number.isFinite(l))return{message:"Unable to determine both strikes for this spread."};const c=this.buildPriceRange({strikeValues:[o,l],spot:s}),d=100*a,u=[];for(let e=0;e<=40;e++){const i=c.minPrice+(c.maxPrice-c.minPrice)*e/40,a=this.optionIntrinsic(t.optionType,i,o),s=this.optionIntrinsic(t.optionType,i,l),h=("short"===t.orientation?n-(a-s):s-a-n)*d-r;u.push({x:parseFloat(i.toFixed(2)),y:parseFloat(h.toFixed(2))})}const h=u.map(e=>({x:e.x,y:0})),m=this.calculateSpreadBreakeven({model:t,shortStrike:o,longStrike:l,entryPrice:n}),p=Math.abs(o-l)*d,y=n*d;let g,f;"short"===t.orientation?(g=Math.max(y-r,0),f=Math.max(p-y,0)+r):(g=Math.max(Math.max(p-y,0)-r,0),f=y+r);return{points:u,zeroLinePoints:h,summary:this.buildPayoffSummary({profileLabel:`${"short"===t.orientation?"Short":"Long"} ${"call"===t.optionType?"Call":"Put"} Spread`,breakeven:m,maxProfit:g,maxLoss:f,contracts:a,isCredit:"short"===t.orientation}),breakeven:m,maxProfit:g,maxLoss:f}}calculateCoveredCallSeries(e){const t=Number(e.strikePrice),i=Number(e.entryPrice),n=Number(e.stockPriceAtEntry),r=Number(e.fees)||0,a=Math.abs(Number(e.quantity)||1);if(!Number.isFinite(t)||!Number.isFinite(i)||!Number.isFinite(n))return{message:"Covered call payoff requires strike, option premium, and stock cost basis."};const s=this.buildPriceRange({strikeValues:[t,n],spot:n}),o=100*a,l=[];for(let e=0;e<=40;e++){const a=s.minPrice+(s.maxPrice-s.minPrice)*e/40,c=(a-n+(i-this.optionIntrinsic("call",a,t)))*o-r;l.push({x:parseFloat(a.toFixed(2)),y:parseFloat(c.toFixed(2))})}const c=l.map(e=>({x:e.x,y:0})),d=n-i,u=Math.max((t-n+i)*o-r,0),h=Math.max((n-i)*o+r,0);return{points:l,zeroLinePoints:c,summary:this.buildPayoffSummary({profileLabel:"Covered Call (Stock + Short Call)",breakeven:d,maxProfit:u,maxLoss:h,contracts:a,isCredit:!0}),breakeven:d,maxProfit:u,maxLoss:h}}calculatePmccSeries(e,t){const i=t.baseLeg;if(!i)return{message:"Add the PMCC base leg to visualize this payoff."};const n=Number(i.strikePrice),r=Number(i.entryPrice),a=Number(i.fees)||0,s=Math.abs(Number(i.quantity)||1);if(!Number.isFinite(n)||!Number.isFinite(r))return{message:"Provide strike and entry price for the PMCC base leg to view this payoff."};const o=t.shortLeg,l=Number(o?.strikePrice),c=Number(o?.entryPrice),d=Number(o?.fees)||0,u=Math.abs(Number(o?.quantity)||0),h=o?this.inferTradeDirection(o):null,m=[n];Number.isFinite(l)&&m.push(l);const p=this.getFallbackUnderlyingPrice(i)??(o?this.getFallbackUnderlyingPrice(o):null)??Number(i.stockPriceAtEntry),y=this.buildPriceRange({strikeValues:m,spot:Number.isFinite(p)?p:Number.NaN}),g=100*s,f=u>0?100*u:g,b=[];for(let e=0;e<=80;e++){const t=y.minPrice+(y.maxPrice-y.minPrice)*e/80,i=(Math.max(t-n,0)-r)*g-a;let s=0;if(o&&Number.isFinite(l)&&Number.isFinite(c)){const e=Math.max(t-l,0);s=("short"===h?c-e:e-c)*f-d}const u=i+s;b.push({x:parseFloat(t.toFixed(2)),y:parseFloat(u.toFixed(2))})}const C=b.map(e=>({x:e.x,y:0})),v=r*g+a;let k=0;o&&Number.isFinite(c)&&(k="short"===h?c*f-d:-(c*f+d));const x=v-k,T=g>0?x/g:0,w=Number.isFinite(T)?n+T:null;let I=1/0;if(o&&Number.isFinite(l)&&"short"===h){const e=Math.max(Math.min(s,u),0);if(e>0){const t=l-n;Number.isFinite(t)&&(I=100*t*e-x)}}const N=x>0?x:0;return{points:b,zeroLinePoints:C,summary:this.buildPayoffSummary({profileLabel:"Poor Man's Covered Call",breakeven:w,maxProfit:I,maxLoss:N,contracts:s,isCredit:x<0}),breakeven:w,maxProfit:I,maxLoss:N}}calculateSpreadBreakeven({model:e,shortStrike:t,longStrike:i,entryPrice:n}){return"short"===e.orientation?"call"===e.optionType?t+n:t-n:"call"===e.optionType?i+n:i-n}optionIntrinsic(e,t,i){return Number.isFinite(t)&&Number.isFinite(i)?"call"===e?Math.max(t-i,0):Math.max(i-t,0):0}extractPmccLegs(e={}){const t=e=>(e||"").toString().trim().toUpperCase(),i=this.normalizeCycleId(e.cycleId);let n=[];if(i&&(n=this.trades.filter(e=>this.normalizeCycleId(e.cycleId)===i)),0===n.length){const i=t(e.ticker);i&&(n=this.trades.filter(e=>t(e.ticker)===i&&"pmcc"===this.normalizeCycleType(e.cycleType,e.strategy)))}n.includes(e)||n.push(e);const r=(e=[])=>[...e].sort((e,t)=>{const i=this.normalizeStatus(e.status),n=this.normalizeStatus(t.status);if("open"===i&&"open"!==n)return-1;if("open"!==i&&"open"===n)return 1;const r=new Date(e.entryDate||e.openDate||0).getTime();return new Date(t.entryDate||t.openDate||0).getTime()-r});let a=r(n.filter(e=>this.isPmccBaseLeg(e)))[0];if(!a){a=r(n.filter(e=>"long"===this.inferTradeDirection(e)&&(e.strategy||"").toLowerCase().includes("call")))[0]||("long"===this.inferTradeDirection(e)?e:null)}let s=r(n.filter(e=>this.isPmccShortCall(e)))[0];if(!s){s=r(n.filter(e=>"short"===this.inferTradeDirection(e)&&(e.strategy||"").toLowerCase().includes("call")))[0]||("short"===this.inferTradeDirection(e)?e:null)}return a&&s&&a===s&&(s=null),{baseLeg:a,shortLeg:s}}buildPriceRange({strikeValues:e=[],spot:t=Number.NaN}={}){const i=e.map(e=>Number(e)).filter(Number.isFinite);if(Number.isFinite(t)&&i.push(t),0===i.length)return{minPrice:0,maxPrice:100};let n=Math.max(Math.min(...i),0),r=Math.max(...i);if(n===r)n=Math.max(0,.7*n),r=1.3*r+1;else{const e=r-n;n=Math.max(0,n-.3*e),r+=.3*e}return r-n<5&&(n=Math.max(0,n-2.5),r+=2.5),{minPrice:n,maxPrice:r}}buildPayoffSummary({profileLabel:e,breakeven:t,maxProfit:i,maxLoss:n,contracts:r,isCredit:a=!1}){const s=[];return e&&s.push(e),Number.isFinite(t)&&s.push(`Breakeven ${this.formatCurrency(t)}`),i===1/0?s.push("Max profit unlimited"):Number.isFinite(i)&&s.push(`Max profit ${this.formatCurrency(i)}`),n===1/0?s.push("Max loss unlimited (theoretical)"):Number.isFinite(n)&&s.push(`Max loss ${this.formatCurrency(n)}`),Number.isFinite(r)&&s.push(`${r} contract${1===r?"":"s"}${a?" (credit)":""}`),s.join(" • ")||"Payoff preview unavailable."}formatPayoffFooter(e,t){const i=e=>e===1/0||e===-1/0?"Unlimited":Number.isFinite(e)?t.format(e):"—";return[`Max profit ${i(e?.maxProfit)}`,`Max loss ${i(e?.maxLoss)}`,`Breakeven ${i(e?.breakeven)}`].join(" • ")}getTradePayoffMeta(e){const t=(e.strategy||"Unspecified strategy").toString(),i=this.getTradeType(e)||"—",n=this.getDisplayStatus(e),r=Math.abs(Number(e.quantity));return[t,i,Number.isFinite(r)&&r>0?`${r} contract${1===r?"":"s"}`:null,n].filter(Boolean).join(" • ")}sortTrades(e){const t="asc"===this.sortDirection[e]?"desc":"asc";this.sortDirection[e]=t,document.querySelectorAll(".sortable").forEach(e=>{e.classList.remove("asc","desc")});const i=document.querySelector(`[data-sort="${e}"]`);i&&i.classList.add(t);const n=[...this.trades].sort((i,n)=>{let r=i[e],a=n[e];return e.includes("Date")&&(r=new Date(r),a=new Date(a)),"asc"===t?r<a?-1:r>a?1:0:r>a?-1:r<a?1:0});this.renderTradesTable(n)}deleteTrade(e){confirm("Are you sure you want to delete this trade?")&&(this.trades=this.trades.filter(t=>t.id!==e),this.saveToStorage(),this.markUnsavedChanges(),this.filterTrades(),this.updateDashboard())}editTrade(e){const t=this.trades.find(t=>t.id===e);if(t){this.currentEditingId=e;const i=document.getElementById("add-trade-form").elements;i.ticker.value=t.ticker,i.strategy.value=t.strategy;const n=this.getTradeType(t);i.tradeType.value=VALID_TRADE_TYPES.has(n)?n:"BTO",i.quantity.value=Math.abs(t.quantity),i.entryDate.value=this.formatDateForInput(t.entryDate),i.expirationDate.value=this.formatDateForInput(t.expirationDate),i.exitDate.value=this.formatDateForInput(t.exitDate),i.status.value=t.status,i.stockPriceAtEntry.value=t.stockPriceAtEntry,i.strikePrice.value=t.strikePrice,i.entryPrice.value=t.entryPrice,i.exitPrice.value=null!==t.exitPrice&&void 0!==t.exitPrice?t.exitPrice:"",i.fees.value=t.fees,i.ivRank.value=t.ivRank||"",i.definedRiskWidth&&(i.definedRiskWidth.value=Number.isFinite(Number(t.definedRiskWidth))?t.definedRiskWidth:""),i.maxRiskOverride&&(i.maxRiskOverride.value=Number.isFinite(Number(t.maxRiskOverride))?t.maxRiskOverride:""),i.marketCondition.value=t.marketCondition,i.convictionLevel.value=t.convictionLevel,i.notes.value=t.notes||"",i.exitReason.value=t.exitReason||"",i.cycleId&&(i.cycleId.value=t.cycleId||""),i.cycleType&&(i.cycleType.value=t.cycleType||""),i.cycleRole&&(i.cycleRole.value=t.cycleRole||""),document.getElementById("conviction-display").textContent=t.convictionLevel,this.updateTickerPreview(t.ticker),this.showView("add-trade")}}exportToCSV(){const e=[["Ticker","Strategy","Trade Type","Strike","Defined Risk Width","Qty","Entry Price","Exit Price","DTE","Days Held","Entry Date","Expiration Date","Exit Date","Max Risk","P&L","ROI %","Annual ROI %","Status","Stock Price at Entry","Fees","Max Risk Override","IV Rank","Market Condition","Conviction Level","Notes","Exit Reason","Cycle ID","Cycle Type","Cycle Role"].join(","),...this.trades.map(e=>[e.ticker,`"${e.strategy}"`,this.getTradeType(e),e.strikePrice,Number.isFinite(Number(e.definedRiskWidth))?Number(e.definedRiskWidth).toFixed(2):"",Math.abs(e.quantity),e.entryPrice,null!==e.exitPrice&&void 0!==e.exitPrice?e.exitPrice:"",e.dte,e.daysHeld,e.entryDate,e.expirationDate,e.exitDate||"",e.maxRisk.toFixed(2),e.pl.toFixed(2),e.roi.toFixed(2),e.annualizedROI.toFixed(2),e.status,e.stockPriceAtEntry,e.fees,Number.isFinite(Number(e.maxRiskOverride))?Number(e.maxRiskOverride).toFixed(2):"",e.ivRank||"",e.marketCondition,e.convictionLevel,`"${e.notes||""}"`,e.exitReason||"",e.cycleId||"",e.cycleType||"",e.cycleRole||""].join(","))].join("\n"),t=new Blob([e],{type:"text/csv"}),i=window.URL.createObjectURL(t),n=document.createElement("a");n.style.display="none",n.href=i,n.download="options_trades_enhanced.csv",document.body.appendChild(n),n.click(),window.URL.revokeObjectURL(i),document.body.removeChild(n)}async saveDatabase(){this.showLoadingIndicator("Saving...");try{const e=this.buildDatabasePayload();this.supportsFileSystemAccess?await this.saveWithFileSystemAPI(e):this.saveWithDownload(e),this.hasUnsavedChanges=!1,this.updateUnsavedIndicator(),this.showNotification("Database saved successfully!","success"),this.saveToStorage({fileName:this.currentFileName})}catch(e){if(console.error("Save error:",e),"AbortError"!==e.name)try{const e=this.buildDatabasePayload();this.saveWithDownload(e),this.hasUnsavedChanges=!1,this.updateUnsavedIndicator(),this.showNotification("Database saved as download!","success"),this.saveToStorage({fileName:this.currentFileName})}catch(e){this.showNotification("Failed to save database","error")}}this.hideLoadingIndicator()}buildDatabasePayload(){return{trades:this.trades,exportDate:(new Date).toISOString(),version:"2.4"}}async saveWithFileSystemAPI(e){try{this.currentFileHandle||(this.currentFileHandle=await window.showSaveFilePicker({suggestedName:"gammaledger.json",types:[{description:"JSON files",accept:{"application/json":[".json"]}}]}));const t=await this.currentFileHandle.createWritable();await t.write(JSON.stringify(e,null,2)),await t.close(),this.currentFileName=this.currentFileHandle.name,this.updateFileNameDisplay()}catch(e){throw e}}saveWithDownload(e){const t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),i=URL.createObjectURL(t),n=document.createElement("a");n.href=i,n.download="gammaledger.json",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(i),this.currentFileName="gammaledger.json",this.updateFileNameDisplay()}async loadDatabase(){this.showLoadingIndicator("Loading...");try{this.supportsFileSystemAccess?await this.loadWithFileSystemAPI():this.loadWithFileInput()}catch(e){console.error("Load error:",e),"AbortError"!==e.name&&this.loadWithFileInput()}this.hideLoadingIndicator()}async loadWithFileSystemAPI(){const[e]=await window.showOpenFilePicker({types:[{description:"JSON files",accept:{"application/json":[".json"]}}]}),t=await e.getFile(),i=await t.text(),n=JSON.parse(i);this.processLoadedData(n,{fileName:e.name,source:"file-open"}),this.currentFileHandle=e,this.showNotification(`Loaded ${this.trades.length} trades successfully!`,"success")}loadWithFileInput(){const e=document.getElementById("file-input");e.onchange=t=>{const i=t.target.files[0];if(i){const t=new FileReader;t.onload=t=>{try{const e=JSON.parse(t.target.result);this.processLoadedData(e,{fileName:i.name,source:"file-open"}),this.showNotification(`Loaded ${this.trades.length} trades successfully!`,"success")}catch(e){this.showNotification("Invalid JSON file","error")}e.value=""},t.readAsText(i)}else e.value=""},e.click()}processLoadedData(e,t={}){if(!e||!Array.isArray(e.trades))throw new Error("Invalid data format");this.trades=e.trades.map(e=>{const t={...e};return t.tradeReasoning&&!t.notes&&(t.notes=t.tradeReasoning,delete t.tradeReasoning),this.enrichTradeData(t)}),t.fileName?this.currentFileName=t.fileName:this.currentFileName||(this.currentFileName="Unsaved Database"),this.hasUnsavedChanges=!1,this.updateUnsavedIndicator(),this.saveToStorage({fileName:this.currentFileName,source:t.source||"import"}),this.updateDashboard(),"trades-list"===this.currentView&&this.updateTradesList(),this.updateFileNameDisplay(),this.initializeAIChat()}newDatabase(){this.hasUnsavedChanges&&!confirm("You have unsaved changes. Are you sure you want to create a new database?")||(this.trades=[],this.currentFileHandle=null,this.currentFileName="Unsaved Database",this.hasUnsavedChanges=!1,this.updateFileNameDisplay(),this.updateUnsavedIndicator(),this.saveToStorage({fileName:this.currentFileName}),this.updateDashboard(),this.showNotification("New database created","success"),this.initializeAIChat())}updateFileNameDisplay(){const e=document.getElementById("current-file-name");e&&(e.textContent=this.currentFileName,"Unsaved Database"===this.currentFileName?e.classList.add("is-unsaved"):e.classList.remove("is-unsaved"))}updateUnsavedIndicator(){const e=document.getElementById("unsaved-indicator");this.hasUnsavedChanges?e.classList.remove("hidden"):e.classList.add("hidden")}showLoadingIndicator(e="Loading..."){const t=document.getElementById("loading-indicator");t&&(t.textContent=e,t.classList.remove("hidden"))}hideLoadingIndicator(){const e=document.getElementById("loading-indicator");e&&e.classList.add("hidden")}showNotification(e,t="info"){"error"===t?alert(`Error: ${e}`):console.log(`${t.toUpperCase()}: ${e}`)}markUnsavedChanges(){this.hasUnsavedChanges=!0,this.updateUnsavedIndicator()}saveToStorage(e={}){try{const t={version:"2.4",timestamp:(new Date).toISOString(),fileName:e.fileName||this.currentFileName||"Unsaved Database",trades:this.trades};localStorage.setItem(LOCAL_STORAGE_KEY,JSON.stringify(t)),localStorage.removeItem(LEGACY_STORAGE_KEY)}catch(e){console.warn("Failed to save to localStorage:",e)}}async loadFromStorage(){try{const e=localStorage.getItem(LOCAL_STORAGE_KEY);if(e){const t=JSON.parse(e);if(t&&Array.isArray(t.trades))return this.trades=t.trades.map(e=>{const t={...e};return t.tradeReasoning&&!t.notes&&(t.notes=t.tradeReasoning),delete t.tradeReasoning,this.enrichTradeData(t)}),t.fileName&&(this.currentFileName=t.fileName),this.hasUnsavedChanges=!1,this.updateUnsavedIndicator(),this.updateFileNameDisplay(),this.updateDashboard(),!0}const t=localStorage.getItem(LEGACY_STORAGE_KEY);if(t){const e=JSON.parse(t);if(Array.isArray(e))return this.trades=e.map(e=>{const t={...e};return t.tradeReasoning&&!t.notes&&(t.notes=t.tradeReasoning),delete t.tradeReasoning,this.enrichTradeData(t)}),this.currentFileName="Unsaved Database",this.hasUnsavedChanges=!1,this.updateUnsavedIndicator(),this.saveToStorage({fileName:this.currentFileName}),this.updateFileNameDisplay(),this.updateDashboard(),!0}}catch(e){console.warn("Failed to load from localStorage:",e)}return!1}formatPercent(e,t="—"){const i=Number(e);return Number.isFinite(i)?`${i.toFixed(2)}%`:t}formatCycleDateRange(e,t,i){if(!e)return"—";const n=new Date(e),r=t?new Date(t):null,a=new Intl.DateTimeFormat("en-US",{month:"short",day:"numeric",year:"numeric"}),s=isNaN(n.getTime())?"—":a.format(n);let o;return o=r&&!isNaN(r.getTime())?a.format(r):i?"Present":"—",o?`${s} — ${o}`:s}escapeHTML(e){return null==e?"":e.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}formatCurrency(e){const t=Number(e);return Number.isFinite(t)?new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(t):"—"}formatDate(e){const t=new Date(e);return isNaN(t.getTime())?"—":t.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}}class LocalInsightsAgent{constructor(e){this.app=e,this.context={stats:null,openTrades:[],closedTrades:[]}}updateContext({stats:e,openTrades:t,closedTrades:i}={}){e&&(this.context.stats=e),Array.isArray(t)&&(this.context.openTrades=t),Array.isArray(i)&&(this.context.closedTrades=i)}hasTradeHistory(){return(this.context.openTrades?.length||0)>0||(this.context.closedTrades?.length||0)>0}getGreeting(){if(!this.hasTradeHistory())return"Hi! I'm your local AI coach. Add or import a few trades and I'll help you analyze risk and performance.";const e=this.context.stats;if(!e)return"Hi! I'm your local AI coach. Ask about performance, risk, or next steps.";const t=this.context.openTrades?.length||0;return`Hi! I'm your local AI coach. You have ${t} active ${1===t?"position":"positions"} and ${this.context.closedTrades?.length||0} closed trades with realised P&L of ${this.formatCurrency(e.totalPL)}.`}generateResponse(e=""){if(!e.trim())return"I can run a portfolio health check, review risk exposure, or suggest strategy adjustments. Try asking for a quick portfolio health check.";if(!this.hasTradeHistory())return"Log a few trades first and I'll start surfacing insights about risk, performance, and strategy.";const t=[],i=this.buildPerformanceSummary();i&&t.push(i);const n=this.buildRiskHeadline();n&&t.push(n);const r=this.buildStrategyHeadline();r&&t.push(r);const a=this.buildCoachingHighlight();return a&&t.push(a),t.length||t.push("Portfolio data is limited, but keep logging trades and I'll highlight trends as they emerge."),t.join("\n\n")}buildPerformanceSummary(){const e=this.context.stats;if(!e)return"";const t=this.context.closedTrades?.length||0;if(!t)return"No closed trades yet. Once you realize some P&L I'll summarize your performance here.";const i=Number.isFinite(e.winRate)?`${e.winRate.toFixed(1)}%`:"—",n=Number.isFinite(e.profitFactor)?e.profitFactor.toFixed(2):"—",r=Number.isFinite(e.totalROI)?`${e.totalROI.toFixed(2)}%`:"—";return`Closed trades: ${t}, realised P&L ${this.formatCurrency(e.totalPL)}, win rate ${i}, profit factor ${n}, total ROI ${r}.`}buildRiskHeadline(){const e=this.context.openTrades||[];if(!e.length)return"No open positions right now, so live risk exposure is minimal.";let t=0,i=0,n=null;if(e.forEach(e=>{const r=Math.max(0,Number(this.app.getCapitalAtRisk(e))||0);t+=r,r>i&&(i=r,n=e)}),!t)return"Open positions detected, but max risk looks minimal based on current data.";if(n&&t){const r=(i/t*100).toFixed(0),a=(n.ticker||"Unknown").toUpperCase();return`Open risk across ${e.length} ${1===e.length?"position":"positions"} is ${this.formatCurrency(t)}. ${a} carries the largest share at ${r}% of exposure.`}return`Open risk across ${e.length} ${1===e.length?"position":"positions"} is ${this.formatCurrency(t)}.`}buildStrategyHeadline(){const e=this.getStrategyBreakdown();if(!e.length)return"";const t=e[0];if(!t)return"";const i=t.trades>0?(t.wins/t.trades*100).toFixed(0):"0";return`${t.name} leads with ${this.formatCurrency(t.pl)} across ${t.trades} trades (win rate ${i}%).`}buildCoachingHighlight(){const e=this.context.stats;if(!e)return"";const t=(this.context.closedTrades||[]).filter(e=>e.pl<0),i=(this.context.closedTrades||[]).filter(e=>e.pl>0),n=(e,t)=>{if(!e.length)return NaN;return e.reduce((e,i)=>e+t(i),0)/e.length},r=n(t,e=>Number(e.daysHeld)||0),a=n(i,e=>Number(e.daysHeld)||0);if(Number.isFinite(r)&&Number.isFinite(a)){const e=r-a;if(e>=2)return`Losing trades stay open about ${Math.round(e)} days longer than winners—tighten exits to cut risk sooner.`;if(e<=-2)return`You let winners run roughly ${Math.round(Math.abs(e))} days longer than losers—keep scaling out to lock in gains.`}return Number.isFinite(e.winRate)&&e.winRate<45&&(this.context.closedTrades?.length||0)>=5?"Win rate is under 45%. Focus on highest-conviction setups or scale size down until consistency improves.":""}getStrategyBreakdown(){const e=new Map;return(this.context.closedTrades||[]).forEach(t=>{const i=(t.strategy||"Unclassified").toString().trim()||"Unclassified";e.has(i)||e.set(i,{name:i,pl:0,trades:0,wins:0,losses:0});const n=e.get(i),r=Number(t.pl)||0;n.pl+=r,n.trades+=1,r>0?n.wins+=1:r<0&&(n.losses+=1)}),Array.from(e.values()).sort((e,t)=>t.pl-e.pl)}formatCurrency(e){return this.app.formatCurrency(e)}}class GeminiInsightsAgent{constructor(e){this.app=e,this.context={stats:null,openTrades:[],closedTrades:[]},this.fallback=new LocalInsightsAgent(e)}updateContext({stats:e,openTrades:t,closedTrades:i}={}){e&&(this.context.stats=e),Array.isArray(t)&&(this.context.openTrades=t),Array.isArray(i)&&(this.context.closedTrades=i),this.fallback.updateContext({stats:this.context.stats,openTrades:this.context.openTrades,closedTrades:this.context.closedTrades})}getGreeting(){return this.isConfigured()?this.fallback.getGreeting():"Connect your Gemini API key in [Settings](#settings) to get tailored analysis."}isConfigured(){const e=this.app?.gemini;return Boolean(e&&e.apiKey)}async generateResponse(e="",t={}){const i=e.trim();if(!i)return"Ask a question and I'll send it to Gemini along with a snapshot of your portfolio.";if(!this.isConfigured())return"Add a Gemini-compatible API key under [Settings](#settings) to enable AI-powered insights.";try{const e=this.buildRequestPayload(i,t),n=await this.callGemini(e);if(n)return n;throw new Error("Gemini returned an empty response")}catch(t){const i=this.fallback.generateResponse(e),n=t?.message||"Unknown error";return i?`Gemini request failed (${n}). Here's a local snapshot instead:\n\n${i}`:`Gemini request failed (${n}). Try again in a moment.`}}buildRequestPayload(e,t={}){const i=this.app?.gemini||{},n=GEMINI_ALLOWED_MODELS.includes(i.model)?i.model:DEFAULT_GEMINI_MODEL,r=.7,a=this.buildContextBlock(),s=[...this.buildHistoryContents(t.history||[]),{role:"user",parts:[{text:["# ROLE & PHILOSOPHY","You are an expert options trading coach. Your philosophy is rooted in rigorous risk management, capital preservation, and generating consistent returns. You are assisting an intermediate trader who wants to refine their strategy and tighten their risk controls. Your goal is to provide a concise, data-driven portfolio health check that identifies key risks and offers actionable, educational insights.","# CONTEXT: PORTFOLIO DATA",a,"# TRADER'S OBJECTIVE",e,"# ANALYSIS FRAMEWORK & INSTRUCTIONS",'1.  **Acknowledge Strengths:** Start by briefly highlighting the strong overall performance (e.g., win rate, profit factor, successful strategies).\n2.  **Prioritize Top Risks:** Scrutinize the data to identify and explain the top 2-3 risks. Focus specifically on:\n    * **Concentration Risk:** Explicitly cite the `riskHeadline` about TGT representing 15% of exposure and explain the danger of such a large allocation to a single position.\n    * **Behavioral Risk:** Connect the `coachingHighlight` ("Losing trades stay open about 6 days longer") to the risk of turning small, manageable losses into larger ones.\n3.  **Provide Actionable Recommendations:** Based on the identified risks, provide clear, bulleted recommendations. Link them directly to the data.\n    * Suggest a specific rule for position sizing (e.g., "Consider a rule to cap any single position\'s max risk to under 10% of total open risk.").\n    * Propose a concrete action to address the behavioral risk (e.g., "Establish a non-negotiable mental stop-loss for each trade, such as closing at a 2x premium loss or a specific DTE.").\n4.  **Suggest Next Steps:** Conclude with 2-3 forward-looking actions for process improvement.',"# OUTPUT FORMATTING","- **Tone:** Professional, direct, and risk-aware coach.\n- **Length:** Keep the response under 400 words.\n- **Structure:** Use bullet points for recommendations and next steps.\n- **Disclaimer:** End with a clear statement that this is educational analysis, not financial advice."].join("\n\n")}]}],o={maxOutputTokens:65536};return o.temperature=Number(r.toFixed(2)),{model:n,body:{contents:s,generationConfig:o}}}buildHistoryContents(e){return Array.isArray(e)&&0!==e.length?e.filter(e=>e&&!e.pending&&"string"==typeof e.text&&e.text.trim().length).slice(-8).map(e=>({role:"ai"===e.sender?"model":"user",parts:[{text:e.text.trim()}]})):[]}buildContextBlock(){const e=this.context.stats||{},t={totals:{totalPL:this.formatNumber(e.totalPL,{style:"currency"}),winRate:this.formatNumber(e.winRate,{style:"percent"}),profitFactor:this.formatNumber(e.profitFactor),totalROI:this.formatNumber(e.totalROI,{style:"percent"}),annualizedROI:this.formatNumber(e.annualizedROI,{style:"percent"}),maxDrawdown:this.formatNumber(e.maxDrawdown,{style:"percent"}),closedTrades:e.closedTrades??(this.context.closedTrades?.length||0),openPositions:e.activePositions??(this.context.openTrades?.length||0)},riskHeadline:this.fallback.buildRiskHeadline(),strategyHighlight:this.fallback.buildStrategyHeadline(),coachingHighlight:this.fallback.buildCoachingHighlight(),performanceHighlight:this.fallback.buildPerformanceSummary?.()||"",openPositions:this.buildOpenPositionsSummary(),recentClosedTrades:this.buildRecentClosedTradesSummary(),topStrategies:this.buildStrategySummary(),cycles:this.buildCycleSummary()};return JSON.stringify(t,null,2)}buildOpenPositionsSummary(e=8){return(Array.isArray(this.context.openTrades)?this.context.openTrades:[]).slice(0,e).map(e=>{const t=this.snapshotObjectForPrompt(e),i={},n=Number.isFinite(e?.dte)?Number(e.dte):this.deriveDTE(e);Number.isFinite(n)&&(i.calculatedDTE=Math.max(Math.round(n),0));const r=Number(this.app.getCapitalAtRisk(e));Number.isFinite(r)&&(i.calculatedMaxRisk=Number(r.toFixed(2)));const a=this.cleanNote(e?.notes);return a&&(i.notePreview=a),Object.keys(i).length&&(t.__promptDerived=i),t})}deriveDTE(e){if(!e?.expirationDate)return null;try{return this.app.calculateDTE(e.expirationDate,e)}catch(e){return null}}buildRecentClosedTradesSummary(e=8){return(Array.isArray(this.context.closedTrades)?[...this.context.closedTrades]:[]).sort((e,t)=>new Date(t.exitDate||0)-new Date(e.exitDate||0)).slice(0,e).map(e=>{const t=this.snapshotObjectForPrompt(e),i={plRounded:this.formatNumber(e?.pl,{style:"currency"}),roiRounded:this.formatNumber(e?.roi,{style:"percent"})},n=this.cleanNote(e?.exitReason);return n&&(i.exitReasonPreview=n),Number.isFinite(e?.daysHeld)&&(i.daysHeld=Number(e.daysHeld)),t.__promptDerived=Object.fromEntries(Object.entries(i).filter(([,e])=>null!=e)),Object.keys(t.__promptDerived).length||delete t.__promptDerived,t})}buildStrategySummary(e=5){return this.fallback.getStrategyBreakdown().slice(0,e).map(e=>({name:e.name,trades:e.trades,wins:e.wins,losses:e.losses,realisedPL:this.formatNumber(e.pl,{style:"currency"}),winRate:e.trades>0?this.formatNumber(e.wins/e.trades*100,{style:"percent"}):null}))}buildCycleSummary(e=3){return(Array.isArray(this.app.cycleAnalytics)&&this.app.cycleAnalytics.length?this.app.cycleAnalytics:this.app.calculateCycleAnalytics()).slice(0,e).map(e=>{const t=this.snapshotObjectForPrompt(e),i={tradeCount:Array.isArray(e?.trades)?e.trades.length:0,totalPLRounded:this.formatNumber(e?.totalPL,{style:"currency"}),roiPercentRounded:this.formatNumber(e?.roiPercent,{style:"percent"}),keyMetricLabel:e?.keyMetricLabel||null,keyMetricValueRounded:this.formatCycleMetricValue(e?.keyMetricValue,e?.keyMetricLabel),timelineLabel:this.app.formatCycleDateRange(e?.startDate,e?.endDate,e?.hasOpenTrade)};return t.__promptDerived=Object.fromEntries(Object.entries(i).filter(([,e])=>null!=e)),Object.keys(t.__promptDerived).length||delete t.__promptDerived,t})}snapshotObjectForPrompt(e){const t=this.snapshotForPrompt(e);return t&&"object"==typeof t&&!Array.isArray(t)?t:{}}snapshotForPrompt(e){if(null==e)return null;if("number"==typeof e)return Number.isFinite(e)?Number(e):null;if("string"==typeof e||"boolean"==typeof e)return e;if(e instanceof Date)return e.toISOString();if(Array.isArray(e))return e.map(e=>this.snapshotForPrompt(e));if("object"==typeof e){const t={};for(const[i,n]of Object.entries(e))"function"!=typeof n&&(t[i]=this.snapshotForPrompt(n));return t}return null}cleanNote(e){if(!e)return"";const t=e.toString().trim();return t.length<=180?t:`${t.slice(0,177)}…`}formatNumber(e,t={}){const i=Number(e);if(!Number.isFinite(i))return null;const n=t.style||"number";return"currency"===n?new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2,maximumFractionDigits:2}).format(i):"percent"===n?`${i.toFixed(2)}%`:"string"===n?i.toFixed(2):Number(i.toFixed(2))}formatCycleMetricValue(e,t=""){const i=(t||"").toString().toLowerCase();return i?/(%|percent|roi|return|drawdown|rate|yield)/.test(i)?this.formatNumber(e,{style:"percent"}):/(\$|pl|p&l|profit|premium|risk|cost|credit|debit|revenue|balance|capital|cash|amount|value|exposure|loss)/.test(i)?this.formatNumber(e,{style:"currency"}):this.formatNumber(e):this.formatNumber(e)}async callGemini({model:e,body:t}){const i=this.app?.gemini?.apiKey;if(!i)throw new Error("Missing Gemini API key");const n=DEFAULT_GEMINI_ENDPOINT.replace(/\/+$/,""),r=(e||DEFAULT_GEMINI_MODEL).replace(/^models\//i,""),a=`${`${n}/${encodeURIComponent(r)}:generateContent`}?key=${encodeURIComponent(i)}`,s="undefined"!=typeof AbortController?new AbortController:null,o=s?setTimeout(()=>s.abort(),2e4):null;try{const e=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":i},body:JSON.stringify(t),signal:s?.signal}),n=await e.json().catch(()=>({}));if(!e.ok){const t=n?.error?.message||n?.message||`HTTP ${e.status}`;throw new Error(t)}if(n?.promptFeedback?.blockReason)throw new Error(`Request blocked (${n.promptFeedback.blockReason})`);const r=n?.candidates?.[0]?.content?.parts;if(!Array.isArray(r)||!r.length)return"";return r.map(e=>e&&"string"==typeof e.text?e.text:"").join("").trim()}finally{o&&clearTimeout(o)}}}document.addEventListener("DOMContentLoaded",function(){window.tracker=new GammaLedger});